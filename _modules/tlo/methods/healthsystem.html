

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>tlo.methods.healthsystem &mdash; TLOmodel 0.1.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.png"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> TLOmodel
          

          
          </a>

          
            
            
              <div class="version">
                0.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Welcome</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../aims.html">Aims &amp; Objectives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../writeups.html">Model Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data_sources.html">Data Sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../azure_batch.html">Using Azure Batch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../background.html">Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">TLOmodel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../methods.html">tlo.methods</a> &raquo;</li>
        
      <li>tlo.methods.healthsystem</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for tlo.methods.healthsystem</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">heapq</span> <span class="k">as</span> <span class="nn">hp</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">repeat</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">NamedTuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pandas.testing</span> <span class="kn">import</span> <span class="n">assert_series_equal</span>

<span class="kn">import</span> <span class="nn">tlo</span>
<span class="kn">from</span> <span class="nn">tlo</span> <span class="kn">import</span> <span class="n">Date</span><span class="p">,</span> <span class="n">DateOffset</span><span class="p">,</span> <span class="n">Module</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">,</span> <span class="n">Property</span><span class="p">,</span> <span class="n">Types</span><span class="p">,</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="nn">tlo.analysis.utils</span> <span class="kn">import</span> <span class="p">(</span>  <span class="c1"># get_filtered_treatment_ids,</span>
    <span class="n">flatten_multi_index_series_into_dict_for_logging</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">tlo.events</span> <span class="kn">import</span> <span class="n">Event</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">,</span> <span class="n">Priority</span><span class="p">,</span> <span class="n">RegularEvent</span>
<span class="kn">from</span> <span class="nn">tlo.methods</span> <span class="kn">import</span> <span class="n">Metadata</span>
<span class="kn">from</span> <span class="nn">tlo.methods.bed_days</span> <span class="kn">import</span> <span class="n">BedDays</span>
<span class="kn">from</span> <span class="nn">tlo.methods.consumables</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Consumables</span><span class="p">,</span>
    <span class="n">get_item_code_from_item_name</span><span class="p">,</span>
    <span class="n">get_item_codes_from_package_name</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">tlo.methods.dxmanager</span> <span class="kn">import</span> <span class="n">DxManager</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="n">logger_summary</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.summary&quot;</span><span class="p">)</span>
<span class="n">logger_summary</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="c1"># Declare the level which will be used to represent the merging of levels &#39;1b&#39; and &#39;2&#39;</span>
<span class="n">LABEL_FOR_MERGED_FACILITY_LEVELS_1B_AND_2</span> <span class="o">=</span> <span class="s1">&#39;2&#39;</span>

<span class="c1"># Declare the assumption for the availability of consumables at the merged levels &#39;1b&#39; and &#39;2&#39;. This can be a</span>
<span class="c1">#  list of facility_levels over which an average is taken (within a district): e.g. [&#39;1b&#39;, &#39;2&#39;].</span>
<span class="n">AVAILABILITY_OF_CONSUMABLES_AT_MERGED_LEVELS_1B_AND_2</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;1b&#39;</span><span class="p">]</span>  <span class="c1"># &lt;-- Implies that availability at merged level &#39;1b &amp; 2&#39;</span>
<span class="c1">#                                                                     is equal to availability at level &#39;1b&#39;. This is</span>
<span class="c1">#                                                                     reasonable because the &#39;1b&#39; are more numerous than</span>
<span class="c1">#                                                                     those of &#39;2&#39; and have more overall capacity, so</span>
<span class="c1">#                                                                     probably account for the majority of the</span>
<span class="c1">#                                                                     interactions.</span>


<span class="k">def</span> <span class="nf">adjust_facility_level_to_merge_1b_and_2</span><span class="p">(</span><span class="n">level</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adjust the facility level of an HSI_Event so that HSI_Events scheduled at level &#39;1b&#39; and &#39;2&#39; are both directed</span>
<span class="sd">    to level &#39;2&#39;&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">level</span> <span class="k">if</span> <span class="n">level</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;1b&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">LABEL_FOR_MERGED_FACILITY_LEVELS_1B_AND_2</span>


<span class="k">def</span> <span class="nf">pool_capabilities_at_levels_1b_and_2</span><span class="p">(</span><span class="n">df_original</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a modified version of the imported capabilities DataFrame to reflect that the capabilities of level 1b</span>
<span class="sd">    are pooled with those of level 2, and all labelled as level 2.&quot;&quot;&quot;</span>

    <span class="c1"># Find total minutes and staff count after the re-allocation of capabilities from &#39;1b&#39; to &#39;2&#39;</span>
    <span class="n">tots_after_reallocation</span> <span class="o">=</span> <span class="n">df_original</span> \
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Facility_Level</span><span class="o">=</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">Facility_Level</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span>
                            <span class="s1">&#39;1b&#39;</span><span class="p">:</span> <span class="n">LABEL_FOR_MERGED_FACILITY_LEVELS_1B_AND_2</span><span class="p">,</span>
                            <span class="s1">&#39;2&#39;</span><span class="p">:</span> <span class="n">LABEL_FOR_MERGED_FACILITY_LEVELS_1B_AND_2</span><span class="p">})</span>
                <span class="p">)</span> \
        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Facility_Level&#39;</span><span class="p">,</span> <span class="s1">&#39;District&#39;</span><span class="p">,</span> <span class="s1">&#39;Region&#39;</span><span class="p">,</span> <span class="s1">&#39;Officer_Category&#39;</span><span class="p">],</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span>
            <span class="s1">&#39;Total_Mins_Per_Day&#39;</span><span class="p">,</span> <span class="s1">&#39;Staff_Count&#39;</span><span class="p">]]</span> \
        <span class="o">.</span><span class="n">sum</span><span class="p">()</span> \
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="c1"># Construct a new version of the dataframe that uses the new totals</span>
    <span class="n">df_updated</span> <span class="o">=</span> <span class="n">df_original</span> \
        <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Total_Mins_Per_Day&#39;</span><span class="p">,</span> <span class="s1">&#39;Staff_Count&#39;</span><span class="p">])</span>\
        <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tots_after_reallocation</span><span class="p">,</span>
               <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Facility_Level&#39;</span><span class="p">,</span> <span class="s1">&#39;District&#39;</span><span class="p">,</span> <span class="s1">&#39;Region&#39;</span><span class="p">,</span> <span class="s1">&#39;Officer_Category&#39;</span><span class="p">],</span>
               <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
               <span class="p">)</span> \
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">Total_Mins_Per_Day</span><span class="o">=</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">Total_Mins_Per_Day</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
            <span class="n">Staff_Count</span><span class="o">=</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">Staff_Count</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># Check that the *total* number of minutes per officer in each district/region is the same as before the change</span>
    <span class="n">assert_series_equal</span><span class="p">(</span>
        <span class="n">df_updated</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;District&#39;</span><span class="p">,</span> <span class="s1">&#39;Region&#39;</span><span class="p">,</span> <span class="s1">&#39;Officer_Category&#39;</span><span class="p">],</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;Total_Mins_Per_Day&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
        <span class="n">df_original</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;District&#39;</span><span class="p">,</span> <span class="s1">&#39;Region&#39;</span><span class="p">,</span> <span class="s1">&#39;Officer_Category&#39;</span><span class="p">],</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;Total_Mins_Per_Day&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="n">df_updated</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Facility_Level&#39;</span><span class="p">)[</span><span class="s1">&#39;Total_Mins_Per_Day&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># Check size/shape of the updated dataframe is as expected</span>
    <span class="k">assert</span> <span class="n">df_updated</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">df_original</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">df_updated</span><span class="o">.</span><span class="n">dtypes</span> <span class="o">==</span> <span class="n">df_original</span><span class="o">.</span><span class="n">dtypes</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">_level</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;1a&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="n">df_original</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_original</span><span class="o">.</span><span class="n">Facility_Level</span> <span class="o">==</span> <span class="n">_level</span><span class="p">]</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span>
            <span class="n">df_updated</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_updated</span><span class="o">.</span><span class="n">Facility_Level</span> <span class="o">==</span> <span class="n">_level</span><span class="p">])</span>

    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span>
        <span class="n">df_updated</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_updated</span><span class="o">.</span><span class="n">Facility_Level</span> <span class="o">==</span> <span class="n">LABEL_FOR_MERGED_FACILITY_LEVELS_1B_AND_2</span><span class="p">,</span>
                       <span class="s1">&#39;Total_Mins_Per_Day&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
        <span class="n">df_updated</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_updated</span><span class="o">.</span><span class="n">Facility_Level</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;1b&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">]),</span> <span class="s1">&#39;Total_Mins_Per_Day&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">df_updated</span>


<span class="k">class</span> <span class="nc">FacilityInfo</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Information about a specific health facility.&quot;&quot;&quot;</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">level</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">region</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">class</span> <span class="nc">AppointmentSubunit</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Component of an appointment relating to a specific officer type.&quot;&quot;&quot;</span>
    <span class="n">officer_type</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">time_taken</span><span class="p">:</span> <span class="nb">float</span>


<span class="k">class</span> <span class="nc">HSIEventDetails</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Non-target specific details of a health system interaction event.&quot;&quot;&quot;</span>
    <span class="n">event_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">treatment_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">facility_level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">appt_footprint</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span>
    <span class="n">beddays_footprint</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span>


<span class="k">class</span> <span class="nc">HSIEventQueueItem</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Properties of event added to health system queue.</span>

<span class="sd">    The order of the attributes in the tuple is important as the queue sorting is done</span>
<span class="sd">    by the order of the items in the tuple, i.e. first by `priority`, then `topen` and</span>
<span class="sd">    so on.</span>

<span class="sd">    Ensure priority is above topen in order for held-over events with low priority not</span>
<span class="sd">    to jump ahead higher priority ones which were opened later.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">priority</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">topen</span><span class="p">:</span> <span class="n">Date</span>
    <span class="n">rand_queue_counter</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1"># Ensure order of events with same topen &amp; priority is not model-dependent</span>
    <span class="n">queue_counter</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1"># Include safety tie-breaker in unlikely event rand_queue_counter is equal</span>
    <span class="n">tclose</span><span class="p">:</span> <span class="n">Date</span>
    <span class="c1"># Define HSI_Event type as string to avoid NameError exception as HSI_Event defined</span>
    <span class="c1"># later in module (see https://stackoverflow.com/a/36286947/4798943)</span>
    <span class="n">hsi_event</span><span class="p">:</span> <span class="s1">&#39;HSI_Event&#39;</span>


<div class="viewcode-block" id="HSI_Event"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HSI_Event">[docs]</a><span class="k">class</span> <span class="nc">HSI_Event</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base HSI event class, from which all others inherit.</span>

<span class="sd">    Concrete subclasses should also inherit from one of the EventMixin classes</span>
<span class="sd">    defined below, and implement at least an `apply` and `did_not_run` method.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="HSI_Event.__init__"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HSI_Event.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new event.</span>

<span class="sd">        Note that just creating an event does not schedule it to happen; that</span>
<span class="sd">        must be done by calling Simulation.schedule_event.</span>

<span class="sd">        :param module: the module that created this event.</span>
<span class="sd">            All subclasses of Event take this as the first argument in their</span>
<span class="sd">            constructor, but may also take further keyword arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">sim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Overwritten by the mixin</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># Call the mixin&#39;s constructors</span>

        <span class="c1"># Defaults for the HSI information:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TREATMENT_ID</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="c1"># self.EXPECTED_APPT_FOOTPRINT = self.make_appt_footprint({})  # HSI needs this property, but it is not defined</span>
        <span class="c1">#                                                                 in the Base class to allow overwriting with a</span>
        <span class="c1">#                                                                 property function.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BEDDAYS_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_beddays_footprint</span><span class="p">({})</span>

        <span class="c1"># Information received about this HSI:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_received_info_about_bed_days</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expected_time_requests</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">facility_info</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bed_days_allocated_to_this_event</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_received_info_about_bed_days</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># default to the footprint if no information about bed-days is received</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">BEDDAYS_FOOTPRINT</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_received_info_about_bed_days</span>

<div class="viewcode-block" id="HSI_Event.apply"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HSI_Event.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">squeeze_factor</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply this event to the population.</span>

<span class="sd">        Must be implemented by subclasses.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="HSI_Event.did_not_run"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HSI_Event.did_not_run">[docs]</a>    <span class="k">def</span> <span class="nf">did_not_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Called when this event is due but it is not run. Return False to prevent the event being rescheduled, or True</span>
<span class="sd">        to allow the rescheduling. This is called each time that the event is tried to be run but it cannot be.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: did not run.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="HSI_Event.never_ran"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HSI_Event.never_ran">[docs]</a>    <span class="k">def</span> <span class="nf">never_ran</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Called when this event is was entered to the HSI Event Queue, but was never run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: was never run.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="HSI_Event.post_apply_hook"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HSI_Event.post_apply_hook">[docs]</a>    <span class="k">def</span> <span class="nf">post_apply_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Impose the bed-days footprint (if target of the HSI is a person_id)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">bed_days</span><span class="o">.</span><span class="n">impose_beddays_footprint</span><span class="p">(</span>
                <span class="n">person_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
                <span class="n">footprint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bed_days_allocated_to_this_event</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="HSI_Event.run"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HSI_Event.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">squeeze_factor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make the event happen.&quot;&quot;&quot;</span>
        <span class="n">updated_appt_footprint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">squeeze_factor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post_apply_hook</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">updated_appt_footprint</span></div>

<div class="viewcode-block" id="HSI_Event.get_consumables"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HSI_Event.get_consumables">[docs]</a>    <span class="k">def</span> <span class="nf">get_consumables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">item_codes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">optional_item_codes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">to_log</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="n">return_individual_results</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Function to allow for getting and checking of entire set of consumables. All requests for consumables should</span>
<span class="sd">        use this function.</span>
<span class="sd">        :param item_codes: The item code(s) (and quantities) of the consumables that are requested and which determine</span>
<span class="sd">        the summary result for availability/non-availability. This can be an `int` (the item_code needed [assume</span>
<span class="sd">        quantity=1]), a `list` or `set` (the collection  of item_codes [for each assuming quantity=1]), or a `dict`</span>
<span class="sd">        (with key:value pairs `&lt;item_code&gt;:&lt;quantity&gt;`).</span>
<span class="sd">        :param optional_item_codes: The item code(s) (and quantities) of the consumables that are requested and which do</span>
<span class="sd">         not determine the summary result for availability/non-availability. (Same format as `item_codes`). This is</span>
<span class="sd">         useful when a large set of items may be used, but the viability of a subsequent operation depends only on a</span>
<span class="sd">         subset.</span>
<span class="sd">        :param return_individual_results: If True returns a `dict` giving the availability of each item_code requested</span>
<span class="sd">        (otherwise gives a `bool` indicating if all the item_codes requested are available).</span>
<span class="sd">        :param to_log: If True, logs the request.</span>
<span class="sd">        :returns A `bool` indicating whether every item is available, or a `dict` indicating the availability of each</span>
<span class="sd">         item.</span>
<span class="sd">        Note that disease module can use the `get_item_codes_from_package_name` and `get_item_code_from_item_name`</span>
<span class="sd">         methods in the `HealthSystem` module to find item_codes.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_return_item_codes_in_dict</span><span class="p">(</span><span class="n">item_codes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Convert an argument for &#39;item_codes` (provided as int, list, set or dict) into the format</span>
<span class="sd">            dict(&lt;item_code&gt;:quantity).&quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="n">item_codes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{}</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item_codes</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
                <span class="k">return</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">item_codes</span><span class="p">):</span> <span class="mi">1</span><span class="p">}</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item_codes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">item_codes</span><span class="p">]):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;item_codes must be integers&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">):</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">item_codes</span><span class="p">}</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item_codes</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
                    <span class="p">[(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">))</span> <span class="ow">and</span>
                      <span class="nb">isinstance</span><span class="p">(</span><span class="n">quantity</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)))</span>
                     <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">quantity</span> <span class="ow">in</span> <span class="n">item_codes</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
                <span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;item_codes must be integers and quantities must be integers or floats.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">):</span> <span class="nb">float</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">item_codes</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The item_codes are given in an unrecognised format&quot;</span><span class="p">)</span>

        <span class="n">hs_module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span>

        <span class="n">_item_codes</span> <span class="o">=</span> <span class="n">_return_item_codes_in_dict</span><span class="p">(</span><span class="n">item_codes</span><span class="p">)</span>
        <span class="n">_optional_item_codes</span> <span class="o">=</span> <span class="n">_return_item_codes_in_dict</span><span class="p">(</span><span class="n">optional_item_codes</span><span class="p">)</span>

        <span class="c1"># Determine if the request should be logged (over-ride argument provided if HealthSystem is disabled).</span>
        <span class="n">_to_log</span> <span class="o">=</span> <span class="n">to_log</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">hs_module</span><span class="o">.</span><span class="n">disable</span> <span class="k">else</span> <span class="kc">False</span>

        <span class="c1"># Checking the availability and logging:</span>
        <span class="n">rtn</span> <span class="o">=</span> <span class="n">hs_module</span><span class="o">.</span><span class="n">consumables</span><span class="o">.</span><span class="n">_request_consumables</span><span class="p">(</span><span class="n">item_codes</span><span class="o">=</span><span class="p">{</span><span class="o">**</span><span class="n">_item_codes</span><span class="p">,</span> <span class="o">**</span><span class="n">_optional_item_codes</span><span class="p">},</span>
                                                         <span class="n">to_log</span><span class="o">=</span><span class="n">_to_log</span><span class="p">,</span>
                                                         <span class="n">facility_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">facility_info</span><span class="p">,</span>
                                                         <span class="n">treatment_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TREATMENT_ID</span><span class="p">)</span>

        <span class="c1"># Return result in expected format:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_individual_results</span><span class="p">:</span>
            <span class="c1"># Determine if all results for all the `item_codes` are True (discarding results from optional_item_codes).</span>
            <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rtn</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_item_codes</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rtn</span></div>

<div class="viewcode-block" id="HSI_Event.make_beddays_footprint"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HSI_Event.make_beddays_footprint">[docs]</a>    <span class="k">def</span> <span class="nf">make_beddays_footprint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dict_of_beddays</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper function to make a correctly-formed &#39;bed-days footprint&#39;&quot;&quot;&quot;</span>

        <span class="c1"># get blank footprint</span>
        <span class="n">footprint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">bed_days</span><span class="o">.</span><span class="n">get_blank_beddays_footprint</span><span class="p">()</span>

        <span class="c1"># do checks on the dict_of_beddays provided.</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dict_of_beddays</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">((</span><span class="n">k</span> <span class="ow">in</span> <span class="n">footprint</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dict_of_beddays</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">))</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dict_of_beddays</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="c1"># make footprint (defaulting to zero where a type of bed-days is not specified)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dict_of_beddays</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">footprint</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">return</span> <span class="n">footprint</span></div>

<div class="viewcode-block" id="HSI_Event.is_all_beddays_allocated"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HSI_Event.is_all_beddays_allocated">[docs]</a>    <span class="k">def</span> <span class="nf">is_all_beddays_allocated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the entire footprint requested is allocated&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bed_days_allocated_to_this_event</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">BEDDAYS_FOOTPRINT</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BEDDAYS_FOOTPRINT</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="HSI_Event.make_appt_footprint"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HSI_Event.make_appt_footprint">[docs]</a>    <span class="k">def</span> <span class="nf">make_appt_footprint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dict_of_appts</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper function to make appointment footprint in format expected downstream.</span>

<span class="sd">        Should be passed a dictionary keyed by appointment type codes with non-negative</span>
<span class="sd">        values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">health_system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">health_system</span><span class="o">.</span><span class="n">appt_footprint_is_valid</span><span class="p">(</span><span class="n">dict_of_appts</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Counter</span><span class="p">(</span><span class="n">dict_of_appts</span><span class="p">)</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Argument to make_appt_footprint should be a dictionary keyed by &quot;</span>
            <span class="s2">&quot;appointment type code strings in Appt_Types_Table with non-negative &quot;</span>
            <span class="s2">&quot;values&quot;</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="HSI_Event.initialise"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HSI_Event.initialise">[docs]</a>    <span class="k">def</span> <span class="nf">initialise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialise the HSI:</span>
<span class="sd">        * Set the facility_info</span>
<span class="sd">        * Compute appt-footprint time requirements</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">health_system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span>

        <span class="c1"># Over-write ACCEPTED_FACILITY_LEVEL to to redirect all &#39;1b&#39; appointments to &#39;2&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span> <span class="o">=</span> <span class="n">adjust_facility_level_to_merge_1b_and_2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">tlo</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">Population</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">facility_info</span> <span class="o">=</span> <span class="n">health_system</span><span class="o">.</span><span class="n">get_facility_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="c1"># If there are bed-days specified, add (if needed) the in-patient admission and in-patient day Appointment</span>
            <span class="c1"># Types.</span>
            <span class="c1"># (HSI that require a bed for one or more days always need such appointments, but this may have been</span>
            <span class="c1"># missed in the declaration of the `EXPECTED_APPPT_FOOTPRINT` in the HSI.)</span>
            <span class="c1"># NB. The in-patient day Appointment time is automatically applied on subsequent days.</span>
            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BEDDAYS_FOOTPRINT</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="n">health_system</span><span class="o">.</span><span class="n">bed_days</span><span class="o">.</span><span class="n">add_first_day_inpatient_appts_to_footprint</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span><span class="p">)</span>

            <span class="c1"># Write the time requirements for staff of the appointments to the HSI:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expected_time_requests</span> <span class="o">=</span> <span class="n">health_system</span><span class="o">.</span><span class="n">get_appt_footprint_as_time_request</span><span class="p">(</span>
                <span class="n">facility_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">facility_info</span><span class="p">,</span>
                <span class="n">appt_footprint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Do checks</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_if_appt_footprint_can_run</span><span class="p">()</span></div>

<div class="viewcode-block" id="HSI_Event._check_if_appt_footprint_can_run"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HSI_Event._check_if_appt_footprint_can_run">[docs]</a>    <span class="k">def</span> <span class="nf">_check_if_appt_footprint_can_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check that event (if individual level) is able to run with this configuration of officers (i.e. check that</span>
<span class="sd">        this does not demand officers that are _never_ available), and issue warning if not.&quot;&quot;&quot;</span>
        <span class="n">health_system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">tlo</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">Population</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">health_system</span><span class="o">.</span><span class="n">_officers_with_availability</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expected_time_requests</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="n">key</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The expected footprint of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TREATMENT_ID</span><span class="si">}</span><span class="s2"> is not possible with the configuration of &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;officers.&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="HSI_Event.as_namedtuple"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HSI_Event.as_namedtuple">[docs]</a>    <span class="k">def</span> <span class="nf">as_namedtuple</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">actual_appt_footprint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HSIEventDetails</span><span class="p">:</span>
        <span class="n">appt_footprint</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;EXPECTED_APPT_FOOTPRINT&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="n">actual_appt_footprint</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">actual_appt_footprint</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">HSIEventDetails</span><span class="p">(</span>
            <span class="n">event_name</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">module_name</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">treatment_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TREATMENT_ID</span><span class="p">,</span>
            <span class="n">facility_level</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ACCEPTED_FACILITY_LEVEL&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="n">appt_footprint</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">appt_footprint</span><span class="o">.</span><span class="n">items</span><span class="p">())),</span>
            <span class="n">beddays_footprint</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span>
                <span class="nb">sorted</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BEDDAYS_FOOTPRINT</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="HSIEventWrapper"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HSIEventWrapper">[docs]</a><span class="k">class</span> <span class="nc">HSIEventWrapper</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is wrapper that contains an HSI event.</span>

<span class="sd">    It is used:</span>
<span class="sd">     1) When the healthsystem is in mode &#39;disabled=True&#39; such that HSI events sent to the health system scheduler are</span>
<span class="sd">     passed to the main simulation scheduler for running on the date of `topen`. (Note, it is run with</span>
<span class="sd">     squeeze_factor=0.0.)</span>
<span class="sd">     2) When the healthsytsem is in mode `diable_and_reject_all=True` such that HSI are not run but the `never_ran`</span>
<span class="sd">     method is run on the date of `tclose`.</span>
<span class="sd">     3) When an HSI has been submitted to `schedule_hsi_event` but the service is not available.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="HSIEventWrapper.__init__"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HSIEventWrapper.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hsi_event</span><span class="p">,</span> <span class="n">run_hsi</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hsi_event</span> <span class="o">=</span> <span class="n">hsi_event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">hsi_event</span><span class="o">.</span><span class="n">target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_hsi</span> <span class="o">=</span> <span class="n">run_hsi</span>  <span class="c1"># True to call the HSI&#39;s `run` method; False to call the HSI&#39;s `never_ran` method</span></div>

<div class="viewcode-block" id="HSIEventWrapper.run"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HSIEventWrapper.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Do the appropriate action on the HSI event&quot;&quot;&quot;</span>

        <span class="c1"># Check that the person is still alive (this check normally happens in the HealthSystemScheduler and silently</span>
        <span class="c1"># do not run the HSI event)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">tlo</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">Population</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="s1">&#39;is_alive&#39;</span><span class="p">]</span>
        <span class="p">):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_hsi</span><span class="p">:</span>
                <span class="c1"># Run the event (with 0 squeeze_factor) and ignore the output</span>
                <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">squeeze_factor</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">call_and_record_never_ran_hsi_event</span><span class="p">(</span>
                      <span class="n">hsi_event</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hsi_event</span><span class="p">,</span>
                      <span class="n">priority</span><span class="o">=-</span><span class="mi">1</span>
                     <span class="p">)</span></div></div>


<span class="k">def</span> <span class="nf">_accepts_argument</span><span class="p">(</span><span class="n">function</span><span class="p">:</span> <span class="nb">callable</span><span class="p">,</span> <span class="n">argument</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper to test if callable object accepts an argument with a given name.</span>

<span class="sd">    Compared to using `inspect.signature` or `inspect.getfullargspec` the approach here</span>
<span class="sd">    has significantly less overhead (as a full `Signature` or `FullArgSpec` object</span>
<span class="sd">    does not need to constructed) but is also less readable hence why it has been</span>
<span class="sd">    wrapped as a helper function despite being only one-line to make its functionality</span>
<span class="sd">    more obvious.</span>

<span class="sd">    :param function: Callable object to check if argument is present in.</span>
<span class="sd">    :param argument: Name of argument to check.</span>
<span class="sd">    :returns: ``True`` is ``argument`` is an argument of ``function`` else ``False``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># co_varnames include both arguments to function and any internally defined variable</span>
    <span class="c1"># names hence we check only in the first `co_argcount` items which correspond to</span>
    <span class="c1"># just the arguments</span>
    <span class="k">return</span> <span class="n">argument</span> <span class="ow">in</span> <span class="n">function</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">[:</span><span class="n">function</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_argcount</span><span class="p">]</span>


<div class="viewcode-block" id="HealthSystem"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem">[docs]</a><span class="k">class</span> <span class="nc">HealthSystem</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the Health System Module.</span>
<span class="sd">    The execution of all health systems interactions are controlled through this module.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">INIT_DEPENDENCIES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Demography&#39;</span><span class="p">}</span>

    <span class="n">PARAMETERS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># Organization of the HealthSystem</span>
        <span class="s1">&#39;Master_Facilities_List&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s1">&#39;Listing of all health facilities.&#39;</span><span class="p">),</span>

        <span class="c1"># Definitions of the officers and appointment types</span>
        <span class="s1">&#39;Officer_Types_Table&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s1">&#39;The names of the types of health workers (&quot;officers&quot;)&#39;</span><span class="p">),</span>
        <span class="s1">&#39;Appt_Types_Table&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s1">&#39;The names of the type of appointments with the health system&#39;</span><span class="p">),</span>
        <span class="s1">&#39;Appt_Offered_By_Facility_Level&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s1">&#39;Table indicating whether or not each appointment is offered at each facility level.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;Appt_Time_Table&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span>
                                     <span class="s1">&#39;The time taken for each appointment, according to officer and facility type.&#39;</span><span class="p">),</span>

        <span class="c1"># Capabilities of the HealthSystem (under alternative assumptions)</span>
        <span class="s1">&#39;Daily_Capabilities_actual&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s1">&#39;The capabilities (minutes of time available of each type of officer in each facility) &#39;</span>
                              <span class="s1">&#39;based on the _estimated current_ number and distribution of staff estimated.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;Daily_Capabilities_funded&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s1">&#39;The capabilities (minutes of time available of each type of officer in each facility) &#39;</span>
                              <span class="s1">&#39;based on the _potential_ number and distribution of staff estimated (i.e. those &#39;</span>
                              <span class="s1">&#39;positions that can be funded).&#39;</span><span class="p">),</span>
        <span class="s1">&#39;Daily_Capabilities_funded_plus&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s1">&#39;The capabilities (minutes of time available of each type of officer in each facility) &#39;</span>
                              <span class="s1">&#39;based on the _potential_ number and distribution of staff estimated, with adjustments &#39;</span>
                              <span class="s1">&#39;to permit each appointment type that should be run at facility level to do so in every &#39;</span>
                              <span class="s1">&#39;district.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;use_funded_or_actual_staffing&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">STRING</span><span class="p">,</span> <span class="s2">&quot;If `actual`, then use the numbers and distribution of staff estimated to be available&quot;</span>
                          <span class="s2">&quot; currently; If `funded`, then use the numbers and distribution of staff that are &quot;</span>
                          <span class="s2">&quot;potentially available. If &#39;funded_plus`, then use a dataset in which the allocation of &quot;</span>
                          <span class="s2">&quot;staff to facilities is tweaked so as to allow each appointment type to run at each &quot;</span>
                          <span class="s2">&quot;facility_level in each district for which it is defined. N.B. This parameter is &quot;</span>
                          <span class="s2">&quot;over-ridden if an argument is provided to the module initialiser.&quot;</span><span class="p">,</span>
            <span class="c1"># N.B. This could have been of type `Types.CATEGORICAL` but this made over-writing through `Scenario`</span>
            <span class="c1"># difficult, due to the requirement that the over-writing value and original value are of the same type</span>
            <span class="c1"># (enforced at line 376 of scenario.py).</span>
        <span class="p">),</span>

        <span class="c1"># Consumables</span>
        <span class="s1">&#39;item_and_package_code_lookups&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s1">&#39;Data imported from the OneHealth Tool on consumable items, packages and costs.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;availability_estimates&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s1">&#39;Estimated availability of consumables in the LMIS dataset.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;cons_availability&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">STRING</span><span class="p">,</span>
            <span class="s2">&quot;Availability of consumables. If &#39;default&#39; then use the availability specified in the ResourceFile; if &quot;</span>
            <span class="s2">&quot;&#39;none&#39;, then let no consumable be  ever be available; if &#39;all&#39;, then all consumables are always available.&quot;</span>
            <span class="s2">&quot; When using &#39;all&#39; or &#39;none&#39;, requests for consumables are not logged. NB. This parameter is over-ridden&quot;</span>
            <span class="s2">&quot;if an argument is provided to the module initialiser.&quot;</span><span class="p">),</span>

        <span class="c1"># Infrastructure and Equipment</span>
        <span class="s1">&#39;BedCapacity&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s2">&quot;Data on the number of beds available of each type by facility_id&quot;</span><span class="p">),</span>
        <span class="s1">&#39;beds_availability&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">STRING</span><span class="p">,</span>
            <span class="s2">&quot;Availability of beds. If &#39;default&#39; then use the availability specified in the ResourceFile; if &quot;</span>
            <span class="s2">&quot;&#39;none&#39;, then let no beds be  ever be available; if &#39;all&#39;, then all beds are always available. NB. This &quot;</span>
            <span class="s2">&quot;parameter is over-ridden if an argument is provided to the module initialiser.&quot;</span><span class="p">),</span>

        <span class="c1"># Service Availability</span>
        <span class="s1">&#39;Service_Availability&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;List of services to be available. NB. This parameter is over-ridden if an argument is provided&#39;</span>
                        <span class="s1">&#39; to the module initialiser.&#39;</span><span class="p">),</span>

        <span class="s1">&#39;policy_name&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">STRING</span><span class="p">,</span> <span class="s2">&quot;Name of priority policy assumed to have been adopted until policy switch&quot;</span><span class="p">),</span>
        <span class="s1">&#39;policy_name_post_switch&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">STRING</span><span class="p">,</span> <span class="s2">&quot;Name of priority policy to be adopted from policy switch year onwards&quot;</span><span class="p">),</span>
        <span class="s1">&#39;year_policy_switch&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span> <span class="s2">&quot;Year in which priority policy switch in enforced&quot;</span><span class="p">),</span>

        <span class="s1">&#39;priority_rank&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">DICT</span><span class="p">,</span> <span class="s2">&quot;Data on the priority ranking of each of the Treatment_IDs to be adopted by &quot;</span>
                        <span class="s2">&quot; the queueing system under different policies, where the lower the number the higher&quot;</span>
                        <span class="s2">&quot; the priority, and on which categories of individuals classify for fast-tracking &quot;</span>
                        <span class="s2">&quot; for specific treatments&quot;</span><span class="p">),</span>

        <span class="s1">&#39;tclose_overwrite&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span> <span class="s2">&quot;Decide whether to overwrite tclose variables assigned by disease modules&quot;</span><span class="p">),</span>

        <span class="s1">&#39;tclose_days_offset_overwrite&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span> <span class="s2">&quot;Offset in days from topen at which tclose will be set by the healthsystem for all HSIs&quot;</span>
                       <span class="s2">&quot;if tclose_overwrite is set to True.&quot;</span><span class="p">),</span>

        <span class="c1"># Mode Appt Constraints</span>
        <span class="s1">&#39;mode_appt_constraints&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span> <span class="s1">&#39;Integer code in `{0, 1, 2}` determining mode of constraints with regards to officer numbers &#39;</span>
                       <span class="s1">&#39;and time - 0: no constraints, all HSI events run with no squeeze factor, 1: elastic constraints&#39;</span>
                       <span class="s1">&#39;, all HSI events run with squeeze factor, 2: hard constraints, only HSI events with no squeeze &#39;</span>
                       <span class="s1">&#39;factor run. N.B. This parameter is over-ridden if an argument is provided&#39;</span>
                       <span class="s1">&#39; to the module initialiser.&#39;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s1">&#39;mode_appt_constraints_postSwitch&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span> <span class="s1">&#39;If considering a mode switch alongside priority policy switch, specify in this parameter. &#39;</span>
                       <span class="s1">&#39;The switch occcurs in the year given in `year_policy_switch`.&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">PROPERTIES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;hs_is_inpatient&#39;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span> <span class="s1">&#39;Whether or not the person is currently an in-patient at any medical facility&#39;</span>
        <span class="p">),</span>
    <span class="p">}</span>

<div class="viewcode-block" id="HealthSystem.__init__"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">resourcefilepath</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">service_availability</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mode_appt_constraints</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cons_availability</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">beds_availability</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">randomise_queue</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">ignore_priority</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">policy_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">capabilities_coefficient</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_funded_or_actual_staffing</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">disable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">disable_and_reject_all</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">compute_squeeze_factor_to_district_level</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">hsi_event_count_log_period</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;month&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param name: Name to use for module, defaults to module class name if ``None``.</span>
<span class="sd">        :param resourcefilepath: Path to directory containing resource files.</span>
<span class="sd">        :param service_availability: A list of treatment IDs to allow.</span>
<span class="sd">        :param mode_appt_constraints: Integer code in ``{0, 1, 2}`` determining mode of</span>
<span class="sd">            constraints with regards to officer numbers and time - 0: no constraints,</span>
<span class="sd">            all HSI events run with no squeeze factor, 1: elastic constraints, all HSI</span>
<span class="sd">            events run with squeeze factor, 2: hard constraints, only HSI events with</span>
<span class="sd">            no squeeze factor run.</span>
<span class="sd">        :param cons_availability: If &#39;default&#39; then use the availability specified in the ResourceFile; if &#39;none&#39;, then</span>
<span class="sd">        let no consumable be ever be available; if &#39;all&#39;, then all consumables are always available. When using &#39;all&#39;</span>
<span class="sd">        or &#39;none&#39;, requests for consumables are not logged.</span>
<span class="sd">        :param beds_availability: If &#39;default&#39; then use the availability specified in the ResourceFile; if &#39;none&#39;, then</span>
<span class="sd">        let no beds be ever be available; if &#39;all&#39;, then all beds are always available.</span>
<span class="sd">        :param randomise_queue ensure that the queue is not model-dependent, i.e. properly randomised for equal topen</span>
<span class="sd">            and priority</span>
<span class="sd">        :param ignore_priority: If ``True`` do not use the priority information in HSI</span>
<span class="sd">            event to schedule</span>
<span class="sd">        :param policy_name: Name of priority policy that will be adopted if any</span>
<span class="sd">        :param capabilities_coefficient: Multiplier for the capabilities of health</span>
<span class="sd">            officers, if ``None`` set to ratio of initial population to estimated 2010</span>
<span class="sd">            population.</span>
<span class="sd">        :param use_funded_or_actual_staffing: If `actual`, then use the numbers and distribution of staff estimated to</span>
<span class="sd">            be available currently; If `funded`, then use the numbers and distribution of staff that are potentially</span>
<span class="sd">            available. If &#39;funded_plus`, then use a dataset in which the allocation of staff to facilities is tweaked</span>
<span class="sd">            so as to allow each appointment type to run at each facility_level in each district for which it is defined.</span>
<span class="sd">        :param disable: If ``True``, disables the health system (no constraints and no</span>
<span class="sd">            logging) and every HSI event runs.</span>
<span class="sd">        :param disable_and_reject_all: If ``True``, disable health system and no HSI</span>
<span class="sd">            events run</span>
<span class="sd">        :param compute_squeeze_factor_to_district_level: Whether to compute squeeze_factors to the district level, or</span>
<span class="sd">            the national level (which effectively pools the resources across all districts).</span>
<span class="sd">        :param hsi_event_count_log_period: Period over which to accumulate counts of HSI</span>
<span class="sd">            events that have run before logging and reseting counters. Should be on of</span>
<span class="sd">            strings ``&#39;day&#39;``, ``&#39;month&#39;``, ``&#39;year&#39;``. ``&#39;simulation&#39;`` to log at the</span>
<span class="sd">            end of each day, end of each calendar month, end of each calendar year or</span>
<span class="sd">            the end of the simulation respectively, or ``None`` to not track the HSI</span>
<span class="sd">            event details and frequencies.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resourcefilepath</span> <span class="o">=</span> <span class="n">resourcefilepath</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">disable</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">disable_and_reject_all</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="n">disable</span> <span class="ow">and</span> <span class="n">disable_and_reject_all</span><span class="p">),</span> <span class="p">(</span>
            <span class="s1">&#39;Cannot have both disable and disable_and_reject_all selected&#39;</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="n">ignore_priority</span> <span class="ow">and</span> <span class="n">policy_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span>
            <span class="s1">&#39;Cannot adopt a priority policy if the priority will be then ignored&#39;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">disable</span> <span class="o">=</span> <span class="n">disable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disable_and_reject_all</span> <span class="o">=</span> <span class="n">disable_and_reject_all</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mode_appt_constraints</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Will be the final determination of the `mode_appt_constraints&#39;</span>
        <span class="k">if</span> <span class="n">mode_appt_constraints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">mode_appt_constraints</span> <span class="ow">in</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg_mode_appt_constraints</span> <span class="o">=</span> <span class="n">mode_appt_constraints</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rng_for_hsi_queue</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Will be a dedicated RNG for the purpose of randomising the queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng_for_dx</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Will be a dedicated RNG for the purpose of determining Dx Test results</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">randomise_queue</span> <span class="o">=</span> <span class="n">randomise_queue</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_priority</span> <span class="o">=</span> <span class="n">ignore_priority</span>

        <span class="c1"># This default value will be overwritten if assumed policy is not None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lowest_priority_considered</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="c1"># Check that the name of policy being evaluated is included</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority_policy</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">policy_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">policy_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;Default&#39;</span><span class="p">,</span> <span class="s1">&#39;Test&#39;</span><span class="p">,</span> <span class="s1">&#39;Random&#39;</span><span class="p">,</span> <span class="s1">&#39;Naive&#39;</span><span class="p">,</span> <span class="s1">&#39;RMNCH&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;VerticalProgrammes&#39;</span><span class="p">,</span> <span class="s1">&#39;ClinicallyVulnerable&#39;</span><span class="p">,</span> <span class="s1">&#39;EHP_III&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;LCOA_EHP&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg_policy_name</span> <span class="o">=</span> <span class="n">policy_name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tclose_overwrite</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tclose_days_offset_overwrite</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Store the fast tracking channels that will be relevant for policy given the modules included</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_fasttrack</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># provided so that there is a default even before simulation is run</span>

        <span class="c1"># Store the argument provided for service_availability</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg_service_availabily</span> <span class="o">=</span> <span class="n">service_availability</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service_availability</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>  <span class="c1"># provided so that there is a default even before simulation is run</span>

        <span class="c1"># Check that the capabilities coefficient is correct</span>
        <span class="k">if</span> <span class="n">capabilities_coefficient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">capabilities_coefficient</span> <span class="o">&gt;=</span> <span class="mi">0</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">capabilities_coefficient</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capabilities_coefficient</span> <span class="o">=</span> <span class="n">capabilities_coefficient</span>

        <span class="c1"># Find which set of assumptions to use - those for the actual staff available or the funded staff available</span>
        <span class="k">if</span> <span class="n">use_funded_or_actual_staffing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">use_funded_or_actual_staffing</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;actual&#39;</span><span class="p">,</span> <span class="s1">&#39;funded&#39;</span><span class="p">,</span> <span class="s1">&#39;funded_plus&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg_use_funded_or_actual_staffing</span> <span class="o">=</span> <span class="n">use_funded_or_actual_staffing</span>

        <span class="c1"># Define (empty) list of registered disease modules (filled in at `initialise_simulation`)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recognised_modules_names</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Define the container for calls for health system interaction events</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HSI_EVENT_QUEUE</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hsi_event_queue_counter</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Counter to help with the sorting in the heapq</span>

        <span class="c1"># Store the argument provided for cons_availability</span>
        <span class="k">assert</span> <span class="n">cons_availability</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg_cons_availability</span> <span class="o">=</span> <span class="n">cons_availability</span>

        <span class="k">assert</span> <span class="n">beds_availability</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg_beds_availability</span> <span class="o">=</span> <span class="n">beds_availability</span>

        <span class="c1"># `compute_squeeze_factor_to_district_level` is a Boolean indicating whether the computation of squeeze_factors</span>
        <span class="c1"># should be specific to each district (when `True`), or if the computation of squeeze_factors should be on the</span>
        <span class="c1"># basis that resources from all districts can be effectively &quot;pooled&quot; (when `False).</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">compute_squeeze_factor_to_district_level</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_squeeze_factor_to_district_level</span> <span class="o">=</span> <span class="n">compute_squeeze_factor_to_district_level</span>

        <span class="c1"># Create the Diagnostic Test Manager to store and manage all Diagnostic Test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dx_manager</span> <span class="o">=</span> <span class="n">DxManager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Create the pointer that will be to the instance of BedDays used to track in-patient bed days</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bed_days</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Create the pointer that will be to the instance of Consumables used to determine availability of consumables.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consumables</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Create pointer for the HealthSystemScheduler event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">healthsystemscheduler</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Create pointer to the `HealthSystemSummaryCounter` helper class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_summary_counter</span> <span class="o">=</span> <span class="n">HealthSystemSummaryCounter</span><span class="p">()</span>

        <span class="c1"># Create counter for the running total of footprint of all the HSIs being run today</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running_total_footprint</span><span class="p">:</span> <span class="n">Counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_hsi_event_count_log_period</span> <span class="o">=</span> <span class="n">hsi_event_count_log_period</span>
        <span class="k">if</span> <span class="n">hsi_event_count_log_period</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;day&quot;</span><span class="p">,</span> <span class="s2">&quot;month&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;simulation&quot;</span><span class="p">}:</span>
            <span class="c1"># Counters for binning HSI events run (by unique integer keys) over</span>
            <span class="c1"># simulation period specified by hsi_event_count_log_period and cumulative</span>
            <span class="c1"># counts over previous log periods</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hsi_event_counts_log_period</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hsi_event_counts_cumulative</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
            <span class="c1"># Dictionary mapping from HSI event details to unique integer keys</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hsi_event_details</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

            <span class="c1"># Counters for binning HSI events that never ran (by unique integer keys) over</span>
            <span class="c1"># simulation period specified by hsi_event_count_log_period and cumulative</span>
            <span class="c1"># counts over previous log periods</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_never_ran_hsi_event_counts_log_period</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_never_ran_hsi_event_counts_cumulative</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
            <span class="c1"># Dictionary mapping from HSI event details to unique integer keys</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_never_ran_hsi_event_details</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">hsi_event_count_log_period</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;hsi_event_count_log_period argument should be one of &#39;day&#39;, &#39;month&#39; &quot;</span>
                <span class="s2">&quot;&#39;year&#39;, &#39;simulation&#39; or None.&quot;</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem.read_parameters"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.read_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">read_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_folder</span><span class="p">):</span>

        <span class="n">path_to_resourcefiles_for_healthsystem</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resourcefilepath</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;healthsystem&#39;</span>

        <span class="c1"># Read parameters for overall performance of the HealthSystem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_parameters_from_dataframe</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">path_to_resourcefiles_for_healthsystem</span> <span class="o">/</span> <span class="s1">&#39;ResourceFile_HealthSystem_parameters.csv&#39;</span>
        <span class="p">))</span>

        <span class="c1"># Load basic information about the organization of the HealthSystem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Master_Facilities_List&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">path_to_resourcefiles_for_healthsystem</span> <span class="o">/</span> <span class="s1">&#39;organisation&#39;</span> <span class="o">/</span> <span class="s1">&#39;ResourceFile_Master_Facilities_List.csv&#39;</span><span class="p">)</span>

        <span class="c1"># Load ResourceFiles that define appointment and officer types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Officer_Types_Table&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">path_to_resourcefiles_for_healthsystem</span> <span class="o">/</span> <span class="s1">&#39;human_resources&#39;</span> <span class="o">/</span> <span class="s1">&#39;definitions&#39;</span> <span class="o">/</span>
            <span class="s1">&#39;ResourceFile_Officer_Types_Table.csv&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Appt_Types_Table&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">path_to_resourcefiles_for_healthsystem</span> <span class="o">/</span> <span class="s1">&#39;human_resources&#39;</span> <span class="o">/</span> <span class="s1">&#39;definitions&#39;</span> <span class="o">/</span>
            <span class="s1">&#39;ResourceFile_Appt_Types_Table.csv&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Appt_Offered_By_Facility_Level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">path_to_resourcefiles_for_healthsystem</span> <span class="o">/</span> <span class="s1">&#39;human_resources&#39;</span> <span class="o">/</span> <span class="s1">&#39;definitions&#39;</span> <span class="o">/</span>
            <span class="s1">&#39;ResourceFile_ApptType_By_FacLevel.csv&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Appt_Time_Table&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">path_to_resourcefiles_for_healthsystem</span> <span class="o">/</span> <span class="s1">&#39;human_resources&#39;</span> <span class="o">/</span> <span class="s1">&#39;definitions&#39;</span> <span class="o">/</span>
            <span class="s1">&#39;ResourceFile_Appt_Time_Table.csv&#39;</span><span class="p">)</span>

        <span class="c1"># Load &#39;Daily_Capabilities&#39; (for both actual and funded)</span>
        <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;actual&#39;</span><span class="p">,</span> <span class="s1">&#39;funded&#39;</span><span class="p">,</span> <span class="s1">&#39;funded_plus&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Daily_Capabilities_</span><span class="si">{</span><span class="n">_i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                <span class="n">path_to_resourcefiles_for_healthsystem</span> <span class="o">/</span> <span class="s1">&#39;human_resources&#39;</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">/</span>
                <span class="s1">&#39;ResourceFile_Daily_Capabilities.csv&#39;</span><span class="p">)</span>

        <span class="c1"># Read in ResourceFile_Consumables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;item_and_package_code_lookups&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">path_to_resourcefiles_for_healthsystem</span> <span class="o">/</span> <span class="s1">&#39;consumables&#39;</span> <span class="o">/</span> <span class="s1">&#39;ResourceFile_Consumables_Items_and_Packages.csv&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;availability_estimates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">path_to_resourcefiles_for_healthsystem</span> <span class="o">/</span> <span class="s1">&#39;consumables&#39;</span> <span class="o">/</span> <span class="s1">&#39;ResourceFile_Consumables_availability_small.csv&#39;</span><span class="p">)</span>

        <span class="c1"># Data on the number of beds available of each type by facility_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;BedCapacity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">path_to_resourcefiles_for_healthsystem</span> <span class="o">/</span> <span class="s1">&#39;infrastructure_and_equipment&#39;</span> <span class="o">/</span> <span class="s1">&#39;ResourceFile_Bed_Capacity.csv&#39;</span><span class="p">)</span>

        <span class="c1"># Data on the priority of each Treatment_ID that should be adopted in the queueing system according to different</span>
        <span class="c1"># priority policies. Load all policies at this stage, and decide later which one to adopt.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;priority_rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">path_to_resourcefiles_for_healthsystem</span> <span class="o">/</span> <span class="s1">&#39;priority_policies&#39;</span> <span class="o">/</span>
                                                         <span class="s1">&#39;ResourceFile_PriorityRanking_ALLPOLICIES.xlsx&#39;</span><span class="p">,</span>
                                                         <span class="n">sheet_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem.pre_initialise_population"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.pre_initialise_population">[docs]</a>    <span class="k">def</span> <span class="nf">pre_initialise_population</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate the accessory classes used by the HealthSystem and pass to them the data that has been read.&quot;&quot;&quot;</span>
        <span class="c1"># Create dedicated RNGs for separate functions done by the HealthSystem module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng_for_hsi_queue</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">31</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng_for_dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">31</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">rng_for_consumables</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">31</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Determine mode_appt_constraints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode_appt_constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mode_appt_constraints</span><span class="p">()</span>

        <span class="c1"># Determine service_availability</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service_availability</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_service_availability</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">process_human_resources_files</span><span class="p">(</span>
            <span class="n">use_funded_or_actual_staffing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_use_funded_or_actual_staffing</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># Initialise the BedDays class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bed_days</span> <span class="o">=</span> <span class="n">BedDays</span><span class="p">(</span><span class="n">hs_module</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                                <span class="n">availability</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_beds_availability</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bed_days</span><span class="o">.</span><span class="n">pre_initialise_population</span><span class="p">()</span>

        <span class="c1"># Initialise the Consumables class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consumables</span> <span class="o">=</span> <span class="n">Consumables</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">update_consumables_availability_to_represent_merging_of_levels_1b_and_2</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;availability_estimates&#39;</span><span class="p">]),</span>
            <span class="n">rng</span><span class="o">=</span><span class="n">rng_for_consumables</span><span class="p">,</span>
            <span class="n">availability</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cons_availability</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tclose_overwrite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;tclose_overwrite&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tclose_days_offset_overwrite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;tclose_days_offset_overwrite&#39;</span><span class="p">]</span>

        <span class="c1"># Set up framework for considering a priority policy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_priority_policy</span><span class="p">()</span></div>

<div class="viewcode-block" id="HealthSystem.initialise_population"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.initialise_population">[docs]</a>    <span class="k">def</span> <span class="nf">initialise_population</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bed_days</span><span class="o">.</span><span class="n">initialise_population</span><span class="p">(</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem.initialise_simulation"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.initialise_simulation">[docs]</a>    <span class="k">def</span> <span class="nf">initialise_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span><span class="p">):</span>
        <span class="c1"># If capabilities coefficient was not explicitly specified, use initial population scaling factor</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">capabilities_coefficient</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">capabilities_coefficient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;Demography&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">initial_model_to_data_popsize_ratio</span>

        <span class="c1"># Set the tracker in preparation for the simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bed_days</span><span class="o">.</span><span class="n">initialise_beddays_tracker</span><span class="p">(</span>
            <span class="n">model_to_data_popsize_ratio</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;Demography&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">initial_model_to_data_popsize_ratio</span>
        <span class="p">)</span>

        <span class="c1"># Set the consumables modules in preparation for the simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consumables</span><span class="o">.</span><span class="n">on_start_of_day</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>

        <span class="c1"># Capture list of disease modules:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recognised_modules_names</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">m</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">Metadata</span><span class="o">.</span><span class="n">USES_HEALTHSYSTEM</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">METADATA</span>
        <span class="p">]</span>

        <span class="c1"># Check that set of districts of residence in population are subset of districts from</span>
        <span class="c1"># `self._facilities_for_each_district`, which is derived from self.parameters[&#39;Master_Facilities_List&#39;]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">districts_of_residence</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s2">&quot;district_of_residence&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span>
            <span class="n">districts_of_residence</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">per_level_facilities</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">per_level_facilities</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_facilities_for_each_district</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">),</span> <span class="p">(</span>
            <span class="s2">&quot;At least one district_of_residence value in population not present in &quot;</span>
            <span class="s2">&quot;self._facilities_for_each_district resource file&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Launch the healthsystem scheduler (a regular event occurring each day) [if not disabled]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disable</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_and_reject_all</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">healthsystemscheduler</span> <span class="o">=</span> <span class="n">HealthSystemScheduler</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">healthsystemscheduler</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>

        <span class="c1"># Schedule priority policy and mode_appt_constraints change</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">HealthSystemChangePriorityPolicyAndMode</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                           <span class="n">Date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;year_policy_switch&quot;</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span></div>

<div class="viewcode-block" id="HealthSystem.on_birth"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.on_birth">[docs]</a>    <span class="k">def</span> <span class="nf">on_birth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mother_id</span><span class="p">,</span> <span class="n">child_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bed_days</span><span class="o">.</span><span class="n">on_birth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="p">,</span> <span class="n">mother_id</span><span class="p">,</span> <span class="n">child_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem.on_simulation_end"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.on_simulation_end">[docs]</a>    <span class="k">def</span> <span class="nf">on_simulation_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Put out to the log the information from the tracker of the last day of the simulation&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bed_days</span><span class="o">.</span><span class="n">on_simulation_end</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consumables</span><span class="o">.</span><span class="n">on_simulation_end</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hsi_event_count_log_period</span> <span class="o">==</span> <span class="s2">&quot;simulation&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_hsi_event_counts_to_log_and_reset</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_never_ran_hsi_event_counts_to_log_and_reset</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hsi_event_count_log_period</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger_summary</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="n">key</span><span class="o">=</span><span class="s2">&quot;hsi_event_details&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Map from integer keys to hsi event detail dictionaries&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;hsi_event_key_to_event_details&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="n">k</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">_asdict</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hsi_event_details</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="n">logger_summary</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="n">key</span><span class="o">=</span><span class="s2">&quot;never_ran_hsi_event_details&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Map from integer keys to never ran hsi event detail dictionaries&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;never_ran_hsi_event_key_to_event_details&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="n">k</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">_asdict</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_never_ran_hsi_event_details</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem.setup_priority_policy"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.setup_priority_policy">[docs]</a>    <span class="k">def</span> <span class="nf">setup_priority_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Determine name of policy to be considered **at the start of the simulation**.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_priority_policy_initial</span><span class="p">()</span>

        <span class="c1"># If adopting a policy, initialise here all other relevant variables.</span>
        <span class="c1"># Use of blank instead of None is not ideal, however couldn&#39;t seem to recover actual</span>
        <span class="c1"># None from parameter file.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_priority_policy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">priority_policy</span><span class="p">)</span>

        <span class="c1"># Initialise the fast-tracking routes.</span>
        <span class="c1"># The attributes that can be looked up to determine whether a person might be eligible</span>
        <span class="c1"># for fast-tracking, as well as the corresponding fast-tracking channels, depend on the modules</span>
        <span class="c1"># included in the simulation. Store the attributes&amp;channels pairs allowed given the modules included</span>
        <span class="c1"># to avoid having to recheck which modules are saved every time an HSI_Event is scheduled.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_fasttrack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;age_exact_years&#39;</span><span class="p">,</span> <span class="s1">&#39;FT_if_5orUnder&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;Contraception&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span> <span class="ow">or</span> <span class="s1">&#39;SimplifiedBirths&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_fasttrack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;is_pregnant&#39;</span><span class="p">,</span> <span class="s1">&#39;FT_if_pregnant&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;Hiv&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_fasttrack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;hv_diagnosed&#39;</span><span class="p">,</span> <span class="s1">&#39;FT_if_Hivdiagnosed&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;Tb&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_fasttrack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;tb_diagnosed&#39;</span><span class="p">,</span> <span class="s1">&#39;FT_if_tbdiagnosed&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="HealthSystem.process_human_resources_files"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.process_human_resources_files">[docs]</a>    <span class="k">def</span> <span class="nf">process_human_resources_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_funded_or_actual_staffing</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create the data-structures needed from the information read into the parameters.&quot;&quot;&quot;</span>

        <span class="c1"># * Define Facility Levels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_facility_levels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Master_Facilities_List&#39;</span><span class="p">][</span><span class="s1">&#39;Facility_Level&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="p">{</span><span class="s1">&#39;5&#39;</span><span class="p">}</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_facility_levels</span> <span class="o">==</span> <span class="p">{</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;1a&#39;</span><span class="p">,</span> <span class="s1">&#39;1b&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">}</span>  <span class="c1"># todo soft code this?</span>

        <span class="c1"># * Define Appointment Types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_appointment_types</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Appt_Types_Table&#39;</span><span class="p">][</span><span class="s1">&#39;Appt_Type_Code&#39;</span><span class="p">])</span>

        <span class="c1"># * Define the Officers Needed For Each Appointment</span>
        <span class="c1"># (Store data as dict of dicts, with outer-dict indexed by string facility level and</span>
        <span class="c1"># inner-dict indexed by string type code with values corresponding to list of (named)</span>
        <span class="c1"># tuples of appointment officer type codes and time taken.)</span>
        <span class="n">appt_time_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Appt_Time_Table&#39;</span><span class="p">]</span>
        <span class="n">appt_times_per_level_and_type</span> <span class="o">=</span> <span class="p">{</span><span class="n">_facility_level</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span> <span class="k">for</span> <span class="n">_facility_level</span> <span class="ow">in</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">_facility_levels</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">appt_time_tuple</span> <span class="ow">in</span> <span class="n">appt_time_data</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
            <span class="n">appt_times_per_level_and_type</span><span class="p">[</span>
                <span class="n">appt_time_tuple</span><span class="o">.</span><span class="n">Facility_Level</span>
            <span class="p">][</span>
                <span class="n">appt_time_tuple</span><span class="o">.</span><span class="n">Appt_Type_Code</span>
            <span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">AppointmentSubunit</span><span class="p">(</span>
                    <span class="n">officer_type</span><span class="o">=</span><span class="n">appt_time_tuple</span><span class="o">.</span><span class="n">Officer_Category</span><span class="p">,</span>
                    <span class="n">time_taken</span><span class="o">=</span><span class="n">appt_time_tuple</span><span class="o">.</span><span class="n">Time_Taken_Mins</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="nb">sum</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">appt_info_list</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_facility_levels</span>
                <span class="k">for</span> <span class="n">appt_info_list</span> <span class="ow">in</span> <span class="n">appt_times_per_level_and_type</span><span class="p">[</span><span class="n">level</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">appt_time_data</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_appt_times</span> <span class="o">=</span> <span class="n">appt_times_per_level_and_type</span>

        <span class="c1"># * Define Which Appointments Are Possible At Each Facility Level</span>
        <span class="n">appt_type_per_level_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Appt_Offered_By_Facility_Level&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_appt_type_by_facLevel</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">_facility_level</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span>
                <span class="n">appt_type_per_level_data</span><span class="p">[</span><span class="s1">&#39;Appt_Type_Code&#39;</span><span class="p">][</span>
                    <span class="n">appt_type_per_level_data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Facility_Level_</span><span class="si">{</span><span class="n">_facility_level</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">_facility_level</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_facility_levels</span>
        <span class="p">}</span>

        <span class="c1"># Also store data as dict of dicts, with outer-dict indexed by string facility level and</span>
        <span class="c1"># inner-dict indexed by district name with values corresponding to (named) tuples of</span>
        <span class="c1"># facility ID and name</span>
        <span class="c1"># Get look-up of the districts (by name) in each region (by name)</span>
        <span class="n">districts_in_region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;Demography&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;districts_in_region&#39;</span><span class="p">]</span>
        <span class="n">all_districts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;Demography&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;district_num_to_district_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="n">facilities_per_level_and_district</span> <span class="o">=</span> <span class="p">{</span><span class="n">_facility_level</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">_facility_level</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_facility_levels</span><span class="p">}</span>
        <span class="n">facilities_by_facility_id</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">facility_tuple</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Master_Facilities_List&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
            <span class="n">_facility_info</span> <span class="o">=</span> <span class="n">FacilityInfo</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">facility_tuple</span><span class="o">.</span><span class="n">Facility_ID</span><span class="p">,</span>
                                          <span class="n">name</span><span class="o">=</span><span class="n">facility_tuple</span><span class="o">.</span><span class="n">Facility_Name</span><span class="p">,</span>
                                          <span class="n">level</span><span class="o">=</span><span class="n">facility_tuple</span><span class="o">.</span><span class="n">Facility_Level</span><span class="p">,</span>
                                          <span class="n">region</span><span class="o">=</span><span class="n">facility_tuple</span><span class="o">.</span><span class="n">Region</span>
                                          <span class="p">)</span>

            <span class="n">facilities_by_facility_id</span><span class="p">[</span><span class="n">facility_tuple</span><span class="o">.</span><span class="n">Facility_ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">_facility_info</span>

            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">facility_tuple</span><span class="o">.</span><span class="n">District</span><span class="p">):</span>
                <span class="c1"># A facility that is specific to a district:</span>
                <span class="n">facilities_per_level_and_district</span><span class="p">[</span><span class="n">facility_tuple</span><span class="o">.</span><span class="n">Facility_Level</span><span class="p">][</span><span class="n">facility_tuple</span><span class="o">.</span><span class="n">District</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">_facility_info</span>

            <span class="k">elif</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">facility_tuple</span><span class="o">.</span><span class="n">District</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">facility_tuple</span><span class="o">.</span><span class="n">Region</span><span class="p">):</span>
                <span class="c1"># A facility that is specific to region (and not a district):</span>
                <span class="k">for</span> <span class="n">_district</span> <span class="ow">in</span> <span class="n">districts_in_region</span><span class="p">[</span><span class="n">facility_tuple</span><span class="o">.</span><span class="n">Region</span><span class="p">]:</span>
                    <span class="n">facilities_per_level_and_district</span><span class="p">[</span><span class="n">facility_tuple</span><span class="o">.</span><span class="n">Facility_Level</span><span class="p">][</span><span class="n">_district</span><span class="p">]</span> <span class="o">=</span> <span class="n">_facility_info</span>

            <span class="k">elif</span> <span class="p">(</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">facility_tuple</span><span class="o">.</span><span class="n">District</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">facility_tuple</span><span class="o">.</span><span class="n">Region</span><span class="p">)</span> <span class="ow">and</span>
                <span class="p">(</span><span class="n">facility_tuple</span><span class="o">.</span><span class="n">Facility_Level</span> <span class="o">!=</span> <span class="s1">&#39;5&#39;</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="c1"># A facility that is National (not specific to a region or a district) (ignoring level 5 (headquarters))</span>
                <span class="k">for</span> <span class="n">_district</span> <span class="ow">in</span> <span class="n">all_districts</span><span class="p">:</span>
                    <span class="n">facilities_per_level_and_district</span><span class="p">[</span><span class="n">facility_tuple</span><span class="o">.</span><span class="n">Facility_Level</span><span class="p">][</span><span class="n">_district</span><span class="p">]</span> <span class="o">=</span> <span class="n">_facility_info</span>

        <span class="c1"># Check that there is facility of every level for every district:</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span>
            <span class="n">all_districts</span> <span class="o">==</span> <span class="n">facilities_per_level_and_district</span><span class="p">[</span><span class="n">_facility_level</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">_facility_level</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_facility_levels</span>
        <span class="p">),</span> <span class="s2">&quot;There is not one of each facility type available to each district.&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_facility_by_facility_id</span> <span class="o">=</span> <span class="n">facilities_by_facility_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_facilities_for_each_district</span> <span class="o">=</span> <span class="n">facilities_per_level_and_district</span>

        <span class="c1"># * Store &#39;DailyCapabilities&#39; in correct format and using the specified underlying assumptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_daily_capabilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_daily_capabilities</span><span class="p">(</span><span class="n">use_funded_or_actual_staffing</span><span class="p">)</span>

        <span class="c1"># Also, store the set of officers with non-zero daily availability</span>
        <span class="c1"># (This is used for checking that scheduled HSI events do not make appointment requiring officers that are</span>
        <span class="c1"># never available.)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_officers_with_availability</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_daily_capabilities</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_daily_capabilities</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="HealthSystem.format_daily_capabilities"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.format_daily_capabilities">[docs]</a>    <span class="k">def</span> <span class="nf">format_daily_capabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_funded_or_actual_staffing</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This will updates the dataframe for the self.parameters[&#39;Daily_Capabilities&#39;] so as to include</span>
<span class="sd">        every permutation of officer_type_code and facility_id, with zeros against permutations where no capacity</span>
<span class="sd">        is available.</span>

<span class="sd">        It also give the dataframe an index that is useful for merging on (based on Facility_ID and Officer Type)</span>

<span class="sd">        (This is so that its easier to track where demands are being placed where there is no capacity)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get the capabilities data imported (according to the specified underlying assumptions).</span>
        <span class="n">capabilities</span> <span class="o">=</span> <span class="n">pool_capabilities_at_levels_1b_and_2</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Daily_Capabilities_</span><span class="si">{</span><span class="n">use_funded_or_actual_staffing</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">])</span>
        <span class="n">capabilities</span> <span class="o">=</span> <span class="n">capabilities</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Officer_Category&#39;</span><span class="p">:</span> <span class="s1">&#39;Officer_Type_Code&#39;</span><span class="p">})</span>  <span class="c1"># neaten</span>

        <span class="c1"># Create dataframe containing background information about facility and officer types</span>
        <span class="n">facility_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Master_Facilities_List&#39;</span><span class="p">][</span><span class="s1">&#39;Facility_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">officer_type_codes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Officer_Types_Table&#39;</span><span class="p">][</span><span class="s1">&#39;Officer_Category&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="c1"># todo - &lt;-- avoid use of the file or define differently?</span>

        <span class="c1"># # naming to be not with _ within the name of an oficer</span>
        <span class="n">facs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">officers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">facility_ids</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">officer_type_codes</span><span class="p">:</span>
                <span class="n">facs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">officers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>

        <span class="n">capabilities_ex</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Facility_ID&#39;</span><span class="p">:</span> <span class="n">facs</span><span class="p">,</span> <span class="s1">&#39;Officer_Type_Code&#39;</span><span class="p">:</span> <span class="n">officers</span><span class="p">})</span>

        <span class="c1"># Merge in information about facility from Master Facilities List</span>
        <span class="n">mfl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Master_Facilities_List&#39;</span><span class="p">]</span>
        <span class="n">capabilities_ex</span> <span class="o">=</span> <span class="n">capabilities_ex</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">mfl</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;Facility_ID&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>

        <span class="c1"># Merge in information about officers</span>
        <span class="c1"># officer_types = self.parameters[&#39;Officer_Types_Table&#39;][[&#39;Officer_Type_Code&#39;, &#39;Officer_Type&#39;]]</span>
        <span class="c1"># capabilities_ex = capabilities_ex.merge(officer_types, on=&#39;Officer_Type_Code&#39;, how=&#39;left&#39;)</span>

        <span class="c1"># Merge in the capabilities (minutes available) for each officer type (inferring zero minutes where</span>
        <span class="c1"># there is no entry in the imported capabilities table)</span>
        <span class="n">capabilities_ex</span> <span class="o">=</span> <span class="n">capabilities_ex</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">capabilities</span><span class="p">[[</span><span class="s1">&#39;Facility_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;Officer_Type_Code&#39;</span><span class="p">,</span> <span class="s1">&#39;Total_Mins_Per_Day&#39;</span><span class="p">]],</span>
            <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Facility_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;Officer_Type_Code&#39;</span><span class="p">],</span>
            <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">capabilities_ex</span> <span class="o">=</span> <span class="n">capabilities_ex</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Give the standard index:</span>
        <span class="n">capabilities_ex</span> <span class="o">=</span> <span class="n">capabilities_ex</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span>
            <span class="s1">&#39;FacilityID_&#39;</span>
            <span class="o">+</span> <span class="n">capabilities_ex</span><span class="p">[</span><span class="s1">&#39;Facility_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="o">+</span> <span class="s1">&#39;_Officer_&#39;</span>
            <span class="o">+</span> <span class="n">capabilities_ex</span><span class="p">[</span><span class="s1">&#39;Officer_Type_Code&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Rename &#39;Total_Minutes_Per_Day&#39;</span>
        <span class="n">capabilities_ex</span> <span class="o">=</span> <span class="n">capabilities_ex</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Total_Mins_Per_Day&#39;</span><span class="p">:</span> <span class="s1">&#39;Total_Minutes_Per_Day&#39;</span><span class="p">})</span>

        <span class="c1"># Checks</span>
        <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">capabilities_ex</span><span class="p">[</span><span class="s1">&#39;Total_Minutes_Per_Day&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="n">capabilities</span><span class="p">[</span><span class="s1">&#39;Total_Mins_Per_Day&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mf">1e-7</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">capabilities_ex</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">facility_ids</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">officer_type_codes</span><span class="p">)</span>

        <span class="c1"># return the pd.Series of `Total_Minutes_Per_Day&#39; indexed for each type of officer at each facility</span>
        <span class="k">return</span> <span class="n">capabilities_ex</span><span class="p">[</span><span class="s1">&#39;Total_Minutes_Per_Day&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="HealthSystem.update_consumables_availability_to_represent_merging_of_levels_1b_and_2"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.update_consumables_availability_to_represent_merging_of_levels_1b_and_2">[docs]</a>    <span class="k">def</span> <span class="nf">update_consumables_availability_to_represent_merging_of_levels_1b_and_2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_original</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;To represent that facility levels &#39;1b&#39; and &#39;2&#39; are merged together under the label &#39;2&#39;, we replace the</span>
<span class="sd">        availability of consumables at level 2 with new values.&quot;&quot;&quot;</span>

        <span class="c1"># get master facilities list</span>
        <span class="n">mfl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Master_Facilities_List&#39;</span><span class="p">]</span>

        <span class="c1"># merge in facility level</span>
        <span class="n">dfx</span> <span class="o">=</span> <span class="n">df_original</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">mfl</span><span class="p">[[</span><span class="s1">&#39;Facility_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;District&#39;</span><span class="p">,</span> <span class="s1">&#39;Facility_Level&#39;</span><span class="p">]],</span>
            <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;Facility_ID&#39;</span><span class="p">,</span>
            <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;Facility_ID&#39;</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span>
        <span class="p">)</span>

        <span class="c1"># compute the updated availability at the merged level &#39;1b&#39; and &#39;2&#39;</span>
        <span class="n">availability_at_1b_and_2</span> <span class="o">=</span> \
            <span class="n">dfx</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">dfx</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">~</span><span class="n">dfx</span><span class="p">[</span><span class="s1">&#39;Facility_Level&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">AVAILABILITY_OF_CONSUMABLES_AT_MERGED_LEVELS_1B_AND_2</span><span class="p">)])</span> \
               <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;District&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;item_code&#39;</span><span class="p">])[</span><span class="s1">&#39;available_prop&#39;</span><span class="p">]</span> \
               <span class="o">.</span><span class="n">mean</span><span class="p">()</span> \
               <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>\
               <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Facility_Level</span><span class="o">=</span><span class="n">LABEL_FOR_MERGED_FACILITY_LEVELS_1B_AND_2</span><span class="p">)</span>

        <span class="c1"># assign facility_id</span>
        <span class="n">availability_at_1b_and_2</span> <span class="o">=</span> <span class="n">availability_at_1b_and_2</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">mfl</span><span class="p">[[</span><span class="s1">&#39;Facility_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;District&#39;</span><span class="p">,</span> <span class="s1">&#39;Facility_Level&#39;</span><span class="p">]],</span>
            <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;District&#39;</span><span class="p">,</span> <span class="s1">&#39;Facility_Level&#39;</span><span class="p">],</span>
            <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;District&#39;</span><span class="p">,</span> <span class="s1">&#39;Facility_Level&#39;</span><span class="p">],</span>
            <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span>
        <span class="p">)</span>

        <span class="c1"># assign these availabilities to the corresponding level 2 facilities (dropping the original values)</span>
        <span class="n">df_updated</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
            <span class="n">dfx</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">dfx</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">dfx</span><span class="p">[</span><span class="s1">&#39;Facility_Level&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">LABEL_FOR_MERGED_FACILITY_LEVELS_1B_AND_2</span><span class="p">]),</span>
            <span class="n">availability_at_1b_and_2</span><span class="p">[</span><span class="n">dfx</span><span class="o">.</span><span class="n">columns</span><span class="p">],</span>
            <span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Facility_Level&#39;</span><span class="p">,</span> <span class="s1">&#39;District&#39;</span><span class="p">])</span>\
         <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;Facility_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;item_code&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># check size/shape/dtypes preserved</span>
        <span class="k">assert</span> <span class="n">df_updated</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">df_original</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">df_updated</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="n">df_original</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">df_updated</span><span class="o">.</span><span class="n">dtypes</span> <span class="o">==</span> <span class="n">df_original</span><span class="o">.</span><span class="n">dtypes</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="c1"># check values the same for everything apart from the facility level &#39;2&#39; facilities</span>
        <span class="n">facilities_with_any_differences</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="n">df_updated</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="o">~</span><span class="p">(</span><span class="n">df_original</span> <span class="o">==</span> <span class="n">df_updated</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="s1">&#39;Facility_ID&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">level2_facilities</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="n">mfl</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mfl</span><span class="p">[</span><span class="s1">&#39;Facility_Level&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;Facility_ID&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">facilities_with_any_differences</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">level2_facilities</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_updated</span></div>

<div class="viewcode-block" id="HealthSystem.get_service_availability"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.get_service_availability">[docs]</a>    <span class="k">def</span> <span class="nf">get_service_availability</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns service availability. (Should be equal to what is specified by the parameter, but overwrite with what</span>
<span class="sd">        was provided in argument if an argument was specified -- provided for backward compatibility/debugging.)&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_service_availabily</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">service_availability</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Service_Availability&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">service_availability</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_service_availabily</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">service_availability</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>

        <span class="c1"># Log the service_availability</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Running Health System With the Following Service Availability: &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">service_availability</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">service_availability</span></div>

<div class="viewcode-block" id="HealthSystem.get_cons_availability"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.get_cons_availability">[docs]</a>    <span class="k">def</span> <span class="nf">get_cons_availability</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns consumables availability. (Should be equal to what is specified by the parameter, but overwrite with</span>
<span class="sd">        what was provided in argument if an argument was specified -- provided for backward compatibility/debugging.)&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_cons_availability</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_cons_availability</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;cons_availability&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_cons_availability</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_cons_availability</span>

        <span class="c1"># Log the service_availability</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Running Health System With the Following Consumables Availability: &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_cons_availability</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

        <span class="k">return</span> <span class="n">_cons_availability</span></div>

<div class="viewcode-block" id="HealthSystem.get_beds_availability"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.get_beds_availability">[docs]</a>    <span class="k">def</span> <span class="nf">get_beds_availability</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns beds availability. (Should be equal to what is specified by the parameter, but overwrite with</span>
<span class="sd">        what was provided in argument if an argument was specified -- provided for backward compatibility/debugging.)&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_beds_availability</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_beds_availability</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;beds_availability&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_beds_availability</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_beds_availability</span>

        <span class="c1"># For logical consistency, when the HealthSystem is disabled, beds_availability should be &#39;all&#39;, irrespective of</span>
        <span class="c1"># what arguments/parameters are provided.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">:</span>
            <span class="n">_beds_availability</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>

        <span class="c1"># Log the service_availability</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Running Health System With the Following Beds Availability: &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_beds_availability</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

        <span class="k">return</span> <span class="n">_beds_availability</span></div>

<div class="viewcode-block" id="HealthSystem.schedule_to_call_never_ran_on_date"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.schedule_to_call_never_ran_on_date">[docs]</a>    <span class="k">def</span> <span class="nf">schedule_to_call_never_ran_on_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hsi_event</span><span class="p">:</span> <span class="s1">&#39;HSI_Event&#39;</span><span class="p">,</span> <span class="n">tdate</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Function to schedule never_ran being called on a given date&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">HSIEventWrapper</span><span class="p">(</span><span class="n">hsi_event</span><span class="o">=</span><span class="n">hsi_event</span><span class="p">,</span> <span class="n">run_hsi</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">tdate</span><span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem.get_mode_appt_constraints"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.get_mode_appt_constraints">[docs]</a>    <span class="k">def</span> <span class="nf">get_mode_appt_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns `mode_appt_constraints`. (Should be equal to what is specified by the parameter, but overwrite with</span>
<span class="sd">        what was provided in argument if an argument was specified -- provided for backward compatibility/debugging.)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;mode_appt_constraints&#39;</span><span class="p">]</span> \
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_mode_appt_constraints</span> <span class="ow">is</span> <span class="kc">None</span> \
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_mode_appt_constraints</span></div>

<div class="viewcode-block" id="HealthSystem.get_use_funded_or_actual_staffing"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.get_use_funded_or_actual_staffing">[docs]</a>    <span class="k">def</span> <span class="nf">get_use_funded_or_actual_staffing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns `use_funded_or_actual_staffing`. (Should be equal to what is specified by the parameter, but</span>
<span class="sd">        overwrite with what was provided in argument if an argument was specified -- provided for backward</span>
<span class="sd">        compatibility/debugging.)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;use_funded_or_actual_staffing&#39;</span><span class="p">]</span> \
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_use_funded_or_actual_staffing</span> <span class="ow">is</span> <span class="kc">None</span> \
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_use_funded_or_actual_staffing</span></div>

<div class="viewcode-block" id="HealthSystem.get_priority_policy_initial"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.get_priority_policy_initial">[docs]</a>    <span class="k">def</span> <span class="nf">get_priority_policy_initial</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns `priority_policy`. (Should be equal to what is specified by the parameter, but</span>
<span class="sd">        overwrite with what was provided in argument if an argument was specified -- provided for backward</span>
<span class="sd">        compatibility/debugging.)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;policy_name&#39;</span><span class="p">]</span> \
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_policy_name</span> <span class="ow">is</span> <span class="kc">None</span> \
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_policy_name</span></div>

<div class="viewcode-block" id="HealthSystem.load_priority_policy"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.load_priority_policy">[docs]</a>    <span class="k">def</span> <span class="nf">load_priority_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">policy</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="c1"># Select the chosen policy from dictionary of all possible policies</span>
            <span class="n">Policy_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;priority_rank&#39;</span><span class="p">][</span><span class="n">policy</span><span class="p">]</span>

            <span class="c1"># If a policy is adopted, following variable *must* always be taken from policy.</span>
            <span class="c1"># Over-write any other values here.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lowest_priority_considered</span> <span class="o">=</span> <span class="n">Policy_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">Policy_df</span><span class="p">[</span><span class="s1">&#39;Treatment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;lowest_priority_considered&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Priority&#39;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Convert policy dataframe into dictionary to speed-up look-up process.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">priority_rank_dict</span> <span class="o">=</span> \
                <span class="n">Policy_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Treatment&quot;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_rank_dict</span><span class="p">[</span><span class="s2">&quot;lowest_priority_considered&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="HealthSystem.schedule_hsi_event"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.schedule_hsi_event">[docs]</a>    <span class="k">def</span> <span class="nf">schedule_hsi_event</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">hsi_event</span><span class="p">:</span> <span class="s1">&#39;HSI_Event&#39;</span><span class="p">,</span>
        <span class="n">priority</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">topen</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span>
        <span class="n">tclose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">do_hsi_event_checks</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Schedule a health system interaction (HSI) event.</span>

<span class="sd">        :param hsi_event: The HSI event to be scheduled.</span>
<span class="sd">        :param priority: The priority for the HSI event: 0 (highest), 1 or 2 (lowest)</span>
<span class="sd">        :param topen: The earliest date at which the HSI event should run.</span>
<span class="sd">        :param tclose: The latest date at which the HSI event should run. Set to one week after ``topen`` if ``None``.</span>
<span class="sd">        :param do_hsi_event_checks: Whether to perform sanity checks on the passed ``hsi_event`` argument to check that</span>
<span class="sd">         it constitutes a valid HSI event. This is intended for allowing disabling of these checks when scheduling</span>
<span class="sd">         multiple HSI events of the same ``HSI_Event`` subclass together, in which case typically performing these</span>
<span class="sd">         checks for each individual HSI event of the shared type will be redundant.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If there is no specified tclose time then set this to a week after topen.</span>
        <span class="c1"># This should be a boolean, not int! Still struggling to get a boolean variable from resource file</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tclose_overwrite</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">tclose</span> <span class="o">=</span> <span class="n">topen</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tclose_days_offset_overwrite</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tclose</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tclose</span> <span class="o">=</span> <span class="n">topen</span> <span class="o">+</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

        <span class="c1"># Check topen is not in the past</span>
        <span class="k">assert</span> <span class="n">topen</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>

        <span class="c1"># Check that topen is strictly before tclose</span>
        <span class="k">assert</span> <span class="n">topen</span> <span class="o">&lt;</span> <span class="n">tclose</span>

        <span class="c1"># If ignoring the priority in scheduling, then over-write the provided priority information with 0.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_priority</span><span class="p">:</span>
            <span class="n">priority</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Use of &quot;&quot; not ideal, see note in initialise_population</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_policy</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="c1"># Look-up priority ranking of this treatment_ID in the policy adopted</span>
            <span class="n">priority</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enforce_priority_policy</span><span class="p">(</span><span class="n">hsi_event</span><span class="o">=</span><span class="n">hsi_event</span><span class="p">)</span>

        <span class="c1"># Check that priority is in valid range</span>
        <span class="k">assert</span> <span class="n">priority</span> <span class="o">&gt;=</span> <span class="mi">0</span>

        <span class="c1"># If priority of HSI_Event lower than the lowest one considered, ignore event in scheduling</span>
        <span class="k">if</span> <span class="n">priority</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowest_priority_considered</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">schedule_to_call_never_ran_on_date</span><span class="p">(</span><span class="n">hsi_event</span><span class="o">=</span><span class="n">hsi_event</span><span class="p">,</span> <span class="n">tdate</span><span class="o">=</span><span class="n">tclose</span><span class="p">)</span>  <span class="c1"># Call this on tclose</span>
            <span class="k">return</span>

        <span class="c1"># Check if healthsystem is disabled/disable_and_reject_all and, if so, schedule a wrapped event:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_and_reject_all</span><span class="p">):</span>
            <span class="c1"># If healthsystem is disabled (meaning that HSI can still run), schedule for the `run` method on `topen`.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">HSIEventWrapper</span><span class="p">(</span><span class="n">hsi_event</span><span class="o">=</span><span class="n">hsi_event</span><span class="p">,</span> <span class="n">run_hsi</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">topen</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_and_reject_all</span><span class="p">:</span>
            <span class="c1"># If healthsystem is disabled the HSI will never run: schedule for the `never_ran` method on `tclose`.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">schedule_to_call_never_ran_on_date</span><span class="p">(</span><span class="n">hsi_event</span><span class="o">=</span><span class="n">hsi_event</span><span class="p">,</span> <span class="n">tdate</span><span class="o">=</span><span class="n">tclose</span><span class="p">)</span>  <span class="c1"># Call this on tclose</span>
            <span class="k">return</span>

        <span class="c1"># Check that this is a legitimate health system interaction (HSI) event.</span>
        <span class="c1"># These checks are only performed when the flag `do_hsi_event_checks` is set to ``True`` to allow disabling</span>
        <span class="c1"># when the checks are redundant for example when scheduling multiple HSI events of same `HSI_Event` subclass.</span>
        <span class="k">if</span> <span class="n">do_hsi_event_checks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_hsi_event_is_valid</span><span class="p">(</span><span class="n">hsi_event</span><span class="p">)</span>

        <span class="c1"># Check that this request is allowable under current policy (i.e. included in service_availability).</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_treatment_id_allowed</span><span class="p">(</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">TREATMENT_ID</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_availability</span><span class="p">):</span>
            <span class="c1"># HSI is not allowable under the services_available parameter: run the HSI&#39;s &#39;never_ran&#39; method on the date</span>
            <span class="c1"># of tclose.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">HSIEventWrapper</span><span class="p">(</span><span class="n">hsi_event</span><span class="o">=</span><span class="n">hsi_event</span><span class="p">,</span> <span class="n">run_hsi</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">tclose</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># The HSI is allowed and will be added to the HSI_EVENT_QUEUE.</span>
            <span class="c1"># Let the HSI gather information about itself (facility_id and appt-footprint time requirements):</span>
            <span class="n">hsi_event</span><span class="o">.</span><span class="n">initialise</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_add_hsi_event_queue_item_to_hsi_event_queue</span><span class="p">(</span>
                <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span> <span class="n">topen</span><span class="o">=</span><span class="n">topen</span><span class="p">,</span> <span class="n">tclose</span><span class="o">=</span><span class="n">tclose</span><span class="p">,</span> <span class="n">hsi_event</span><span class="o">=</span><span class="n">hsi_event</span><span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem._add_hsi_event_queue_item_to_hsi_event_queue"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem._add_hsi_event_queue_item_to_hsi_event_queue">[docs]</a>    <span class="k">def</span> <span class="nf">_add_hsi_event_queue_item_to_hsi_event_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">priority</span><span class="p">,</span> <span class="n">topen</span><span class="p">,</span> <span class="n">tclose</span><span class="p">,</span> <span class="n">hsi_event</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add an event to the HSI_EVENT_QUEUE.&quot;&quot;&quot;</span>
        <span class="c1"># Create HSIEventQueue Item, including a counter for the number of HSI_Events, to assist with sorting in the</span>
        <span class="c1"># queue (NB. the sorting is done ascending and by the order of the items in the tuple).</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hsi_event_queue_counter</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">randomise_queue</span><span class="p">:</span>
            <span class="c1"># Might be best to use float here, and if rand_queue is off just assign it a fixed value (?)</span>
            <span class="n">rand_queue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng_for_hsi_queue</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rand_queue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsi_event_queue_counter</span>

        <span class="n">_new_item</span><span class="p">:</span> <span class="n">HSIEventQueueItem</span> <span class="o">=</span> <span class="n">HSIEventQueueItem</span><span class="p">(</span>
            <span class="n">priority</span><span class="p">,</span> <span class="n">topen</span><span class="p">,</span> <span class="n">rand_queue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsi_event_queue_counter</span><span class="p">,</span> <span class="n">tclose</span><span class="p">,</span> <span class="n">hsi_event</span><span class="p">)</span>

        <span class="c1"># Add to queue:</span>
        <span class="n">hp</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HSI_EVENT_QUEUE</span><span class="p">,</span> <span class="n">_new_item</span><span class="p">)</span></div>

    <span class="c1"># This is where the priority policy is enacted</span>
<div class="viewcode-block" id="HealthSystem.enforce_priority_policy"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.enforce_priority_policy">[docs]</a>    <span class="k">def</span> <span class="nf">enforce_priority_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hsi_event</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return priority for HSI_Event based on policy under consideration &quot;&quot;&quot;</span>

        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_rank_dict</span>
        <span class="n">pdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="k">if</span> <span class="n">hsi_event</span><span class="o">.</span><span class="n">TREATMENT_ID</span> <span class="ow">in</span> <span class="n">pr</span><span class="p">:</span>
            <span class="n">_priority_ranking</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">TREATMENT_ID</span><span class="p">][</span><span class="s1">&#39;Priority&#39;</span><span class="p">]</span>

            <span class="c1"># Check whether fast-tracking routes are available for this treatment. If person qualifies for one</span>
            <span class="c1"># don&#39;t check remaining.</span>

            <span class="c1"># Look up relevant attributes for HSI_Event&#39;s target</span>
            <span class="n">list_targets</span> <span class="o">=</span> <span class="p">[</span><span class="n">_t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_fasttrack</span><span class="p">]</span>
            <span class="n">target_attributes</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">list_targets</span><span class="p">]</span>

            <span class="c1"># Warning: here assuming that the first fast-tracking eligibility encountered</span>
            <span class="c1"># will determine the priority to be used. If different fast-tracking channels have</span>
            <span class="c1"># different priorities for the same treatment, this will be a problem!</span>
            <span class="c1"># First item in Lists is age-related, therefore need to invoke different logic.</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">pr</span><span class="p">[</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">TREATMENT_ID</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">list_fasttrack</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="ow">and</span> <span class="p">(</span><span class="n">target_attributes</span><span class="p">[</span><span class="s1">&#39;age_exact_years&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="n">pr</span><span class="p">[</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">TREATMENT_ID</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">list_fasttrack</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>

            <span class="c1"># All other attributes are looked up the same way, so can do this in for loop</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_fasttrack</span><span class="p">)):</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">pr</span><span class="p">[</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">TREATMENT_ID</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">list_fasttrack</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">target_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="k">return</span> <span class="n">pr</span><span class="p">[</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">TREATMENT_ID</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">list_fasttrack</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>

            <span class="k">return</span> <span class="n">_priority_ranking</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># If treatment is not ranked in the policy, issue a warning and assign priority=3 by default</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="ne">UserWarning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Couldn&#39;t find priority ranking for TREATMENT_ID </span><span class="se">\n</span><span class="s2">&quot;</span>
                                      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">TREATMENT_ID</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowest_priority_considered</span></div>

<div class="viewcode-block" id="HealthSystem.check_hsi_event_is_valid"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.check_hsi_event_is_valid">[docs]</a>    <span class="k">def</span> <span class="nf">check_hsi_event_is_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hsi_event</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check the integrity of an HSI_Event.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hsi_event</span><span class="p">,</span> <span class="n">HSI_Event</span><span class="p">)</span>

        <span class="c1"># Check that non-empty treatment ID specified</span>
        <span class="k">assert</span> <span class="n">hsi_event</span><span class="o">.</span><span class="n">TREATMENT_ID</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">tlo</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">Population</span><span class="p">):</span>
            <span class="c1"># This is an individual-scoped HSI event.</span>
            <span class="c1"># It must have EXPECTED_APPT_FOOTPRINT, BEDDAYS_FOOTPRINT and ACCEPTED_FACILITY_LEVELS.</span>

            <span class="c1"># Correct formatted EXPECTED_APPT_FOOTPRINT</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">appt_footprint_is_valid</span><span class="p">(</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span><span class="p">),</span> \
                <span class="sa">f</span><span class="s2">&quot;the incorrectly formatted appt_footprint is </span><span class="si">{</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="c1"># That it has an acceptable &#39;ACCEPTED_FACILITY_LEVEL&#39; attribute</span>
            <span class="k">assert</span> <span class="n">hsi_event</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_facility_levels</span><span class="p">,</span> \
                <span class="sa">f</span><span class="s2">&quot;In the HSI with TREATMENT_ID=</span><span class="si">{</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">TREATMENT_ID</span><span class="si">}</span><span class="s2">, the ACCEPTED_FACILITY_LEVEL (=&quot;</span> \
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span><span class="si">}</span><span class="s2">) is not recognised.&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">bed_days</span><span class="o">.</span><span class="n">check_beddays_footprint_format</span><span class="p">(</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">BEDDAYS_FOOTPRINT</span><span class="p">)</span>

            <span class="c1"># Check that this can accept the squeeze argument</span>
            <span class="k">assert</span> <span class="n">_accepts_argument</span><span class="p">(</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="s1">&#39;squeeze_factor&#39;</span><span class="p">)</span>

            <span class="c1"># Check that the event does not request an appointment at a facility</span>
            <span class="c1"># level which is not possible</span>
            <span class="n">appt_type_to_check_list</span> <span class="o">=</span> <span class="n">hsi_event</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">facility_appt_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_appt_type_by_facLevel</span><span class="p">[</span>
                <span class="n">hsi_event</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span>
            <span class="p">]</span>
            <span class="k">assert</span> <span class="n">facility_appt_types</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">appt_type_to_check_list</span><span class="p">),</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;An appointment type has been requested at a facility level for &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;which it is not possible: TREATMENT_ID=</span><span class="si">{</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">TREATMENT_ID</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem.is_treatment_id_allowed"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.is_treatment_id_allowed">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_treatment_id_allowed</span><span class="p">(</span><span class="n">treatment_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">service_availability</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine if a treatment_id (specified as a string) can be run (i.e., is within the allowable set of</span>
<span class="sd">         treatments, given by `self.service_availability`. The rules are as follows:</span>
<span class="sd">          * An empty list means nothing is allowed</span>
<span class="sd">          * A list that contains only an asteriks [&#39;*&#39;] means run anything</span>
<span class="sd">          * If the list is not empty, then a treatment_id with a first part &quot;FirstAttendance_&quot; is also allowed</span>
<span class="sd">          * An entry in the list of the form &quot;A_B_C&quot; means a treatment_id that matches exactly is allowed</span>
<span class="sd">          * An entry in the list of the form &quot;A_B_*&quot; means that a treatment_id that begins &quot;A_B_&quot; or &quot;A_B&quot; is allowed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">_treatment_matches_pattern</span><span class="p">(</span><span class="n">_treatment_id</span><span class="p">,</span> <span class="n">_service_availability</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Check if treatment_id matches any services specified with wildcard * patterns&quot;&quot;&quot;</span>

            <span class="k">def</span> <span class="nf">_matches_this_pattern</span><span class="p">(</span><span class="n">_treatment_id</span><span class="p">,</span> <span class="n">_s</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Returns True if this treatment_id is consistent with this component of service_availability&quot;&quot;&quot;</span>
                <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">_s</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">_s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Component of service_availability has an asteriks not at the end: </span><span class="si">{</span><span class="n">_s</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">_s_split</span> <span class="o">=</span> <span class="n">_s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>  <span class="c1"># split the matching pattern at &#39;_&#39; knowing that the last component is &#39;*&#39;</span>
                    <span class="n">_treatment_id_split</span> <span class="o">=</span> <span class="n">_treatment_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">_s_split</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># split treatment_id at &#39;_&#39; into</span>
                    <span class="c1"># as many component as there as non-asteriks component of _s.</span>
                    <span class="c1"># Check if all the components (that are not asteriks) are the same:</span>
                    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span>
                        <span class="p">[(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">zip_longest</span><span class="p">(</span><span class="n">_treatment_id_split</span><span class="p">,</span> <span class="n">_s_split</span><span class="p">)]</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If not &quot;*&quot;, comparison is ordinary match between strings</span>
                    <span class="k">return</span> <span class="n">_treatment_id</span> <span class="o">==</span> <span class="n">_s</span>

            <span class="k">for</span> <span class="n">_s</span> <span class="ow">in</span> <span class="n">service_availability</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_matches_this_pattern</span><span class="p">(</span><span class="n">_treatment_id</span><span class="p">,</span> <span class="n">_s</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">service_availability</span><span class="p">:</span>
            <span class="c1"># Empty list --&gt; nothing is allowable</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">service_availability</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]:</span>
            <span class="c1"># Wildcard --&gt; everything is allowed</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">treatment_id</span> <span class="ow">in</span> <span class="n">service_availability</span><span class="p">:</span>
            <span class="c1"># Explicit inclusion of this treatment_id --&gt; allowed</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">treatment_id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;FirstAttendance_&#39;</span><span class="p">):</span>
            <span class="c1"># FirstAttendance* --&gt; allowable</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_treatment_matches_pattern</span><span class="p">(</span><span class="n">treatment_id</span><span class="p">,</span> <span class="n">service_availability</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="HealthSystem.schedule_batch_of_individual_hsi_events"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.schedule_batch_of_individual_hsi_events">[docs]</a>    <span class="k">def</span> <span class="nf">schedule_batch_of_individual_hsi_events</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">hsi_event_class</span><span class="p">,</span> <span class="n">person_ids</span><span class="p">,</span> <span class="n">priority</span><span class="p">,</span> <span class="n">topen</span><span class="p">,</span> <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">event_kwargs</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Schedule a batch of individual-scoped HSI events of the same type.</span>

<span class="sd">        Only performs sanity checks on the HSI event for the first scheduled event</span>
<span class="sd">        thus removing the overhead of multiple redundant checks.</span>

<span class="sd">        :param hsi_event_class: The ``HSI_Event`` subclass of the events to schedule.</span>
<span class="sd">        :param person_ids: A sequence of person ID index values to use as the targets</span>
<span class="sd">            of the HSI events being scheduled.</span>
<span class="sd">        :param priority: The priority for the HSI events: 0 (highest), 1 or 2 (lowest).</span>
<span class="sd">            Either a single value for all events or an iterable of per-target values.</span>
<span class="sd">        :param topen: The earliest date at which the HSI events should run. Either a</span>
<span class="sd">            single value for all events or an iterable of per-target values.</span>
<span class="sd">        :param tclose: The latest date at which the HSI events should run. Set to one</span>
<span class="sd">           week after ``topen`` if ``None``. Either a single value for all events or an</span>
<span class="sd">           iterable of per-target values.</span>
<span class="sd">        :param event_kwargs: Any additional keyword arguments to pass to the</span>
<span class="sd">            ``hsi_event_class`` initialiser in addition to ``person_id``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If any of {priority, topen, tclose} are iterable assume correspond to per-</span>
        <span class="c1"># target values for corresponding arguments of schedule_hsi_event otherwise</span>
        <span class="c1"># use same value for all calls</span>
        <span class="n">priorities</span> <span class="o">=</span> <span class="n">priority</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">priority</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="k">else</span> <span class="n">repeat</span><span class="p">(</span><span class="n">priority</span><span class="p">)</span>
        <span class="n">topens</span> <span class="o">=</span> <span class="n">topen</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">topen</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="k">else</span> <span class="n">repeat</span><span class="p">(</span><span class="n">topen</span><span class="p">)</span>
        <span class="n">tcloses</span> <span class="o">=</span> <span class="n">tclose</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tclose</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="k">else</span> <span class="n">repeat</span><span class="p">(</span><span class="n">tclose</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">person_id</span><span class="p">,</span> <span class="n">priority</span><span class="p">,</span> <span class="n">topen</span><span class="p">,</span> <span class="n">tclose</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">person_ids</span><span class="p">,</span> <span class="n">priorities</span><span class="p">,</span> <span class="n">topens</span><span class="p">,</span> <span class="n">tcloses</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">hsi_event</span><span class="o">=</span><span class="n">hsi_event_class</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="o">**</span><span class="n">event_kwargs</span><span class="p">),</span>
                <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span>
                <span class="n">topen</span><span class="o">=</span><span class="n">topen</span><span class="p">,</span>
                <span class="n">tclose</span><span class="o">=</span><span class="n">tclose</span><span class="p">,</span>
                <span class="c1"># Only perform checks for first event</span>
                <span class="n">do_hsi_event_checks</span><span class="o">=</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem.appt_footprint_is_valid"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.appt_footprint_is_valid">[docs]</a>    <span class="k">def</span> <span class="nf">appt_footprint_is_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">appt_footprint</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks an appointment footprint to ensure it is in the correct format.</span>
<span class="sd">        :param appt_footprint: Appointment footprint to check.</span>
<span class="sd">        :return: True if valid and False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check that all keys known appointment types and all values non-negative</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">appt_footprint</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span>
            <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_appointment_types</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">&gt;=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">appt_footprint</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">capabilities_today</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the capabilities of the health system today.</span>
<span class="sd">        returns: pd.Series giving minutes available for each officer type in each facility type</span>

<span class="sd">        Functions can go in here in the future that could expand the time available,</span>
<span class="sd">        simulating increasing efficiency (the concept of a productivity ratio raised</span>
<span class="sd">        by Martin Chalkley).</span>

<span class="sd">        For now this method only multiplies the estimated minutes available by the `capabilities_coefficient` scale</span>
<span class="sd">        factor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_daily_capabilities</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">capabilities_coefficient</span>

<div class="viewcode-block" id="HealthSystem.get_blank_appt_footprint"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.get_blank_appt_footprint">[docs]</a>    <span class="k">def</span> <span class="nf">get_blank_appt_footprint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a helper function so that disease modules can easily create their appt_footprints.</span>
<span class="sd">        It returns an empty Counter instance.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Counter</span><span class="p">()</span></div>

<div class="viewcode-block" id="HealthSystem.get_facility_info"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.get_facility_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_facility_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hsi_event</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FacilityInfo</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper function to find the facility at which an HSI event will take place based on their district of</span>
<span class="sd">        residence and the level of the facility of the HSI.&quot;&quot;&quot;</span>
        <span class="n">the_district</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="s1">&#39;district_of_residence&#39;</span><span class="p">]</span>
        <span class="n">the_level</span> <span class="o">=</span> <span class="n">hsi_event</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_facilities_for_each_district</span><span class="p">[</span><span class="n">the_level</span><span class="p">][</span><span class="n">the_district</span><span class="p">]</span></div>

<div class="viewcode-block" id="HealthSystem.get_appt_footprint_as_time_request"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.get_appt_footprint_as_time_request">[docs]</a>    <span class="k">def</span> <span class="nf">get_appt_footprint_as_time_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">facility_info</span><span class="p">:</span> <span class="n">FacilityInfo</span><span class="p">,</span> <span class="n">appt_footprint</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This will take an APPT_FOOTPRINT and return the required appointments in terms of the</span>
<span class="sd">        time required of each Officer Type in each Facility ID.</span>
<span class="sd">        The index will identify the Facility ID and the Officer Type in the same format</span>
<span class="sd">        as is used in Daily_Capabilities.</span>
<span class="sd">        :params facility_info: The FacilityInfo describing the facility at which the appointment occurs</span>
<span class="sd">        :param appt_footprint: The actual appt footprint (optional) if different to that in the HSI event.</span>
<span class="sd">        :return: A Counter that gives the times required for each officer-type in each facility_ID, where this time</span>
<span class="sd">         is non-zero.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Accumulate appointment times for specified footprint using times from appointment times table.</span>
        <span class="n">appt_footprint_times</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">appt_type</span> <span class="ow">in</span> <span class="n">appt_footprint</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">appt_info_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_appt_times</span><span class="p">[</span><span class="n">facility_info</span><span class="o">.</span><span class="n">level</span><span class="p">][</span><span class="n">appt_type</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The time needed for an appointment is not defined for the specified facility level: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;appt_type=</span><span class="si">{</span><span class="n">appt_type</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;facility_level=</span><span class="si">{</span><span class="n">facility_info</span><span class="o">.</span><span class="n">level</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

            <span class="k">for</span> <span class="n">appt_info</span> <span class="ow">in</span> <span class="n">appt_info_list</span><span class="p">:</span>
                <span class="n">appt_footprint_times</span><span class="p">[</span>
                    <span class="sa">f</span><span class="s2">&quot;FacilityID_</span><span class="si">{</span><span class="n">facility_info</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">_Officer_</span><span class="si">{</span><span class="n">appt_info</span><span class="o">.</span><span class="n">officer_type</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">]</span> <span class="o">+=</span> <span class="n">appt_info</span><span class="o">.</span><span class="n">time_taken</span>

        <span class="k">return</span> <span class="n">appt_footprint_times</span></div>

<div class="viewcode-block" id="HealthSystem.get_squeeze_factors"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.get_squeeze_factors">[docs]</a>    <span class="k">def</span> <span class="nf">get_squeeze_factors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">footprints_per_event</span><span class="p">,</span> <span class="n">total_footprint</span><span class="p">,</span> <span class="n">current_capabilities</span><span class="p">,</span>
                            <span class="n">compute_squeeze_factor_to_district_level</span><span class="p">:</span> <span class="nb">bool</span>
                            <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This will compute the squeeze factors for each HSI event from the list of all</span>
<span class="sd">        the calls on health system resources for the day.</span>
<span class="sd">        The squeeze factor is defined as (call/available - 1). ie. the highest</span>
<span class="sd">        fractional over-demand among any type of officer that is called-for in the</span>
<span class="sd">        appt_footprint of an HSI event.</span>
<span class="sd">        A value of 0.0 signifies that there is no squeezing (sufficient resources for</span>
<span class="sd">        the EXPECTED_APPT_FOOTPRINT).</span>

<span class="sd">        :param footprints_per_event: List, one entry per HSI event, containing the</span>
<span class="sd">            minutes required from each health officer in each health facility as a</span>
<span class="sd">            Counter (using the standard index)</span>
<span class="sd">        :param total_footprint: Counter, containing the total minutes required from</span>
<span class="sd">            each health officer in each health facility when non-zero, (using the</span>
<span class="sd">            standard index)</span>
<span class="sd">        :param current_capabilities: Series giving the amount of time available for</span>
<span class="sd">            each health officer in each health facility (using the standard index)</span>
<span class="sd">        :param compute_squeeze_factor_to_district_level: Boolean indicating whether</span>
<span class="sd">            the computation of squeeze_factors should be specific to each district</span>
<span class="sd">            (when `True`), or if the computation of squeeze_factors should be on</span>
<span class="sd">            the basis that resources from all districts can be effectively &quot;pooled&quot;</span>
<span class="sd">            (when `False).</span>

<span class="sd">        :return: squeeze_factors: an array of the squeeze factors for each HSI event</span>
<span class="sd">            (position in array matches that in the all_call_today list).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">get_total_minutes_of_this_officer_in_this_district</span><span class="p">(</span><span class="n">_officer</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Returns the minutes of current capabilities for the officer identified (this officer type in this</span>
<span class="sd">            facility_id).&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">current_capabilities</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_officer</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_total_minutes_of_this_officer_in_all_district</span><span class="p">(</span><span class="n">_officer</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Returns the minutes of current capabilities for the officer identified in all districts (this officer</span>
<span class="sd">            type in this all facilities of the same level in all districts).&quot;&quot;&quot;</span>

            <span class="k">def</span> <span class="nf">split_officer_compound_string</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Returns (facility_id, officer_type) for the officer identified in the string of the form:</span>
<span class="sd">                 &#39;FacilityID_{facility_id}_Officer_{officer_type}&#39;.&quot;&quot;&quot;</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">_facility_id</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_officer_type</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># (NB. Some &#39;officer_type&#39; include &quot;_&quot;)</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">_facility_id</span><span class="p">),</span> <span class="n">_officer_type</span>

            <span class="k">def</span> <span class="nf">_match</span><span class="p">(</span><span class="n">_this_officer</span><span class="p">,</span> <span class="n">facility_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">officer_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Returns True if the officer identified is of the identified officer_type and is in one of the</span>
<span class="sd">                facility_ids.&quot;&quot;&quot;</span>
                <span class="n">this_facility_id</span><span class="p">,</span> <span class="n">this_officer_type</span> <span class="o">=</span> <span class="n">split_officer_compound_string</span><span class="p">(</span><span class="n">_this_officer</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">this_officer_type</span> <span class="o">==</span> <span class="n">officer_type</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">this_facility_id</span> <span class="ow">in</span> <span class="n">facility_ids</span><span class="p">)</span>

            <span class="n">facility_id</span><span class="p">,</span> <span class="n">officer_type</span> <span class="o">=</span> <span class="n">split_officer_compound_string</span><span class="p">(</span><span class="n">_officer</span><span class="p">)</span>
            <span class="n">facility_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_facility_by_facility_id</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">facility_id</span><span class="p">)]</span><span class="o">.</span><span class="n">level</span>
            <span class="n">facilities_of_same_level_in_all_district</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">_fac</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">_fac</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_facilities_for_each_district</span><span class="p">[</span><span class="n">facility_level</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="p">]</span>

            <span class="n">officers_in_the_same_level_in_all_districts</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">_officer</span> <span class="k">for</span> <span class="n">_officer</span> <span class="ow">in</span> <span class="n">current_capabilities</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span>
                <span class="n">_match</span><span class="p">(</span><span class="n">_officer</span><span class="p">,</span> <span class="n">facility_ids</span><span class="o">=</span><span class="n">facilities_of_same_level_in_all_district</span><span class="p">,</span> <span class="n">officer_type</span><span class="o">=</span><span class="n">officer_type</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">current_capabilities</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_o</span><span class="p">)</span> <span class="k">for</span> <span class="n">_o</span> <span class="ow">in</span> <span class="n">officers_in_the_same_level_in_all_districts</span><span class="p">)</span>

        <span class="c1"># 1) Compute the load factors for each officer type at each facility that is</span>
        <span class="c1"># called-upon in this list of HSIs</span>
        <span class="n">load_factor</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">officer</span><span class="p">,</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">total_footprint</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">compute_squeeze_factor_to_district_level</span><span class="p">:</span>
                <span class="n">availability</span> <span class="o">=</span> <span class="n">get_total_minutes_of_this_officer_in_this_district</span><span class="p">(</span><span class="n">officer</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">availability</span> <span class="o">=</span> <span class="n">get_total_minutes_of_this_officer_in_all_district</span><span class="p">(</span><span class="n">officer</span><span class="p">)</span>

            <span class="c1"># If officer does not exist in the relevant facility, log warning and proceed as if availability = 0</span>
            <span class="k">if</span> <span class="n">availability</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="n">key</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Requested officer </span><span class="si">{</span><span class="n">officer</span><span class="si">}</span><span class="s2"> is not contemplated by health system. &quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">availability</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">availability</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">load_factor</span><span class="p">[</span><span class="n">officer</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">load_factor</span><span class="p">[</span><span class="n">officer</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">call</span> <span class="o">/</span> <span class="n">availability</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

        <span class="c1"># 2) Convert these load-factors into an overall &#39;squeeze&#39; signal for each HSI,</span>
        <span class="c1"># based on the load-factor of the officer with the largest time requirement for that</span>
        <span class="c1"># event (or zero if event has an empty footprint)</span>
        <span class="n">squeeze_factor_per_hsi_event</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">footprint</span> <span class="ow">in</span> <span class="n">footprints_per_event</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">footprint</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># If any of the required officers are not available at the facility, set overall squeeze to inf</span>
                <span class="n">require_missing_officer</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">load_factor</span><span class="p">[</span><span class="n">officer</span><span class="p">]</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">officer</span> <span class="ow">in</span> <span class="n">footprint</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">require_missing_officer</span><span class="p">:</span>
                    <span class="n">squeeze_factor_per_hsi_event</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">squeeze_factor_per_hsi_event</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">load_factor</span><span class="p">[</span><span class="n">footprint</span><span class="o">.</span><span class="n">most_common</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span> <span class="mf">0.</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">squeeze_factor_per_hsi_event</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">squeeze_factor_per_hsi_event</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">squeeze_factor_per_hsi_event</span><span class="p">)</span>

        <span class="k">assert</span> <span class="p">(</span><span class="n">squeeze_factor_per_hsi_event</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">squeeze_factor_per_hsi_event</span></div>

<div class="viewcode-block" id="HealthSystem.record_hsi_event"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.record_hsi_event">[docs]</a>    <span class="k">def</span> <span class="nf">record_hsi_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hsi_event</span><span class="p">,</span> <span class="n">actual_appt_footprint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">squeeze_factor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">did_run</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Record the processing of an HSI event.</span>
<span class="sd">        If this is an individual-level HSI_Event, it will also record the actual appointment footprint</span>
<span class="sd">        :param hsi_event: The HSI_Event (containing the initial expectations of footprints)</span>
<span class="sd">        :param actual_appt_footprint: The actual Appointment Footprint (if individual event)</span>
<span class="sd">        :param squeeze_factor: The squeeze factor (if individual event)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">tlo</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">Population</span><span class="p">):</span>
            <span class="c1"># Population HSI-Event (N.B. This is not actually logged.)</span>
            <span class="n">log_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;TREATMENT_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hsi_event</span><span class="o">.</span><span class="n">TREATMENT_ID</span>
            <span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Number_By_Appt_Type_Code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Population&#39;</span>  <span class="c1"># remove the appt-types with zeros</span>
            <span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Person_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># Junk code</span>
            <span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Squeeze_Factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;did_run&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">did_run</span>
            <span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;priority&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">priority</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Individual HSI-Event</span>
            <span class="n">_squeeze_factor</span> <span class="o">=</span> <span class="n">squeeze_factor</span> <span class="k">if</span> <span class="n">squeeze_factor</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="k">else</span> <span class="mf">100.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_to_hsi_log</span><span class="p">(</span>
                <span class="n">event_details</span><span class="o">=</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">as_namedtuple</span><span class="p">(</span><span class="n">actual_appt_footprint</span><span class="p">),</span>
                <span class="n">person_id</span><span class="o">=</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
                <span class="n">facility_id</span><span class="o">=</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">facility_info</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">squeeze_factor</span><span class="o">=</span><span class="n">_squeeze_factor</span><span class="p">,</span>
                <span class="n">did_run</span><span class="o">=</span><span class="n">did_run</span><span class="p">,</span>
                <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem.write_to_hsi_log"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.write_to_hsi_log">[docs]</a>    <span class="k">def</span> <span class="nf">write_to_hsi_log</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">event_details</span><span class="p">:</span> <span class="n">HSIEventDetails</span><span class="p">,</span>
        <span class="n">person_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">facility_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">squeeze_factor</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">did_run</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">priority</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write the log `HSI_Event` and add to the summary counter.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;HSI_Event&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;Event_Name&#39;</span><span class="p">:</span> <span class="n">event_details</span><span class="o">.</span><span class="n">event_name</span><span class="p">,</span>
                <span class="s1">&#39;TREATMENT_ID&#39;</span><span class="p">:</span> <span class="n">event_details</span><span class="o">.</span><span class="n">treatment_id</span><span class="p">,</span>
                <span class="s1">&#39;Number_By_Appt_Type_Code&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">event_details</span><span class="o">.</span><span class="n">appt_footprint</span><span class="p">),</span>
                <span class="s1">&#39;Person_ID&#39;</span><span class="p">:</span> <span class="n">person_id</span><span class="p">,</span>
                <span class="s1">&#39;Squeeze_Factor&#39;</span><span class="p">:</span> <span class="n">squeeze_factor</span><span class="p">,</span>
                <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="n">priority</span><span class="p">,</span>
                <span class="s1">&#39;did_run&#39;</span><span class="p">:</span> <span class="n">did_run</span><span class="p">,</span>
                <span class="s1">&#39;Facility_Level&#39;</span><span class="p">:</span> <span class="n">event_details</span><span class="o">.</span><span class="n">facility_level</span> <span class="k">if</span> <span class="n">event_details</span><span class="o">.</span><span class="n">facility_level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="o">-</span><span class="mi">99</span><span class="p">,</span>
                <span class="s1">&#39;Facility_ID&#39;</span><span class="p">:</span> <span class="n">facility_id</span> <span class="k">if</span> <span class="n">facility_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="o">-</span><span class="mi">99</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;record of each HSI event&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">did_run</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hsi_event_count_log_period</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">event_details_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hsi_event_details</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
                    <span class="n">event_details</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hsi_event_details</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_hsi_event_counts_log_period</span><span class="p">[</span><span class="n">event_details_key</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_summary_counter</span><span class="o">.</span><span class="n">record_hsi_event</span><span class="p">(</span>
                <span class="n">treatment_id</span><span class="o">=</span><span class="n">event_details</span><span class="o">.</span><span class="n">treatment_id</span><span class="p">,</span>
                <span class="n">hsi_event_name</span><span class="o">=</span><span class="n">event_details</span><span class="o">.</span><span class="n">event_name</span><span class="p">,</span>
                <span class="n">squeeze_factor</span><span class="o">=</span><span class="n">squeeze_factor</span><span class="p">,</span>
                <span class="n">appt_footprint</span><span class="o">=</span><span class="n">event_details</span><span class="o">.</span><span class="n">appt_footprint</span><span class="p">,</span>
                <span class="n">level</span><span class="o">=</span><span class="n">event_details</span><span class="o">.</span><span class="n">facility_level</span><span class="p">,</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem.call_and_record_never_ran_hsi_event"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.call_and_record_never_ran_hsi_event">[docs]</a>    <span class="k">def</span> <span class="nf">call_and_record_never_ran_hsi_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hsi_event</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Record the fact that an HSI event was never ran.</span>
<span class="sd">        If this is an individual-level HSI_Event, it will also record the actual appointment footprint</span>
<span class="sd">        :param hsi_event: The HSI_Event (containing the initial expectations of footprints)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Invoke never ran function here</span>
        <span class="n">hsi_event</span><span class="o">.</span><span class="n">never_ran</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">hsi_event</span><span class="o">.</span><span class="n">facility_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Fully-defined HSI Event</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_to_never_ran_hsi_log</span><span class="p">(</span>
                 <span class="n">event_details</span><span class="o">=</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">as_namedtuple</span><span class="p">(),</span>
                 <span class="n">person_id</span><span class="o">=</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
                 <span class="n">facility_id</span><span class="o">=</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">facility_info</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                 <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span>
                 <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_to_never_ran_hsi_log</span><span class="p">(</span>
                 <span class="n">event_details</span><span class="o">=</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">as_namedtuple</span><span class="p">(),</span>
                 <span class="n">person_id</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">facility_id</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span>
                 <span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem.write_to_never_ran_hsi_log"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.write_to_never_ran_hsi_log">[docs]</a>    <span class="k">def</span> <span class="nf">write_to_never_ran_hsi_log</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">event_details</span><span class="p">:</span> <span class="n">HSIEventDetails</span><span class="p">,</span>
        <span class="n">person_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">facility_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">priority</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write the log `HSI_Event` and add to the summary counter.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Never_ran_HSI_Event&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;Event_Name&#39;</span><span class="p">:</span> <span class="n">event_details</span><span class="o">.</span><span class="n">event_name</span><span class="p">,</span>
                <span class="s1">&#39;TREATMENT_ID&#39;</span><span class="p">:</span> <span class="n">event_details</span><span class="o">.</span><span class="n">treatment_id</span><span class="p">,</span>
                <span class="s1">&#39;Number_By_Appt_Type_Code&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">event_details</span><span class="o">.</span><span class="n">appt_footprint</span><span class="p">),</span>
                <span class="s1">&#39;Person_ID&#39;</span><span class="p">:</span> <span class="n">person_id</span><span class="p">,</span>
                <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="n">priority</span><span class="p">,</span>
                <span class="s1">&#39;Facility_Level&#39;</span><span class="p">:</span> <span class="n">event_details</span><span class="o">.</span><span class="n">facility_level</span> <span class="k">if</span> <span class="n">event_details</span><span class="o">.</span><span class="n">facility_level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="o">-</span><span class="mi">99</span><span class="p">,</span>
                <span class="s1">&#39;Facility_ID&#39;</span><span class="p">:</span> <span class="n">facility_id</span> <span class="k">if</span> <span class="n">facility_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="o">-</span><span class="mi">99</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;record of each HSI event that never ran&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hsi_event_count_log_period</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">event_details_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_never_ran_hsi_event_details</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
                <span class="n">event_details</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_never_ran_hsi_event_details</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_never_ran_hsi_event_counts_log_period</span><span class="p">[</span><span class="n">event_details_key</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_summary_counter</span><span class="o">.</span><span class="n">record_never_ran_hsi_event</span><span class="p">(</span>
            <span class="n">treatment_id</span><span class="o">=</span><span class="n">event_details</span><span class="o">.</span><span class="n">treatment_id</span><span class="p">,</span>
            <span class="n">hsi_event_name</span><span class="o">=</span><span class="n">event_details</span><span class="o">.</span><span class="n">event_name</span><span class="p">,</span>
            <span class="n">appt_footprint</span><span class="o">=</span><span class="n">event_details</span><span class="o">.</span><span class="n">appt_footprint</span><span class="p">,</span>
            <span class="n">level</span><span class="o">=</span><span class="n">event_details</span><span class="o">.</span><span class="n">facility_level</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem.log_current_capabilities_and_usage"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.log_current_capabilities_and_usage">[docs]</a>    <span class="k">def</span> <span class="nf">log_current_capabilities_and_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This will log the percentage of the current capabilities that is used at each Facility Type, according the</span>
<span class="sd">        `runnning_total_footprint`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_capabilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capabilities_today</span>
        <span class="n">total_footprint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_total_footprint</span>

        <span class="c1"># Combine the current_capabilities and total_footprint per-officer totals</span>
        <span class="n">comparison</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">current_capabilities</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;Total_Minutes_Per_Day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_capabilities</span>
        <span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;Minutes_Used&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">total_footprint</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
        <span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;Minutes_Used&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;Minutes_Used&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">comparison</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_capabilities</span><span class="p">)</span>

        <span class="c1"># Compute Fraction of Time Used Overall</span>
        <span class="n">total_available</span> <span class="o">=</span> <span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;Total_Minutes_Per_Day&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">fraction_time_used_overall</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;Minutes_Used&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">total_available</span> <span class="k">if</span> <span class="n">total_available</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">)</span>

        <span class="c1"># Compute Fraction of Time Used In Each Facility</span>
        <span class="n">facility_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">_f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">_f</span> <span class="ow">in</span> <span class="n">comparison</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="n">summary_by_fac_id</span> <span class="o">=</span> <span class="n">comparison</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">facility_id</span><span class="p">)[[</span><span class="s1">&#39;Total_Minutes_Per_Day&#39;</span><span class="p">,</span> <span class="s1">&#39;Minutes_Used&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">summary_by_fac_id</span><span class="p">[</span><span class="s1">&#39;Fraction_Time_Used&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">summary_by_fac_id</span><span class="p">[</span><span class="s1">&#39;Minutes_Used&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">summary_by_fac_id</span><span class="p">[</span><span class="s1">&#39;Total_Minutes_Per_Day&#39;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>

        <span class="c1"># Compute Fraction of Time For Each Officer and level</span>
        <span class="n">officer</span> <span class="o">=</span> <span class="p">[</span><span class="n">_f</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;Officer_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">_f</span> <span class="ow">in</span> <span class="n">comparison</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="n">level</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_facility_by_facility_id</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">_fac_id</span><span class="p">)]</span><span class="o">.</span><span class="n">level</span> <span class="k">for</span> <span class="n">_fac_id</span> <span class="ow">in</span> <span class="n">facility_id</span><span class="p">]</span>
        <span class="n">level</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;1b&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">),</span> <span class="n">level</span><span class="p">))</span>
        <span class="n">summary_by_officer</span> <span class="o">=</span> <span class="n">comparison</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="n">officer</span><span class="p">,</span> <span class="n">level</span><span class="p">])[[</span><span class="s1">&#39;Total_Minutes_Per_Day&#39;</span><span class="p">,</span> <span class="s1">&#39;Minutes_Used&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">summary_by_officer</span><span class="p">[</span><span class="s1">&#39;Fraction_Time_Used&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">summary_by_officer</span><span class="p">[</span><span class="s1">&#39;Minutes_Used&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">summary_by_officer</span><span class="p">[</span><span class="s1">&#39;Total_Minutes_Per_Day&#39;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">summary_by_officer</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Officer_Type&#39;</span><span class="p">,</span> <span class="s1">&#39;Facility_Level&#39;</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;Capacity&#39;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                        <span class="s1">&#39;Frac_Time_Used_Overall&#39;</span><span class="p">:</span> <span class="n">fraction_time_used_overall</span><span class="p">,</span>
                        <span class="s1">&#39;Frac_Time_Used_By_Facility_ID&#39;</span><span class="p">:</span> <span class="n">summary_by_fac_id</span><span class="p">[</span><span class="s1">&#39;Fraction_Time_Used&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
                        <span class="s1">&#39;Frac_Time_Used_By_OfficerType&#39;</span><span class="p">:</span>  <span class="n">flatten_multi_index_series_into_dict_for_logging</span><span class="p">(</span>
                            <span class="n">summary_by_officer</span><span class="p">[</span><span class="s1">&#39;Fraction_Time_Used&#39;</span><span class="p">]</span>
                        <span class="p">),</span>
                    <span class="p">},</span>
                    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;daily summary of utilisation and capacity of health system resources&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_summary_counter</span><span class="o">.</span><span class="n">record_hs_status</span><span class="p">(</span>
            <span class="n">fraction_time_used_across_all_facilities</span><span class="o">=</span><span class="n">fraction_time_used_overall</span><span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem.remove_beddays_footprint"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.remove_beddays_footprint">[docs]</a>    <span class="k">def</span> <span class="nf">remove_beddays_footprint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="c1"># removing bed_days from a particular individual if any</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bed_days</span><span class="o">.</span><span class="n">remove_beddays_footprint</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem.find_events_for_person"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.find_events_for_person">[docs]</a>    <span class="k">def</span> <span class="nf">find_events_for_person</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find the events in the HSI_EVENT_QUEUE for a particular person.</span>
<span class="sd">        :param person_id: the person_id of interest</span>
<span class="sd">        :returns list of tuples (date_of_event, event) for that person_id in the HSI_EVENT_QUEUE.</span>

<span class="sd">        NB. This is for debugging and testing only - not for use in real simulations as it is slow</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">list_of_events</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">ev_tuple</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">HSI_EVENT_QUEUE</span><span class="p">:</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">ev_tuple</span><span class="o">.</span><span class="n">topen</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">ev_tuple</span><span class="o">.</span><span class="n">hsi_event</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">target</span> <span class="o">==</span> <span class="n">person_id</span><span class="p">:</span>
                    <span class="n">list_of_events</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">date</span><span class="p">,</span> <span class="n">event</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">list_of_events</span></div>

<div class="viewcode-block" id="HealthSystem.reset_queue"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.reset_queue">[docs]</a>    <span class="k">def</span> <span class="nf">reset_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the HSI event queue to be empty&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HSI_EVENT_QUEUE</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hsi_event_queue_counter</span> <span class="o">=</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="HealthSystem.get_item_codes_from_package_name"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.get_item_codes_from_package_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_item_codes_from_package_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper function to provide the item codes and quantities in a dict of the form {&lt;item_code&gt;:&lt;quantity&gt;} for</span>
<span class="sd">         a given package name.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">get_item_codes_from_package_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;item_and_package_code_lookups&#39;</span><span class="p">],</span> <span class="n">package</span><span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem.get_item_code_from_item_name"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.get_item_code_from_item_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_item_code_from_item_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper function to provide the item_code (an int) when provided with the name of the item&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">get_item_code_from_item_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;item_and_package_code_lookups&#39;</span><span class="p">],</span> <span class="n">item</span><span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem.override_availability_of_consumables"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.override_availability_of_consumables">[docs]</a>    <span class="k">def</span> <span class="nf">override_availability_of_consumables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_codes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Over-ride the availability (for all months and all facilities) of certain consumables item_codes.</span>
<span class="sd">        :param item_codes: Dictionary of the form {&lt;item_code&gt;: probability_that_item_is_available}</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consumables</span><span class="o">.</span><span class="n">override_availability</span><span class="p">(</span><span class="n">item_codes</span><span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem._write_hsi_event_counts_to_log_and_reset"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem._write_hsi_event_counts_to_log_and_reset">[docs]</a>    <span class="k">def</span> <span class="nf">_write_hsi_event_counts_to_log_and_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger_summary</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;hsi_event_counts&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Counts of the HSI events that have run in this &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_hsi_event_count_log_period</span><span class="si">}</span><span class="s2"> with keys corresponding to integer&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; keys recorded in dictionary in hsi_event_details log entry.&quot;</span>
            <span class="p">),</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;hsi_event_key_to_counts&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hsi_event_counts_log_period</span><span class="p">)},</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hsi_event_counts_cumulative</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hsi_event_counts_log_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hsi_event_counts_log_period</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>

<div class="viewcode-block" id="HealthSystem._write_never_ran_hsi_event_counts_to_log_and_reset"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem._write_never_ran_hsi_event_counts_to_log_and_reset">[docs]</a>    <span class="k">def</span> <span class="nf">_write_never_ran_hsi_event_counts_to_log_and_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger_summary</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;never_ran_hsi_event_counts&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Counts of the HSI events that never ran in this &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_hsi_event_count_log_period</span><span class="si">}</span><span class="s2"> with keys corresponding to integer&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; keys recorded in dictionary in hsi_event_details log entry.&quot;</span>
            <span class="p">),</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;never_ran_hsi_event_key_to_counts&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_never_ran_hsi_event_counts_log_period</span><span class="p">)},</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_never_ran_hsi_event_counts_cumulative</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_never_ran_hsi_event_counts_log_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_never_ran_hsi_event_counts_log_period</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>

<div class="viewcode-block" id="HealthSystem.on_end_of_day"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.on_end_of_day">[docs]</a>    <span class="k">def</span> <span class="nf">on_end_of_day</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Do jobs to be done at the end of the day (after all HSI run)&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bed_days</span><span class="o">.</span><span class="n">on_end_of_day</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hsi_event_count_log_period</span> <span class="o">==</span> <span class="s2">&quot;day&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_hsi_event_counts_to_log_and_reset</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_never_ran_hsi_event_counts_to_log_and_reset</span><span class="p">()</span></div>

<div class="viewcode-block" id="HealthSystem.on_end_of_month"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.on_end_of_month">[docs]</a>    <span class="k">def</span> <span class="nf">on_end_of_month</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Do jobs to be done at the end of the month (after all HSI run)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hsi_event_count_log_period</span> <span class="o">==</span> <span class="s2">&quot;month&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_hsi_event_counts_to_log_and_reset</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_never_ran_hsi_event_counts_to_log_and_reset</span><span class="p">()</span></div>

<div class="viewcode-block" id="HealthSystem.on_end_of_year"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.on_end_of_year">[docs]</a>    <span class="k">def</span> <span class="nf">on_end_of_year</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write to log the current states of the summary counters and reset them.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_summary_counter</span><span class="o">.</span><span class="n">write_to_log_and_reset_counters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consumables</span><span class="o">.</span><span class="n">on_end_of_year</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bed_days</span><span class="o">.</span><span class="n">on_end_of_year</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hsi_event_count_log_period</span> <span class="o">==</span> <span class="s2">&quot;year&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_hsi_event_counts_to_log_and_reset</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_never_ran_hsi_event_counts_to_log_and_reset</span><span class="p">()</span></div>

<div class="viewcode-block" id="HealthSystem.run_population_level_events"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.run_population_level_events">[docs]</a>    <span class="k">def</span> <span class="nf">run_population_level_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_list_of_population_hsi_event_tuples</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">HSIEventQueueItem</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run a list of population level events.&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">_list_of_population_hsi_event_tuples</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pop_level_hsi_event_tuple</span> <span class="o">=</span> <span class="n">_list_of_population_hsi_event_tuples</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">pop_level_hsi_event</span> <span class="o">=</span> <span class="n">pop_level_hsi_event_tuple</span><span class="o">.</span><span class="n">hsi_event</span>
            <span class="n">pop_level_hsi_event</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">squeeze_factor</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">record_hsi_event</span><span class="p">(</span><span class="n">hsi_event</span><span class="o">=</span><span class="n">pop_level_hsi_event</span><span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem.run_individual_level_events_in_mode_0_or_1"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.run_individual_level_events_in_mode_0_or_1">[docs]</a>    <span class="k">def</span> <span class="nf">run_individual_level_events_in_mode_0_or_1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                                   <span class="n">_list_of_individual_hsi_event_tuples</span><span class="p">:</span>
                                                   <span class="n">List</span><span class="p">[</span><span class="n">HSIEventQueueItem</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run a list of individual level events. Returns: list of events that did not run (maybe an empty a list).&quot;&quot;&quot;</span>
        <span class="n">_to_be_held_over</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_appt_constraints</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">_list_of_individual_hsi_event_tuples</span><span class="p">:</span>
            <span class="c1"># Examine total call on health officers time from the HSI events in the list:</span>

            <span class="c1"># For all events in the list, expand the appt-footprint of the event to give the demands on each</span>
            <span class="c1"># officer-type in each facility_id.</span>
            <span class="n">footprints_of_all_individual_level_hsi_event</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">event_tuple</span><span class="o">.</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">expected_time_requests</span>
                <span class="k">for</span> <span class="n">event_tuple</span> <span class="ow">in</span> <span class="n">_list_of_individual_hsi_event_tuples</span>
            <span class="p">]</span>

            <span class="c1"># Compute total appointment footprint across all events</span>
            <span class="k">for</span> <span class="n">footprint</span> <span class="ow">in</span> <span class="n">footprints_of_all_individual_level_hsi_event</span><span class="p">:</span>
                <span class="c1"># Counter.update method when called with dict-like argument adds counts</span>
                <span class="c1"># from argument to Counter object called from</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">running_total_footprint</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">footprint</span><span class="p">)</span>

            <span class="c1"># Estimate Squeeze-Factors for today</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_appt_constraints</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># For Mode 0 (no Constraints), the squeeze factors are all zero.</span>
                <span class="n">squeeze_factor_per_hsi_event</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">footprints_of_all_individual_level_hsi_event</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># For Other Modes, the squeeze factors must be computed</span>
                <span class="n">squeeze_factor_per_hsi_event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_squeeze_factors</span><span class="p">(</span>
                    <span class="n">footprints_per_event</span><span class="o">=</span><span class="n">footprints_of_all_individual_level_hsi_event</span><span class="p">,</span>
                    <span class="n">total_footprint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">running_total_footprint</span><span class="p">,</span>
                    <span class="n">current_capabilities</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">capabilities_today</span><span class="p">,</span>
                    <span class="n">compute_squeeze_factor_to_district_level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_squeeze_factor_to_district_level</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">for</span> <span class="n">ev_num</span><span class="p">,</span> <span class="n">event</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_list_of_individual_hsi_event_tuples</span><span class="p">):</span>
                <span class="n">_priority</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">priority</span>
                <span class="n">event</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">hsi_event</span>
                <span class="n">squeeze_factor</span> <span class="o">=</span> <span class="n">squeeze_factor_per_hsi_event</span><span class="p">[</span><span class="n">ev_num</span><span class="p">]</span>                  <span class="c1"># todo use zip here!</span>

                <span class="c1"># store appt_footprint before running</span>
                <span class="n">_appt_footprint_before_running</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span>

                <span class="c1"># Mode 0: All HSI Event run, with no squeeze</span>
                <span class="c1"># Mode 1: All HSI Events run with squeeze provided latter is not inf</span>
                <span class="n">ok_to_run</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_appt_constraints</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">squeeze_factor</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
                    <span class="n">ok_to_run</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="n">ok_to_run</span><span class="p">:</span>

                    <span class="c1"># Compute the bed days that are allocated to this HSI and provide this information to the HSI</span>
                    <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">BEDDAYS_FOOTPRINT</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                        <span class="n">event</span><span class="o">.</span><span class="n">_received_info_about_bed_days</span> <span class="o">=</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">bed_days</span><span class="o">.</span><span class="n">issue_bed_days_according_to_availability</span><span class="p">(</span>
                                <span class="n">facility_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bed_days</span><span class="o">.</span><span class="n">get_facility_id_for_beds</span><span class="p">(</span><span class="n">persons_id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">target</span><span class="p">),</span>
                                <span class="n">footprint</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">BEDDAYS_FOOTPRINT</span>
                            <span class="p">)</span>

                    <span class="c1"># Check that a facility has been assigned to this HSI</span>
                    <span class="k">assert</span> <span class="n">event</span><span class="o">.</span><span class="n">facility_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> \
                        <span class="sa">f</span><span class="s2">&quot;Cannot run HSI </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">TREATMENT_ID</span><span class="si">}</span><span class="s2"> without facility_info being defined.&quot;</span>

                    <span class="c1"># Run the HSI event (allowing it to return an updated appt_footprint)</span>
                    <span class="n">actual_appt_footprint</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">squeeze_factor</span><span class="o">=</span><span class="n">squeeze_factor</span><span class="p">)</span>

                    <span class="c1"># Check if the HSI event returned updated appt_footprint</span>
                    <span class="k">if</span> <span class="n">actual_appt_footprint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># The returned footprint is different to the expected footprint: so must update load factors</span>

                        <span class="c1"># check its formatting:</span>
                        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">appt_footprint_is_valid</span><span class="p">(</span><span class="n">actual_appt_footprint</span><span class="p">)</span>

                        <span class="c1"># Update load factors:</span>
                        <span class="n">updated_call</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_appt_footprint_as_time_request</span><span class="p">(</span>
                            <span class="n">facility_info</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">facility_info</span><span class="p">,</span>
                            <span class="n">appt_footprint</span><span class="o">=</span><span class="n">actual_appt_footprint</span>
                        <span class="p">)</span>
                        <span class="n">original_call</span> <span class="o">=</span> <span class="n">footprints_of_all_individual_level_hsi_event</span><span class="p">[</span><span class="n">ev_num</span><span class="p">]</span>
                        <span class="n">footprints_of_all_individual_level_hsi_event</span><span class="p">[</span><span class="n">ev_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">updated_call</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">running_total_footprint</span> <span class="o">-=</span> <span class="n">original_call</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">running_total_footprint</span> <span class="o">+=</span> <span class="n">updated_call</span>

                        <span class="c1"># Don&#39;t recompute for mode=0</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_appt_constraints</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">squeeze_factor_per_hsi_event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_squeeze_factors</span><span class="p">(</span>
                                <span class="n">footprints_per_event</span><span class="o">=</span><span class="n">footprints_of_all_individual_level_hsi_event</span><span class="p">,</span>
                                <span class="n">total_footprint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">running_total_footprint</span><span class="p">,</span>
                                <span class="n">current_capabilities</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">capabilities_today</span><span class="p">,</span>
                                <span class="n">compute_squeeze_factor_to_district_level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span>
                                <span class="n">compute_squeeze_factor_to_district_level</span><span class="p">,</span>
                            <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># no actual footprint is returned so take the expected initial declaration as the actual,</span>
                        <span class="c1"># as recorded before the HSI event run</span>
                        <span class="n">actual_appt_footprint</span> <span class="o">=</span> <span class="n">_appt_footprint_before_running</span>

                    <span class="c1"># Write to the log</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">record_hsi_event</span><span class="p">(</span>
                        <span class="n">hsi_event</span><span class="o">=</span><span class="n">event</span><span class="p">,</span>
                        <span class="n">actual_appt_footprint</span><span class="o">=</span><span class="n">actual_appt_footprint</span><span class="p">,</span>
                        <span class="n">squeeze_factor</span><span class="o">=</span><span class="n">squeeze_factor</span><span class="p">,</span>
                        <span class="n">did_run</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">priority</span><span class="o">=</span><span class="n">_priority</span>
                    <span class="p">)</span>

                <span class="c1"># if not ok_to_run</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Do not run,</span>
                    <span class="c1"># Call did_not_run for the hsi_event</span>
                    <span class="n">rtn_from_did_not_run</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">did_not_run</span><span class="p">()</span>

                    <span class="c1"># If received no response from the call to did_not_run, or a True signal, then</span>
                    <span class="c1"># add to the hold-over queue.</span>
                    <span class="c1"># Otherwise (disease module returns &quot;FALSE&quot;) the event is not rescheduled and will not run.</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">rtn_from_did_not_run</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">):</span>
                        <span class="c1"># reschedule event</span>
                        <span class="n">hp</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">_to_be_held_over</span><span class="p">,</span> <span class="n">_list_of_individual_hsi_event_tuples</span><span class="p">[</span><span class="n">ev_num</span><span class="p">])</span>

                    <span class="c1"># Log that the event did not run</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">record_hsi_event</span><span class="p">(</span>
                        <span class="n">hsi_event</span><span class="o">=</span><span class="n">event</span><span class="p">,</span>
                        <span class="n">actual_appt_footprint</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span><span class="p">,</span>
                        <span class="n">squeeze_factor</span><span class="o">=</span><span class="n">squeeze_factor</span><span class="p">,</span>
                        <span class="n">did_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">priority</span><span class="o">=</span><span class="n">_priority</span>
                    <span class="p">)</span>

        <span class="k">return</span> <span class="n">_to_be_held_over</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hsi_event_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Counter</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Counts of details of HSI events which have run so far in simulation.</span>

<span class="sd">        Returns a ``Counter`` instance with keys ``HSIEventDetail`` named tuples</span>
<span class="sd">        corresponding to details of HSI events that have run over simulation so far.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hsi_event_count_log_period</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Counter</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If in middle of log period _hsi_event_counts_log_period will not be empty</span>
            <span class="c1"># and so overall total counts is sums of counts in both</span>
            <span class="c1"># _hsi_event_counts_cumulative and _hsi_event_counts_log_period</span>
            <span class="n">total_hsi_event_counts</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_hsi_event_counts_cumulative</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hsi_event_counts_log_period</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">Counter</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="n">event_details</span><span class="p">:</span> <span class="n">total_hsi_event_counts</span><span class="p">[</span><span class="n">event_details_key</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">event_details</span><span class="p">,</span> <span class="n">event_details_key</span>
                    <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hsi_event_details</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">}</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">never_ran_hsi_event_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Counter</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Counts of details of HSI events which never ran so far in simulation.</span>

<span class="sd">        Returns a ``Counter`` instance with keys ``HSIEventDetail`` named tuples</span>
<span class="sd">        corresponding to details of HSI events that have never ran over simulation so far.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hsi_event_count_log_period</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Counter</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If in middle of log period _hsi_event_counts_log_period will not be empty</span>
            <span class="c1"># and so overall total counts is sums of counts in both</span>
            <span class="c1"># _hsi_event_counts_cumulative and _hsi_event_counts_log_period</span>
            <span class="n">total_never_ran_hsi_event_counts</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_never_ran_hsi_event_counts_cumulative</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_never_ran_hsi_event_counts_log_period</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">Counter</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="n">event_details</span><span class="p">:</span> <span class="n">total_never_ran_hsi_event_counts</span><span class="p">[</span><span class="n">event_details_key</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">event_details</span><span class="p">,</span> <span class="n">event_details_key</span>
                    <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_never_ran_hsi_event_details</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">}</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="HealthSystemScheduler"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystemScheduler">[docs]</a><span class="k">class</span> <span class="nc">HealthSystemScheduler</span><span class="p">(</span><span class="n">RegularEvent</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the HealthSystemScheduler. It is an event that occurs every day and must be the LAST event of the day.</span>
<span class="sd">    It inspects the calls on the healthsystem and commissions event to occur that are consistent with the</span>
<span class="sd">    healthsystem&#39;s capabilities for the following day, given assumptions about how this decision is made.</span>

<span class="sd">    N.B. Events scheduled for the same day will occur that day, but after those which were scheduled on an earlier date.</span>

<span class="sd">        The overall Prioritization algorithm is:</span>
<span class="sd">        * Look at events in order (the order is set by the heapq: see `schedule_hsi_event`)</span>
<span class="sd">        * Ignore if the current data is before topen</span>
<span class="sd">        * Remove and do nothing if tclose has expired</span>
<span class="sd">        * Run any  population-level HSI events</span>
<span class="sd">        * For an individual-level HSI event, check if there are sufficient health system capabilities to run the event</span>

<span class="sd">    If the event is to be run, then the following events occur:</span>
<span class="sd">        * The HSI event itself is run.</span>
<span class="sd">        * The occurence of the event is logged</span>
<span class="sd">        * The resources used are &#39;occupied&#39; (if individual level HSI event)</span>
<span class="sd">        * Other disease modules are alerted of the occurence of the HSI event (if individual level HSI event)</span>

<span class="sd">    Here is where we can have multiple types of assumption regarding how these capabilities are modelled.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="HealthSystemScheduler.__init__"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystemScheduler.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">:</span> <span class="n">HealthSystem</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">priority</span><span class="o">=</span><span class="n">Priority</span><span class="o">.</span><span class="n">END_OF_DAY</span><span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystemScheduler._is_last_day_of_the_year"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystemScheduler._is_last_day_of_the_year">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_is_last_day_of_the_year</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="mi">31</span><span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystemScheduler._is_last_day_of_the_month"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystemScheduler._is_last_day_of_the_month">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_is_last_day_of_the_month</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">date</span><span class="o">.</span><span class="n">month</span> <span class="o">!=</span> <span class="p">(</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">month</span></div>

<div class="viewcode-block" id="HealthSystemScheduler._get_events_due_today"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystemScheduler._get_events_due_today">[docs]</a>    <span class="k">def</span> <span class="nf">_get_events_due_today</span><span class="p">(</span><span class="bp">self</span><span class="p">,)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">List</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Interrogate the HSI_EVENT queue object to remove from it the events due today, and to return these in two</span>
<span class="sd">        lists:</span>
<span class="sd">         * list_of_individual_hsi_event_tuples_due_today</span>
<span class="sd">         * list_of_population_hsi_event_tuples_due_today</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_list_of_individual_hsi_event_tuples_due_today</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">_list_of_population_hsi_event_tuples_due_today</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">_list_of_events_not_due_today</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="c1"># To avoid repeated dataframe accesses in subsequent loop, assemble set of alive</span>
        <span class="c1"># person IDs as  one-off operation, exploiting the improved efficiency of</span>
        <span class="c1"># boolean-indexing of a Series compared to row-by-row access. From benchmarks</span>
        <span class="c1"># converting Series to list before converting to set is ~2x more performant than</span>
        <span class="c1"># direct conversion to set, while checking membership of set is ~10x quicker</span>
        <span class="c1"># than checking membership of Pandas Index object and ~25x quicker than checking</span>
        <span class="c1"># membership of list</span>
        <span class="n">alive_persons</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">is_alive</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># Traverse the queue and split events into the three lists (due-individual, due-population, not_due)</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">HSI_EVENT_QUEUE</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="n">next_event_tuple</span> <span class="o">=</span> <span class="n">hp</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">HSI_EVENT_QUEUE</span><span class="p">)</span>
            <span class="c1"># Read the tuple and remove from heapq, and assemble into a dict &#39;next_event&#39;</span>

            <span class="n">event</span> <span class="o">=</span> <span class="n">next_event_tuple</span><span class="o">.</span><span class="n">hsi_event</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;</span> <span class="n">next_event_tuple</span><span class="o">.</span><span class="n">tclose</span><span class="p">:</span>
                <span class="c1"># The event has expired (after tclose) having never been run. Call the &#39;never_ran&#39; function</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">call_and_record_never_ran_hsi_event</span><span class="p">(</span>
                      <span class="n">hsi_event</span><span class="o">=</span><span class="n">event</span><span class="p">,</span>
                      <span class="n">priority</span><span class="o">=</span><span class="n">next_event_tuple</span><span class="o">.</span><span class="n">priority</span>
                     <span class="p">)</span>

            <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">tlo</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">Population</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">event</span><span class="o">.</span><span class="n">target</span> <span class="ow">in</span> <span class="n">alive_persons</span>
            <span class="p">):</span>
                <span class="c1"># if individual level event and the person who is the target is no longer alive, do nothing more,</span>
                <span class="c1"># i.e. remove from heapq</span>
                <span class="k">pass</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;</span> <span class="n">next_event_tuple</span><span class="o">.</span><span class="n">topen</span><span class="p">:</span>
                <span class="c1"># The event is not yet due (before topen)</span>
                <span class="n">hp</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">_list_of_events_not_due_today</span><span class="p">,</span> <span class="n">next_event_tuple</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">next_event_tuple</span><span class="o">.</span><span class="n">priority</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">lowest_priority_considered</span><span class="p">:</span>
                    <span class="c1"># Check the priority</span>
                    <span class="c1"># If the next event is not due and has lowest allowed priority, then stop looking</span>
                    <span class="c1"># through the heapq as all other events will also not be due.</span>
                    <span class="k">break</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># The event is now due to run today and the person is confirmed to be still alive</span>
                <span class="c1"># Add it to the list of events due today (individual or population level)</span>
                <span class="c1"># NB. These list is ordered by priority and then due date</span>

                <span class="n">is_pop_level_hsi_event</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">tlo</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">Population</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">is_pop_level_hsi_event</span><span class="p">:</span>
                    <span class="n">_list_of_population_hsi_event_tuples_due_today</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_event_tuple</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_list_of_individual_hsi_event_tuples_due_today</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_event_tuple</span><span class="p">)</span>

        <span class="c1"># add events from the _list_of_events_not_due_today back into the queue</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">_list_of_events_not_due_today</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">hp</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">HSI_EVENT_QUEUE</span><span class="p">,</span> <span class="n">hp</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="n">_list_of_events_not_due_today</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">_list_of_individual_hsi_event_tuples_due_today</span><span class="p">,</span> <span class="n">_list_of_population_hsi_event_tuples_due_today</span></div>

<div class="viewcode-block" id="HealthSystemScheduler.process_events_mode_0_and_1"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystemScheduler.process_events_mode_0_and_1">[docs]</a>    <span class="k">def</span> <span class="nf">process_events_mode_0_and_1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hold_over</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">HSIEventQueueItem</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Get the events that are due today:</span>
            <span class="p">(</span>
                <span class="n">list_of_individual_hsi_event_tuples_due_today</span><span class="p">,</span>
                <span class="n">list_of_population_hsi_event_tuples_due_today</span>
             <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_events_due_today</span><span class="p">()</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">list_of_individual_hsi_event_tuples_due_today</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">list_of_population_hsi_event_tuples_due_today</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">break</span>

            <span class="c1"># Run the list of population-level HSI events</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">run_population_level_events</span><span class="p">(</span><span class="n">list_of_population_hsi_event_tuples_due_today</span><span class="p">)</span>

            <span class="c1"># Run the list of individual-level events</span>
            <span class="n">_to_be_held_over</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">run_individual_level_events_in_mode_0_or_1</span><span class="p">(</span>
                <span class="n">list_of_individual_hsi_event_tuples_due_today</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">hold_over</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_to_be_held_over</span><span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystemScheduler.process_events_mode_2"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystemScheduler.process_events_mode_2">[docs]</a>    <span class="k">def</span> <span class="nf">process_events_mode_2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hold_over</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">HSIEventQueueItem</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">capabilities_monitor</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">capabilities_today</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
        <span class="n">set_capabilities_still_available</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">capabilities_monitor</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">}</span>

        <span class="c1"># Here use different approach for appt_mode_constraints = 2: rather than collecting events</span>
        <span class="c1"># due today all at once, run event immediately at time of querying. This ensure that no</span>
        <span class="c1"># artificial &quot;midday effects&quot; are introduced when evaluating priority policies.</span>

        <span class="c1"># To avoid repeated dataframe accesses in subsequent loop, assemble set of alive</span>
        <span class="c1"># person IDs as one-off operation, exploiting the improved efficiency of</span>
        <span class="c1"># boolean-indexing of a Series compared to row-by-row access. From benchmarks</span>
        <span class="c1"># converting Series to list before converting to set is ~2x more performant than</span>
        <span class="c1"># direct conversion to set, while checking membership of set is ~10x quicker</span>
        <span class="c1"># than checking membership of Pandas Index object and ~25x quicker than checking</span>
        <span class="c1"># membership of list</span>
        <span class="n">alive_persons</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">is_alive</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="n">list_of_population_hsi_event_tuples_due_today</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">list_of_events_not_due_today</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="c1"># Traverse the queue and run events due today until have capabilities still available</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">HSI_EVENT_QUEUE</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="c1"># Check if any of the officers in the country are still available for today.</span>
            <span class="c1"># If not, no point in going through the queue any longer.</span>
            <span class="c1"># This will make things slower for tests/small simulations, but should be of significant help</span>
            <span class="c1"># in the case of large simulations in mode_appt_constraints = 2 where number of people in the</span>
            <span class="c1"># queue for today &gt;&gt; resources available for that day. This would be faster done by facility.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">set_capabilities_still_available</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

                <span class="n">next_event_tuple</span> <span class="o">=</span> <span class="n">hp</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">HSI_EVENT_QUEUE</span><span class="p">)</span>
                <span class="c1"># Read the tuple and remove from heapq, and assemble into a dict &#39;next_event&#39;</span>

                <span class="n">event</span> <span class="o">=</span> <span class="n">next_event_tuple</span><span class="o">.</span><span class="n">hsi_event</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;</span> <span class="n">next_event_tuple</span><span class="o">.</span><span class="n">tclose</span><span class="p">:</span>
                    <span class="c1"># The event has expired (after tclose) having never been run. Call the &#39;never_ran&#39; function</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">call_and_record_never_ran_hsi_event</span><span class="p">(</span>
                          <span class="n">hsi_event</span><span class="o">=</span><span class="n">event</span><span class="p">,</span>
                          <span class="n">priority</span><span class="o">=</span><span class="n">next_event_tuple</span><span class="o">.</span><span class="n">priority</span>
                         <span class="p">)</span>

                <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span>
                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">tlo</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">Population</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="n">event</span><span class="o">.</span><span class="n">target</span> <span class="ow">in</span> <span class="n">alive_persons</span>
                <span class="p">):</span>
                    <span class="c1"># if individual level event and the person who is the target is no longer alive,</span>
                    <span class="c1"># do nothing more, i.e. remove from heapq</span>
                    <span class="k">pass</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;</span> <span class="n">next_event_tuple</span><span class="o">.</span><span class="n">topen</span><span class="p">:</span>
                    <span class="c1"># The event is not yet due (before topen)</span>
                    <span class="n">hp</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">list_of_events_not_due_today</span><span class="p">,</span> <span class="n">next_event_tuple</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">next_event_tuple</span><span class="o">.</span><span class="n">priority</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">lowest_priority_considered</span><span class="p">:</span>
                        <span class="c1"># Check the priority</span>
                        <span class="c1"># If the next event is not due and has lowest allowed priority, then stop looking</span>
                        <span class="c1"># through the heapq as all other events will also not be due.</span>
                        <span class="k">break</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># The event is now due to run today and the person is confirmed to be still alive</span>
                    <span class="c1"># Add it to the list of events due today if at population level.</span>
                    <span class="c1"># Otherwise, run event immediately.</span>

                    <span class="n">is_pop_level_hsi_event</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">tlo</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">Population</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">is_pop_level_hsi_event</span><span class="p">:</span>
                        <span class="n">list_of_population_hsi_event_tuples_due_today</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_event_tuple</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>

                        <span class="c1"># Retrieve officers&amp;facility required for HSI</span>
                        <span class="n">original_call</span> <span class="o">=</span> <span class="n">next_event_tuple</span><span class="o">.</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">expected_time_requests</span>
                        <span class="n">_priority</span> <span class="o">=</span> <span class="n">next_event_tuple</span><span class="o">.</span><span class="n">priority</span>
                        <span class="c1"># In this version of mode_appt_constraints = 2, do not have access to squeeze</span>
                        <span class="c1"># based on queue information, and we assume no squeeze ever takes place.</span>
                        <span class="n">squeeze_factor</span> <span class="o">=</span> <span class="mf">0.</span>

                        <span class="c1"># Check if any of the officers required have ran out.</span>
                        <span class="n">out_of_resources</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">for</span> <span class="n">officer</span><span class="p">,</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">original_call</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="c1"># If any of the officers are not available, then out of resources</span>
                            <span class="k">if</span> <span class="n">officer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">set_capabilities_still_available</span><span class="p">:</span>
                                <span class="n">out_of_resources</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="c1"># If officers still available, run event. Note: in current logic, a little</span>
                        <span class="c1"># overtime is allowed to run last event of the day. This seems more realistic</span>
                        <span class="c1"># than medical staff leaving earlier than</span>
                        <span class="c1"># planned if seeing another patient would take them into overtime.</span>

                        <span class="k">if</span> <span class="n">out_of_resources</span><span class="p">:</span>

                            <span class="c1"># Do not run,</span>
                            <span class="c1"># Call did_not_run for the hsi_event</span>
                            <span class="n">rtn_from_did_not_run</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">did_not_run</span><span class="p">()</span>

                            <span class="c1"># If received no response from the call to did_not_run, or a True signal, then</span>
                            <span class="c1"># add to the hold-over queue.</span>
                            <span class="c1"># Otherwise (disease module returns &quot;FALSE&quot;) the event is not rescheduled and</span>
                            <span class="c1"># will not run.</span>

                            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">rtn_from_did_not_run</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">):</span>
                                <span class="c1"># reschedule event</span>
                                <span class="c1"># Add the event to the queue:</span>
                                <span class="n">hp</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">hold_over</span><span class="p">,</span> <span class="n">next_event_tuple</span><span class="p">)</span>

                            <span class="c1"># Log that the event did not run</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">record_hsi_event</span><span class="p">(</span>
                                <span class="n">hsi_event</span><span class="o">=</span><span class="n">event</span><span class="p">,</span>
                                <span class="n">actual_appt_footprint</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span><span class="p">,</span>
                                <span class="n">squeeze_factor</span><span class="o">=</span><span class="n">squeeze_factor</span><span class="p">,</span>
                                <span class="n">did_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">priority</span><span class="o">=</span><span class="n">_priority</span>
                            <span class="p">)</span>

                        <span class="c1"># Have enough capabilities left to run event</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Notes-to-self: Shouldn&#39;t this be done after checking the footprint?</span>
                            <span class="c1"># Compute the bed days that are allocated to this HSI and provide this</span>
                            <span class="c1"># information to the HSI</span>
                            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">BEDDAYS_FOOTPRINT</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                                <span class="n">event</span><span class="o">.</span><span class="n">_received_info_about_bed_days</span> <span class="o">=</span> \
                                    <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">bed_days</span><span class="o">.</span><span class="n">issue_bed_days_according_to_availability</span><span class="p">(</span>
                                        <span class="n">facility_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">bed_days</span><span class="o">.</span><span class="n">get_facility_id_for_beds</span><span class="p">(</span>
                                                                           <span class="n">persons_id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">target</span><span class="p">),</span>
                                        <span class="n">footprint</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">BEDDAYS_FOOTPRINT</span>
                                    <span class="p">)</span>

                            <span class="c1"># Check that a facility has been assigned to this HSI</span>
                            <span class="k">assert</span> <span class="n">event</span><span class="o">.</span><span class="n">facility_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> \
                                <span class="sa">f</span><span class="s2">&quot;Cannot run HSI </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">TREATMENT_ID</span><span class="si">}</span><span class="s2"> without facility_info being defined.&quot;</span>

                            <span class="c1"># Expected appt footprint before running event</span>
                            <span class="n">_appt_footprint_before_running</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span>
                            <span class="c1"># Run event &amp; get actual footprint</span>
                            <span class="n">actual_appt_footprint</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">squeeze_factor</span><span class="o">=</span><span class="n">squeeze_factor</span><span class="p">)</span>

                            <span class="c1"># Check if the HSI event returned updated_appt_footprint, and if so adjust original_call</span>
                            <span class="k">if</span> <span class="n">actual_appt_footprint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                                <span class="c1"># check its formatting:</span>
                                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">appt_footprint_is_valid</span><span class="p">(</span><span class="n">actual_appt_footprint</span><span class="p">)</span>

                                <span class="c1"># Update call that will be used to compute capabilities used</span>
                                <span class="n">updated_call</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">get_appt_footprint_as_time_request</span><span class="p">(</span>
                                    <span class="n">facility_info</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">facility_info</span><span class="p">,</span>
                                    <span class="n">appt_footprint</span><span class="o">=</span><span class="n">actual_appt_footprint</span>
                                <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">actual_appt_footprint</span> <span class="o">=</span> <span class="n">_appt_footprint_before_running</span>
                                <span class="n">updated_call</span> <span class="o">=</span> <span class="n">original_call</span>

                            <span class="c1"># Recalculate call on officers based on squeeze factor.</span>
                            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">updated_call</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                <span class="n">updated_call</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">updated_call</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">squeeze_factor</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">)</span>

                            <span class="c1"># Subtract this from capabilities used so-far today</span>
                            <span class="n">capabilities_monitor</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">updated_call</span><span class="p">)</span>

                            <span class="c1"># If any of the officers have ran out of time by performing this hsi,</span>
                            <span class="c1"># remove them from list of available officers.</span>
                            <span class="k">for</span> <span class="n">officer</span><span class="p">,</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">updated_call</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="k">if</span> <span class="n">capabilities_monitor</span><span class="p">[</span><span class="n">officer</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">officer</span> <span class="ow">in</span> <span class="n">set_capabilities_still_available</span><span class="p">:</span>
                                        <span class="n">set_capabilities_still_available</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">officer</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
                                            <span class="n">data</span><span class="o">=</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">TREATMENT_ID</span><span class="si">}</span><span class="s2"> actual_footprint requires different&quot;</span>
                                                  <span class="sa">f</span><span class="s2">&quot;officers than expected_footprint.&quot;</span><span class="p">)</span>
                                        <span class="p">)</span>

                            <span class="c1"># Update today&#39;s footprint based on actuall call and squeeze factor</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">running_total_footprint</span> <span class="o">-=</span> <span class="n">original_call</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">running_total_footprint</span> <span class="o">+=</span> <span class="n">updated_call</span>

                            <span class="c1"># Write to the log</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">record_hsi_event</span><span class="p">(</span>
                                <span class="n">hsi_event</span><span class="o">=</span><span class="n">event</span><span class="p">,</span>
                                <span class="n">actual_appt_footprint</span><span class="o">=</span><span class="n">actual_appt_footprint</span><span class="p">,</span>
                                <span class="n">squeeze_factor</span><span class="o">=</span><span class="n">squeeze_factor</span><span class="p">,</span>
                                <span class="n">did_run</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">priority</span><span class="o">=</span><span class="n">_priority</span>
                            <span class="p">)</span>

            <span class="c1"># Don&#39;t have any capabilities at all left for today, no</span>
            <span class="c1"># point in going through the queue to check what&#39;s left to do today.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c1"># Traverse the queue again to check all appts which have expired are removed from the queue,</span>
        <span class="c1"># and call did_not_run() for all those that were postponed.</span>
        <span class="c1"># In previous iteration, we stopped querying the queue once capabilities</span>
        <span class="c1"># were exhausted, so here ensure if any events expired were left unchecked they are properly</span>
        <span class="c1"># removed from the queue, and did_not_run() is invoked for all postponed events.</span>
        <span class="c1"># (This should still be more efficient than querying the queue as done in mode_appt_constraints</span>
        <span class="c1">#  = 0 and 1 while ensuring mid-day effects are avoided.)</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">HSI_EVENT_QUEUE</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="n">next_event_tuple</span> <span class="o">=</span> <span class="n">hp</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">HSI_EVENT_QUEUE</span><span class="p">)</span>
            <span class="c1"># Read the tuple and remove from heapq, and assemble into a dict &#39;next_event&#39;</span>

            <span class="n">event</span> <span class="o">=</span> <span class="n">next_event_tuple</span><span class="o">.</span><span class="n">hsi_event</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;</span> <span class="n">next_event_tuple</span><span class="o">.</span><span class="n">tclose</span><span class="p">:</span>
                <span class="c1"># The event has expired (after tclose) having never been run. Call the &#39;never_ran&#39; function</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">call_and_record_never_ran_hsi_event</span><span class="p">(</span>
                      <span class="n">hsi_event</span><span class="o">=</span><span class="n">event</span><span class="p">,</span>
                      <span class="n">priority</span><span class="o">=</span><span class="n">next_event_tuple</span><span class="o">.</span><span class="n">priority</span>
                     <span class="p">)</span>

            <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">tlo</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">Population</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">event</span><span class="o">.</span><span class="n">target</span> <span class="ow">in</span> <span class="n">alive_persons</span>
            <span class="p">):</span>
                <span class="c1"># if individual level event and the person who is the target is no longer alive,</span>
                <span class="c1"># do nothing more, i.e. remove from heapq</span>
                <span class="k">pass</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;</span> <span class="n">next_event_tuple</span><span class="o">.</span><span class="n">topen</span><span class="p">:</span>
                <span class="c1"># The event is not yet due (before topen)</span>
                <span class="n">hp</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">list_of_events_not_due_today</span><span class="p">,</span> <span class="n">next_event_tuple</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">next_event_tuple</span><span class="o">.</span><span class="n">priority</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">lowest_priority_considered</span><span class="p">:</span>
                    <span class="c1"># Check the priority</span>
                    <span class="c1"># If the next event is not due and has lowest allowed priority, then stop looking</span>
                    <span class="c1"># through the heapq as all other events will also not be due.</span>
                    <span class="k">break</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># The event is now due to run today and the person is confirmed to be still alive</span>
                <span class="c1"># Add it to the list of events due today if at population level.</span>
                <span class="c1"># Otherwise, run event immediately.</span>

                <span class="n">is_pop_level_hsi_event</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">tlo</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">Population</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">is_pop_level_hsi_event</span><span class="p">:</span>
                    <span class="n">list_of_population_hsi_event_tuples_due_today</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_event_tuple</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># In previous iteration, have already ran all the events for today that could run</span>
                    <span class="c1"># given capabilities available, so put back any remaining events due today to the</span>
                    <span class="c1"># hold_over queue as it would not be possible to run them today.</span>

                    <span class="c1"># Do not run,</span>
                    <span class="c1"># Call did_not_run for the hsi_event</span>
                    <span class="n">rtn_from_did_not_run</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">did_not_run</span><span class="p">()</span>

                    <span class="c1"># If received no response from the call to did_not_run, or a True signal, then</span>
                    <span class="c1"># add to the hold-over queue.</span>
                    <span class="c1"># Otherwise (disease module returns &quot;FALSE&quot;) the event is not rescheduled and</span>
                    <span class="c1"># will not run.</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">rtn_from_did_not_run</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">):</span>
                        <span class="c1"># reschedule event</span>
                        <span class="c1"># Add the event to the queue:</span>
                        <span class="n">hp</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">hold_over</span><span class="p">,</span> <span class="n">next_event_tuple</span><span class="p">)</span>

                    <span class="c1"># Log that the event did not run</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">record_hsi_event</span><span class="p">(</span>
                       <span class="n">hsi_event</span><span class="o">=</span><span class="n">event</span><span class="p">,</span>
                       <span class="n">actual_appt_footprint</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span><span class="p">,</span>
                       <span class="n">squeeze_factor</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                       <span class="n">did_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">priority</span><span class="o">=</span><span class="n">next_event_tuple</span><span class="o">.</span><span class="n">priority</span>
                       <span class="p">)</span>

        <span class="c1"># add events from the list_of_events_not_due_today back into the queue</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_of_events_not_due_today</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">hp</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">HSI_EVENT_QUEUE</span><span class="p">,</span> <span class="n">hp</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="n">list_of_events_not_due_today</span><span class="p">))</span>

        <span class="c1"># Run the list of population-level HSI events</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">run_population_level_events</span><span class="p">(</span><span class="n">list_of_population_hsi_event_tuples_due_today</span><span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystemScheduler.apply"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystemScheduler.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>

        <span class="c1"># Refresh information ready for new day:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">bed_days</span><span class="o">.</span><span class="n">on_start_of_day</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">consumables</span><span class="o">.</span><span class="n">on_start_of_day</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>

        <span class="c1"># Compute footprint that arise from in-patient bed-days</span>
        <span class="n">inpatient_appts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">bed_days</span><span class="o">.</span><span class="n">get_inpatient_appts</span><span class="p">()</span>
        <span class="n">inpatient_footprints</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_fac_id</span><span class="p">,</span> <span class="n">_footprint</span> <span class="ow">in</span> <span class="n">inpatient_appts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">inpatient_footprints</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">get_appt_footprint_as_time_request</span><span class="p">(</span>
                <span class="n">facility_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">_facility_by_facility_id</span><span class="p">[</span><span class="n">_fac_id</span><span class="p">],</span> <span class="n">appt_footprint</span><span class="o">=</span><span class="n">_footprint</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Write to the log that these in-patient appointments were needed:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inpatient_appts</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">_fac_id</span><span class="p">,</span> <span class="n">_inpatient_appts</span> <span class="ow">in</span> <span class="n">inpatient_appts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">write_to_hsi_log</span><span class="p">(</span>
                    <span class="n">event_details</span><span class="o">=</span><span class="n">HSIEventDetails</span><span class="p">(</span>
                        <span class="n">event_name</span><span class="o">=</span><span class="s1">&#39;Inpatient_Care&#39;</span><span class="p">,</span>
                        <span class="n">module_name</span><span class="o">=</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">,</span>
                        <span class="n">treatment_id</span><span class="o">=</span><span class="s1">&#39;Inpatient_Care&#39;</span><span class="p">,</span>
                        <span class="n">facility_level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">_facility_by_facility_id</span><span class="p">[</span><span class="n">_fac_id</span><span class="p">]</span><span class="o">.</span><span class="n">level</span><span class="p">,</span>
                        <span class="n">appt_footprint</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">_inpatient_appts</span><span class="o">.</span><span class="n">items</span><span class="p">())),</span>
                        <span class="n">beddays_footprint</span><span class="o">=</span><span class="p">()</span>
                    <span class="p">),</span>
                    <span class="n">person_id</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">facility_id</span><span class="o">=</span><span class="n">_fac_id</span><span class="p">,</span>
                    <span class="n">squeeze_factor</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                    <span class="n">priority</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">did_run</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># Restart the total footprint of all calls today, beginning with those due to existing in-patients.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">running_total_footprint</span> <span class="o">=</span> <span class="n">inpatient_footprints</span>

        <span class="c1"># Create hold-over list. This will hold events that cannot occur today before they are added back to the queue.</span>
        <span class="n">hold_over</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">mode_appt_constraints</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># Run all events due today, repeating the check for due events until none are due</span>
            <span class="c1"># (this allows for HSI that are added to the queue in the course of other HSI</span>
            <span class="c1"># for this today to be run this day).</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_events_mode_0_and_1</span><span class="p">(</span><span class="n">hold_over</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">mode_appt_constraints</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_events_mode_2</span><span class="p">(</span><span class="n">hold_over</span><span class="p">)</span>

        <span class="c1"># -- End-of-day activities --</span>
        <span class="c1"># Add back to the HSI_EVENT_QUEUE heapq all those events which are still eligible to run but which did not run</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">hold_over</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">hp</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">HSI_EVENT_QUEUE</span><span class="p">,</span> <span class="n">hp</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="n">hold_over</span><span class="p">))</span>

        <span class="c1"># Log total usage of the facilities</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">log_current_capabilities_and_usage</span><span class="p">()</span>

        <span class="c1"># Trigger jobs to be done at the end of the day (after all HSI run)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">on_end_of_day</span><span class="p">()</span>

        <span class="c1"># Do activities that are required at end of month (if last day of the month)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_last_day_of_the_month</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">on_end_of_month</span><span class="p">()</span>

        <span class="c1"># Do activities that are required at end of year (if last day of the year)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_last_day_of_the_year</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">on_end_of_year</span><span class="p">()</span></div></div>

<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1">#   Logging</span>
<span class="c1"># ---------------------------------------------------------------------------</span>


<span class="k">class</span> <span class="nc">HealthSystemSummaryCounter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper class to keep running counts of HSI and the state of the HealthSystem and logging summaries.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_internal_stores</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_reset_internal_stores</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create empty versions of the data structures used to store a running records.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_treatment_ids</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>  <span class="c1"># Running record of the `TREATMENT_ID`s of `HSI_Event`s</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_appts</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>  <span class="c1"># Running record of the Appointments of `HSI_Event`s that have run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_appts_by_level</span> <span class="o">=</span> <span class="p">{</span><span class="n">_level</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">_level</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;1a&#39;</span><span class="p">,</span> <span class="s1">&#39;1b&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">)}</span>

        <span class="c1"># Log HSI_Events that never ran to monitor shortcoming of Health System</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_never_ran_treatment_ids</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>  <span class="c1"># As above, but for `HSI_Event`s that never ran</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_never_ran_appts</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>  <span class="c1"># As above, but for `HSI_Event`s that have never ran</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_never_ran_appts_by_level</span> <span class="o">=</span> <span class="p">{</span><span class="n">_level</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">_level</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;1a&#39;</span><span class="p">,</span> <span class="s1">&#39;1b&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">)}</span>

        <span class="c1"># &lt;--Same as `self._appts` but also split by facility_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_frac_time_used_overall</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Running record of the usage of the healthcare system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_squeeze_factor_by_hsi_event_name</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>  <span class="c1"># Running record the squeeze-factor applying to each</span>
        <span class="c1">#                                                           treatment_id. Key is of the form:</span>
        <span class="c1">#                                                           &quot;&lt;TREATMENT_ID&gt;:&lt;HSI_EVENT_NAME&gt;&quot;</span>

    <span class="k">def</span> <span class="nf">record_hsi_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                         <span class="n">treatment_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">hsi_event_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">squeeze_factor</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                         <span class="n">appt_footprint</span><span class="p">:</span> <span class="n">Counter</span><span class="p">,</span>
                         <span class="n">level</span><span class="p">:</span> <span class="nb">str</span>
                         <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add information about an `HSI_Event` to the running summaries.&quot;&quot;&quot;</span>

        <span class="c1"># Count the treatment_id:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_treatment_ids</span><span class="p">[</span><span class="n">treatment_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Add the squeeze-factor to the list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_squeeze_factor_by_hsi_event_name</span><span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">treatment_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">hsi_event_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">squeeze_factor</span><span class="p">)</span>

        <span class="c1"># Count each type of appointment:</span>
        <span class="k">for</span> <span class="n">appt_type</span><span class="p">,</span> <span class="n">number</span> <span class="ow">in</span> <span class="n">appt_footprint</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_appts</span><span class="p">[</span><span class="n">appt_type</span><span class="p">]</span> <span class="o">+=</span> <span class="n">number</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_appts_by_level</span><span class="p">[</span><span class="n">level</span><span class="p">][</span><span class="n">appt_type</span><span class="p">]</span> <span class="o">+=</span> <span class="n">number</span>

    <span class="k">def</span> <span class="nf">record_never_ran_hsi_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                   <span class="n">treatment_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                   <span class="n">hsi_event_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                   <span class="n">appt_footprint</span><span class="p">:</span> <span class="n">Counter</span><span class="p">,</span>
                                   <span class="n">level</span><span class="p">:</span> <span class="nb">str</span>
                                   <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add information about a never-ran `HSI_Event` to the running summaries.&quot;&quot;&quot;</span>

        <span class="c1"># Count the treatment_id:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_never_ran_treatment_ids</span><span class="p">[</span><span class="n">treatment_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Count each type of appointment:</span>
        <span class="k">for</span> <span class="n">appt_type</span><span class="p">,</span> <span class="n">number</span> <span class="ow">in</span> <span class="n">appt_footprint</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_never_ran_appts</span><span class="p">[</span><span class="n">appt_type</span><span class="p">]</span> <span class="o">+=</span> <span class="n">number</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_never_ran_appts_by_level</span><span class="p">[</span><span class="n">level</span><span class="p">][</span><span class="n">appt_type</span><span class="p">]</span> <span class="o">+=</span> <span class="n">number</span>

    <span class="k">def</span> <span class="nf">record_hs_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fraction_time_used_across_all_facilities</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Record a current status metric of the HealthSystem.&quot;&quot;&quot;</span>

        <span class="c1"># The fraction of all healthcare worker time that is used:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_frac_time_used_overall</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fraction_time_used_across_all_facilities</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write_to_log_and_reset_counters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log summary statistics reset the data structures.&quot;&quot;&quot;</span>

        <span class="n">logger_summary</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;HSI_Event&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Counts of the HSI_Events that have occurred in this calendar year by TREATMENT_ID, &quot;</span>
                        <span class="s2">&quot;and counts of the &#39;Appt_Type&#39;s that have occurred in this calendar year,&quot;</span>
                        <span class="s2">&quot;and the average squeeze_factor for HSIs that have occurred in this calendar year.&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;TREATMENT_ID&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_treatment_ids</span><span class="p">,</span>
                <span class="s2">&quot;Number_By_Appt_Type_Code&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_appts</span><span class="p">,</span>
                <span class="s2">&quot;Number_By_Appt_Type_Code_And_Level&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_appts_by_level</span><span class="p">,</span>
                <span class="s1">&#39;squeeze_factor&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_squeeze_factor_by_hsi_event_name</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">}</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># Log summary of HSI_Events that never ran</span>
        <span class="n">logger_summary</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Never_ran_HSI_Event&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Counts of the HSI_Events that never ran in this calendar year by TREATMENT_ID, &quot;</span>
                        <span class="s2">&quot;and the respective &#39;Appt_Type&#39;s that have not occurred in this calendar year.&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;TREATMENT_ID&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_never_ran_treatment_ids</span><span class="p">,</span>
                <span class="s2">&quot;Number_By_Appt_Type_Code&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_never_ran_appts</span><span class="p">,</span>
                <span class="s2">&quot;Number_By_Appt_Type_Code_And_Level&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_never_ran_appts_by_level</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="n">logger_summary</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Capacity&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The fraction of all the healthcare worker time that is used each day, averaged over this &quot;</span>
                        <span class="s2">&quot;calendar year.&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;average_Frac_Time_Used_Overall&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_frac_time_used_overall</span><span class="p">),</span>
                <span class="c1"># &lt;-- leaving space here for additional summary measures that may be needed in the future.</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_internal_stores</span><span class="p">()</span>


<div class="viewcode-block" id="HealthSystemChangeParameters"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystemChangeParameters">[docs]</a><span class="k">class</span> <span class="nc">HealthSystemChangeParameters</span><span class="p">(</span><span class="n">Event</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Event that causes certain internal parameters of the HealthSystem to be changed; specifically:</span>
<span class="sd">        * `mode_appt_constraints`</span>
<span class="sd">        * `ignore_priority`</span>
<span class="sd">        * `capabilities_coefficient`</span>
<span class="sd">        * `cons_availability`</span>
<span class="sd">        * `beds_availability`</span>
<span class="sd">    Note that no checking is done here on the suitability of values of each parameter.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="HealthSystemChangeParameters.__init__"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystemChangeParameters.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">:</span> <span class="n">HealthSystem</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span> <span class="o">=</span> <span class="n">parameters</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">HealthSystem</span><span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystemChangeParameters.apply"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystemChangeParameters.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;mode_appt_constraints&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">mode_appt_constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">[</span><span class="s1">&#39;mode_appt_constraints&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;ignore_priority&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">ignore_priority</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">[</span><span class="s1">&#39;ignore_priority&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;capabilities_coefficient&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">capabilities_coefficient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">[</span><span class="s1">&#39;capabilities_coefficient&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;cons_availability&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">consumables</span> <span class="o">=</span> <span class="n">Consumables</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;availability_estimates&#39;</span><span class="p">],</span>
                                                  <span class="n">rng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="p">,</span>
                                                  <span class="n">availability</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">[</span><span class="s1">&#39;cons_availability&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">consumables</span><span class="o">.</span><span class="n">on_start_of_day</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;beds_availability&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">bed_days</span><span class="o">.</span><span class="n">availability</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">[</span><span class="s1">&#39;beds_availability&#39;</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="HealthSystemChangePriorityPolicyAndMode"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystemChangePriorityPolicyAndMode">[docs]</a><span class="k">class</span> <span class="nc">HealthSystemChangePriorityPolicyAndMode</span><span class="p">(</span><span class="n">RegularEvent</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; This event exists to change the priority policy adopted by the</span>
<span class="sd">    HealthSystem at a given year.    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="HealthSystemChangePriorityPolicyAndMode.__init__"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystemChangePriorityPolicyAndMode.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">100</span><span class="p">))</span></div>

<div class="viewcode-block" id="HealthSystemChangePriorityPolicyAndMode.apply"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystemChangePriorityPolicyAndMode.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>

        <span class="c1"># Change mode_appt_constraints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">mode_appt_constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;mode_appt_constraints_postSwitch&quot;</span><span class="p">]</span>

        <span class="c1"># If policy has changed, update it</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;policy_name&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;policy_name_post_switch&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">priority_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;policy_name_post_switch&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">load_priority_policy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">priority_policy</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Switched policy at sim date: &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="si">}</span><span class="s2">&quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;Now using policy: &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">priority_policy</span><span class="si">}</span><span class="s2">&quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;and mode: &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">mode_appt_constraints</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
      <span class="lastupdated">
        Last updated on Sep 27, 2023.
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>