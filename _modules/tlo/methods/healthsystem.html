

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>tlo.methods.healthsystem &mdash; TLOmodel 0.1.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.png"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> TLOmodel
          

          
          </a>

          
            
            
              <div class="version">
                0.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Welcome</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../aims.html">Aims &amp; Objectives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../writeups.html">Model Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data_sources.html">Data Sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../azure_batch.html">Using Azure Batch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">TLOmodel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../methods.html">tlo.methods</a> &raquo;</li>
        
      <li>tlo.methods.healthsystem</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for tlo.methods.healthsystem</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Todo:   - speed up</span>
<span class="sd">        - phase-out use of facility_name and replace with facility_id</span>
<span class="sd">        - re-organised resource files: bring in one united file, and then decompose following read_parameters</span>
<span class="sd">        - bed days parameterisation</span>
<span class="sd">        - let the level of the appointment be in the log</span>
<span class="sd">        - move things to the hsi base class</span>
<span class="sd">        - let the logger give times of each hcw</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">heapq</span> <span class="k">as</span> <span class="nn">hp</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">repeat</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">NamedTuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">tlo</span>
<span class="kn">from</span> <span class="nn">tlo</span> <span class="kn">import</span> <span class="n">Date</span><span class="p">,</span> <span class="n">DateOffset</span><span class="p">,</span> <span class="n">Module</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">,</span> <span class="n">Property</span><span class="p">,</span> <span class="n">Types</span><span class="p">,</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="nn">tlo.events</span> <span class="kn">import</span> <span class="n">Event</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">,</span> <span class="n">RegularEvent</span>
<span class="kn">from</span> <span class="nn">tlo.methods</span> <span class="kn">import</span> <span class="n">Metadata</span>
<span class="kn">from</span> <span class="nn">tlo.methods.bed_days</span> <span class="kn">import</span> <span class="n">BedDays</span>
<span class="kn">from</span> <span class="nn">tlo.methods.dxmanager</span> <span class="kn">import</span> <span class="n">DxManager</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FacilityInfo</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Information about a specific health facility.&quot;&quot;&quot;</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">class</span> <span class="nc">AppointmentSubunit</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Component of an appointment relating to a specific officer type.&quot;&quot;&quot;</span>
    <span class="n">officer_type</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">time_taken</span><span class="p">:</span> <span class="nb">float</span>


<span class="k">class</span> <span class="nc">HSIEventDetails</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Non-target specific details of a health system interaction event.&quot;&quot;&quot;</span>
    <span class="n">event_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">treatment_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">facility_level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="n">appt_footprint</span><span class="p">:</span> <span class="n">Tuple</span>


<span class="k">class</span> <span class="nc">HSIEventQueueItem</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Properties of event added to health system queue.</span>

<span class="sd">    The order of the attributes in the tuple is important as the queue sorting is done</span>
<span class="sd">    by the order of the items in the tuple, i.e. first by `priority`, then `topen` and</span>
<span class="sd">    so on.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">priority</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">topen</span><span class="p">:</span> <span class="n">Date</span>
    <span class="n">queue_counter</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">tclose</span><span class="p">:</span> <span class="n">Date</span>
    <span class="c1"># Define HSI_Event type as string to avoid NameError exception as HSI_Event defined</span>
    <span class="c1"># later in module (see https://stackoverflow.com/a/36286947/4798943)</span>
    <span class="n">hsi_event</span><span class="p">:</span> <span class="s1">&#39;HSI_Event&#39;</span>


<span class="k">def</span> <span class="nf">_accepts_argument</span><span class="p">(</span><span class="n">function</span><span class="p">:</span> <span class="n">callable</span><span class="p">,</span> <span class="n">argument</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Helper to test if callable object accepts an argument with a given name.</span>

<span class="sd">    Compared to using `inspect.signature` or `inspect.getfullargspec` the approach here</span>
<span class="sd">    has significantly less overhead (as a full `Signature` or `FullArgSpec` object</span>
<span class="sd">    does not need to constructed) but is also less readable hence why it has been</span>
<span class="sd">    wrapped as a helper function despite being only one-line to make its functionality</span>
<span class="sd">    more obvious.</span>

<span class="sd">    :param function: Callable object to check if argument is present in.</span>
<span class="sd">    :param argument: Name of argument to check.</span>
<span class="sd">    :returns: ``True`` is ``argument`` is an argument of ``function`` else ``False``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># co_varnames include both arguments to function and any internally defined variable</span>
    <span class="c1"># names hence we check only in the first `co_argcount` items which correspond to</span>
    <span class="c1"># just the arguments</span>
    <span class="k">return</span> <span class="n">argument</span> <span class="ow">in</span> <span class="n">function</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">[:</span><span class="n">function</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_argcount</span><span class="p">]</span>


<div class="viewcode-block" id="HealthSystem"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem">[docs]</a><span class="k">class</span> <span class="nc">HealthSystem</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the Health System Module</span>
<span class="sd">    Version: September 2019</span>
<span class="sd">    The execution of all health systems interactions are controlled through this module.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">INIT_DEPENDENCIES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Demography&#39;</span><span class="p">}</span>

    <span class="n">PARAMETERS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;BedCapacity&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s2">&quot;Data on the number of beds available of each type by facility_id&quot;</span><span class="p">),</span>
        <span class="s1">&#39;Officer_Types&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s1">&#39;The names of the types of health workers (&quot;officers&quot;)&#39;</span><span class="p">),</span>
        <span class="s1">&#39;Daily_Capabilities&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s1">&#39;The capabilities by facility and officer type available each day&#39;</span>
        <span class="p">),</span>
        <span class="s1">&#39;Appt_Types_Table&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s1">&#39;The names of the type of appointments with the health system&#39;</span><span class="p">),</span>
        <span class="s1">&#39;Appt_Time_Table&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">DICT</span><span class="p">,</span> <span class="s1">&#39;The time taken for each appointment, according to officer and facility type.&#39;</span>
        <span class="p">),</span>
        <span class="s1">&#39;ApptType_By_FacLevel&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;Indicates whether an appointment type can occur at a facility level.&#39;</span>
        <span class="p">),</span>
        <span class="s1">&#39;Master_Facilities_List&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s1">&#39;Listing of all health facilities.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;Facilities_For_Each_District&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">DICT</span><span class="p">,</span>
            <span class="s1">&#39;Mapping between a district and all of the health facilities to which its </span><span class="se">\</span>
<span class="s1">                      population have access.&#39;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s1">&#39;Consumables&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s1">&#39;List of consumables used in each intervention and their costs.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;Consumables_Cost_List&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s1">&#39;List of each consumable item and it&#39;</span> <span class="s1">&#39;s cost&#39;</span><span class="p">),</span>
        <span class="s1">&#39;Service_Availability&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;List of services to be available.&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">PROPERTIES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;hs_dist_to_facility&#39;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s1">&#39;The distance for each person to their nearest clinic (of any type)&#39;</span>
        <span class="p">),</span>
        <span class="s1">&#39;hs_is_inpatient&#39;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span> <span class="s1">&#39;Whether or not the person is currently an in-patient at any medical facility&#39;</span>
        <span class="p">),</span>
    <span class="p">}</span>

<div class="viewcode-block" id="HealthSystem.__init__"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">resourcefilepath</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">service_availability</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mode_appt_constraints</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">ignore_cons_constraints</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ignore_priority</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">capabilities_coefficient</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">disable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">disable_and_reject_all</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">store_hsi_events_that_have_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">record_hsi_event_details</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param name: Name to use for module, defaults to module class name if ``None``.</span>
<span class="sd">        :param resourcefilepath: Path to directory containing resource files.</span>
<span class="sd">        :param service_availability: A list of treatment IDs to allow.</span>
<span class="sd">        :param mode_appt_constraints: Integer code in ``{0, 1, 2}`` determining mode of</span>
<span class="sd">            constraints with regards to officer numbers and time - 0: no constraints,</span>
<span class="sd">            all HSI events run with no squeeze factor, 1: elastic constraints, all HSI</span>
<span class="sd">            events run with squeeze factor, 2: hard constraints, only HSI events with</span>
<span class="sd">            no squeeze factor run.</span>
<span class="sd">        :param ignore_cons_constraints: Mode for consumable constraints (if ``True``,</span>
<span class="sd">            all consumables available).</span>
<span class="sd">        :param ignore_priority: If ``True`` do not use the priority information in HSI</span>
<span class="sd">            event to schedule</span>
<span class="sd">        :param capabilities_coefficient: Multiplier for the capabilities of health</span>
<span class="sd">            officers, if ``None`` set to ratio of initial population to estimated 2010</span>
<span class="sd">            population.</span>
<span class="sd">        :param disable: If ``True``, disables the health system (no constraints and no</span>
<span class="sd">            logging) and every HSI event runs.</span>
<span class="sd">        :param disable_and_reject_all: If ``True``, disable health system and no HSI</span>
<span class="sd">            events run</span>
<span class="sd">        :param store_hsi_events_that_have_run: Convenience flag for debugging.</span>
<span class="sd">        :param record_hsi_event_details: Whether to record details of HSI events used.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resourcefilepath</span> <span class="o">=</span> <span class="n">resourcefilepath</span>

        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">ignore_cons_constraints</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">bool</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_cons_constraints</span> <span class="o">=</span> <span class="n">ignore_cons_constraints</span>

        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">disable</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">bool</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">disable_and_reject_all</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">bool</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="n">disable</span> <span class="ow">and</span> <span class="n">disable_and_reject_all</span><span class="p">),</span> <span class="p">(</span>
            <span class="s1">&#39;Cannot have both disable and disable_and_reject_all selected&#39;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disable</span> <span class="o">=</span> <span class="n">disable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disable_and_reject_all</span> <span class="o">=</span> <span class="n">disable_and_reject_all</span>

        <span class="k">assert</span> <span class="n">mode_appt_constraints</span> <span class="ow">in</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mode_appt_constraints</span> <span class="o">=</span> <span class="n">mode_appt_constraints</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_priority</span> <span class="o">=</span> <span class="n">ignore_priority</span>

        <span class="c1"># Store the argument provided for service_availability</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg_service_availabily</span> <span class="o">=</span> <span class="n">service_availability</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service_availability</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>  <span class="c1"># provided so that there is a default even before simulation is run</span>

        <span class="c1"># Check that the capabilities coefficient is correct</span>
        <span class="k">if</span> <span class="n">capabilities_coefficient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">capabilities_coefficient</span> <span class="o">&gt;=</span> <span class="mi">0</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">capabilities_coefficient</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capabilities_coefficient</span> <span class="o">=</span> <span class="n">capabilities_coefficient</span>

        <span class="c1"># Define (empty) list of registered disease modules (filled in at `initialise_simulation`)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recognised_modules_names</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Define the container for calls for health system interaction events</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HSI_EVENT_QUEUE</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hsi_event_queue_counter</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Counter to help with the sorting in the heapq</span>

        <span class="c1"># Check &#39;store_hsi_events_that_have_run&#39;: will store a running list of HSI events that have run</span>
        <span class="c1"># (for debugging)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">store_hsi_events_that_have_run</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store_hsi_events_that_have_run</span> <span class="o">=</span> <span class="n">store_hsi_events_that_have_run</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_hsi_events_that_have_run</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store_of_hsi_events_that_have_run</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="c1"># If record_hsi_event_details == True, a set will be built during the simulation</span>
        <span class="c1"># containing HSIEventDetails tuples corresponding to all HSI_Event instances</span>
        <span class="c1"># used in the simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">record_hsi_event_details</span> <span class="o">=</span> <span class="n">record_hsi_event_details</span>
        <span class="k">if</span> <span class="n">record_hsi_event_details</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hsi_event_details</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># Create the Diagnostic Test Manager to store and manage all Diagnostic Test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dx_manager</span> <span class="o">=</span> <span class="n">DxManager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Create the instance of BedDays to record usage of in-patient bed days</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bed_days</span> <span class="o">=</span> <span class="n">BedDays</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem.read_parameters"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.read_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">read_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_folder</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Officer_Types_Table&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resourcefilepath</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;ResourceFile_Officer_Types_Table.csv&#39;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Appt_Types_Table&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resourcefilepath</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;ResourceFile_Appt_Types_Table.csv&#39;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_appointment_types</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Appt_Types_Table&#39;</span><span class="p">][</span><span class="s1">&#39;Appt_Type_Code&#39;</span><span class="p">])</span>

        <span class="n">appt_time_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resourcefilepath</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;ResourceFile_Appt_Time_Table.csv&#39;</span>
        <span class="p">)</span>
        <span class="n">facility_levels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">appt_time_data</span><span class="p">[</span><span class="s1">&#39;Facility_Level&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="c1"># Check that facility levels are consecutive integers starting from 0</span>
        <span class="k">assert</span> <span class="n">facility_levels</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">facility_levels</span><span class="p">)))</span>
        <span class="c1"># Store facility levels in module for check in schedule_hsi_event and for</span>
        <span class="c1"># check against levels in facilities per district resource file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_facility_levels</span> <span class="o">=</span> <span class="n">facility_levels</span>
        <span class="c1"># Store data as tuple of dicts, with tuple indexed by integer facility level and</span>
        <span class="c1"># dict indexed by string type code with values corresponding to list of (named)</span>
        <span class="c1"># tuples of appointment officer type codes and time takens</span>
        <span class="n">appt_times_per_level_and_type</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">facility_levels</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">appt_time_tuple</span> <span class="ow">in</span> <span class="n">appt_time_data</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
            <span class="n">appt_times_per_level_and_type</span><span class="p">[</span>
                <span class="n">appt_time_tuple</span><span class="o">.</span><span class="n">Facility_Level</span>
            <span class="p">][</span>
                <span class="n">appt_time_tuple</span><span class="o">.</span><span class="n">Appt_Type_Code</span>
            <span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">AppointmentSubunit</span><span class="p">(</span>
                    <span class="n">officer_type</span><span class="o">=</span><span class="n">appt_time_tuple</span><span class="o">.</span><span class="n">Officer_Type_Code</span><span class="p">,</span>
                    <span class="n">time_taken</span><span class="o">=</span><span class="n">appt_time_tuple</span><span class="o">.</span><span class="n">Time_Taken</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="nb">sum</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">appt_info_list</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">facility_levels</span>
                <span class="k">for</span> <span class="n">appt_info_list</span> <span class="ow">in</span> <span class="n">appt_times_per_level_and_type</span><span class="p">[</span><span class="n">level</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">appt_time_data</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Appt_Time_Table&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">appt_times_per_level_and_type</span>

        <span class="n">appt_type_per_level_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resourcefilepath</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;ResourceFile_ApptType_By_FacLevel.csv&#39;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ApptType_By_FacLevel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">set</span><span class="p">(</span>
                <span class="n">appt_type_per_level_data</span><span class="p">[</span><span class="s1">&#39;Appt_Type_Code&#39;</span><span class="p">][</span>
                    <span class="n">appt_type_per_level_data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Facility_Level_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">facility_levels</span>
        <span class="p">]</span>

        <span class="n">mfl</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resourcefilepath</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;ResourceFile_Master_Facilities_List.csv&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Master_Facilities_List&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mfl</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>  <span class="c1"># get rid of extra column</span>

        <span class="n">facilities_per_district_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resourcefilepath</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;ResourceFile_Facilities_For_Each_District.csv&#39;</span>
        <span class="p">)</span>
        <span class="n">districts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">facilities_per_district_data</span><span class="p">[</span><span class="s1">&#39;District&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">facility_levels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">facilities_per_district_data</span><span class="p">[</span><span class="s1">&#39;Facility_Level&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="c1"># Check facility levels match those from appointment time table</span>
        <span class="k">assert</span> <span class="n">facility_levels</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_facility_levels</span><span class="p">,</span> <span class="p">(</span>
            <span class="s2">&quot;Mismatch between facility levels in Facilities_For_Each_District &quot;</span>
            <span class="s2">&quot;resource file and Appt_Time_Table resource files&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Store data as tuple of dicts, with tuple indexed by integer facility level and</span>
        <span class="c1"># dict indexed by district name with values corresponding to (named) tuples of</span>
        <span class="c1"># facility ID and name</span>
        <span class="n">facilities_per_level_and_district</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">({}</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">facility_levels</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">facility_tuple</span> <span class="ow">in</span> <span class="n">facilities_per_district_data</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
            <span class="n">facilities_per_level_and_district</span><span class="p">[</span>
                <span class="n">facility_tuple</span><span class="o">.</span><span class="n">Facility_Level</span>
            <span class="p">][</span>
                <span class="n">facility_tuple</span><span class="o">.</span><span class="n">District</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">FacilityInfo</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">facility_tuple</span><span class="o">.</span><span class="n">Facility_ID</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">facility_tuple</span><span class="o">.</span><span class="n">Facility_Name</span>
            <span class="p">)</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="n">districts</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">facilities_per_level_and_district</span><span class="p">),</span> <span class="p">(</span>
            <span class="s2">&quot;Facilities_For_Each_District resource file does not contain facilities &quot;</span>
            <span class="s2">&quot;at all levels for all districts&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Facilities_For_Each_District&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">facilities_per_level_and_district</span>

        <span class="n">caps</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resourcefilepath</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;ResourceFile_Daily_Capabilities.csv&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Daily_Capabilities&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">caps</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reformat_daily_capabilities</span><span class="p">()</span>  <span class="c1"># Reformats this table to include zero where capacity is not available</span>
        <span class="c1"># Store set of officers with non-zero daily availability for checking scheduled</span>
        <span class="c1"># HSI events do not make appointment time requests of unavailable officers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_officers_with_availability</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Daily_Capabilities&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Daily_Capabilities&#39;</span><span class="p">][</span><span class="s1">&#39;Total_Minutes_Per_Day&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Read in ResourceFile_Consumables and then process it to create the data structures needed</span>
        <span class="c1"># NB. Modules can use this to look-up what consumables they need.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Consumables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resourcefilepath</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;ResourceFile_Consumables.csv&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_consumables_file</span><span class="p">()</span>

        <span class="c1"># Set default parameter for Service Availablity (everthing available)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Service_Availability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>

        <span class="c1"># Data on the number of beds available of each type by facility_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;BedCapacity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resourcefilepath</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;ResourceFile_Bed_Capacity.csv&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem.process_consumables_file"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.process_consumables_file">[docs]</a>    <span class="k">def</span> <span class="nf">process_consumables_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper function for processing the consumables data (stored as self.parameters[&#39;Consumables&#39;])</span>
<span class="sd">        * Creates ```parameters[&#39;Consumables&#39;]```</span>
<span class="sd">        * Creates ```df_mapping_pkg_code_to_intv_code```</span>
<span class="sd">        * Creates ```prob_item_code_available```</span>
<span class="sd">        * Creates ```parameters[&#39;Consumables_Cost_List]```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Load the &#39;raw&#39; ResourceFile_Consumabes that is loaded in to self.parameters[&#39;Consumables&#39;]</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Consumables&#39;</span><span class="p">]</span>
        <span class="c1"># -------------------------------------------------------------------------------------------------</span>
        <span class="c1"># Create a pd.DataFrame that maps pkg code (as index) to item code:</span>
        <span class="c1"># This is used to quickly look-up which items are required in each package</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[[</span><span class="s1">&#39;Intervention_Pkg_Code&#39;</span><span class="p">,</span> <span class="s1">&#39;Item_Code&#39;</span><span class="p">,</span> <span class="s1">&#39;Expected_Units_Per_Case&#39;</span><span class="p">]]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Intervention_Pkg_Code&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_mapping_pkg_code_to_intv_code</span> <span class="o">=</span> <span class="n">df</span>

        <span class="c1"># -------------------------------------------------------------------------------------------------</span>
        <span class="c1"># Make ```prob_item_codes_available```</span>
        <span class="c1"># This is a data-frame that organise the probabilities of individual consumables items being available</span>
        <span class="c1"># (by the item codes)</span>
        <span class="n">unique_item_codes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Item_Code&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="s1">&#39;Item_Code&#39;</span><span class="p">])})</span>

        <span class="c1"># merge in probabilities of being available</span>
        <span class="n">filter_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">raw</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Available_Facility_Level_&#39;</span><span class="p">)]</span>
        <span class="n">filter_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Item_Code&#39;</span><span class="p">)</span>
        <span class="n">prob_item_codes_available</span> <span class="o">=</span> <span class="n">unique_item_codes</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">raw</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;Item_Code&#39;</span><span class="p">])[</span><span class="n">filter_col</span><span class="p">],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;Item_Code&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">prob_item_codes_available</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_item_codes</span><span class="p">)</span>

        <span class="c1"># set the index as the Item_Code and save</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prob_item_codes_available</span> <span class="o">=</span> <span class="n">prob_item_codes_available</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Item_Code&#39;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># -------------------------------------------------------------------------------------------------</span>
        <span class="c1"># Create ```parameters[&#39;Consumables_Cost_List]```</span>
        <span class="c1"># This is a pd.Series, with index item_code, giving the cost of each item.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Consumables_Cost_List&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
            <span class="n">raw</span><span class="p">[[</span><span class="s1">&#39;Item_Code&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit_Cost&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Item_Code&#39;</span><span class="p">)[</span><span class="s1">&#39;Unit_Cost&#39;</span><span class="p">]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem.pre_initialise_population"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.pre_initialise_population">[docs]</a>    <span class="k">def</span> <span class="nf">pre_initialise_population</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bed_days</span><span class="o">.</span><span class="n">pre_initialise_population</span><span class="p">()</span></div>

<div class="viewcode-block" id="HealthSystem.initialise_population"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.initialise_population">[docs]</a>    <span class="k">def</span> <span class="nf">initialise_population</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
        <span class="c1"># If capabilities coefficient was not explicitly specified, use ratio of initial</span>
        <span class="c1"># population size to estimated actual population in 2010</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">capabilities_coefficient</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">demography_module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;Demography&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">capabilities_coefficient</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">demography_module</span><span class="o">.</span><span class="n">compute_initial_population_scaling_factor</span><span class="p">(</span>
                    <span class="n">population</span><span class="o">.</span><span class="n">initial_size</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="c1"># Assign hs_dist_to_facility&#39;</span>
        <span class="c1"># (For now, let this be a random number, but in future it may be properly informed based on \</span>
        <span class="c1">#  population density distribitions)</span>
        <span class="c1"># Note that this characteritic is inherited from mother to child.</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s1">&#39;hs_dist_to_facility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">5.00</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bed_days</span><span class="o">.</span><span class="n">initialise_population</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem.initialise_simulation"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.initialise_simulation">[docs]</a>    <span class="k">def</span> <span class="nf">initialise_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span><span class="p">):</span>

        <span class="c1"># Set the tracker in preparation for the simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bed_days</span><span class="o">.</span><span class="n">initialise_beddays_tracker</span><span class="p">()</span>

        <span class="c1"># Capture list of disease modules:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recognised_modules_names</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">m</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">Metadata</span><span class="o">.</span><span class="n">USES_HEALTHSYSTEM</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">METADATA</span>
        <span class="p">]</span>

        <span class="c1"># Check that set of districts of residence in population are subset o districts from</span>
        <span class="c1"># Facilities_For_Each_District resource file</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">districts_of_residence</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s2">&quot;district_of_residence&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span>
            <span class="n">districts_of_residence</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">per_level_facilities</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">per_level_facilities</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;Facilities_For_Each_District&quot;</span><span class="p">]</span>
        <span class="p">),</span> <span class="p">(</span>
            <span class="s2">&quot;At least one district_of_residence value in population not present in &quot;</span>
            <span class="s2">&quot;Facilities_For_Each_District resource file&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Launch the healthsystem scheduler (a regular event occurring each day) [if not disabled]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disable</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_and_reject_all</span><span class="p">):</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">HealthSystemScheduler</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>

        <span class="c1"># Update consumables available today:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">determine_availability_of_consumables_today</span><span class="p">()</span>

        <span class="c1"># Determine service_availability</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_service_availability</span><span class="p">()</span></div>

<div class="viewcode-block" id="HealthSystem.set_service_availability"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.set_service_availability">[docs]</a>    <span class="k">def</span> <span class="nf">set_service_availability</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set service availability. (Should be equal to what is specified by the parameter, but overwrite with what was</span>
<span class="sd">         provided in arguement if an argument was specified -- provided for backward compatibility.)&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_service_availabily</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">service_availability</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Service_Availability&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">service_availability</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_service_availabily</span>

        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">service_availability</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service_availability</span> <span class="o">=</span> <span class="n">service_availability</span>

        <span class="c1"># Log the service_availability</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Running Health System With the Following Service Availability: &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">service_availability</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem.on_birth"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.on_birth">[docs]</a>    <span class="k">def</span> <span class="nf">on_birth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mother_id</span><span class="p">,</span> <span class="n">child_id</span><span class="p">):</span>

        <span class="c1"># New child inherits the hs_dist_to_facility of the mother</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s1">&#39;hs_dist_to_facility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">mother_id</span><span class="p">,</span> <span class="s1">&#39;hs_dist_to_facility&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bed_days</span><span class="o">.</span><span class="n">on_birth</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">mother_id</span><span class="p">,</span> <span class="n">child_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem.on_simulation_end"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.on_simulation_end">[docs]</a>    <span class="k">def</span> <span class="nf">on_simulation_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Put out to the log the information from the tracker of the last day of the simulation&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bed_days</span><span class="o">.</span><span class="n">on_simulation_end</span><span class="p">()</span></div>

<div class="viewcode-block" id="HealthSystem.register_disease_module"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.register_disease_module">[docs]</a>    <span class="k">def</span> <span class="nf">register_disease_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_disease_module</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is now deprecated. Disease modules do not need to register with the health system.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="HealthSystem.schedule_hsi_event"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.schedule_hsi_event">[docs]</a>    <span class="k">def</span> <span class="nf">schedule_hsi_event</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">hsi_event</span><span class="p">,</span> <span class="n">priority</span><span class="p">,</span> <span class="n">topen</span><span class="p">,</span> <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">do_hsi_event_checks</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Schedule a health system interaction (HSI) event.</span>

<span class="sd">        :param hsi_event: The HSI event to be scheduled.</span>
<span class="sd">        :param priority: The priority for the HSI event (0 (highest), 1 or 2 (lowest)</span>
<span class="sd">        :param topen: The earliest date at which the HSI event should run</span>
<span class="sd">        :param tclose: The latest date at which the HSI event should run. Set to one</span>
<span class="sd">           week after ``topen`` if ``None``.</span>
<span class="sd">        :param do_hsi_event_checks: Whether to perform sanity checks on the passed</span>
<span class="sd">            ``hsi_event`` argument to check that it constitutes a valid HSI event. This</span>
<span class="sd">            is intended for allowing disabling of these checks when scheduling multiple</span>
<span class="sd">            HSI events of the same ``HSI_Event`` subclass together, in which case</span>
<span class="sd">            typically performing these checks for each individual HSI event of the</span>
<span class="sd">            shared type will be redundant.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s1">&#39;message&#39;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;HealthSystem.schedule_event &gt;&gt; Logging a request for an HSI: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">TREATMENT_ID</span><span class="si">}</span><span class="s2"> for person: </span><span class="si">{</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># If there is no specified tclose time then set this to a week after topen</span>
        <span class="k">if</span> <span class="n">tclose</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tclose</span> <span class="o">=</span> <span class="n">topen</span> <span class="o">+</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

        <span class="c1"># Check topen is not in the past</span>
        <span class="k">assert</span> <span class="n">topen</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>

        <span class="c1"># Check that priority is in valid range</span>
        <span class="k">assert</span> <span class="n">priority</span> <span class="ow">in</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">}</span>

        <span class="c1"># Check that topen is strictly before tclose</span>
        <span class="k">assert</span> <span class="n">topen</span> <span class="o">&lt;</span> <span class="n">tclose</span>

        <span class="c1"># Check if healthsystem is disabled/disable_and_reject_all, and scheduled a the event with appropriate wrapper.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_and_reject_all</span><span class="p">):</span>
            <span class="c1"># If healthsystem is disabled (but HSI can still run), ...</span>
            <span class="c1">#   ... put this event straight into the normal simulation scheduler.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">HSIEventWrapper</span><span class="p">(</span><span class="n">hsi_event</span><span class="o">=</span><span class="n">hsi_event</span><span class="p">,</span> <span class="n">run_hsi</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">topen</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_and_reject_all</span><span class="p">:</span>
            <span class="c1"># If healthsystem is disabled the HSI will never run: schedule for the &quot;never_ran&quot; method for `tclose`.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">HSIEventWrapper</span><span class="p">(</span><span class="n">hsi_event</span><span class="o">=</span><span class="n">hsi_event</span><span class="p">,</span> <span class="n">run_hsi</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">tclose</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Check that this is a legitimate health system interaction (HSI) event</span>
        <span class="c1"># These checks are only performed when the flag `do_hsi_event_checks` is set</span>
        <span class="c1"># to ``True`` to allow disabling when the checks are redundant for example when</span>
        <span class="c1"># scheduling multiple HSI events of same `HSI_Event` subclass</span>
        <span class="k">if</span> <span class="n">do_hsi_event_checks</span><span class="p">:</span>

            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hsi_event</span><span class="p">,</span> <span class="n">HSI_Event</span><span class="p">)</span>

            <span class="c1"># Check that non-empty treatment ID specified (required for both population</span>
            <span class="c1"># and individual scoped events)</span>
            <span class="k">assert</span> <span class="n">hsi_event</span><span class="o">.</span><span class="n">TREATMENT_ID</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">tlo</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">Population</span><span class="p">):</span>
                <span class="c1"># This is an individual-scoped HSI event.</span>
                <span class="c1"># It must have EXPECTED_APPT_FOOTPRINT, BEDDAYS_FOOTPRINT,</span>
                <span class="c1"># ACCEPTED_FACILITY_LEVELS and ALERT_OTHER_DISEASES defined</span>

                <span class="c1"># Correct formated EXPECTED_APPT_FOOTPRINT</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">appt_footprint_is_valid</span><span class="p">(</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span><span class="p">)</span>

                <span class="c1"># That it has an &#39;ACCEPTED_FACILITY_LEVEL&#39; attribute</span>
                <span class="c1"># (Integer specificying the facility level at which HSI_Event must occur)</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">hsi_event</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_facility_levels</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">bed_days</span><span class="o">.</span><span class="n">check_beddays_footprint_format</span><span class="p">(</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">BEDDAYS_FOOTPRINT</span><span class="p">)</span>

                <span class="c1"># That it has a list for the other disease that will be alerted when it</span>
                <span class="c1"># is run and that this make sense</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">ALERT_OTHER_DISEASES</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">ALERT_OTHER_DISEASES</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">ALERT_OTHER_DISEASES</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">hsi_event</span><span class="o">.</span><span class="n">ALERT_OTHER_DISEASES</span><span class="p">:</span>
                            <span class="k">assert</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">recognised_modules_names</span>

                <span class="c1"># Check that this can accept the squeeze argument</span>
                <span class="k">assert</span> <span class="n">_accepts_argument</span><span class="p">(</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="s1">&#39;squeeze_factor&#39;</span><span class="p">)</span>

                <span class="c1"># Check that at least one type of appointment is required</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span>
                    <span class="s1">&#39;No appointment types required in the EXPECTED_APPT_FOOTPRINT&#39;</span>
                <span class="p">)</span>
                <span class="c1"># Check that the event does not request an appointment at a facility</span>
                <span class="c1"># level which is not possible</span>
                <span class="n">appt_type_to_check_list</span> <span class="o">=</span> <span class="n">hsi_event</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="n">facility_appt_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ApptType_By_FacLevel&#39;</span><span class="p">][</span>
                    <span class="n">hsi_event</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span>
                <span class="p">]</span>
                <span class="k">assert</span> <span class="n">facility_appt_types</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">appt_type_to_check_list</span><span class="p">),</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;An appointment type has been requested at a facility level for &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;which it is not possible: </span><span class="si">{</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">TREATMENT_ID</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Check that event (if individual level) is able to run with this configuration</span>
        <span class="c1"># of officers (i.e. check that this does not demand officers that are never</span>
        <span class="c1"># available at a particular facility). This is run irrespective of the value of</span>
        <span class="c1"># _do_hsi_event_checks as the appointment footprint time request depends on the</span>
        <span class="c1"># district of residence of the HSI event&#39;s target and so the time requests can</span>
        <span class="c1"># differ for each instance of an HSI_Event subclass even when their other</span>
        <span class="c1"># attributes are shared</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">tlo</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">Population</span><span class="p">):</span>
            <span class="n">footprint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_appt_footprint_as_time_request</span><span class="p">(</span><span class="n">hsi_event</span><span class="o">=</span><span class="n">hsi_event</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_officers_with_availability</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">footprint</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="n">key</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="p">(</span>
                        <span class="s2">&quot;The expected footprint is not possible with the configuration &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;of officers: </span><span class="si">{</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">TREATMENT_ID</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="c1"># Check that this request is allowable under current policy (i.e. included in</span>
        <span class="c1"># service_availability)</span>
        <span class="n">allowed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_availability</span><span class="p">:</span>  <span class="c1"># it&#39;s an empty list</span>
            <span class="n">allowed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_availability</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>  <span class="c1"># it&#39;s the overall wild-card, do anything</span>
            <span class="n">allowed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">hsi_event</span><span class="o">.</span><span class="n">TREATMENT_ID</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_availability</span><span class="p">:</span>
            <span class="n">allowed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">hsi_event</span><span class="o">.</span><span class="n">TREATMENT_ID</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">allowed</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># (if no treatment_id it can pass)</span>
        <span class="k">elif</span> <span class="n">hsi_event</span><span class="o">.</span><span class="n">TREATMENT_ID</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;GenericFirstAppt&#39;</span><span class="p">):</span>
            <span class="n">allowed</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># allow all GenericFirstAppts</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># check to see if anything provided given any wildcards</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_availability</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                    <span class="n">stub</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">hsi_event</span><span class="o">.</span><span class="n">TREATMENT_ID</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">stub</span><span class="p">):</span>
                        <span class="n">allowed</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>

        <span class="c1">#  Manipulate the priority level if needed</span>
        <span class="c1"># If ignoring the priority in scheduling, then over-write the provided priority information</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_priority</span><span class="p">:</span>
            <span class="n">priority</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># set all event to priority 0</span>
        <span class="c1"># This is where could attach a different priority score according to the treatment_id (and other things)</span>
        <span class="c1"># in order to examine the influence of the prioritisation score.</span>

        <span class="c1"># If all is correct and the hsi event is allowed then add this request to the queue of HSI_EVENT_QUEUE</span>
        <span class="k">if</span> <span class="n">allowed</span><span class="p">:</span>

            <span class="c1"># Create a tuple to go into the heapq</span>
            <span class="c1"># (NB. the sorting is done ascending and by the order of the items in the tuple)</span>
            <span class="c1"># Pos 0: priority,</span>
            <span class="c1"># Pos 1: topen,</span>
            <span class="c1"># Pos 2: hsi_event_queue_counter,</span>
            <span class="c1"># Pos 3: tclose,</span>
            <span class="c1"># Pos 4: the hsi_event itself</span>

            <span class="n">new_request</span> <span class="o">=</span> <span class="n">HSIEventQueueItem</span><span class="p">(</span>
                <span class="n">priority</span><span class="p">,</span> <span class="n">topen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsi_event_queue_counter</span><span class="p">,</span> <span class="n">tclose</span><span class="p">,</span> <span class="n">hsi_event</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hsi_event_queue_counter</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">hp</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HSI_EVENT_QUEUE</span><span class="p">,</span> <span class="n">new_request</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="n">key</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;HealthSystem.schedule_event &gt;&gt; &quot;</span>
                     <span class="sa">f</span><span class="s2">&quot;HSI has been added to the queue: </span><span class="si">{</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">TREATMENT_ID</span><span class="si">}</span><span class="s2"> for person: </span><span class="si">{</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># HSI is not available under the services_available parameter: call the hsi&#39;s not_available() method if it</span>
            <span class="c1"># exists:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">hsi_event</span><span class="o">.</span><span class="n">not_available</span><span class="p">()</span>
                <span class="c1"># TODO: should the healthsystem call this at the time that the HSI was intended to be run (i.e topen)?</span>

            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="n">key</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;A request was made for a service but it was not included in the service_availability list:&quot;</span>
                     <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">TREATMENT_ID</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem.schedule_batch_of_individual_hsi_events"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.schedule_batch_of_individual_hsi_events">[docs]</a>    <span class="k">def</span> <span class="nf">schedule_batch_of_individual_hsi_events</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">hsi_event_class</span><span class="p">,</span> <span class="n">person_ids</span><span class="p">,</span> <span class="n">priority</span><span class="p">,</span> <span class="n">topen</span><span class="p">,</span> <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">event_kwargs</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Schedule a batch of individual-scoped HSI events of the same type.</span>

<span class="sd">        Only performs sanity checks on the HSI event for the first scheduled event</span>
<span class="sd">        thus removing the overhead of multiple redundant checks.</span>

<span class="sd">        :param hsi_event_class: The ``HSI_Event`` subclass of the events to schedule.</span>
<span class="sd">        :param person_ids: A sequence of person ID index values to use as the targets</span>
<span class="sd">            of the HSI events being scheduled.</span>
<span class="sd">        :param priority: The priority for the HSI events: 0 (highest), 1 or 2 (lowest).</span>
<span class="sd">            Either a single value for all events or an iterable of per-target values.</span>
<span class="sd">        :param topen: The earliest date at which the HSI events should run. Either a</span>
<span class="sd">            single value for all events or an iterable of per-target values.</span>
<span class="sd">        :param tclose: The latest date at which the HSI events should run. Set to one</span>
<span class="sd">           week after ``topen`` if ``None``. Either a single value for all events or an</span>
<span class="sd">           iterable of per-target values.</span>
<span class="sd">        :param event_kwargs: Any additional keyword arguments to pass to the</span>
<span class="sd">            ``hsi_event_class`` initialiser in addition to ``person_id``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If any of {priority, topen, tclose} are iterable assume correspond to per-</span>
        <span class="c1"># target values for corresponding arguments of schedule_hsi_event otherwise</span>
        <span class="c1"># use same value for all calls</span>
        <span class="n">priorities</span> <span class="o">=</span> <span class="n">priority</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">priority</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="k">else</span> <span class="n">repeat</span><span class="p">(</span><span class="n">priority</span><span class="p">)</span>
        <span class="n">topens</span> <span class="o">=</span> <span class="n">topen</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">topen</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="k">else</span> <span class="n">repeat</span><span class="p">(</span><span class="n">topen</span><span class="p">)</span>
        <span class="n">tcloses</span> <span class="o">=</span> <span class="n">tclose</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tclose</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="k">else</span> <span class="n">repeat</span><span class="p">(</span><span class="n">tclose</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">person_id</span><span class="p">,</span> <span class="n">priority</span><span class="p">,</span> <span class="n">topen</span><span class="p">,</span> <span class="n">tclose</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">person_ids</span><span class="p">,</span> <span class="n">priorities</span><span class="p">,</span> <span class="n">topens</span><span class="p">,</span> <span class="n">tcloses</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">hsi_event</span><span class="o">=</span><span class="n">hsi_event_class</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="o">**</span><span class="n">event_kwargs</span><span class="p">),</span>
                <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span>
                <span class="n">topen</span><span class="o">=</span><span class="n">topen</span><span class="p">,</span>
                <span class="n">tclose</span><span class="o">=</span><span class="n">tclose</span><span class="p">,</span>
                <span class="c1"># Only perform checks for first event</span>
                <span class="n">do_hsi_event_checks</span><span class="o">=</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem.appt_footprint_is_valid"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.appt_footprint_is_valid">[docs]</a>    <span class="k">def</span> <span class="nf">appt_footprint_is_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">appt_footprint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks an appointment footprint to ensure it is in the correct format.</span>
<span class="sd">        :param appt_footprint: Appointment footprint to check.</span>
<span class="sd">        :return: True if valid and False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check that all keys known appointment types and all values non-negative</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">appt_footprint</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span>
            <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_appointment_types</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">appt_footprint</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem.broadcast_healthsystem_interaction"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.broadcast_healthsystem_interaction">[docs]</a>    <span class="k">def</span> <span class="nf">broadcast_healthsystem_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hsi_event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This will alert disease modules than a treatment_id is occurring to a particular person.</span>
<span class="sd">        :param hsi_event: the health system interaction event</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">hsi_event</span><span class="o">.</span><span class="n">ALERT_OTHER_DISEASES</span><span class="p">:</span>  <span class="c1"># it&#39;s an empty list</span>
            <span class="c1"># There are no disease modules to alert, so do nothing</span>
            <span class="k">pass</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Alert some disease modules</span>

            <span class="k">if</span> <span class="n">hsi_event</span><span class="o">.</span><span class="n">ALERT_OTHER_DISEASES</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
                <span class="n">alert_modules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recognised_modules_names</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">alert_modules</span> <span class="o">=</span> <span class="n">hsi_event</span><span class="o">.</span><span class="n">ALERT_OTHER_DISEASES</span>

            <span class="c1"># Alert each of the modules</span>
            <span class="k">for</span> <span class="n">module_name</span> <span class="ow">in</span> <span class="n">alert_modules</span><span class="p">:</span>
                <span class="c1"># Don&#39;t notify originating module</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">hsi_event</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">module_name</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module_name</span><span class="p">]</span><span class="o">.</span><span class="n">on_hsi_alert</span><span class="p">(</span>
                        <span class="n">person_id</span><span class="o">=</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">treatment_id</span><span class="o">=</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">TREATMENT_ID</span>
                    <span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem.reformat_daily_capabilities"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.reformat_daily_capabilities">[docs]</a>    <span class="k">def</span> <span class="nf">reformat_daily_capabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This will updates the dataframe for the self.parameters[&#39;Daily_Capabilities&#39;] so as to include</span>
<span class="sd">        every permutation of officer_type_code and facility_id, with zeros against permuations where no capacity</span>
<span class="sd">        is available.</span>

<span class="sd">        It also give the dataframe an index that is useful for merging on (based on Facility_ID and Officer Type)</span>

<span class="sd">        (This is so that its easier to track where demands are being placed where there is no capacity)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get the capabilities data as they are imported</span>
        <span class="n">capabilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Daily_Capabilities&#39;</span><span class="p">]</span>

        <span class="c1"># Create dataframe containing background information about facility and officer types</span>
        <span class="n">facility_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Master_Facilities_List&#39;</span><span class="p">][</span><span class="s1">&#39;Facility_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">officer_type_codes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Officer_Types_Table&#39;</span><span class="p">][</span><span class="s1">&#39;Officer_Type_Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="n">facs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">officers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">facility_ids</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">officer_type_codes</span><span class="p">:</span>
                <span class="n">facs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">officers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>

        <span class="n">capabilities_ex</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Facility_ID&#39;</span><span class="p">:</span> <span class="n">facs</span><span class="p">,</span> <span class="s1">&#39;Officer_Type_Code&#39;</span><span class="p">:</span> <span class="n">officers</span><span class="p">})</span>

        <span class="c1"># Merge in information about facility from Master Facilities List</span>
        <span class="n">mfl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Master_Facilities_List&#39;</span><span class="p">]</span>
        <span class="n">capabilities_ex</span> <span class="o">=</span> <span class="n">capabilities_ex</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">mfl</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;Facility_ID&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>

        <span class="c1"># Merge in information about officers</span>
        <span class="n">officer_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Officer_Types_Table&#39;</span><span class="p">][[</span><span class="s1">&#39;Officer_Type_Code&#39;</span><span class="p">,</span> <span class="s1">&#39;Officer_Type&#39;</span><span class="p">]]</span>
        <span class="n">capabilities_ex</span> <span class="o">=</span> <span class="n">capabilities_ex</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">officer_types</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;Officer_Type_Code&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>

        <span class="c1"># Merge in the capabilities (minutes available) for each officer type (inferring zero minutes where</span>
        <span class="c1"># there is no entry in the imported capabilities table)</span>
        <span class="n">capabilities_ex</span> <span class="o">=</span> <span class="n">capabilities_ex</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">capabilities</span><span class="p">[[</span><span class="s1">&#39;Facility_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;Officer_Type_Code&#39;</span><span class="p">,</span> <span class="s1">&#39;Total_Minutes_Per_Day&#39;</span><span class="p">]],</span>
            <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Facility_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;Officer_Type_Code&#39;</span><span class="p">],</span>
            <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">capabilities_ex</span> <span class="o">=</span> <span class="n">capabilities_ex</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Give the standard index:</span>
        <span class="n">capabilities_ex</span> <span class="o">=</span> <span class="n">capabilities_ex</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span>
            <span class="s1">&#39;FacilityID_&#39;</span>
            <span class="o">+</span> <span class="n">capabilities_ex</span><span class="p">[</span><span class="s1">&#39;Facility_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="o">+</span> <span class="s1">&#39;_Officer_&#39;</span>
            <span class="o">+</span> <span class="n">capabilities_ex</span><span class="p">[</span><span class="s1">&#39;Officer_Type_Code&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Checks</span>
        <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">capabilities_ex</span><span class="p">[</span><span class="s1">&#39;Total_Minutes_Per_Day&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="n">capabilities</span><span class="p">[</span><span class="s1">&#39;Total_Minutes_Per_Day&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mf">1e-7</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">capabilities_ex</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">facility_ids</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">officer_type_codes</span><span class="p">)</span>

        <span class="c1"># Updates the capabilities table with the reformatted version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Daily_Capabilities&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">capabilities_ex</span></div>

<div class="viewcode-block" id="HealthSystem.get_capabilities_today"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.get_capabilities_today">[docs]</a>    <span class="k">def</span> <span class="nf">get_capabilities_today</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the capabilities of the health system today.</span>
<span class="sd">        returns: Series giving minutes available for each officer type in each facility type</span>

<span class="sd">        Functions can go in here in the future that could expand the time available,</span>
<span class="sd">        simulating increasing efficiency (the concept of a productivitiy ratio raised</span>
<span class="sd">        by Martin Chalkley).</span>

<span class="sd">        For now this method only scales by the static `capabilities_coefficient` scale</span>
<span class="sd">        factor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Daily_Capabilities&#39;</span><span class="p">][</span><span class="s1">&#39;Total_Minutes_Per_Day&#39;</span><span class="p">]</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">capabilities_coefficient</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem.get_blank_appt_footprint"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.get_blank_appt_footprint">[docs]</a>    <span class="k">def</span> <span class="nf">get_blank_appt_footprint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a helper function so that disease modules can easily create their appt_footprints.</span>
<span class="sd">        It returns an empty Counter instance.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Counter</span><span class="p">()</span></div>

<div class="viewcode-block" id="HealthSystem.get_blank_cons_footprint"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.get_blank_cons_footprint">[docs]</a>    <span class="k">def</span> <span class="nf">get_blank_cons_footprint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a helper function so that disease modules can easily create their cons_footprints.</span>
<span class="sd">        It returns a dictionary containing the consumables information in the format that the /</span>
<span class="sd">        HealthSystemScheduler expects.</span>

<span class="sd">        Format is as follows:</span>
<span class="sd">            * dict with two keys; Intervention_Package_Code and Item_Code</span>
<span class="sd">            * the value for each is a dict of the form (package_code or item_code): quantity</span>
<span class="sd">            * the codes within each list must be unique and valid codes; quantities must be integer values &gt;0</span>

<span class="sd">            e.g.</span>
<span class="sd">            cons_req_as_footprint = {</span>
<span class="sd">                        &#39;Intervention_Package_Code&#39;: {my_pkg_code: 1},</span>
<span class="sd">                        &#39;Item_Code&#39;: {my_item_code: 10, another_item_code: 1}</span>
<span class="sd">            }</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">blank_footprint</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Intervention_Package_Code&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;Item_Code&#39;</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="k">return</span> <span class="n">blank_footprint</span></div>

<div class="viewcode-block" id="HealthSystem.get_prob_seek_care"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.get_prob_seek_care">[docs]</a>    <span class="k">def</span> <span class="nf">get_prob_seek_care</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">symptom_code</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is depracted. Report onset of generic acute symptoms to the symptom mananger.</span>
<span class="sd">        HealthSeekingBehaviour module will schedule a generic hsi.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Do not use get_prob_seek_care().&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem.get_facility_info"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.get_facility_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_facility_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hsi_event</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FacilityInfo</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Helper function to find the facility at which an HSI event will take place&quot;&quot;&quot;</span>
        <span class="c1"># Gather information about the HSI event</span>
        <span class="n">the_district</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">at</span><span class="p">[</span>
            <span class="n">hsi_event</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="s1">&#39;district_of_residence&#39;</span><span class="p">]</span>
        <span class="n">the_level</span> <span class="o">=</span> <span class="n">hsi_event</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span>

        <span class="c1"># Return the (one) health_facility available to this person (based on their</span>
        <span class="c1"># district), which is accepted by the hsi_event.ACCEPTED_FACILITY_LEVEL</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;Facilities_For_Each_District&quot;</span><span class="p">][</span><span class="n">the_level</span><span class="p">][</span><span class="n">the_district</span><span class="p">]</span></div>

<div class="viewcode-block" id="HealthSystem.get_appt_footprint_as_time_request"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.get_appt_footprint_as_time_request">[docs]</a>    <span class="k">def</span> <span class="nf">get_appt_footprint_as_time_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hsi_event</span><span class="p">,</span> <span class="n">actual_appt_footprint</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This will take an HSI event and return the required appointments in terms of the</span>
<span class="sd">        time required of each Officer Type in each Facility ID.</span>
<span class="sd">        The index will identify the Facility ID and the Officer Type in the same format</span>
<span class="sd">        as is used in Daily_Capabilities.</span>

<span class="sd">        :param hsi_event: The HSI event</span>
<span class="sd">        :param actual_appt_footprint: The actual appt footprint (optional) if different</span>
<span class="sd">            to that in the HSI event.</span>
<span class="sd">        :return: A Counter that gives the times required for each officer-type in each</span>
<span class="sd">            facility_ID, where this time is non-zero.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If specified use actual_appt_footprint otherwise use EXPECTED_APPT_FOOTPRINT</span>
        <span class="n">the_appt_footprint</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">hsi_event</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span> <span class="k">if</span> <span class="n">actual_appt_footprint</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span>
            <span class="n">actual_appt_footprint</span>
        <span class="p">)</span>
        <span class="c1"># Check in time request cache in event if a time request corresponding to the</span>
        <span class="c1"># current relevant event attributes and appointment footprint has previously</span>
        <span class="c1"># been stored, and if so return this</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">hsi_event</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
            <span class="n">hsi_event</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span><span class="p">,</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="n">the_appt_footprint</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">cached_time_request</span> <span class="o">=</span> <span class="n">hsi_event</span><span class="o">.</span><span class="n">_cached_time_requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached_time_request</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cached_time_request</span>

        <span class="c1"># No entry in cache so compute time request</span>

        <span class="c1"># Appointment times for each facility and officer combination</span>
        <span class="n">appt_times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Appt_Time_Table&#39;</span><span class="p">]</span>

        <span class="c1"># Facility level required by this event</span>
        <span class="n">the_facility_level</span> <span class="o">=</span> <span class="n">hsi_event</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span>

        <span class="c1"># Get the (one) health_facility available to this person (based on their</span>
        <span class="c1"># district), which is accepted by the hsi_event.ACCEPTED_FACILITY_LEVEL:</span>
        <span class="n">the_facility</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_facility_info</span><span class="p">(</span><span class="n">hsi_event</span><span class="p">)</span>

        <span class="c1"># Accumulate appointment times for specified footprint using times from</span>
        <span class="c1"># appointment times table</span>
        <span class="n">appt_footprint_times</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">appt_type</span> <span class="ow">in</span> <span class="n">the_appt_footprint</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">appt_info_list</span> <span class="o">=</span> <span class="n">appt_times</span><span class="p">[</span><span class="n">the_facility_level</span><span class="p">][</span><span class="n">appt_type</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The time needed for this appointment is not defined for this &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;specified facility level in the Appt_Time_Table. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Event treatment ID: </span><span class="si">{</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">TREATMENT_ID</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
            <span class="k">for</span> <span class="n">appt_info</span> <span class="ow">in</span> <span class="n">appt_info_list</span><span class="p">:</span>
                <span class="n">appt_footprint_times</span><span class="p">[</span>
                    <span class="sa">f</span><span class="s2">&quot;FacilityID_</span><span class="si">{</span><span class="n">the_facility</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">_Officer_</span><span class="si">{</span><span class="n">appt_info</span><span class="o">.</span><span class="n">officer_type</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">]</span> <span class="o">+=</span> <span class="n">appt_info</span><span class="o">.</span><span class="n">time_taken</span>

        <span class="c1"># Cache the time request to avoid having to recompute on subsequent calls</span>
        <span class="n">hsi_event</span><span class="o">.</span><span class="n">_cached_time_requests</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">appt_footprint_times</span>

        <span class="k">return</span> <span class="n">appt_footprint_times</span></div>

<div class="viewcode-block" id="HealthSystem.get_squeeze_factors"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.get_squeeze_factors">[docs]</a>    <span class="k">def</span> <span class="nf">get_squeeze_factors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">footprints_per_event</span><span class="p">,</span> <span class="n">total_footprint</span><span class="p">,</span> <span class="n">current_capabilities</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This will compute the squeeze factors for each HSI event from the list of all</span>
<span class="sd">        the calls on health system resources for the day.</span>
<span class="sd">        The squeeze factor is defined as (call/available - 1). ie. the highest</span>
<span class="sd">        fractional over-demand among any type of officer that is called-for in the</span>
<span class="sd">        appt_footprint of an HSI event.</span>
<span class="sd">        A value of 0.0 signifies that there is no squeezing (sufficient resources for</span>
<span class="sd">        the EXPECTED_APPT_FOOTPRINT).</span>
<span class="sd">        A value of 99.99 signifies that the call is for an officer_type in a</span>
<span class="sd">        health-facility that is not available.</span>

<span class="sd">        :param footprints_per_event: List, one entry per HSI event, containing the</span>
<span class="sd">            minutes required from each health officer in each health facility as a</span>
<span class="sd">            Counter (using the standard index)</span>
<span class="sd">        :param total_footprint: Counter, containing the total minutes required from</span>
<span class="sd">            each health officer in each health facility when non-zero, (using the</span>
<span class="sd">            standard index)</span>
<span class="sd">        :param current_capabilities: Series giving the amount of time available for</span>
<span class="sd">            each health officer in each health facility (using the standard index)</span>

<span class="sd">        :return: squeeze_factors: an array of the squeeze factors for each HSI event</span>
<span class="sd">            (position in array matches that in the all_call_today list).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># 1) Compute the load factors for each officer type at each facility that is</span>
        <span class="c1"># called-upon in this list of HSIs</span>
        <span class="n">load_factor</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">officer</span><span class="p">,</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">total_footprint</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">availability</span> <span class="o">=</span> <span class="n">current_capabilities</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">officer</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">availability</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">load_factor</span><span class="p">[</span><span class="n">officer</span><span class="p">]</span> <span class="o">=</span> <span class="mf">99.99</span>
            <span class="k">elif</span> <span class="n">availability</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">load_factor</span><span class="p">[</span><span class="n">officer</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">load_factor</span><span class="p">[</span><span class="n">officer</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">call</span> <span class="o">/</span> <span class="n">availability</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># 5) Convert these load-factors into an overall &#39;squeeze&#39; signal for each HSI,</span>
        <span class="c1"># based on the highest load-factor of any officer required (or zero if event</span>
        <span class="c1"># has an empty footprint)</span>
        <span class="n">squeeze_factor_per_hsi_event</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="nb">max</span><span class="p">((</span><span class="n">load_factor</span><span class="p">[</span><span class="n">officer</span><span class="p">]</span> <span class="k">for</span> <span class="n">officer</span> <span class="ow">in</span> <span class="n">footprint</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">footprint</span> <span class="ow">in</span> <span class="n">footprints_per_event</span>
        <span class="p">])</span>

        <span class="k">assert</span> <span class="p">(</span><span class="n">squeeze_factor_per_hsi_event</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">squeeze_factor_per_hsi_event</span></div>

<div class="viewcode-block" id="HealthSystem.request_consumables"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.request_consumables">[docs]</a>    <span class="k">def</span> <span class="nf">request_consumables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hsi_event</span><span class="p">,</span> <span class="n">cons_req_as_footprint</span><span class="p">,</span> <span class="n">to_log</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is where HSI events can check access to and log use of consumables.</span>
<span class="sd">        The healthsystem module will check if that consumable is available</span>
<span class="sd">        at this time and at that facility and return a True/False response. If a package is requested, it is considered</span>
<span class="sd">        to be available only if all of the constituent items are available.</span>
<span class="sd">        All requests are logged and, by default, it is assumed that if a requested consumable is available then it</span>
<span class="sd">        is used. Alternatively, HSI Events can just query if a</span>
<span class="sd">        consumable is available (without using it) by setting to_log=False.</span>

<span class="sd">        :param cons_req: The consumable that is requested, in the format specified in &#39;get_blank_cons_footprint()&#39;</span>
<span class="sd">        :param to_log: Indicator to show whether this should not be logged (defualt: True)</span>
<span class="sd">        :return: In the same format of the provided footprint, giving a bool for each package or item returned</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Could check the format of the cons_req_as_footprint</span>
        <span class="c1"># It is removed as this is a time-consuming check that is rarely required</span>
        <span class="c1"># self.check_consumables_footprint_format(cons_req_as_footprint)</span>

        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># If the healthsystem module is disabled, return True for all consumables without checking or logging</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;Intervention_Package_Code&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
                    <span class="n">cons_req_as_footprint</span><span class="p">[</span><span class="s1">&#39;Intervention_Package_Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                    <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">cons_req_as_footprint</span><span class="p">[</span><span class="s1">&#39;Intervention_Package_Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                                 <span class="p">))),</span>
                <span class="s1">&#39;Item_Code&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
                    <span class="n">cons_req_as_footprint</span><span class="p">[</span><span class="s1">&#39;Item_Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                    <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">cons_req_as_footprint</span><span class="p">[</span><span class="s1">&#39;Item_Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                                 <span class="p">)))</span>
                <span class="p">}</span>

        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Determine availability of each item and package:</span>
        <span class="n">select_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Available_Facility_Level_</span><span class="si">{</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">available</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Intervention_Package_Code&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons_available_today</span><span class="p">[</span><span class="s1">&#39;Intervention_Package_Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">cons_req_as_footprint</span><span class="p">[</span><span class="s1">&#39;Intervention_Package_Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">select_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
            <span class="s1">&#39;Item_Code&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons_available_today</span><span class="p">[</span><span class="s1">&#39;Item_Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">cons_req_as_footprint</span><span class="p">[</span><span class="s1">&#39;Item_Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">select_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

        <span class="c1"># Logging:</span>
        <span class="k">if</span> <span class="n">to_log</span><span class="p">:</span>
            <span class="n">treatment_id</span> <span class="o">=</span> <span class="n">hsi_event</span><span class="o">.</span><span class="n">TREATMENT_ID</span>
            <span class="c1"># NB. Casting the data to strings because logger complains with dict of varying sizes/keys</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;Consumables&#39;</span><span class="p">,</span>
                        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                            <span class="s1">&#39;TREATMENT_ID&#39;</span><span class="p">:</span> <span class="n">treatment_id</span><span class="p">,</span>
                            <span class="s1">&#39;Item_Available&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cons_req_as_footprint</span><span class="p">[</span><span class="s1">&#39;Item_Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                                   <span class="k">if</span> <span class="n">available</span><span class="p">[</span><span class="s1">&#39;Item_Code&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]}</span>
                                                  <span class="p">),</span>
                            <span class="s1">&#39;Item_NotAvailable&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cons_req_as_footprint</span><span class="p">[</span><span class="s1">&#39;Item_Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                                      <span class="k">if</span> <span class="ow">not</span> <span class="n">available</span><span class="p">[</span><span class="s1">&#39;Item_Code&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]}</span>
                                                     <span class="p">),</span>
                            <span class="s1">&#39;Package_Available&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span>
                                                      <span class="n">cons_req_as_footprint</span><span class="p">[</span><span class="s1">&#39;Intervention_Package_Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                                      <span class="k">if</span> <span class="n">available</span><span class="p">[</span><span class="s1">&#39;Intervention_Package_Code&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]}</span>
                                                     <span class="p">),</span>
                            <span class="s1">&#39;Package_NotAvailable&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span>
                                                         <span class="n">cons_req_as_footprint</span><span class="p">[</span><span class="s1">&#39;Intervention_Package_Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                                         <span class="k">if</span> <span class="ow">not</span> <span class="n">available</span><span class="p">[</span><span class="s1">&#39;Intervention_Package_Code&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]}</span>
                                                        <span class="p">)</span>
                        <span class="p">},</span>
                        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;record of each consumable item that is requested by in an HSI&quot;</span>
                        <span class="p">)</span>

        <span class="c1"># return the result of the check on availability</span>
        <span class="k">return</span> <span class="n">available</span></div>

<div class="viewcode-block" id="HealthSystem.check_consumables_footprint_format"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.check_consumables_footprint_format">[docs]</a>    <span class="k">def</span> <span class="nf">check_consumables_footprint_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cons_req_as_footprint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function runs some check on the cons_req_as_footprint to ensure its in the right format</span>
<span class="sd">        :param cons_req_as_footprint:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Format is as follows:</span>
        <span class="c1">#     * dict with two keys; Intervention_Package_Code and Item_Code</span>
        <span class="c1">#     * For each, there is list of dicts, each dict giving code (i.e. package_code or item_code):quantity</span>
        <span class="c1">#     * the codes within each list must be unique and valid codes, quantities must be integer values &gt;0</span>
        <span class="c1">#     e.g.</span>
        <span class="c1">#     cons_req_as_footprint = {</span>
        <span class="c1">#                 &#39;Intervention_Package_Code&#39;: {my_pkg_code: 1},</span>
        <span class="c1">#                 &#39;Item_Code&#39;: {my_item_code: 10}, {another_item_code: 1}</span>
        <span class="c1">#     }</span>

        <span class="c1"># check basic formatting</span>
        <span class="n">format_error_str</span> <span class="o">=</span> <span class="s1">&#39;The consumable_footprint is not in the right format. &#39;</span> \
                           <span class="s1">&#39;See check_consumables_footprint_format.&#39;</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">cons_req_as_footprint</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span>
        <span class="k">assert</span> <span class="s1">&#39;Intervention_Package_Code&#39;</span> <span class="ow">in</span> <span class="n">cons_req_as_footprint</span><span class="p">,</span> <span class="n">format_error_str</span>
        <span class="k">assert</span> <span class="s1">&#39;Item_Code&#39;</span> <span class="ow">in</span> <span class="n">cons_req_as_footprint</span><span class="p">,</span> <span class="n">format_error_str</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">cons_req_as_footprint</span><span class="p">[</span><span class="s1">&#39;Intervention_Package_Code&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">format_error_str</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">cons_req_as_footprint</span><span class="p">[</span><span class="s1">&#39;Item_Code&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">format_error_str</span>

        <span class="c1"># Check that consumables being required are in the database</span>

        <span class="c1"># Check packages</span>
        <span class="n">all_pkgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_mapping_pkg_code_to_intv_code</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
        <span class="k">for</span> <span class="n">pkg_code</span><span class="p">,</span> <span class="n">pkg_quant</span> <span class="ow">in</span> <span class="n">cons_req_as_footprint</span><span class="p">[</span><span class="s1">&#39;Intervention_Package_Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">assert</span> <span class="n">pkg_code</span> <span class="ow">in</span> <span class="n">all_pkgs</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Intervention_Package_Code </span><span class="si">{</span><span class="n">pkg_code</span><span class="si">}</span><span class="s1"> not recognised&#39;</span>
            <span class="k">assert</span> <span class="n">pkg_code</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">99</span><span class="p">,</span> <span class="s1">&#39;Intervention_Package_Code cannot be -99&#39;</span>
            <span class="k">assert</span> <span class="n">pkg_quant</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">format_error_str</span>

        <span class="c1"># Check items</span>
        <span class="n">all_items</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_mapping_pkg_code_to_intv_code</span><span class="p">[</span><span class="s1">&#39;Item_Code&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">itm_code</span><span class="p">,</span> <span class="n">itm_quant</span> <span class="ow">in</span> <span class="n">cons_req_as_footprint</span><span class="p">[</span><span class="s1">&#39;Item_Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">assert</span> <span class="n">itm_code</span> <span class="ow">in</span> <span class="n">all_items</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Item_Code </span><span class="si">{</span><span class="n">itm_code</span><span class="si">}</span><span class="s1"> not recognised&#39;</span>
            <span class="k">assert</span> <span class="n">itm_quant</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">format_error_str</span></div>

<div class="viewcode-block" id="HealthSystem.get_consumables_as_individual_items"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.get_consumables_as_individual_items">[docs]</a>    <span class="k">def</span> <span class="nf">get_consumables_as_individual_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cons_req_as_footprint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to decompose a ```cons_req_as_footprint``` and return a pd.Series with the individual items</span>
<span class="sd">        (as the index) and the quantity needed (as the value).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Unpack package_code (repeat package code if the package is required multiple times)</span>
        <span class="n">pkgs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cons_req_as_footprint</span><span class="p">[</span><span class="s1">&#39;Intervention_Package_Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                <span class="n">pkgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="c1"># Get the corresponding item codes and flip in to a series with index of Item_Code</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_mapping_pkg_code_to_intv_code</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pkgs</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Item_Code&#39;</span><span class="p">)[</span><span class="s1">&#39;Expected_Units_Per_Case&#39;</span><span class="p">]</span>

        <span class="c1"># Add in individual consumables in one go as a pd.Series</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">cons_req_as_footprint</span><span class="p">[</span><span class="s1">&#39;Item_Code&#39;</span><span class="p">]))</span>

        <span class="c1"># Return de-duplicated Series (index=Item_Code, value=quantity)</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>

<div class="viewcode-block" id="HealthSystem.determine_availability_of_consumables_today"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.determine_availability_of_consumables_today">[docs]</a>    <span class="k">def</span> <span class="nf">determine_availability_of_consumables_today</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper function to determine availability of all items and packages&quot;&quot;&quot;</span>

        <span class="c1"># Determine the availability of the consumables *items* today</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_cons_constraints</span><span class="p">:</span>
            <span class="c1"># Random draws: assume that availability of the same item is independent between different facility levels</span>
            <span class="n">random_draws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prob_item_codes_available</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prob_item_codes_available</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prob_item_codes_available</span> <span class="o">&gt;</span> <span class="n">random_draws</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Make all true if ignoring consumables constraints</span>
            <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prob_item_codes_available</span> <span class="o">&gt;</span> <span class="mf">0.0</span>

        <span class="c1"># Determine the availability of packages today</span>
        <span class="c1"># (packages are made-up of the individual items: if one item is not available, the package is not available)</span>
        <span class="n">pkgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_mapping_pkg_code_to_intv_code</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;Item_Code&#39;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pkgs</span> <span class="o">=</span> <span class="n">pkgs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">pkgs</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">pkgs</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Available_Facility_Level&#39;</span><span class="p">)]]</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cons_available_today</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Item_Code&quot;</span><span class="p">:</span> <span class="n">items</span><span class="p">,</span>
            <span class="s2">&quot;Intervention_Package_Code&quot;</span><span class="p">:</span> <span class="n">pkgs</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="HealthSystem.log_hsi_event"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.log_hsi_event">[docs]</a>    <span class="k">def</span> <span class="nf">log_hsi_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hsi_event</span><span class="p">,</span> <span class="n">actual_appt_footprint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">squeeze_factor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">did_run</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This will write to the log with a record that this HSI event has occured.</span>
<span class="sd">        If this is an individual-level HSI event, it will also record the actual appointment footprint</span>
<span class="sd">        :param hsi_event: The hsi event (containing the initial expectations of footprints)</span>
<span class="sd">        :param actual_appt_footprint: The actual appt footprint to log (if individual event)</span>
<span class="sd">        :param squeeze_factor: The squueze factor (if individual event)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">tlo</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">Population</span><span class="p">):</span>
            <span class="c1"># Population HSI-Event</span>
            <span class="n">log_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;TREATMENT_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hsi_event</span><span class="o">.</span><span class="n">TREATMENT_ID</span>
            <span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Number_By_Appt_Type_Code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Population&#39;</span>  <span class="c1"># remove the appt-types with zeros</span>
            <span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Person_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># Junk code</span>
            <span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Squeeze_Factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Individual HSI-Event:</span>
            <span class="k">assert</span> <span class="n">actual_appt_footprint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="n">squeeze_factor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

            <span class="n">log_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;TREATMENT_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hsi_event</span><span class="o">.</span><span class="n">TREATMENT_ID</span>
            <span class="c1"># key appointment types that are non-zero</span>
            <span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Number_By_Appt_Type_Code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">actual_appt_footprint</span>
            <span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Person_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hsi_event</span><span class="o">.</span><span class="n">target</span>

            <span class="k">if</span> <span class="n">squeeze_factor</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
                <span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Squeeze_Factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">100.0</span>  <span class="c1"># arbitrarily high value to replace infinity</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;Squeeze_Factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">squeeze_factor</span>

        <span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;did_run&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">did_run</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;HSI_Event&quot;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">log_info</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;record of each HSI event&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_hsi_events_that_have_run</span><span class="p">:</span>
            <span class="n">log_info</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store_of_hsi_events_that_have_run</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_info</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_hsi_event_details</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hsi_event_details</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="n">HSIEventDetails</span><span class="p">(</span>
                    <span class="n">event_name</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">hsi_event</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                    <span class="n">module_name</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">module</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                    <span class="n">treatment_id</span><span class="o">=</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">TREATMENT_ID</span><span class="p">,</span>
                    <span class="n">facility_level</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span>
                        <span class="n">hsi_event</span><span class="p">,</span> <span class="s1">&#39;ACCEPTED_FACILITY_LEVEL&#39;</span><span class="p">,</span> <span class="kc">None</span>
                    <span class="p">),</span>
                    <span class="n">appt_footprint</span><span class="o">=</span><span class="p">(</span>
                        <span class="nb">tuple</span><span class="p">(</span><span class="n">actual_appt_footprint</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">actual_appt_footprint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="k">else</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">hsi_event</span><span class="p">,</span> <span class="s1">&#39;EXPECTED_APPT_FOOTPRINT&#39;</span><span class="p">,</span> <span class="p">{}))</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem.log_current_capabilities"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.log_current_capabilities">[docs]</a>    <span class="k">def</span> <span class="nf">log_current_capabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_capabilities</span><span class="p">,</span> <span class="n">total_footprint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This will log the percentage of the current capabilities that is used at each Facility Type</span>
<span class="sd">        NB. To get this per Officer_Type_Code, it would be possible to simply log the entire current_capabilities df.</span>
<span class="sd">        :param current_capabilities: the current_capabilities of the health system.</span>
<span class="sd">        :param total_footprint: Per-officer totals of footprints of all the HSI events that ran</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Combine the current_capabiliites and total_footprint per-officer totals</span>
        <span class="n">total_calls_per_officer</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">total_footprint</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
        <span class="n">comparison</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Daily_Capabilities&#39;</span><span class="p">][[</span><span class="s1">&#39;Facility_ID&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;Total_Minutes_Per_Day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_capabilities</span>
        <span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;Minutes_Used&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_calls_per_officer</span>
        <span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;Minutes_Used&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">total_calls</span> <span class="o">=</span> <span class="n">total_calls_per_officer</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">comparison</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_capabilities</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;Minutes_Used&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">total_calls</span><span class="p">)</span>

        <span class="c1"># Sum within each Facility_ID using groupby (Index of &#39;summary&#39; is Facility_ID)</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="n">comparison</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Facility_ID&#39;</span><span class="p">)[[</span><span class="s1">&#39;Total_Minutes_Per_Day&#39;</span><span class="p">,</span> <span class="s1">&#39;Minutes_Used&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Compute Fraction of Time Used Across All Facilities</span>
        <span class="n">total_available</span> <span class="o">=</span> <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;Total_Minutes_Per_Day&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">fraction_time_used_across_all_facilities</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">total_calls</span> <span class="o">/</span> <span class="n">total_available</span> <span class="k">if</span> <span class="n">total_available</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">else</span> <span class="mi">0</span>  <span class="c1"># no capabilities or nan arising</span>
        <span class="p">)</span>

        <span class="c1"># Compute Fraction of Time Used In Each Facility</span>
        <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;Fraction_Time_Used&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;Minutes_Used&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;Total_Minutes_Per_Day&#39;</span><span class="p">]</span>
        <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;Fraction_Time_Used&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">log_capacity</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">log_capacity</span><span class="p">[</span><span class="s1">&#39;Frac_Time_Used_Overall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fraction_time_used_across_all_facilities</span>
        <span class="n">log_capacity</span><span class="p">[</span><span class="s1">&#39;Frac_Time_Used_By_Facility_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;Fraction_Time_Used&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;Capacity&#39;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">log_capacity</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;daily summary of utilisation and capacity of health system resources&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem.find_events_for_person"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.find_events_for_person">[docs]</a>    <span class="k">def</span> <span class="nf">find_events_for_person</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find the events in the HSI_EVENT_QUEUE for a particular person.</span>
<span class="sd">        :param person_id: the person_id of interest</span>
<span class="sd">        :returns list of tuples (date_of_event, event) for that person_id in the HSI_EVENT_QUEUE.</span>

<span class="sd">        NB. This is for debugging and testing only - not for use in real simulations as it is slow</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">list_of_events</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">ev_tuple</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">HSI_EVENT_QUEUE</span><span class="p">:</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">ev_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>   <span class="c1"># this is the &#39;topen&#39; value</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">ev_tuple</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">target</span> <span class="o">==</span> <span class="n">person_id</span><span class="p">:</span>
                    <span class="n">list_of_events</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">date</span><span class="p">,</span> <span class="n">event</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">list_of_events</span></div>

<div class="viewcode-block" id="HealthSystem.remove_beddays_footprint"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.remove_beddays_footprint">[docs]</a>    <span class="k">def</span> <span class="nf">remove_beddays_footprint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="c1"># removing bed_days from a particular individual if any</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bed_days</span><span class="o">.</span><span class="n">remove_beddays_footprint</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="HealthSystem.reset_queue"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystem.reset_queue">[docs]</a>    <span class="k">def</span> <span class="nf">reset_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the HSI event queue to be empty&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HSI_EVENT_QUEUE</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hsi_event_queue_counter</span> <span class="o">=</span> <span class="mi">0</span></div></div>


<div class="viewcode-block" id="HealthSystemScheduler"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystemScheduler">[docs]</a><span class="k">class</span> <span class="nc">HealthSystemScheduler</span><span class="p">(</span><span class="n">RegularEvent</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the HealthSystemScheduler. It is an event that occurs every day, inspects the calls on the healthsystem</span>
<span class="sd">    and commissions event to occur that are consistent with the healthsystem&#39;s capabilities for the following day, given</span>
<span class="sd">    assumptions about how this decision is made.</span>
<span class="sd">    The overall Prioritation algorithm is:</span>
<span class="sd">        * Look at events in order (the order is set by the heapq: see schedule_event</span>
<span class="sd">        * Ignore is the current data is before topen</span>
<span class="sd">        * Remove and do nothing if tclose has expired</span>
<span class="sd">        * Run any  population-level HSI events</span>
<span class="sd">        * For an individual-level HSI event, check if there are sufficient health system capabilities to run the event</span>

<span class="sd">    If the event is to be run, then the following events occur:</span>
<span class="sd">        * The HSI event itself is run.</span>
<span class="sd">        * The occurence of the event is logged</span>
<span class="sd">        * The resources used are &#39;occupied&#39; (if individual level HSI event)</span>
<span class="sd">        * Other disease modules are alerted of the occurence of the HSI event (if individual level HSI event)</span>

<span class="sd">    Here is where we can have multiple types of assumption regarding how these capabilities are modelled.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="HealthSystemScheduler.__init__"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystemScheduler.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">:</span> <span class="n">HealthSystem</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span></div>

<div class="viewcode-block" id="HealthSystemScheduler.apply"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HealthSystemScheduler.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>

        <span class="c1"># 0) Refresh information ready for new day:</span>
        <span class="c1"># - Update Bed Days trackers:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">bed_days</span><span class="o">.</span><span class="n">processing_at_start_of_new_day</span><span class="p">()</span>

        <span class="c1"># - Determine the availability of consumables today based on their probabilities</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">determine_availability_of_consumables_today</span><span class="p">()</span>

        <span class="c1"># - Create hold-over list (will become a heapq). This will hold events that cannot occur today before they are</span>
        <span class="c1">#  added back to the heapq</span>
        <span class="n">hold_over</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="c1"># 1) Get the events that are due today:</span>
        <span class="n">list_of_individual_hsi_event_tuples_due_today</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">list_of_population_hsi_event_tuples_due_today</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="c1"># To avoid repeated dataframe accesses in subsequent loop, assemble set of alive</span>
        <span class="c1"># person IDs as  one-off operation, exploiting the improved efficiency of</span>
        <span class="c1"># boolean-indexing of a Series compared to row-by-row access. From benchmarks</span>
        <span class="c1"># converting Series to list before converting to set is ~2x more performant than</span>
        <span class="c1"># direct conversion to set, while checking membership of set is ~10x quicker</span>
        <span class="c1"># than checking membership of Pandas Index object and ~25x quicker than checking</span>
        <span class="c1"># membership of list</span>
        <span class="n">alive_persons</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">is_alive</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">HSI_EVENT_QUEUE</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="n">next_event_tuple</span> <span class="o">=</span> <span class="n">hp</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">HSI_EVENT_QUEUE</span><span class="p">)</span>
            <span class="c1"># Read the tuple and assemble into a dict &#39;next_event&#39;</span>

            <span class="n">event</span> <span class="o">=</span> <span class="n">next_event_tuple</span><span class="o">.</span><span class="n">hsi_event</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;</span> <span class="n">next_event_tuple</span><span class="o">.</span><span class="n">tclose</span><span class="p">:</span>
                <span class="c1"># The event has expired (after tclose) having never been run. Call the &#39;never_ran&#39; function</span>
                <span class="n">event</span><span class="o">.</span><span class="n">never_ran</span><span class="p">()</span>

            <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span>
                <span class="nb">type</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">target</span><span class="p">)</span> <span class="ow">is</span> <span class="n">tlo</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">Population</span>
                <span class="ow">or</span> <span class="n">event</span><span class="o">.</span><span class="n">target</span> <span class="ow">in</span> <span class="n">alive_persons</span>
            <span class="p">):</span>
                <span class="c1"># if individual level event and the person who is the target is no longer alive, do nothing more</span>
                <span class="k">pass</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;</span> <span class="n">next_event_tuple</span><span class="o">.</span><span class="n">topen</span><span class="p">:</span>
                <span class="c1"># The event is not yet due (before topen), add to the hold-over list</span>
                <span class="n">hp</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">hold_over</span><span class="p">,</span> <span class="n">next_event_tuple</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">next_event_tuple</span><span class="o">.</span><span class="n">priority</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="c1"># Check the priority</span>
                    <span class="c1"># If the next event is not due and has low priority, then stop looking through the heapq</span>
                    <span class="c1"># as all other events will also not be due.</span>
                    <span class="k">break</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># The event is now due to run today and the person is confirmed to be still alive</span>
                <span class="c1"># Add it to the list of events due today (individual or population level)</span>
                <span class="c1"># NB. These list is ordered by priority and then due date</span>

                <span class="n">is_pop_level_hsi_event</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">target</span><span class="p">)</span> <span class="ow">is</span> <span class="n">tlo</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">Population</span>
                <span class="k">if</span> <span class="n">is_pop_level_hsi_event</span><span class="p">:</span>
                    <span class="n">list_of_population_hsi_event_tuples_due_today</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_event_tuple</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">list_of_individual_hsi_event_tuples_due_today</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_event_tuple</span><span class="p">)</span>

        <span class="c1"># 2) Run all population-level HSI events</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_of_population_hsi_event_tuples_due_today</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pop_level_hsi_event_tuple</span> <span class="o">=</span> <span class="n">list_of_population_hsi_event_tuples_due_today</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

            <span class="n">pop_level_hsi_event</span> <span class="o">=</span> <span class="n">pop_level_hsi_event_tuple</span><span class="o">.</span><span class="n">hsi_event</span>
            <span class="n">pop_level_hsi_event</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">squeeze_factor</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">log_hsi_event</span><span class="p">(</span><span class="n">hsi_event</span><span class="o">=</span><span class="n">pop_level_hsi_event</span><span class="p">)</span>

        <span class="c1"># 3) Get the capabilities that are available today and prepare dataframe to store all the calls for today</span>
        <span class="n">current_capabilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">get_capabilities_today</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">list_of_individual_hsi_event_tuples_due_today</span><span class="p">:</span>
            <span class="c1"># Empty counter for log_current_capabilities call below</span>
            <span class="n">total_footprint</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 4) Examine total call on health officers time from the HSI events that are due today</span>

            <span class="c1"># For all events in &#39;list_of_individual_hsi_event_tuples_due_today&#39;,</span>
            <span class="c1"># expand the appt-footprint of the event to give the demands on</span>
            <span class="c1"># each officer-type in each facility_id.</span>

            <span class="n">footprints_of_all_individual_level_hsi_event</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">get_appt_footprint_as_time_request</span><span class="p">(</span><span class="n">hsi_event</span><span class="o">=</span><span class="p">(</span><span class="n">event_tuple</span><span class="o">.</span><span class="n">hsi_event</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">event_tuple</span> <span class="ow">in</span> <span class="n">list_of_individual_hsi_event_tuples_due_today</span>
            <span class="p">]</span>

            <span class="c1"># Compute total appointment footprint across all events</span>
            <span class="n">total_footprint</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">footprint</span> <span class="ow">in</span> <span class="n">footprints_of_all_individual_level_hsi_event</span><span class="p">:</span>
                <span class="c1"># Counter.update method when called with dict-like argument adds counts</span>
                <span class="c1"># from argument to Counter object called from</span>
                <span class="n">total_footprint</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">footprint</span><span class="p">)</span>

            <span class="c1"># 5) Estimate Squeeze-Factors for today</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">mode_appt_constraints</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># For Mode 0 (no Constraints), the squeeze factors are all zero.</span>
                <span class="n">squeeze_factor_per_hsi_event</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">footprints_of_all_individual_level_hsi_event</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># For Other Modes, the squeeze factors must be computed</span>
                <span class="n">squeeze_factor_per_hsi_event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">get_squeeze_factors</span><span class="p">(</span>
                    <span class="n">footprints_per_event</span><span class="o">=</span><span class="n">footprints_of_all_individual_level_hsi_event</span><span class="p">,</span>
                    <span class="n">total_footprint</span><span class="o">=</span><span class="n">total_footprint</span><span class="p">,</span>
                    <span class="n">current_capabilities</span><span class="o">=</span><span class="n">current_capabilities</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># 6) For each event, determine if run or not, and run if so.</span>
            <span class="k">for</span> <span class="n">ev_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">list_of_individual_hsi_event_tuples_due_today</span><span class="p">)):</span>
                <span class="n">event</span> <span class="o">=</span> <span class="n">list_of_individual_hsi_event_tuples_due_today</span><span class="p">[</span><span class="n">ev_num</span><span class="p">]</span><span class="o">.</span><span class="n">hsi_event</span>
                <span class="n">squeeze_factor</span> <span class="o">=</span> <span class="n">squeeze_factor_per_hsi_event</span><span class="p">[</span><span class="n">ev_num</span><span class="p">]</span>

                <span class="n">ok_to_run</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">mode_appt_constraints</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">mode_appt_constraints</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">mode_appt_constraints</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">squeeze_factor</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">))</span>
                <span class="p">)</span>

                <span class="c1"># Mode 0: All HSI Event run, with no squeeze</span>
                <span class="c1"># Mode 1: All Run With Squeeze</span>
                <span class="c1"># Mode 2: Only if squeeze &lt;1</span>

                <span class="k">if</span> <span class="n">ok_to_run</span><span class="p">:</span>

                    <span class="c1"># Compute the fraction of the bed-days in the footprint that is available and log the usage:</span>
                    <span class="c1"># todo - this provides exactly the beddays that were requested,</span>
                    <span class="c1">#  ... but this will be where the check on availability is gated</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">_received_info_about_bed_days</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">BEDDAYS_FOOTPRINT</span>

                    <span class="c1"># Run the HSI event (allowing it to return an updated appt_footprint)</span>
                    <span class="n">actual_appt_footprint</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                        <span class="n">squeeze_factor</span><span class="o">=</span><span class="n">squeeze_factor</span>
                    <span class="p">)</span>

                    <span class="c1"># Check if the HSI event returned updated appt_footprint</span>
                    <span class="k">if</span> <span class="n">actual_appt_footprint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># The returned footprint is different to the expected footprint: so must update load factors</span>

                        <span class="c1"># check its formatting:</span>
                        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">appt_footprint_is_valid</span><span class="p">(</span><span class="n">actual_appt_footprint</span><span class="p">)</span>

                        <span class="c1"># Update load factors:</span>
                        <span class="n">updated_call</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">get_appt_footprint_as_time_request</span><span class="p">(</span>
                            <span class="n">event</span><span class="p">,</span> <span class="n">actual_appt_footprint</span><span class="p">)</span>
                        <span class="n">original_call</span> <span class="o">=</span> <span class="n">footprints_of_all_individual_level_hsi_event</span><span class="p">[</span><span class="n">ev_num</span><span class="p">]</span>
                        <span class="n">footprints_of_all_individual_level_hsi_event</span><span class="p">[</span><span class="n">ev_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">updated_call</span>
                        <span class="n">total_footprint</span> <span class="o">-=</span> <span class="n">original_call</span>
                        <span class="n">total_footprint</span> <span class="o">+=</span> <span class="n">updated_call</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">mode_appt_constraints</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="c1"># only need to recompute squeeze factors if running with constraints</span>
                            <span class="c1"># i.e. mode != 0</span>
                            <span class="n">squeeze_factor_per_hsi_event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">get_squeeze_factors</span><span class="p">(</span>
                                <span class="n">footprints_per_event</span><span class="o">=</span><span class="n">footprints_of_all_individual_level_hsi_event</span><span class="p">,</span>
                                <span class="n">total_footprint</span><span class="o">=</span><span class="n">total_footprint</span><span class="p">,</span>
                                <span class="n">current_capabilities</span><span class="o">=</span><span class="n">current_capabilities</span><span class="p">,</span>
                            <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># no actual footprint is returned so take the expected initial declaration as the actual</span>
                        <span class="n">actual_appt_footprint</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span>

                    <span class="c1"># Write to the log</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">log_hsi_event</span><span class="p">(</span>
                        <span class="n">hsi_event</span><span class="o">=</span><span class="n">event</span><span class="p">,</span>
                        <span class="n">actual_appt_footprint</span><span class="o">=</span><span class="n">actual_appt_footprint</span><span class="p">,</span>
                        <span class="n">squeeze_factor</span><span class="o">=</span><span class="n">squeeze_factor</span><span class="p">,</span>
                        <span class="n">did_run</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Do not run,</span>
                    <span class="c1"># Call did_not_run for the hsi_event</span>
                    <span class="n">rtn_from_did_not_run</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">did_not_run</span><span class="p">()</span>

                    <span class="c1"># If received no response from the call to did_not_run, or a True signal, then</span>
                    <span class="c1"># add to the hold-over queue.</span>
                    <span class="c1"># Otherwise (disease module returns &quot;FALSE&quot;) the event is not rescheduled and will not run.</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">rtn_from_did_not_run</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">):</span>
                        <span class="c1"># reschedule event</span>
                        <span class="n">hp</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">hold_over</span><span class="p">,</span> <span class="n">list_of_individual_hsi_event_tuples_due_today</span><span class="p">[</span><span class="n">ev_num</span><span class="p">])</span>

                    <span class="c1"># Log that the event did not run</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">log_hsi_event</span><span class="p">(</span>
                        <span class="n">hsi_event</span><span class="o">=</span><span class="n">event</span><span class="p">,</span>
                        <span class="n">actual_appt_footprint</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span><span class="p">,</span>
                        <span class="n">squeeze_factor</span><span class="o">=</span><span class="n">squeeze_factor</span><span class="p">,</span>
                        <span class="n">did_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="c1"># 7) Add back to the HSI_EVENT_QUEUE heapq all those events</span>
        <span class="c1"># which are still eligible to run but which did not run</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">hold_over</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">hp</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">HSI_EVENT_QUEUE</span><span class="p">,</span> <span class="n">hp</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="n">hold_over</span><span class="p">))</span>

        <span class="c1"># 8) After completing routine for the day, log total usage of the facilities</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">log_current_capabilities</span><span class="p">(</span>
            <span class="n">current_capabilities</span><span class="o">=</span><span class="n">current_capabilities</span><span class="p">,</span>
            <span class="n">total_footprint</span><span class="o">=</span><span class="n">total_footprint</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="HSI_Event"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HSI_Event">[docs]</a><span class="k">class</span> <span class="nc">HSI_Event</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Base HSI event class, from which all others inherit.</span>

<span class="sd">    Concrete subclasses should also inherit from one of the EventMixin classes</span>
<span class="sd">    defined below, and implement at least an `apply` and `did_not_run` method.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="HSI_Event.__init__"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HSI_Event.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new event.</span>

<span class="sd">        Note that just creating an event does not schedule it to happen; that</span>
<span class="sd">        must be done by calling Simulation.schedule_event.</span>

<span class="sd">        :param module: the module that created this event.</span>
<span class="sd">            All subclasses of Event take this as the first argument in their</span>
<span class="sd">            constructor, but may also take further keyword arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">sim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Overwritten by the mixin</span>
        <span class="c1"># This is needed so mixin constructors are called</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Defaults for the HSI information:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TREATMENT_ID</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ALERT_OTHER_DISEASES</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BEDDAYS_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_beddays_footprint</span><span class="p">({})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_received_info_about_bed_days</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_time_requests</span> <span class="o">=</span> <span class="p">{}</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bed_days_allocated_to_this_event</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_received_info_about_bed_days</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># default to the footprint if no information about bed-days is received</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">BEDDAYS_FOOTPRINT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_received_info_about_bed_days</span>

<div class="viewcode-block" id="HSI_Event.apply"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HSI_Event.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">squeeze_factor</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply this event to the population.</span>

<span class="sd">        Must be implemented by subclasses.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="HSI_Event.did_not_run"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HSI_Event.did_not_run">[docs]</a>    <span class="k">def</span> <span class="nf">did_not_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called when this event is due but it is not run. Return False to prevent the event being rescheduled, or True</span>
<span class="sd">        to allow the rescheduling. This is called each time that the event is tried to be run but it cannot be.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: did not run.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="HSI_Event.never_ran"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HSI_Event.never_ran">[docs]</a>    <span class="k">def</span> <span class="nf">never_ran</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called when this event is was entered to the HSI Event Queue, but was never run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: was never run.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="HSI_Event.not_available"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HSI_Event.not_available">[docs]</a>    <span class="k">def</span> <span class="nf">not_available</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called when this event is passed to schedule_hsi_event but the TREATMENT_ID is not permitted by the</span>
<span class="sd">         parameter service_availability.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: was not admitted to the HSI queue because the &quot;</span>
                                         <span class="sa">f</span><span class="s2">&quot;service is not available.&quot;</span><span class="p">)</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="HSI_Event.post_apply_hook"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HSI_Event.post_apply_hook">[docs]</a>    <span class="k">def</span> <span class="nf">post_apply_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Impose the bed-days footprint (if target of the HSI is a person_id)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;HealthSystem&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">bed_days</span><span class="o">.</span><span class="n">impose_beddays_footprint</span><span class="p">(</span>
                    <span class="n">person_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
                    <span class="n">footprint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bed_days_allocated_to_this_event</span>
                <span class="p">)</span></div>

<div class="viewcode-block" id="HSI_Event.run"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HSI_Event.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">squeeze_factor</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make the event happen.&quot;&quot;&quot;</span>
        <span class="n">updated_appt_footprint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">squeeze_factor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post_apply_hook</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">updated_appt_footprint</span></div>

<div class="viewcode-block" id="HSI_Event.get_all_consumables"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HSI_Event.get_all_consumables">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_consumables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_codes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pkg_codes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">footprint</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper function to allow for getting and checking of entire set of consumables.</span>
<span class="sd">        It accepts a footprint, or an item_code, or a package_code, and returns True/False for whether all the items</span>
<span class="sd">         are available. It avoids the use of consumables &#39;footprints&#39;.&quot;&quot;&quot;</span>

        <span class="c1"># Turn the input arguments into the usual consumables footprint if it&#39;s not already provided as a footprint:</span>
        <span class="k">if</span> <span class="n">footprint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Item Codes provided:</span>
            <span class="k">if</span> <span class="n">item_codes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item_codes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">item_codes</span> <span class="o">=</span> <span class="p">[</span><span class="n">item_codes</span><span class="p">]</span>
                <span class="c1"># turn into &#39;consumable footprint&#39;:</span>
                <span class="n">footprint_items</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">item_codes</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">item_codes</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">footprint_items</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># Package Codes provided:</span>
            <span class="k">if</span> <span class="n">pkg_codes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pkg_codes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">pkg_codes</span> <span class="o">=</span> <span class="p">[</span><span class="n">pkg_codes</span><span class="p">]</span>
                <span class="n">footprint_pkgs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">pkg_codes</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">pkg_codes</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">footprint_pkgs</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># Make the total footprint</span>
            <span class="n">footprint</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;Item_Code&#39;</span><span class="p">:</span> <span class="n">footprint_items</span><span class="p">,</span>
                <span class="s1">&#39;Intervention_Package_Code&#39;</span><span class="p">:</span> <span class="n">footprint_pkgs</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">check_consumables_footprint_format</span><span class="p">(</span><span class="n">footprint</span><span class="p">)</span>

        <span class="c1"># Check availability of consumables</span>
        <span class="n">rtn_from_health_system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">request_consumables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">footprint</span><span class="p">)</span>

        <span class="n">all_available</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span>
            <span class="n">rtn_from_health_system</span><span class="p">[</span><span class="s1">&#39;Intervention_Package_Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span>
            <span class="n">rtn_from_health_system</span><span class="p">[</span><span class="s1">&#39;Item_Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">all_available</span></div>

<div class="viewcode-block" id="HSI_Event.make_beddays_footprint"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HSI_Event.make_beddays_footprint">[docs]</a>    <span class="k">def</span> <span class="nf">make_beddays_footprint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dict_of_beddays</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper function to make a correctly-formed &#39;bed-days footprint&#39;&quot;&quot;&quot;</span>

        <span class="c1"># get blank footprint</span>
        <span class="k">if</span> <span class="s1">&#39;HealthSystem&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
            <span class="n">footprint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">bed_days</span><span class="o">.</span><span class="n">get_blank_beddays_footprint</span><span class="p">()</span>

            <span class="c1"># do checks</span>
            <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">dict_of_beddays</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">([(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">footprint</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dict_of_beddays</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dict_of_beddays</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>

            <span class="c1"># make footprint (defaulting to zero where a type of bed-days is not specified)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dict_of_beddays</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">footprint</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

            <span class="k">return</span> <span class="n">footprint</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="HSI_Event.is_all_beddays_allocated"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HSI_Event.is_all_beddays_allocated">[docs]</a>    <span class="k">def</span> <span class="nf">is_all_beddays_allocated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if the entire footprint requested is allocated&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bed_days_allocated_to_this_event</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">BEDDAYS_FOOTPRINT</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BEDDAYS_FOOTPRINT</span><span class="p">]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="HSI_Event.make_appt_footprint"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HSI_Event.make_appt_footprint">[docs]</a>    <span class="k">def</span> <span class="nf">make_appt_footprint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dict_of_appts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper function to make appointment footprint in format expected downstream.</span>

<span class="sd">        Should be passed a dictionary keyed by appointment type codes with non-negative</span>
<span class="sd">        values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">health_system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">health_system</span><span class="o">.</span><span class="n">appt_footprint_is_valid</span><span class="p">(</span><span class="n">dict_of_appts</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Counter</span><span class="p">(</span><span class="n">dict_of_appts</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Argument to make_appt_footprint should be a dictionary keyed by &quot;</span>
                <span class="s2">&quot;appointment type code strings in Appt_Types_Table with non-negative &quot;</span>
                <span class="s2">&quot;values&quot;</span>
            <span class="p">)</span></div></div>


<div class="viewcode-block" id="HSIEventWrapper"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HSIEventWrapper">[docs]</a><span class="k">class</span> <span class="nc">HSIEventWrapper</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is wrapper that contains an HSI event.</span>

<span class="sd">    It is used:</span>
<span class="sd">     1) When the healthsystem is in mode &#39;disabled=True&#39; such that HSI events sent to the health system scheduler are</span>
<span class="sd">     passed to the main simulation scheduler for running on the date of `topen`. (Note, it is run with</span>
<span class="sd">     squeeze_factor=0.0.)</span>
<span class="sd">     2) When the healthsytsem is in mode `diable_and_reject_all=True` such that HSI are not run but the `never_ran`</span>
<span class="sd">     method is run on the date of `tclose`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="HSIEventWrapper.__init__"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HSIEventWrapper.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hsi_event</span><span class="p">,</span> <span class="n">run_hsi</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hsi_event</span> <span class="o">=</span> <span class="n">hsi_event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">hsi_event</span><span class="o">.</span><span class="n">target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_hsi</span> <span class="o">=</span> <span class="n">run_hsi</span>  <span class="c1"># True to call the HSI&#39;s `run` method; False to call the HSI&#39;s `never_ran` method</span></div>

<div class="viewcode-block" id="HSIEventWrapper.run"><a class="viewcode-back" href="../../../reference/tlo.methods.healthsystem.html#tlo.methods.healthsystem.HSIEventWrapper.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Do the appropriate action on the HSI event&quot;&quot;&quot;</span>

        <span class="c1"># Check that the person is still alive (this check normally happens in the HealthSystemScheduler and silently</span>
        <span class="c1"># do not run the HSI event)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">tlo</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">Population</span><span class="p">)</span> \
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="s1">&#39;is_alive&#39;</span><span class="p">]):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_hsi</span><span class="p">:</span>
                <span class="c1"># Run the event (with 0 squeeze_factor) and ignore the output</span>
                <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">squeeze_factor</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hsi_event</span><span class="o">.</span><span class="n">never_ran</span><span class="p">()</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
      <span class="lastupdated">
        Last updated on Nov 09, 2021.
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>