

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tlo.methods.tb &mdash; TLOmodel 0.1.dev2457+g44ac319.d20241008 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=d10597a4" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=7ab3649f" />
      <link rel="stylesheet" type="text/css" href="../../../_static/theme_overrides.css?v=6ea10ece" />

  
    <link rel="shortcut icon" href="../../../_static/favicon.png"/>
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=0e657b16"></script>
      <script src="../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            TLOmodel
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Welcome</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../aims.html">Aims &amp; Objectives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../writeups.html">Model Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data_sources.html">Data Sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../azure_batch.html">Using Azure Batch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../resources/index.html">Resource files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../parameters.html">Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../learning.html">Learning Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributors.html">Contributors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">TLOmodel</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../methods.html">tlo.methods</a></li>
      <li class="breadcrumb-item active">tlo.methods.tb</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for tlo.methods.tb</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This module schedules TB infection and natural history</span>
<span class="sd">    It schedules TB treatment and follow-up appointments along with preventive therapy</span>
<span class="sd">    for eligible people (HIV+ and paediatric contacts of active TB cases</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">tlo</span> <span class="kn">import</span> <span class="n">Date</span><span class="p">,</span> <span class="n">DateOffset</span><span class="p">,</span> <span class="n">Module</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">,</span> <span class="n">Property</span><span class="p">,</span> <span class="n">Types</span><span class="p">,</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="nn">tlo.events</span> <span class="kn">import</span> <span class="n">Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">,</span> <span class="n">RegularEvent</span>
<span class="kn">from</span> <span class="nn">tlo.lm</span> <span class="kn">import</span> <span class="n">LinearModel</span><span class="p">,</span> <span class="n">LinearModelType</span><span class="p">,</span> <span class="n">Predictor</span>
<span class="kn">from</span> <span class="nn">tlo.methods</span> <span class="kn">import</span> <span class="n">Metadata</span><span class="p">,</span> <span class="n">hiv</span>
<span class="kn">from</span> <span class="nn">tlo.methods.causes</span> <span class="kn">import</span> <span class="n">Cause</span>
<span class="kn">from</span> <span class="nn">tlo.methods.dxmanager</span> <span class="kn">import</span> <span class="n">DxTest</span>
<span class="kn">from</span> <span class="nn">tlo.methods.hsi_event</span> <span class="kn">import</span> <span class="n">HSI_Event</span>
<span class="kn">from</span> <span class="nn">tlo.methods.symptommanager</span> <span class="kn">import</span> <span class="n">Symptom</span>
<span class="kn">from</span> <span class="nn">tlo.util</span> <span class="kn">import</span> <span class="n">random_date</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>


<div class="viewcode-block" id="Tb">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.Tb">[docs]</a>
<span class="k">class</span> <span class="nc">Tb</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set up the baseline population with TB prevalence&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Tb.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.Tb.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resourcefilepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run_with_checks</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resourcefilepath</span> <span class="o">=</span> <span class="n">resourcefilepath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daly_wts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">footprints_for_consumables_required</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symptom_list</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fever&quot;</span><span class="p">,</span> <span class="s2">&quot;respiratory_symptoms&quot;</span><span class="p">,</span> <span class="s2">&quot;fatigue&quot;</span><span class="p">,</span> <span class="s2">&quot;night_sweats&quot;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">district_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">run_with_checks</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_with_checks</span> <span class="o">=</span> <span class="n">run_with_checks</span>

        <span class="c1"># tb outputs needed for calibration/</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">,</span>
                <span class="s2">&quot;num_new_active_tb&quot;</span><span class="p">,</span>
                <span class="s2">&quot;tbPrevLatent&quot;</span>
                <span class="p">]</span>
        <span class="c1"># initialise empty dict with set keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tb_outputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span></div>


    <span class="n">INIT_DEPENDENCIES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Demography&quot;</span><span class="p">,</span>
        <span class="s2">&quot;HealthSystem&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Lifestyle&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SymptomManager&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Epi&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">OPTIONAL_INIT_DEPENDENCIES</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;HealthBurden&quot;</span><span class="p">,</span> <span class="s2">&quot;Hiv&quot;</span><span class="p">}</span>

    <span class="n">METADATA</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">Metadata</span><span class="o">.</span><span class="n">DISEASE_MODULE</span><span class="p">,</span>
        <span class="n">Metadata</span><span class="o">.</span><span class="n">USES_SYMPTOMMANAGER</span><span class="p">,</span>
        <span class="n">Metadata</span><span class="o">.</span><span class="n">USES_HEALTHSYSTEM</span><span class="p">,</span>
        <span class="n">Metadata</span><span class="o">.</span><span class="n">USES_HEALTHBURDEN</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Declare Causes of Death</span>
    <span class="n">CAUSES_OF_DEATH</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;TB&quot;</span><span class="p">:</span> <span class="n">Cause</span><span class="p">(</span><span class="n">gbd_causes</span><span class="o">=</span><span class="s2">&quot;Tuberculosis&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;TB (non-AIDS)&quot;</span><span class="p">),</span>
        <span class="s2">&quot;AIDS_TB&quot;</span><span class="p">:</span> <span class="n">Cause</span><span class="p">(</span><span class="n">gbd_causes</span><span class="o">=</span><span class="s2">&quot;HIV/AIDS&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;AIDS&quot;</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="n">CAUSES_OF_DISABILITY</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;TB&quot;</span><span class="p">:</span> <span class="n">Cause</span><span class="p">(</span><span class="n">gbd_causes</span><span class="o">=</span><span class="s2">&quot;Tuberculosis&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;TB (non-AIDS)&quot;</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="c1"># Declaration of the specific symptoms that this module will use</span>
    <span class="n">SYMPTOMS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fatigue&quot;</span><span class="p">,</span> <span class="s2">&quot;night_sweats&quot;</span><span class="p">}</span>

    <span class="n">PROPERTIES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># ------------------ natural history ------------------ #</span>
        <span class="s2">&quot;tb_inf&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">CATEGORICAL</span><span class="p">,</span>
            <span class="n">categories</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;uninfected&quot;</span><span class="p">,</span>
                <span class="s2">&quot;latent&quot;</span><span class="p">,</span>
                <span class="s2">&quot;active&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;tb status&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;tb_strain&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">CATEGORICAL</span><span class="p">,</span>
            <span class="n">categories</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;none&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ds&quot;</span><span class="p">,</span>
                <span class="s2">&quot;mdr&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;tb strain: drug-susceptible (ds) or multi-drug resistant (mdr)&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;tb_date_latent&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">DATE</span><span class="p">,</span> <span class="s2">&quot;Date acquired tb infection (latent stage)&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;tb_scheduled_date_active&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">DATE</span><span class="p">,</span> <span class="s2">&quot;Date active tb is scheduled to start&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;tb_date_active&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATE</span><span class="p">,</span> <span class="s2">&quot;Date active tb started&quot;</span><span class="p">),</span>
        <span class="s2">&quot;tb_smear&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span>
            <span class="s2">&quot;smear positivity with active infection: False=negative, True=positive&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="c1"># ------------------ testing status ------------------ #</span>
        <span class="s2">&quot;tb_date_tested&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATE</span><span class="p">,</span> <span class="s2">&quot;Date of last tb test&quot;</span><span class="p">),</span>
        <span class="s2">&quot;tb_diagnosed&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span> <span class="s2">&quot;person has current diagnosis of active tb&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;tb_date_diagnosed&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATE</span><span class="p">,</span> <span class="s2">&quot;date most recent tb diagnosis&quot;</span><span class="p">),</span>
        <span class="s2">&quot;tb_diagnosed_mdr&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span> <span class="s2">&quot;person has current diagnosis of active mdr-tb&quot;</span>
        <span class="p">),</span>
        <span class="c1"># ------------------ treatment status ------------------ #</span>
        <span class="s2">&quot;tb_on_treatment&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span> <span class="s2">&quot;on tb treatment regimen&quot;</span><span class="p">),</span>
        <span class="s2">&quot;tb_date_treated&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">DATE</span><span class="p">,</span> <span class="s2">&quot;date most recent tb treatment started&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;tb_treatment_regimen&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">CATEGORICAL</span><span class="p">,</span>
            <span class="n">categories</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;none&quot;</span><span class="p">,</span>
                <span class="s2">&quot;tb_tx_adult&quot;</span><span class="p">,</span>
                <span class="s2">&quot;tb_tx_child&quot;</span><span class="p">,</span>
                <span class="s2">&quot;tb_retx_adult&quot;</span><span class="p">,</span>
                <span class="s2">&quot;tb_retx_child&quot;</span><span class="p">,</span>
                <span class="s2">&quot;tb_mdrtx&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;current tb treatment regimen&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;tb_ever_treated&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span> <span class="s2">&quot;if ever treated for active tb&quot;</span><span class="p">),</span>
        <span class="s2">&quot;tb_treatment_failure&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span> <span class="s2">&quot;failed first line tb treatment&quot;</span><span class="p">),</span>
        <span class="s2">&quot;tb_treated_mdr&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span> <span class="s2">&quot;on tb treatment MDR regimen&quot;</span><span class="p">),</span>
        <span class="s2">&quot;tb_date_treated_mdr&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATE</span><span class="p">,</span> <span class="s2">&quot;date tb MDR treatment started&quot;</span><span class="p">),</span>
        <span class="s2">&quot;tb_on_ipt&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span> <span class="s2">&quot;if currently on ipt&quot;</span><span class="p">),</span>
        <span class="s2">&quot;tb_date_ipt&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATE</span><span class="p">,</span> <span class="s2">&quot;date ipt started&quot;</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="n">PARAMETERS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># ------------------ baseline population ------------------ #</span>
        <span class="s2">&quot;prop_mdr2010&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Proportion of active tb cases with multidrug resistance in 2010&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="c1"># ------------------ workbooks ------------------ #</span>
        <span class="s2">&quot;who_incidence_estimates&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;WHO estimated active TB incidence per 100,000 population&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;followup_times&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span>
            <span class="s2">&quot;times(weeks) tb treatment monitoring required after tx start&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;tb_high_risk_distr&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s2">&quot;list of ten high-risk districts&quot;</span><span class="p">),</span>
        <span class="s2">&quot;ipt_coverage&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span>
            <span class="s2">&quot;national estimates of coverage of IPT in PLHIV and paediatric contacts&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="c1"># ------------------ natural history ------------------ #</span>
        <span class="s2">&quot;incidence_active_tb_2010&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;incidence of active tb in 2010 in all ages&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;rr_tb_child&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;relative risk of tb infection if under 16 years of age&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;monthly_prob_relapse_tx_complete&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;monthly probability of relapse once treatment complete&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;monthly_prob_relapse_tx_incomplete&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;monthly probability of relapse if treatment incomplete&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;monthly_prob_relapse_2yrs&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;monthly probability of relapse 2 years after treatment complete&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;rr_relapse_hiv&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;relative risk of relapse for HIV-positive people&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;rr_relapse_diabetes&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;relative risk of relapse for people with diabetes (treated/untreated)&quot;</span>
        <span class="p">),</span>
        <span class="c1"># ------------------ active disease ------------------ #</span>
        <span class="s2">&quot;scaling_factor_WHO&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;scaling factor applied to WHO estimates to account for the impact of interventions in place&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;duration_active_disease_years&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;duration of active disease from onset to cure or death&quot;</span>
        <span class="p">),</span>
        <span class="c1"># ------------------ clinical features ------------------ #</span>
        <span class="s2">&quot;prop_smear_positive&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;proportion of new active cases that will be smear-positive&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;prop_smear_positive_hiv&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;proportion of hiv+ active tb cases that will be smear-positive&quot;</span>
        <span class="p">),</span>
        <span class="c1"># ------------------ mortality ------------------ #</span>
        <span class="c1"># untreated</span>
        <span class="s2">&quot;death_rate_smear_pos_untreated&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;probability of death in smear-positive tb cases with untreated tb&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;death_rate_smear_neg_untreated&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;probability of death in smear-negative tb cases with untreated tb&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="c1"># treated</span>
        <span class="s2">&quot;death_rate_child0_4_treated&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;probability of death in child aged 0-4 years with treated tb&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;death_rate_child5_14_treated&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;probability of death in child aged 5-14 years with treated tb&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;death_rate_adult_treated&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;probability of death in adult aged &gt;=15 years with treated tb&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;rr_death_diabetes&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;additional risk of death if person has diabetes (treated/untreated)&quot;</span>
        <span class="p">),</span>
        <span class="c1"># ------------------ progression to active disease ------------------ #</span>
        <span class="s2">&quot;rr_tb_bcg&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;relative risk of progression to active disease for children with BCG vaccine&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;rr_tb_hiv&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;relative risk of progression to active disease for PLHIV&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;rr_tb_aids&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;relative risk of progression to active disease for PLHIV with AIDS&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;rr_tb_art_adult&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;relative risk of progression to active disease for adults with HIV on ART&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;rr_tb_art_child&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;relative risk of progression to active disease for adults with HIV on ART&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;rr_tb_obese&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;relative risk of progression to active disease if obese&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;rr_tb_diabetes&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;relative risk of progression to active disease with any type diabetes&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;rr_tb_alcohol&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;relative risk of progression to active disease with heavy alcohol use&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;rr_tb_smoking&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;relative risk of progression to active disease with smoking&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;rr_ipt_adult&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;relative risk of active TB with IPT in adults&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;rr_ipt_child&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;relative risk of active TB with IPT in children&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;rr_ipt_adult_hiv&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;relative risk of active TB with IPT in adults with hiv&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;rr_ipt_child_hiv&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;relative risk of active TB with IPT in children with hiv&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;rr_ipt_art_adult&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;relative risk of active TB with IPT and ART in adults&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;rr_ipt_art_child&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;relative risk of active TB with IPT and ART in children&quot;</span>
        <span class="p">),</span>
        <span class="c1"># ------------------ diagnostic tests ------------------ #</span>
        <span class="s2">&quot;sens_xpert_smear_negative&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;sensitivity of Xpert test in smear negative TB cases&quot;</span><span class="p">),</span>
        <span class="s2">&quot;sens_xpert_smear_positive&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;sensitivity of Xpert test in smear positive TB cases&quot;</span><span class="p">),</span>
        <span class="s2">&quot;spec_xpert_smear_negative&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;specificity of Xpert test in smear negative TB cases&quot;</span><span class="p">),</span>
        <span class="s2">&quot;spec_xpert_smear_positive&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;specificity of Xpert test in smear positive TB cases&quot;</span><span class="p">),</span>
        <span class="s2">&quot;sens_sputum_smear_positive&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;sensitivity of sputum smear microscopy in sputum positive cases&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;spec_sputum_smear_positive&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;specificity of sputum smear microscopy in sputum positive cases&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;sens_clinical&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;sensitivity of clinical diagnosis in detecting active TB&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;spec_clinical&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;specificity of clinical diagnosis in detecting TB&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;sens_xray_smear_negative&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;sensitivity of x-ray diagnosis in smear negative TB cases&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;sens_xray_smear_positive&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;sensitivity of x-ray diagnosis in smear positive TB cases&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;spec_xray_smear_negative&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;specificity of x-ray diagnosis in smear negative TB cases&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;spec_xray_smear_positive&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;specificity of x-ray diagnosis in smear positive TB cases&quot;</span>
        <span class="p">),</span>
        <span class="c1"># ------------------ treatment success rates ------------------ #</span>
        <span class="s2">&quot;prob_tx_success_ds&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Probability of treatment success for new and relapse TB cases&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;prob_tx_success_mdr&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Probability of treatment success for MDR-TB cases&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;prob_tx_success_0_4&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Probability of treatment success for children aged 0-4 years&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;prob_tx_success_5_14&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Probability of treatment success for children aged 5-14 years&quot;</span>
        <span class="p">),</span>
        <span class="c1"># ------------------ testing rates ------------------ #</span>
        <span class="s2">&quot;rate_testing_general_pop&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;rate of screening / testing per month in general population&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;rate_testing_active_tb&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span>
            <span class="s2">&quot;rate of screening / testing per month in population with active tb&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="c1"># ------------------ treatment regimens ------------------ #</span>
        <span class="s2">&quot;ds_treatment_length&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;length of treatment for drug-susceptible tb (first case) in months&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;ds_retreatment_length&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;length of treatment for drug-susceptible tb (secondary case) in months&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;mdr_treatment_length&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;length of treatment for mdr-tb in months&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;prob_retained_ipt_6_months&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;probability of being retained on IPT every 6 months if still eligible&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;age_eligibility_for_ipt&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;eligibility criteria (years of age) for IPT given to contacts of TB cases&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;ipt_start_date&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span>
            <span class="s2">&quot;year from which IPT is available for paediatric contacts of diagnosed active TB cases&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;first_line_test&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">STRING</span><span class="p">,</span>
            <span class="s2">&quot;name of first test to be used for TB diagnosis&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;second_line_test&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">STRING</span><span class="p">,</span>
            <span class="s2">&quot;name of second test to be used for TB diagnosis&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;tb_healthseekingbehaviour_cap&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span>
            <span class="s2">&quot;number of repeat visits assumed for healthcare services&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;data_end&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span>
            <span class="s2">&quot;last year for which data are available&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;length_of_inpatient_stay_if_terminal&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span>
            <span class="s2">&quot;length of inpatient stay for end-of-life TB patients&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="c1"># ------------------ scale-up parameters for scenario analysis ------------------ #</span>
        <span class="s2">&quot;type_of_scaleup&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">STRING</span><span class="p">,</span> <span class="s2">&quot;argument to determine type scale-up of program which will be implemented, &quot;</span>
                          <span class="s2">&quot;can be &#39;none&#39;, &#39;target&#39; or &#39;max&#39;&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;scaleup_start_year&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span>
            <span class="s2">&quot;the year when the scale-up starts (it will occur on 1st January of that year)&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;scaleup_parameters&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span>
            <span class="s2">&quot;the parameters and values changed in scenario analysis&quot;</span>
        <span class="p">)</span>
    <span class="p">}</span>

<div class="viewcode-block" id="Tb.read_parameters">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.Tb.read_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">read_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_folder</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        * 1) Reads the ResourceFiles</span>
<span class="sd">        * 2) Declares the DALY weights</span>
<span class="sd">        * 3) Declares the Symptoms</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># 1) Read the ResourceFiles</span>
        <span class="n">workbook</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resourcefilepath</span><span class="p">,</span> <span class="s2">&quot;ResourceFile_TB.xlsx&quot;</span><span class="p">),</span> <span class="n">sheet_name</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_parameters_from_dataframe</span><span class="p">(</span><span class="n">workbook</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">])</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>

        <span class="c1"># assume cases distributed equally across districts</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;who_incidence_estimates&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s2">&quot;WHO_activeTB2023&quot;</span><span class="p">]</span>

        <span class="c1"># use NTP reported treatment rates as testing rates (perfect referral)</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rate_testing_active_tb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s2">&quot;NTP2019&quot;</span><span class="p">]</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;followup_times&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s2">&quot;followup&quot;</span><span class="p">]</span>

        <span class="c1"># if using national-level model, include all districts in IPT coverage</span>
        <span class="c1"># p[&#39;tb_high_risk_distr&#39;] = workbook[&#39;IPTdistricts&#39;]</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;tb_high_risk_distr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s2">&quot;all_districts&quot;</span><span class="p">]</span>

        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;ipt_coverage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s2">&quot;ipt_coverage&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">district_list</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;Demography&quot;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;pop_2010&quot;</span><span class="p">][</span><span class="s2">&quot;District&quot;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># load parameters for scale-up projections</span>
        <span class="n">p</span><span class="p">[</span><span class="s1">&#39;scaleup_parameters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s2">&quot;scaleup_parameters&quot;</span><span class="p">]</span>

        <span class="c1"># 2) Get the DALY weights</span>
        <span class="k">if</span> <span class="s2">&quot;HealthBurden&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># HIV-negative</span>
            <span class="c1"># Drug-susceptible tuberculosis, not HIV infected</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">daly_wts</span><span class="p">[</span><span class="s2">&quot;daly_tb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthBurden&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_daly_weight</span><span class="p">(</span>
                <span class="mi">0</span>
            <span class="p">)</span>
            <span class="c1"># multi-drug resistant tuberculosis, not HIV infected</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">daly_wts</span><span class="p">[</span><span class="s2">&quot;daly_mdr_tb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span>
                <span class="s2">&quot;HealthBurden&quot;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">get_daly_weight</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># HIV-positive</span>
            <span class="c1"># Drug-susceptible Tuberculosis, HIV infected without anaemia</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">daly_wts</span><span class="p">[</span><span class="s2">&quot;daly_tb_hiv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span>
                <span class="s2">&quot;HealthBurden&quot;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">get_daly_weight</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
            <span class="c1"># Multi-drug resistant Tuberculosis, HIV infected and anemia, moderate</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">daly_wts</span><span class="p">[</span><span class="s2">&quot;daly_mdr_tb_hiv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span>
                <span class="s2">&quot;HealthBurden&quot;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">get_daly_weight</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>

        <span class="c1"># 3) Declare the Symptoms</span>
        <span class="c1"># additional healthcare-seeking behaviour with these symptoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;SymptomManager&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">register_symptom</span><span class="p">(</span>
            <span class="n">Symptom</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;fatigue&quot;</span><span class="p">,</span>
                <span class="n">odds_ratio_health_seeking_in_adults</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
                <span class="n">odds_ratio_health_seeking_in_children</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;SymptomManager&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">register_symptom</span><span class="p">(</span>
            <span class="n">Symptom</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;night_sweats&quot;</span><span class="p">,</span>
                <span class="n">odds_ratio_health_seeking_in_adults</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
                <span class="n">odds_ratio_health_seeking_in_children</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Tb.pre_initialise_population">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.Tb.pre_initialise_population">[docs]</a>
    <span class="k">def</span> <span class="nf">pre_initialise_population</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Do things required before the population is created</span>
<span class="sd">        * Build the LinearModels&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_linear_models</span><span class="p">()</span></div>


<div class="viewcode-block" id="Tb._build_linear_models">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.Tb._build_linear_models">[docs]</a>
    <span class="k">def</span> <span class="nf">_build_linear_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Establish the Linear Models&quot;&quot;&quot;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>

        <span class="c1"># risk of active tb</span>
        <span class="n">predictors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;age_years&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;&lt;=15&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_tb_child&quot;</span><span class="p">]),</span>
            <span class="c1"># -------------- LIFESTYLE -------------- #</span>
            <span class="n">Predictor</span><span class="p">()</span><span class="o">.</span><span class="n">when</span><span class="p">(</span>
                <span class="s1">&#39;va_bcg_all_doses &amp;&#39;</span>
                <span class="s1">&#39;(hv_inf == False) &amp;&#39;</span>
                <span class="s1">&#39;(age_years &lt;10)&#39;</span><span class="p">,</span>
                <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_tb_bcg&quot;</span><span class="p">]</span>  <span class="c1"># child with bcg</span>
            <span class="p">),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;li_bmi&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;&gt;=4&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_tb_obese&quot;</span><span class="p">]),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;li_ex_alc&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_tb_alcohol&quot;</span><span class="p">]),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;li_tob&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_tb_smoking&quot;</span><span class="p">]),</span>
            <span class="c1"># -------------- IPT -------------- #</span>
            <span class="n">Predictor</span><span class="p">()</span><span class="o">.</span><span class="n">when</span><span class="p">(</span>
                <span class="s1">&#39;~hv_inf &amp;&#39;</span>
                <span class="s1">&#39;tb_on_ipt &amp; &#39;</span>
                <span class="s1">&#39;age_years &lt;= 15&#39;</span><span class="p">,</span>
                <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_ipt_child&quot;</span><span class="p">]),</span>  <span class="c1"># hiv- child on ipt</span>
            <span class="n">Predictor</span><span class="p">()</span><span class="o">.</span><span class="n">when</span><span class="p">(</span>
                <span class="s1">&#39;~hv_inf &amp;&#39;</span>
                <span class="s1">&#39;tb_on_ipt &amp; &#39;</span>
                <span class="s1">&#39;age_years &gt; 15&#39;</span><span class="p">,</span>
                <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_ipt_adult&quot;</span><span class="p">]),</span>  <span class="c1"># hiv- adult on ipt</span>
            <span class="c1"># -------------- PLHIV -------------- #</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;hv_inf&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_tb_hiv&quot;</span><span class="p">]),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;sy_aids_symptoms&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;&gt;0&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_tb_aids&quot;</span><span class="p">]),</span>
            <span class="c1"># on ART, no IPT</span>
            <span class="n">Predictor</span><span class="p">()</span><span class="o">.</span><span class="n">when</span><span class="p">(</span>
                <span class="s1">&#39;hv_inf &amp; &#39;</span>
                <span class="s1">&#39;(hv_art == &quot;on_VL_suppressed&quot;) &amp;&#39;</span>
                <span class="s1">&#39;~tb_on_ipt &amp; &#39;</span>
                <span class="s1">&#39;age_years &lt;= 15&#39;</span><span class="p">,</span>
                <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_tb_art_child&quot;</span><span class="p">]),</span>  <span class="c1"># hiv+ child on ART</span>
            <span class="n">Predictor</span><span class="p">()</span><span class="o">.</span><span class="n">when</span><span class="p">(</span>
                <span class="s1">&#39;hv_inf &amp; &#39;</span>
                <span class="s1">&#39;(hv_art == &quot;on_VL_suppressed&quot;) &amp;&#39;</span>
                <span class="s1">&#39;~tb_on_ipt &amp; &#39;</span>
                <span class="s1">&#39;age_years &gt; 15&#39;</span><span class="p">,</span>
                <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_tb_art_adult&quot;</span><span class="p">]),</span>  <span class="c1"># hiv+ adult on ART</span>
            <span class="c1"># on ART, on IPT</span>
            <span class="n">Predictor</span><span class="p">()</span><span class="o">.</span><span class="n">when</span><span class="p">(</span>
                <span class="s1">&#39;tb_on_ipt &amp; &#39;</span>
                <span class="s1">&#39;hv_inf &amp; &#39;</span>
                <span class="s1">&#39;age_years &lt;= 15 &amp;&#39;</span>
                <span class="s1">&#39;(hv_art == &quot;on_VL_suppressed&quot;)&#39;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_tb_art_child&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_ipt_art_child&quot;</span><span class="p">]),</span>  <span class="c1"># hiv+ child on ART+IPT</span>
            <span class="p">),</span>
            <span class="n">Predictor</span><span class="p">()</span><span class="o">.</span><span class="n">when</span><span class="p">(</span>
                <span class="s1">&#39;tb_on_ipt &amp; &#39;</span>
                <span class="s1">&#39;hv_inf &amp; &#39;</span>
                <span class="s1">&#39;age_years &gt; 15 &amp;&#39;</span>
                <span class="s1">&#39;(hv_art == &quot;on_VL_suppressed&quot;)&#39;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_tb_art_adult&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_ipt_art_adult&quot;</span><span class="p">]),</span>  <span class="c1"># hiv+ adult on ART+IPT</span>
            <span class="p">),</span>
            <span class="c1"># not on ART, on IPT</span>
            <span class="n">Predictor</span><span class="p">()</span><span class="o">.</span><span class="n">when</span><span class="p">(</span>
                <span class="s1">&#39;tb_on_ipt &amp; &#39;</span>
                <span class="s1">&#39;hv_inf &amp; &#39;</span>
                <span class="s1">&#39;age_years &lt;= 15 &amp;&#39;</span>
                <span class="s1">&#39;(hv_art != &quot;on_VL_suppressed&quot;)&#39;</span><span class="p">,</span>
                <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_ipt_child_hiv&quot;</span><span class="p">],</span>  <span class="c1"># hiv+ child IPT only</span>
            <span class="p">),</span>
            <span class="n">Predictor</span><span class="p">()</span><span class="o">.</span><span class="n">when</span><span class="p">(</span>
                <span class="s1">&#39;tb_on_ipt &amp; &#39;</span>
                <span class="s1">&#39;hv_inf &amp; &#39;</span>
                <span class="s1">&#39;age_years &gt; 15 &amp;&#39;</span>
                <span class="s1">&#39;(hv_art != &quot;on_VL_suppressed&quot;)&#39;</span><span class="p">,</span>
                <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_ipt_adult_hiv&quot;</span><span class="p">],</span>  <span class="c1"># hiv+ adult IPT only</span>
            <span class="p">),</span>
        <span class="p">]</span>
        <span class="n">conditional_predictors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;nc_diabetes&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;rr_tb_diabetes&#39;</span><span class="p">]),</span>
        <span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;CardioMetabolicDisorders&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span> <span class="k">else</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s2">&quot;active_tb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinearModel</span><span class="o">.</span><span class="n">multiplicative</span><span class="p">(</span>
            <span class="o">*</span><span class="p">(</span><span class="n">predictors</span> <span class="o">+</span> <span class="n">conditional_predictors</span><span class="p">))</span>

        <span class="c1"># risk of relapse &lt;2 years following treatment</span>
        <span class="n">predictors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;hv_inf&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_relapse_hiv&quot;</span><span class="p">]),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;tb_treatment_failure&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;monthly_prob_relapse_tx_incomplete&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;monthly_prob_relapse_tx_complete&quot;</span><span class="p">])),</span>
            <span class="n">Predictor</span><span class="p">()</span><span class="o">.</span><span class="n">when</span><span class="p">(</span>
                <span class="s1">&#39;tb_on_ipt &amp; &#39;</span>
                <span class="s1">&#39;age_years &lt;= 15&#39;</span><span class="p">,</span>
                <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_ipt_child&quot;</span><span class="p">]),</span>
            <span class="n">Predictor</span><span class="p">()</span><span class="o">.</span><span class="n">when</span><span class="p">(</span>
                <span class="s1">&#39;tb_on_ipt &amp; &#39;</span>
                <span class="s1">&#39;age_years &gt; 15&#39;</span><span class="p">,</span>
                <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_ipt_adult&quot;</span><span class="p">]),</span>
        <span class="p">]</span>

        <span class="n">conditional_predictors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;nc_diabetes&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;rr_relapse_diabetes&#39;</span><span class="p">]),</span>
        <span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;CardioMetabolicDisorders&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span> <span class="k">else</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s2">&quot;risk_relapse_2yrs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinearModel</span><span class="p">(</span>
            <span class="n">LinearModelType</span><span class="o">.</span><span class="n">MULTIPLICATIVE</span><span class="p">,</span>
            <span class="n">p</span><span class="p">[</span><span class="s2">&quot;monthly_prob_relapse_tx_complete&quot;</span><span class="p">],</span>
            <span class="o">*</span><span class="p">(</span><span class="n">predictors</span> <span class="o">+</span> <span class="n">conditional_predictors</span><span class="p">))</span>

        <span class="c1"># risk of relapse if &gt;=2 years post treatment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s2">&quot;risk_relapse_late&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinearModel</span><span class="p">(</span>
            <span class="n">LinearModelType</span><span class="o">.</span><span class="n">MULTIPLICATIVE</span><span class="p">,</span>
            <span class="n">p</span><span class="p">[</span><span class="s2">&quot;monthly_prob_relapse_2yrs&quot;</span><span class="p">],</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;hv_inf&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_relapse_hiv&quot;</span><span class="p">]),</span>
            <span class="n">Predictor</span><span class="p">()</span><span class="o">.</span><span class="n">when</span><span class="p">(</span>
                <span class="s1">&#39;tb_on_ipt &amp; &#39;</span>
                <span class="s1">&#39;age_years &lt;= 15&#39;</span><span class="p">,</span>
                <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_ipt_child&quot;</span><span class="p">]),</span>
            <span class="n">Predictor</span><span class="p">()</span><span class="o">.</span><span class="n">when</span><span class="p">(</span>
                <span class="s1">&#39;tb_on_ipt &amp; &#39;</span>
                <span class="s1">&#39;age_years &gt; 15&#39;</span><span class="p">,</span>
                <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_ipt_adult&quot;</span><span class="p">]),</span>
        <span class="p">)</span>

        <span class="c1"># probability of death</span>
        <span class="n">predictors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Predictor</span><span class="p">()</span><span class="o">.</span><span class="n">when</span><span class="p">(</span>
                <span class="s2">&quot;(tb_on_treatment == True) &amp; &quot;</span>
                <span class="s2">&quot;(age_years &lt;=4)&quot;</span><span class="p">,</span>
                <span class="n">p</span><span class="p">[</span><span class="s2">&quot;death_rate_child0_4_treated&quot;</span><span class="p">],</span>
            <span class="p">),</span>
            <span class="n">Predictor</span><span class="p">()</span><span class="o">.</span><span class="n">when</span><span class="p">(</span>
                <span class="s2">&quot;(tb_on_treatment == True) &amp; &quot;</span>
                <span class="s2">&quot;(age_years &lt;=14)&quot;</span><span class="p">,</span>
                <span class="n">p</span><span class="p">[</span><span class="s2">&quot;death_rate_child5_14_treated&quot;</span><span class="p">],</span>
            <span class="p">),</span>
            <span class="n">Predictor</span><span class="p">()</span><span class="o">.</span><span class="n">when</span><span class="p">(</span>
                <span class="s2">&quot;(tb_on_treatment == True) &amp; &quot;</span>
                <span class="s2">&quot;(age_years &gt;=15)&quot;</span><span class="p">,</span>
                <span class="n">p</span><span class="p">[</span><span class="s2">&quot;death_rate_adult_treated&quot;</span><span class="p">],</span>
            <span class="p">),</span>
            <span class="n">Predictor</span><span class="p">()</span><span class="o">.</span><span class="n">when</span><span class="p">(</span>
                <span class="s2">&quot;(tb_on_treatment == False) &amp; &quot;</span>
                <span class="s2">&quot;(tb_smear == True)&quot;</span><span class="p">,</span>
                <span class="n">p</span><span class="p">[</span><span class="s2">&quot;death_rate_smear_pos_untreated&quot;</span><span class="p">],</span>
            <span class="p">),</span>
            <span class="n">Predictor</span><span class="p">()</span><span class="o">.</span><span class="n">when</span><span class="p">(</span>
                <span class="s2">&quot;(tb_on_treatment == False) &amp; &quot;</span>
                <span class="s2">&quot;(tb_smear == False)&quot;</span><span class="p">,</span>
                <span class="n">p</span><span class="p">[</span><span class="s2">&quot;death_rate_smear_neg_untreated&quot;</span><span class="p">],</span>
            <span class="p">),</span>
        <span class="p">]</span>

        <span class="n">conditional_predictors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;nc_diabetes&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;rr_death_diabetes&#39;</span><span class="p">]),</span>
        <span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;CardioMetabolicDisorders&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span> <span class="k">else</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s2">&quot;death_rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinearModel</span><span class="o">.</span><span class="n">multiplicative</span><span class="p">(</span>
            <span class="o">*</span><span class="p">(</span><span class="n">predictors</span> <span class="o">+</span> <span class="n">conditional_predictors</span><span class="p">))</span></div>


<div class="viewcode-block" id="Tb.send_for_screening_general">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.Tb.send_for_screening_general">[docs]</a>
    <span class="k">def</span> <span class="nf">send_for_screening_general</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span>

        <span class="n">random_draw</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>

        <span class="c1"># randomly select some individuals for screening and testing</span>
        <span class="c1"># this may include some newly infected active tb cases (that&#39;s fine)</span>
        <span class="n">screen_idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span>
            <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
            <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">tb_diagnosed</span>
            <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">tb_on_treatment</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">random_draw</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rate_testing_general_pop&quot;</span><span class="p">])</span>
            <span class="p">]</span>

        <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">screen_idx</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">HSI_Tb_ScreeningAndRefer</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="p">),</span>
                <span class="n">topen</span><span class="o">=</span><span class="n">random_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">),</span>
                <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Tb.select_tb_test">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.Tb.select_tb_test">[docs]</a>
    <span class="k">def</span> <span class="nf">select_tb_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">person</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span>

        <span class="c1"># xpert tests limited to 60% coverage</span>
        <span class="c1"># if selected test is xpert, check for availability</span>
        <span class="c1"># give sputum smear as back-up</span>
        <span class="c1"># assume sputum smear always available</span>

        <span class="c1"># previously diagnosed/treated or hiv+ -&gt; xpert</span>
        <span class="k">if</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;tb_ever_treated&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;hv_diagnosed&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;first_line_test&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;xpert&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;xpert&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;sputum&quot;</span></div>


<div class="viewcode-block" id="Tb.get_consumables_for_dx_and_tx">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.Tb.get_consumables_for_dx_and_tx">[docs]</a>
    <span class="k">def</span> <span class="nf">get_consumables_for_dx_and_tx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>
        <span class="c1"># consumables = self.sim.modules[&quot;HealthSystem&quot;].parameters[&quot;Consumables&quot;]</span>
        <span class="n">hs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span>

        <span class="c1"># TB Sputum smear test</span>
        <span class="c1"># assume that if smear-positive, sputum smear test is 100% specific and sensitive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;sputum_test&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">hs</span><span class="o">.</span><span class="n">get_item_codes_from_package_name</span><span class="p">(</span><span class="s2">&quot;Microscopy Test&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">register_dx_test</span><span class="p">(</span>
            <span class="n">tb_sputum_test_smear_positive</span><span class="o">=</span><span class="n">DxTest</span><span class="p">(</span>
                <span class="nb">property</span><span class="o">=</span><span class="s1">&#39;tb_inf&#39;</span><span class="p">,</span>
                <span class="n">target_categories</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;active&quot;</span><span class="p">],</span>
                <span class="n">sensitivity</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;sens_sputum_smear_positive&quot;</span><span class="p">],</span>
                <span class="n">specificity</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;spec_sputum_smear_positive&quot;</span><span class="p">],</span>
                <span class="n">item_codes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;sputum_test&#39;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">register_dx_test</span><span class="p">(</span>
            <span class="n">tb_sputum_test_smear_negative</span><span class="o">=</span><span class="n">DxTest</span><span class="p">(</span>
                <span class="nb">property</span><span class="o">=</span><span class="s1">&#39;tb_inf&#39;</span><span class="p">,</span>
                <span class="n">target_categories</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;active&quot;</span><span class="p">],</span>
                <span class="n">sensitivity</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                <span class="n">specificity</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="n">item_codes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;sputum_test&#39;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># TB GeneXpert</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;xpert_test&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">hs</span><span class="o">.</span><span class="n">get_item_codes_from_package_name</span><span class="p">(</span><span class="s2">&quot;Xpert test&quot;</span><span class="p">)</span>

        <span class="c1"># sensitivity/specificity set for smear status of cases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">register_dx_test</span><span class="p">(</span>
            <span class="n">tb_xpert_test_smear_positive</span><span class="o">=</span><span class="n">DxTest</span><span class="p">(</span>
                <span class="nb">property</span><span class="o">=</span><span class="s2">&quot;tb_inf&quot;</span><span class="p">,</span>
                <span class="n">target_categories</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;active&quot;</span><span class="p">],</span>
                <span class="n">sensitivity</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;sens_xpert_smear_positive&quot;</span><span class="p">],</span>
                <span class="n">specificity</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;spec_xpert_smear_positive&quot;</span><span class="p">],</span>
                <span class="n">item_codes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;xpert_test&#39;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">register_dx_test</span><span class="p">(</span>
            <span class="n">tb_xpert_test_smear_negative</span><span class="o">=</span><span class="n">DxTest</span><span class="p">(</span>
                <span class="nb">property</span><span class="o">=</span><span class="s2">&quot;tb_inf&quot;</span><span class="p">,</span>
                <span class="n">target_categories</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;active&quot;</span><span class="p">],</span>
                <span class="n">sensitivity</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;sens_xpert_smear_negative&quot;</span><span class="p">],</span>
                <span class="n">specificity</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;spec_xpert_smear_negative&quot;</span><span class="p">],</span>
                <span class="n">item_codes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;xpert_test&#39;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># TB Chest x-ray</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;chest_xray&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">hs</span><span class="o">.</span><span class="n">get_item_code_from_item_name</span><span class="p">(</span><span class="s2">&quot;X-ray&quot;</span><span class="p">):</span> <span class="mi">1</span><span class="p">}</span>

        <span class="c1"># sensitivity/specificity set for smear status of cases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">register_dx_test</span><span class="p">(</span>
            <span class="n">tb_xray_smear_positive</span><span class="o">=</span><span class="n">DxTest</span><span class="p">(</span>
                <span class="nb">property</span><span class="o">=</span><span class="s2">&quot;tb_inf&quot;</span><span class="p">,</span>
                <span class="n">target_categories</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;active&quot;</span><span class="p">],</span>
                <span class="n">sensitivity</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;sens_xray_smear_positive&quot;</span><span class="p">],</span>
                <span class="n">specificity</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;spec_xray_smear_positive&quot;</span><span class="p">],</span>
                <span class="n">item_codes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;chest_xray&#39;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">register_dx_test</span><span class="p">(</span>
            <span class="n">tb_xray_smear_negative</span><span class="o">=</span><span class="n">DxTest</span><span class="p">(</span>
                <span class="nb">property</span><span class="o">=</span><span class="s2">&quot;tb_inf&quot;</span><span class="p">,</span>
                <span class="n">target_categories</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;active&quot;</span><span class="p">],</span>
                <span class="n">sensitivity</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;sens_xray_smear_negative&quot;</span><span class="p">],</span>
                <span class="n">specificity</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;spec_xray_smear_negative&quot;</span><span class="p">],</span>
                <span class="n">item_codes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;chest_xray&#39;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># TB clinical diagnosis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">register_dx_test</span><span class="p">(</span>
            <span class="n">tb_clinical</span><span class="o">=</span><span class="n">DxTest</span><span class="p">(</span>
                <span class="nb">property</span><span class="o">=</span><span class="s2">&quot;tb_inf&quot;</span><span class="p">,</span>
                <span class="n">target_categories</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;active&quot;</span><span class="p">],</span>
                <span class="n">sensitivity</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;sens_clinical&quot;</span><span class="p">],</span>
                <span class="n">specificity</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;spec_clinical&quot;</span><span class="p">],</span>
                <span class="n">item_codes</span><span class="o">=</span><span class="p">[]</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># 4) -------- Define the treatment options --------</span>
        <span class="c1"># treatment supplied as full kits for duration of treatment</span>
        <span class="c1"># adult treatment - primary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;tb_tx_adult&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">hs</span><span class="o">.</span><span class="n">get_item_code_from_item_name</span><span class="p">(</span><span class="s2">&quot;Cat. I &amp; III Patient Kit A&quot;</span><span class="p">)</span>

        <span class="c1"># child treatment - primary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;tb_tx_child&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">hs</span><span class="o">.</span><span class="n">get_item_code_from_item_name</span><span class="p">(</span><span class="s2">&quot;Cat. I &amp; III Patient Kit B&quot;</span><span class="p">)</span>

        <span class="c1"># adult treatment - secondary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;tb_retx_adult&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">hs</span><span class="o">.</span><span class="n">get_item_code_from_item_name</span><span class="p">(</span><span class="s2">&quot;Cat. II Patient Kit A1&quot;</span><span class="p">)</span>

        <span class="c1"># child treatment - secondary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;tb_retx_child&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">hs</span><span class="o">.</span><span class="n">get_item_code_from_item_name</span><span class="p">(</span><span class="s2">&quot;Cat. II Patient Kit A2&quot;</span><span class="p">)</span>

        <span class="c1"># mdr treatment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;tb_mdrtx&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">hs</span><span class="o">.</span><span class="n">get_item_code_from_item_name</span><span class="p">(</span><span class="s2">&quot;Treatment: second-line drugs&quot;</span><span class="p">)</span>

        <span class="c1"># ipt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;tb_ipt&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">hs</span><span class="o">.</span><span class="n">get_item_code_from_item_name</span><span class="p">(</span><span class="s2">&quot;Isoniazid/Pyridoxine, tablet 300 mg&quot;</span><span class="p">)</span>

        <span class="c1"># 3hp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;tb_3HP&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">hs</span><span class="o">.</span><span class="n">get_item_code_from_item_name</span><span class="p">(</span><span class="s2">&quot;Isoniazid/Rifapentine&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Tb.initialise_population">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.Tb.initialise_population">[docs]</a>
    <span class="k">def</span> <span class="nf">initialise_population</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>

        <span class="c1"># if HIV is not registered, create a dummy property</span>
        <span class="k">if</span> <span class="s2">&quot;Hiv&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
            <span class="n">population</span><span class="o">.</span><span class="n">make_test_property</span><span class="p">(</span><span class="s2">&quot;hv_inf&quot;</span><span class="p">,</span> <span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">)</span>
            <span class="n">population</span><span class="o">.</span><span class="n">make_test_property</span><span class="p">(</span><span class="s2">&quot;sy_aids_symptoms&quot;</span><span class="p">,</span> <span class="n">Types</span><span class="o">.</span><span class="n">INT</span><span class="p">)</span>
            <span class="n">population</span><span class="o">.</span><span class="n">make_test_property</span><span class="p">(</span><span class="s2">&quot;hv_art&quot;</span><span class="p">,</span> <span class="n">Types</span><span class="o">.</span><span class="n">STRING</span><span class="p">)</span>

            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;hv_inf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;sy_aids_symptoms&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;hv_art&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;not&quot;</span>

        <span class="c1"># Set our property values for the initial population</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tb_inf&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:]</span> <span class="o">=</span> <span class="s2">&quot;uninfected&quot;</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tb_strain&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:]</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>

        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tb_date_latent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tb_scheduled_date_active&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tb_date_active&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tb_smear&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># ------------------ testing status ------------------ #</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tb_date_tested&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tb_diagnosed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tb_date_diagnosed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tb_diagnosed_mdr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># ------------------ treatment status ------------------ #</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tb_on_treatment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tb_date_treated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tb_treatment_regimen&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:]</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tb_ever_treated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tb_treatment_failure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tb_on_ipt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tb_date_ipt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>

        <span class="c1"># # ------------------ infection status ------------------ #</span>
        <span class="c1"># WHO estimates of active TB for 2010 to get infected initial population</span>
        <span class="c1"># don&#39;t need to scale or include treated proportion as no-one on treatment yet</span>
        <span class="n">inc_estimates</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;who_incidence_estimates&quot;</span><span class="p">]</span>
        <span class="n">incidence_year</span> <span class="o">=</span> <span class="p">(</span><span class="n">inc_estimates</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">inc_estimates</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">),</span> <span class="s2">&quot;incidence_per_100k&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">100_000</span>

        <span class="n">incidence_year</span> <span class="o">=</span> <span class="n">incidence_year</span> <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;scaling_factor_WHO&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assign_active_tb</span><span class="p">(</span>
            <span class="n">population</span><span class="p">,</span>
            <span class="n">strain</span><span class="o">=</span><span class="s2">&quot;ds&quot;</span><span class="p">,</span>
            <span class="n">incidence</span><span class="o">=</span><span class="n">incidence_year</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assign_active_tb</span><span class="p">(</span>
            <span class="n">population</span><span class="p">,</span>
            <span class="n">strain</span><span class="o">=</span><span class="s2">&quot;mdr&quot;</span><span class="p">,</span>
            <span class="n">incidence</span><span class="o">=</span><span class="n">incidence_year</span> <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;prop_mdr2010&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">send_for_screening_general</span><span class="p">(</span>
            <span class="n">population</span>
        <span class="p">)</span>  <span class="c1"># send some baseline population for screening</span></div>


<div class="viewcode-block" id="Tb.initialise_simulation">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.Tb.initialise_simulation">[docs]</a>
    <span class="k">def</span> <span class="nf">initialise_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        * 1) Schedule the regular TB events</span>
<span class="sd">        * 2) schedule logging</span>
<span class="sd">        * 3) Define the DxTests and treatment options</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># 1) Regular events</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">TbActiveEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">TbRegularEvents</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">TbSelfCureEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">TbActiveCasePoll</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># 2) log at the end of the year</span>
        <span class="c1"># Optional: Schedule the scale-up of programs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;type_of_scaleup&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="n">scaleup_start_date</span> <span class="o">=</span> <span class="n">Date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;scaleup_start_year&quot;</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">scaleup_start_date</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">start_date</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Date </span><span class="si">{</span><span class="n">scaleup_start_date</span><span class="si">}</span><span class="s2"> is before simulation starts.&quot;</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">TbScaleUpEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">scaleup_start_date</span><span class="p">)</span>

        <span class="c1"># 2) log at the end of the year</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">TbLoggingEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># 3) Define the DxTests and get the consumables required</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_consumables_for_dx_and_tx</span><span class="p">()</span>

        <span class="c1"># 4) (Optionally) Schedule the event to check the configuration of all properties</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_with_checks</span><span class="p">:</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
                <span class="n">TbCheckPropertiesEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Tb.update_parameters_for_program_scaleup">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.Tb.update_parameters_for_program_scaleup">[docs]</a>
    <span class="k">def</span> <span class="nf">update_parameters_for_program_scaleup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; options for program scale-up are &#39;target&#39; or &#39;max&#39; &quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">scaled_params_workbook</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;scaleup_parameters&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;type_of_scaleup&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;target&#39;</span><span class="p">:</span>
            <span class="n">scaled_params</span> <span class="o">=</span> <span class="n">scaled_params_workbook</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;parameter&#39;</span><span class="p">)[</span><span class="s1">&#39;target_value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scaled_params</span> <span class="o">=</span> <span class="n">scaled_params_workbook</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;parameter&#39;</span><span class="p">)[</span><span class="s1">&#39;max_value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="c1"># scale-up TB program</span>
        <span class="c1"># use NTP treatment rates</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rate_testing_active_tb&quot;</span><span class="p">][</span><span class="s2">&quot;treatment_coverage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaled_params</span><span class="p">[</span><span class="s2">&quot;tb_treatment_coverage&quot;</span><span class="p">]</span>

        <span class="c1"># increase tb treatment success rates</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prob_tx_success_ds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaled_params</span><span class="p">[</span><span class="s2">&quot;tb_prob_tx_success_ds&quot;</span><span class="p">]</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prob_tx_success_mdr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaled_params</span><span class="p">[</span><span class="s2">&quot;tb_prob_tx_success_mdr&quot;</span><span class="p">]</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prob_tx_success_0_4&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaled_params</span><span class="p">[</span><span class="s2">&quot;tb_prob_tx_success_0_4&quot;</span><span class="p">]</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prob_tx_success_5_14&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaled_params</span><span class="p">[</span><span class="s2">&quot;tb_prob_tx_success_5_14&quot;</span><span class="p">]</span>

        <span class="c1"># change first-line testing for TB to xpert</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;first_line_test&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaled_params</span><span class="p">[</span><span class="s2">&quot;first_line_test&quot;</span><span class="p">]</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;second_line_test&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaled_params</span><span class="p">[</span><span class="s2">&quot;second_line_test&quot;</span><span class="p">]</span>

        <span class="c1"># increase coverage of IPT</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;ipt_coverage&quot;</span><span class="p">][</span><span class="s2">&quot;coverage_plhiv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaled_params</span><span class="p">[</span><span class="s2">&quot;ipt_coverage_plhiv&quot;</span><span class="p">]</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;ipt_coverage&quot;</span><span class="p">][</span><span class="s2">&quot;coverage_paediatric&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaled_params</span><span class="p">[</span><span class="s2">&quot;ipt_coverage_paediatric&quot;</span><span class="p">]</span>

        <span class="c1"># update exising linear models to use new scaled-up paramters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_linear_models</span><span class="p">()</span></div>


<div class="viewcode-block" id="Tb.on_birth">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.Tb.on_birth">[docs]</a>
    <span class="k">def</span> <span class="nf">on_birth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mother_id</span><span class="p">,</span> <span class="n">child_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialise properties for a newborn individual</span>
<span class="sd">        allocate IPT for child if mother diagnosed with TB</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>

        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;tb_inf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;uninfected&quot;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;tb_strain&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>

        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;tb_date_latent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;tb_scheduled_date_active&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;tb_date_active&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;tb_smear&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># ------------------ testing status ------------------ #</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;tb_date_tested&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>

        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;tb_diagnosed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;tb_date_diagnosed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;tb_diagnosed_mdr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># ------------------ treatment status ------------------ #</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;tb_on_treatment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;tb_date_treated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;tb_treatment_regimen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;tb_treatment_failure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;tb_ever_treated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;tb_on_ipt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;tb_date_ipt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>

        <span class="k">if</span> <span class="s2">&quot;Hiv&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;hv_inf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;sy_aids_symptoms&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;hv_art&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;not&quot;</span>

        <span class="c1"># Not interested in whether true or direct birth</span>
        <span class="c1"># give IPT to child of TB diagnosed mother if 2014 or later</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">mother_id</span><span class="p">),</span> <span class="s2">&quot;tb_diagnosed&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;ipt_start_date&quot;</span><span class="p">]):</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">HSI_Tb_Start_or_Continue_Ipt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">child_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">event</span><span class="p">,</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">topen</span><span class="o">=</span><span class="n">now</span><span class="p">,</span>
                <span class="n">tclose</span><span class="o">=</span><span class="n">now</span> <span class="o">+</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">28</span><span class="p">),</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Tb.report_daly_values">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.Tb.report_daly_values">[docs]</a>
    <span class="k">def</span> <span class="nf">report_daly_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This must send back a pd.Series or pd.DataFrame that reports on the average daly-weights that have been</span>
<span class="sd">        experienced by persons in the previous month. Only rows for alive-persons must be returned.</span>
<span class="sd">        The names of the series of columns is taken to be the label of the cause of this disability.</span>
<span class="sd">        It will be recorded by the healthburden module as &lt;ModuleName&gt;_&lt;Cause&gt;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>  <span class="c1"># shortcut to population properties dataframe</span>

        <span class="c1"># to avoid errors when hiv module not running</span>
        <span class="n">df_tmp</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">]</span>
        <span class="n">health_values</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="c1"># hiv-negative</span>
        <span class="n">health_values</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">tb_inf</span> <span class="o">==</span> <span class="s2">&quot;active&quot;</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">tb_strain</span> <span class="o">==</span> <span class="s2">&quot;ds&quot;</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="o">~</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">hv_inf</span>
            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">daly_wts</span><span class="p">[</span><span class="s2">&quot;daly_tb&quot;</span><span class="p">]</span>

        <span class="n">health_values</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">tb_inf</span> <span class="o">==</span> <span class="s2">&quot;active&quot;</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">tb_strain</span> <span class="o">==</span> <span class="s2">&quot;mdr&quot;</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="o">~</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">hv_inf</span>
            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">daly_wts</span><span class="p">[</span><span class="s2">&quot;daly_tb&quot;</span><span class="p">]</span>

        <span class="c1"># hiv-positive</span>
        <span class="n">health_values</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">tb_inf</span> <span class="o">==</span> <span class="s2">&quot;active&quot;</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">tb_strain</span> <span class="o">==</span> <span class="s2">&quot;ds&quot;</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="n">df_tmp</span><span class="o">.</span><span class="n">hv_inf</span>
            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">daly_wts</span><span class="p">[</span><span class="s2">&quot;daly_tb_hiv&quot;</span><span class="p">]</span>

        <span class="n">health_values</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">tb_inf</span> <span class="o">==</span> <span class="s2">&quot;active&quot;</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">tb_strain</span> <span class="o">==</span> <span class="s2">&quot;mdr&quot;</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="n">df_tmp</span><span class="o">.</span><span class="n">hv_inf</span>
            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">daly_wts</span><span class="p">[</span><span class="s2">&quot;daly_mdr_tb_hiv&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">health_values</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">]</span></div>


<div class="viewcode-block" id="Tb.calculate_untreated_proportion">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.Tb.calculate_untreated_proportion">[docs]</a>
    <span class="k">def</span> <span class="nf">calculate_untreated_proportion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">,</span> <span class="n">strain</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        calculate the proportion of active TB cases not on correct treatment</span>
<span class="sd">        if mdr-tb and on first-line treatment, count case as untreated</span>
<span class="sd">        they will continue to contribute to transmission</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="c1"># sum active tb cases</span>
        <span class="n">num_active_tb_cases</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_inf</span> <span class="o">==</span> <span class="s2">&quot;active&quot;</span><span class="p">)</span> <span class="o">&amp;</span>
                                     <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_strain</span> <span class="o">==</span> <span class="n">strain</span><span class="p">)</span> <span class="o">&amp;</span>
                                     <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">])</span>

        <span class="c1"># sum treated active tb cases</span>
        <span class="c1"># if mdr-tb must be on mdr treatment, otherwise consider as untreated case</span>
        <span class="k">if</span> <span class="n">strain</span> <span class="o">==</span> <span class="s2">&quot;mdr&quot;</span><span class="p">:</span>
            <span class="n">num_treated_tb_cases</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_inf</span> <span class="o">==</span> <span class="s2">&quot;active&quot;</span><span class="p">)</span> <span class="o">&amp;</span>
                                          <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_strain</span> <span class="o">==</span> <span class="n">strain</span><span class="p">)</span> <span class="o">&amp;</span>
                                          <span class="n">df</span><span class="o">.</span><span class="n">tb_on_treatment</span> <span class="o">&amp;</span>
                                          <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_treatment_regimen</span> <span class="o">==</span> <span class="s2">&quot;tb_mdrtx&quot;</span><span class="p">)</span> <span class="o">&amp;</span>
                                          <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_treated_tb_cases</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_inf</span> <span class="o">==</span> <span class="s2">&quot;active&quot;</span><span class="p">)</span> <span class="o">&amp;</span>
                                          <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_strain</span> <span class="o">==</span> <span class="n">strain</span><span class="p">)</span> <span class="o">&amp;</span>
                                          <span class="n">df</span><span class="o">.</span><span class="n">tb_on_treatment</span> <span class="o">&amp;</span>
                                          <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">])</span>

        <span class="n">prop_untreated</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">num_treated_tb_cases</span> <span class="o">/</span> <span class="n">num_active_tb_cases</span><span class="p">)</span> <span class="k">if</span> <span class="n">num_active_tb_cases</span> <span class="k">else</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">prop_untreated</span></div>


<div class="viewcode-block" id="Tb.assign_active_tb">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.Tb.assign_active_tb">[docs]</a>
    <span class="k">def</span> <span class="nf">assign_active_tb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">,</span> <span class="n">strain</span><span class="p">,</span> <span class="n">incidence</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        select individuals to be infected</span>
<span class="sd">        assign scheduled date of active tb onset</span>
<span class="sd">        update properties as needed</span>
<span class="sd">        symptoms and smear status are assigned in the TbActiveEvent</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span>
        <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>

        <span class="c1"># identify eligible people, not currently with active tb infection</span>
        <span class="n">eligible</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_inf</span> <span class="o">!=</span> <span class="s2">&quot;active&quot;</span><span class="p">)</span>
            <span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># weight risk by individual characteristics</span>
        <span class="c1"># Compute chance that each susceptible person becomes infected:</span>
        <span class="n">rr_of_infection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s2">&quot;active_tb&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">eligible</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1">#  probability of infection</span>
        <span class="n">p_infection</span> <span class="o">=</span> <span class="p">(</span><span class="n">rr_of_infection</span> <span class="o">*</span> <span class="n">incidence</span><span class="p">)</span>

        <span class="c1"># New infections:</span>
        <span class="n">will_be_infected</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p_infection</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">p_infection</span>
        <span class="p">)</span>
        <span class="n">idx_new_infection</span> <span class="o">=</span> <span class="n">will_be_infected</span><span class="p">[</span><span class="n">will_be_infected</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx_new_infection</span><span class="p">,</span> <span class="s2">&quot;tb_strain&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strain</span>

        <span class="c1"># schedule onset of active tb, time now up to 1 year</span>
        <span class="k">for</span> <span class="n">person_id</span> <span class="ow">in</span> <span class="n">idx_new_infection</span><span class="p">:</span>
            <span class="n">date_progression</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span>
                <span class="n">days</span><span class="o">=</span><span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">365</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># set date of active tb - properties will be updated at TbActiveEvent poll daily</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_scheduled_date_active&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_progression</span></div>


<div class="viewcode-block" id="Tb.consider_ipt_for_those_initiating_art">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.Tb.consider_ipt_for_those_initiating_art">[docs]</a>
    <span class="k">def</span> <span class="nf">consider_ipt_for_those_initiating_art</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        this is called by HIV when person is initiating ART</span>
<span class="sd">        checks whether person is eligible for IPT</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_diagnosed&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_diagnosed_mdr&quot;</span><span class="p">]:</span>
            <span class="k">pass</span>

        <span class="n">high_risk_districts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;tb_high_risk_distr&quot;</span><span class="p">]</span>
        <span class="n">district</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;district_of_residence&quot;</span><span class="p">]</span>
        <span class="n">eligible</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_inf&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;active&quot;</span>

        <span class="c1"># select coverage rate by year:</span>
        <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">year</span> <span class="k">if</span> <span class="n">now</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;=</span> <span class="mi">2050</span> <span class="k">else</span> <span class="mi">2050</span>

        <span class="n">ipt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;ipt_coverage&quot;</span><span class="p">]</span>
        <span class="n">ipt_year</span> <span class="o">=</span> <span class="n">ipt</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ipt</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year</span><span class="p">]</span>
        <span class="n">ipt_coverage_plhiv</span> <span class="o">=</span> <span class="n">ipt_year</span><span class="o">.</span><span class="n">coverage_plhiv</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">district</span> <span class="ow">in</span> <span class="n">high_risk_districts</span><span class="o">.</span><span class="n">district_name</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="n">eligible</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">ipt_coverage_plhiv</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="c1"># Schedule the TB treatment event:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">HSI_Tb_Start_or_Continue_Ipt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">),</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Tb.relapse_event">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.Tb.relapse_event">[docs]</a>
    <span class="k">def</span> <span class="nf">relapse_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The Tb Regular Relapse Event</span>
<span class="sd">        runs every month to randomly sample amongst those previously infected with active tb</span>
<span class="sd">        * Schedules persons who have previously been infected to relapse with a set probability</span>
<span class="sd">        * Sets a scheduled_date_active which is picked up by TbActiveEvent</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span>
        <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>

        <span class="c1"># need a monthly relapse for every person in df</span>
        <span class="c1"># should return risk=0 for everyone not eligible for relapse</span>

        <span class="c1"># risk of relapse if &lt;2 years post treatment start, includes risk if HIV+</span>
        <span class="n">risk_of_relapse_early</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s2">&quot;risk_relapse_2yrs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                   <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">tb_ever_treated</span>
                   <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_inf</span> <span class="o">==</span> <span class="s2">&quot;latent&quot;</span><span class="p">)</span>
                   <span class="o">&amp;</span> <span class="p">(</span><span class="n">now</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_date_treated</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">2</span><span class="p">)))]</span>
        <span class="p">)</span>

        <span class="n">will_relapse</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">risk_of_relapse_early</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">risk_of_relapse_early</span>
        <span class="p">)</span>
        <span class="n">idx_will_relapse_early</span> <span class="o">=</span> <span class="n">will_relapse</span><span class="p">[</span><span class="n">will_relapse</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># risk of relapse if &gt;=2 years post treatment start, includes risk if HIV+</span>
        <span class="n">risk_of_relapse_later</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s2">&quot;risk_relapse_late&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                   <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">tb_ever_treated</span>
                   <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_inf</span> <span class="o">==</span> <span class="s2">&quot;latent&quot;</span><span class="p">)</span>
                   <span class="o">&amp;</span> <span class="p">(</span><span class="n">now</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_date_treated</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">2</span><span class="p">)))]</span>
        <span class="p">)</span>

        <span class="n">will_relapse_later</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">risk_of_relapse_later</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">risk_of_relapse_later</span>
        <span class="p">)</span>
        <span class="n">idx_will_relapse_late2</span> <span class="o">=</span> <span class="n">will_relapse_later</span><span class="p">[</span><span class="n">will_relapse_later</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># join both indices</span>
        <span class="n">idx_will_relapse</span> <span class="o">=</span> <span class="n">idx_will_relapse_early</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
            <span class="n">idx_will_relapse_late2</span>
        <span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

        <span class="c1"># set date of scheduled active tb</span>
        <span class="c1"># properties will be updated at TbActiveEvent every month</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx_will_relapse</span><span class="p">,</span> <span class="s2">&quot;tb_scheduled_date_active&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span></div>


<div class="viewcode-block" id="Tb.end_treatment">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.Tb.end_treatment">[docs]</a>
    <span class="k">def</span> <span class="nf">end_treatment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         * check for those eligible to finish treatment</span>
<span class="sd">         * sample for treatment failure and refer for follow-up screening/testing</span>
<span class="sd">         * if treatment has finished, change individual properties</span>
<span class="sd">         &quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span>
        <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>

        <span class="c1"># check across population on tb treatment and end treatment if required</span>
        <span class="c1"># if current date is after (treatment start date + treatment length) -&gt; end tx</span>

        <span class="c1"># ---------------------- treatment end: first case ds-tb (6 months) ---------------------- #</span>
        <span class="c1"># end treatment for new tb (ds) cases</span>
        <span class="n">end_ds_tx_idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
            <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">tb_on_treatment</span>
            <span class="o">&amp;</span> <span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">tb_treatment_regimen</span> <span class="o">==</span> <span class="s2">&quot;tb_tx_adult&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_treatment_regimen</span> <span class="o">==</span> <span class="s2">&quot;tb_tx_child&quot;</span><span class="p">))</span>
            <span class="o">&amp;</span> <span class="p">(</span>
                <span class="n">now</span>
                <span class="o">&gt;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_date_treated</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;ds_treatment_length&quot;</span><span class="p">]))</span>
            <span class="p">)</span>
            <span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># ---------------------- treatment end: retreatment ds-tb (7 months) ---------------------- #</span>
        <span class="c1"># end treatment for retreatment cases</span>
        <span class="n">end_ds_retx_idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
            <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">tb_on_treatment</span>
            <span class="o">&amp;</span> <span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">tb_treatment_regimen</span> <span class="o">==</span> <span class="s2">&quot;tb_retx_adult&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_treatment_regimen</span> <span class="o">==</span> <span class="s2">&quot;tb_retx_child&quot;</span><span class="p">))</span>
            <span class="o">&amp;</span> <span class="p">(</span>
                <span class="n">now</span>
                <span class="o">&gt;</span> <span class="p">(</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">tb_date_treated</span>
                    <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;ds_retreatment_length&quot;</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># ---------------------- treatment end: mdr-tb (24 months) ---------------------- #</span>
        <span class="c1"># end treatment for mdr-tb cases</span>
        <span class="n">end_mdr_tx_idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
            <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">tb_on_treatment</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_treatment_regimen</span> <span class="o">==</span> <span class="s2">&quot;tb_mdrtx&quot;</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span>
                <span class="n">now</span>
                <span class="o">&gt;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_date_treated</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;mdr_treatment_length&quot;</span><span class="p">]))</span>
            <span class="p">)</span>
            <span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># join indices</span>
        <span class="n">end_tx_idx</span> <span class="o">=</span> <span class="n">end_ds_tx_idx</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">end_ds_retx_idx</span><span class="p">)</span>
        <span class="n">end_tx_idx</span> <span class="o">=</span> <span class="n">end_tx_idx</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">end_mdr_tx_idx</span><span class="p">)</span>

        <span class="c1"># ---------------------- treatment failure ---------------------- #</span>
        <span class="c1"># sample some to have treatment failure</span>
        <span class="c1"># assume all retreatment cases will cure</span>
        <span class="n">random_var</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>

        <span class="c1"># children aged 0-4 ds-tb</span>
        <span class="n">ds_tx_failure0_4_idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">end_ds_tx_idx</span><span class="p">))</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">random_var</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prob_tx_success_0_4&quot;</span><span class="p">]))</span>
            <span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># children aged 5-14 ds-tb</span>
        <span class="n">ds_tx_failure5_14_idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">end_ds_tx_idx</span><span class="p">))</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">random_var</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prob_tx_success_5_14&quot;</span><span class="p">]))</span>
            <span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># adults ds-tb</span>
        <span class="n">ds_tx_failure_adult_idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">end_ds_tx_idx</span><span class="p">))</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">random_var</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prob_tx_success_ds&quot;</span><span class="p">]))</span>
            <span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># all mdr cases on ds tx will fail</span>
        <span class="n">failure_in_mdr_with_ds_tx_idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">end_ds_tx_idx</span><span class="p">))</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_strain</span> <span class="o">==</span> <span class="s2">&quot;mdr&quot;</span><span class="p">)</span>
            <span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># some mdr cases on mdr treatment will fail</span>
        <span class="n">failure_due_to_mdr_idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">end_mdr_tx_idx</span><span class="p">))</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_strain</span> <span class="o">==</span> <span class="s2">&quot;mdr&quot;</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">random_var</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prob_tx_success_mdr&quot;</span><span class="p">]))</span>
            <span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># join indices of failing cases together</span>
        <span class="n">tx_failure</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="o">.</span><span class="n">union</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="n">ds_tx_failure0_4_idx</span><span class="p">,</span>
                <span class="n">ds_tx_failure5_14_idx</span><span class="p">,</span>
                <span class="n">ds_tx_failure_adult_idx</span><span class="p">,</span>
                <span class="n">failure_in_mdr_with_ds_tx_idx</span><span class="p">,</span>
                <span class="n">failure_due_to_mdr_idx</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">tx_failure</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tx_failure</span><span class="p">,</span> <span class="s2">&quot;tb_treatment_failure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">tx_failure</span><span class="p">,</span> <span class="s2">&quot;tb_ever_treated&quot;</span>
            <span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># ensure classed as retreatment case</span>

            <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">tx_failure</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                    <span class="n">HSI_Tb_ScreeningAndRefer</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="p">),</span>
                    <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                    <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># remove any treatment failure indices from the treatment end indices</span>
        <span class="n">cure_idx</span> <span class="o">=</span> <span class="n">end_tx_idx</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">tx_failure</span><span class="p">)</span>

        <span class="c1"># change individual properties for all to off treatment</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">end_tx_idx</span><span class="p">,</span> <span class="s2">&quot;tb_diagnosed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">end_tx_idx</span><span class="p">,</span> <span class="s2">&quot;tb_on_treatment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">end_tx_idx</span><span class="p">,</span> <span class="s2">&quot;tb_treated_mdr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># this will indicate that this person has had one complete course of tb treatment</span>
        <span class="c1"># subsequent infections will be classified as retreatment</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">end_tx_idx</span><span class="p">,</span> <span class="s2">&quot;tb_ever_treated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># if cured, move infection status back to latent</span>
        <span class="c1"># leave tb_strain property set in case of relapse</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cure_idx</span><span class="p">,</span> <span class="s2">&quot;tb_inf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;latent&quot;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cure_idx</span><span class="p">,</span> <span class="s2">&quot;tb_date_latent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cure_idx</span><span class="p">,</span> <span class="s2">&quot;tb_smear&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># this will clear all tb symptoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;SymptomManager&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">clear_symptoms</span><span class="p">(</span>
            <span class="n">person_id</span><span class="o">=</span><span class="n">cure_idx</span><span class="p">,</span> <span class="n">disease_module</span><span class="o">=</span><span class="bp">self</span>
        <span class="p">)</span>

        <span class="c1"># if HIV+ and on ART (virally suppressed), remove AIDS symptoms if cured of TB</span>
        <span class="n">hiv_tb_infected</span> <span class="o">=</span> <span class="n">cure_idx</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_art</span> <span class="o">==</span> <span class="s2">&quot;on_VL_suppressed&quot;</span><span class="p">)</span>
                <span class="p">]</span><span class="o">.</span><span class="n">index</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;SymptomManager&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">clear_symptoms</span><span class="p">(</span>
            <span class="n">person_id</span><span class="o">=</span><span class="n">hiv_tb_infected</span><span class="p">,</span> <span class="n">disease_module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;Hiv&quot;</span><span class="p">]</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Tb.check_config_of_properties">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.Tb.check_config_of_properties">[docs]</a>
    <span class="k">def</span> <span class="nf">check_config_of_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;check that the properties are currently configured correctly&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">df_alive</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">]</span>

        <span class="c1"># basic check types of columns and dtypes</span>
        <span class="n">orig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">new_row</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dtypes</span> <span class="o">==</span> <span class="n">orig</span><span class="o">.</span><span class="n">dtypes</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">is_subset</span><span class="p">(</span><span class="n">col_for_set</span><span class="p">,</span> <span class="n">col_for_subset</span><span class="p">):</span>
            <span class="c1"># Confirms that the series of col_for_subset is true only for a subset of the series for col_for_set</span>
            <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">col_for_subset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">col_for_subset</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span>
                <span class="n">col_for_set</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">col_for_set</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
            <span class="p">)</span>

        <span class="c1"># Check that core properties of current status are never None/NaN/NaT</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">df_alive</span><span class="o">.</span><span class="n">tb_inf</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">df_alive</span><span class="o">.</span><span class="n">tb_strain</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">df_alive</span><span class="o">.</span><span class="n">tb_smear</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">df_alive</span><span class="o">.</span><span class="n">tb_on_treatment</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">df_alive</span><span class="o">.</span><span class="n">tb_treatment_regimen</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">df_alive</span><span class="o">.</span><span class="n">tb_ever_treated</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">df_alive</span><span class="o">.</span><span class="n">tb_on_ipt</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>

        <span class="c1"># Check that the core TB properties are &#39;nested&#39; in the way expected.</span>
        <span class="k">assert</span> <span class="n">is_subset</span><span class="p">(</span>
            <span class="n">col_for_set</span><span class="o">=</span><span class="p">(</span><span class="n">df_alive</span><span class="o">.</span><span class="n">tb_inf</span> <span class="o">!=</span> <span class="s2">&quot;uninfected&quot;</span><span class="p">),</span> <span class="n">col_for_subset</span><span class="o">=</span><span class="n">df_alive</span><span class="o">.</span><span class="n">tb_diagnosed</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">is_subset</span><span class="p">(</span>
            <span class="n">col_for_set</span><span class="o">=</span><span class="n">df_alive</span><span class="o">.</span><span class="n">tb_diagnosed</span><span class="p">,</span> <span class="n">col_for_subset</span><span class="o">=</span><span class="n">df_alive</span><span class="o">.</span><span class="n">tb_on_treatment</span>
        <span class="p">)</span>

        <span class="c1"># Check that if person is infected, the dates of active TB is NOT missing</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_inf</span> <span class="o">==</span> <span class="s2">&quot;active&quot;</span><span class="p">),</span> <span class="s2">&quot;tb_date_active&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></div>
</div>



<span class="c1"># # ---------------------------------------------------------------------------</span>
<span class="c1"># #   TB infection event</span>
<span class="c1"># # ---------------------------------------------------------------------------</span>


<div class="viewcode-block" id="TbActiveCasePoll">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.TbActiveCasePoll">[docs]</a>
<span class="k">class</span> <span class="nc">TbActiveCasePoll</span><span class="p">(</span><span class="n">RegularEvent</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The Tb Regular Poll Event for assigning active infections</span>
<span class="sd">    * selects people for active infection and schedules onset of active tb</span>
<span class="sd">    assign_active_tb uses a transmission model to assign new cases</span>
<span class="sd">    import_tb simulates importation of active tb independent of current prevalence</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TbActiveCasePoll.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.TbActiveCasePoll.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span></div>


<div class="viewcode-block" id="TbActiveCasePoll.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.TbActiveCasePoll.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span>

        <span class="n">current_year</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;data_end&quot;</span><span class="p">])</span>

        <span class="n">inc_estimates</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;who_incidence_estimates&quot;</span><span class="p">]</span>
        <span class="n">incidence_year</span> <span class="o">=</span> <span class="p">(</span><span class="n">inc_estimates</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">inc_estimates</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">current_year</span><span class="p">),</span> <span class="s2">&quot;incidence_per_100k&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">100000</span>

        <span class="n">prop_untreated_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">calculate_untreated_proportion</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">strain</span><span class="o">=</span><span class="s2">&quot;ds&quot;</span><span class="p">)</span>
        <span class="n">prop_untreated_mdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">calculate_untreated_proportion</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">strain</span><span class="o">=</span><span class="s2">&quot;mdr&quot;</span><span class="p">)</span>

        <span class="n">scaled_incidence_ds</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">incidence_year</span> <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;scaling_factor_WHO&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">prop_untreated_ds</span>
        <span class="p">)</span>
        <span class="n">scaled_incidence_mdr</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">incidence_year</span>
            <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prop_mdr2010&quot;</span><span class="p">]</span>
            <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;scaling_factor_WHO&quot;</span><span class="p">]</span>
            <span class="o">*</span> <span class="n">prop_untreated_mdr</span>
        <span class="p">)</span>

        <span class="c1"># transmission ds-tb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">assign_active_tb</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">strain</span><span class="o">=</span><span class="s2">&quot;ds&quot;</span><span class="p">,</span> <span class="n">incidence</span><span class="o">=</span><span class="n">scaled_incidence_ds</span><span class="p">)</span>

        <span class="c1"># transmission mdr-tb, around 1% of total tb incidence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">assign_active_tb</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">strain</span><span class="o">=</span><span class="s2">&quot;mdr&quot;</span><span class="p">,</span> <span class="n">incidence</span><span class="o">=</span><span class="n">scaled_incidence_mdr</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TbRegularEvents">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.TbRegularEvents">[docs]</a>
<span class="k">class</span> <span class="nc">TbRegularEvents</span><span class="p">(</span><span class="n">RegularEvent</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This event runs each month and calls three functions:</span>
<span class="sd">    * scheduling TB screening for the general population</span>
<span class="sd">    * ending treatment if end of treatment regimen has been reached</span>
<span class="sd">    * determining who will relapse after a primary infection</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TbRegularEvents.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.TbRegularEvents.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span></div>


<div class="viewcode-block" id="TbRegularEvents.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.TbRegularEvents.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
        <span class="c1"># schedule some background rates of tb testing (non-symptom-driven)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">send_for_screening_general</span><span class="p">(</span><span class="n">population</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">end_treatment</span><span class="p">(</span><span class="n">population</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">relapse_event</span><span class="p">(</span><span class="n">population</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TbScaleUpEvent">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.TbScaleUpEvent">[docs]</a>
<span class="k">class</span> <span class="nc">TbScaleUpEvent</span><span class="p">(</span><span class="n">Event</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; This event exists to change parameters or functions</span>
<span class="sd">    depending on the scenario for projections which has been set</span>
<span class="sd">    It only occurs once on date: scaleup_start_date,</span>
<span class="sd">    called by initialise_simulation</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TbScaleUpEvent.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.TbScaleUpEvent.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">)</span></div>


<div class="viewcode-block" id="TbScaleUpEvent.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.TbScaleUpEvent.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">update_parameters_for_program_scaleup</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="TbActiveEvent">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.TbActiveEvent">[docs]</a>
<span class="k">class</span> <span class="nc">TbActiveEvent</span><span class="p">(</span><span class="n">RegularEvent</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    * check for those with dates of active tb onset within last time-period</span>
<span class="sd">    *1 change individual properties for active disease</span>
<span class="sd">    *2 assign symptoms</span>
<span class="sd">    *3 if HIV+, assign smear status and schedule AIDS onset</span>
<span class="sd">    *4 if HIV-, assign smear status and schedule death</span>
<span class="sd">    *5 schedule screening for symptomatic active cases</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TbActiveEvent.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.TbActiveEvent.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">repeat</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">))</span></div>


<div class="viewcode-block" id="TbActiveEvent.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.TbActiveEvent.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span>

        <span class="c1"># find people eligible for progression to active disease</span>
        <span class="c1"># date of active disease scheduled to occur this week</span>
        <span class="c1"># some will be scheduled for future dates</span>
        <span class="c1"># if on IPT or treatment - do nothing</span>
        <span class="n">active_idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_scheduled_date_active</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">now</span> <span class="o">+</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_scheduled_date_active</span> <span class="o">&gt;=</span> <span class="n">now</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">tb_on_ipt</span>
            <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">tb_on_treatment</span>
            <span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="k">if</span> <span class="n">active_idx</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># -------- 1) change individual properties for active disease --------</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">active_idx</span><span class="p">,</span> <span class="s2">&quot;tb_inf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;active&quot;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">active_idx</span><span class="p">,</span> <span class="s2">&quot;tb_date_active&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">active_idx</span><span class="p">,</span> <span class="s2">&quot;tb_smear&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># default property</span>

        <span class="c1"># -------- 2) assign symptoms --------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;SymptomManager&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">change_symptom</span><span class="p">(</span>
            <span class="n">person_id</span><span class="o">=</span><span class="n">active_idx</span><span class="p">,</span>
            <span class="n">symptom_string</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">symptom_list</span><span class="p">,</span>
            <span class="n">add_or_remove</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
            <span class="n">disease_module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span>
            <span class="n">duration_in_days</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># -------- 3) if HIV+ assign smear status and schedule AIDS onset --------</span>
        <span class="n">active_and_hiv</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">active_idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># lower probability of being smear positive than HIV-</span>
        <span class="n">smear_pos</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">active_and_hiv</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prop_smear_positive_hiv&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">active_and_hiv_smear_pos</span> <span class="o">=</span> <span class="n">active_and_hiv</span><span class="p">[</span><span class="n">smear_pos</span><span class="p">]</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">active_and_hiv_smear_pos</span><span class="p">,</span> <span class="s2">&quot;tb_smear&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="s2">&quot;Hiv&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">person_id</span> <span class="ow">in</span> <span class="n">active_and_hiv</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
                    <span class="n">hiv</span><span class="o">.</span><span class="n">HivAidsOnsetEvent</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;Hiv&quot;</span><span class="p">],</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">cause</span><span class="o">=</span><span class="s2">&quot;AIDS_TB&quot;</span>
                    <span class="p">),</span>
                    <span class="n">now</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># if Hiv not registered, give HIV+ person same time to death as HIV-</span>
            <span class="k">for</span> <span class="n">person_id</span> <span class="ow">in</span> <span class="n">active_and_hiv</span><span class="p">:</span>
                <span class="n">date_of_tb_death</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span>
                    <span class="n">months</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
                    <span class="n">event</span><span class="o">=</span><span class="n">TbDecideDeathEvent</span><span class="p">(</span>
                        <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">cause</span><span class="o">=</span><span class="s2">&quot;AIDS_TB&quot;</span>
                    <span class="p">),</span>
                    <span class="n">date</span><span class="o">=</span><span class="n">date_of_tb_death</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># -------- 4) if HIV- assign smear status and schedule death --------</span>
        <span class="n">active_no_hiv</span> <span class="o">=</span> <span class="n">active_idx</span><span class="p">[</span><span class="o">~</span><span class="n">active_idx</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">active_and_hiv</span><span class="p">)]</span>
        <span class="n">smear_pos</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">active_no_hiv</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prop_smear_positive&quot;</span><span class="p">]</span>
        <span class="n">active_no_hiv_smear_pos</span> <span class="o">=</span> <span class="n">active_no_hiv</span><span class="p">[</span><span class="n">smear_pos</span><span class="p">]</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">active_no_hiv_smear_pos</span><span class="p">,</span> <span class="s2">&quot;tb_smear&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">person_id</span> <span class="ow">in</span> <span class="n">active_no_hiv</span><span class="p">:</span>
            <span class="n">date_of_tb_death</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span>
                <span class="n">months</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">6</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
                <span class="n">event</span><span class="o">=</span><span class="n">TbDecideDeathEvent</span><span class="p">(</span>
                    <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">cause</span><span class="o">=</span><span class="s2">&quot;TB&quot;</span>
                <span class="p">),</span>
                <span class="n">date</span><span class="o">=</span><span class="n">date_of_tb_death</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># -------- 5) schedule screening for asymptomatic and symptomatic people --------</span>
        <span class="c1"># sample from all NEW active cases (active_idx) and determine whether they will seek a test</span>
        <span class="n">year</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">2019</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span> <span class="n">now</span><span class="o">.</span><span class="n">year</span><span class="p">))</span>

        <span class="n">active_testing_rates</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rate_testing_active_tb&quot;</span><span class="p">]</span>

        <span class="c1"># change to NTP testing rates</span>
        <span class="n">current_active_testing_rate</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">active_testing_rates</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="p">(</span><span class="n">active_testing_rates</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year</span><span class="p">),</span> <span class="s2">&quot;treatment_coverage&quot;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">/</span> <span class="mi">100</span>
        <span class="p">)</span>

        <span class="c1"># multiply testing rate by average treatment availability to match treatment coverage</span>
        <span class="n">current_active_testing_rate</span> <span class="o">=</span> <span class="n">current_active_testing_rate</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mf">0.6</span><span class="p">)</span>

        <span class="n">random_draw</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>

        <span class="c1"># randomly select some symptomatic individuals for screening and testing</span>
        <span class="c1"># would only be screened if have symptoms for &gt;= 14 days</span>
        <span class="c1"># sample some of active_idx to go for screening</span>
        <span class="n">screen_active_idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">active_idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">random_draw</span> <span class="o">&lt;</span> <span class="n">current_active_testing_rate</span><span class="p">))</span>
        <span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># TB screening checks for symptoms lasting at least 14 days, so add delay</span>
        <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">screen_active_idx</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">HSI_Tb_ScreeningAndRefer</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">),</span>
                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">14</span><span class="p">),</span>
                <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TbSelfCureEvent">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.TbSelfCureEvent">[docs]</a>
<span class="k">class</span> <span class="nc">TbSelfCureEvent</span><span class="p">(</span><span class="n">RegularEvent</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;annual event which allows some individuals to self-cure</span>
<span class="sd">    approximate time from infection to self-cure is 3 years</span>
<span class="sd">    HIV+ and not virally suppressed cannot self-cure</span>
<span class="sd">    note that frequency can&#39;t be changed here as parameters are set to annual values</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TbSelfCureEvent.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.TbSelfCureEvent.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="c1"># note frequency must remain at 12 months or edit code below for duration active disease</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">12</span><span class="p">))</span></div>


<div class="viewcode-block" id="TbSelfCureEvent.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.TbSelfCureEvent.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="n">prob_self_cure</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;duration_active_disease_years&quot;</span><span class="p">]</span>

        <span class="c1"># self-cure - move from active to latent, excludes cases that just became active</span>
        <span class="n">random_draw</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>

        <span class="c1"># hiv-negative</span>
        <span class="n">self_cure</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_inf</span> <span class="o">==</span> <span class="s2">&quot;active&quot;</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
            <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_date_active</span> <span class="o">&lt;</span> <span class="n">now</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">random_draw</span> <span class="o">&lt;</span> <span class="n">prob_self_cure</span><span class="p">)</span>
            <span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># hiv-positive, on art and virally suppressed</span>
        <span class="n">self_cure_art</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_inf</span> <span class="o">==</span> <span class="s2">&quot;active&quot;</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
            <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_art</span> <span class="o">==</span> <span class="s2">&quot;on_VL_suppressed&quot;</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_date_active</span> <span class="o">&lt;</span> <span class="n">now</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">random_draw</span> <span class="o">&lt;</span> <span class="n">prob_self_cure</span><span class="p">)</span>
            <span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># resolve symptoms and change properties</span>
        <span class="n">all_self_cure</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">self_cure</span><span class="p">,</span> <span class="o">*</span><span class="n">self_cure_art</span><span class="p">]</span>

        <span class="c1"># leave tb strain set in case of relapse</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">all_self_cure</span><span class="p">,</span> <span class="s2">&quot;tb_inf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;latent&quot;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">all_self_cure</span><span class="p">,</span> <span class="s2">&quot;tb_diagnosed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">all_self_cure</span><span class="p">,</span> <span class="s2">&quot;tb_smear&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># this will clear all tb symptoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;SymptomManager&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">clear_symptoms</span><span class="p">(</span>
            <span class="n">person_id</span><span class="o">=</span><span class="n">all_self_cure</span><span class="p">,</span> <span class="n">disease_module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span>
        <span class="p">)</span>

        <span class="c1"># resolve AIDS symptoms if virally suppressed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;SymptomManager&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">clear_symptoms</span><span class="p">(</span>
            <span class="n">person_id</span><span class="o">=</span><span class="n">self_cure_art</span><span class="p">,</span> <span class="n">disease_module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;Hiv&quot;</span><span class="p">]</span>
        <span class="p">)</span></div>
</div>



<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1">#   Health System Interactions (HSI)</span>
<span class="c1"># ---------------------------------------------------------------------------</span>


<div class="viewcode-block" id="HSI_Tb_ScreeningAndRefer">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.HSI_Tb_ScreeningAndRefer">[docs]</a>
<span class="k">class</span> <span class="nc">HSI_Tb_ScreeningAndRefer</span><span class="p">(</span><span class="n">HSI_Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the Screening-and-Refer HSI.</span>
<span class="sd">    A positive outcome from symptom-based screening will prompt referral to tb tests (sputum/xpert/xray)</span>
<span class="sd">    no consumables are required for screening (4 clinical questions)</span>

<span class="sd">    This event is scheduled by:</span>
<span class="sd">        * the main event poll,</span>
<span class="sd">        * when someone presents for care through a Generic HSI with tb-like symptoms</span>
<span class="sd">        * active screening / contact tracing programmes</span>

<span class="sd">    If this event is called within another HSI, it may be desirable to limit the functionality of the HSI: do this</span>
<span class="sd">    using the arguments:</span>
<span class="sd">        * suppress_footprint=True : the HSI will not have any footprint</span>

<span class="sd">    This event will:</span>
<span class="sd">    * screen individuals for TB symptoms</span>
<span class="sd">    * administer appropriate TB test</span>
<span class="sd">    * schedule treatment if needed</span>
<span class="sd">    * give IPT for paediatric contacts of diagnosed case</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="HSI_Tb_ScreeningAndRefer.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.HSI_Tb_ScreeningAndRefer.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">suppress_footprint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">facility_level</span><span class="o">=</span><span class="s1">&#39;1a&#39;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">Tb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">facility_level</span> <span class="o">=</span> <span class="n">facility_level</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">suppress_footprint</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suppress_footprint</span> <span class="o">=</span> <span class="n">suppress_footprint</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">TREATMENT_ID</span> <span class="o">=</span> <span class="s2">&quot;Tb_Test_Screening&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s2">&quot;Over5OPD&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span> <span class="o">=</span> <span class="s2">&quot;1a&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">facility_level</span> <span class="o">==</span> <span class="s2">&quot;1a&quot;</span> <span class="k">else</span> <span class="s2">&quot;2&quot;</span></div>


<div class="viewcode-block" id="HSI_Tb_ScreeningAndRefer.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.HSI_Tb_ScreeningAndRefer.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">squeeze_factor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Do the screening and referring to next tests&quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">person</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;is_alive&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_blank_appt_footprint</span><span class="p">()</span>

        <span class="c1"># If the person is already diagnosed, do nothing do not occupy any resources</span>
        <span class="k">if</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;tb_diagnosed&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_blank_appt_footprint</span><span class="p">()</span>

        <span class="c1"># If the person is already on treatment and not failing, do nothing do not occupy any resources</span>
        <span class="k">if</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;tb_on_treatment&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;tb_treatment_failure&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_blank_appt_footprint</span><span class="p">()</span>

        <span class="c1"># if person has tested within last 14 days, do nothing</span>
        <span class="k">if</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;tb_date_tested&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_blank_appt_footprint</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;HSI_Tb_ScreeningAndRefer: person </span><span class="si">{</span><span class="n">person_id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="n">smear_status</span> <span class="o">=</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;tb_smear&quot;</span><span class="p">]</span>

        <span class="c1"># ------------------------- screening ------------------------- #</span>

        <span class="c1"># check if patient has: cough, fever, night sweat, weight loss</span>
        <span class="c1"># if none of the above conditions are present, no further action</span>
        <span class="n">persons_symptoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;SymptomManager&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">has_what</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">symptom_list</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">persons_symptoms</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({})</span>

        <span class="c1"># ------------------------- testing ------------------------- #</span>
        <span class="c1"># if screening indicates presumptive tb</span>
        <span class="n">test</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">test_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ACTUAL_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span>

        <span class="c1"># refer for HIV testing: all ages</span>
        <span class="c1"># do not run if already HIV diagnosed or had test in last week</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;hv_diagnosed&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="p">(</span><span class="n">person</span><span class="p">[</span><span class="s2">&quot;hv_last_test_date&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">))):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">hsi_event</span><span class="o">=</span><span class="n">hiv</span><span class="o">.</span><span class="n">HSI_Hiv_TestAndRefer</span><span class="p">(</span>
                    <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span>
                    <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;Hiv&quot;</span><span class="p">],</span>
                    <span class="n">referred_from</span><span class="o">=</span><span class="s2">&quot;Tb&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">topen</span><span class="o">=</span><span class="n">now</span><span class="p">,</span>
                <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># ------------------------- x-ray for children ------------------------- #</span>

        <span class="c1"># child under 5 -&gt; chest x-ray, but access is limited</span>
        <span class="c1"># if xray not available, HSI_Tb_Xray_level1b will refer</span>
        <span class="k">if</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;age_years&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">ACTUAL_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;Under5OPD&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
            <span class="p">)</span>

            <span class="c1"># this HSI will choose relevant sensitivity/specificity depending on person&#39;s smear status</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">HSI_Tb_Xray_level1b</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">),</span>
                <span class="n">topen</span><span class="o">=</span><span class="n">now</span><span class="p">,</span>
                <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">test_result</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># to avoid calling a clinical diagnosis</span>

        <span class="c1"># ------------------------- select test for adults ------------------------- #</span>

        <span class="c1"># for all presumptive cases over 5 years of age</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># this selects a test for the person</span>
            <span class="c1"># if selection is xpert, will check for availability and return sputum if xpert not available</span>
            <span class="n">test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">select_tb_test</span><span class="p">(</span><span class="n">person_id</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">test</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;sputum&quot;</span><span class="p">,</span> <span class="s2">&quot;xpert&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">test</span> <span class="o">==</span> <span class="s2">&quot;sputum&quot;</span><span class="p">:</span>
                <span class="n">ACTUAL_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;Over5OPD&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;LabTBMicro&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
                <span class="p">)</span>

                <span class="c1"># relevant test depends on smear status (changes parameters on sensitivity/specificity</span>
                <span class="k">if</span> <span class="n">smear_status</span><span class="p">:</span>
                    <span class="n">test_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span>
                        <span class="s2">&quot;HealthSystem&quot;</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">run_dx_test</span><span class="p">(</span>
                        <span class="n">dx_tests_to_run</span><span class="o">=</span><span class="s2">&quot;tb_sputum_test_smear_positive&quot;</span><span class="p">,</span> <span class="n">hsi_event</span><span class="o">=</span><span class="bp">self</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># if smear-negative, sputum smear should always return negative</span>
                    <span class="c1"># run the dx test to log the consumable</span>
                    <span class="n">test_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span>
                        <span class="s2">&quot;HealthSystem&quot;</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">run_dx_test</span><span class="p">(</span>
                        <span class="n">dx_tests_to_run</span><span class="o">=</span><span class="s2">&quot;tb_sputum_test_smear_negative&quot;</span><span class="p">,</span> <span class="n">hsi_event</span><span class="o">=</span><span class="bp">self</span>
                    <span class="p">)</span>
                    <span class="c1"># if negative, check for presence of all symptoms (clinical diagnosis)</span>
                    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">symptom_list</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">persons_symptoms</span><span class="p">):</span>
                        <span class="n">test_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span>
                            <span class="s2">&quot;HealthSystem&quot;</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">run_dx_test</span><span class="p">(</span>
                            <span class="n">dx_tests_to_run</span><span class="o">=</span><span class="s2">&quot;tb_clinical&quot;</span><span class="p">,</span> <span class="n">hsi_event</span><span class="o">=</span><span class="bp">self</span>
                        <span class="p">)</span>
                <span class="k">if</span> <span class="n">test_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Add used equipment</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_equipment</span><span class="p">({</span><span class="s1">&#39;Sputum Collection box&#39;</span><span class="p">,</span> <span class="s1">&#39;Ordinary Microscope&#39;</span><span class="p">})</span>

            <span class="k">elif</span> <span class="n">test</span> <span class="o">==</span> <span class="s2">&quot;xpert&quot;</span><span class="p">:</span>

                <span class="c1"># this can only be performed at level 1b/2, refer if necessary</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">facility_level</span> <span class="o">==</span> <span class="s2">&quot;1a&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                        <span class="n">hsi_event</span><span class="o">=</span><span class="n">HSI_Tb_ScreeningAndRefer</span><span class="p">(</span>
                            <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">facility_level</span><span class="o">=</span><span class="s2">&quot;2&quot;</span>
                        <span class="p">),</span>
                        <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                        <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s2">&quot;Over5OPD&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">smear_status</span><span class="p">:</span>
                        <span class="c1"># relevant test depends on smear status (changes parameters on sensitivity/specificity</span>
                        <span class="n">test_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span>
                            <span class="s2">&quot;HealthSystem&quot;</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">run_dx_test</span><span class="p">(</span>
                            <span class="n">dx_tests_to_run</span><span class="o">=</span><span class="s2">&quot;tb_xpert_test_smear_positive&quot;</span><span class="p">,</span>
                            <span class="n">hsi_event</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="c1"># for smear-negative people</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">test_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span>
                            <span class="s2">&quot;HealthSystem&quot;</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">run_dx_test</span><span class="p">(</span>
                            <span class="n">dx_tests_to_run</span><span class="o">=</span><span class="s2">&quot;tb_xpert_test_smear_negative&quot;</span><span class="p">,</span>
                            <span class="n">hsi_event</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="n">test_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># Add used equipment</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_equipment</span><span class="p">({</span><span class="s1">&#39;Sputum Collection box&#39;</span><span class="p">,</span> <span class="s1">&#39;Gene Expert (16 Module)&#39;</span><span class="p">})</span>

        <span class="c1"># ------------------------- testing referrals ------------------------- #</span>

        <span class="c1"># if none of the tests are available, try again for sputum</span>
        <span class="c1"># requires another appointment - added in ACTUAL_APPT_FOOTPRINT</span>
        <span class="k">if</span> <span class="n">test_result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">smear_status</span><span class="p">:</span>
                <span class="n">test_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">run_dx_test</span><span class="p">(</span>
                    <span class="n">dx_tests_to_run</span><span class="o">=</span><span class="s2">&quot;tb_sputum_test_smear_positive&quot;</span><span class="p">,</span> <span class="n">hsi_event</span><span class="o">=</span><span class="bp">self</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">test_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">run_dx_test</span><span class="p">(</span>
                    <span class="n">dx_tests_to_run</span><span class="o">=</span><span class="s2">&quot;tb_sputum_test_smear_negative&quot;</span><span class="p">,</span> <span class="n">hsi_event</span><span class="o">=</span><span class="bp">self</span>
                <span class="p">)</span>

            <span class="n">ACTUAL_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;Over5OPD&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;LabTBMicro&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">test_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Add used equipment</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_equipment</span><span class="p">({</span><span class="s1">&#39;Sputum Collection box&#39;</span><span class="p">,</span> <span class="s1">&#39;Ordinary Microscope&#39;</span><span class="p">})</span>

        <span class="c1"># if still no result available, rely on clinical diagnosis</span>
        <span class="k">if</span> <span class="n">test_result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">test_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">run_dx_test</span><span class="p">(</span>
                <span class="n">dx_tests_to_run</span><span class="o">=</span><span class="s2">&quot;tb_clinical&quot;</span><span class="p">,</span> <span class="n">hsi_event</span><span class="o">=</span><span class="bp">self</span>
            <span class="p">)</span>

        <span class="c1"># ------------------------- testing outcomes ------------------------- #</span>

        <span class="c1"># diagnosed with mdr-tb - only if xpert used</span>
        <span class="k">if</span> <span class="n">test_result</span> <span class="ow">and</span> <span class="p">(</span><span class="n">test</span> <span class="o">==</span> <span class="s2">&quot;xpert&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">person</span><span class="p">[</span><span class="s2">&quot;tb_strain&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;mdr&quot;</span><span class="p">):</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_diagnosed_mdr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># if a test has been performed, update person&#39;s properties</span>
        <span class="k">if</span> <span class="n">test_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_date_tested&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span>

        <span class="c1"># if any test returns positive result, refer for appropriate treatment</span>
        <span class="k">if</span> <span class="n">test_result</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_diagnosed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_date_diagnosed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="n">key</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;schedule HSI_Tb_StartTreatment for person </span><span class="si">{</span><span class="n">person_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">HSI_Tb_StartTreatment</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">),</span>
                <span class="n">topen</span><span class="o">=</span><span class="n">now</span><span class="p">,</span>
                <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># ------------------------- give IPT to contacts ------------------------- #</span>
            <span class="c1"># if diagnosed, trigger ipt outreach event for up to 5 contacts of case</span>
            <span class="c1"># only high-risk districts are eligible</span>
            <span class="n">year</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">year</span> <span class="k">if</span> <span class="n">now</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;</span> <span class="mi">2020</span> <span class="k">else</span> <span class="mi">2019</span>

            <span class="n">district</span> <span class="o">=</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;district_of_residence&quot;</span><span class="p">]</span>
            <span class="n">ipt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;ipt_coverage&quot;</span><span class="p">]</span>
            <span class="n">ipt_year</span> <span class="o">=</span> <span class="n">ipt</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ipt</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year</span><span class="p">]</span>
            <span class="n">ipt_coverage_paed</span> <span class="o">=</span> <span class="n">ipt_year</span><span class="o">.</span><span class="n">coverage_paediatric</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">district</span> <span class="ow">in</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;tb_high_risk_distr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">district_name</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">ipt_coverage_paed</span>
            <span class="p">):</span>
                <span class="c1"># randomly sample from eligible population within district</span>
                <span class="n">ipt_eligible</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;age_eligibility_for_ipt&quot;</span><span class="p">])</span>
                    <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">tb_diagnosed</span>
                    <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">district_of_residence</span> <span class="o">==</span> <span class="n">district</span><span class="p">)</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">index</span>

                <span class="k">if</span> <span class="n">ipt_eligible</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>

                    <span class="c1"># select persons at highest risk of tb</span>
                    <span class="n">rr_of_tb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s2">&quot;active_tb&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ipt_eligible</span><span class="p">])</span>

                    <span class="c1"># choose top 5 highest risk contacts</span>
                    <span class="n">ipt_sample</span> <span class="o">=</span> <span class="n">rr_of_tb</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>

                    <span class="k">for</span> <span class="n">person_id</span> <span class="ow">in</span> <span class="n">ipt_sample</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
                            <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;HSI_Tb_ScreeningAndRefer: scheduling IPT for person </span><span class="si">{</span><span class="n">person_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="p">)</span>

                        <span class="n">ipt_event</span> <span class="o">=</span> <span class="n">HSI_Tb_Start_or_Continue_Ipt</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                            <span class="n">ipt_event</span><span class="p">,</span>
                            <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">topen</span><span class="o">=</span><span class="n">now</span><span class="p">,</span>
                            <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="p">)</span>

        <span class="c1"># Return the footprint. If it should be suppressed, return a blank footprint.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suppress_footprint</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ACTUAL_APPT_FOOTPRINT</span></div>
</div>



<div class="viewcode-block" id="HSI_Tb_ClinicalDiagnosis">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.HSI_Tb_ClinicalDiagnosis">[docs]</a>
<span class="k">class</span> <span class="nc">HSI_Tb_ClinicalDiagnosis</span><span class="p">(</span><span class="n">HSI_Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a clinical diagnosis appt which is called when other tests have not been</span>
<span class="sd">    available and only a clinical diagnosis is required</span>

<span class="sd">    * it does not include any of the routine tests for TB or HIV</span>
<span class="sd">    therefore property tb_date_tested is not updated</span>
<span class="sd">    * It only requires 0.5 footprint of Under5OPD since it will almost exclusively</span>
<span class="sd">    be used for children unable to get xrays following initial diagnostic consultations</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="HSI_Tb_ClinicalDiagnosis.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.HSI_Tb_ClinicalDiagnosis.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">suppress_footprint</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">Tb</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">suppress_footprint</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suppress_footprint</span> <span class="o">=</span> <span class="n">suppress_footprint</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">TREATMENT_ID</span> <span class="o">=</span> <span class="s2">&quot;Tb_Test_Clinical&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s2">&quot;Under5OPD&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span> <span class="o">=</span> <span class="s1">&#39;1a&#39;</span></div>


<div class="viewcode-block" id="HSI_Tb_ClinicalDiagnosis.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.HSI_Tb_ClinicalDiagnosis.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">squeeze_factor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Do the screening and referring process &quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>
        <span class="n">person</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span>
        <span class="n">test_result</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># If the person is dead or already diagnosed, do nothing do not occupy any resources</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;is_alive&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;tb_diagnosed&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_blank_appt_footprint</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;HSI_Tb_ClinicalDiagnosis: person </span><span class="si">{</span><span class="n">person_id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># check if patient has: cough, fever, night sweat, weight loss</span>
        <span class="n">set_of_symptoms_that_indicate_tb</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">symptom_list</span><span class="p">)</span>
        <span class="n">persons_symptoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;SymptomManager&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">has_what</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">set_of_symptoms_that_indicate_tb</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">persons_symptoms</span><span class="p">):</span>
            <span class="c1"># if none of the above conditions are present, no further action</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({})</span>

        <span class="k">elif</span> <span class="n">set_of_symptoms_that_indicate_tb</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">persons_symptoms</span><span class="p">):</span>
            <span class="c1"># All symptoms present (clinical diagnosis)</span>
            <span class="n">test_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">run_dx_test</span><span class="p">(</span>
                <span class="n">dx_tests_to_run</span><span class="o">=</span><span class="s2">&quot;tb_clinical&quot;</span><span class="p">,</span> <span class="n">hsi_event</span><span class="o">=</span><span class="bp">self</span>
            <span class="p">)</span>

            <span class="c1"># if clinical diagnosis returns positive result, refer for appropriate treatment</span>
            <span class="k">if</span> <span class="n">test_result</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_diagnosed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_date_diagnosed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="n">key</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;schedule HSI_Tb_StartTreatment for person </span><span class="si">{</span><span class="n">person_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                    <span class="n">HSI_Tb_StartTreatment</span><span class="p">(</span>
                        <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">facility_level</span><span class="o">=</span><span class="s2">&quot;1a&quot;</span>
                    <span class="p">),</span>
                    <span class="n">topen</span><span class="o">=</span><span class="n">now</span><span class="p">,</span>
                    <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="HSI_Tb_Xray_level1b">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.HSI_Tb_Xray_level1b">[docs]</a>
<span class="k">class</span> <span class="nc">HSI_Tb_Xray_level1b</span><span class="p">(</span><span class="n">HSI_Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The is the x-ray HSI</span>
<span class="sd">    usually used for testing children unable to produce sputum</span>
<span class="sd">    positive result will prompt referral to start treatment</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="HSI_Tb_Xray_level1b.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.HSI_Tb_Xray_level1b.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">suppress_footprint</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">Tb</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">suppress_footprint</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suppress_footprint</span> <span class="o">=</span> <span class="n">suppress_footprint</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">TREATMENT_ID</span> <span class="o">=</span> <span class="s2">&quot;Tb_Test_Xray&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s2">&quot;DiagRadio&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span> <span class="o">=</span> <span class="s1">&#39;1b&#39;</span></div>


<div class="viewcode-block" id="HSI_Tb_Xray_level1b.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.HSI_Tb_Xray_level1b.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">squeeze_factor</span><span class="p">):</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;is_alive&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_diagnosed&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_blank_appt_footprint</span><span class="p">()</span>

        <span class="n">ACTUAL_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span>

        <span class="n">smear_status</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_smear&quot;</span><span class="p">]</span>

        <span class="c1"># select sensitivity/specificity of test based on smear status</span>
        <span class="k">if</span> <span class="n">smear_status</span><span class="p">:</span>
            <span class="n">test_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">run_dx_test</span><span class="p">(</span>
                <span class="n">dx_tests_to_run</span><span class="o">=</span><span class="s2">&quot;tb_xray_smear_positive&quot;</span><span class="p">,</span> <span class="n">hsi_event</span><span class="o">=</span><span class="bp">self</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">test_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">run_dx_test</span><span class="p">(</span>
                <span class="n">dx_tests_to_run</span><span class="o">=</span><span class="s2">&quot;tb_xray_smear_negative&quot;</span><span class="p">,</span> <span class="n">hsi_event</span><span class="o">=</span><span class="bp">self</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">test_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_equipment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">healthcare_system</span><span class="o">.</span><span class="n">equipment</span><span class="o">.</span><span class="n">from_pkg_names</span><span class="p">(</span><span class="s1">&#39;X-ray&#39;</span><span class="p">))</span>

        <span class="c1"># if consumables not available, refer to level 2</span>
        <span class="c1"># return blank footprint as xray did not occur</span>
        <span class="k">if</span> <span class="n">test_result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">ACTUAL_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({})</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">HSI_Tb_Xray_level2</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">),</span>
                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">weeks</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># if test returns positive result, refer for appropriate treatment</span>
        <span class="k">if</span> <span class="n">test_result</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_diagnosed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_date_diagnosed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">HSI_Tb_StartTreatment</span><span class="p">(</span>
                    <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">facility_level</span><span class="o">=</span><span class="s2">&quot;1a&quot;</span>
                <span class="p">),</span>
                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Return the footprint. If it should be suppressed, return a blank footprint.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suppress_footprint</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ACTUAL_APPT_FOOTPRINT</span></div>
</div>



<div class="viewcode-block" id="HSI_Tb_Xray_level2">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.HSI_Tb_Xray_level2">[docs]</a>
<span class="k">class</span> <span class="nc">HSI_Tb_Xray_level2</span><span class="p">(</span><span class="n">HSI_Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the x-ray HSI performed at level 2</span>
<span class="sd">    usually used for testing children unable to produce sputum</span>
<span class="sd">    positive result will prompt referral to start treatment</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="HSI_Tb_Xray_level2.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.HSI_Tb_Xray_level2.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">suppress_footprint</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">Tb</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">suppress_footprint</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suppress_footprint</span> <span class="o">=</span> <span class="n">suppress_footprint</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">TREATMENT_ID</span> <span class="o">=</span> <span class="s2">&quot;Tb_Test_Xray&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s2">&quot;DiagRadio&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span> <span class="o">=</span> <span class="s1">&#39;2&#39;</span></div>


<div class="viewcode-block" id="HSI_Tb_Xray_level2.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.HSI_Tb_Xray_level2.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">squeeze_factor</span><span class="p">):</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;is_alive&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_diagnosed&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_blank_appt_footprint</span><span class="p">()</span>

        <span class="n">ACTUAL_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span>

        <span class="n">smear_status</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_smear&quot;</span><span class="p">]</span>

        <span class="c1"># select sensitivity/specificity of test based on smear status</span>
        <span class="k">if</span> <span class="n">smear_status</span><span class="p">:</span>
            <span class="n">test_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">run_dx_test</span><span class="p">(</span>
                <span class="n">dx_tests_to_run</span><span class="o">=</span><span class="s2">&quot;tb_xray_smear_positive&quot;</span><span class="p">,</span> <span class="n">hsi_event</span><span class="o">=</span><span class="bp">self</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">test_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">run_dx_test</span><span class="p">(</span>
                <span class="n">dx_tests_to_run</span><span class="o">=</span><span class="s2">&quot;tb_xray_smear_negative&quot;</span><span class="p">,</span> <span class="n">hsi_event</span><span class="o">=</span><span class="bp">self</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">test_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_equipment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">healthcare_system</span><span class="o">.</span><span class="n">equipment</span><span class="o">.</span><span class="n">from_pkg_names</span><span class="p">(</span><span class="s1">&#39;X-ray&#39;</span><span class="p">))</span>

        <span class="c1"># if consumables not available, rely on clinical diagnosis</span>
        <span class="c1"># return blank footprint as xray was not available</span>
        <span class="k">if</span> <span class="n">test_result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">ACTUAL_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({})</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">HSI_Tb_ClinicalDiagnosis</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">),</span>
                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># if test returns positive result, refer for appropriate treatment</span>
        <span class="k">if</span> <span class="n">test_result</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_diagnosed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_date_diagnosed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">HSI_Tb_StartTreatment</span><span class="p">(</span>
                    <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">facility_level</span><span class="o">=</span><span class="s2">&quot;1a&quot;</span>
                <span class="p">),</span>
                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Return the footprint. If it should be suppressed, return a blank footprint.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suppress_footprint</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ACTUAL_APPT_FOOTPRINT</span></div>
</div>



<span class="c1"># # ---------------------------------------------------------------------------</span>
<span class="c1"># #   Treatment</span>
<span class="c1"># # ---------------------------------------------------------------------------</span>
<span class="c1"># # the consumables at treatment initiation include the cost for the full course of treatment</span>
<span class="c1"># # so the follow-up appts don&#39;t need to account for consumables, just appt time</span>


<div class="viewcode-block" id="HSI_Tb_StartTreatment">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.HSI_Tb_StartTreatment">[docs]</a>
<span class="k">class</span> <span class="nc">HSI_Tb_StartTreatment</span><span class="p">(</span><span class="n">HSI_Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<div class="viewcode-block" id="HSI_Tb_StartTreatment.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.HSI_Tb_StartTreatment.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">facility_level</span><span class="o">=</span><span class="s2">&quot;1a&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">Tb</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">facility_level</span> <span class="o">=</span> <span class="n">facility_level</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">TREATMENT_ID</span> <span class="o">=</span> <span class="s2">&quot;Tb_Treatment&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_of_occurrences</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span> <span class="o">=</span> <span class="s2">&quot;1a&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">facility_level</span> <span class="o">==</span> <span class="s2">&quot;1a&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;2&quot;</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">EXPECTED_APPT_FOOTPRINT</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the expected appt footprint based on whether the HSI has been rescheduled due to unavailable treatment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_occurrences</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s1">&#39;TBNew&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s1">&#39;PharmDispensing&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>

<div class="viewcode-block" id="HSI_Tb_StartTreatment.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.HSI_Tb_StartTreatment.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">squeeze_factor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This is a Health System Interaction Event - start TB treatment</span>
<span class="sd">        select appropriate treatment and request</span>
<span class="sd">        if available, change person&#39;s properties</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>
        <span class="n">person</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_of_occurrences</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># The current appointment is included in the count.</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;is_alive&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_blank_appt_footprint</span><span class="p">()</span>

        <span class="c1"># if person already on treatment or not yet diagnosed, do nothing</span>
        <span class="k">if</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;tb_on_treatment&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;tb_diagnosed&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_blank_appt_footprint</span><span class="p">()</span>

        <span class="n">treatment_regimen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_treatment</span><span class="p">(</span><span class="n">person_id</span><span class="p">)</span>
        <span class="c1"># treatment supplied in kits, one kit per treatment course</span>
        <span class="n">treatment_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_consumables</span><span class="p">(</span>
            <span class="n">item_codes</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="n">treatment_regimen</span><span class="p">]:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># if require MDR treatment, and not currently at level 2, refer to level 2</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">treatment_regimen</span> <span class="o">==</span> <span class="s2">&quot;tb_mdrtx&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">facility_level</span> <span class="o">!=</span> <span class="s2">&quot;2&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">hsi_event</span><span class="o">=</span><span class="n">HSI_Tb_StartTreatment</span><span class="p">(</span>
                    <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">facility_level</span><span class="o">=</span><span class="s2">&quot;2&quot;</span>
                <span class="p">),</span>
                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_blank_appt_footprint</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">treatment_available</span><span class="p">:</span>
            <span class="c1"># start person on tb treatment - update properties</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_on_treatment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_date_treated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_treatment_regimen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">treatment_regimen</span>

            <span class="k">if</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;tb_diagnosed_mdr&quot;</span><span class="p">]:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_treated_mdr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_date_treated_mdr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span>

            <span class="c1"># schedule first follow-up appointment</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="n">key</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;HSI_Tb_StartTreatment: scheduling first follow-up &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;for person </span><span class="si">{</span><span class="n">person_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">HSI_Tb_FollowUp</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">),</span>
                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># if treatment not available, return for treatment start in 1 week</span>
        <span class="c1"># cap repeated visits at 5</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">number_of_occurrences</span>
                <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;tb_healthseekingbehaviour_cap&quot;</span><span class="p">]</span>
            <span class="p">):</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">weeks</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                    <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="p">)</span></div>


<div class="viewcode-block" id="HSI_Tb_StartTreatment.select_treatment">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.HSI_Tb_StartTreatment.select_treatment">[docs]</a>
    <span class="k">def</span> <span class="nf">select_treatment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        helper function to select appropriate treatment and check whether</span>
<span class="sd">        consumables are available to start drug course</span>
<span class="sd">        treatment will always be for ds-tb unless mdr has been identified</span>
<span class="sd">        :return: drug_available [BOOL]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">person</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span>

        <span class="n">treatment_regimen</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># default return value</span>

        <span class="c1"># -------- MDR-TB -------- #</span>

        <span class="k">if</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;tb_diagnosed_mdr&quot;</span><span class="p">]:</span>

            <span class="n">treatment_regimen</span> <span class="o">=</span> <span class="s2">&quot;tb_mdrtx&quot;</span>

        <span class="c1"># -------- First TB infection -------- #</span>
        <span class="c1"># could be undiagnosed mdr or ds-tb: treat as ds-tb</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;tb_ever_treated&quot;</span><span class="p">]:</span>

            <span class="k">if</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;age_years&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">:</span>
                <span class="c1"># treatment for ds-tb: adult</span>
                <span class="n">treatment_regimen</span> <span class="o">=</span> <span class="s2">&quot;tb_tx_adult&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># treatment for ds-tb: child</span>
                <span class="n">treatment_regimen</span> <span class="o">=</span> <span class="s2">&quot;tb_tx_child&quot;</span>

        <span class="c1"># -------- Secondary TB infection -------- #</span>
        <span class="c1"># person has been treated before</span>
        <span class="c1"># possible treatment failure or subsequent reinfection</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;age_years&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">:</span>
                <span class="c1"># treatment for reinfection ds-tb: adult</span>
                <span class="n">treatment_regimen</span> <span class="o">=</span> <span class="s2">&quot;tb_retx_adult&quot;</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># treatment for reinfection ds-tb: child</span>
                <span class="n">treatment_regimen</span> <span class="o">=</span> <span class="s2">&quot;tb_retx_child&quot;</span>

        <span class="k">return</span> <span class="n">treatment_regimen</span></div>
</div>



<span class="c1"># # ---------------------------------------------------------------------------</span>
<span class="c1"># #   Follow-up appts</span>
<span class="c1"># # ---------------------------------------------------------------------------</span>
<div class="viewcode-block" id="HSI_Tb_FollowUp">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.HSI_Tb_FollowUp">[docs]</a>
<span class="k">class</span> <span class="nc">HSI_Tb_FollowUp</span><span class="p">(</span><span class="n">HSI_Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a Health System Interaction Event</span>
<span class="sd">    clinical monitoring for tb patients on treatment</span>
<span class="sd">    will schedule sputum smear test if needed</span>
<span class="sd">    if positive sputum smear, schedule xpert test for drug sensitivity</span>
<span class="sd">    then schedule the next follow-up appt if needed</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="HSI_Tb_FollowUp.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.HSI_Tb_FollowUp.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">Tb</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">TREATMENT_ID</span> <span class="o">=</span> <span class="s2">&quot;Tb_Test_FollowUp&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s2">&quot;TBFollowUp&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span> <span class="o">=</span> <span class="s1">&#39;1a&#39;</span></div>


<div class="viewcode-block" id="HSI_Tb_FollowUp.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.HSI_Tb_FollowUp.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">squeeze_factor</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">person</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span>

        <span class="c1"># Do not run if the person is not alive, or is not currently on treatment</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;is_alive&quot;</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;tb_on_treatment&quot;</span><span class="p">]):</span>
            <span class="k">return</span>

        <span class="n">ACTUAL_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span>

        <span class="c1"># months since treatment start - to compare with monitoring schedule</span>
        <span class="c1"># make sure it&#39;s an integer value</span>
        <span class="n">months_since_tx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_date_treated&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">days</span> <span class="o">/</span> <span class="mf">30.5</span>
        <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;HSI_Tb_FollowUp: person </span><span class="si">{</span><span class="n">person_id</span><span class="si">}</span><span class="s2"> on month </span><span class="si">{</span><span class="n">months_since_tx</span><span class="si">}</span><span class="s2"> of treatment&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># default clinical monitoring schedule for first infection ds-tb</span>
        <span class="n">xperttest_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">follow_up_times</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;followup_times&quot;</span><span class="p">]</span>
        <span class="n">sputum_fup</span> <span class="o">=</span> <span class="n">follow_up_times</span><span class="p">[</span><span class="s2">&quot;ds_sputum&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">treatment_length</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;ds_treatment_length&quot;</span><span class="p">]</span>

        <span class="c1"># if previously treated:</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">person</span><span class="p">[</span><span class="s2">&quot;tb_treatment_regimen&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;tb_retx_adult&quot;</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">person</span><span class="p">[</span><span class="s2">&quot;tb_treatment_regimen&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;tb_retx_child&quot;</span><span class="p">)):</span>

            <span class="c1"># if strain is ds and person previously treated:</span>
            <span class="n">sputum_fup</span> <span class="o">=</span> <span class="n">follow_up_times</span><span class="p">[</span><span class="s2">&quot;ds_retreatment_sputum&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="n">treatment_length</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;ds_retreatment_length&quot;</span><span class="p">]</span>

        <span class="c1"># if person diagnosed with mdr - this treatment schedule takes precedence</span>
        <span class="k">elif</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;tb_treatment_regimen&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;tb_mdrtx&quot;</span><span class="p">:</span>

            <span class="n">sputum_fup</span> <span class="o">=</span> <span class="n">follow_up_times</span><span class="p">[</span><span class="s2">&quot;mdr_sputum&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="n">treatment_length</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;mdr_treatment_length&quot;</span><span class="p">]</span>

        <span class="c1"># check schedule for sputum test and perform if necessary</span>
        <span class="k">if</span> <span class="n">months_since_tx</span> <span class="ow">in</span> <span class="n">sputum_fup</span><span class="p">:</span>
            <span class="n">ACTUAL_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;TBFollowUp&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;LabTBMicro&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
            <span class="p">)</span>

            <span class="c1"># choose test parameters based on smear status</span>
            <span class="k">if</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;tb_smear&quot;</span><span class="p">]:</span>
                <span class="n">test_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">run_dx_test</span><span class="p">(</span>
                    <span class="n">dx_tests_to_run</span><span class="o">=</span><span class="s2">&quot;tb_sputum_test_smear_positive&quot;</span><span class="p">,</span> <span class="n">hsi_event</span><span class="o">=</span><span class="bp">self</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">test_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">run_dx_test</span><span class="p">(</span>
                    <span class="n">dx_tests_to_run</span><span class="o">=</span><span class="s2">&quot;tb_sputum_test_smear_negative&quot;</span><span class="p">,</span> <span class="n">hsi_event</span><span class="o">=</span><span class="bp">self</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">test_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Add used equipment</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_equipment</span><span class="p">({</span><span class="s1">&#39;Sputum Collection box&#39;</span><span class="p">,</span> <span class="s1">&#39;Ordinary Microscope&#39;</span><span class="p">})</span>

            <span class="c1"># if sputum test was available and returned positive and not diagnosed with mdr, schedule xpert test</span>
            <span class="k">if</span> <span class="n">test_result</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;tb_diagnosed_mdr&quot;</span><span class="p">]:</span>
                <span class="n">ACTUAL_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;TBFollowUp&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;LabTBMicro&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;LabMolec&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;tb_smear&quot;</span><span class="p">]:</span>
                    <span class="n">xperttest_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">run_dx_test</span><span class="p">(</span>
                        <span class="n">dx_tests_to_run</span><span class="o">=</span><span class="s2">&quot;tb_xpert_test_smear_positive&quot;</span><span class="p">,</span> <span class="n">hsi_event</span><span class="o">=</span><span class="bp">self</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xperttest_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">run_dx_test</span><span class="p">(</span>
                        <span class="n">dx_tests_to_run</span><span class="o">=</span><span class="s2">&quot;tb_xpert_test_smear_negative&quot;</span><span class="p">,</span> <span class="n">hsi_event</span><span class="o">=</span><span class="bp">self</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">xperttest_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Add used equipment</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_equipment</span><span class="p">({</span><span class="s1">&#39;Sputum Collection box&#39;</span><span class="p">,</span> <span class="s1">&#39;Gene Expert (16 Module)&#39;</span><span class="p">})</span>

        <span class="c1"># if xpert test returns new mdr-tb diagnosis</span>
        <span class="k">if</span> <span class="n">xperttest_result</span> <span class="ow">and</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_strain&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;mdr&quot;</span><span class="p">):</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_diagnosed_mdr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># already diagnosed with active tb so don&#39;t update tb_date_diagnosed</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_treatment_failure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># restart treatment (new regimen) if newly diagnosed with mdr-tb</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">HSI_Tb_StartTreatment</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">),</span>
                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># for all ds cases and known mdr cases:</span>
        <span class="c1"># schedule next clinical follow-up appt if still within treatment length</span>
        <span class="k">elif</span> <span class="n">months_since_tx</span> <span class="o">&lt;</span> <span class="n">treatment_length</span><span class="p">:</span>
            <span class="n">follow_up_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="n">key</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;HSI_Tb_FollowUp: scheduling next follow-up &quot;</span>
                     <span class="sa">f</span><span class="s2">&quot;for person </span><span class="si">{</span><span class="n">person_id</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">follow_up_date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">HSI_Tb_FollowUp</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">),</span>
                <span class="n">topen</span><span class="o">=</span><span class="n">follow_up_date</span><span class="p">,</span>
                <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">ACTUAL_APPT_FOOTPRINT</span></div>
</div>



<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1">#   IPT</span>
<span class="c1"># ---------------------------------------------------------------------------</span>
<div class="viewcode-block" id="HSI_Tb_Start_or_Continue_Ipt">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.HSI_Tb_Start_or_Continue_Ipt">[docs]</a>
<span class="k">class</span> <span class="nc">HSI_Tb_Start_or_Continue_Ipt</span><span class="p">(</span><span class="n">HSI_Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a Health System Interaction Event - give ipt to reduce risk of active TB</span>
<span class="sd">    It can be scheduled by:</span>
<span class="sd">    * HIV.HSI_Hiv_StartOrContinueTreatment for PLHIV, diagnosed and on ART</span>
<span class="sd">    * Tb.HSI_Tb_StartTreatment for up to 5 contacts of diagnosed active TB case</span>

<span class="sd">    Isoniazid preventive therapy for HIV-infected children : 6 months, 180 doses</span>
<span class="sd">    3HP (Isoniazid/Rifapentine) for adults: 12 weeks, 12 doses</span>
<span class="sd">    3HP for children ages &gt;2 yrs hiv-</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="HSI_Tb_Start_or_Continue_Ipt.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.HSI_Tb_Start_or_Continue_Ipt.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TREATMENT_ID</span> <span class="o">=</span> <span class="s2">&quot;Tb_Prevention_Ipt&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s2">&quot;Over5OPD&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span> <span class="o">=</span> <span class="s1">&#39;1a&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_of_occurrences</span> <span class="o">=</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="HSI_Tb_Start_or_Continue_Ipt.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.HSI_Tb_Start_or_Continue_Ipt.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">squeeze_factor</span><span class="p">):</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Starting IPT for person </span><span class="si">{</span><span class="n">person_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_of_occurrences</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>  <span class="c1"># shortcut to the dataframe</span>

        <span class="n">person</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span>

        <span class="c1"># Do not run if the person is not alive or already on IPT or diagnosed active infection</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="p">(</span><span class="ow">not</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;is_alive&quot;</span><span class="p">])</span>
            <span class="ow">or</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;tb_on_ipt&quot;</span><span class="p">]</span>
            <span class="ow">or</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;tb_diagnosed&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># if currently have symptoms of TB, refer for screening/testing</span>
        <span class="n">persons_symptoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;SymptomManager&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">has_what</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">symptom_list</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">persons_symptoms</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">HSI_Tb_ScreeningAndRefer</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">),</span>
                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                <span class="n">tclose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">14</span><span class="p">),</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Check/log use of consumables, and give IPT if available</span>

            <span class="c1"># if child and HIV+ or child under 2 yrs</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">person</span><span class="p">[</span><span class="s2">&quot;age_years&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">)</span> <span class="ow">and</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;hv_inf&quot;</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="n">person</span><span class="p">[</span><span class="s2">&quot;age_years&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">):</span>

                <span class="c1"># 6 months dispensation, once daily</span>
                <span class="n">drugs_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_consumables</span><span class="p">(</span>
                    <span class="n">item_codes</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s2">&quot;tb_ipt&quot;</span><span class="p">]:</span> <span class="mi">180</span><span class="p">})</span>

            <span class="c1"># for all others</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 12 weeks dispensation, once weekly</span>
                <span class="n">drugs_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_consumables</span><span class="p">(</span>
                    <span class="n">item_codes</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s2">&quot;tb_3HP&quot;</span><span class="p">]:</span> <span class="mi">12</span><span class="p">}</span>
                <span class="p">)</span>

            <span class="c1"># if available, schedule IPT decision</span>
            <span class="k">if</span> <span class="n">drugs_available</span><span class="p">:</span>
                <span class="c1"># Update properties</span>
                <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_on_ipt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_date_ipt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>

                <span class="c1"># schedule decision to continue or end IPT after 6 months</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
                    <span class="n">Tb_DecisionToContinueIPT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">6</span><span class="p">),</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Reschedule this HSI to occur again, up to a 5 times in total</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">number_of_occurrences</span>
                    <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;tb_healthseekingbehaviour_cap&quot;</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span>
                        <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                        <span class="n">tclose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">14</span><span class="p">),</span>
                        <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="HSI_Tb_EndOfLifeCare">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.HSI_Tb_EndOfLifeCare">[docs]</a>
<span class="k">class</span> <span class="nc">HSI_Tb_EndOfLifeCare</span><span class="p">(</span><span class="n">HSI_Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    this is a hospital stay for terminally-ill patients with TB</span>
<span class="sd">    it does not affect disability weight or probability of death</span>
<span class="sd">    no consumables are logged but health system capacity (HR) is allocated</span>
<span class="sd">    there are no consequences if hospital bed is not available as person has scheduled death</span>
<span class="sd">    already within 2 weeks</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="HSI_Tb_EndOfLifeCare.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.HSI_Tb_EndOfLifeCare.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">beddays</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">Tb</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">TREATMENT_ID</span> <span class="o">=</span> <span class="s2">&quot;Tb_PalliativeCare&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span> <span class="o">=</span> <span class="s2">&quot;2&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">beddays</span> <span class="o">=</span> <span class="n">beddays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BEDDAYS_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_beddays_footprint</span><span class="p">({</span><span class="s2">&quot;general_bed&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">beddays</span><span class="p">})</span></div>


<div class="viewcode-block" id="HSI_Tb_EndOfLifeCare.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.HSI_Tb_EndOfLifeCare.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">squeeze_factor</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">hs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;is_alive&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">hs</span><span class="o">.</span><span class="n">get_blank_appt_footprint</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;HSI_Tb_EndOfLifeCare: inpatient admission for </span><span class="si">{</span><span class="n">person_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="Tb_DecisionToContinueIPT">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.Tb_DecisionToContinueIPT">[docs]</a>
<span class="k">class</span> <span class="nc">Tb_DecisionToContinueIPT</span><span class="p">(</span><span class="n">Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper event that is used to &#39;decide&#39; if someone on IPT should continue or end</span>
<span class="sd">    This event is scheduled by &#39;HSI_Tb_Start_or_Continue_Ipt&#39; after 6 months</span>

<span class="sd">    * end IPT for all</span>
<span class="sd">    * schedule further IPT for HIV+ if still eligible (no active TB diagnosed, &lt;36 months IPT)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Tb_DecisionToContinueIPT.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.Tb_DecisionToContinueIPT.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="Tb_DecisionToContinueIPT.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.Tb_DecisionToContinueIPT.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">person</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">person</span><span class="p">[</span><span class="s2">&quot;is_alive&quot;</span><span class="p">]):</span>
            <span class="k">return</span>

        <span class="c1"># default update properties for all</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_on_ipt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># decide whether PLHIV will continue</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">person</span><span class="p">[</span><span class="s2">&quot;hv_diagnosed&quot;</span><span class="p">]</span>
            <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;tb_diagnosed&quot;</span><span class="p">])</span>
            <span class="ow">and</span> <span class="p">(</span><span class="n">person</span><span class="p">[</span><span class="s2">&quot;tb_date_ipt&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">36</span> <span class="o">*</span> <span class="mf">30.5</span><span class="p">)))</span>
            <span class="ow">and</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">m</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;prob_retained_ipt_6_months&quot;</span><span class="p">])</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">HSI_Tb_Start_or_Continue_Ipt</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="n">m</span><span class="p">),</span>
                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                <span class="n">tclose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">14</span><span class="p">),</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span></div>
</div>



<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1">#   Deaths</span>
<span class="c1"># ---------------------------------------------------------------------------</span>


<div class="viewcode-block" id="TbDecideDeathEvent">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.TbDecideDeathEvent">[docs]</a>
<span class="k">class</span> <span class="nc">TbDecideDeathEvent</span><span class="p">(</span><span class="n">Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The scheduled hospitalisation and subsequent death for a tb case</span>
<span class="sd">    check whether death should occur using a linear model</span>
<span class="sd">    will depend on treatment status, smear status and age</span>
<span class="sd">    then schedule a hospital stay prior to that death</span>
<span class="sd">    hospital stay will not affect outcomes</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TbDecideDeathEvent.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.TbDecideDeathEvent.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">cause</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cause</span> <span class="o">=</span> <span class="n">cause</span></div>


<div class="viewcode-block" id="TbDecideDeathEvent.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.TbDecideDeathEvent.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;is_alive&quot;</span><span class="p">]:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_inf&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;active&quot;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;TbDecideDeathEvent: checking whether death should occur for person </span><span class="si">{</span><span class="n">person_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># use linear model to determine whether this person will die:</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span>
        <span class="n">will_die</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s2">&quot;death_rate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">person_id</span><span class="p">]],</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">will_die</span><span class="p">:</span>
            <span class="c1"># schedule hospital stay for this person</span>
            <span class="c1"># schedule hospital stay</span>
            <span class="n">beddays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span>
                <span class="n">low</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;length_of_inpatient_stay_if_terminal&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">high</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;length_of_inpatient_stay_if_terminal&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">hsi_event</span><span class="o">=</span><span class="n">HSI_Tb_EndOfLifeCare</span><span class="p">(</span>
                    <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;Tb&quot;</span><span class="p">],</span> <span class="n">beddays</span><span class="o">=</span><span class="n">beddays</span>
                <span class="p">),</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># schedule death for this person after hospital stay</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
                <span class="n">event</span><span class="o">=</span><span class="n">TbDeathEvent</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">),</span>
                <span class="n">date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">beddays</span><span class="p">),</span>
            <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TbDeathEvent">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.TbDeathEvent">[docs]</a>
<span class="k">class</span> <span class="nc">TbDeathEvent</span><span class="p">(</span><span class="n">Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The scheduled death for a tb case</span>
<span class="sd">    check whether this death should occur using a linear model</span>
<span class="sd">    will depend on treatment status, smear status and age</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TbDeathEvent.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.TbDeathEvent.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="TbDeathEvent.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.TbDeathEvent.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;is_alive&quot;</span><span class="p">]:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_inf&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;active&quot;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;TbDeathEvent: cause this death for person </span><span class="si">{</span><span class="n">person_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;Demography&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">do_death</span><span class="p">(</span>
            <span class="n">individual_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span>
            <span class="n">cause</span><span class="o">=</span><span class="s2">&quot;TB&quot;</span><span class="p">,</span>
            <span class="n">originating_module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>



<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1">#   Logging</span>
<span class="c1"># ---------------------------------------------------------------------------</span>


<div class="viewcode-block" id="TbLoggingEvent">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.TbLoggingEvent">[docs]</a>
<span class="k">class</span> <span class="nc">TbLoggingEvent</span><span class="p">(</span><span class="n">RegularEvent</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">):</span>
<div class="viewcode-block" id="TbLoggingEvent.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.TbLoggingEvent.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;produce some outputs to check&quot;&quot;&quot;</span>
        <span class="c1"># run this event every 12 months</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repeat</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">))</span></div>


<div class="viewcode-block" id="TbLoggingEvent.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.TbLoggingEvent.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
        <span class="c1"># get some summary statistics</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>

        <span class="c1"># ------------------------------------ INCIDENCE ------------------------------------</span>
        <span class="c1"># total number of new active cases in last year - ds + mdr</span>
        <span class="c1"># may have died in the last year but still counted as active case for the year</span>

        <span class="c1"># number of new active cases</span>
        <span class="n">new_tb_cases</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_date_active</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))]</span>
        <span class="p">)</span>

        <span class="c1"># number of latent cases</span>
        <span class="n">new_latent_cases</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_date_latent</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))]</span>
        <span class="p">)</span>

        <span class="c1"># number of new active cases in HIV+</span>
        <span class="n">inc_active_hiv</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span>
                <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_date_active</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))</span>
                <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span>
                <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># proportion of active TB cases in the last year who are HIV-positive</span>
        <span class="n">prop_hiv</span> <span class="o">=</span> <span class="n">inc_active_hiv</span> <span class="o">/</span> <span class="n">new_tb_cases</span> <span class="k">if</span> <span class="n">new_tb_cases</span> <span class="k">else</span> <span class="mf">0.0</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;tb_incidence&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Number new active and latent TB cases, total and in PLHIV&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;num_new_active_tb&quot;</span><span class="p">:</span> <span class="n">new_tb_cases</span><span class="p">,</span>
                <span class="s2">&quot;num_new_latent_tb&quot;</span><span class="p">:</span> <span class="n">new_latent_cases</span><span class="p">,</span>
                <span class="s2">&quot;num_new_active_tb_in_hiv&quot;</span><span class="p">:</span> <span class="n">inc_active_hiv</span><span class="p">,</span>
                <span class="s2">&quot;prop_active_tb_in_plhiv&quot;</span><span class="p">:</span> <span class="n">prop_hiv</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># save outputs to dict for calibration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">tb_outputs</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">tb_outputs</span><span class="p">[</span><span class="s2">&quot;num_new_active_tb&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">new_tb_cases</span><span class="p">]</span>

        <span class="c1"># ------------------------------------ PREVALENCE ------------------------------------</span>
        <span class="c1"># number of current active cases divided by population alive</span>

        <span class="c1"># ACTIVE</span>
        <span class="n">num_active_tb_cases</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_inf</span> <span class="o">==</span> <span class="s2">&quot;active&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">])</span>
        <span class="n">prev_active</span> <span class="o">=</span> <span class="n">num_active_tb_cases</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">])</span>

        <span class="k">assert</span> <span class="n">prev_active</span> <span class="o">&lt;=</span> <span class="mi">1</span>

        <span class="c1"># prevalence of active TB in adults</span>
        <span class="n">num_active_adult</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_inf</span> <span class="o">==</span> <span class="s2">&quot;active&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">prev_active_adult</span> <span class="o">=</span> <span class="n">num_active_adult</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">]</span>
        <span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">]</span>
        <span class="p">)</span> <span class="k">else</span> <span class="mf">0.0</span>
        <span class="k">assert</span> <span class="n">prev_active_adult</span> <span class="o">&lt;=</span> <span class="mi">1</span>

        <span class="c1"># prevalence of active TB in children</span>
        <span class="n">num_active_child</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_inf</span> <span class="o">==</span> <span class="s2">&quot;active&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">prev_active_child</span> <span class="o">=</span> <span class="n">num_active_child</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">]</span>
        <span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">]</span>
        <span class="p">)</span> <span class="k">else</span> <span class="mf">0.0</span>
        <span class="k">assert</span> <span class="n">prev_active_child</span> <span class="o">&lt;=</span> <span class="mi">1</span>

        <span class="c1"># LATENT</span>
        <span class="c1"># proportion of population with latent TB - all pop</span>
        <span class="n">num_latent</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_inf</span> <span class="o">==</span> <span class="s2">&quot;latent&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">])</span>
        <span class="n">prev_latent</span> <span class="o">=</span> <span class="n">num_latent</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">prev_latent</span> <span class="o">&lt;=</span> <span class="mi">1</span>

        <span class="c1"># proportion of population with latent TB - adults</span>
        <span class="n">num_latent_adult</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_inf</span> <span class="o">==</span> <span class="s2">&quot;latent&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">prev_latent_adult</span> <span class="o">=</span> <span class="n">num_latent_adult</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">]</span>
        <span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">]</span>
        <span class="p">)</span> <span class="k">else</span> <span class="mf">0.0</span>
        <span class="k">assert</span> <span class="n">prev_latent_adult</span> <span class="o">&lt;=</span> <span class="mi">1</span>

        <span class="c1"># proportion of population with latent TB - children</span>
        <span class="n">num_latent_child</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_inf</span> <span class="o">==</span> <span class="s2">&quot;latent&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">prev_latent_child</span> <span class="o">=</span> <span class="n">num_latent_child</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">]</span>
        <span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">]</span>
        <span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="n">prev_latent_child</span> <span class="o">&lt;=</span> <span class="mi">1</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;tb_prevalence&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Prevalence of active and latent TB cases, total and in PLHIV&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;tbPrevActive&quot;</span><span class="p">:</span> <span class="n">prev_active</span><span class="p">,</span>
                <span class="s2">&quot;tbPrevActiveAdult&quot;</span><span class="p">:</span> <span class="n">prev_active_adult</span><span class="p">,</span>
                <span class="s2">&quot;tbPrevActiveChild&quot;</span><span class="p">:</span> <span class="n">prev_active_child</span><span class="p">,</span>
                <span class="s2">&quot;tbPrevLatent&quot;</span><span class="p">:</span> <span class="n">prev_latent</span><span class="p">,</span>
                <span class="s2">&quot;tbPrevLatentAdult&quot;</span><span class="p">:</span> <span class="n">prev_latent_adult</span><span class="p">,</span>
                <span class="s2">&quot;tbPrevLatentChild&quot;</span><span class="p">:</span> <span class="n">prev_latent_child</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># save outputs to dict for calibration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">tb_outputs</span><span class="p">[</span><span class="s2">&quot;tbPrevLatent&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">prev_latent</span><span class="p">]</span>

        <span class="c1"># ------------------------------------ MDR ------------------------------------</span>
        <span class="c1"># number new mdr tb cases</span>
        <span class="n">new_mdr_cases</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span>
                <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_strain</span> <span class="o">==</span> <span class="s2">&quot;mdr&quot;</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_date_active</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))</span>
                <span class="p">]</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">new_mdr_cases</span><span class="p">:</span>
            <span class="n">prop_mdr</span> <span class="o">=</span> <span class="n">new_mdr_cases</span> <span class="o">/</span> <span class="n">new_tb_cases</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prop_mdr</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;tb_mdr&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Incidence of new active MDR cases and the proportion of TB cases that are MDR&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;tbNewActiveMdrCases&quot;</span><span class="p">:</span> <span class="n">new_mdr_cases</span><span class="p">,</span>
                <span class="s2">&quot;tbPropActiveCasesMdr&quot;</span><span class="p">:</span> <span class="n">prop_mdr</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># ------------------------------------ CASE NOTIFICATIONS ------------------------------------</span>
        <span class="c1"># number diagnoses (new, relapse, reinfection) in last timeperiod</span>
        <span class="n">new_tb_diagnosis</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span>
                <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_date_active</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_date_diagnosed</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))]</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">new_tb_diagnosis</span><span class="p">:</span>
            <span class="n">prop_dx</span> <span class="o">=</span> <span class="n">new_tb_diagnosis</span> <span class="o">/</span> <span class="n">new_tb_cases</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prop_dx</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># ------------------------------------ TREATMENT ------------------------------------</span>
        <span class="c1"># number of tb cases who became active in last timeperiod and initiated treatment</span>
        <span class="n">new_tb_tx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span>
                <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_date_active</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_date_treated</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))</span>
                <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># treatment coverage: if became active and was treated in last timeperiod</span>
        <span class="k">if</span> <span class="n">new_tb_cases</span><span class="p">:</span>
            <span class="n">tx_coverage</span> <span class="o">=</span> <span class="n">new_tb_tx</span> <span class="o">/</span> <span class="n">new_tb_cases</span>
            <span class="c1"># assert tx_coverage &lt;= 1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tx_coverage</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># ipt coverage</span>
        <span class="n">new_tb_ipt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span>
                <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_date_ipt</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># this will give ipt among whole population - not just eligible pop</span>
        <span class="k">if</span> <span class="n">new_tb_ipt</span><span class="p">:</span>
            <span class="n">current_ipt_coverage</span> <span class="o">=</span> <span class="n">new_tb_ipt</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_ipt_coverage</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;tb_treatment&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;TB treatment coverage&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;tbNewDiagnosis&quot;</span><span class="p">:</span> <span class="n">new_tb_diagnosis</span><span class="p">,</span>
                <span class="s2">&quot;tbPropDiagnosed&quot;</span><span class="p">:</span> <span class="n">prop_dx</span><span class="p">,</span>
                <span class="s2">&quot;tbTreatmentCoverage&quot;</span><span class="p">:</span> <span class="n">tx_coverage</span><span class="p">,</span>
                <span class="s2">&quot;tbIptCoverage&quot;</span><span class="p">:</span> <span class="n">current_ipt_coverage</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># ------------------------------------ TREATMENT DELAYS ------------------------------------</span>
        <span class="c1"># for every person initiated on treatment, record time from onset to treatment</span>
        <span class="c1"># each year a series of intervals in days (treatment date - onset date) are recorded</span>
        <span class="c1"># convert to list</span>
        <span class="c1"># this will include false positives as Nan or negative or delay &gt; 3 years</span>

        <span class="c1"># adults</span>
        <span class="c1"># get index of adults starting tx in last time-period</span>
        <span class="c1"># note tb onset may have been up to 3 years prior to treatment</span>
        <span class="n">adult_tx_idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span>
                              <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_date_treated</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))]</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># calculate treatment_date - onset_date for each person in index</span>
        <span class="n">adult_tx_delays</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">adult_tx_idx</span><span class="p">,</span> <span class="s2">&quot;tb_date_treated&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">adult_tx_idx</span><span class="p">,</span> <span class="s2">&quot;tb_date_active&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span>
        <span class="n">adult_tx_delays</span> <span class="o">=</span> <span class="n">adult_tx_delays</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># children</span>
        <span class="n">child_tx_idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span>
                              <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_date_treated</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))]</span><span class="o">.</span><span class="n">index</span>
        <span class="n">child_tx_delays</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">child_tx_idx</span><span class="p">,</span> <span class="s2">&quot;tb_date_treated&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">child_tx_idx</span><span class="p">,</span> <span class="s2">&quot;tb_date_active&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span>
        <span class="n">child_tx_delays</span> <span class="o">=</span> <span class="n">child_tx_delays</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;tb_treatment_delays&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;TB time from onset to treatment&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;tbTreatmentDelayAdults&quot;</span><span class="p">:</span> <span class="n">adult_tx_delays</span><span class="p">,</span>
                <span class="s2">&quot;tbTreatmentDelayChildren&quot;</span><span class="p">:</span> <span class="n">child_tx_delays</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># ------------------------------------ FALSE POSITIVES ------------------------------------</span>
        <span class="c1"># from the numbers on treatment, extract those who did not have active TB infection</span>
        <span class="c1"># they will be diagnosed as positive, but tb_inf != active</span>
        <span class="c1"># proportion of new treatments which are false positives</span>

        <span class="c1"># adults</span>
        <span class="c1"># tb_date_active is not within last 3 years (or pd.NaT)</span>
        <span class="n">adult_num_false_positive</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span>
                <span class="o">~</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_date_active</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">36</span><span class="p">)))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_date_treated</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span>
                <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># these are all new adults treated, regardless of tb status</span>
        <span class="n">new_tb_tx_adult</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span>
                <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_date_treated</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span>
                <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># proportion of adults starting on treatment who are false positive</span>
        <span class="k">if</span> <span class="n">adult_num_false_positive</span><span class="p">:</span>
            <span class="n">adult_prop_false_positive</span> <span class="o">=</span> <span class="n">adult_num_false_positive</span> <span class="o">/</span> <span class="n">new_tb_tx_adult</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">adult_prop_false_positive</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># children</span>
        <span class="n">child_num_false_positive</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span>
                <span class="o">~</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_date_active</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">36</span><span class="p">)))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_date_treated</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
                <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># these are all new children treated, regardless of tb status</span>
        <span class="n">new_tb_tx_child</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span>
                <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tb_date_treated</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
                <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># proportion of children starting on treatment who are false positive</span>
        <span class="k">if</span> <span class="n">child_num_false_positive</span><span class="p">:</span>
            <span class="n">child_prop_false_positive</span> <span class="o">=</span> <span class="n">child_num_false_positive</span> <span class="o">/</span> <span class="n">new_tb_tx_child</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">child_prop_false_positive</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;tb_false_positive&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;TB numbers on treatment without disease&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;tbNumFalsePositiveAdults&quot;</span><span class="p">:</span> <span class="n">adult_num_false_positive</span><span class="p">,</span>
                <span class="s2">&quot;tbNumFalsePositiveChildren&quot;</span><span class="p">:</span> <span class="n">child_num_false_positive</span><span class="p">,</span>
                <span class="s2">&quot;tbPropFalsePositiveAdults&quot;</span><span class="p">:</span> <span class="n">adult_prop_false_positive</span><span class="p">,</span>
                <span class="s2">&quot;tbPropFalsePositiveChildren&quot;</span><span class="p">:</span> <span class="n">child_prop_false_positive</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span></div>
</div>



<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1">#   Debugging / Checking Events</span>
<span class="c1"># ---------------------------------------------------------------------------</span>


<div class="viewcode-block" id="TbCheckPropertiesEvent">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.TbCheckPropertiesEvent">[docs]</a>
<span class="k">class</span> <span class="nc">TbCheckPropertiesEvent</span><span class="p">(</span><span class="n">RegularEvent</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">):</span>
<div class="viewcode-block" id="TbCheckPropertiesEvent.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.TbCheckPropertiesEvent.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>  <span class="c1"># runs every month</span></div>


<div class="viewcode-block" id="TbCheckPropertiesEvent.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.TbCheckPropertiesEvent.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">check_config_of_properties</span><span class="p">()</span></div>
</div>



<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1">#   Dummy Version of the Module</span>
<span class="c1"># ---------------------------------------------------------------------------</span>


<div class="viewcode-block" id="DummyTbModule">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.DummyTbModule">[docs]</a>
<span class="k">class</span> <span class="nc">DummyTbModule</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dummy TB Module - it&#39;s only job is to create and maintain the &#39;tb_inf&#39; property.</span>
<span class="sd">    This can be used in test files.&quot;&quot;&quot;</span>

    <span class="n">INIT_DEPENDENCIES</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Demography&quot;</span><span class="p">}</span>
    <span class="n">ALTERNATIVE_TO</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Tb&quot;</span><span class="p">}</span>

    <span class="n">PROPERTIES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;tb_inf&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">CATEGORICAL</span><span class="p">,</span>
            <span class="n">categories</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;uninfected&quot;</span><span class="p">,</span>
                <span class="s2">&quot;latent&quot;</span><span class="p">,</span>
                <span class="s2">&quot;active&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;tb status&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">}</span>

<div class="viewcode-block" id="DummyTbModule.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.DummyTbModule.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">active_tb_prev</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_tb_prev</span> <span class="o">=</span> <span class="n">active_tb_prev</span></div>


<div class="viewcode-block" id="DummyTbModule.read_parameters">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.DummyTbModule.read_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">read_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_folder</span><span class="p">):</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="DummyTbModule.initialise_population">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.DummyTbModule.initialise_population">[docs]</a>
    <span class="k">def</span> <span class="nf">initialise_population</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="n">tb_idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span>
            <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">))</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_tb_prev</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tb_idx</span><span class="p">,</span> <span class="s2">&quot;tb_inf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;active&quot;</span></div>


<div class="viewcode-block" id="DummyTbModule.initialise_simulation">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.DummyTbModule.initialise_simulation">[docs]</a>
    <span class="k">def</span> <span class="nf">initialise_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span><span class="p">):</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="DummyTbModule.on_birth">
<a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.DummyTbModule.on_birth">[docs]</a>
    <span class="k">def</span> <span class="nf">on_birth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mother</span><span class="p">,</span> <span class="n">child</span><span class="p">):</span>
        <span class="n">child_infected</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_tb_prev</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">child_infected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child</span><span class="p">,</span> <span class="s2">&quot;tb_inf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;active&quot;</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
      <span class="lastupdated">Last updated on Oct 08, 2024.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>