

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>tlo.methods.tb &mdash; TLOmodel 0.1.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> TLOmodel
          

          
          </a>

          
            
            
              <div class="version">
                0.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../welcome.html">Welcome</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../aims.html">Aims &amp; Objectives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../writeups.html">Model Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../azure_batch.html">Using Azure Batch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">TLOmodel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../methods.html">tlo.methods</a> &raquo;</li>
        
      <li>tlo.methods.tb</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for tlo.methods.tb</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The TB Module is under development. Here the contents of the module are commented out whilst work proceeds. It is</span>
<span class="sd">included because this version should replace what is currently in Master.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">tlo</span> <span class="kn">import</span> <span class="n">Module</span><span class="p">,</span> <span class="n">logging</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">import os</span>

<span class="sd">import pandas as pd</span>

<span class="sd">from tlo.events import Event, IndividualScopeEventMixin, PopulationScopeEventMixin, RegularEvent</span>
<span class="sd">from tlo.methods import demography, hiv</span>
<span class="sd">from tlo.methods.healthsystem import HSI_Event</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="Tb"><a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.Tb">[docs]</a><span class="k">class</span> <span class="nc">Tb</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Set up the baseline population with TB prevalence</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Tb.__init__"><a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.Tb.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resourcefilepath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resourcefilepath</span> <span class="o">=</span> <span class="n">resourcefilepath</span></div>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    PARAMETERS = {</span>
<span class="sd">        # workbooks</span>
<span class="sd">        &quot;prop_latent_2010&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;Proportion of population with latent tb in 2010&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;prop_active_2010&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;Proportion of population with active tb in 2010&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;pulm_tb&quot;: Parameter(Types.REAL, &quot;probability of pulmonary tb&quot;),</span>
<span class="sd">        &quot;followup_times&quot;: Parameter(</span>
<span class="sd">            Types.INT, &quot;times(weeks) tb treatment monitoring required after tx start&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;tb_high_risk_distr&quot;: Parameter(Types.LIST, &quot;list of ten high-risk districts&quot;),</span>
<span class="sd">        &quot;ipt_contact_cov&quot;: Parameter(</span>
<span class="sd">            Types.REAL,</span>
<span class="sd">            &quot;coverage of IPT among contacts of TB cases in high-risk districts&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;bcg_coverage_year&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;bcg coverage estimates in children &lt;1 years by calendar year&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;initial_bcg_coverage&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;bcg coverage by age in baseline population&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        # baseline population</span>
<span class="sd">        &quot;prop_mdr2010&quot;: Parameter(</span>
<span class="sd">            Types.REAL,</span>
<span class="sd">            &quot;Proportion of active tb cases with multidrug resistance in 2010&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">        # natural history</span>
<span class="sd">        &quot;transmission_rate&quot;: Parameter(Types.REAL, &quot;TB transmission rate, calibrated&quot;),</span>
<span class="sd">        &quot;rel_inf_smear_ng&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;relative infectiousness of tb in hiv+ compared with hiv-&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;rel_inf_poor_tx&quot;: Parameter(</span>
<span class="sd">            Types.REAL,</span>
<span class="sd">            &quot;relative infectiousness of tb in treated people with poor adherence&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;rr_bcg_inf&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;relative risk of tb infection with bcg vaccination&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;monthly_prob_relapse_tx_complete&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;monthly probability of relapse once treatment complete&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;monthly_prob_relapse_tx_incomplete&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;monthly probability of relapse if treatment incomplete&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;monthly_prob_relapse_2yrs&quot;: Parameter(</span>
<span class="sd">            Types.REAL,</span>
<span class="sd">            &quot;monthly probability of relapse 2 years after treatment complete&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;rr_relapse_hiv&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;relative risk of relapse for HIV-positive people&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;r_trans_mdr&quot;: Parameter(</span>
<span class="sd">            Types.REAL,</span>
<span class="sd">            &quot;relative transmissibility of MDR compared with drug-susceptible TB&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;p_mdr_new&quot;: Parameter(</span>
<span class="sd">            Types.REAL,</span>
<span class="sd">            &quot;probability of MDR emergence per treatment course – new patients&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;p_mdr_retreat&quot;: Parameter(</span>
<span class="sd">            Types.REAL,</span>
<span class="sd">            &quot;multiplier for probability of MDR emergence per treatment course – re-treatment&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;p_mdr_tx_fail&quot;: Parameter(</span>
<span class="sd">            Types.REAL,</span>
<span class="sd">            &quot;multiplier for probability of MDR emergence per treatment course – treatment failure&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">        # progression</span>
<span class="sd">        &quot;prop_fast_progressor&quot;: Parameter(</span>
<span class="sd">            Types.REAL,</span>
<span class="sd">            &quot;Proportion of infections that progress directly to active stage&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;prop_fast_progressor_hiv&quot;: Parameter(</span>
<span class="sd">            Types.REAL,</span>
<span class="sd">            &quot;proportion of HIV+ people not on ART progressing directly to active TB disease after infection&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;prog_active&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;risk of progressing to active tb within two years&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;prog_1yr&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;proportion children aged &lt;1 year progressing to active disease&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;prog_1_2yr&quot;: Parameter(</span>
<span class="sd">            Types.REAL,</span>
<span class="sd">            &quot;proportion children aged 1-2 year2 progressing to active disease&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;prog_2_5yr&quot;: Parameter(</span>
<span class="sd">            Types.REAL,</span>
<span class="sd">            &quot;proportion children aged 2-5 years progressing to active disease&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;prog_5_10yr&quot;: Parameter(</span>
<span class="sd">            Types.REAL,</span>
<span class="sd">            &quot;proportion children aged 5-10 years progressing to active disease&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;prog_10yr&quot;: Parameter(</span>
<span class="sd">            Types.REAL,</span>
<span class="sd">            &quot;proportion children aged 10-15 years progressing to active disease&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;monthly_prob_self_cure&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;monthly probability of self-cure&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;monthly_prob_self_cure_hiv&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;monthly probability of self-cure in plhiv&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        # clinical features</span>
<span class="sd">        &quot;prop_smear_positive&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;proportion of new active cases that will be smear-positive&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;prop_smear_positive_hiv&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;proportion of hiv+ active tb cases that will be smear-positive&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        # mortality</span>
<span class="sd">        &quot;monthly_prob_tb_mortality&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;mortality rate with active tb&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;monthly_prob_tb_mortality_hiv&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;mortality from tb with concurrent HIV&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;mort_cotrim&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;reduction in mortality rates due to cotrimoxazole prophylaxis&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;mort_tx&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;reduction in mortality rates due to effective tb treatment&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        # relative risks of progression to active disease</span>
<span class="sd">        &quot;rr_tb_bcg&quot;: Parameter(</span>
<span class="sd">            Types.REAL,</span>
<span class="sd">            &quot;relative risk of progression to active disease for children with BCG vaccine&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;rr_tb_hiv&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;relative risk of progression to active disease for PLHIV&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;rr_tb_aids&quot;: Parameter(</span>
<span class="sd">            Types.REAL,</span>
<span class="sd">            &quot;relative risk of progression to active disease for PLHIV with AIDS&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;rr_tb_art_adult&quot;: Parameter(</span>
<span class="sd">            Types.REAL,</span>
<span class="sd">            &quot;relative risk of progression to active disease for adults with HIV on ART&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;rr_tb_art_child&quot;: Parameter(</span>
<span class="sd">            Types.REAL,</span>
<span class="sd">            &quot;relative risk of progression to active disease for adults with HIV on ART&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;rr_tb_overweight&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;relative risk of progression to active disease if overweight&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;rr_tb_obese&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;relative risk of progression to active disease if obese&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;rr_tb_diabetes1&quot;: Parameter(</span>
<span class="sd">            Types.REAL,</span>
<span class="sd">            &quot;relative risk of progression to active disease with type 1 diabetes&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;rr_tb_alcohol&quot;: Parameter(</span>
<span class="sd">            Types.REAL,</span>
<span class="sd">            &quot;relative risk of progression to active disease with heavy alcohol use&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;rr_tb_smoking&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;relative risk of progression to active disease with smoking&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;dur_prot_ipt&quot;: Parameter(</span>
<span class="sd">            Types.REAL,</span>
<span class="sd">            &quot;duration in days of protection conferred by IPT against active TB&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;dur_prot_ipt_infant&quot;: Parameter(</span>
<span class="sd">            Types.REAL,</span>
<span class="sd">            &quot;duration days of protection conferred by IPT against active TB in infants&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;rr_ipt_adult&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;relative risk of active TB with IPT in adults&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;rr_ipt_child&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;relative risk of active TB with IPT in children&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;rr_ipt_adult_hiv&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;relative risk of active TB with IPT in adults with hiv&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;rr_ipt_child_hiv&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;relative risk of active TB with IPT in children with hiv&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;rr_ipt_art_adult&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;relative risk of active TB with IPT and ART in adults&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;rr_ipt_art_child&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;relative risk of active TB with IPT and ART in children&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        # health system interactions</span>
<span class="sd">        &quot;sens_xpert&quot;: Parameter(Types.REAL, &quot;sensitivity of Xpert test&quot;),</span>
<span class="sd">        &quot;sens_sputum_pos&quot;: Parameter(</span>
<span class="sd">            Types.REAL,</span>
<span class="sd">            &quot;sensitivity of sputum smear microscopy in sputum positive cases&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;sens_sputum_neg&quot;: Parameter(</span>
<span class="sd">            Types.REAL,</span>
<span class="sd">            &quot;sensitivity of sputum smear microscopy in sputum negative cases&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;sens_clinical&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;sensitivity of clinical diagnosis in detecting active TB&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;spec_clinical&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;specificity of clinical diagnosis in detecting TB&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;prob_tx_success_new&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;Probability of treatment success for new TB cases&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;prob_tx_success_prev&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;Probability of treatment success for previously treated cases&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;prob_tx_success_hiv&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;Probability of treatment success for PLHIV&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;prob_tx_success_mdr&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;Probability of treatment success for MDR-TB cases&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;prob_tx_success_extra&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;Probability of treatment success for extrapulmonary TB cases&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;prob_tx_success_0_4&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;Probability of treatment success for children aged 0-4 years&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;prob_tx_success_5_14&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;Probability of treatment success for children aged 5-14 years&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;prop_ltfu_tx&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;Proportion lost to follow-up during initial treatment&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;prop_ltfu_retx&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;Proportion lost to follow-up during retreatment&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;rate_testing_tb&quot;: Parameter(</span>
<span class="sd">            Types.REAL,</span>
<span class="sd">            &quot;rate of presenting for TB screening and testing for people with active TB&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;rr_testing_non_tb&quot;: Parameter(</span>
<span class="sd">            Types.REAL,</span>
<span class="sd">            &quot;rate ratio for TB testing without active TB compared with ative TB cases&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;rate_testing_hiv&quot;: Parameter(</span>
<span class="sd">            Types.REAL,</span>
<span class="sd">            &quot;rate of presenting for TB screening and testing for HIV-positive people with active TB&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;presump_testing&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;probability of an individual without tb requesting tb test&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        # daly weights, no daly weight for latent tb</span>
<span class="sd">        &quot;daly_wt_susc_tb&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;Drug-susecptible tuberculosis, not HIV infected&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;daly_wt_resistant_tb&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;multidrug-resistant tuberculosis, not HIV infected&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;daly_wt_susc_tb_hiv_severe_anaemia&quot;: Parameter(</span>
<span class="sd">            Types.REAL,</span>
<span class="sd">            &quot;# Drug-susecptible Tuberculosis, HIV infected and anemia, severe&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;daly_wt_susc_tb_hiv_moderate_anaemia&quot;: Parameter(</span>
<span class="sd">            Types.REAL,</span>
<span class="sd">            &quot;Drug-susecptible Tuberculosis, HIV infected and anemia, moderate&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;daly_wt_susc_tb_hiv_mild_anaemia&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;Drug-susecptible Tuberculosis, HIV infected and anemia, mild&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;daly_wt_susc_tb_hiv&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;Drug-susecptible Tuberculosis, HIV infected&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;daly_wt_resistant_tb_hiv_severe_anaemia&quot;: Parameter(</span>
<span class="sd">            Types.REAL,</span>
<span class="sd">            &quot;Multidrug resistant Tuberculosis, HIV infected and anemia, severe&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;daly_wt_resistant_tb_hiv&quot;: Parameter(</span>
<span class="sd">            Types.REAL, &quot;Multidrug resistant Tuberculosis, HIV infected&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;daly_wt_resistant_tb_hiv_moderate_anaemia&quot;: Parameter(</span>
<span class="sd">            Types.REAL,</span>
<span class="sd">            &quot;Multidrug resistant Tuberculosis, HIV infected and anemia, moderate&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;daly_wt_resistant_tb_hiv_mild_anaemia&quot;: Parameter(</span>
<span class="sd">            Types.REAL,</span>
<span class="sd">            &quot;Multidrug resistant Tuberculosis, HIV infected and anemia, mild&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">    }</span>

<span class="sd">    PROPERTIES = {</span>
<span class="sd">        &quot;tb_inf&quot;: Property(</span>
<span class="sd">            Types.CATEGORICAL,</span>
<span class="sd">            categories=[</span>
<span class="sd">                &quot;uninfected&quot;,</span>
<span class="sd">                &quot;latent_susc_new&quot;,</span>
<span class="sd">                &quot;active_susc_new&quot;,</span>
<span class="sd">                &quot;latent_susc_tx&quot;,</span>
<span class="sd">                &quot;active_susc_tx&quot;,</span>
<span class="sd">                &quot;latent_mdr_new&quot;,</span>
<span class="sd">                &quot;active_mdr_new&quot;,</span>
<span class="sd">                &quot;latent_mdr_tx&quot;,</span>
<span class="sd">                &quot;active_mdr_tx&quot;,</span>
<span class="sd">            ],</span>
<span class="sd">            description=&quot;tb status&quot;,</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;tb_date_active&quot;: Property(Types.DATE, &quot;Date active tb started&quot;),</span>
<span class="sd">        &quot;tb_any_resp_symptoms&quot;: Property(Types.DATE, &quot;Date of symptom start&quot;),</span>
<span class="sd">        &quot;tb_smear&quot;: Property(Types.BOOL, &quot;smear positivity with active infection&quot;),</span>
<span class="sd">        &quot;tb_date_latent&quot;: Property(</span>
<span class="sd">            Types.DATE, &quot;Date acquired tb infection (latent stage)&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;tb_ever_tb&quot;: Property(Types.BOOL, &quot;if ever had active drug-susceptible tb&quot;),</span>
<span class="sd">        &quot;tb_ever_tb_mdr&quot;: Property(</span>
<span class="sd">            Types.BOOL, &quot;if ever had active multi-drug resistant tb&quot;</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;tb_stage&quot;: Property(</span>
<span class="sd">            Types.CATEGORICAL,</span>
<span class="sd">            &quot;Level of symptoms for tb&quot;,</span>
<span class="sd">            categories=[&quot;none&quot;, &quot;latent&quot;, &quot;active_pulm&quot;, &quot;active_extra&quot;],</span>
<span class="sd">        ),</span>
<span class="sd">        &quot;tb_ever_tested&quot;: Property(Types.BOOL, &quot;ever had a tb test&quot;),</span>
<span class="sd">        &quot;tb_smear_test&quot;: Property(Types.BOOL, &quot;ever had a tb smear test&quot;),</span>
<span class="sd">        &quot;tb_result_smear_test&quot;: Property(Types.BOOL, &quot;result from tb smear test&quot;),</span>
<span class="sd">        &quot;tb_date_smear_test&quot;: Property(Types.DATE, &quot;date of tb smear test&quot;),</span>
<span class="sd">        &quot;tb_xpert_test&quot;: Property(Types.BOOL, &quot;ever had a tb Xpert test&quot;),</span>
<span class="sd">        &quot;tb_result_xpert_test&quot;: Property(Types.BOOL, &quot;result from tb Xpert test&quot;),</span>
<span class="sd">        &quot;tb_date_xpert_test&quot;: Property(Types.DATE, &quot;date of tb Xpert test&quot;),</span>
<span class="sd">        &quot;tb_diagnosed&quot;: Property(Types.BOOL, &quot;current diagnosis of active tb&quot;),</span>
<span class="sd">        &quot;tb_mdr_diagnosed&quot;: Property(Types.BOOL, &quot;current diagnosis of active tb_mdr&quot;),</span>
<span class="sd">        &quot;tb_on_treatment&quot;: Property(Types.BOOL, &quot;on tb treatment regimen&quot;),</span>
<span class="sd">        &quot;tb_date_treated&quot;: Property(Types.DATE, &quot;date tb treatment started&quot;),</span>
<span class="sd">        &quot;tb_treatment_failure&quot;: Property(Types.BOOL, &quot;failed first line tb treatment&quot;),</span>
<span class="sd">        &quot;tb_treated_mdr&quot;: Property(Types.BOOL, &quot;on tb treatment MDR regimen&quot;),</span>
<span class="sd">        &quot;tb_date_treated_mdr&quot;: Property(Types.DATE, &quot;date tb MDR treatment started&quot;),</span>
<span class="sd">        &quot;tb_on_ipt&quot;: Property(Types.BOOL, &quot;if currently on ipt&quot;),</span>
<span class="sd">        &quot;tb_date_ipt&quot;: Property(Types.DATE, &quot;date ipt started&quot;),</span>
<span class="sd">        &quot;tb_date_death&quot;: Property(Types.DATE, &quot;date of tb death&quot;),</span>
<span class="sd">        &quot;tb_date_death_occurred&quot;: Property(Types.DATE, &quot;date of tb death&quot;),</span>
<span class="sd">        &quot;tb_bcg&quot;: Property(Types.BOOL, &quot;received BCG vaccination&quot;),</span>
<span class="sd">        &quot;tb_symptoms&quot;: Property(Types.BOOL, &quot;tb-like symptoms present&quot;),</span>
<span class="sd">    }</span>

<span class="sd">    # cough and fever are part of generic symptoms</span>
<span class="sd">    SYMPTOMS = {&quot;fatigue&quot;, &quot;night_sweats&quot;}</span>

<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Tb.read_parameters"><a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.Tb.read_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">read_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_folder</span><span class="p">):</span>
        <span class="k">pass</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        workbook = pd.read_excel(</span>
<span class="sd">            os.path.join(self.resourcefilepath, &quot;ResourceFile_TB.xlsx&quot;), sheet_name=None</span>
<span class="sd">        )</span>
<span class="sd">        self.load_parameters_from_dataframe(workbook[&quot;parameters&quot;])</span>

<span class="sd">        p = self.parameters</span>

<span class="sd">        # workbooks</span>
<span class="sd">        p[&quot;prop_active_2010&quot;], p[&quot;prop_latent_2010&quot;] = (</span>
<span class="sd">            workbook[&quot;cases2010district&quot;],</span>
<span class="sd">            workbook[&quot;Latent_TB_prob&quot;],</span>
<span class="sd">        )</span>
<span class="sd">        p[&quot;pulm_tb&quot;] = workbook[&quot;pulm_tb&quot;]</span>
<span class="sd">        p[&quot;followup_times&quot;] = workbook[&quot;followup&quot;]</span>
<span class="sd">        p[&quot;tb_high_risk_distr&quot;] = workbook[&quot;IPTdistricts&quot;]</span>
<span class="sd">        p[&quot;ipt_contact_cov&quot;] = workbook[&quot;ipt_coverage&quot;]</span>
<span class="sd">        p[&quot;bcg_coverage_year&quot;] = workbook[&quot;BCG&quot;]</span>
<span class="sd">        p[&quot;initial_bcg_coverage&quot;] = workbook[&quot;BCG_baseline&quot;]</span>

<span class="sd">        # get the DALY weight that this module will use from the weight database</span>
<span class="sd">        if &quot;HealthBurden&quot; in self.sim.modules.keys():</span>
<span class="sd">            p[&quot;daly_wt_susc_tb&quot;] = self.sim.modules[&quot;HealthBurden&quot;].get_daly_weight(</span>
<span class="sd">                0</span>
<span class="sd">            )  # Drug-susecptible tuberculosis, not HIV infected</span>
<span class="sd">            p[&quot;daly_wt_resistant_tb&quot;] = self.sim.modules[</span>
<span class="sd">                &quot;HealthBurden&quot;</span>
<span class="sd">            ].get_daly_weight(</span>
<span class="sd">                1</span>
<span class="sd">            )  # multidrug-resistant tuberculosis, not HIV infected</span>
<span class="sd">            p[&quot;daly_wt_susc_tb_hiv_severe_anaemia&quot;] = self.sim.modules[</span>
<span class="sd">                &quot;HealthBurden&quot;</span>
<span class="sd">            ].get_daly_weight(</span>
<span class="sd">                4</span>
<span class="sd">            )  # Drug-susecptible Tuberculosis, HIV infected and anemia, severe</span>
<span class="sd">            p[&quot;daly_wt_susc_tb_hiv_moderate_anaemia&quot;] = self.sim.modules[</span>
<span class="sd">                &quot;HealthBurden&quot;</span>
<span class="sd">            ].get_daly_weight(</span>
<span class="sd">                5</span>
<span class="sd">            )  # Drug-susecptible Tuberculosis, HIV infected and anemia, moderate</span>
<span class="sd">            p[&quot;daly_wt_susc_tb_hiv_mild_anaemia&quot;] = self.sim.modules[</span>
<span class="sd">                &quot;HealthBurden&quot;</span>
<span class="sd">            ].get_daly_weight(</span>
<span class="sd">                6</span>
<span class="sd">            )  # Drug-susecptible Tuberculosis, HIV infected and anemia, mild</span>
<span class="sd">            p[&quot;daly_wt_susc_tb_hiv&quot;] = self.sim.modules[&quot;HealthBurden&quot;].get_daly_weight(</span>
<span class="sd">                7</span>
<span class="sd">            )  # Drug-susecptible Tuberculosis, HIV infected</span>
<span class="sd">            p[&quot;daly_wt_resistant_tb_hiv_severe_anaemia&quot;] = self.sim.modules[</span>
<span class="sd">                &quot;HealthBurden&quot;</span>
<span class="sd">            ].get_daly_weight(</span>
<span class="sd">                8</span>
<span class="sd">            )  # Multidrug resistant Tuberculosis, HIV infected and anemia, severe</span>
<span class="sd">            p[&quot;daly_wt_resistant_tb_hiv&quot;] = self.sim.modules[</span>
<span class="sd">                &quot;HealthBurden&quot;</span>
<span class="sd">            ].get_daly_weight(</span>
<span class="sd">                9</span>
<span class="sd">            )  # Multidrug resistant Tuberculosis, HIV infected</span>
<span class="sd">            p[&quot;daly_wt_resistant_tb_hiv_moderate_anaemia&quot;] = self.sim.modules[</span>
<span class="sd">                &quot;HealthBurden&quot;</span>
<span class="sd">            ].get_daly_weight(</span>
<span class="sd">                10</span>
<span class="sd">            )  # Multidrug resistant Tuberculosis, HIV infected and anemia, moderate</span>
<span class="sd">            p[&quot;daly_wt_resistant_tb_hiv_mild_anaemia&quot;] = self.sim.modules[</span>
<span class="sd">                &quot;HealthBurden&quot;</span>
<span class="sd">            ].get_daly_weight(</span>
<span class="sd">                11</span>
<span class="sd">            )  # Multidrug resistant Tuberculosis, HIV infected and anemia, mild</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="Tb.initialise_population"><a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.Tb.initialise_population">[docs]</a>    <span class="k">def</span> <span class="nf">initialise_population</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
        <span class="k">pass</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set our property values for the initial population.</span>

<span class="sd">        df = population.props</span>
<span class="sd">        now = self.sim.date</span>
<span class="sd">        params = self.parameters</span>

<span class="sd">        # set-up baseline population</span>
<span class="sd">        df[&quot;tb_inf&quot;].values[:] = &quot;uninfected&quot;</span>
<span class="sd">        df[&quot;tb_date_active&quot;] = pd.NaT</span>
<span class="sd">        df[&quot;tb_any_resp_symptoms&quot;] = pd.NaT</span>
<span class="sd">        df[&quot;tb_smear&quot;] = False</span>
<span class="sd">        df[&quot;tb_date_latent&quot;] = pd.NaT</span>

<span class="sd">        df[&quot;tb_ever_tb&quot;] = False</span>
<span class="sd">        df[&quot;tb_ever_tb_mdr&quot;] = False</span>

<span class="sd">        df[&quot;tb_stage&quot;].values[:] = &quot;none&quot;</span>

<span class="sd">        df[&quot;tb_ever_tested&quot;] = False  # default: no individuals tested</span>
<span class="sd">        df[&quot;tb_smear_test&quot;] = False</span>
<span class="sd">        df[&quot;tb_result_smear_test&quot;] = False</span>
<span class="sd">        df[&quot;tb_date_smear_test&quot;] = pd.NaT</span>
<span class="sd">        df[&quot;tb_xpert_test&quot;] = False</span>
<span class="sd">        df[&quot;tb_result_xpert_test&quot;] = False</span>
<span class="sd">        df[&quot;tb_date_xpert_test&quot;] = pd.NaT</span>
<span class="sd">        df[&quot;tb_diagnosed&quot;] = False</span>
<span class="sd">        df[&quot;tb_mdr_diagnosed&quot;] = False</span>
<span class="sd">        df[&quot;tb_on_treatment&quot;] = False</span>
<span class="sd">        df[&quot;tb_date_treated&quot;] = pd.NaT</span>
<span class="sd">        df[&quot;tb_treatment_failure&quot;] = False</span>
<span class="sd">        df[&quot;tb_treated_mdr&quot;] = False</span>
<span class="sd">        df[&quot;tb_date_treated_mdr&quot;] = pd.NaT</span>
<span class="sd">        df[&quot;tb_on_ipt&quot;] = False</span>
<span class="sd">        df[&quot;tb_date_ipt&quot;] = pd.NaT</span>
<span class="sd">        df[&quot;tb_date_death&quot;] = pd.NaT</span>
<span class="sd">        df[&quot;tb_date_death_occurred&quot;] = pd.NaT</span>
<span class="sd">        df[&quot;tb_bcg&quot;] = False</span>
<span class="sd">        df[&quot;tb_symptoms&quot;] = False</span>

<span class="sd">        self.bcg(population)  # assign bcg vaccine to baseline population</span>

<span class="sd">        # TB infections - active / latent</span>
<span class="sd">        # baseline infections not weighted by RR, randomly assigned</span>
<span class="sd">        active_tb_data = self.parameters[&quot;prop_active_2010&quot;]</span>
<span class="sd">        latent_tb_data = self.parameters[&quot;prop_latent_2010&quot;]</span>

<span class="sd">        # ~~~~~~~~~~~~~~~~~~~~~~~~~~ LATENT ~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">        # merge all susceptible individuals with their hiv probability based on sex and age</span>
<span class="sd">        df_tbprob = df.merge(</span>
<span class="sd">            latent_tb_data,</span>
<span class="sd">            left_on=[&quot;age_years&quot;, &quot;sex&quot;],</span>
<span class="sd">            right_on=[&quot;age&quot;, &quot;sex&quot;],</span>
<span class="sd">            how=&quot;left&quot;,</span>
<span class="sd">        )</span>

<span class="sd">        # fill missing values with 0 (only relevant for age 80+)</span>
<span class="sd">        df_tbprob[&quot;prob_latent_tb&quot;] = df_tbprob[&quot;prob_latent_tb&quot;].fillna(0)</span>

<span class="sd">        assert (</span>
<span class="sd">            df_tbprob.prob_latent_tb.isna().sum() == 0</span>
<span class="sd">        )  # check there is a probability for every individual</span>

<span class="sd">        # assign risk of latent tb</span>
<span class="sd">        risk_tb = pd.Series(1, index=df.index)</span>
<span class="sd">        risk_tb.loc[df.is_alive &amp; df.tb_bcg &amp; (df.age_years &lt; 10)] *= params[</span>
<span class="sd">            &quot;rr_bcg_inf&quot;</span>
<span class="sd">        ]</span>

<span class="sd">        # weight the likelihood of being sampled by the relative risk</span>
<span class="sd">        # norm_p = pd.Series(risk_tb)</span>
<span class="sd">        # norm_p /= norm_p.sum()  # normalise</span>

<span class="sd">        # get a list of random numbers between 0 and 1 for each infected individual</span>
<span class="sd">        random_draw = self.rng.random_sample(size=len(df_tbprob))</span>
<span class="sd">        tb_idx = df_tbprob.index[df.is_alive &amp; (random_draw &lt; df_tbprob.prob_latent_tb)]</span>
<span class="sd">        # tb_idx = df_tbprob.index[df.is_alive &amp; (random_draw &lt; (df_tbprob.prob_latent_tb * norm_p))]</span>

<span class="sd">        df.loc[tb_idx, &quot;tb_inf&quot;] = &quot;latent_susc_new&quot;</span>
<span class="sd">        df.loc[tb_idx, &quot;tb_date_latent&quot;] = now</span>
<span class="sd">        df.loc[tb_idx, &quot;tb_stage&quot;] = &quot;latent&quot;</span>

<span class="sd">        # allocate some latent infections as mdr-tb</span>
<span class="sd">        if len(df[df.is_alive &amp; (df.tb_inf == &quot;latent_susc_new&quot;)]) &gt; 10:</span>
<span class="sd">            idx_c = (</span>
<span class="sd">                df[df.is_alive &amp; (df.tb_inf == &quot;latent_susc_new&quot;)]</span>
<span class="sd">                .sample(frac=self.parameters[&quot;prop_mdr2010&quot;])</span>
<span class="sd">                .index</span>
<span class="sd">            )</span>

<span class="sd">            df.loc[idx_c, &quot;tb_inf&quot;] = &quot;latent_mdr_new&quot;  # change to mdr-tb</span>
<span class="sd">            df.loc[idx_c, &quot;tb_stage&quot;] = &quot;latent&quot;</span>

<span class="sd">        # ~~~~~~~~~~~~~~~~~~~~~~~~~~ ACTIVE ~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="sd">        # prob of active case by district</span>
<span class="sd">        df_active_prob = df.merge(</span>
<span class="sd">            active_tb_data,</span>
<span class="sd">            left_on=[&quot;district_of_residence&quot;],</span>
<span class="sd">            right_on=[&quot;district&quot;],</span>
<span class="sd">            how=&quot;left&quot;,</span>
<span class="sd">        )</span>
<span class="sd">        assert (</span>
<span class="sd">            df_active_prob.general_prob.isna().sum() == 0</span>
<span class="sd">        )  # check there is a probability for every individual</span>

<span class="sd">        # get a list of random numbers between 0 and 1 for each infected individual</span>
<span class="sd">        random_draw = self.rng.random_sample(size=len(df_active_prob))</span>
<span class="sd">        active_idx = df_active_prob.index[</span>
<span class="sd">            df.is_alive &amp; (random_draw &lt; df_active_prob.general_prob)</span>
<span class="sd">        ]</span>

<span class="sd">        # if &gt;10 active cases, sample some mdr cases</span>
<span class="sd">        if len(active_idx) &gt; 10:</span>

<span class="sd">            # sample from active to get mdr-tb cases</span>
<span class="sd">            idx = df.loc[active_idx].sample(frac=self.parameters[&quot;prop_mdr2010&quot;]).index</span>

<span class="sd">            # if some mdr-cases</span>
<span class="sd">            if not idx.isnull().all():</span>

<span class="sd">                for person_id in active_idx:</span>
<span class="sd">                    # print(person_id)</span>
<span class="sd">                    # random draw of days 0-365</span>
<span class="sd">                    random_day = self.rng.randint(low=0, high=364)</span>
<span class="sd">                    pd_day = now + pd.to_timedelta(random_day, unit=&quot;d&quot;)</span>

<span class="sd">                    # if not sampled for mdr, schedule onset active drug-susceptible</span>
<span class="sd">                    if person_id not in idx:</span>

<span class="sd">                        logger.debug(</span>
<span class="sd">                            &quot;This is Tb, scheduling active disease for person %d on date %s&quot;,</span>
<span class="sd">                            person_id,</span>
<span class="sd">                            pd_day,</span>
<span class="sd">                        )</span>

<span class="sd">                        # schedule active disease</span>
<span class="sd">                        self.sim.schedule_event(TbActiveEvent(self, person_id), pd_day)</span>

<span class="sd">                    else:</span>
<span class="sd">                        logger.debug(</span>
<span class="sd">                            &quot;This is Tb, scheduling mdr-active disease for person %d on date %s&quot;,</span>
<span class="sd">                            person_id,</span>
<span class="sd">                            pd_day,</span>
<span class="sd">                        )</span>

<span class="sd">                        # schedule active disease</span>
<span class="sd">                        self.sim.schedule_event(</span>
<span class="sd">                            TbMdrActiveEvent(self, person_id), pd_day</span>
<span class="sd">                        )</span>

<span class="sd">            # if no mdr cases have been sampled</span>
<span class="sd">            else:</span>
<span class="sd">                for person_id in active_idx:</span>
<span class="sd">                    # print(person_id)</span>
<span class="sd">                    # random draw of days 0-365</span>
<span class="sd">                    random_day = self.rng.randint(low=0, high=364)</span>
<span class="sd">                    pd_day = now + pd.to_timedelta(random_day, unit=&quot;d&quot;)</span>

<span class="sd">                    logger.debug(</span>
<span class="sd">                        &quot;This is Tb, scheduling active disease for person %d on date %s&quot;,</span>
<span class="sd">                        person_id,</span>
<span class="sd">                        pd_day,</span>
<span class="sd">                    )</span>

<span class="sd">                    # schedule active disease</span>
<span class="sd">                    self.sim.schedule_event(TbActiveEvent(self, person_id), pd_day)</span>

<span class="sd">        # if &lt;10 active cases</span>
<span class="sd">        else:</span>
<span class="sd">            for person_id in active_idx:</span>
<span class="sd">                # print(person_id)</span>
<span class="sd">                # random draw of days 0-365</span>
<span class="sd">                random_day = self.rng.randint(low=0, high=364)</span>
<span class="sd">                pd_day = now + pd.to_timedelta(random_day, unit=&quot;d&quot;)</span>

<span class="sd">                logger.debug(</span>
<span class="sd">                    &quot;This is Tb, scheduling active disease for person %d on date %s&quot;,</span>
<span class="sd">                    person_id,</span>
<span class="sd">                    pd_day,</span>
<span class="sd">                )</span>

<span class="sd">                # schedule active disease</span>
<span class="sd">                self.sim.schedule_event(TbActiveEvent(self, person_id), pd_day)</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="Tb.bcg"><a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.Tb.bcg">[docs]</a>    <span class="k">def</span> <span class="nf">bcg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
        <span class="k">pass</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign BCG vaccination to baseline population</span>
<span class="sd">        may have already been assigned active TB, should be ok as bcg not 100% protective</span>

<span class="sd">        df = population.props</span>
<span class="sd">        params = self.parameters</span>

<span class="sd">        bcg_cov = params[&quot;initial_bcg_coverage&quot;]</span>

<span class="sd">        df_bcg = df.merge(bcg_cov, left_on=[&quot;age_years&quot;], right_on=[&quot;Age&quot;], how=&quot;left&quot;)</span>

<span class="sd">        # fill missing values with 0 (only relevant for age 80+)</span>
<span class="sd">        df_bcg[&quot;bcg_coverage&quot;] = df_bcg[&quot;bcg_coverage&quot;].fillna(0)</span>
<span class="sd">        assert (</span>
<span class="sd">            df_bcg.bcg_coverage.isna().sum() == 0</span>
<span class="sd">        )  # check there is a probability for every individual</span>

<span class="sd">        # get a list of random numbers between 0 and 1 for each infected individual</span>
<span class="sd">        random_draw = self.rng.random_sample(size=len(df_bcg))</span>

<span class="sd">        # probability of bcg &gt; random number, assign bcg = True</span>
<span class="sd">        bcg_idx = df_bcg.index[df.is_alive &amp; (random_draw &lt; df_bcg.bcg_coverage)]</span>

<span class="sd">        df.loc[bcg_idx, &quot;tb_bcg&quot;] = True</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="Tb.initialise_simulation"><a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.Tb.initialise_simulation">[docs]</a>    <span class="k">def</span> <span class="nf">initialise_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span><span class="p">):</span>
        <span class="k">pass</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sim.schedule_event(TbEvent(self), sim.date + DateOffset(months=12))</span>
<span class="sd">        sim.schedule_event(TbRelapseEvent(self), sim.date + DateOffset(months=1))</span>
<span class="sd">        sim.schedule_event(TbSelfCureEvent(self), sim.date + DateOffset(months=1))</span>

<span class="sd">        sim.schedule_event(TbMdrEvent(self), sim.date + DateOffset(months=12))</span>
<span class="sd">        sim.schedule_event(TbMdrRelapseEvent(self), sim.date + DateOffset(months=1))</span>
<span class="sd">        sim.schedule_event(TbMdrSelfCureEvent(self), sim.date + DateOffset(months=1))</span>

<span class="sd">        # sim.schedule_event(TbScheduleTesting(self), sim.date + DateOffset(days=1))</span>

<span class="sd">        # sim.schedule_event(NonTbSymptomsEvent(self), sim.date + DateOffset(months=1))</span>

<span class="sd">        sim.schedule_event(TbDeathEvent(self), sim.date + DateOffset(months=1))</span>
<span class="sd">        sim.schedule_event(TbMdrDeathEvent(self), sim.date + DateOffset(months=1))</span>

<span class="sd">        # Logging</span>
<span class="sd">        sim.schedule_event(TbLoggingEvent(self), sim.date + DateOffset(days=0))</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="Tb.on_birth"><a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.Tb.on_birth">[docs]</a>    <span class="k">def</span> <span class="nf">on_birth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mother_id</span><span class="p">,</span> <span class="n">child_id</span><span class="p">):</span>
        <span class="k">pass</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialise our properties for a newborn individual.</span>

<span class="sd">        df = self.sim.population.props</span>
<span class="sd">        now = self.sim.date</span>

<span class="sd">        df.at[child_id, &quot;tb_inf&quot;] = &quot;uninfected&quot;</span>
<span class="sd">        df.at[child_id, &quot;tb_date_active&quot;] = pd.NaT</span>
<span class="sd">        df.at[child_id, &quot;tb_any_resp_symptoms&quot;] = pd.NaT</span>
<span class="sd">        df.at[child_id, &quot;tb_smear&quot;] = False</span>
<span class="sd">        df.at[child_id, &quot;tb_date_latent&quot;] = pd.NaT</span>
<span class="sd">        df.at[child_id, &quot;tb_ever_tb&quot;] = False</span>
<span class="sd">        df.at[child_id, &quot;tb_ever_tb_mdr&quot;] = False</span>
<span class="sd">        df.at[child_id, &quot;tb_stage&quot;] = &quot;none&quot;</span>

<span class="sd">        df.at[child_id, &quot;tb_ever_tested&quot;] = False  # default: not tested</span>
<span class="sd">        df.at[child_id, &quot;tb_smear_test&quot;] = False</span>
<span class="sd">        df.at[child_id, &quot;tb_result_smear_test&quot;] = False</span>
<span class="sd">        df.at[child_id, &quot;tb_date_smear_test&quot;] = pd.NaT</span>
<span class="sd">        df.at[child_id, &quot;tb_xpert_test&quot;] = False</span>
<span class="sd">        df.at[child_id, &quot;tb_result_xpert_test&quot;] = False</span>
<span class="sd">        df.at[child_id, &quot;tb_date_xpert_test&quot;] = pd.NaT</span>
<span class="sd">        df.at[child_id, &quot;tb_diagnosed&quot;] = False</span>
<span class="sd">        df.at[child_id, &quot;tb_mdr_diagnosed&quot;] = False</span>
<span class="sd">        df.at[child_id, &quot;tb_on_treatment&quot;] = False</span>
<span class="sd">        df.at[child_id, &quot;tb_date_treated&quot;] = pd.NaT</span>
<span class="sd">        df.at[child_id, &quot;tb_treatment_failure&quot;] = False</span>
<span class="sd">        df.at[child_id, &quot;tb_treated_mdr&quot;] = False</span>
<span class="sd">        df.at[child_id, &quot;tb_date_treated_mdr&quot;] = pd.NaT</span>
<span class="sd">        df.at[child_id, &quot;tb_on_ipt&quot;] = False</span>
<span class="sd">        df.at[child_id, &quot;tb_date_ipt&quot;] = pd.NaT</span>
<span class="sd">        df.at[child_id, &quot;tb_date_death&quot;] = pd.NaT</span>
<span class="sd">        df.at[child_id, &quot;tb_date_death_occurred&quot;] = pd.NaT</span>
<span class="sd">        df.at[child_id, &quot;tb_bcg&quot;] = False</span>
<span class="sd">        df.at[child_id, &quot;tb_symptoms&quot;] = False</span>

<span class="sd">        # if mother is diagnosed with TB, give IPT to infant</span>
<span class="sd">        if df.at[mother_id, &quot;tb_diagnosed&quot;]:</span>
<span class="sd">            event = HSI_Tb_Ipt(self, person_id=child_id)</span>
<span class="sd">            self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="sd">                event,</span>
<span class="sd">                priority=1,</span>
<span class="sd">                topen=self.sim.date,</span>
<span class="sd">                tclose=self.sim.date + DateOffset(weeks=4),</span>
<span class="sd">            )</span>

<span class="sd">        # assign bcg according to current coverage</span>
<span class="sd">        bcg_cov_yr = self.parameters[&quot;bcg_coverage_year&quot;]</span>

<span class="sd">        bcg_curr_yr = (</span>
<span class="sd">            bcg_cov_yr.loc[bcg_cov_yr.Year == now.year, [&quot;bcg_coverage&quot;]]</span>
<span class="sd">        ).values[0] / 100</span>

<span class="sd">        if self.rng.random_sample(size=1) &lt; bcg_curr_yr:</span>
<span class="sd">            df.at[child_id, &quot;tb_bcg&quot;] = True</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="Tb.on_hsi_alert"><a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.Tb.on_hsi_alert">[docs]</a>    <span class="k">def</span> <span class="nf">on_hsi_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">treatment_id</span><span class="p">):</span>
        <span class="k">pass</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is called whenever there is an HSI event commissioned by one of the other disease modules.</span>

<span class="sd">        logger.debug(</span>
<span class="sd">            &quot;This is TB, being alerted about a health system interaction &quot;</span>
<span class="sd">            &quot;person %d for: %s&quot;,</span>
<span class="sd">            person_id,</span>
<span class="sd">            treatment_id,</span>
<span class="sd">        )</span>

<span class="sd">        # create list of appts which link to tb screening</span>
<span class="sd">        id_list = [</span>
<span class="sd">            &quot;Hiv_Testing&quot;,</span>
<span class="sd">            &quot;Hiv_TestingInfant&quot;,</span>
<span class="sd">            &quot;Hiv_InfantTreatmentInitiation&quot;,</span>
<span class="sd">            &quot;Hiv_TreatmentInitiation&quot;,</span>
<span class="sd">            &quot;Hiv_Treatment&quot;,</span>
<span class="sd">        ]</span>

<span class="sd">        if treatment_id in id_list:</span>
<span class="sd">            piggy_back_dx_at_appt = HSI_Tb_Screening(self, person_id)</span>
<span class="sd">            piggy_back_dx_at_appt.TREATMENT_ID = &quot;Tb_Screening_PiggybackAppt&quot;</span>

<span class="sd">            # Arbitrarily reduce the size of appt footprint to reflect that this is a piggy back appt</span>
<span class="sd">            for key in piggy_back_dx_at_appt.EXPECTED_APPT_FOOTPRINT:</span>
<span class="sd">                piggy_back_dx_at_appt.EXPECTED_APPT_FOOTPRINT[key] = (</span>
<span class="sd">                    piggy_back_dx_at_appt.EXPECTED_APPT_FOOTPRINT[key] * 0.5</span>
<span class="sd">                )</span>

<span class="sd">            self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="sd">                piggy_back_dx_at_appt, priority=0, topen=self.sim.date, tclose=None</span>
<span class="sd">            )</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="Tb.report_daly_values"><a class="viewcode-back" href="../../../reference/tlo.methods.tb.html#tlo.methods.tb.Tb.report_daly_values">[docs]</a>    <span class="k">def</span> <span class="nf">report_daly_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        # This must send back a pd.Series or pd.DataFrame that reports on the average daly-weights that have been</span>
<span class="sd">        # experienced by persons in the previous month. Only rows for alive-persons must be returned.</span>
<span class="sd">        # The names of the series of columns is taken to be the label of the cause of this disability.</span>
<span class="sd">        # It will be recorded by the healthburden module as &lt;ModuleName&gt;_&lt;Cause&gt;.</span>
<span class="sd">        logger.debug(&quot;This is tb reporting my health values&quot;)</span>

<span class="sd">        df = self.sim.population.props  # shortcut to population properties dataframe</span>
<span class="sd">        params = self.parameters</span>

<span class="sd">        health_values = pd.Series(0, index=df.index)</span>

<span class="sd">        health_values.loc[</span>
<span class="sd">            df[&quot;tb_inf&quot;].str.contains(&quot;active_susc&quot;) &amp; ~df.hv_inf &amp; df.is_alive</span>
<span class="sd">        ] = params[&quot;daly_wt_susc_tb&quot;]</span>
<span class="sd">        health_values.loc[</span>
<span class="sd">            df[&quot;tb_inf&quot;].str.contains(&quot;active_mdr&quot;) &amp; ~df.hv_inf &amp; df.is_alive</span>
<span class="sd">        ] = params[&quot;daly_wt_resistant_tb&quot;]</span>

<span class="sd">        health_values.loc[</span>
<span class="sd">            df[&quot;tb_inf&quot;].str.contains(&quot;active_susc&quot;) &amp; df.hv_inf &amp; df.is_alive</span>
<span class="sd">        ] = params[&quot;daly_wt_susc_tb_hiv&quot;]</span>
<span class="sd">        health_values.loc[</span>
<span class="sd">            df[&quot;tb_inf&quot;].str.contains(&quot;active_mdr&quot;) &amp; df.hv_inf &amp; df.is_alive</span>
<span class="sd">        ] = params[&quot;daly_wt_resistant_tb_hiv&quot;]</span>

<span class="sd">        health_values.name = &quot;tb Symptoms&quot;  # label the cause of this disability</span>

<span class="sd">        return health_values.loc[df.is_alive]</span>
<span class="sd">    &quot;&quot;&quot;</span></div></div>

<span class="c1">#</span>
<span class="c1"># # ---------------------------------------------------------------------------</span>
<span class="c1"># #   TB infection event</span>
<span class="c1"># # ---------------------------------------------------------------------------</span>
<span class="c1"># # TODO should transmission be limited within each district?</span>
<span class="c1"># # TODO add relative infectiousness for those on poor tx [prop tx failure]</span>
<span class="c1"># # TODO rel inf for smear negative - weight inf by prop smear negative</span>
<span class="c1"># # TODO age/sex distribution for new cases?</span>
<span class="c1"># class TbEvent(RegularEvent, PopulationScopeEventMixin):</span>
<span class="c1">#     &quot;&quot;&quot; tb infection events</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self, module):</span>
<span class="c1">#         super().__init__(module, frequency=DateOffset(months=1))  # every 1 month</span>
<span class="c1">#</span>
<span class="c1">#     def apply(self, population):</span>
<span class="c1">#         params = self.module.parameters</span>
<span class="c1">#         now = self.sim.date</span>
<span class="c1">#         rng = self.module.rng</span>
<span class="c1">#</span>
<span class="c1">#         df = population.props</span>
<span class="c1">#</span>
<span class="c1">#         # ----------------------------------- FORCE OF INFECTION -----------------------------------</span>
<span class="c1">#</span>
<span class="c1">#         # apply a force of infection to produce new latent cases</span>
<span class="c1">#         # no age distribution for FOI but the relative risks would affect distribution of active infections</span>
<span class="c1">#         # smear-positive cases by district</span>
<span class="c1">#         df[&quot;tmp&quot;] = pd.Series(0, index=df.index)</span>
<span class="c1">#         df.loc[</span>
<span class="c1">#             df.is_alive &amp; df[&quot;tb_inf&quot;].str.contains(&quot;active_susc&quot;) &amp; df.tb_smear, &quot;tmp&quot;</span>
<span class="c1">#         ] = 1</span>
<span class="c1">#         smear_pos = df.groupby([&quot;district_of_residence&quot;])[[&quot;tmp&quot;]].sum()</span>
<span class="c1">#         smear_pos = smear_pos.iloc[:, 0]  # convert to series</span>
<span class="c1">#</span>
<span class="c1">#         # smear-negative cases by district</span>
<span class="c1">#         df[&quot;tmp2&quot;] = pd.Series(0, index=df.index)</span>
<span class="c1">#         df.loc[</span>
<span class="c1">#             df.is_alive &amp; df[&quot;tb_inf&quot;].str.contains(&quot;active_susc&quot;) &amp; ~df.tb_smear,</span>
<span class="c1">#             &quot;tmp2&quot;,</span>
<span class="c1">#         ] = 1</span>
<span class="c1">#         smear_neg = df.groupby([&quot;district_of_residence&quot;])[[&quot;tmp2&quot;]].sum()</span>
<span class="c1">#         smear_neg = smear_neg.iloc[:, 0]  # convert to series</span>
<span class="c1">#</span>
<span class="c1">#         # uninfected cases by district</span>
<span class="c1">#         df[&quot;tmp3&quot;] = pd.Series(0, index=df.index)</span>
<span class="c1">#         df.loc[df.is_alive &amp; (df.tb_inf == &quot;uninfected&quot;), &quot;tmp3&quot;] = 1</span>
<span class="c1">#         uninfected = df.groupby([&quot;district_of_residence&quot;])[[&quot;tmp3&quot;]].sum()</span>
<span class="c1">#         uninfected = uninfected.iloc[:, 0]  # convert to series</span>
<span class="c1">#</span>
<span class="c1">#         # population by district</span>
<span class="c1">#         df[&quot;tmp4&quot;] = pd.Series(0, index=df.index)</span>
<span class="c1">#         df.loc[df.is_alive, &quot;tmp4&quot;] = 1</span>
<span class="c1">#         pop = df.groupby([&quot;district_of_residence&quot;])[[&quot;tmp4&quot;]].sum()</span>
<span class="c1">#         pop = pop.iloc[:, 0]  # convert to series</span>
<span class="c1">#</span>
<span class="c1">#         del df[&quot;tmp&quot;]</span>
<span class="c1">#         del df[&quot;tmp2&quot;]</span>
<span class="c1">#         del df[&quot;tmp3&quot;]</span>
<span class="c1">#         del df[&quot;tmp4&quot;]</span>
<span class="c1">#</span>
<span class="c1">#         # calculate foi by district</span>
<span class="c1">#         districts = df[&quot;district_of_residence&quot;].unique()</span>
<span class="c1">#</span>
<span class="c1">#         # if any smear_pos or smear_neg are 0 they will return foi=0</span>
<span class="c1">#         smear_pos[smear_pos == 0] = 1</span>
<span class="c1">#         smear_neg[smear_neg == 0] = 1</span>
<span class="c1">#</span>
<span class="c1">#         foi = pd.Series(0, index=districts)</span>
<span class="c1">#         foi = (</span>
<span class="c1">#             params[&quot;transmission_rate&quot;]</span>
<span class="c1">#             * smear_pos</span>
<span class="c1">#             * (smear_neg * params[&quot;rel_inf_smear_ng&quot;])</span>
<span class="c1">#             * uninfected</span>
<span class="c1">#         ) / pop</span>
<span class="c1">#</span>
<span class="c1">#         assert foi.isna().sum() == 0  # check there is a foi for every district</span>
<span class="c1">#</span>
<span class="c1">#         foi_df = pd.DataFrame(foi, columns=[&quot;foi&quot;])</span>
<span class="c1">#</span>
<span class="c1">#         # ----------------------------------- NEW LATENT INFECTIONS -----------------------------------</span>
<span class="c1">#         df_distr = df.merge(</span>
<span class="c1">#             foi_df, left_on=[&quot;district_of_residence&quot;], right_index=True, how=&quot;left&quot;</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         assert (</span>
<span class="c1">#             df_distr.foi.isna().sum() == 0</span>
<span class="c1">#         )  # check there is a district-level foi for every person</span>
<span class="c1">#</span>
<span class="c1">#         risk_tb = pd.Series(df_distr.foi, index=df.index)</span>
<span class="c1">#         risk_tb.loc[~df.is_alive] *= 0</span>
<span class="c1">#         risk_tb.loc[df.tb_bcg &amp; df.age_years &lt; 10] *= params[&quot;rr_bcg_inf&quot;]</span>
<span class="c1">#</span>
<span class="c1">#         # get a list of random numbers between 0 and 1 for each infected individual</span>
<span class="c1">#         random_draw = rng.random_sample(size=len(df))</span>
<span class="c1">#</span>
<span class="c1">#         tb_idx = df.index[</span>
<span class="c1">#             df.is_alive &amp; (df.tb_inf == &quot;uninfected&quot;) &amp; (random_draw &lt; risk_tb)</span>
<span class="c1">#         ]</span>
<span class="c1">#</span>
<span class="c1">#         df.loc[tb_idx, &quot;tb_inf&quot;] = &quot;latent_susc_new&quot;</span>
<span class="c1">#         df.loc[tb_idx, &quot;tb_date_latent&quot;] = now</span>
<span class="c1">#         df.loc[tb_idx, &quot;tb_stage&quot;] = &quot;latent&quot;</span>
<span class="c1">#</span>
<span class="c1">#         logger.debug(f&quot;TbEvent:new latent infections for ids {tb_idx}&quot;)</span>
<span class="c1">#</span>
<span class="c1">#         # ----------------------------------- RE-INFECTIONS -----------------------------------</span>
<span class="c1">#</span>
<span class="c1">#         # pop at risk = latent_susc_tx and latent_mdr (new &amp; tx)</span>
<span class="c1">#         repeat_case = df.index[</span>
<span class="c1">#             df.is_alive &amp; (df.tb_inf == &quot;latent_susc_tx&quot;)</span>
<span class="c1">#             | df[&quot;tb_inf&quot;].str.contains(&quot;latent_mdr&quot;) &amp; (random_draw &lt; risk_tb)</span>
<span class="c1">#         ]</span>
<span class="c1">#</span>
<span class="c1">#         # unchanged status, high risk of relapse as if just recovered</span>
<span class="c1">#         df.loc[repeat_case, &quot;tb_inf&quot;] = &quot;latent_susc_tx&quot;</span>
<span class="c1">#</span>
<span class="c1">#         df.loc[repeat_case, &quot;tb_date_latent&quot;] = now</span>
<span class="c1">#         df.loc[repeat_case, &quot;tb_stage&quot;] = &quot;latent&quot;</span>
<span class="c1">#</span>
<span class="c1">#         logger.debug(f&quot;TbEvent: reinfections for ids {tb_idx}&quot;)</span>
<span class="c1">#</span>
<span class="c1">#         del df_distr</span>
<span class="c1">#</span>
<span class="c1">#         # -----------------------------------------------------------------------------------------------------</span>
<span class="c1">#         # PROGRESSION TO ACTIVE DISEASE</span>
<span class="c1">#</span>
<span class="c1">#         # ----------------------------------- ADULT PROGRESSORS TO ACTIVE DISEASE -----------------------------------</span>
<span class="c1">#</span>
<span class="c1">#         # probability of active disease</span>
<span class="c1">#         prob_prog = pd.Series(0, index=df.index)</span>
<span class="c1">#         prob_prog.loc[df.is_alive &amp; df.age_years.between(15, 100)] = params[</span>
<span class="c1">#             &quot;prog_active&quot;</span>
<span class="c1">#         ]</span>
<span class="c1">#         prob_prog.loc[df.hv_inf] *= params[&quot;rr_tb_hiv&quot;]</span>
<span class="c1">#         prob_prog.loc[df.hv_inf] *= params[&quot;rr_tb_aids&quot;]</span>
<span class="c1">#         prob_prog.loc[(df.hv_on_art == 2)] *= (</span>
<span class="c1">#             params[&quot;rr_tb_hiv&quot;] * params[&quot;rr_tb_art_adult&quot;]</span>
<span class="c1">#         )</span>
<span class="c1">#         # prob_prog.loc[df.xxxx] *= params[&#39;rr_tb_overweight&#39;]</span>
<span class="c1">#         prob_prog.loc[df.li_bmi &gt;= 4] *= params[&quot;rr_tb_obese&quot;]</span>
<span class="c1">#         # prob_prog.loc[df.xxxx] *= params[&#39;rr_tb_diabetes1&#39;]</span>
<span class="c1">#         prob_prog.loc[df.li_ex_alc] *= params[&quot;rr_tb_alcohol&quot;]</span>
<span class="c1">#         prob_prog.loc[df.li_tob] *= params[&quot;rr_tb_smoking&quot;]</span>
<span class="c1">#</span>
<span class="c1">#         # impact of IPT</span>
<span class="c1">#         dur_ipt = pd.to_timedelta(params[&quot;dur_prot_ipt&quot;], unit=&quot;d&quot;)</span>
<span class="c1">#</span>
<span class="c1">#         prob_prog.loc[(df.tb_date_ipt &lt; (now - dur_ipt)) &amp; ~df.hv_inf] *= params[</span>
<span class="c1">#             &quot;rr_ipt_adult&quot;</span>
<span class="c1">#         ]</span>
<span class="c1">#         prob_prog.loc[</span>
<span class="c1">#             (df.tb_date_ipt &lt; (now - dur_ipt)) &amp; df.hv_inf &amp; (df.hv_on_art != 2)</span>
<span class="c1">#         ] *= params[&quot;rr_ipt_adult_hiv&quot;]</span>
<span class="c1">#         prob_prog.loc[</span>
<span class="c1">#             (df.tb_date_ipt &lt; (now - dur_ipt)) &amp; df.hv_inf &amp; (df.hv_on_art == 2)</span>
<span class="c1">#         ] *= params[&quot;rr_ipt_art_adult&quot;]</span>
<span class="c1">#</span>
<span class="c1">#         # new latent cases including repeat infections</span>
<span class="c1">#         new_latent = len(</span>
<span class="c1">#             df[(df.tb_date_latent == now) &amp; (df.age_years &gt;= 15) &amp; df.is_alive].index</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         if new_latent:</span>
<span class="c1">#</span>
<span class="c1">#             # index of all new susc cases</span>
<span class="c1">#             idx = df[</span>
<span class="c1">#                 (df.tb_date_latent == now) &amp; (df.age_years &gt;= 15) &amp; df.is_alive</span>
<span class="c1">#             ].index</span>
<span class="c1">#</span>
<span class="c1">#             # for each person determine if fast progressor and schedule onset of active disease</span>
<span class="c1">#             fast = pd.Series(data=False, index=df.loc[idx].index)</span>
<span class="c1">#</span>
<span class="c1">#             for i in df.index[idx]:</span>
<span class="c1">#                 fast[i] = rng.rand() &lt; params[&quot;prop_fast_progressor&quot;]</span>
<span class="c1">#</span>
<span class="c1">#             # need to scale the prob of progressing to active so overall pop prob of</span>
<span class="c1">#             #  progression = params[&#39;prog_active&#39;]</span>
<span class="c1">#             # mean / scale = scaling factor</span>
<span class="c1">#             # don&#39;t include children here</span>
<span class="c1">#             mean = sum(prob_prog[df.is_alive &amp; df.age_years.between(15, 100)]) / len(</span>
<span class="c1">#                 prob_prog[df.is_alive &amp; df.age_years.between(15, 100)]</span>
<span class="c1">#             )</span>
<span class="c1">#             scaling_factor = mean / params[&quot;prog_active&quot;]</span>
<span class="c1">#</span>
<span class="c1">#             prob_prog_scaled = prob_prog.divide(other=scaling_factor)</span>
<span class="c1">#             assert len(prob_prog) == len(prob_prog_scaled)</span>
<span class="c1">#</span>
<span class="c1">#             if fast.sum() &gt; 0:</span>
<span class="c1">#                 for person_id in fast.index[fast]:</span>
<span class="c1">#                     # print(&#39;fast&#39;, person_id)</span>
<span class="c1">#</span>
<span class="c1">#                     logger.debug(</span>
<span class="c1">#                         &quot;This is TbEvent, scheduling active disease for fast progressing person %d on date %s&quot;,</span>
<span class="c1">#                         person_id,</span>
<span class="c1">#                         now,</span>
<span class="c1">#                     )</span>
<span class="c1">#                     # schedule active disease now</span>
<span class="c1">#                     self.sim.schedule_event(TbActiveEvent(self.module, person_id), now)</span>
<span class="c1">#</span>
<span class="c1">#             # slow progressors</span>
<span class="c1">#             for person_id in idx[~fast]:</span>
<span class="c1">#                 # print(&#39;slow&#39;, person_id)</span>
<span class="c1">#                 # decide if person will develop active tb</span>
<span class="c1">#                 active = rng.rand() &lt; prob_prog_scaled[person_id]</span>
<span class="c1">#</span>
<span class="c1">#                 if active:</span>
<span class="c1">#                     # randomly select date of onset of active disease</span>
<span class="c1">#                     # random draw of days 0-732</span>
<span class="c1">#                     random_date = rng.randint(low=0, high=732)</span>
<span class="c1">#                     sch_date = now + pd.to_timedelta(random_date, unit=&quot;d&quot;)</span>
<span class="c1">#</span>
<span class="c1">#                     logger.debug(</span>
<span class="c1">#                         &quot;This is TbEvent, scheduling active disease for slow progressing person %d on date %s&quot;,</span>
<span class="c1">#                         person_id,</span>
<span class="c1">#                         sch_date,</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#                     # schedule active disease</span>
<span class="c1">#                     self.sim.schedule_event(</span>
<span class="c1">#                         TbActiveEvent(self.module, person_id), sch_date</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#         # ----------------------------------- CHILD PROGRESSORS TO ACTIVE DISEASE -----------------------------------</span>
<span class="c1">#         # probability of active disease</span>
<span class="c1">#         prob_prog_child = pd.Series(0, index=df.index)</span>
<span class="c1">#         prob_prog_child.loc[df.is_alive &amp; (df.age_years &lt; 1)] = params[&quot;prog_1yr&quot;]</span>
<span class="c1">#         prob_prog_child.loc[df.is_alive &amp; (df.age_years.between(1, 2))] = params[</span>
<span class="c1">#             &quot;prog_1_2yr&quot;</span>
<span class="c1">#         ]</span>
<span class="c1">#         prob_prog_child.loc[df.is_alive &amp; (df.age_years.between(2, 5))] = params[</span>
<span class="c1">#             &quot;prog_2_5yr&quot;</span>
<span class="c1">#         ]</span>
<span class="c1">#         prob_prog_child.loc[df.is_alive &amp; (df.age_years.between(5, 10))] = params[</span>
<span class="c1">#             &quot;prog_5_10yr&quot;</span>
<span class="c1">#         ]</span>
<span class="c1">#         prob_prog_child.loc[df.is_alive &amp; (df.age_years.between(10, 15))] = params[</span>
<span class="c1">#             &quot;prog_10yr&quot;</span>
<span class="c1">#         ]</span>
<span class="c1">#         prob_prog_child.loc[df.is_alive &amp; df.tb_bcg &amp; df.age_years &lt;= 10] *= params[</span>
<span class="c1">#             &quot;rr_tb_bcg&quot;</span>
<span class="c1">#         ]</span>
<span class="c1">#         prob_prog_child.loc[(df.hv_on_art == 2)] *= params[&quot;rr_tb_art_child&quot;]</span>
<span class="c1">#</span>
<span class="c1">#         dur_ipt_inf = pd.to_timedelta(params[&quot;dur_prot_ipt_infant&quot;], unit=&quot;d&quot;)</span>
<span class="c1">#</span>
<span class="c1">#         prob_prog_child.loc[</span>
<span class="c1">#             (df.tb_date_ipt &lt; (now - dur_ipt_inf)) &amp; ~df.hv_inf</span>
<span class="c1">#         ] *= params[&quot;rr_ipt_child&quot;]</span>
<span class="c1">#         prob_prog_child.loc[</span>
<span class="c1">#             (df.tb_date_ipt &lt; (now - dur_ipt_inf)) &amp; df.hv_inf &amp; (df.hv_on_art != 2)</span>
<span class="c1">#         ] *= params[&quot;rr_ipt_child_hiv&quot;]</span>
<span class="c1">#         prob_prog_child.loc[</span>
<span class="c1">#             (df.tb_date_ipt &lt; (now - dur_ipt_inf)) &amp; df.hv_inf &amp; (df.hv_on_art == 2)</span>
<span class="c1">#         ] *= params[&quot;rr_ipt_art_child&quot;]</span>
<span class="c1">#</span>
<span class="c1">#         # no direct progression</span>
<span class="c1">#         # progression within 1 year</span>
<span class="c1">#         new_latent_child = len(</span>
<span class="c1">#             df.index[(df.tb_date_latent == now) &amp; (df.age_years &lt; 15) &amp; df.is_alive]</span>
<span class="c1">#         )</span>
<span class="c1">#         # print(new_latent)</span>
<span class="c1">#</span>
<span class="c1">#         # some proportion schedule active now, else schedule active at random date</span>
<span class="c1">#         if new_latent_child:</span>
<span class="c1">#             prog = df[</span>
<span class="c1">#                 (df.tb_date_latent == now) &amp; (df.age_years &lt; 15) &amp; df.is_alive</span>
<span class="c1">#             ].index</span>
<span class="c1">#</span>
<span class="c1">#             for person_id in prog:</span>
<span class="c1">#                 # decide if person will develop active tb</span>
<span class="c1">#                 active = rng.rand() &lt; prob_prog_child[person_id]</span>
<span class="c1">#</span>
<span class="c1">#                 if active:</span>
<span class="c1">#                     # random draw of days 0-365</span>
<span class="c1">#                     # random_date = rng.choice(list(range(0, 365)), size=1, p=[(1 / 365)] * 365)</span>
<span class="c1">#                     random_date = rng.randint(low=0, high=182)</span>
<span class="c1">#                     # convert days into years</span>
<span class="c1">#                     random_days = pd.to_timedelta(random_date, unit=&quot;d&quot;)</span>
<span class="c1">#</span>
<span class="c1">#                     sch_date = now + random_days</span>
<span class="c1">#</span>
<span class="c1">#                     logger.debug(</span>
<span class="c1">#                         &quot;This is TbEvent, scheduling active disease for child %d on date %s&quot;,</span>
<span class="c1">#                         person_id,</span>
<span class="c1">#                         sch_date,</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#                     # schedule active disease</span>
<span class="c1">#                     self.sim.schedule_event(</span>
<span class="c1">#                         TbActiveEvent(self.module, person_id), sch_date</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class NonTbSymptomsEvent(RegularEvent, PopulationScopeEventMixin):</span>
<span class="c1">#     &quot;&quot;&quot; symptom onset and healthcare seeking of people with tb-like symptoms but no active tb infection</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self, module):</span>
<span class="c1">#         super().__init__(module, frequency=DateOffset(months=1))  # every 1 month</span>
<span class="c1">#</span>
<span class="c1">#     def apply(self, population):</span>
<span class="c1">#         params = self.module.parameters</span>
<span class="c1">#         rng = self.module.rng</span>
<span class="c1">#</span>
<span class="c1">#         df = population.props</span>
<span class="c1">#</span>
<span class="c1">#         # select proportion of eligible non-tb patients to test for tb</span>
<span class="c1">#         test_non_tb = df.index[</span>
<span class="c1">#             (rng.random_sample(size=len(df)) &lt; params[&quot;presump_testing&quot;])</span>
<span class="c1">#             &amp; df.is_alive</span>
<span class="c1">#             &amp; ~(df.tb_inf.str.contains(&quot;active&quot;))</span>
<span class="c1">#         ]</span>
<span class="c1">#</span>
<span class="c1">#         df.loc[test_non_tb, &quot;tb_symptoms&quot;] = True</span>
<span class="c1">#</span>
<span class="c1">#         # schedule tb screening and test</span>
<span class="c1">#         if len(test_non_tb):</span>
<span class="c1">#</span>
<span class="c1">#             # ----------------------------------- SYMPTOMS -----------------------------------</span>
<span class="c1">#             # ACTIVE CASES - smear positive and smear negative</span>
<span class="c1">#</span>
<span class="c1">#             df.loc[test_non_tb, &quot;tb_any_resp_symptoms&quot;] = self.sim.date</span>
<span class="c1">#</span>
<span class="c1">#             self.sim.modules[&quot;SymptomManager&quot;].change_symptom(</span>
<span class="c1">#                 person_id=list(test_non_tb),</span>
<span class="c1">#                 symptom_string=&quot;fever&quot;,</span>
<span class="c1">#                 add_or_remove=&quot;+&quot;,</span>
<span class="c1">#                 disease_module=self.module,</span>
<span class="c1">#                 duration_in_days=None,</span>
<span class="c1">#             )</span>
<span class="c1">#</span>
<span class="c1">#             self.sim.modules[&quot;SymptomManager&quot;].change_symptom(</span>
<span class="c1">#                 person_id=list(test_non_tb),</span>
<span class="c1">#                 symptom_string=&quot;respiratory_symptoms&quot;,</span>
<span class="c1">#                 add_or_remove=&quot;+&quot;,</span>
<span class="c1">#                 disease_module=self.module,</span>
<span class="c1">#                 duration_in_days=None,</span>
<span class="c1">#             )</span>
<span class="c1">#</span>
<span class="c1">#             # ----------------------------------- SCHEDULE TB SCREENING -----------------------------------</span>
<span class="c1">#</span>
<span class="c1">#             for person in test_non_tb:</span>
<span class="c1">#                 logger.debug(</span>
<span class="c1">#                     &quot;This is NonTbSymptomsEvent, scheduling HSI_Tb_Screening for person %d&quot;,</span>
<span class="c1">#                     person,</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#                 event = HSI_Tb_Screening(self.module, person_id=person)</span>
<span class="c1">#                 self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                     event,</span>
<span class="c1">#                     priority=2,</span>
<span class="c1">#                     topen=self.sim.date + DateOffset(weeks=2),</span>
<span class="c1">#                     tclose=None,</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class TbActiveEvent(Event, IndividualScopeEventMixin):</span>
<span class="c1">#     def __init__(self, module, person_id):</span>
<span class="c1">#         super().__init__(module, person_id=person_id)</span>
<span class="c1">#</span>
<span class="c1">#     def apply(self, person_id):</span>
<span class="c1">#         logger.debug(f&quot;Onset of active TB for {person_id} on {self.sim.date}&quot;)</span>
<span class="c1">#</span>
<span class="c1">#         df = self.sim.population.props</span>
<span class="c1">#         params = self.sim.modules[&quot;Tb&quot;].parameters</span>
<span class="c1">#         rng = self.module.rng</span>
<span class="c1">#         now = self.sim.date</span>
<span class="c1">#</span>
<span class="c1">#         # todo add tb_stage == active_extra with prob based on HIV status</span>
<span class="c1">#         if (</span>
<span class="c1">#             not df.at[person_id, &quot;tb_on_ipt&quot;]</span>
<span class="c1">#             and not df.at[person_id, &quot;tb_on_treatment&quot;]</span>
<span class="c1">#         ):</span>
<span class="c1">#</span>
<span class="c1">#             df.at[person_id, &quot;tb_date_active&quot;] = self.sim.date</span>
<span class="c1">#             df.at[person_id, &quot;tb_symptoms&quot;] = True</span>
<span class="c1">#             df.at[person_id, &quot;tb_ever_tb&quot;] = True</span>
<span class="c1">#             df.at[person_id, &quot;tb_stage&quot;] = &quot;active_pulm&quot;</span>
<span class="c1">#</span>
<span class="c1">#             # check if new infection or re-infection</span>
<span class="c1">#             # latent_susc_new or latent_susc_tx</span>
<span class="c1">#             if df.at[person_id, &quot;tb_inf&quot;] == &quot;latent_susc_new&quot;:</span>
<span class="c1">#                 df.at[person_id, &quot;tb_inf&quot;] = &quot;active_susc_new&quot;</span>
<span class="c1">#             elif df.at[person_id, &quot;tb_inf&quot;] == &quot;latent_susc_tx&quot;:</span>
<span class="c1">#                 df.at[person_id, &quot;tb_inf&quot;] = &quot;active_susc_tx&quot;</span>
<span class="c1">#</span>
<span class="c1">#             # decide smear positive / negative</span>
<span class="c1">#             # depends on HIV status</span>
<span class="c1">#             if df.at[person_id, &quot;hv_inf&quot;] &amp; (</span>
<span class="c1">#                 rng.rand() &lt; params[&quot;prop_smear_positive_hiv&quot;]</span>
<span class="c1">#             ):</span>
<span class="c1">#                 df.at[person_id, &quot;tb_smear&quot;] = True</span>
<span class="c1">#</span>
<span class="c1">#             # hiv-negative</span>
<span class="c1">#             elif rng.rand() &lt; params[&quot;prop_smear_positive&quot;]:</span>
<span class="c1">#                 df.at[person_id, &quot;tb_smear&quot;] = True</span>
<span class="c1">#</span>
<span class="c1">#             # ----------------------------------- SYMPTOMS -----------------------------------</span>
<span class="c1">#             # ACTIVE CASES - smear positive and smear negative</span>
<span class="c1">#</span>
<span class="c1">#             df.at[person_id, &quot;tb_any_resp_symptoms&quot;] = now</span>
<span class="c1">#</span>
<span class="c1">#             self.sim.modules[&quot;SymptomManager&quot;].change_symptom(</span>
<span class="c1">#                 person_id=person_id,</span>
<span class="c1">#                 symptom_string=&quot;fever&quot;,</span>
<span class="c1">#                 add_or_remove=&quot;+&quot;,</span>
<span class="c1">#                 disease_module=self.module,</span>
<span class="c1">#                 duration_in_days=None,</span>
<span class="c1">#             )</span>
<span class="c1">#</span>
<span class="c1">#             self.sim.modules[&quot;SymptomManager&quot;].change_symptom(</span>
<span class="c1">#                 person_id=person_id,</span>
<span class="c1">#                 symptom_string=&quot;respiratory_symptoms&quot;,</span>
<span class="c1">#                 add_or_remove=&quot;+&quot;,</span>
<span class="c1">#                 disease_module=self.module,</span>
<span class="c1">#                 duration_in_days=None,</span>
<span class="c1">#             )</span>
<span class="c1">#</span>
<span class="c1">#             self.sim.modules[&quot;SymptomManager&quot;].change_symptom(</span>
<span class="c1">#                 person_id=person_id,</span>
<span class="c1">#                 symptom_string=&quot;fatigue&quot;,</span>
<span class="c1">#                 add_or_remove=&quot;+&quot;,</span>
<span class="c1">#                 disease_module=self.module,</span>
<span class="c1">#                 duration_in_days=None,</span>
<span class="c1">#             )</span>
<span class="c1">#</span>
<span class="c1">#             self.sim.modules[&quot;SymptomManager&quot;].change_symptom(</span>
<span class="c1">#                 person_id=person_id,</span>
<span class="c1">#                 symptom_string=&quot;night_sweats&quot;,</span>
<span class="c1">#                 add_or_remove=&quot;+&quot;,</span>
<span class="c1">#                 disease_module=self.module,</span>
<span class="c1">#                 duration_in_days=None,</span>
<span class="c1">#             )</span>
<span class="c1">#</span>
<span class="c1">#             # ----------------------------------- ACTIVE CASES SEEKING CARE -----------------------------------</span>
<span class="c1">#             # TODO leave this in here for now until diagnostic algorithm updated</span>
<span class="c1">#             # TODO: calibrate / input these data from MOH reports</span>
<span class="c1">#             prob_care = 0.47</span>
<span class="c1">#             if now.year == 2013:</span>
<span class="c1">#                 prob_care = 0.44</span>
<span class="c1">#             elif now.year == 2014:</span>
<span class="c1">#                 prob_care = 0.45</span>
<span class="c1">#             elif now.year == 2015:</span>
<span class="c1">#                 prob_care = 0.5</span>
<span class="c1">#             elif now.year == 2016:</span>
<span class="c1">#                 prob_care = 0.57</span>
<span class="c1">#             elif now.year &gt; 2016:</span>
<span class="c1">#                 prob_care = 0.73</span>
<span class="c1">#</span>
<span class="c1">#             seeks_care = rng.rand() &lt; prob_care</span>
<span class="c1">#</span>
<span class="c1">#             if seeks_care:</span>
<span class="c1">#                 logger.debug(</span>
<span class="c1">#                     &quot;This is TbActiveEvent, scheduling HSI_Tb_Screening for person %d&quot;,</span>
<span class="c1">#                     person_id,</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#                 event = HSI_Tb_Screening(self.module, person_id=person_id)</span>
<span class="c1">#                 self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                     event,</span>
<span class="c1">#                     priority=2,</span>
<span class="c1">#                     topen=self.sim.date + DateOffset(weeks=2),</span>
<span class="c1">#                     tclose=None,</span>
<span class="c1">#                 )</span>
<span class="c1">#             else:</span>
<span class="c1">#                 logger.debug(</span>
<span class="c1">#                     &quot;This is TbActiveEvent, person %d is not seeking care&quot;, person_id</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#             # ----------------------------------- HIV+ SCHEDULE AIDS ONSET -----------------------------------</span>
<span class="c1">#</span>
<span class="c1">#             if df.at[person_id, &quot;hv_inf&quot;]:</span>
<span class="c1">#                 logger.debug(</span>
<span class="c1">#                     &quot;This is TbActiveEvent scheduling aids onset for person %d&quot;,</span>
<span class="c1">#                     person_id,</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#                 aids = hiv.HivAidsEvent(self.module, person_id)</span>
<span class="c1">#                 self.sim.schedule_event(aids, self.sim.date)</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class TbRelapseEvent(RegularEvent, PopulationScopeEventMixin):</span>
<span class="c1">#     &quot;&quot;&quot; relapse from latent to active</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self, module):</span>
<span class="c1">#         super().__init__(module, frequency=DateOffset(months=1))  # every 1 month</span>
<span class="c1">#</span>
<span class="c1">#     def apply(self, population):</span>
<span class="c1">#</span>
<span class="c1">#         df = self.sim.population.props</span>
<span class="c1">#         params = self.module.parameters</span>
<span class="c1">#         now = self.sim.date</span>
<span class="c1">#         rng = self.module.rng</span>
<span class="c1">#</span>
<span class="c1">#         # ----------------------------------- RELAPSE -----------------------------------</span>
<span class="c1">#         random_draw = rng.random_sample(size=len(df))</span>
<span class="c1">#</span>
<span class="c1">#         # HIV-NEGATIVE</span>
<span class="c1">#</span>
<span class="c1">#         # relapse after treatment completion, tb_date_treated + six months</span>
<span class="c1">#         relapse_tx_complete = df[</span>
<span class="c1">#             (df.tb_inf == &quot;latent_susc_tx&quot;)</span>
<span class="c1">#             &amp; ~df.tb_on_ipt</span>
<span class="c1">#             &amp; df.is_alive</span>
<span class="c1">#             &amp; ~df.hv_inf</span>
<span class="c1">#             &amp; (self.sim.date - df.tb_date_treated &gt; pd.to_timedelta(182.625, unit=&quot;d&quot;))</span>
<span class="c1">#             &amp; (self.sim.date - df.tb_date_treated &lt; pd.to_timedelta(732.5, unit=&quot;d&quot;))</span>
<span class="c1">#             &amp; ~df.tb_treatment_failure</span>
<span class="c1">#             &amp; (random_draw &lt; params[&quot;monthly_prob_relapse_tx_complete&quot;])</span>
<span class="c1">#         ].index</span>
<span class="c1">#</span>
<span class="c1">#         # relapse after treatment default, tb_treatment_failure=True, but make sure not tb-mdr</span>
<span class="c1">#         relapse_tx_incomplete = df[</span>
<span class="c1">#             (df.tb_inf == &quot;latent_susc_tx&quot;)</span>
<span class="c1">#             &amp; ~df.tb_on_ipt</span>
<span class="c1">#             &amp; df.is_alive</span>
<span class="c1">#             &amp; ~df.hv_inf</span>
<span class="c1">#             &amp; df.tb_treatment_failure</span>
<span class="c1">#             &amp; (self.sim.date - df.tb_date_treated &gt; pd.to_timedelta(182.625, unit=&quot;d&quot;))</span>
<span class="c1">#             &amp; (self.sim.date - df.tb_date_treated &lt; pd.to_timedelta(732.5, unit=&quot;d&quot;))</span>
<span class="c1">#             &amp; (random_draw &lt; params[&quot;monthly_prob_relapse_tx_incomplete&quot;])</span>
<span class="c1">#         ].index</span>
<span class="c1">#</span>
<span class="c1">#         # relapse after &gt;2 years following completion of treatment (or default)</span>
<span class="c1">#         # use tb_date_treated + 2 years + 6 months of treatment</span>
<span class="c1">#         relapse_tx_2yrs = df[</span>
<span class="c1">#             (df.tb_inf == &quot;latent_susc_tx&quot;)</span>
<span class="c1">#             &amp; ~df.tb_on_ipt</span>
<span class="c1">#             &amp; df.is_alive</span>
<span class="c1">#             &amp; ~df.hv_inf</span>
<span class="c1">#             &amp; (self.sim.date - df.tb_date_treated &gt;= pd.to_timedelta(913.125, unit=&quot;d&quot;))</span>
<span class="c1">#             &amp; (random_draw &lt; params[&quot;monthly_prob_relapse_2yrs&quot;])</span>
<span class="c1">#         ].index</span>
<span class="c1">#</span>
<span class="c1">#         df.loc[</span>
<span class="c1">#             relapse_tx_complete | relapse_tx_incomplete | relapse_tx_2yrs, &quot;tb_inf&quot;</span>
<span class="c1">#         ] = &quot;active_susc_tx&quot;</span>
<span class="c1">#         df.loc[</span>
<span class="c1">#             relapse_tx_complete | relapse_tx_incomplete | relapse_tx_2yrs,</span>
<span class="c1">#             &quot;tb_date_active&quot;,</span>
<span class="c1">#         ] = now</span>
<span class="c1">#         df.loc[</span>
<span class="c1">#             relapse_tx_complete | relapse_tx_incomplete | relapse_tx_2yrs, &quot;tb_ever_tb&quot;</span>
<span class="c1">#         ] = True</span>
<span class="c1">#         df.loc[</span>
<span class="c1">#             relapse_tx_complete | relapse_tx_incomplete | relapse_tx_2yrs, &quot;tb_stage&quot;</span>
<span class="c1">#         ] = &quot;active_pulm&quot;</span>
<span class="c1">#</span>
<span class="c1">#         # HIV-POSITIVE</span>
<span class="c1">#</span>
<span class="c1">#         # relapse after treatment completion, tb_date_treated + six months</span>
<span class="c1">#         relapse_tx_complete = df[</span>
<span class="c1">#             (df.tb_inf == &quot;latent_susc_tx&quot;)</span>
<span class="c1">#             &amp; ~df.tb_on_ipt</span>
<span class="c1">#             &amp; df.is_alive</span>
<span class="c1">#             &amp; df.hv_inf</span>
<span class="c1">#             &amp; (self.sim.date - df.tb_date_treated &gt; pd.to_timedelta(182.625, unit=&quot;d&quot;))</span>
<span class="c1">#             &amp; (self.sim.date - df.tb_date_treated &lt; pd.to_timedelta(732.5, unit=&quot;d&quot;))</span>
<span class="c1">#             &amp; ~df.tb_treatment_failure</span>
<span class="c1">#             &amp; (</span>
<span class="c1">#                 random_draw</span>
<span class="c1">#                 &lt; (</span>
<span class="c1">#                     params[&quot;monthly_prob_relapse_tx_complete&quot;]</span>
<span class="c1">#                     * params[&quot;rr_relapse_hiv&quot;]</span>
<span class="c1">#                 )</span>
<span class="c1">#             )</span>
<span class="c1">#         ].index</span>
<span class="c1">#</span>
<span class="c1">#         # relapse after treatment default, tb_treatment_failure=True, but make sure not tb-mdr</span>
<span class="c1">#         relapse_tx_incomplete = df[</span>
<span class="c1">#             (df.tb_inf == &quot;latent_susc_tx&quot;)</span>
<span class="c1">#             &amp; ~df.tb_on_ipt</span>
<span class="c1">#             &amp; df.is_alive</span>
<span class="c1">#             &amp; df.hv_inf</span>
<span class="c1">#             &amp; df.tb_treatment_failure</span>
<span class="c1">#             &amp; (self.sim.date - df.tb_date_treated &gt; pd.to_timedelta(182.625, unit=&quot;d&quot;))</span>
<span class="c1">#             &amp; (self.sim.date - df.tb_date_treated &lt; pd.to_timedelta(732.5, unit=&quot;d&quot;))</span>
<span class="c1">#             &amp; (</span>
<span class="c1">#                 random_draw</span>
<span class="c1">#                 &lt; (</span>
<span class="c1">#                     params[&quot;monthly_prob_relapse_tx_complete&quot;]</span>
<span class="c1">#                     * params[&quot;rr_relapse_hiv&quot;]</span>
<span class="c1">#                 )</span>
<span class="c1">#             )</span>
<span class="c1">#         ].index</span>
<span class="c1">#</span>
<span class="c1">#         # relapse after &gt;2 years following completion of treatment (or default)</span>
<span class="c1">#         # use tb_date_treated + 2 years + 6 months of treatment</span>
<span class="c1">#         relapse_tx_2yrs = df[</span>
<span class="c1">#             (df.tb_inf == &quot;latent_susc_tx&quot;)</span>
<span class="c1">#             &amp; ~df.tb_on_ipt</span>
<span class="c1">#             &amp; df.is_alive</span>
<span class="c1">#             &amp; df.hv_inf</span>
<span class="c1">#             &amp; (self.sim.date - df.tb_date_treated &gt;= pd.to_timedelta(913.125, unit=&quot;d&quot;))</span>
<span class="c1">#             &amp; (</span>
<span class="c1">#                 random_draw</span>
<span class="c1">#                 &lt; (</span>
<span class="c1">#                     params[&quot;monthly_prob_relapse_tx_complete&quot;]</span>
<span class="c1">#                     * params[&quot;rr_relapse_hiv&quot;]</span>
<span class="c1">#                 )</span>
<span class="c1">#             )</span>
<span class="c1">#         ].index</span>
<span class="c1">#</span>
<span class="c1">#         df.loc[</span>
<span class="c1">#             relapse_tx_complete | relapse_tx_incomplete | relapse_tx_2yrs, &quot;tb_inf&quot;</span>
<span class="c1">#         ] = &quot;active_susc_tx&quot;</span>
<span class="c1">#         df.loc[</span>
<span class="c1">#             relapse_tx_complete | relapse_tx_incomplete | relapse_tx_2yrs,</span>
<span class="c1">#             &quot;tb_date_active&quot;,</span>
<span class="c1">#         ] = now</span>
<span class="c1">#         df.loc[</span>
<span class="c1">#             relapse_tx_complete | relapse_tx_incomplete | relapse_tx_2yrs, &quot;tb_ever_tb&quot;</span>
<span class="c1">#         ] = True</span>
<span class="c1">#         df.loc[</span>
<span class="c1">#             relapse_tx_complete | relapse_tx_incomplete | relapse_tx_2yrs, &quot;tb_stage&quot;</span>
<span class="c1">#         ] = &quot;active_pulm&quot;</span>
<span class="c1">#         df.loc[</span>
<span class="c1">#             relapse_tx_complete | relapse_tx_incomplete | relapse_tx_2yrs, &quot;tb_symptoms&quot;</span>
<span class="c1">#         ] = True</span>
<span class="c1">#</span>
<span class="c1">#         all_relapse_complete = relapse_tx_complete.append(relapse_tx_2yrs)</span>
<span class="c1">#         all_relapse = all_relapse_complete.append(relapse_tx_incomplete)</span>
<span class="c1">#</span>
<span class="c1">#         # ----------------------------------- SYMPTOMS -----------------------------------</span>
<span class="c1">#         df.loc[all_relapse, &quot;tb_any_resp_symptoms&quot;] = now</span>
<span class="c1">#</span>
<span class="c1">#         self.sim.modules[&quot;SymptomManager&quot;].change_symptom(</span>
<span class="c1">#             person_id=list(all_relapse),</span>
<span class="c1">#             symptom_string=&quot;fever&quot;,</span>
<span class="c1">#             add_or_remove=&quot;+&quot;,</span>
<span class="c1">#             disease_module=self.module,</span>
<span class="c1">#             duration_in_days=None,</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         self.sim.modules[&quot;SymptomManager&quot;].change_symptom(</span>
<span class="c1">#             person_id=list(all_relapse),</span>
<span class="c1">#             symptom_string=&quot;respiratory_symptoms&quot;,</span>
<span class="c1">#             add_or_remove=&quot;+&quot;,</span>
<span class="c1">#             disease_module=self.module,</span>
<span class="c1">#             duration_in_days=None,</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         self.sim.modules[&quot;SymptomManager&quot;].change_symptom(</span>
<span class="c1">#             person_id=list(all_relapse),</span>
<span class="c1">#             symptom_string=&quot;fatigue&quot;,</span>
<span class="c1">#             add_or_remove=&quot;+&quot;,</span>
<span class="c1">#             disease_module=self.module,</span>
<span class="c1">#             duration_in_days=None,</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         self.sim.modules[&quot;SymptomManager&quot;].change_symptom(</span>
<span class="c1">#             person_id=list(all_relapse),</span>
<span class="c1">#             symptom_string=&quot;night_sweats&quot;,</span>
<span class="c1">#             add_or_remove=&quot;+&quot;,</span>
<span class="c1">#             disease_module=self.module,</span>
<span class="c1">#             duration_in_days=None,</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         # ----------------------------------- RELAPSE CASES SEEKING CARE -----------------------------------</span>
<span class="c1">#         # relapse after complete treatment course - refer for xpert testing</span>
<span class="c1">#         # TODO leave this in here for now until diagnostic algorithm updated</span>
<span class="c1">#         # TODO: calibrate / input these data from MOH reports</span>
<span class="c1">#         prob_care = 0.47</span>
<span class="c1">#         if now.year == 2013:</span>
<span class="c1">#             prob_care = 0.44</span>
<span class="c1">#         elif now.year == 2014:</span>
<span class="c1">#             prob_care = 0.45</span>
<span class="c1">#         elif now.year == 2015:</span>
<span class="c1">#             prob_care = 0.5</span>
<span class="c1">#         elif now.year == 2016:</span>
<span class="c1">#             prob_care = 0.57</span>
<span class="c1">#         elif now.year &gt; 2016:</span>
<span class="c1">#             prob_care = 0.73</span>
<span class="c1">#</span>
<span class="c1">#         # if relapse after complete treatment course</span>
<span class="c1">#         seeks_care = pd.Series(data=False, index=df.loc[relapse_tx_2yrs].index)</span>
<span class="c1">#         for i in df.loc[all_relapse_complete].index:</span>
<span class="c1">#             prob = rng.rand() &lt; prob_care</span>
<span class="c1">#             seeks_care[i] = rng.rand() &lt; prob</span>
<span class="c1">#</span>
<span class="c1">#         if seeks_care.sum() &gt; 0:</span>
<span class="c1">#             for person_index in seeks_care.index[seeks_care]:</span>
<span class="c1">#                 logger.debug(</span>
<span class="c1">#                     f&quot;This is TbRelapseEvent, scheduling HSI_Tb_XpertTest for {person_index}&quot;,</span>
<span class="c1">#                     person_index,</span>
<span class="c1">#                 )</span>
<span class="c1">#                 event = HSI_Tb_XpertTest(self.module, person_id=person_index)</span>
<span class="c1">#                 self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                     event,</span>
<span class="c1">#                     priority=2,</span>
<span class="c1">#                     topen=self.sim.date,</span>
<span class="c1">#                     tclose=self.sim.date + DateOffset(weeks=2),</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#                 # add back-up check if xpert is not available, then schedule sputum smear</span>
<span class="c1">#                 self.sim.schedule_event(</span>
<span class="c1">#                     TbCheckXpert(self.module, person_index),</span>
<span class="c1">#                     self.sim.date + DateOffset(weeks=2),</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#         # relapse after incomplete treatment course - repeat treatment course</span>
<span class="c1">#         seeks_care = pd.Series(data=False, index=df.loc[relapse_tx_incomplete].index)</span>
<span class="c1">#         for i in df.loc[relapse_tx_incomplete].index:</span>
<span class="c1">#             prob = rng.rand() &lt; prob_care</span>
<span class="c1">#             seeks_care[i] = rng.rand() &lt; prob</span>
<span class="c1">#</span>
<span class="c1">#         if seeks_care.sum() &gt; 0:</span>
<span class="c1">#             for person_index in seeks_care.index[seeks_care]:</span>
<span class="c1">#                 if df.at[person_index, &quot;age_years&quot;] &lt; 15:</span>
<span class="c1">#</span>
<span class="c1">#                     logger.debug(</span>
<span class="c1">#                         f&quot;TbRelapseEvent, scheduling HSI_Tb_StartTreatmentChild for relapsed child {person_index}&quot;</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#                     event = HSI_Tb_StartTreatmentChild(</span>
<span class="c1">#                         self.module, person_id=person_index</span>
<span class="c1">#                     )</span>
<span class="c1">#                     self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                         event,</span>
<span class="c1">#                         priority=2,</span>
<span class="c1">#                         topen=self.sim.date,</span>
<span class="c1">#                         tclose=self.sim.date + DateOffset(weeks=2),</span>
<span class="c1">#                     )</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     logger.debug(</span>
<span class="c1">#                         f&quot;TbRelapseEvent, scheduling HSI_Tb_StartTreatmentAdult for relapsed adult {person_index}&quot;</span>
<span class="c1">#                     )</span>
<span class="c1">#                     event = HSI_Tb_StartTreatmentAdult(</span>
<span class="c1">#                         self.module, person_id=person_index</span>
<span class="c1">#                     )</span>
<span class="c1">#                     self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                         event,</span>
<span class="c1">#                         priority=2,</span>
<span class="c1">#                         topen=self.sim.date,</span>
<span class="c1">#                         tclose=self.sim.date + DateOffset(weeks=2),</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class TbScheduleTesting(RegularEvent, PopulationScopeEventMixin):</span>
<span class="c1">#     &quot;&quot;&quot; additional TB testing happening outside the symptom-driven generic HSI event</span>
<span class="c1">#     to increase tx coverage up to reported levels</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self, module):</span>
<span class="c1">#         super().__init__(module, frequency=DateOffset(months=1))</span>
<span class="c1">#</span>
<span class="c1">#     def apply(self, population):</span>
<span class="c1">#         df = population.props</span>
<span class="c1">#         now = self.sim.date</span>
<span class="c1">#         p = self.module.parameters</span>
<span class="c1">#</span>
<span class="c1">#         # select symptomatic people to go for testing (and subsequent tx)</span>
<span class="c1">#         # random sample to match clinical case tx coverage</span>
<span class="c1">#         test = df.index[</span>
<span class="c1">#             (self.module.rng.random_sample(size=len(df)) &lt; p[&quot;rate_testing_tb&quot;])</span>
<span class="c1">#             &amp; df.is_alive</span>
<span class="c1">#             &amp; (</span>
<span class="c1">#                 (df.tb_inf == &quot;active_susc_new&quot;)</span>
<span class="c1">#                 | (df.tb_inf == &quot;active_susc_tx&quot;)</span>
<span class="c1">#                 | (df.tb_inf == &quot;active_mdr_new&quot;)</span>
<span class="c1">#                 | (df.tb_inf == &quot;active_mdr_tx&quot;)</span>
<span class="c1">#             )</span>
<span class="c1">#             &amp; ~(df.tb_diagnosed | df.tb_mdr_diagnosed)</span>
<span class="c1">#         ]</span>
<span class="c1">#</span>
<span class="c1">#         for person_index in test:</span>
<span class="c1">#             logger.debug(</span>
<span class="c1">#                 f&quot;TbScheduleTesting: scheduling HSI_Tb_Screening for person {person_index}&quot;</span>
<span class="c1">#             )</span>
<span class="c1">#</span>
<span class="c1">#             event = HSI_Tb_Screening(self.module, person_id=person_index)</span>
<span class="c1">#             self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                 event, priority=1, topen=now, tclose=None</span>
<span class="c1">#             )</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class TbCheckXpert(Event, IndividualScopeEventMixin):</span>
<span class="c1">#     &quot;&quot;&quot; if person has not received xpert test as prescribed, schedule sputum smear</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self, module, person_id):</span>
<span class="c1">#         super().__init__(module, person_id=person_id)</span>
<span class="c1">#</span>
<span class="c1">#     def apply(self, person_id):</span>
<span class="c1">#         logger.debug(</span>
<span class="c1">#             &quot;This is TbCheckXpert checking if person %d received xpert test&quot;, person_id</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         df = self.sim.population.props</span>
<span class="c1">#         now = self.sim.date</span>
<span class="c1">#</span>
<span class="c1">#         # if no xpert test</span>
<span class="c1">#         if not df.at[person_id, &quot;tb_xpert_test&quot;]:</span>
<span class="c1">#             logger.debug(</span>
<span class="c1">#                 &quot;This is TbCheckXpert, scheduling HSI_Tb_SputumTest for person %d&quot;,</span>
<span class="c1">#                 person_id,</span>
<span class="c1">#             )</span>
<span class="c1">#</span>
<span class="c1">#             event = HSI_Tb_SputumTest(self.module, person_id=person_id)</span>
<span class="c1">#             self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                 event,</span>
<span class="c1">#                 priority=2,</span>
<span class="c1">#                 topen=self.sim.date,</span>
<span class="c1">#                 tclose=self.sim.date + DateOffset(weeks=2),</span>
<span class="c1">#             )</span>
<span class="c1">#</span>
<span class="c1">#         # if no xpert in last 14 days</span>
<span class="c1">#         if (now - df.at[person_id, &quot;tb_date_xpert_test&quot;]) &gt; pd.to_timedelta(</span>
<span class="c1">#             14, unit=&quot;d&quot;</span>
<span class="c1">#         ):</span>
<span class="c1">#             logger.debug(</span>
<span class="c1">#                 &quot;This is TbCheckXpert, scheduling HSI_Tb_SputumTest for person %d&quot;,</span>
<span class="c1">#                 person_id,</span>
<span class="c1">#             )</span>
<span class="c1">#</span>
<span class="c1">#             event = HSI_Tb_SputumTest(self.module, person_id=person_id)</span>
<span class="c1">#             self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                 event,</span>
<span class="c1">#                 priority=2,</span>
<span class="c1">#                 topen=self.sim.date,</span>
<span class="c1">#                 tclose=self.sim.date + DateOffset(weeks=2),</span>
<span class="c1">#             )</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class TbCheckXray(Event, IndividualScopeEventMixin):</span>
<span class="c1">#     &quot;&quot;&quot; if person has not received chest x-ray as prescribed, treat if still presumptive case</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self, module, person_id):</span>
<span class="c1">#         super().__init__(module, person_id=person_id)</span>
<span class="c1">#</span>
<span class="c1">#     def apply(self, person_id):</span>
<span class="c1">#         logger.debug(</span>
<span class="c1">#             &quot;This is TbCheckXray checking if person %d received xpert test&quot;, person_id</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         df = self.sim.population.props</span>
<span class="c1">#         now = self.sim.date</span>
<span class="c1">#</span>
<span class="c1">#         # if not started treatment in last 14 days and still have symptoms</span>
<span class="c1">#         if not df.at[person_id, &quot;tb_date_treated&quot;] or (</span>
<span class="c1">#             now - df.at[person_id, &quot;tb_date_treated&quot;]</span>
<span class="c1">#         ) &lt; pd.to_timedelta(14, unit=&quot;d&quot;):</span>
<span class="c1">#             logger.debug(</span>
<span class="c1">#                 &quot;This is TbCheckXray, scheduling HSI_Tb_StartTreatmentChild for person %d&quot;,</span>
<span class="c1">#                 person_id,</span>
<span class="c1">#             )</span>
<span class="c1">#</span>
<span class="c1">#             event = HSI_Tb_StartTreatmentChild(self.module, person_id=person_id)</span>
<span class="c1">#             self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                 event,</span>
<span class="c1">#                 priority=2,</span>
<span class="c1">#                 topen=self.sim.date,</span>
<span class="c1">#                 tclose=self.sim.date + DateOffset(weeks=2),</span>
<span class="c1">#             )</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class TbSelfCureEvent(RegularEvent, PopulationScopeEventMixin):</span>
<span class="c1">#     &quot;&quot;&quot; tb self-cure events</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self, module):</span>
<span class="c1">#         super().__init__(module, frequency=DateOffset(months=1))  # every 1 month</span>
<span class="c1">#</span>
<span class="c1">#     def apply(self, population):</span>
<span class="c1">#         params = self.module.parameters</span>
<span class="c1">#         now = self.sim.date</span>
<span class="c1">#         rng = self.module.rng</span>
<span class="c1">#</span>
<span class="c1">#         df = population.props</span>
<span class="c1">#</span>
<span class="c1">#         # self-cure - move from active to latent, excludes cases that just became active</span>
<span class="c1">#         random_draw = rng.random_sample(size=len(df))</span>
<span class="c1">#</span>
<span class="c1">#         # hiv-negative</span>
<span class="c1">#         self_cure = df[</span>
<span class="c1">#             df[&quot;tb_inf&quot;].str.contains(&quot;active_susc&quot;)</span>
<span class="c1">#             &amp; df.is_alive</span>
<span class="c1">#             &amp; ~df.hv_inf</span>
<span class="c1">#             &amp; (df.tb_date_active &lt; now)</span>
<span class="c1">#             &amp; (random_draw &lt; params[&quot;monthly_prob_self_cure&quot;])</span>
<span class="c1">#         ].index</span>
<span class="c1">#         df.loc[self_cure, &quot;tb_inf&quot;] = &quot;latent_susc_new&quot;</span>
<span class="c1">#         df.loc[self_cure, &quot;tb_stage&quot;] = &quot;latent&quot;</span>
<span class="c1">#         df.loc[self_cure, &quot;tb_symptoms&quot;] = False</span>
<span class="c1">#         df.loc[self_cure, &quot;tb_diagnosed&quot;] = False</span>
<span class="c1">#</span>
<span class="c1">#         # hiv-positive, not on art</span>
<span class="c1">#         self_cure_hiv = df[</span>
<span class="c1">#             df[&quot;tb_inf&quot;].str.contains(&quot;active_susc&quot;)</span>
<span class="c1">#             &amp; df.is_alive</span>
<span class="c1">#             &amp; df.hv_inf</span>
<span class="c1">#             &amp; (df.hv_on_art != 2)</span>
<span class="c1">#             &amp; (df.tb_date_active &lt; now)</span>
<span class="c1">#             &amp; (random_draw &lt; params[&quot;monthly_prob_self_cure_hiv&quot;])</span>
<span class="c1">#         ].index</span>
<span class="c1">#         df.loc[self_cure_hiv, &quot;tb_inf&quot;] = &quot;latent_susc_new&quot;</span>
<span class="c1">#         df.loc[self_cure_hiv, &quot;tb_stage&quot;] = &quot;latent&quot;</span>
<span class="c1">#         df.loc[self_cure_hiv, &quot;tb_symptoms&quot;] = False</span>
<span class="c1">#         df.loc[self_cure_hiv, &quot;tb_diagnosed&quot;] = False</span>
<span class="c1">#</span>
<span class="c1">#         # hiv-positive, on art</span>
<span class="c1">#         self_cure_art = df[</span>
<span class="c1">#             df[&quot;tb_inf&quot;].str.contains(&quot;active_susc&quot;)</span>
<span class="c1">#             &amp; df.is_alive</span>
<span class="c1">#             &amp; df.hv_inf</span>
<span class="c1">#             &amp; (df.hv_on_art == 2)</span>
<span class="c1">#             &amp; (df.tb_date_active &lt; now)</span>
<span class="c1">#             &amp; (random_draw &lt; params[&quot;monthly_prob_self_cure&quot;])</span>
<span class="c1">#         ].index</span>
<span class="c1">#         df.loc[self_cure_art, &quot;tb_inf&quot;] = &quot;latent_susc_new&quot;</span>
<span class="c1">#         df.loc[self_cure_art, &quot;tb_stage&quot;] = &quot;latent&quot;</span>
<span class="c1">#         df.loc[self_cure_art, &quot;tb_symptoms&quot;] = False</span>
<span class="c1">#         df.loc[self_cure_art, &quot;tb_diagnosed&quot;] = False</span>
<span class="c1">#</span>
<span class="c1">#         # check that tb symptoms are present and caused by tb before resolving</span>
<span class="c1">#         # all_self_cure = pd.concat(self_cure, self_cure_hiv, self_cure_art)</span>
<span class="c1">#         # all_self_cure = self_cure + self_cure_hiv + self_cure_art</span>
<span class="c1">#         all_self_cure = [*self_cure, *self_cure_hiv, *self_cure_art]</span>
<span class="c1">#</span>
<span class="c1">#         for person_id in all_self_cure:</span>
<span class="c1">#             if (</span>
<span class="c1">#                 &quot;respiratory_symptoms&quot;</span>
<span class="c1">#                 in self.sim.modules[&quot;SymptomManager&quot;].has_what(person_id)</span>
<span class="c1">#             ) &amp; (</span>
<span class="c1">#                 &quot;Tb&quot;</span>
<span class="c1">#                 in self.sim.modules[&quot;SymptomManager&quot;].causes_of(</span>
<span class="c1">#                     person_id, &quot;respiratory_symptoms&quot;</span>
<span class="c1">#                 )</span>
<span class="c1">#             ):</span>
<span class="c1">#                 # this will clear all tb symptoms</span>
<span class="c1">#                 self.sim.modules[&quot;SymptomManager&quot;].clear_symptoms(</span>
<span class="c1">#                     person_id=person_id, disease_module=self.module</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># # ---------------------------------------------------------------------------</span>
<span class="c1"># #   TB MDR infection event</span>
<span class="c1"># # ---------------------------------------------------------------------------</span>
<span class="c1"># # TODO should transmission be limited within each district? background foi for transmission risk between districts</span>
<span class="c1"># # TODO add relative infectiousness for those on poor tx [prop tx failure]</span>
<span class="c1"># # TODO rel inf for smear negative - weight inf by prop smear negative</span>
<span class="c1"># # TODO age/sex distribution for new active cases? may emerge through rr active</span>
<span class="c1"># class TbMdrEvent(RegularEvent, PopulationScopeEventMixin):</span>
<span class="c1">#     &quot;&quot;&quot; tb-mdr infection events</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self, module):</span>
<span class="c1">#         super().__init__(module, frequency=DateOffset(months=1))  # every 1 month</span>
<span class="c1">#</span>
<span class="c1">#     def apply(self, population):</span>
<span class="c1">#         params = self.module.parameters</span>
<span class="c1">#         now = self.sim.date</span>
<span class="c1">#         rng = self.module.rng</span>
<span class="c1">#</span>
<span class="c1">#         df = population.props</span>
<span class="c1">#</span>
<span class="c1">#         # ----------------------------------- FORCE OF INFECTION -----------------------------------</span>
<span class="c1">#</span>
<span class="c1">#         # apply a force of infection to produce new latent cases</span>
<span class="c1">#         # no age distribution for FOI but the relative risks would affect distribution of active infections</span>
<span class="c1">#</span>
<span class="c1">#         # infectious people are active_pulm</span>
<span class="c1">#         # hiv-positive and hiv-negative</span>
<span class="c1">#         active_sm_pos = int(</span>
<span class="c1">#             len(</span>
<span class="c1">#                 df[</span>
<span class="c1">#                     df[&quot;tb_inf&quot;].str.contains(&quot;active_mdr&quot;)</span>
<span class="c1">#                     &amp; (df.tb_stage == &quot;active_pulm&quot;)</span>
<span class="c1">#                     &amp; df.is_alive</span>
<span class="c1">#                 ]</span>
<span class="c1">#             )</span>
<span class="c1">#             * params[&quot;prop_smear_positive&quot;]</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         active_sm_neg = int(</span>
<span class="c1">#             len(</span>
<span class="c1">#                 df[</span>
<span class="c1">#                     df[&quot;tb_inf&quot;].str.contains(&quot;active_mdr&quot;)</span>
<span class="c1">#                     &amp; (df.tb_stage == &quot;active_pulm&quot;)</span>
<span class="c1">#                     &amp; df.is_alive</span>
<span class="c1">#                 ]</span>
<span class="c1">#             )</span>
<span class="c1">#             * (1 - params[&quot;prop_smear_positive&quot;])</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         # population at-risk of new infection = uninfected</span>
<span class="c1">#         uninfected_total = len(df[(df.tb_inf == &quot;uninfected&quot;) &amp; df.is_alive])</span>
<span class="c1">#         total_population = len(df[df.is_alive])</span>
<span class="c1">#</span>
<span class="c1">#         # in small pops, may get zero values which results in FOI = 0</span>
<span class="c1">#         if active_sm_pos == 0:</span>
<span class="c1">#             active_sm_pos = 1</span>
<span class="c1">#</span>
<span class="c1">#         if active_sm_neg == 0:</span>
<span class="c1">#             active_sm_neg = 1</span>
<span class="c1">#</span>
<span class="c1">#         force_of_infection = (</span>
<span class="c1">#             params[&quot;transmission_rate&quot;]</span>
<span class="c1">#             * active_sm_pos</span>
<span class="c1">#             * (active_sm_neg * params[&quot;rel_inf_smear_ng&quot;])</span>
<span class="c1">#             * uninfected_total</span>
<span class="c1">#         ) / total_population</span>
<span class="c1">#         # print(&#39;force_of_infection: &#39;, force_of_infection)</span>
<span class="c1">#</span>
<span class="c1">#         # ----------------------------------- NEW INFECTIONS -----------------------------------</span>
<span class="c1">#</span>
<span class="c1">#         # pop at risk = susceptible and latent_susc, latent_mdr_primary only</span>
<span class="c1">#         #  no age/sex effect on risk of latent infection</span>
<span class="c1">#         prob_tb_new = pd.Series(0, index=df.index)</span>
<span class="c1">#         prob_tb_new.loc[</span>
<span class="c1">#             df.is_alive &amp; (df.tb_inf == &quot;uninfected&quot;)</span>
<span class="c1">#         ] = force_of_infection  # print(&#39;prob_tb_new: &#39;, prob_tb_new)</span>
<span class="c1">#</span>
<span class="c1">#         # assign risk of latent tb</span>
<span class="c1">#         risk_tb = pd.Series(1, index=df.index)</span>
<span class="c1">#         risk_tb.loc[df.is_alive &amp; df.tb_bcg &amp; df.age_years &lt; 10] *= params[&quot;rr_bcg_inf&quot;]</span>
<span class="c1">#</span>
<span class="c1">#         # weight the likelihood of being sampled by the relative risk</span>
<span class="c1">#         norm_p = pd.Series(risk_tb)</span>
<span class="c1">#         norm_p /= norm_p.sum()  # normalise</span>
<span class="c1">#</span>
<span class="c1">#         # get a list of random numbers between 0 and 1 for each infected individual</span>
<span class="c1">#         random_draw = rng.random_sample(size=len(df))</span>
<span class="c1">#</span>
<span class="c1">#         tb_idx = df.index[df.is_alive &amp; (random_draw &lt; (prob_tb_new * norm_p))]</span>
<span class="c1">#</span>
<span class="c1">#         df.loc[tb_idx, &quot;tb_inf&quot;] = &quot;latent_mdr_new&quot;</span>
<span class="c1">#         df.loc[tb_idx, &quot;tb_date_latent&quot;] = now</span>
<span class="c1">#         df.loc[tb_idx, &quot;tb_stage&quot;] = &quot;latent&quot;</span>
<span class="c1">#</span>
<span class="c1">#         # ----------------------------------- RE-INFECTIONS -----------------------------------</span>
<span class="c1">#</span>
<span class="c1">#         # pop at risk = latent_mdr_secondary, latent_susc (primary &amp; secondary)</span>
<span class="c1">#         prob_tb_reinf = pd.Series(0, index=df.index)</span>
<span class="c1">#         prob_tb_reinf.loc[</span>
<span class="c1">#             (df.tb_inf == &quot;latent_mdr_tx&quot;)</span>
<span class="c1">#             | df[&quot;tb_inf&quot;].str.contains(&quot;latent_susc&quot;) &amp; df.is_alive</span>
<span class="c1">#         ] = force_of_infection</span>
<span class="c1">#</span>
<span class="c1">#         repeat_case = df.index[df.is_alive &amp; (random_draw &lt; (prob_tb_reinf * norm_p))]</span>
<span class="c1">#</span>
<span class="c1">#         # unchanged status, high risk of relapse as if just recovered</span>
<span class="c1">#         df.loc[repeat_case, &quot;tb_inf&quot;] = &quot;latent_mdr_tx&quot;</span>
<span class="c1">#</span>
<span class="c1">#         df.loc[repeat_case, &quot;tb_date_latent&quot;] = now</span>
<span class="c1">#         df.loc[repeat_case, &quot;tb_stage&quot;] = &quot;latent&quot;</span>
<span class="c1">#</span>
<span class="c1">#         # -----------------------------------------------------------------------------------------------------</span>
<span class="c1">#         # PROGRESSION TO ACTIVE MDR-TB DISEASE</span>
<span class="c1">#</span>
<span class="c1">#         # ----------------------------------- ADULT PROGRESSORS TO ACTIVE DISEASE -----------------------------------</span>
<span class="c1">#</span>
<span class="c1">#         # probability of active disease</span>
<span class="c1">#         prob_prog = pd.Series(0, index=df.index)</span>
<span class="c1">#         prob_prog.loc[df.is_alive &amp; df.age_years.between(15, 100)] = params[</span>
<span class="c1">#             &quot;prog_active&quot;</span>
<span class="c1">#         ]</span>
<span class="c1">#         prob_prog.loc[df.hv_inf] *= params[&quot;rr_tb_hiv&quot;]</span>
<span class="c1">#         prob_prog.loc[(df.hv_on_art == 2)] *= (</span>
<span class="c1">#             params[&quot;rr_tb_hiv&quot;] * params[&quot;rr_tb_art_adult&quot;]</span>
<span class="c1">#         )</span>
<span class="c1">#         # prob_prog.loc[df.xxxx] *= params[&#39;rr_tb_overweight&#39;]</span>
<span class="c1">#         prob_prog.loc[df.li_bmi &gt;= 4] *= params[&quot;rr_tb_obese&quot;]</span>
<span class="c1">#         # prob_prog.loc[df.xxxx] *= params[&#39;rr_tb_diabetes1&#39;]</span>
<span class="c1">#         prob_prog.loc[df.li_ex_alc] *= params[&quot;rr_tb_alcohol&quot;]</span>
<span class="c1">#         prob_prog.loc[df.li_tob] *= params[&quot;rr_tb_smoking&quot;]</span>
<span class="c1">#</span>
<span class="c1">#         # ipt - protection against active disease for one yr (6-month regimen)</span>
<span class="c1">#         dur_ipt = pd.to_timedelta(params[&quot;dur_prot_ipt&quot;], unit=&quot;d&quot;)</span>
<span class="c1">#</span>
<span class="c1">#         prob_prog.loc[(df.tb_date_ipt &lt; (now - dur_ipt)) &amp; ~df.hv_inf] *= params[</span>
<span class="c1">#             &quot;rr_ipt_adult&quot;</span>
<span class="c1">#         ]</span>
<span class="c1">#         prob_prog.loc[</span>
<span class="c1">#             (df.tb_date_ipt &lt; (now - dur_ipt)) &amp; df.hv_inf &amp; (df.hv_on_art != 2)</span>
<span class="c1">#         ] *= params[&quot;rr_ipt_adult_hiv&quot;]</span>
<span class="c1">#         prob_prog.loc[</span>
<span class="c1">#             (df.tb_date_ipt &lt; (now - dur_ipt)) &amp; df.hv_inf &amp; (df.hv_on_art == 2)</span>
<span class="c1">#         ] *= params[&quot;rr_ipt_art_adult&quot;]</span>
<span class="c1">#</span>
<span class="c1">#         # scale probability of progression to match overall population values</span>
<span class="c1">#         mean = sum(prob_prog[df.is_alive &amp; df.age_years.between(15, 100)]) / len(</span>
<span class="c1">#             prob_prog[df.is_alive &amp; df.age_years.between(15, 100)]</span>
<span class="c1">#         )</span>
<span class="c1">#         scaling_factor = mean / params[&quot;prog_active&quot;]</span>
<span class="c1">#</span>
<span class="c1">#         prob_prog_scaled = prob_prog.divide(other=scaling_factor)</span>
<span class="c1">#         assert len(prob_prog) == len(prob_prog_scaled)</span>
<span class="c1">#</span>
<span class="c1">#         # if any newly infected latent cases, 14% become active directly, only for new infections</span>
<span class="c1">#         new_latent = len(</span>
<span class="c1">#             df[</span>
<span class="c1">#                 (df.tb_inf == &quot;latent_mdr_new&quot;)</span>
<span class="c1">#                 &amp; (df.tb_date_latent == now)</span>
<span class="c1">#                 &amp; (df.age_years &gt;= 15)</span>
<span class="c1">#                 &amp; df.is_alive</span>
<span class="c1">#             ].index</span>
<span class="c1">#         )</span>
<span class="c1">#         # print(new_latent)</span>
<span class="c1">#</span>
<span class="c1">#         # some proportion schedule active now, else schedule active at random date</span>
<span class="c1">#         if new_latent:</span>
<span class="c1">#</span>
<span class="c1">#             # index of all new mdr cases</span>
<span class="c1">#             idx = df[</span>
<span class="c1">#                 (df.tb_inf == &quot;latent_mdr_new&quot;)</span>
<span class="c1">#                 &amp; (df.tb_date_latent == now)</span>
<span class="c1">#                 &amp; (df.age_years &gt;= 15)</span>
<span class="c1">#                 &amp; df.is_alive</span>
<span class="c1">#             ].index</span>
<span class="c1">#</span>
<span class="c1">#             # for each person determine if fast progressor and schedule onset of active disease</span>
<span class="c1">#             fast = pd.Series(data=False, index=df.loc[idx].index)</span>
<span class="c1">#</span>
<span class="c1">#             for i in df.index[idx]:</span>
<span class="c1">#                 fast[i] = rng.rand() &lt; params[&quot;prop_fast_progressor&quot;]</span>
<span class="c1">#</span>
<span class="c1">#             # print(&#39;fast&#39;, fast)</span>
<span class="c1">#</span>
<span class="c1">#             if fast.sum() &gt; 0:</span>
<span class="c1">#                 for person_id in fast.index[fast]:</span>
<span class="c1">#                     # print(&#39;fast&#39;, person_id)</span>
<span class="c1">#</span>
<span class="c1">#                     logger.debug(</span>
<span class="c1">#                         &quot;This is TbMdrEvent, scheduling active disease for fast progressing person %d on date %s&quot;,</span>
<span class="c1">#                         person_id,</span>
<span class="c1">#                         now,</span>
<span class="c1">#                     )</span>
<span class="c1">#                     # schedule active disease now</span>
<span class="c1">#                     self.sim.schedule_event(</span>
<span class="c1">#                         TbMdrActiveEvent(self.module, person_id), now</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#             for person_id in idx[~fast]:</span>
<span class="c1">#                 # print(&#39;slow&#39;, person_id)</span>
<span class="c1">#                 # decide if person will develop active tb</span>
<span class="c1">#                 active = rng.rand() &lt; prob_prog_scaled[person_id]</span>
<span class="c1">#</span>
<span class="c1">#                 if active:</span>
<span class="c1">#                     # randomly select date of onset of active disease</span>
<span class="c1">#                     # random draw of days 0-732</span>
<span class="c1">#                     random_date = rng.randint(low=0, high=732)</span>
<span class="c1">#                     sch_date = now + pd.to_timedelta(random_date, unit=&quot;d&quot;)</span>
<span class="c1">#</span>
<span class="c1">#                     logger.debug(</span>
<span class="c1">#                         &quot;This is TbMdrEvent, scheduling active disease for slow progressing person %d on date %s&quot;,</span>
<span class="c1">#                         person_id,</span>
<span class="c1">#                         sch_date,</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#                     # schedule active disease</span>
<span class="c1">#                     self.sim.schedule_event(</span>
<span class="c1">#                         TbMdrActiveEvent(self.module, person_id), sch_date</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#         # ----------------------------------- CHILD PROGRESSORS TO ACTIVE DISEASE -----------------------------------</span>
<span class="c1">#         # probability of active disease</span>
<span class="c1">#         prob_prog_child = pd.Series(0, index=df.index)</span>
<span class="c1">#         prob_prog_child.loc[df.is_alive &amp; (df.age_years &lt; 1)] = params[&quot;prog_1yr&quot;]</span>
<span class="c1">#         prob_prog_child.loc[df.is_alive &amp; (df.age_years.between(1, 2))] = params[</span>
<span class="c1">#             &quot;prog_1_2yr&quot;</span>
<span class="c1">#         ]</span>
<span class="c1">#         prob_prog_child.loc[df.is_alive &amp; (df.age_years.between(2, 5))] = params[</span>
<span class="c1">#             &quot;prog_2_5yr&quot;</span>
<span class="c1">#         ]</span>
<span class="c1">#         prob_prog_child.loc[df.is_alive &amp; (df.age_years.between(5, 10))] = params[</span>
<span class="c1">#             &quot;prog_5_10yr&quot;</span>
<span class="c1">#         ]</span>
<span class="c1">#         prob_prog_child.loc[df.is_alive &amp; (df.age_years.between(10, 15))] = params[</span>
<span class="c1">#             &quot;prog_10yr&quot;</span>
<span class="c1">#         ]</span>
<span class="c1">#         prob_prog_child.loc[df.tb_bcg &amp; df.age_years &lt; 10] *= params[&quot;rr_tb_bcg&quot;]</span>
<span class="c1">#         prob_prog_child.loc[(df.hv_on_art == 2)] *= params[&quot;rr_tb_art_child&quot;]</span>
<span class="c1">#</span>
<span class="c1">#         # ipt - protection against active disease for one yr (6-month regimen)</span>
<span class="c1">#         dur_ipt_inf = pd.to_timedelta(params[&quot;dur_prot_ipt_infant&quot;], unit=&quot;d&quot;)</span>
<span class="c1">#</span>
<span class="c1">#         prob_prog_child.loc[</span>
<span class="c1">#             (df.tb_date_ipt &lt; (now - dur_ipt_inf)) &amp; ~df.hv_inf</span>
<span class="c1">#         ] *= params[&quot;rr_ipt_child&quot;]</span>
<span class="c1">#         prob_prog_child.loc[</span>
<span class="c1">#             (df.tb_date_ipt &lt; (now - dur_ipt_inf)) &amp; df.hv_inf &amp; (df.hv_on_art != 2)</span>
<span class="c1">#         ] *= params[&quot;rr_ipt_child_hiv&quot;]</span>
<span class="c1">#         prob_prog_child.loc[</span>
<span class="c1">#             (df.tb_date_ipt &lt; (now - dur_ipt_inf)) &amp; df.hv_inf &amp; (df.hv_on_art == 2)</span>
<span class="c1">#         ] *= params[&quot;rr_ipt_art_child&quot;]</span>
<span class="c1">#</span>
<span class="c1">#         # no direct progression</span>
<span class="c1">#         # progression within 1 year</span>
<span class="c1">#         new_latent_child = df[</span>
<span class="c1">#             (df.tb_inf == &quot;latent_mdr_new&quot;)</span>
<span class="c1">#             &amp; (df.tb_date_latent == now)</span>
<span class="c1">#             &amp; (df.age_years &lt; 15)</span>
<span class="c1">#             &amp; df.is_alive</span>
<span class="c1">#         ].sum()</span>
<span class="c1">#         # print(new_latent)</span>
<span class="c1">#</span>
<span class="c1">#         # some proportion schedule active now, else schedule active at random date</span>
<span class="c1">#         if new_latent_child.any():</span>
<span class="c1">#             prog = df[</span>
<span class="c1">#                 (df.tb_inf == &quot;latent_mdr_new&quot;)</span>
<span class="c1">#                 &amp; (df.tb_date_latent == now)</span>
<span class="c1">#                 &amp; (df.age_years &lt; 15)</span>
<span class="c1">#                 &amp; df.is_alive</span>
<span class="c1">#             ].index</span>
<span class="c1">#</span>
<span class="c1">#             for person_id in prog:</span>
<span class="c1">#                 # decide if person will develop active tb</span>
<span class="c1">#                 active = rng.rand() &lt; prob_prog_child[person_id]</span>
<span class="c1">#</span>
<span class="c1">#                 if active:</span>
<span class="c1">#                     # random draw of days 0-182</span>
<span class="c1">#                     random_date = rng.randint(low=0, high=182)</span>
<span class="c1">#                     # convert days into years</span>
<span class="c1">#                     random_days = pd.to_timedelta(random_date, unit=&quot;d&quot;)</span>
<span class="c1">#</span>
<span class="c1">#                     sch_date = now + random_days</span>
<span class="c1">#</span>
<span class="c1">#                     logger.debug(</span>
<span class="c1">#                         &quot;This is TbMdrEvent, scheduling active disease for child %d on date %s&quot;,</span>
<span class="c1">#                         person_id,</span>
<span class="c1">#                         sch_date,</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#                     # schedule active disease</span>
<span class="c1">#                     self.sim.schedule_event(</span>
<span class="c1">#                         TbMdrActiveEvent(self.module, person_id), sch_date</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class TbMdrActiveEvent(Event, IndividualScopeEventMixin):</span>
<span class="c1">#     def __init__(self, module, person_id):</span>
<span class="c1">#         super().__init__(module, person_id=person_id)</span>
<span class="c1">#</span>
<span class="c1">#     def apply(self, person_id):</span>
<span class="c1">#         logger.debug(&quot;Onset of active MDR-TB for person %d&quot;, person_id)</span>
<span class="c1">#</span>
<span class="c1">#         df = self.sim.population.props</span>
<span class="c1">#         params = self.sim.modules[&quot;Tb&quot;].parameters</span>
<span class="c1">#         # prob_pulm = params[&#39;pulm_tb&#39;]</span>
<span class="c1">#         rng = self.module.rng</span>
<span class="c1">#         now = self.sim.date</span>
<span class="c1">#</span>
<span class="c1">#         # todo add in pulm / extrapulm probabilities</span>
<span class="c1">#</span>
<span class="c1">#         # check not on ipt now or on tb treatment</span>
<span class="c1">#         if not df.at[person_id, &quot;tb_on_ipt&quot;] or not df.at[person_id, &quot;tb_on_treatment&quot;]:</span>
<span class="c1">#</span>
<span class="c1">#             df.at[person_id, &quot;tb_date_active&quot;] = self.sim.date</span>
<span class="c1">#             df.at[person_id, &quot;tb_symptoms&quot;] = True</span>
<span class="c1">#             df.at[person_id, &quot;tb_ever_tb&quot;] = True</span>
<span class="c1">#             df.at[person_id, &quot;tb_ever_tb_mdr&quot;] = True</span>
<span class="c1">#             df.at[person_id, &quot;tb_stage&quot;] = &quot;active_pulm&quot;</span>
<span class="c1">#</span>
<span class="c1">#             # check if new infection or re-infection</span>
<span class="c1">#             # latent_susc_new or latent_susc_tx</span>
<span class="c1">#             if df.at[person_id, &quot;tb_inf&quot;] == &quot;latent_mdr_new&quot;:</span>
<span class="c1">#                 df.at[person_id, &quot;tb_inf&quot;] = &quot;active_mdr_new&quot;</span>
<span class="c1">#             elif df.at[person_id, &quot;tb_inf&quot;] == &quot;latent_mdr_tx&quot;:</span>
<span class="c1">#                 df.at[person_id, &quot;tb_inf&quot;] = &quot;active_mdr_tx&quot;</span>
<span class="c1">#</span>
<span class="c1">#             # decide smear positive / negative</span>
<span class="c1">#             # depends on HIV status</span>
<span class="c1">#             if df.at[person_id, &quot;hv_inf&quot;] &amp; (</span>
<span class="c1">#                 rng.rand() &lt; params[&quot;prop_smear_positive_hiv&quot;]</span>
<span class="c1">#             ):</span>
<span class="c1">#                 df.at[person_id, &quot;tb_smear&quot;] = True</span>
<span class="c1">#</span>
<span class="c1">#             elif rng.rand() &lt; params[&quot;prop_smear_positive&quot;]:</span>
<span class="c1">#                 df.at[person_id, &quot;tb_smear&quot;] = True</span>
<span class="c1">#</span>
<span class="c1">#             # ----------------------------------- ACTIVE CASES SEEKING CARE -----------------------------------</span>
<span class="c1">#</span>
<span class="c1">#             # determine whether they will seek care on symptom change</span>
<span class="c1">#             # prob_care = self.sim.modules[&#39;HealthSystem&#39;].get_prob_seek_care(person_id, symptom_code=2)</span>
<span class="c1">#</span>
<span class="c1">#             # this will be removed once healthcare seeking model is in place</span>
<span class="c1">#             prob_care = 0.47</span>
<span class="c1">#             if now.year == 2013:</span>
<span class="c1">#                 prob_care = 0.44</span>
<span class="c1">#             elif now.year == 2014:</span>
<span class="c1">#                 prob_care = 0.45</span>
<span class="c1">#             elif now.year == 2015:</span>
<span class="c1">#                 prob_care = 0.5</span>
<span class="c1">#             elif now.year == 2016:</span>
<span class="c1">#                 prob_care = 0.57</span>
<span class="c1">#             elif now.year &gt; 2016:</span>
<span class="c1">#                 prob_care = 0.73</span>
<span class="c1">#</span>
<span class="c1">#             seeks_care = rng.rand() &lt; prob_care</span>
<span class="c1">#</span>
<span class="c1">#             if seeks_care:</span>
<span class="c1">#                 logger.debug(</span>
<span class="c1">#                     &quot;This is TbMdrActiveEvent, scheduling HSI_Tb_Screening for person %d&quot;,</span>
<span class="c1">#                     person_id,</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#                 event = HSI_Tb_Screening(self.sim.modules[&quot;Tb&quot;], person_id=person_id)</span>
<span class="c1">#                 self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                     event,</span>
<span class="c1">#                     priority=2,</span>
<span class="c1">#                     topen=self.sim.date,</span>
<span class="c1">#                     tclose=self.sim.date + DateOffset(weeks=2),</span>
<span class="c1">#                 )</span>
<span class="c1">#             else:</span>
<span class="c1">#                 logger.debug(</span>
<span class="c1">#                     &quot;This is TbMdrActiveEvent, person %d is not seeking care&quot;, person_id</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#             if df.at[person_id, &quot;hv_inf&quot;]:</span>
<span class="c1">#                 logger.debug(</span>
<span class="c1">#                     &quot;This is TbActiveEvent scheduling aids onset for person %d&quot;,</span>
<span class="c1">#                     person_id,</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#                 aids = hiv.HivAidsEvent(self.module, person_id)</span>
<span class="c1">#                 self.sim.schedule_event(aids, self.sim.date)</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class TbMdrRelapseEvent(RegularEvent, PopulationScopeEventMixin):</span>
<span class="c1">#     &quot;&quot;&quot; relapse from latent to active</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self, module):</span>
<span class="c1">#         super().__init__(module, frequency=DateOffset(months=1))  # every 1 month</span>
<span class="c1">#</span>
<span class="c1">#     def apply(self, population):</span>
<span class="c1">#</span>
<span class="c1">#         df = self.sim.population.props</span>
<span class="c1">#         params = self.module.parameters</span>
<span class="c1">#         now = self.sim.date</span>
<span class="c1">#         rng = self.module.rng</span>
<span class="c1">#</span>
<span class="c1">#         # ----------------------------------- RELAPSE -----------------------------------</span>
<span class="c1">#         random_draw = rng.random_sample(size=len(df))</span>
<span class="c1">#</span>
<span class="c1">#         # relapse after treatment completion, tb_date_treated + six months</span>
<span class="c1">#         relapse_tx_complete = df[</span>
<span class="c1">#             (df.tb_inf == &quot;latent_mdr_tx&quot;)</span>
<span class="c1">#             &amp; ~df.tb_on_ipt</span>
<span class="c1">#             &amp; df.is_alive</span>
<span class="c1">#             &amp; (self.sim.date - df.tb_date_treated &gt; pd.to_timedelta(182.625, unit=&quot;d&quot;))</span>
<span class="c1">#             &amp; (self.sim.date - df.tb_date_treated &lt; pd.to_timedelta(732.5, unit=&quot;d&quot;))</span>
<span class="c1">#             &amp; ~df.tb_treatment_failure</span>
<span class="c1">#             &amp; (random_draw &lt; params[&quot;monthly_prob_relapse_tx_complete&quot;])</span>
<span class="c1">#         ].index</span>
<span class="c1">#</span>
<span class="c1">#         # relapse after treatment default, tb_treatment_failure=True, but make sure not tb-mdr</span>
<span class="c1">#         relapse_tx_incomplete = df[</span>
<span class="c1">#             (df.tb_inf == &quot;latent_mdr_tx&quot;)</span>
<span class="c1">#             &amp; ~df.tb_on_ipt</span>
<span class="c1">#             &amp; df.is_alive</span>
<span class="c1">#             &amp; df.tb_treatment_failure</span>
<span class="c1">#             &amp; (self.sim.date - df.tb_date_treated &gt; pd.to_timedelta(182.625, unit=&quot;d&quot;))</span>
<span class="c1">#             &amp; (self.sim.date - df.tb_date_treated &lt; pd.to_timedelta(732.5, unit=&quot;d&quot;))</span>
<span class="c1">#             &amp; (random_draw &lt; params[&quot;monthly_prob_relapse_tx_incomplete&quot;])</span>
<span class="c1">#         ].index</span>
<span class="c1">#</span>
<span class="c1">#         # relapse after &gt;2 years following completion of treatment (or default)</span>
<span class="c1">#         # use tb_date_treated + 2 years + 6 months of treatment</span>
<span class="c1">#         relapse_tx_2yrs = df[</span>
<span class="c1">#             (df.tb_inf == &quot;latent_mdr_secondary&quot;)</span>
<span class="c1">#             &amp; ~df.tb_on_ipt</span>
<span class="c1">#             &amp; df.is_alive</span>
<span class="c1">#             &amp; (self.sim.date - df.tb_date_treated &gt;= pd.to_timedelta(732.5, unit=&quot;d&quot;))</span>
<span class="c1">#             &amp; (random_draw &lt; params[&quot;monthly_prob_relapse_2yrs&quot;])</span>
<span class="c1">#         ].index</span>
<span class="c1">#</span>
<span class="c1">#         df.loc[</span>
<span class="c1">#             relapse_tx_complete | relapse_tx_incomplete | relapse_tx_2yrs, &quot;tb_inf&quot;</span>
<span class="c1">#         ] = &quot;active_mdr_tx&quot;</span>
<span class="c1">#         df.loc[</span>
<span class="c1">#             relapse_tx_complete | relapse_tx_incomplete | relapse_tx_2yrs,</span>
<span class="c1">#             &quot;tb_date_active&quot;,</span>
<span class="c1">#         ] = now</span>
<span class="c1">#         df.loc[</span>
<span class="c1">#             relapse_tx_complete | relapse_tx_incomplete | relapse_tx_2yrs, &quot;tb_ever_tb&quot;</span>
<span class="c1">#         ] = True</span>
<span class="c1">#         df.loc[</span>
<span class="c1">#             relapse_tx_complete | relapse_tx_incomplete | relapse_tx_2yrs, &quot;tb_stage&quot;</span>
<span class="c1">#         ] = &quot;active_pulm&quot;</span>
<span class="c1">#         df.loc[</span>
<span class="c1">#             relapse_tx_complete | relapse_tx_incomplete | relapse_tx_2yrs, &quot;tb_symptoms&quot;</span>
<span class="c1">#         ] = True</span>
<span class="c1">#</span>
<span class="c1">#         all_relapse_complete = relapse_tx_complete.append(relapse_tx_2yrs)</span>
<span class="c1">#         all_relapse = all_relapse_complete.append(relapse_tx_incomplete)</span>
<span class="c1">#</span>
<span class="c1">#         # ----------------------------------- SYMPTOMS -----------------------------------</span>
<span class="c1">#         df.loc[all_relapse, &quot;tb_any_resp_symptoms&quot;] = now</span>
<span class="c1">#</span>
<span class="c1">#         self.sim.modules[&quot;SymptomManager&quot;].change_symptom(</span>
<span class="c1">#             person_id=list(all_relapse),</span>
<span class="c1">#             symptom_string=&quot;fever&quot;,</span>
<span class="c1">#             add_or_remove=&quot;+&quot;,</span>
<span class="c1">#             disease_module=self.module,</span>
<span class="c1">#             duration_in_days=None,</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         self.sim.modules[&quot;SymptomManager&quot;].change_symptom(</span>
<span class="c1">#             person_id=list(all_relapse),</span>
<span class="c1">#             symptom_string=&quot;respiratory_symptoms&quot;,</span>
<span class="c1">#             add_or_remove=&quot;+&quot;,</span>
<span class="c1">#             disease_module=self.module,</span>
<span class="c1">#             duration_in_days=None,</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         self.sim.modules[&quot;SymptomManager&quot;].change_symptom(</span>
<span class="c1">#             person_id=list(all_relapse),</span>
<span class="c1">#             symptom_string=&quot;fatigue&quot;,</span>
<span class="c1">#             add_or_remove=&quot;+&quot;,</span>
<span class="c1">#             disease_module=self.module,</span>
<span class="c1">#             duration_in_days=None,</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         self.sim.modules[&quot;SymptomManager&quot;].change_symptom(</span>
<span class="c1">#             person_id=list(all_relapse),</span>
<span class="c1">#             symptom_string=&quot;night_sweats&quot;,</span>
<span class="c1">#             add_or_remove=&quot;+&quot;,</span>
<span class="c1">#             disease_module=self.module,</span>
<span class="c1">#             duration_in_days=None,</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         # ----------------------------------- RELAPSE CASES SEEKING CARE -----------------------------------</span>
<span class="c1">#         # relapse after complete treatment course - refer for xpert testing</span>
<span class="c1">#         # TODO leave this in here for now until diagnostic algorithm updated</span>
<span class="c1">#         # TODO: calibrate / input these data from MOH reports</span>
<span class="c1">#         prob_care = 0.47</span>
<span class="c1">#         if now.year == 2013:</span>
<span class="c1">#             prob_care = 0.44</span>
<span class="c1">#         elif now.year == 2014:</span>
<span class="c1">#             prob_care = 0.45</span>
<span class="c1">#         elif now.year == 2015:</span>
<span class="c1">#             prob_care = 0.5</span>
<span class="c1">#         elif now.year == 2016:</span>
<span class="c1">#             prob_care = 0.57</span>
<span class="c1">#         elif now.year &gt; 2016:</span>
<span class="c1">#             prob_care = 0.73</span>
<span class="c1">#</span>
<span class="c1">#         # if relapse after complete treatment course</span>
<span class="c1">#         seeks_care = pd.Series(data=False, index=df.loc[relapse_tx_2yrs].index)</span>
<span class="c1">#         for i in df.loc[all_relapse_complete].index:</span>
<span class="c1">#             prob = rng.rand() &lt; prob_care</span>
<span class="c1">#             seeks_care[i] = rng.rand() &lt; prob</span>
<span class="c1">#</span>
<span class="c1">#         if seeks_care.sum() &gt; 0:</span>
<span class="c1">#             for person_index in seeks_care.index[seeks_care]:</span>
<span class="c1">#                 logger.debug(</span>
<span class="c1">#                     &quot;This is TbMdrRelapseEvent, scheduling HSI_Tb_XpertTest for person %d&quot;,</span>
<span class="c1">#                     person_index,</span>
<span class="c1">#                 )</span>
<span class="c1">#                 event = HSI_Tb_XpertTest(self.module, person_id=person_index)</span>
<span class="c1">#                 self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                     event,</span>
<span class="c1">#                     priority=2,</span>
<span class="c1">#                     topen=self.sim.date,</span>
<span class="c1">#                     tclose=self.sim.date + DateOffset(weeks=2),</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#                 # add back-up check if xpert is not available, then schedule sputum smear</span>
<span class="c1">#                 self.sim.schedule_event(</span>
<span class="c1">#                     TbCheckXpert(self.module, person_index),</span>
<span class="c1">#                     self.sim.date + DateOffset(weeks=2),</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#         # relapse after incomplete treatment course - repeat treatment course</span>
<span class="c1">#         seeks_care = pd.Series(data=False, index=df.loc[relapse_tx_incomplete].index)</span>
<span class="c1">#         for i in df.loc[relapse_tx_incomplete].index:</span>
<span class="c1">#             prob = rng.rand() &lt; prob_care</span>
<span class="c1">#             seeks_care[i] = rng.rand() &lt; prob</span>
<span class="c1">#</span>
<span class="c1">#         if seeks_care.sum() &gt; 0:</span>
<span class="c1">#             for person_index in seeks_care.index[seeks_care]:</span>
<span class="c1">#                 if df.at[person_index, &quot;age_years&quot;] &lt; 15:</span>
<span class="c1">#</span>
<span class="c1">#                     logger.debug(</span>
<span class="c1">#                         &quot;This is TbMdrActiveEvent, scheduling HSI_Tb_StartTreatmentChild for relapsed child %d&quot;,</span>
<span class="c1">#                         person_index,</span>
<span class="c1">#                     )</span>
<span class="c1">#                     event = HSI_Tb_StartTreatmentChild(</span>
<span class="c1">#                         self.module, person_id=person_index</span>
<span class="c1">#                     )</span>
<span class="c1">#                     self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                         event,</span>
<span class="c1">#                         priority=2,</span>
<span class="c1">#                         topen=self.sim.date,</span>
<span class="c1">#                         tclose=self.sim.date + DateOffset(weeks=2),</span>
<span class="c1">#                     )</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     logger.debug(</span>
<span class="c1">#                         &quot;This is TbMdrActiveEvent, scheduling HSI_Tb_StartTreatmentChild for relapsed adult %d&quot;,</span>
<span class="c1">#                         person_index,</span>
<span class="c1">#                     )</span>
<span class="c1">#                     event = HSI_Tb_StartTreatmentAdult(</span>
<span class="c1">#                         self.module, person_id=person_index</span>
<span class="c1">#                     )</span>
<span class="c1">#                     self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                         event,</span>
<span class="c1">#                         priority=2,</span>
<span class="c1">#                         topen=self.sim.date,</span>
<span class="c1">#                         tclose=self.sim.date + DateOffset(weeks=2),</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class TbMdrSelfCureEvent(RegularEvent, PopulationScopeEventMixin):</span>
<span class="c1">#     &quot;&quot;&quot; tb-mdr self-cure events</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self, module):</span>
<span class="c1">#         super().__init__(module, frequency=DateOffset(months=1))  # every 1 month</span>
<span class="c1">#</span>
<span class="c1">#     def apply(self, population):</span>
<span class="c1">#         params = self.module.parameters</span>
<span class="c1">#         now = self.sim.date</span>
<span class="c1">#</span>
<span class="c1">#         df = population.props</span>
<span class="c1">#</span>
<span class="c1">#         # self-cure - move from active to latent_secondary, make sure it&#39;s not the ones that just became active</span>
<span class="c1">#         random_draw = self.module.rng.random_sample(size=len(df))</span>
<span class="c1">#</span>
<span class="c1">#         # hiv-negative</span>
<span class="c1">#         self_cure = df[</span>
<span class="c1">#             df[&quot;tb_inf&quot;].str.contains(&quot;active_mdr&quot;)</span>
<span class="c1">#             &amp; df.is_alive</span>
<span class="c1">#             &amp; ~df.hv_inf</span>
<span class="c1">#             &amp; (df.tb_date_active &lt; now)</span>
<span class="c1">#             &amp; (random_draw &lt; params[&quot;monthly_prob_self_cure&quot;])</span>
<span class="c1">#         ].index</span>
<span class="c1">#         df.loc[self_cure, &quot;tb_inf&quot;] = &quot;latent_susc_new&quot;</span>
<span class="c1">#         df.loc[self_cure, &quot;tb_stage&quot;] = &quot;latent&quot;</span>
<span class="c1">#         df.loc[self_cure, &quot;tb_symptoms&quot;] = False</span>
<span class="c1">#         df.loc[self_cure, &quot;tb_diagnosed&quot;] = False</span>
<span class="c1">#</span>
<span class="c1">#         # hiv-positive, not on art</span>
<span class="c1">#         self_cure_hiv = df[</span>
<span class="c1">#             df[&quot;tb_inf&quot;].str.contains(&quot;active_mdr&quot;)</span>
<span class="c1">#             &amp; df.is_alive</span>
<span class="c1">#             &amp; df.hv_inf</span>
<span class="c1">#             &amp; (df.hv_on_art != 2)</span>
<span class="c1">#             &amp; (df.tb_date_active &lt; now)</span>
<span class="c1">#             &amp; (random_draw &lt; params[&quot;monthly_prob_self_cure_hiv&quot;])</span>
<span class="c1">#         ].index</span>
<span class="c1">#         df.loc[self_cure_hiv, &quot;tb_inf&quot;] = &quot;latent_susc_new&quot;</span>
<span class="c1">#         df.loc[self_cure_hiv, &quot;tb_stage&quot;] = &quot;latent&quot;</span>
<span class="c1">#         df.loc[self_cure_hiv, &quot;tb_symptoms&quot;] = False</span>
<span class="c1">#         df.loc[self_cure_hiv, &quot;tb_diagnosed&quot;] = False</span>
<span class="c1">#</span>
<span class="c1">#         # hiv-positive, on art</span>
<span class="c1">#         self_cure_art = df[</span>
<span class="c1">#             df[&quot;tb_inf&quot;].str.contains(&quot;active_mdr&quot;)</span>
<span class="c1">#             &amp; df.is_alive</span>
<span class="c1">#             &amp; df.hv_inf</span>
<span class="c1">#             &amp; (df.hv_on_art == 2)</span>
<span class="c1">#             &amp; (df.tb_date_active &lt; now)</span>
<span class="c1">#             &amp; (random_draw &lt; params[&quot;monthly_prob_self_cure&quot;])</span>
<span class="c1">#         ].index</span>
<span class="c1">#         df.loc[self_cure_art, &quot;tb_inf&quot;] = &quot;latent_susc_new&quot;</span>
<span class="c1">#         df.loc[self_cure_art, &quot;tb_stage&quot;] = &quot;latent&quot;</span>
<span class="c1">#         df.loc[self_cure_art, &quot;tb_symptoms&quot;] = False</span>
<span class="c1">#         df.loc[self_cure_art, &quot;tb_diagnosed&quot;] = False</span>
<span class="c1">#</span>
<span class="c1">#         # check that tb symptoms are present and caused by tb before resolving</span>
<span class="c1">#         # all_self_cure = pd.concat(self_cure, self_cure_hiv, self_cure_art)</span>
<span class="c1">#         # all_self_cure = self_cure + self_cure_hiv + self_cure_art</span>
<span class="c1">#         all_self_cure = [*self_cure, *self_cure_hiv, *self_cure_art]</span>
<span class="c1">#</span>
<span class="c1">#         for person_id in all_self_cure:</span>
<span class="c1">#             if (</span>
<span class="c1">#                 &quot;respiratory_symptoms&quot;</span>
<span class="c1">#                 in self.sim.modules[&quot;SymptomManager&quot;].has_what(person_id)</span>
<span class="c1">#             ) &amp; (</span>
<span class="c1">#                 &quot;Tb&quot;</span>
<span class="c1">#                 in self.sim.modules[&quot;SymptomManager&quot;].causes_of(</span>
<span class="c1">#                     person_id, &quot;respiratory_symptoms&quot;</span>
<span class="c1">#                 )</span>
<span class="c1">#             ):</span>
<span class="c1">#                 # this will clear all tb symptoms</span>
<span class="c1">#                 self.sim.modules[&quot;SymptomManager&quot;].clear_symptoms(</span>
<span class="c1">#                     person_id=person_id, disease_module=self.module</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># # ---------------------------------------------------------------------------</span>
<span class="c1"># #   HEALTH SYSTEM INTERACTIONS</span>
<span class="c1"># # ---------------------------------------------------------------------------</span>
<span class="c1">#</span>
<span class="c1"># # ---------------------------------------------------------------------------</span>
<span class="c1"># #   Testing</span>
<span class="c1"># # ---------------------------------------------------------------------------</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class HSI_Tb_Screening(HSI_Event, IndividualScopeEventMixin):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     This is a Health System Interaction Event.</span>
<span class="c1">#     It is the screening event that occurs before a sputum smear test or xpert is offered</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self, module, person_id):</span>
<span class="c1">#         super().__init__(module, person_id=person_id)</span>
<span class="c1">#         assert isinstance(module, Tb)</span>
<span class="c1">#</span>
<span class="c1">#         # Get a blank footprint and then edit to define call on resources of this event</span>
<span class="c1">#         the_appt_footprint = self.sim.modules[&quot;HealthSystem&quot;].get_blank_appt_footprint()</span>
<span class="c1">#         the_appt_footprint[</span>
<span class="c1">#             &quot;Over5OPD&quot;</span>
<span class="c1">#         ] = 0.5  # This requires a few minutes of an outpatient appt</span>
<span class="c1">#</span>
<span class="c1">#         # Define the necessary information for an HSI</span>
<span class="c1">#         self.TREATMENT_ID = &quot;Tb_Screening&quot;</span>
<span class="c1">#         self.EXPECTED_APPT_FOOTPRINT = the_appt_footprint</span>
<span class="c1">#         self.ACCEPTED_FACILITY_LEVEL = 1</span>
<span class="c1">#         self.ALERT_OTHER_DISEASES = [&quot;Hiv&quot;]</span>
<span class="c1">#</span>
<span class="c1">#     def apply(self, person_id, squeeze_factor):</span>
<span class="c1">#         logger.debug(</span>
<span class="c1">#             &quot;HSI_TbScreening: a screening appointment for person %d&quot;, person_id</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         df = self.sim.population.props</span>
<span class="c1">#</span>
<span class="c1">#         # check across all disease modules if patient has: cough, fever, night sweat, weight loss</span>
<span class="c1">#         # if any of the above conditions are present, label as presumptive tb case and request appropriate test</span>
<span class="c1">#</span>
<span class="c1">#         # hiv-negative adults or undiagnosed hiv-positive</span>
<span class="c1">#         if (</span>
<span class="c1">#             (df.at[person_id, &quot;tb_stage&quot;] == &quot;active_pulm&quot;)</span>
<span class="c1">#             and (df.at[person_id, &quot;age_exact_years&quot;] &gt;= 5)</span>
<span class="c1">#             and not (df.at[person_id, &quot;hv_diagnosed&quot;])</span>
<span class="c1">#         ):</span>
<span class="c1">#</span>
<span class="c1">#             logger.debug(</span>
<span class="c1">#                 &quot;HSI_TbScreening: scheduling sputum test for person %d&quot;, person_id</span>
<span class="c1">#             )</span>
<span class="c1">#</span>
<span class="c1">#             test = HSI_Tb_SputumTest(self.module, person_id=person_id)</span>
<span class="c1">#</span>
<span class="c1">#             # Request the health system to give xpert test</span>
<span class="c1">#             self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                 test, priority=1, topen=self.sim.date, tclose=None</span>
<span class="c1">#             )</span>
<span class="c1">#</span>
<span class="c1">#         # hiv-positive adults, diagnosed only</span>
<span class="c1">#         elif (</span>
<span class="c1">#             (df.at[person_id, &quot;tb_stage&quot;] == &quot;active_pulm&quot;)</span>
<span class="c1">#             and (df.at[person_id, &quot;age_exact_years&quot;] &gt;= 5)</span>
<span class="c1">#             and (df.at[person_id, &quot;hv_diagnosed&quot;])</span>
<span class="c1">#         ):</span>
<span class="c1">#</span>
<span class="c1">#             logger.debug(</span>
<span class="c1">#                 &quot;HSI_TbScreening: scheduling xpert test for person %d&quot;, person_id</span>
<span class="c1">#             )</span>
<span class="c1">#</span>
<span class="c1">#             test = HSI_Tb_XpertTest(self.module, person_id=person_id)</span>
<span class="c1">#</span>
<span class="c1">#             # Request the health system to give xpert test</span>
<span class="c1">#             self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                 test, priority=1, topen=self.sim.date, tclose=None</span>
<span class="c1">#             )</span>
<span class="c1">#</span>
<span class="c1">#             # add back-up check if xpert is not available, then schedule sputum smear</span>
<span class="c1">#             self.sim.schedule_event(</span>
<span class="c1">#                 TbCheckXpert(self.module, person_id),</span>
<span class="c1">#                 self.sim.date + DateOffset(weeks=2),</span>
<span class="c1">#             )</span>
<span class="c1">#</span>
<span class="c1">#         # if child &lt;5 schedule chest x-ray for diagnosis and add check if x-ray not available</span>
<span class="c1">#         elif (df.at[person_id, &quot;tb_stage&quot;] == &quot;active_pulm&quot;) and (</span>
<span class="c1">#             df.at[person_id, &quot;age_exact_years&quot;] &lt; 5</span>
<span class="c1">#         ):</span>
<span class="c1">#</span>
<span class="c1">#             logger.debug(</span>
<span class="c1">#                 &quot;HSI_TbScreening: scheduling chest xray for person %d&quot;, person_id</span>
<span class="c1">#             )</span>
<span class="c1">#</span>
<span class="c1">#             test = HSI_Tb_Xray(self.module, person_id=person_id)</span>
<span class="c1">#</span>
<span class="c1">#             # Request the health system to give xpert test</span>
<span class="c1">#             self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                 test, priority=1, topen=self.sim.date, tclose=None</span>
<span class="c1">#             )</span>
<span class="c1">#</span>
<span class="c1">#             # add back-up check if chest x-ray is not available, then treat if still symptomatic</span>
<span class="c1">#             self.sim.schedule_event(</span>
<span class="c1">#                 TbCheckXray(self.module, person_id), self.sim.date + DateOffset(weeks=2)</span>
<span class="c1">#             )</span>
<span class="c1">#</span>
<span class="c1">#     def did_not_run(self):</span>
<span class="c1">#         logger.debug(&quot;HSI_TbScreening: did not run&quot;)</span>
<span class="c1">#         pass</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class HSI_Tb_SputumTest(HSI_Event, IndividualScopeEventMixin):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     This is a sputum test for presumptive tb cases</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self, module, person_id):</span>
<span class="c1">#         super().__init__(module, person_id=person_id)</span>
<span class="c1">#         assert isinstance(module, Tb)</span>
<span class="c1">#</span>
<span class="c1">#         # Get a blank footprint and then edit to define call on resources of this event</span>
<span class="c1">#         the_appt_footprint = self.sim.modules[&quot;HealthSystem&quot;].get_blank_appt_footprint()</span>
<span class="c1">#         the_appt_footprint[</span>
<span class="c1">#             &quot;ConWithDCSA&quot;</span>
<span class="c1">#         ] = 1  # This requires one generic outpatient appt</span>
<span class="c1">#         the_appt_footprint[</span>
<span class="c1">#             &quot;LabTBMicro&quot;</span>
<span class="c1">#         ] = 1  # This requires one lab appt for microscopy</span>
<span class="c1">#</span>
<span class="c1">#         # Define the necessary information for an HSI</span>
<span class="c1">#         self.TREATMENT_ID = &quot;Tb_SputumTest&quot;</span>
<span class="c1">#         self.EXPECTED_APPT_FOOTPRINT = the_appt_footprint</span>
<span class="c1">#         self.ACCEPTED_FACILITY_LEVEL = 1</span>
<span class="c1">#         self.ALERT_OTHER_DISEASES = [&quot;Hiv&quot;]</span>
<span class="c1">#</span>
<span class="c1">#     def apply(self, person_id, squeeze_factor):</span>
<span class="c1">#         logger.debug(</span>
<span class="c1">#             &quot;This is HSI_Tb_SputumTest, giving a sputum test to person %d&quot;, person_id</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         df = self.sim.population.props</span>
<span class="c1">#         params = self.sim.modules[&quot;Tb&quot;].parameters</span>
<span class="c1">#         now = self.sim.date</span>
<span class="c1">#</span>
<span class="c1">#         # Get the consumables required</span>
<span class="c1">#         consumables = self.sim.modules[&quot;HealthSystem&quot;].parameters[&quot;Consumables&quot;]</span>
<span class="c1">#         pkg_code1 = pd.unique(</span>
<span class="c1">#             consumables.loc[</span>
<span class="c1">#                 consumables[&quot;Intervention_Pkg&quot;] == &quot;Microscopy Test&quot;,</span>
<span class="c1">#                 &quot;Intervention_Pkg_Code&quot;,</span>
<span class="c1">#             ]</span>
<span class="c1">#         )[0]</span>
<span class="c1">#</span>
<span class="c1">#         the_cons_footprint = {</span>
<span class="c1">#             &quot;Intervention_Package_Code&quot;: [{pkg_code1: 1}],</span>
<span class="c1">#             &quot;Item_Code&quot;: [],</span>
<span class="c1">#         }</span>
<span class="c1">#</span>
<span class="c1">#         is_cons_available = self.sim.modules[&quot;HealthSystem&quot;].request_consumables(</span>
<span class="c1">#             hsi_event=self, cons_req_as_footprint=the_cons_footprint</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         if is_cons_available:</span>
<span class="c1">#</span>
<span class="c1">#             df.at[person_id, &quot;tb_ever_tested&quot;] = True</span>
<span class="c1">#             df.at[person_id, &quot;tb_smear_test&quot;] = True</span>
<span class="c1">#             df.at[person_id, &quot;tb_date_smear_test&quot;] = now</span>
<span class="c1">#             df.at[person_id, &quot;tb_result_smear_test&quot;] = False</span>
<span class="c1">#</span>
<span class="c1">#             # ----------------------------------- OUTCOME OF TEST -----------------------------------</span>
<span class="c1">#</span>
<span class="c1">#             # if smear-positive, sensitivity is 1</span>
<span class="c1">#             if (df.at[person_id, &quot;tb_stage&quot;] == &quot;active_pulm&quot;) and df.at[</span>
<span class="c1">#                 person_id, &quot;tb_smear&quot;</span>
<span class="c1">#             ]:</span>
<span class="c1">#                 df.at[person_id, &quot;tb_result_smear_test&quot;] = True</span>
<span class="c1">#                 df.at[person_id, &quot;tb_diagnosed&quot;] = True</span>
<span class="c1">#</span>
<span class="c1">#             # ----------------------------------- REFERRALS FOR TREATMENT -----------------------------------</span>
<span class="c1">#             if df.at[person_id, &quot;tb_diagnosed&quot;]:</span>
<span class="c1">#</span>
<span class="c1">#                 # request child treatment</span>
<span class="c1">#                 if (</span>
<span class="c1">#                     (df.at[person_id, &quot;tb_inf&quot;] == &quot;active_susc_new&quot;)</span>
<span class="c1">#                     | (df.at[person_id, &quot;tb_inf&quot;] == &quot;active_mdr_new&quot;)</span>
<span class="c1">#                 ) &amp; (df.at[person_id, &quot;age_years&quot;] &lt; 15):</span>
<span class="c1">#                     logger.debug(</span>
<span class="c1">#                         &quot;This is HSI_Tb_SputumTest scheduling HSI_Tb_StartTreatmentChild for person %d&quot;,</span>
<span class="c1">#                         person_id,</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#                     treatment = HSI_Tb_StartTreatmentChild(</span>
<span class="c1">#                         self.module, person_id=person_id</span>
<span class="c1">#                     )</span>
<span class="c1">#                     self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                         treatment,</span>
<span class="c1">#                         priority=1,</span>
<span class="c1">#                         topen=self.sim.date + DateOffset(days=1),</span>
<span class="c1">#                         tclose=None,</span>
<span class="c1">#                     )</span>
<span class="c1">#                 # request adult treatment</span>
<span class="c1">#                 if (</span>
<span class="c1">#                     (df.at[person_id, &quot;tb_inf&quot;] == &quot;active_susc_new&quot;)</span>
<span class="c1">#                     | (df.at[person_id, &quot;tb_inf&quot;] == &quot;active_mdr_new&quot;)</span>
<span class="c1">#                 ) &amp; (df.at[person_id, &quot;age_years&quot;] &gt;= 15):</span>
<span class="c1">#                     logger.debug(</span>
<span class="c1">#                         &quot;This is HSI_Tb_SputumTest scheduling HSI_Tb_StartTreatmentAdult for person %d&quot;,</span>
<span class="c1">#                         person_id,</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#                     treatment = HSI_Tb_StartTreatmentAdult(</span>
<span class="c1">#                         self.module, person_id=person_id</span>
<span class="c1">#                     )</span>
<span class="c1">#                     self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                         treatment,</span>
<span class="c1">#                         priority=1,</span>
<span class="c1">#                         topen=self.sim.date + DateOffset(days=1),</span>
<span class="c1">#                         tclose=None,</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#                 if (</span>
<span class="c1">#                     (df.at[person_id, &quot;tb_inf&quot;] == &quot;active_susc_tx&quot;)</span>
<span class="c1">#                     | (df.at[person_id, &quot;tb_inf&quot;] == &quot;active_mdr_tx&quot;)</span>
<span class="c1">#                 ) &amp; (df.at[person_id, &quot;age_years&quot;] &lt; 15):</span>
<span class="c1">#                     # request child retreatment</span>
<span class="c1">#                     logger.debug(</span>
<span class="c1">#                         &quot;This is HSI_Tb_SputumTest scheduling HSI_Tb_RetreatmentChild for person %d&quot;,</span>
<span class="c1">#                         person_id,</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#                     treatment = HSI_Tb_RetreatmentChild(</span>
<span class="c1">#                         self.module, person_id=person_id</span>
<span class="c1">#                     )</span>
<span class="c1">#                     self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                         treatment,</span>
<span class="c1">#                         priority=1,</span>
<span class="c1">#                         topen=self.sim.date + DateOffset(days=1),</span>
<span class="c1">#                         tclose=None,</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#                 if (</span>
<span class="c1">#                     (df.at[person_id, &quot;tb_inf&quot;] == &quot;active_susc_tx&quot;)</span>
<span class="c1">#                     | (df.at[person_id, &quot;tb_inf&quot;] == &quot;active_mdr_tx&quot;)</span>
<span class="c1">#                 ) &amp; (df.at[person_id, &quot;age_years&quot;] &gt;= 15):</span>
<span class="c1">#                     # request adult retreatment</span>
<span class="c1">#                     logger.debug(</span>
<span class="c1">#                         &quot;This is HSI_Tb_SputumTest scheduling HSI_Tb_RetreatmentAdult for person %d&quot;,</span>
<span class="c1">#                         person_id,</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#                     treatment = HSI_Tb_RetreatmentAdult(</span>
<span class="c1">#                         self.module, person_id=person_id</span>
<span class="c1">#                     )</span>
<span class="c1">#                     self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                         treatment,</span>
<span class="c1">#                         priority=1,</span>
<span class="c1">#                         topen=self.sim.date + DateOffset(days=1),</span>
<span class="c1">#                         tclose=None,</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#                 # ----------------------------------- REFERRALS FOR IPT -----------------------------------</span>
<span class="c1">#                 # todo check these coverage levels relate to paed contacts not HIV cases</span>
<span class="c1">#                 if self.sim.date.year &gt;= 2014:</span>
<span class="c1">#                     # if diagnosed, trigger ipt outreach event for all paediatric contacts of case</span>
<span class="c1">#                     district = df.at[person_id, &quot;district_of_residence&quot;]</span>
<span class="c1">#                     ipt_cov = params[&quot;ipt_contact_cov&quot;]</span>
<span class="c1">#                     ipt_cov_year = ipt_cov.loc[</span>
<span class="c1">#                         ipt_cov.year == self.sim.date.year</span>
<span class="c1">#                     ].coverage.values</span>
<span class="c1">#</span>
<span class="c1">#                     if (district in params[&quot;tb_high_risk_distr&quot;].values) &amp; (</span>
<span class="c1">#                         self.module.rng.rand() &lt; ipt_cov_year</span>
<span class="c1">#                     ):</span>
<span class="c1">#</span>
<span class="c1">#                         # check enough contacts available for sample</span>
<span class="c1">#                         if (</span>
<span class="c1">#                             len(</span>
<span class="c1">#                                 df[</span>
<span class="c1">#                                     (df.age_years &lt;= 5)</span>
<span class="c1">#                                     &amp; ~df.tb_ever_tb</span>
<span class="c1">#                                     &amp; ~df.tb_ever_tb_mdr</span>
<span class="c1">#                                     &amp; df.is_alive</span>
<span class="c1">#                                     &amp; (df.district_of_residence == district)</span>
<span class="c1">#                                 ].index</span>
<span class="c1">#                             )</span>
<span class="c1">#                             &gt; 5</span>
<span class="c1">#                         ):</span>
<span class="c1">#</span>
<span class="c1">#                             # randomly sample from &lt;5 yr olds within district</span>
<span class="c1">#                             ipt_sample = (</span>
<span class="c1">#                                 df[</span>
<span class="c1">#                                     (df.age_years &lt;= 5)</span>
<span class="c1">#                                     &amp; ~df.tb_ever_tb</span>
<span class="c1">#                                     &amp; ~df.tb_ever_tb_mdr</span>
<span class="c1">#                                     &amp; df.is_alive</span>
<span class="c1">#                                     &amp; (df.district_of_residence == district)</span>
<span class="c1">#                                 ]</span>
<span class="c1">#                                 .sample(n=5, replace=False)</span>
<span class="c1">#                                 .index</span>
<span class="c1">#                             )</span>
<span class="c1">#</span>
<span class="c1">#                             for person_id in ipt_sample:</span>
<span class="c1">#                                 logger.debug(</span>
<span class="c1">#                                     &quot;HSI_Tb_Sputum: scheduling IPT for person %d&quot;,</span>
<span class="c1">#                                     person_id,</span>
<span class="c1">#                                 )</span>
<span class="c1">#</span>
<span class="c1">#                                 ipt_event = HSI_Tb_Ipt(self.module, person_id=person_id)</span>
<span class="c1">#                                 self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                                     ipt_event,</span>
<span class="c1">#                                     priority=1,</span>
<span class="c1">#                                     topen=self.sim.date,</span>
<span class="c1">#                                     tclose=None,</span>
<span class="c1">#                                 )</span>
<span class="c1">#</span>
<span class="c1">#     def did_not_run(self):</span>
<span class="c1">#         logger.debug(&quot;HSI_Tb_SputumTest: did not run&quot;)</span>
<span class="c1">#         pass</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class HSI_Tb_XpertTest(HSI_Event, IndividualScopeEventMixin):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#         This is a Health System Interaction Event - tb xpert test</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self, module, person_id):</span>
<span class="c1">#         super().__init__(module, person_id=person_id)</span>
<span class="c1">#         assert isinstance(module, Tb)</span>
<span class="c1">#</span>
<span class="c1">#         # Get a blank footprint and then edit to define call on resources of this treatment event</span>
<span class="c1">#         the_appt_footprint = self.sim.modules[&quot;HealthSystem&quot;].get_blank_appt_footprint()</span>
<span class="c1">#         the_appt_footprint[&quot;TBFollowUp&quot;] = 1</span>
<span class="c1">#         the_appt_footprint[&quot;LabTBMicro&quot;] = 1</span>
<span class="c1">#</span>
<span class="c1">#         # Define the necessary information for an HSI</span>
<span class="c1">#         self.TREATMENT_ID = &quot;Tb_XpertTest&quot;</span>
<span class="c1">#         self.EXPECTED_APPT_FOOTPRINT = the_appt_footprint</span>
<span class="c1">#         self.ACCEPTED_FACILITY_LEVEL = 1</span>
<span class="c1">#         self.ALERT_OTHER_DISEASES = [&quot;Hiv&quot;]</span>
<span class="c1">#</span>
<span class="c1">#     def apply(self, person_id, squeeze_factor):</span>
<span class="c1">#         logger.debug(&quot;HSI_Tb_XpertTest: giving xpert test for person %d&quot;, person_id)</span>
<span class="c1">#</span>
<span class="c1">#         df = self.sim.population.props</span>
<span class="c1">#         now = self.sim.date</span>
<span class="c1">#         params = self.sim.modules[&quot;Tb&quot;].parameters</span>
<span class="c1">#</span>
<span class="c1">#         consumables = self.sim.modules[&quot;HealthSystem&quot;].parameters[&quot;Consumables&quot;]</span>
<span class="c1">#         pkg_code1 = pd.unique(</span>
<span class="c1">#             consumables.loc[</span>
<span class="c1">#                 consumables[&quot;Intervention_Pkg&quot;] == &quot;Xpert test&quot;, &quot;Intervention_Pkg_Code&quot;</span>
<span class="c1">#             ]</span>
<span class="c1">#         )[0]</span>
<span class="c1">#</span>
<span class="c1">#         the_cons_footprint = {</span>
<span class="c1">#             &quot;Intervention_Package_Code&quot;: [{pkg_code1: 1}],</span>
<span class="c1">#             &quot;Item_Code&quot;: [],</span>
<span class="c1">#         }</span>
<span class="c1">#</span>
<span class="c1">#         is_cons_available = self.sim.modules[&quot;HealthSystem&quot;].request_consumables(</span>
<span class="c1">#             hsi_event=self, cons_req_as_footprint=the_cons_footprint</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         if is_cons_available:</span>
<span class="c1">#             df.at[person_id, &quot;tb_ever_tested&quot;] = True</span>
<span class="c1">#             df.at[person_id, &quot;tb_xpert_test&quot;] = True</span>
<span class="c1">#             df.at[person_id, &quot;tb_date_xpert_test&quot;] = now</span>
<span class="c1">#             df.at[person_id, &quot;tb_result_xpert_test&quot;] = False</span>
<span class="c1">#             df.at[person_id, &quot;tb_diagnosed_mdr&quot;] = False  # default</span>
<span class="c1">#</span>
<span class="c1">#             # a further 15% of TB cases fail to be diagnosed with Xpert (sensitivity of test)</span>
<span class="c1">#             # they will present back to the health system with some delay (2-4 weeks)</span>
<span class="c1">#             if df.at[person_id, &quot;tb_inf&quot;].startswith(&quot;active&quot;):</span>
<span class="c1">#</span>
<span class="c1">#                 diagnosed = self.module.rng.choice(</span>
<span class="c1">#                     [True, False],</span>
<span class="c1">#                     size=1,</span>
<span class="c1">#                     p=[params[&quot;sens_xpert&quot;], (1 - params[&quot;sens_xpert&quot;])],</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#                 if diagnosed:</span>
<span class="c1">#                     df.at[person_id, &quot;tb_result_xpert_test&quot;] = True</span>
<span class="c1">#                     df.at[person_id, &quot;tb_diagnosed&quot;] = True</span>
<span class="c1">#</span>
<span class="c1">#                     if df.at[person_id, &quot;tb_inf&quot;].startswith(&quot;active_mdr&quot;):</span>
<span class="c1">#                         df.at[person_id, &quot;tb_diagnosed_mdr&quot;] = True</span>
<span class="c1">#</span>
<span class="c1">#                     # ----------------------------------- REFERRALS FOR IPT -----------------------------------</span>
<span class="c1">#                     # todo check these coverage levels relate to paed contacts not HIV cases</span>
<span class="c1">#                     if self.sim.date.year &gt;= 2014:</span>
<span class="c1">#                         # if diagnosed, trigger ipt outreach event for all paediatric contacts of case</span>
<span class="c1">#                         district = df.at[person_id, &quot;district_of_residence&quot;]</span>
<span class="c1">#                         ipt_cov = params[&quot;ipt_contact_cov&quot;]</span>
<span class="c1">#                         ipt_cov_year = ipt_cov.loc[</span>
<span class="c1">#                             ipt_cov.year == self.sim.date.year</span>
<span class="c1">#                         ].coverage.values</span>
<span class="c1">#</span>
<span class="c1">#                         if (district in params[&quot;tb_high_risk_distr&quot;].values) &amp; (</span>
<span class="c1">#                             self.module.rng.rand() &lt; ipt_cov_year</span>
<span class="c1">#                         ):</span>
<span class="c1">#</span>
<span class="c1">#                             # check enough contacts available for sample</span>
<span class="c1">#                             if (</span>
<span class="c1">#                                 len(</span>
<span class="c1">#                                     df[</span>
<span class="c1">#                                         (df.age_years &lt;= 5)</span>
<span class="c1">#                                         &amp; ~df.tb_ever_tb</span>
<span class="c1">#                                         &amp; ~df.tb_ever_tb_mdr</span>
<span class="c1">#                                         &amp; df.is_alive</span>
<span class="c1">#                                         &amp; (df.district_of_residence == district)</span>
<span class="c1">#                                     ].index</span>
<span class="c1">#                                 )</span>
<span class="c1">#                                 &gt; 5</span>
<span class="c1">#                             ):</span>
<span class="c1">#</span>
<span class="c1">#                                 # randomly sample from &lt;5 yr olds within district</span>
<span class="c1">#                                 ipt_sample = (</span>
<span class="c1">#                                     df[</span>
<span class="c1">#                                         (df.age_years &lt;= 5)</span>
<span class="c1">#                                         &amp; ~df.tb_ever_tb</span>
<span class="c1">#                                         &amp; ~df.tb_ever_tb_mdr</span>
<span class="c1">#                                         &amp; df.is_alive</span>
<span class="c1">#                                         &amp; (df.district_of_residence == district)</span>
<span class="c1">#                                     ]</span>
<span class="c1">#                                     .sample(n=5, replace=False)</span>
<span class="c1">#                                     .index</span>
<span class="c1">#                                 )</span>
<span class="c1">#</span>
<span class="c1">#                                 for person_id in ipt_sample:</span>
<span class="c1">#                                     logger.debug(</span>
<span class="c1">#                                         &quot;HSI_Tb_XpertTest: scheduling IPT for person %d&quot;,</span>
<span class="c1">#                                         person_id,</span>
<span class="c1">#                                     )</span>
<span class="c1">#</span>
<span class="c1">#                                     ipt_event = HSI_Tb_Ipt(</span>
<span class="c1">#                                         self.module, person_id=person_id</span>
<span class="c1">#                                     )</span>
<span class="c1">#                                     self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                                         ipt_event,</span>
<span class="c1">#                                         priority=1,</span>
<span class="c1">#                                         topen=self.sim.date,</span>
<span class="c1">#                                         tclose=None,</span>
<span class="c1">#                                     )</span>
<span class="c1">#</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     # Request the health system for screening again in 2 weeks if still symptomatic</span>
<span class="c1">#                     logger.debug(</span>
<span class="c1">#                         &quot;HSI_Tb_XpertTest: with negative result for person %d&quot;,</span>
<span class="c1">#                         person_id,</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#                     followup = HSI_Tb_SputumTest(self.module, person_id=person_id)</span>
<span class="c1">#                     self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                         followup,</span>
<span class="c1">#                         priority=1,</span>
<span class="c1">#                         topen=self.sim.date + DateOffset(weeks=2),</span>
<span class="c1">#                         tclose=None,</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#                 # ----------------------------------- REFERRALS FOR TREATMENT -----------------------------------</span>
<span class="c1">#             if df.at[person_id, &quot;tb_diagnosed&quot;]:</span>
<span class="c1">#</span>
<span class="c1">#                 if (df.at[person_id, &quot;tb_inf&quot;] == &quot;active_susc_new&quot;) &amp; (</span>
<span class="c1">#                     df.at[person_id, &quot;age_years&quot;] &lt; 15</span>
<span class="c1">#                 ):</span>
<span class="c1">#                     # request child treatment</span>
<span class="c1">#                     logger.debug(</span>
<span class="c1">#                         &quot;HSI_Tb_XpertTest: scheduling HSI_Tb_StartTreatmentChild for person %d&quot;,</span>
<span class="c1">#                         person_id,</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#                     treatment = HSI_Tb_StartTreatmentChild(</span>
<span class="c1">#                         self.module, person_id=person_id</span>
<span class="c1">#                     )</span>
<span class="c1">#                     self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                         treatment, priority=1, topen=self.sim.date, tclose=None</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#                 if (df.at[person_id, &quot;tb_inf&quot;] == &quot;active_susc_new&quot;) &amp; (</span>
<span class="c1">#                     df.at[person_id, &quot;age_years&quot;] &gt;= 15</span>
<span class="c1">#                 ):</span>
<span class="c1">#                     # request adult treatment</span>
<span class="c1">#                     logger.debug(</span>
<span class="c1">#                         &quot;HSI_Tb_XpertTest: scheduling HSI_Tb_StartTreatmentAdult for person %d&quot;,</span>
<span class="c1">#                         person_id,</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#                     treatment = HSI_Tb_StartTreatmentAdult(</span>
<span class="c1">#                         self.module, person_id=person_id</span>
<span class="c1">#                     )</span>
<span class="c1">#                     self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                         treatment, priority=1, topen=self.sim.date, tclose=None</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#                 if (df.at[person_id, &quot;tb_inf&quot;] == &quot;active_susc_tx&quot;) &amp; (</span>
<span class="c1">#                     df.at[person_id, &quot;age_years&quot;] &lt; 15</span>
<span class="c1">#                 ):</span>
<span class="c1">#                     # request child retreatment</span>
<span class="c1">#                     logger.debug(</span>
<span class="c1">#                         &quot;HSI_Tb_XpertTest: scheduling HSI_Tb_StartTreatmentChild for person %d&quot;,</span>
<span class="c1">#                         person_id,</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#                     treatment = HSI_Tb_RetreatmentChild(</span>
<span class="c1">#                         self.module, person_id=person_id</span>
<span class="c1">#                     )</span>
<span class="c1">#                     self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                         treatment, priority=1, topen=self.sim.date, tclose=None</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#                 if (df.at[person_id, &quot;tb_inf&quot;] == &quot;active_susc_tx&quot;) &amp; (</span>
<span class="c1">#                     df.at[person_id, &quot;age_years&quot;] &gt;= 15</span>
<span class="c1">#                 ):</span>
<span class="c1">#                     # request adult retreatment</span>
<span class="c1">#                     logger.debug(</span>
<span class="c1">#                         &quot;HSI_Tb_XpertTest: scheduling HSI_Tb_StartTreatmentAdult for person %d&quot;,</span>
<span class="c1">#                         person_id,</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#                     treatment = HSI_Tb_RetreatmentAdult(</span>
<span class="c1">#                         self.module, person_id=person_id</span>
<span class="c1">#                     )</span>
<span class="c1">#                     self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                         treatment, priority=1, topen=self.sim.date, tclose=None</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#                 if df.at[person_id, &quot;tb_diagnosed&quot;] &amp; df.at[</span>
<span class="c1">#                     person_id, &quot;tb_inf&quot;</span>
<span class="c1">#                 ].startswith(&quot;active_mdr&quot;):</span>
<span class="c1">#                     # request treatment</span>
<span class="c1">#                     logger.debug(</span>
<span class="c1">#                         &quot;This is HSI_Tb_XpertTest scheduling HSI_Tb_StartMdrTreatment for person %d&quot;,</span>
<span class="c1">#                         person_id,</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#                     treatment = HSI_Tb_StartMdrTreatment(</span>
<span class="c1">#                         self.module, person_id=person_id</span>
<span class="c1">#                     )</span>
<span class="c1">#                     self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                         treatment, priority=1, topen=self.sim.date, tclose=None</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#                 # ----------------------------------- REFERRALS FOR IPT -----------------------------------</span>
<span class="c1">#                 # trigger ipt outreach event for all paediatric contacts of diagnosed case</span>
<span class="c1">#                 # randomly sample from &lt;5 yr olds, match by district</span>
<span class="c1">#                 if self.sim.date.year &gt;= 2014:</span>
<span class="c1">#                     # if diagnosed, trigger ipt outreach event for all paediatric contacts of case</span>
<span class="c1">#                     district = df.at[person_id, &quot;district_of_residence&quot;]</span>
<span class="c1">#                     ipt_cov = params[&quot;ipt_contact_cov&quot;]</span>
<span class="c1">#                     ipt_cov_year = ipt_cov.loc[</span>
<span class="c1">#                         ipt_cov.year == self.sim.date.year</span>
<span class="c1">#                     ].coverage.values</span>
<span class="c1">#</span>
<span class="c1">#                     if (district in params[&quot;tb_high_risk_distr&quot;].values) &amp; (</span>
<span class="c1">#                         self.module.rng.rand() &lt; ipt_cov_year</span>
<span class="c1">#                     ):</span>
<span class="c1">#</span>
<span class="c1">#                         if (</span>
<span class="c1">#                             len(</span>
<span class="c1">#                                 df[</span>
<span class="c1">#                                     (df.age_years &lt;= 5)</span>
<span class="c1">#                                     &amp; ~df.tb_ever_tb</span>
<span class="c1">#                                     &amp; ~df.tb_ever_tb_mdr</span>
<span class="c1">#                                     &amp; df.is_alive</span>
<span class="c1">#                                     &amp; (df.district_of_residence == district)</span>
<span class="c1">#                                 ].index</span>
<span class="c1">#                             )</span>
<span class="c1">#                             &gt; 5</span>
<span class="c1">#                         ):</span>
<span class="c1">#</span>
<span class="c1">#                             ipt_sample = (</span>
<span class="c1">#                                 df[</span>
<span class="c1">#                                     (df.age_years &lt;= 5)</span>
<span class="c1">#                                     &amp; ~(df.tb_inf.str.contains(&quot;active&quot;))</span>
<span class="c1">#                                     &amp; df.is_alive</span>
<span class="c1">#                                     &amp; (df.district_of_residence == district)</span>
<span class="c1">#                                 ]</span>
<span class="c1">#                                 .sample(n=5, replace=False)</span>
<span class="c1">#                                 .index</span>
<span class="c1">#                             )</span>
<span class="c1">#</span>
<span class="c1">#                             for person_id in ipt_sample:</span>
<span class="c1">#                                 logger.debug(</span>
<span class="c1">#                                     &quot;HSI_Tb_XpertTest: scheduling HSI_Tb_Ipt for person %d&quot;,</span>
<span class="c1">#                                     person_id,</span>
<span class="c1">#                                 )</span>
<span class="c1">#</span>
<span class="c1">#                                 ipt_event = HSI_Tb_Ipt(self.module, person_id=person_id)</span>
<span class="c1">#                                 self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                                     ipt_event,</span>
<span class="c1">#                                     priority=1,</span>
<span class="c1">#                                     topen=self.sim.date + DateOffset(days=1),</span>
<span class="c1">#                                     tclose=None,</span>
<span class="c1">#                                 )</span>
<span class="c1">#</span>
<span class="c1">#     def did_not_run(self):</span>
<span class="c1">#         logger.debug(&quot;HSI_Tb_XpertTest: did not run&quot;)</span>
<span class="c1">#         pass</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class HSI_Tb_Xray(HSI_Event, IndividualScopeEventMixin):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     This is a chest x-ray for presumptive tb cases</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self, module, person_id):</span>
<span class="c1">#         super().__init__(module, person_id=person_id)</span>
<span class="c1">#         assert isinstance(module, Tb)</span>
<span class="c1">#</span>
<span class="c1">#         # Get a blank footprint and then edit to define call on resources of this event</span>
<span class="c1">#         the_appt_footprint = self.sim.modules[&quot;HealthSystem&quot;].get_blank_appt_footprint()</span>
<span class="c1">#         the_appt_footprint[</span>
<span class="c1">#             &quot;Under5OPD&quot;</span>
<span class="c1">#         ] = 1  # This requires one paediatric outpatient appt</span>
<span class="c1">#         the_appt_footprint[&quot;DiagRadio&quot;] = 1  # This requires one x-ray appt</span>
<span class="c1">#</span>
<span class="c1">#         # Define the necessary information for an HSI</span>
<span class="c1">#         self.TREATMENT_ID = &quot;Tb_Xray&quot;</span>
<span class="c1">#         self.EXPECTED_APPT_FOOTPRINT = the_appt_footprint</span>
<span class="c1">#         self.ACCEPTED_FACILITY_LEVEL = 1</span>
<span class="c1">#         self.ALERT_OTHER_DISEASES = [&quot;Hiv&quot;]</span>
<span class="c1">#</span>
<span class="c1">#     def apply(self, person_id, squeeze_factor):</span>
<span class="c1">#         logger.debug(&quot;This is HSI_Tb_Xray, a chest x-ray for person %d&quot;, person_id)</span>
<span class="c1">#</span>
<span class="c1">#         df = self.sim.population.props</span>
<span class="c1">#         params = self.module.parameters</span>
<span class="c1">#</span>
<span class="c1">#         # Get the consumables required</span>
<span class="c1">#         consumables = self.sim.modules[&quot;HealthSystem&quot;].parameters[&quot;Consumables&quot;]</span>
<span class="c1">#         pkg_code1 = pd.unique(</span>
<span class="c1">#             consumables.loc[consumables[&quot;Item_Code&quot;] == 175, &quot;Intervention_Pkg_Code&quot;]</span>
<span class="c1">#         )[0]</span>
<span class="c1">#</span>
<span class="c1">#         the_cons_footprint = {</span>
<span class="c1">#             &quot;Intervention_Package_Code&quot;: [{pkg_code1: 1}],</span>
<span class="c1">#             &quot;Item_Code&quot;: [],</span>
<span class="c1">#         }</span>
<span class="c1">#</span>
<span class="c1">#         is_cons_available = self.sim.modules[&quot;HealthSystem&quot;].request_consumables(</span>
<span class="c1">#             hsi_event=self, cons_req_as_footprint=the_cons_footprint</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         if is_cons_available:</span>
<span class="c1">#</span>
<span class="c1">#             # ----------------------------------- OUTCOME OF TEST -----------------------------------</span>
<span class="c1">#</span>
<span class="c1">#             # active tb</span>
<span class="c1">#             if df.at[person_id, &quot;tb_stage&quot;] == &quot;active_pulm&quot;:</span>
<span class="c1">#                 df.at[person_id, &quot;tb_diagnosed&quot;] = True</span>
<span class="c1">#</span>
<span class="c1">#             # ------------------------- REFERRALS FOR TREATMENT -----------------------------------</span>
<span class="c1">#</span>
<span class="c1">#             if (</span>
<span class="c1">#                 df.at[person_id, &quot;tb_diagnosed&quot;]</span>
<span class="c1">#                 &amp; (df.at[person_id, &quot;tb_inf&quot;] == &quot;active_susc_new&quot;)</span>
<span class="c1">#                 &amp; (df.at[person_id, &quot;age_years&quot;] &lt; 15)</span>
<span class="c1">#             ):</span>
<span class="c1">#                 # request child treatment</span>
<span class="c1">#                 logger.debug(</span>
<span class="c1">#                     &quot;This is HSI_Tb_Xray scheduling HSI_Tb_StartTreatmentChild for person %d&quot;,</span>
<span class="c1">#                     person_id,</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#                 treatment = HSI_Tb_StartTreatmentChild(self.module, person_id=person_id)</span>
<span class="c1">#                 self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                     treatment,</span>
<span class="c1">#                     priority=1,</span>
<span class="c1">#                     topen=self.sim.date + DateOffset(days=1),</span>
<span class="c1">#                     tclose=None,</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#             if (</span>
<span class="c1">#                 df.at[person_id, &quot;tb_diagnosed&quot;]</span>
<span class="c1">#                 &amp; (df.at[person_id, &quot;tb_inf&quot;] == &quot;active_susc_tx&quot;)</span>
<span class="c1">#                 &amp; (df.at[person_id, &quot;age_years&quot;] &lt; 15)</span>
<span class="c1">#             ):</span>
<span class="c1">#</span>
<span class="c1">#                 # request child retreatment</span>
<span class="c1">#                 logger.debug(</span>
<span class="c1">#                     &quot;This is HSI_Tb_Xray scheduling HSI_Tb_RetreatmentChild for person %d&quot;,</span>
<span class="c1">#                     person_id,</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#                 treatment = HSI_Tb_RetreatmentChild(self.module, person_id=person_id)</span>
<span class="c1">#                 self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                     treatment,</span>
<span class="c1">#                     priority=1,</span>
<span class="c1">#                     topen=self.sim.date + DateOffset(days=1),</span>
<span class="c1">#                     tclose=None,</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#                 # ----------------------------------- REFERRALS FOR IPT -----------------------------------</span>
<span class="c1">#                 # todo check these coverage levels relate to paed contacts not HIV cases</span>
<span class="c1">#                 if self.sim.date.year &gt;= 2014:</span>
<span class="c1">#                     # if diagnosed, trigger ipt outreach event for all paediatric contacts of case</span>
<span class="c1">#                     district = df.at[person_id, &quot;district_of_residence&quot;]</span>
<span class="c1">#                     ipt_cov = params[&quot;ipt_contact_cov&quot;]</span>
<span class="c1">#                     ipt_cov_year = ipt_cov.loc[</span>
<span class="c1">#                         ipt_cov.year == self.sim.date.year</span>
<span class="c1">#                     ].coverage.values</span>
<span class="c1">#</span>
<span class="c1">#                     if (district in params[&quot;tb_high_risk_distr&quot;].values) &amp; (</span>
<span class="c1">#                         self.module.rng.rand() &lt; ipt_cov_year</span>
<span class="c1">#                     ):</span>
<span class="c1">#</span>
<span class="c1">#                         # check enough contacts available for sample</span>
<span class="c1">#                         if (</span>
<span class="c1">#                             len(</span>
<span class="c1">#                                 df[</span>
<span class="c1">#                                     (df.age_years &lt;= 5)</span>
<span class="c1">#                                     &amp; ~df.tb_ever_tb</span>
<span class="c1">#                                     &amp; ~df.tb_ever_tb_mdr</span>
<span class="c1">#                                     &amp; df.is_alive</span>
<span class="c1">#                                     &amp; (df.district_of_residence == district)</span>
<span class="c1">#                                 ].index</span>
<span class="c1">#                             )</span>
<span class="c1">#                             &gt; 5</span>
<span class="c1">#                         ):</span>
<span class="c1">#</span>
<span class="c1">#                             # randomly sample from &lt;5 yr olds within district</span>
<span class="c1">#                             ipt_sample = (</span>
<span class="c1">#                                 df[</span>
<span class="c1">#                                     (df.age_years &lt;= 5)</span>
<span class="c1">#                                     &amp; ~df.tb_ever_tb</span>
<span class="c1">#                                     &amp; ~df.tb_ever_tb_mdr</span>
<span class="c1">#                                     &amp; df.is_alive</span>
<span class="c1">#                                     &amp; (df.district_of_residence == district)</span>
<span class="c1">#                                 ]</span>
<span class="c1">#                                 .sample(n=5, replace=False)</span>
<span class="c1">#                                 .index</span>
<span class="c1">#                             )</span>
<span class="c1">#</span>
<span class="c1">#                             for person_id in ipt_sample:</span>
<span class="c1">#                                 logger.debug(</span>
<span class="c1">#                                     &quot;HSI_Tb_Xray: scheduling IPT for person %d&quot;,</span>
<span class="c1">#                                     person_id,</span>
<span class="c1">#                                 )</span>
<span class="c1">#</span>
<span class="c1">#                                 ipt_event = HSI_Tb_Ipt(self.module, person_id=person_id)</span>
<span class="c1">#                                 self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                                     ipt_event,</span>
<span class="c1">#                                     priority=1,</span>
<span class="c1">#                                     topen=self.sim.date,</span>
<span class="c1">#                                     tclose=None,</span>
<span class="c1">#                                 )</span>
<span class="c1">#</span>
<span class="c1">#     def did_not_run(self):</span>
<span class="c1">#         pass</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># # ---------------------------------------------------------------------------</span>
<span class="c1"># #   Treatment</span>
<span class="c1"># # ---------------------------------------------------------------------------</span>
<span class="c1"># # the consumables at treatment initiation include the cost for the full course of treatment</span>
<span class="c1"># # so the follow-up appts don&#39;t need to account for consumables, just appt time</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class HSI_Tb_StartTreatmentAdult(HSI_Event, IndividualScopeEventMixin):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     This is a Health System Interaction Event - start tb treatment</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self, module, person_id):</span>
<span class="c1">#         super().__init__(module, person_id=person_id)</span>
<span class="c1">#         assert isinstance(module, Tb)</span>
<span class="c1">#</span>
<span class="c1">#         # Get a blank footprint and then edit to define call on resources of this treatment event</span>
<span class="c1">#         the_appt_footprint = self.sim.modules[&quot;HealthSystem&quot;].get_blank_appt_footprint()</span>
<span class="c1">#         the_appt_footprint[</span>
<span class="c1">#             &quot;TBNew&quot;</span>
<span class="c1">#         ] = 1  # New tb treatment initiation appt, this include pharmacist time</span>
<span class="c1">#</span>
<span class="c1">#         # Define the necessary information for an HSI</span>
<span class="c1">#         self.TREATMENT_ID = &quot;Tb_TreatmentInitiationAdult&quot;</span>
<span class="c1">#         self.EXPECTED_APPT_FOOTPRINT = the_appt_footprint</span>
<span class="c1">#         self.ACCEPTED_FACILITY_LEVEL = 1</span>
<span class="c1">#         self.ALERT_OTHER_DISEASES = []</span>
<span class="c1">#</span>
<span class="c1">#     def apply(self, person_id, squeeze_factor):</span>
<span class="c1">#         logger.debug(&quot;We are now ready to treat this tb case %d&quot;, person_id)</span>
<span class="c1">#</span>
<span class="c1">#         now = self.sim.date</span>
<span class="c1">#         df = self.sim.population.props</span>
<span class="c1">#         params = self.module.parameters</span>
<span class="c1">#</span>
<span class="c1">#         consumables = self.sim.modules[&quot;HealthSystem&quot;].parameters[&quot;Consumables&quot;]</span>
<span class="c1">#         pkg_code1 = pd.unique(</span>
<span class="c1">#             consumables.loc[</span>
<span class="c1">#                 consumables[&quot;Intervention_Pkg&quot;]</span>
<span class="c1">#                 == &quot;First line treatment for new TB cases for adults&quot;,</span>
<span class="c1">#                 &quot;Intervention_Pkg_Code&quot;,</span>
<span class="c1">#             ]</span>
<span class="c1">#         )[0]</span>
<span class="c1">#</span>
<span class="c1">#         the_cons_footprint = {</span>
<span class="c1">#             &quot;Intervention_Package_Code&quot;: [{pkg_code1: 1}],</span>
<span class="c1">#             &quot;Item_Code&quot;: [],</span>
<span class="c1">#         }</span>
<span class="c1">#</span>
<span class="c1">#         is_cons_available = self.sim.modules[&quot;HealthSystem&quot;].request_consumables(</span>
<span class="c1">#             hsi_event=self, cons_req_as_footprint=the_cons_footprint</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         if is_cons_available:</span>
<span class="c1">#</span>
<span class="c1">#             # treatment allocated for pulmonary tb</span>
<span class="c1">#             if (</span>
<span class="c1">#                 df.at[person_id, &quot;is_alive&quot;]</span>
<span class="c1">#                 and df.at[person_id, &quot;tb_diagnosed&quot;]</span>
<span class="c1">#                 and df.at[person_id, &quot;tb_stage&quot;] == &quot;active_pulm&quot;</span>
<span class="c1">#             ):</span>
<span class="c1">#                 df.at[person_id, &quot;tb_on_treatment&quot;] = True</span>
<span class="c1">#                 df.at[person_id, &quot;tb_date_treated&quot;] = now</span>
<span class="c1">#</span>
<span class="c1">#                 # schedule a 6-month event where people are cured, symptoms return to latent or not cured</span>
<span class="c1">#                 self.sim.schedule_event(</span>
<span class="c1">#                     TbCureEvent(self.module, person_id),</span>
<span class="c1">#                     self.sim.date + DateOffset(months=6),</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#                 # follow-up appts</span>
<span class="c1">#                 logger.debug(</span>
<span class="c1">#                     &quot;This is HSI_Tb_StartTreatmentAdult: scheduling follow-up appointments for person %d&quot;,</span>
<span class="c1">#                     person_id,</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#                 # clinical monitoring</span>
<span class="c1">#                 followup_clin = HSI_Tb_FollowUp(self.module, person_id=person_id)</span>
<span class="c1">#</span>
<span class="c1">#                 # Request the health system to have this follow-up appointment</span>
<span class="c1">#                 weeks = params[&quot;followup_times&quot;][&quot;treatment_clinical&quot;]</span>
<span class="c1">#                 cleaned_list = [x for x in weeks if x == x]  # remove nan</span>
<span class="c1">#</span>
<span class="c1">#                 for i in range(0, len(cleaned_list)):</span>
<span class="c1">#                     followup_appt_date = self.sim.date + DateOffset(</span>
<span class="c1">#                         months=cleaned_list[i]</span>
<span class="c1">#                     )</span>
<span class="c1">#                     self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                         followup_clin,</span>
<span class="c1">#                         priority=1,</span>
<span class="c1">#                         topen=followup_appt_date,</span>
<span class="c1">#                         tclose=followup_appt_date + DateOffset(days=3),</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#                 # repeat sputum smear tests</span>
<span class="c1">#                 followup_smear = HSI_Tb_FollowUp_SputumTest(</span>
<span class="c1">#                     self.module, person_id=person_id</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#                 # Request the health system to have this follow-up appointment</span>
<span class="c1">#                 weeks = params[&quot;followup_times&quot;][&quot;treatment_sputum&quot;]</span>
<span class="c1">#                 cleaned_list = [x for x in weeks if x == x]  # remove nan</span>
<span class="c1">#</span>
<span class="c1">#                 for i in range(0, len(cleaned_list)):</span>
<span class="c1">#                     followup_appt_date = self.sim.date + DateOffset(</span>
<span class="c1">#                         months=cleaned_list[i]</span>
<span class="c1">#                     )</span>
<span class="c1">#                     self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                         followup_smear,</span>
<span class="c1">#                         priority=1,</span>
<span class="c1">#                         topen=followup_appt_date,</span>
<span class="c1">#                         tclose=followup_appt_date + DateOffset(days=3),</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#             # treatment allocated for extrapulmonary tb</span>
<span class="c1">#             if (</span>
<span class="c1">#                 df.at[person_id, &quot;is_alive&quot;]</span>
<span class="c1">#                 and df.at[person_id, &quot;tb_diagnosed&quot;]</span>
<span class="c1">#                 and df.at[person_id, &quot;tb_stage&quot;] == &quot;active_extra&quot;</span>
<span class="c1">#             ):</span>
<span class="c1">#</span>
<span class="c1">#                 df.at[person_id, &quot;tb_on_treatment&quot;] = True</span>
<span class="c1">#                 df.at[person_id, &quot;tb_date_treated&quot;] = now</span>
<span class="c1">#</span>
<span class="c1">#                 # schedule a 6-month event where people are cured, symptoms return to latent or not cured</span>
<span class="c1">#                 self.sim.schedule_event(</span>
<span class="c1">#                     TbCureEvent(self.module, person_id),</span>
<span class="c1">#                     self.sim.date + DateOffset(months=6),</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#                 # follow-up appts</span>
<span class="c1">#                 logger.debug(</span>
<span class="c1">#                     &quot;This is HSI_Tb_StartTreatmentAdult: scheduling follow-up appointments for person %d&quot;,</span>
<span class="c1">#                     person_id,</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#                 # clinical monitoring</span>
<span class="c1">#                 followup_clin = HSI_Tb_FollowUp(self.module, person_id=person_id)</span>
<span class="c1">#</span>
<span class="c1">#                 # Request the health system to have this follow-up appointment</span>
<span class="c1">#                 weeks = params[&quot;followup_times&quot;][&quot;treatment_extrapulm&quot;]</span>
<span class="c1">#                 cleaned_list = [x for x in weeks if x == x]  # remove nan</span>
<span class="c1">#</span>
<span class="c1">#                 for i in range(0, len(cleaned_list)):</span>
<span class="c1">#                     followup_appt_date = self.sim.date + DateOffset(</span>
<span class="c1">#                         months=cleaned_list[i]</span>
<span class="c1">#                     )</span>
<span class="c1">#                     self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                         followup_clin,</span>
<span class="c1">#                         priority=1,</span>
<span class="c1">#                         topen=followup_appt_date,</span>
<span class="c1">#                         tclose=followup_appt_date + DateOffset(days=3),</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#                 # repeat sputum smear tests</span>
<span class="c1">#                 followup_smear = HSI_Tb_FollowUp_SputumTest(</span>
<span class="c1">#                     self.module, person_id=person_id</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#                 # Request the health system to have this follow-up appointment</span>
<span class="c1">#                 weeks = params[&quot;followup_times&quot;][&quot;treatment_sputum&quot;]</span>
<span class="c1">#                 cleaned_list = [x for x in weeks if x == x]  # remove nan</span>
<span class="c1">#</span>
<span class="c1">#                 for i in range(0, len(cleaned_list)):</span>
<span class="c1">#                     followup_appt_date = self.sim.date + DateOffset(</span>
<span class="c1">#                         months=cleaned_list[i]</span>
<span class="c1">#                     )</span>
<span class="c1">#                     self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                         followup_smear,</span>
<span class="c1">#                         priority=1,</span>
<span class="c1">#                         topen=followup_appt_date,</span>
<span class="c1">#                         tclose=followup_appt_date + DateOffset(days=3),</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#     def did_not_run(self):</span>
<span class="c1">#         pass</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class HSI_Tb_StartTreatmentChild(HSI_Event, IndividualScopeEventMixin):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     This is a Health System Interaction Event - start tb treatment</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self, module, person_id):</span>
<span class="c1">#         super().__init__(module, person_id=person_id)</span>
<span class="c1">#         assert isinstance(module, Tb)</span>
<span class="c1">#</span>
<span class="c1">#         # Get a blank footprint and then edit to define call on resources of this treatment event</span>
<span class="c1">#         the_appt_footprint = self.sim.modules[&quot;HealthSystem&quot;].get_blank_appt_footprint()</span>
<span class="c1">#         the_appt_footprint[&quot;TBNew&quot;] = 1  # New tb treatment initiation appt</span>
<span class="c1">#</span>
<span class="c1">#         # Define the necessary information for an HSI</span>
<span class="c1">#         self.TREATMENT_ID = &quot;Tb_TreatmentInitiationChild&quot;</span>
<span class="c1">#         self.EXPECTED_APPT_FOOTPRINT = the_appt_footprint</span>
<span class="c1">#         self.ACCEPTED_FACILITY_LEVEL = 1</span>
<span class="c1">#         self.ALERT_OTHER_DISEASES = []</span>
<span class="c1">#</span>
<span class="c1">#     def apply(self, person_id, squeeze_factor):</span>
<span class="c1">#         logger.debug(&quot;We are now ready to treat this tb case %d&quot;, person_id)</span>
<span class="c1">#</span>
<span class="c1">#         now = self.sim.date</span>
<span class="c1">#         df = self.sim.population.props</span>
<span class="c1">#         params = self.module.parameters</span>
<span class="c1">#</span>
<span class="c1">#         consumables = self.sim.modules[&quot;HealthSystem&quot;].parameters[&quot;Consumables&quot;]</span>
<span class="c1">#         pkg_code1 = pd.unique(</span>
<span class="c1">#             consumables.loc[</span>
<span class="c1">#                 consumables[&quot;Intervention_Pkg&quot;]</span>
<span class="c1">#                 == &quot;First line treatment for new TB cases for children&quot;,</span>
<span class="c1">#                 &quot;Intervention_Pkg_Code&quot;,</span>
<span class="c1">#             ]</span>
<span class="c1">#         )[0]</span>
<span class="c1">#</span>
<span class="c1">#         the_cons_footprint = {</span>
<span class="c1">#             &quot;Intervention_Package_Code&quot;: [{pkg_code1: 1}],</span>
<span class="c1">#             &quot;Item_Code&quot;: [],</span>
<span class="c1">#         }</span>
<span class="c1">#</span>
<span class="c1">#         is_cons_available = self.sim.modules[&quot;HealthSystem&quot;].request_consumables(</span>
<span class="c1">#             hsi_event=self, cons_req_as_footprint=the_cons_footprint</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         if is_cons_available:</span>
<span class="c1">#</span>
<span class="c1">#             # treatment allocated for pulmonary tb</span>
<span class="c1">#             if (</span>
<span class="c1">#                 df.at[person_id, &quot;is_alive&quot;]</span>
<span class="c1">#                 and df.at[person_id, &quot;tb_diagnosed&quot;]</span>
<span class="c1">#                 and df.at[person_id, &quot;tb_stage&quot;] == &quot;active_pulm&quot;</span>
<span class="c1">#             ):</span>
<span class="c1">#</span>
<span class="c1">#                 df.at[person_id, &quot;tb_on_treatment&quot;] = True</span>
<span class="c1">#                 df.at[person_id, &quot;tb_date_treated&quot;] = now</span>
<span class="c1">#</span>
<span class="c1">#                 # schedule a 6-month event where people are cured, symptoms return to latent or not cured</span>
<span class="c1">#                 self.sim.schedule_event(</span>
<span class="c1">#                     TbCureEvent(self.module, person_id),</span>
<span class="c1">#                     self.sim.date + DateOffset(months=6),</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#                 # follow-up appts</span>
<span class="c1">#                 logger.debug(</span>
<span class="c1">#                     &quot;....This is HSI_Tb_StartTreatmentChild: scheduling follow-up appointments for person %d&quot;,</span>
<span class="c1">#                     person_id,</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#                 # clinical monitoring</span>
<span class="c1">#                 followup_clin = HSI_Tb_FollowUp(self.module, person_id=person_id)</span>
<span class="c1">#</span>
<span class="c1">#                 # Request the health system to have this follow-up appointment</span>
<span class="c1">#                 weeks = params[&quot;followup_times&quot;][&quot;treatment_clinical&quot;]</span>
<span class="c1">#                 cleaned_list = [x for x in weeks if x == x]  # remove nan</span>
<span class="c1">#</span>
<span class="c1">#                 for i in range(0, len(cleaned_list)):</span>
<span class="c1">#                     followup_appt_date = self.sim.date + DateOffset(</span>
<span class="c1">#                         months=cleaned_list[i]</span>
<span class="c1">#                     )</span>
<span class="c1">#                     self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                         followup_clin,</span>
<span class="c1">#                         priority=1,</span>
<span class="c1">#                         topen=followup_appt_date,</span>
<span class="c1">#                         tclose=followup_appt_date + DateOffset(days=3),</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#                 # repeat sputum smear tests</span>
<span class="c1">#                 followup_smear = HSI_Tb_FollowUp_SputumTest(</span>
<span class="c1">#                     self.module, person_id=person_id</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#                 # Request the health system to have this follow-up appointment</span>
<span class="c1">#                 weeks = params[&quot;followup_times&quot;][&quot;treatment_sputum&quot;]</span>
<span class="c1">#                 cleaned_list = [x for x in weeks if x == x]  # remove nan</span>
<span class="c1">#</span>
<span class="c1">#                 for i in range(0, len(cleaned_list)):</span>
<span class="c1">#                     followup_appt_date = self.sim.date + DateOffset(</span>
<span class="c1">#                         months=cleaned_list[i]</span>
<span class="c1">#                     )</span>
<span class="c1">#                     self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                         followup_smear,</span>
<span class="c1">#                         priority=1,</span>
<span class="c1">#                         topen=followup_appt_date,</span>
<span class="c1">#                         tclose=followup_appt_date + DateOffset(days=3),</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#             # treatment allocated for extrapulmonary tb</span>
<span class="c1">#             if (</span>
<span class="c1">#                 df.at[person_id, &quot;is_alive&quot;]</span>
<span class="c1">#                 and df.at[person_id, &quot;tb_diagnosed&quot;]</span>
<span class="c1">#                 and df.at[person_id, &quot;tb_stage&quot;] == &quot;active_extra&quot;</span>
<span class="c1">#             ):</span>
<span class="c1">#                 df.at[person_id, &quot;tb_on_treatment&quot;] = True</span>
<span class="c1">#                 df.at[person_id, &quot;tb_date_treated&quot;] = now</span>
<span class="c1">#</span>
<span class="c1">#                 # schedule a 6-month event where people are cured, symptoms return to latent or not cured</span>
<span class="c1">#                 self.sim.schedule_event(</span>
<span class="c1">#                     TbCureEvent(self.module, person_id),</span>
<span class="c1">#                     self.sim.date + DateOffset(months=6),</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#                 # follow-up appts</span>
<span class="c1">#                 logger.debug(</span>
<span class="c1">#                     &quot;....This is HSI_Tb_StartTreatmentChild: scheduling follow-up appointments for person %d&quot;,</span>
<span class="c1">#                     person_id,</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#                 # clinical monitoring</span>
<span class="c1">#                 followup_clin = HSI_Tb_FollowUp(self.module, person_id=person_id)</span>
<span class="c1">#</span>
<span class="c1">#                 # Request the health system to have this follow-up appointment</span>
<span class="c1">#                 weeks = params[&quot;followup_times&quot;][&quot;treatment_extrapulm&quot;]</span>
<span class="c1">#                 cleaned_list = [x for x in weeks if x == x]  # remove nan</span>
<span class="c1">#</span>
<span class="c1">#                 for i in range(0, len(cleaned_list)):</span>
<span class="c1">#                     followup_appt_date = self.sim.date + DateOffset(</span>
<span class="c1">#                         months=cleaned_list[i]</span>
<span class="c1">#                     )</span>
<span class="c1">#                     self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                         followup_clin,</span>
<span class="c1">#                         priority=1,</span>
<span class="c1">#                         topen=followup_appt_date,</span>
<span class="c1">#                         tclose=followup_appt_date + DateOffset(days=3),</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#                 # repeat sputum smear tests</span>
<span class="c1">#                 followup_smear = HSI_Tb_FollowUp_SputumTest(</span>
<span class="c1">#                     self.module, person_id=person_id</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#                 # Request the health system to have this follow-up appointment</span>
<span class="c1">#                 weeks = params[&quot;followup_times&quot;][&quot;treatment_sputum&quot;]</span>
<span class="c1">#                 cleaned_list = [x for x in weeks if x == x]  # remove nan</span>
<span class="c1">#</span>
<span class="c1">#                 for i in range(0, len(cleaned_list)):</span>
<span class="c1">#                     followup_appt_date = self.sim.date + DateOffset(</span>
<span class="c1">#                         months=cleaned_list[i]</span>
<span class="c1">#                     )</span>
<span class="c1">#                     self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                         followup_smear,</span>
<span class="c1">#                         priority=1,</span>
<span class="c1">#                         topen=followup_appt_date,</span>
<span class="c1">#                         tclose=followup_appt_date + DateOffset(days=3),</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#     def did_not_run(self):</span>
<span class="c1">#         pass</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class HSI_Tb_StartMdrTreatment(HSI_Event, IndividualScopeEventMixin):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     This is a Health System Interaction Event - start tb-mdr treatment</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self, module, person_id):</span>
<span class="c1">#         super().__init__(module, person_id=person_id)</span>
<span class="c1">#         assert isinstance(module, Tb)</span>
<span class="c1">#</span>
<span class="c1">#         # Get a blank footprint and then edit to define call on resources of this treatment event</span>
<span class="c1">#         the_appt_footprint = self.sim.modules[&quot;HealthSystem&quot;].get_blank_appt_footprint()</span>
<span class="c1">#         the_appt_footprint[&quot;TBFollowUp&quot;] = 1</span>
<span class="c1">#</span>
<span class="c1">#         # Define the necessary information for an HSI</span>
<span class="c1">#         self.TREATMENT_ID = &quot;Tb_MdrTreatmentInitiation&quot;</span>
<span class="c1">#         self.EXPECTED_APPT_FOOTPRINT = the_appt_footprint</span>
<span class="c1">#         self.ACCEPTED_FACILITY_LEVEL = 1</span>
<span class="c1">#         self.ALERT_OTHER_DISEASES = []</span>
<span class="c1">#</span>
<span class="c1">#     def apply(self, person_id, squeeze_factor):</span>
<span class="c1">#         logger.debug(&quot;We are now ready to treat this tb case %d&quot;, person_id)</span>
<span class="c1">#</span>
<span class="c1">#         now = self.sim.date</span>
<span class="c1">#         df = self.sim.population.props</span>
<span class="c1">#         params = self.module.parameters</span>
<span class="c1">#</span>
<span class="c1">#         consumables = self.sim.modules[&quot;HealthSystem&quot;].parameters[&quot;Consumables&quot;]</span>
<span class="c1">#         pkg_code1 = pd.unique(</span>
<span class="c1">#             consumables.loc[</span>
<span class="c1">#                 consumables[&quot;Intervention_Pkg&quot;] == &quot;Case management of MDR cases&quot;,</span>
<span class="c1">#                 &quot;Intervention_Pkg_Code&quot;,</span>
<span class="c1">#             ]</span>
<span class="c1">#         )[0]</span>
<span class="c1">#</span>
<span class="c1">#         the_cons_footprint = {</span>
<span class="c1">#             &quot;Intervention_Package_Code&quot;: [{pkg_code1: 1}],</span>
<span class="c1">#             &quot;Item_Code&quot;: [],</span>
<span class="c1">#         }</span>
<span class="c1">#</span>
<span class="c1">#         is_cons_available = self.sim.modules[&quot;HealthSystem&quot;].request_consumables(</span>
<span class="c1">#             hsi_event=self, cons_req_as_footprint=the_cons_footprint</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         if is_cons_available:</span>
<span class="c1">#</span>
<span class="c1">#             # treatment allocated</span>
<span class="c1">#             if df.at[person_id, &quot;is_alive&quot;] and df.at[person_id, &quot;tb_diagnosed&quot;]:</span>
<span class="c1">#                 df.at[person_id, &quot;tb_treated_mdr&quot;] = True</span>
<span class="c1">#                 df.at[person_id, &quot;tb_date_treated_mdr&quot;] = now</span>
<span class="c1">#</span>
<span class="c1">#             # schedule a 6-month event where people are cured, symptoms return to latent or not cured</span>
<span class="c1">#             self.sim.schedule_event(</span>
<span class="c1">#                 TbCureEvent(self.module, person_id),</span>
<span class="c1">#                 self.sim.date + DateOffset(months=6),</span>
<span class="c1">#             )</span>
<span class="c1">#</span>
<span class="c1">#             # follow-up appts</span>
<span class="c1">#             logger.debug(</span>
<span class="c1">#                 &quot;....This is HSI_Tb_StartMdrTreatment: scheduling follow-up appointments for person %d&quot;,</span>
<span class="c1">#                 person_id,</span>
<span class="c1">#             )</span>
<span class="c1">#</span>
<span class="c1">#             # clinical monitoring</span>
<span class="c1">#             followup_clin = HSI_Tb_FollowUp(self.module, person_id=person_id)</span>
<span class="c1">#</span>
<span class="c1">#             # Request the health system to have this follow-up appointment</span>
<span class="c1">#             weeks = params[&quot;followup_times&quot;][&quot;mdr_clinical&quot;]</span>
<span class="c1">#             cleaned_list = [x for x in weeks if x == x]  # remove nan</span>
<span class="c1">#</span>
<span class="c1">#             for i in range(0, len(cleaned_list)):</span>
<span class="c1">#                 followup_appt_date = self.sim.date + DateOffset(months=cleaned_list[i])</span>
<span class="c1">#                 self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                     followup_clin,</span>
<span class="c1">#                     priority=1,</span>
<span class="c1">#                     topen=followup_appt_date,</span>
<span class="c1">#                     tclose=followup_appt_date + DateOffset(days=3),</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#             # repeat sputum smear tests</span>
<span class="c1">#             followup_smear = HSI_Tb_FollowUp_SputumTest(</span>
<span class="c1">#                 self.module, person_id=person_id</span>
<span class="c1">#             )</span>
<span class="c1">#</span>
<span class="c1">#             # Request the health system to have this follow-up appointment</span>
<span class="c1">#             weeks = params[&quot;followup_times&quot;][&quot;mdr_sputum&quot;]</span>
<span class="c1">#             cleaned_list = [x for x in weeks if x == x]  # remove nan</span>
<span class="c1">#</span>
<span class="c1">#             for i in range(0, len(cleaned_list)):</span>
<span class="c1">#                 followup_appt_date = self.sim.date + DateOffset(months=cleaned_list[i])</span>
<span class="c1">#                 self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                     followup_smear,</span>
<span class="c1">#                     priority=1,</span>
<span class="c1">#                     topen=followup_appt_date,</span>
<span class="c1">#                     tclose=followup_appt_date + DateOffset(days=3),</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#     def did_not_run(self):</span>
<span class="c1">#         pass</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class HSI_Tb_RetreatmentAdult(HSI_Event, IndividualScopeEventMixin):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     This is a Health System Interaction Event - start tb treatment</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self, module, person_id):</span>
<span class="c1">#         super().__init__(module, person_id=person_id)</span>
<span class="c1">#         assert isinstance(module, Tb)</span>
<span class="c1">#</span>
<span class="c1">#         # Get a blank footprint and then edit to define call on resources of this treatment event</span>
<span class="c1">#         the_appt_footprint = self.sim.modules[&quot;HealthSystem&quot;].get_blank_appt_footprint()</span>
<span class="c1">#         the_appt_footprint[&quot;TBNew&quot;] = 1  # This requires one out patient appt</span>
<span class="c1">#</span>
<span class="c1">#         # Define the necessary information for an HSI</span>
<span class="c1">#         self.TREATMENT_ID = &quot;Tb_RetreatmentAdult&quot;</span>
<span class="c1">#         self.EXPECTED_APPT_FOOTPRINT = the_appt_footprint</span>
<span class="c1">#         self.ACCEPTED_FACILITY_LEVEL = 1</span>
<span class="c1">#         self.ALERT_OTHER_DISEASES = []</span>
<span class="c1">#</span>
<span class="c1">#     def apply(self, person_id, squeeze_factor):</span>
<span class="c1">#         logger.debug(&quot;We are now ready to treat this tb case %d&quot;, person_id)</span>
<span class="c1">#</span>
<span class="c1">#         params = self.sim.modules[&quot;Tb&quot;].parameters</span>
<span class="c1">#         now = self.sim.date</span>
<span class="c1">#         df = self.sim.population.props</span>
<span class="c1">#</span>
<span class="c1">#         consumables = self.sim.modules[&quot;HealthSystem&quot;].parameters[&quot;Consumables&quot;]</span>
<span class="c1">#         pkg_code1 = pd.unique(</span>
<span class="c1">#             consumables.loc[</span>
<span class="c1">#                 consumables[&quot;Intervention_Pkg&quot;]</span>
<span class="c1">#                 == &quot;First line treatment for retreatment TB cases for adults&quot;,</span>
<span class="c1">#                 &quot;Intervention_Pkg_Code&quot;,</span>
<span class="c1">#             ]</span>
<span class="c1">#         )[0]</span>
<span class="c1">#</span>
<span class="c1">#         the_cons_footprint = {</span>
<span class="c1">#             &quot;Intervention_Package_Code&quot;: [{pkg_code1: 1}],</span>
<span class="c1">#             &quot;Item_Code&quot;: [],</span>
<span class="c1">#         }</span>
<span class="c1">#</span>
<span class="c1">#         is_cons_available = self.sim.modules[&quot;HealthSystem&quot;].request_consumables(</span>
<span class="c1">#             hsi_event=self, cons_req_as_footprint=the_cons_footprint</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         if is_cons_available:</span>
<span class="c1">#</span>
<span class="c1">#             # treatment allocated</span>
<span class="c1">#             if df.at[person_id, &quot;is_alive&quot;] and df.at[person_id, &quot;tb_diagnosed&quot;]:</span>
<span class="c1">#                 df.at[person_id, &quot;tb_on_treatment&quot;] = True</span>
<span class="c1">#                 df.at[person_id, &quot;tb_date_treated&quot;] = now</span>
<span class="c1">#</span>
<span class="c1">#                 # schedule a 6-month event where people are cured, symptoms return to latent or not cured</span>
<span class="c1">#                 self.sim.schedule_event(</span>
<span class="c1">#                     TbCureEvent(self.module, person_id),</span>
<span class="c1">#                     self.sim.date + DateOffset(months=6),</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#                 # follow-up appts</span>
<span class="c1">#                 logger.debug(</span>
<span class="c1">#                     &quot;....This is HSI_Tb_RetreatmentAdult: scheduling follow-up appointments for person %d&quot;,</span>
<span class="c1">#                     person_id,</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#                 # clinical monitoring</span>
<span class="c1">#                 followup_clin = HSI_Tb_FollowUp(self.module, person_id=person_id)</span>
<span class="c1">#</span>
<span class="c1">#                 # Request the health system to have this follow-up appointment</span>
<span class="c1">#                 weeks = params[&quot;followup_times&quot;][&quot;retreatment_clinical&quot;]</span>
<span class="c1">#                 cleaned_list = [x for x in weeks if x == x]  # remove nan</span>
<span class="c1">#</span>
<span class="c1">#                 for i in range(0, len(cleaned_list)):</span>
<span class="c1">#                     followup_appt_date = self.sim.date + DateOffset(</span>
<span class="c1">#                         months=cleaned_list[i]</span>
<span class="c1">#                     )</span>
<span class="c1">#                     self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                         followup_clin,</span>
<span class="c1">#                         priority=1,</span>
<span class="c1">#                         topen=followup_appt_date,</span>
<span class="c1">#                         tclose=followup_appt_date + DateOffset(days=3),</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#                 # repeat sputum smear tests</span>
<span class="c1">#                 followup_smear = HSI_Tb_FollowUp_SputumTest(</span>
<span class="c1">#                     self.module, person_id=person_id</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#                 # Request the health system to have this follow-up appointment</span>
<span class="c1">#                 weeks = params[&quot;followup_times&quot;][&quot;retreatment_sputum&quot;]</span>
<span class="c1">#                 cleaned_list = [x for x in weeks if x == x]  # remove nan</span>
<span class="c1">#</span>
<span class="c1">#                 for i in range(0, len(cleaned_list)):</span>
<span class="c1">#                     followup_appt_date = self.sim.date + DateOffset(</span>
<span class="c1">#                         months=cleaned_list[i]</span>
<span class="c1">#                     )</span>
<span class="c1">#                     self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                         followup_smear,</span>
<span class="c1">#                         priority=1,</span>
<span class="c1">#                         topen=followup_appt_date,</span>
<span class="c1">#                         tclose=followup_appt_date + DateOffset(days=3),</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#     def did_not_run(self):</span>
<span class="c1">#         pass</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class HSI_Tb_RetreatmentChild(HSI_Event, IndividualScopeEventMixin):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     This is a Health System Interaction Event - start tb treatment</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self, module, person_id):</span>
<span class="c1">#         super().__init__(module, person_id=person_id)</span>
<span class="c1">#         assert isinstance(module, Tb)</span>
<span class="c1">#</span>
<span class="c1">#         # Get a blank footprint and then edit to define call on resources of this treatment event</span>
<span class="c1">#         the_appt_footprint = self.sim.modules[&quot;HealthSystem&quot;].get_blank_appt_footprint()</span>
<span class="c1">#         the_appt_footprint[&quot;TBNew&quot;] = 1  # New tb treatment initiation appt</span>
<span class="c1">#</span>
<span class="c1">#         # Define the necessary information for an HSI</span>
<span class="c1">#         self.TREATMENT_ID = &quot;Tb_RetreatmentChild&quot;</span>
<span class="c1">#         self.EXPECTED_APPT_FOOTPRINT = the_appt_footprint</span>
<span class="c1">#         self.ACCEPTED_FACILITY_LEVEL = 1</span>
<span class="c1">#         self.ALERT_OTHER_DISEASES = []</span>
<span class="c1">#</span>
<span class="c1">#     def apply(self, person_id, squeeze_factor):</span>
<span class="c1">#         logger.debug(&quot;We are now ready to treat this tb case %d&quot;, person_id)</span>
<span class="c1">#</span>
<span class="c1">#         params = self.sim.modules[&quot;Tb&quot;].parameters</span>
<span class="c1">#         now = self.sim.date</span>
<span class="c1">#         df = self.sim.population.props</span>
<span class="c1">#</span>
<span class="c1">#         consumables = self.sim.modules[&quot;HealthSystem&quot;].parameters[&quot;Consumables&quot;]</span>
<span class="c1">#         pkg_code1 = pd.unique(</span>
<span class="c1">#             consumables.loc[</span>
<span class="c1">#                 consumables[&quot;Intervention_Pkg&quot;]</span>
<span class="c1">#                 == &quot;First line treatment for retreatment TB cases for children&quot;,</span>
<span class="c1">#                 &quot;Intervention_Pkg_Code&quot;,</span>
<span class="c1">#             ]</span>
<span class="c1">#         )[0]</span>
<span class="c1">#</span>
<span class="c1">#         the_cons_footprint = {</span>
<span class="c1">#             &quot;Intervention_Package_Code&quot;: [{pkg_code1: 1}],</span>
<span class="c1">#             &quot;Item_Code&quot;: [],</span>
<span class="c1">#         }</span>
<span class="c1">#</span>
<span class="c1">#         is_cons_available = self.sim.modules[&quot;HealthSystem&quot;].request_consumables(</span>
<span class="c1">#             hsi_event=self, cons_req_as_footprint=the_cons_footprint</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         if is_cons_available:</span>
<span class="c1">#</span>
<span class="c1">#             # treatment allocated</span>
<span class="c1">#             if df.at[person_id, &quot;is_alive&quot;] and df.at[person_id, &quot;tb_diagnosed&quot;]:</span>
<span class="c1">#                 df.at[person_id, &quot;tb_on_treatment&quot;] = True</span>
<span class="c1">#                 df.at[person_id, &quot;tb_date_treated&quot;] = now</span>
<span class="c1">#</span>
<span class="c1">#                 # schedule a 6-month event where people are cured, symptoms return to latent or not cured</span>
<span class="c1">#                 self.sim.schedule_event(</span>
<span class="c1">#                     TbCureEvent(self.module, person_id),</span>
<span class="c1">#                     self.sim.date + DateOffset(months=6),</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#                 # follow-up appts</span>
<span class="c1">#                 logger.debug(</span>
<span class="c1">#                     &quot;....This is HSI_Tb_RetreatmentChild: scheduling follow-up appointments for person %d&quot;,</span>
<span class="c1">#                     person_id,</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#                 # clinical monitoring</span>
<span class="c1">#                 followup_clin = HSI_Tb_FollowUp(self.module, person_id=person_id)</span>
<span class="c1">#</span>
<span class="c1">#                 # Request the health system to have this follow-up appointment</span>
<span class="c1">#                 weeks = params[&quot;followup_times&quot;][&quot;retreatment_clinical&quot;]</span>
<span class="c1">#                 cleaned_list = [x for x in weeks if x == x]  # remove nan</span>
<span class="c1">#</span>
<span class="c1">#                 for i in range(0, len(cleaned_list)):</span>
<span class="c1">#                     followup_appt_date = self.sim.date + DateOffset(</span>
<span class="c1">#                         months=cleaned_list[i]</span>
<span class="c1">#                     )</span>
<span class="c1">#                     self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                         followup_clin,</span>
<span class="c1">#                         priority=1,</span>
<span class="c1">#                         topen=followup_appt_date,</span>
<span class="c1">#                         tclose=followup_appt_date + DateOffset(days=3),</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#                 # repeat sputum smear tests</span>
<span class="c1">#                 followup_smear = HSI_Tb_FollowUp_SputumTest(</span>
<span class="c1">#                     self.module, person_id=person_id</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#                 # Request the health system to have this follow-up appointment</span>
<span class="c1">#                 weeks = params[&quot;followup_times&quot;][&quot;retreatment_sputum&quot;]</span>
<span class="c1">#                 cleaned_list = [x for x in weeks if x == x]  # remove nan</span>
<span class="c1">#</span>
<span class="c1">#                 for i in range(0, len(cleaned_list)):</span>
<span class="c1">#                     followup_appt_date = self.sim.date + DateOffset(</span>
<span class="c1">#                         months=cleaned_list[i]</span>
<span class="c1">#                     )</span>
<span class="c1">#                     self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                         followup_smear,</span>
<span class="c1">#                         priority=1,</span>
<span class="c1">#                         topen=followup_appt_date,</span>
<span class="c1">#                         tclose=followup_appt_date + DateOffset(days=3),</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#     def did_not_run(self):</span>
<span class="c1">#         pass</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># # ---------------------------------------------------------------------------</span>
<span class="c1"># #   Follow-up appts</span>
<span class="c1"># # ---------------------------------------------------------------------------</span>
<span class="c1"># class HSI_Tb_FollowUp(HSI_Event, IndividualScopeEventMixin):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     This is a Health System Interaction Event - start tb treatment</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self, module, person_id):</span>
<span class="c1">#         super().__init__(module, person_id=person_id)</span>
<span class="c1">#         assert isinstance(module, Tb)</span>
<span class="c1">#</span>
<span class="c1">#         # Get a blank footprint and then edit to define call on resources of this treatment event</span>
<span class="c1">#         the_appt_footprint = self.sim.modules[&quot;HealthSystem&quot;].get_blank_appt_footprint()</span>
<span class="c1">#         the_appt_footprint[&quot;TBFollowUp&quot;] = 1</span>
<span class="c1">#</span>
<span class="c1">#         # Define the necessary information for an HSI</span>
<span class="c1">#         self.TREATMENT_ID = &quot;Tb_FollowUp&quot;</span>
<span class="c1">#         self.EXPECTED_APPT_FOOTPRINT = the_appt_footprint</span>
<span class="c1">#         self.ACCEPTED_FACILITY_LEVEL = 1</span>
<span class="c1">#         self.ALERT_OTHER_DISEASES = []</span>
<span class="c1">#</span>
<span class="c1">#     def apply(self, person_id, squeeze_factor):</span>
<span class="c1">#         # nothing needs to happen here, just log the appt</span>
<span class="c1">#         logger.debug(&quot;Follow up appt for tb case %d&quot;, person_id)</span>
<span class="c1">#</span>
<span class="c1">#     def did_not_run(self):</span>
<span class="c1">#         pass</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class HSI_Tb_FollowUp_SputumTest(HSI_Event, IndividualScopeEventMixin):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     This is a follow-up sputum test for confirmed tb cases</span>
<span class="c1">#     doesn&#39;t change any properties except for date latest sputum test</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self, module, person_id):</span>
<span class="c1">#         super().__init__(module, person_id=person_id)</span>
<span class="c1">#         assert isinstance(module, Tb)</span>
<span class="c1">#</span>
<span class="c1">#         # Get a blank footprint and then edit to define call on resources of this event</span>
<span class="c1">#         the_appt_footprint = self.sim.modules[&quot;HealthSystem&quot;].get_blank_appt_footprint()</span>
<span class="c1">#         the_appt_footprint[</span>
<span class="c1">#             &quot;ConWithDCSA&quot;</span>
<span class="c1">#         ] = 1  # This requires one generic outpatient appt</span>
<span class="c1">#         the_appt_footprint[</span>
<span class="c1">#             &quot;LabTBMicro&quot;</span>
<span class="c1">#         ] = 1  # This requires one lab appt for microscopy</span>
<span class="c1">#</span>
<span class="c1">#         # Define the necessary information for an HSI</span>
<span class="c1">#         self.TREATMENT_ID = &quot;Tb_FollowUpSputumTest&quot;</span>
<span class="c1">#         self.EXPECTED_APPT_FOOTPRINT = the_appt_footprint</span>
<span class="c1">#         self.ACCEPTED_FACILITY_LEVEL = 1</span>
<span class="c1">#         self.ALERT_OTHER_DISEASES = []</span>
<span class="c1">#</span>
<span class="c1">#     def apply(self, person_id, squeeze_factor):</span>
<span class="c1">#         logger.debug(</span>
<span class="c1">#             &quot;This is HSI_Tb_FollowUp_SputumTest, a follow-up sputum smear test for person %d&quot;,</span>
<span class="c1">#             person_id,</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         df = self.sim.population.props</span>
<span class="c1">#         now = self.sim.date</span>
<span class="c1">#</span>
<span class="c1">#         # Get the consumables required</span>
<span class="c1">#         consumables = self.sim.modules[&quot;HealthSystem&quot;].parameters[&quot;Consumables&quot;]</span>
<span class="c1">#         pkg_code1 = pd.unique(</span>
<span class="c1">#             consumables.loc[</span>
<span class="c1">#                 consumables[&quot;Intervention_Pkg&quot;] == &quot;Microscopy Test&quot;,</span>
<span class="c1">#                 &quot;Intervention_Pkg_Code&quot;,</span>
<span class="c1">#             ]</span>
<span class="c1">#         )[0]</span>
<span class="c1">#</span>
<span class="c1">#         the_cons_footprint = {</span>
<span class="c1">#             &quot;Intervention_Package_Code&quot;: [{pkg_code1: 1}],</span>
<span class="c1">#             &quot;Item_Code&quot;: [],</span>
<span class="c1">#         }</span>
<span class="c1">#</span>
<span class="c1">#         is_cons_available = self.sim.modules[&quot;HealthSystem&quot;].request_consumables(</span>
<span class="c1">#             hsi_event=self, cons_req_as_footprint=the_cons_footprint</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         if is_cons_available:</span>
<span class="c1">#             df.at[person_id, &quot;tb_ever_tested&quot;] = True</span>
<span class="c1">#             df.at[person_id, &quot;tb_smear_test&quot;] = True</span>
<span class="c1">#             df.at[person_id, &quot;tb_date_smear_test&quot;] = now</span>
<span class="c1">#</span>
<span class="c1">#     def did_not_run(self):</span>
<span class="c1">#         pass</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># # ---------------------------------------------------------------------------</span>
<span class="c1"># #   Cure</span>
<span class="c1"># # ---------------------------------------------------------------------------</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class TbCureEvent(Event, IndividualScopeEventMixin):</span>
<span class="c1">#     def __init__(self, module, person_id):</span>
<span class="c1">#         super().__init__(module, person_id=person_id)</span>
<span class="c1">#</span>
<span class="c1">#     def apply(self, person_id):</span>
<span class="c1">#         logger.debug(&quot;Stopping tb treatment and curing person %d&quot;, person_id)</span>
<span class="c1">#</span>
<span class="c1">#         df = self.sim.population.props</span>
<span class="c1">#         params = self.sim.modules[&quot;Tb&quot;].parameters</span>
<span class="c1">#</span>
<span class="c1">#         if df.at[person_id, &quot;is_alive&quot;]:</span>
<span class="c1">#</span>
<span class="c1">#             # after six months of treatment, stop</span>
<span class="c1">#             df.at[person_id, &quot;tb_on_treatment&quot;] = False</span>
<span class="c1">#             cured = False</span>
<span class="c1">#</span>
<span class="c1">#             # ADULTS: if drug-susceptible and pulmonary tb:</span>
<span class="c1">#             # prob of tx success</span>
<span class="c1">#             if df.at[person_id, &quot;tb_inf&quot;].startswith(&quot;active_susc&quot;) and (</span>
<span class="c1">#                 df.at[person_id, &quot;age_exact_years&quot;] &gt;= 15</span>
<span class="c1">#             ):</span>
<span class="c1">#</span>
<span class="c1">#                 # new case</span>
<span class="c1">#                 if (</span>
<span class="c1">#                     df.at[person_id, &quot;tb_inf&quot;] == &quot;active_susc_new&quot;</span>
<span class="c1">#                     and not df.at[person_id, &quot;hv_inf&quot;]</span>
<span class="c1">#                 ):</span>
<span class="c1">#                     cured = (</span>
<span class="c1">#                         self.module.rng.random_sample(size=1)</span>
<span class="c1">#                         &lt; params[&quot;prob_tx_success_new&quot;]</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#                 # previously treated case</span>
<span class="c1">#                 elif (</span>
<span class="c1">#                     df.at[person_id, &quot;tb_inf&quot;] == &quot;active_susc_prev&quot;</span>
<span class="c1">#                     and not df.at[person_id, &quot;hv_inf&quot;]</span>
<span class="c1">#                 ):</span>
<span class="c1">#                     cured = (</span>
<span class="c1">#                         self.module.rng.random_sample(size=1)</span>
<span class="c1">#                         &lt; params[&quot;prob_tx_success_prev&quot;]</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#                 # hiv+</span>
<span class="c1">#                 elif df.at[person_id, &quot;hv_inf&quot;]:</span>
<span class="c1">#                     cured = (</span>
<span class="c1">#                         self.module.rng.random_sample(size=1)</span>
<span class="c1">#                         &lt; params[&quot;prob_tx_success_hiv&quot;]</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#             # if under 5 years old</span>
<span class="c1">#             if df.at[person_id, &quot;tb_inf&quot;].startswith(&quot;active_susc&quot;) and (</span>
<span class="c1">#                 df.at[person_id, &quot;age_exact_years&quot;] &lt; 4</span>
<span class="c1">#             ):</span>
<span class="c1">#                 cured = (</span>
<span class="c1">#                     self.module.rng.random_sample(size=1)</span>
<span class="c1">#                     &lt; params[&quot;prob_tx_success_0_4&quot;]</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#             # if between 5-14 years old</span>
<span class="c1">#             if (</span>
<span class="c1">#                 df.at[person_id, &quot;tb_inf&quot;].startswith(&quot;active_susc&quot;)</span>
<span class="c1">#                 and (df.at[person_id, &quot;age_exact_years&quot;] &gt; 4)</span>
<span class="c1">#                 and (df.at[person_id, &quot;age_exact_years&quot;] &lt; 15)</span>
<span class="c1">#             ):</span>
<span class="c1">#                 cured = (</span>
<span class="c1">#                     self.module.rng.random_sample(size=1)</span>
<span class="c1">#                     &lt; params[&quot;prob_tx_success_5_14&quot;]</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#             # if cured change properties</span>
<span class="c1">#             if cured:</span>
<span class="c1">#                 df.at[person_id, &quot;tb_inf&quot;] = &quot;latent_susc_tx&quot;</span>
<span class="c1">#                 df.at[person_id, &quot;tb_diagnosed&quot;] = False</span>
<span class="c1">#                 df.at[person_id, &quot;tb_stage&quot;] = &quot;latent&quot;</span>
<span class="c1">#                 df.at[person_id, &quot;tb_treatment_failure&quot;] = False</span>
<span class="c1">#                 df.at[person_id, &quot;tb_symptoms&quot;] = False</span>
<span class="c1">#                 df.at[person_id, &quot;tb_smear&quot;] = False</span>
<span class="c1">#                 df.at[person_id, &quot;tb_diagnosed&quot;] = False</span>
<span class="c1">#</span>
<span class="c1">#                 # check that tb symptoms are present and caused by tb before resolving</span>
<span class="c1">#                 if (</span>
<span class="c1">#                     &quot;respiratory_symptoms&quot;</span>
<span class="c1">#                     in self.sim.modules[&quot;SymptomManager&quot;].has_what(person_id)</span>
<span class="c1">#                 ) &amp; (</span>
<span class="c1">#                     &quot;Tb&quot;</span>
<span class="c1">#                     in self.sim.modules[&quot;SymptomManager&quot;].causes_of(</span>
<span class="c1">#                         person_id, &quot;respiratory_symptoms&quot;</span>
<span class="c1">#                     )</span>
<span class="c1">#                 ):</span>
<span class="c1">#                     # this will clear all tb symptoms</span>
<span class="c1">#                     self.sim.modules[&quot;SymptomManager&quot;].clear_symptoms(</span>
<span class="c1">#                         person_id=person_id, disease_module=self.module</span>
<span class="c1">#                     )</span>
<span class="c1">#</span>
<span class="c1">#             else:</span>
<span class="c1">#                 df.at[person_id, &quot;tb_treatment_failure&quot;] = True</span>
<span class="c1">#                 # request a repeat / Xpert test - follow-up</span>
<span class="c1">#                 # this will include drug-susceptible treatment failures and mdr-tb cases</span>
<span class="c1">#                 secondary_test = HSI_Tb_XpertTest(self.module, person_id=person_id)</span>
<span class="c1">#</span>
<span class="c1">#                 # Request the health system to give xpert test</span>
<span class="c1">#                 self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                     secondary_test, priority=1, topen=self.sim.date, tclose=None</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#                 # add back-up check if xpert is not available, then schedule sputum smear</span>
<span class="c1">#                 self.sim.schedule_event(</span>
<span class="c1">#                     TbCheckXpert(self.module, person_id),</span>
<span class="c1">#                     self.sim.date + DateOffset(weeks=2),</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class TbCureMdrEvent(Event, IndividualScopeEventMixin):</span>
<span class="c1">#     def __init__(self, module, person_id):</span>
<span class="c1">#         super().__init__(module, person_id=person_id)</span>
<span class="c1">#</span>
<span class="c1">#     def apply(self, person_id):</span>
<span class="c1">#         logger.debug(&quot;Stopping tb-mdr treatment and curing person %d&quot;, person_id)</span>
<span class="c1">#</span>
<span class="c1">#         df = self.sim.population.props</span>
<span class="c1">#         params = self.sim.modules[&quot;Tb&quot;].parameters</span>
<span class="c1">#</span>
<span class="c1">#         df.at[person_id, &quot;tb_treated_mdr&quot;] = False</span>
<span class="c1">#</span>
<span class="c1">#         cured = self.module.rng.random_sample(size=1) &lt; params[&quot;prob_tx_success_mdr&quot;]</span>
<span class="c1">#</span>
<span class="c1">#         if cured:</span>
<span class="c1">#             df.at[person_id, &quot;tb_inf&quot;] = &quot;latent_mdr_tx&quot;</span>
<span class="c1">#             df.at[person_id, &quot;tb_diagnosed&quot;] = False</span>
<span class="c1">#             df.at[person_id, &quot;tb_stage&quot;] = &quot;latent&quot;</span>
<span class="c1">#             df.at[person_id, &quot;tb_treatment_failure&quot;] = False</span>
<span class="c1">#             df.at[person_id, &quot;tb_symptoms&quot;] = False</span>
<span class="c1">#             df.at[person_id, &quot;tb_smear&quot;] = False</span>
<span class="c1">#             df.at[person_id, &quot;tb_diagnosed&quot;] = False</span>
<span class="c1">#</span>
<span class="c1">#             # check that tb symptoms are present and caused by tb before resolving</span>
<span class="c1">#             if (</span>
<span class="c1">#                 &quot;respiratory_symptoms&quot;</span>
<span class="c1">#                 in self.sim.modules[&quot;SymptomManager&quot;].has_what(person_id)</span>
<span class="c1">#             ) &amp; (</span>
<span class="c1">#                 &quot;Tb&quot;</span>
<span class="c1">#                 in self.sim.modules[&quot;SymptomManager&quot;].causes_of(</span>
<span class="c1">#                     person_id, &quot;respiratory_symptoms&quot;</span>
<span class="c1">#                 )</span>
<span class="c1">#             ):</span>
<span class="c1">#                 # this will clear all tb symptoms</span>
<span class="c1">#                 self.sim.modules[&quot;SymptomManager&quot;].clear_symptoms(</span>
<span class="c1">#                     person_id=person_id, disease_module=self.module</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#         else:</span>
<span class="c1">#             df.at[person_id, &quot;tb_treatment_failure&quot;] = True</span>
<span class="c1">#</span>
<span class="c1">#             # request a repeat / Xpert test - follow-up</span>
<span class="c1">#             secondary_test = HSI_Tb_XpertTest(self.module, person_id=person_id)</span>
<span class="c1">#</span>
<span class="c1">#             # Request the health system to give xpert test</span>
<span class="c1">#             self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                 secondary_test, priority=1, topen=self.sim.date, tclose=None</span>
<span class="c1">#             )</span>
<span class="c1">#</span>
<span class="c1">#             # add back-up check if xpert is not available, then schedule sputum smear</span>
<span class="c1">#             self.sim.schedule_event(</span>
<span class="c1">#                 TbCheckXpert(self.module, person_id),</span>
<span class="c1">#                 self.sim.date + DateOffset(weeks=2),</span>
<span class="c1">#             )</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># #</span>
<span class="c1"># # ---------------------------------------------------------------------------</span>
<span class="c1"># #   IPT</span>
<span class="c1"># # ---------------------------------------------------------------------------</span>
<span class="c1"># class HSI_Tb_Ipt(HSI_Event, IndividualScopeEventMixin):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#         This is a Health System Interaction Event - give ipt to contacts of tb cases for 6 months</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self, module, person_id):</span>
<span class="c1">#         super().__init__(module, person_id=person_id)</span>
<span class="c1">#         assert isinstance(module, Tb)</span>
<span class="c1">#</span>
<span class="c1">#         # Get a blank footprint and then edit to define call on resources of this treatment event</span>
<span class="c1">#         the_appt_footprint = self.sim.modules[&quot;HealthSystem&quot;].get_blank_appt_footprint()</span>
<span class="c1">#         the_appt_footprint[&quot;Over5OPD&quot;] = 1  # This requires one out patient appt</span>
<span class="c1">#</span>
<span class="c1">#         # Define the necessary information for an HSI</span>
<span class="c1">#         self.TREATMENT_ID = &quot;Tb_Ipt&quot;</span>
<span class="c1">#         self.EXPECTED_APPT_FOOTPRINT = the_appt_footprint</span>
<span class="c1">#         self.ACCEPTED_FACILITY_LEVEL = 1</span>
<span class="c1">#         self.ALERT_OTHER_DISEASES = []</span>
<span class="c1">#</span>
<span class="c1">#     def apply(self, person_id, squeeze_factor):</span>
<span class="c1">#         logger.debug(&quot;Starting IPT for person %d&quot;, person_id)</span>
<span class="c1">#</span>
<span class="c1">#         df = self.sim.population.props</span>
<span class="c1">#</span>
<span class="c1">#         consumables = self.sim.modules[&quot;HealthSystem&quot;].parameters[&quot;Consumables&quot;]</span>
<span class="c1">#         pkg_code1 = pd.unique(</span>
<span class="c1">#             consumables.loc[</span>
<span class="c1">#                 consumables[&quot;Items&quot;] == &quot;Isoniazid Preventive Therapy&quot;,</span>
<span class="c1">#                 &quot;Intervention_Pkg_Code&quot;,</span>
<span class="c1">#             ]</span>
<span class="c1">#         )[0]</span>
<span class="c1">#</span>
<span class="c1">#         the_cons_footprint = {</span>
<span class="c1">#             &quot;Intervention_Package_Code&quot;: [{pkg_code1: 1}],</span>
<span class="c1">#             &quot;Item_Code&quot;: [],</span>
<span class="c1">#         }</span>
<span class="c1">#</span>
<span class="c1">#         is_cons_available = self.sim.modules[&quot;HealthSystem&quot;].request_consumables(</span>
<span class="c1">#             hsi_event=self, cons_req_as_footprint=the_cons_footprint</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         if is_cons_available:</span>
<span class="c1">#             df.at[person_id, &quot;tb_on_ipt&quot;] = True</span>
<span class="c1">#             df.at[person_id, &quot;tb_date_ipt&quot;] = self.sim.date</span>
<span class="c1">#</span>
<span class="c1">#             # schedule end date of ipt after six months</span>
<span class="c1">#             self.sim.schedule_event(</span>
<span class="c1">#                 TbIptEndEvent(self.module, person_id),</span>
<span class="c1">#                 self.sim.date + DateOffset(months=6),</span>
<span class="c1">#             )</span>
<span class="c1">#</span>
<span class="c1">#     def did_not_run(self):</span>
<span class="c1">#         pass</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class HSI_Tb_IptHiv(HSI_Event, IndividualScopeEventMixin):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#         This is a Health System Interaction Event - give ipt to hiv+ persons</span>
<span class="c1">#         called by hiv module when starting ART (adults and children)</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self, module, person_id):</span>
<span class="c1">#         super().__init__(module, person_id=person_id)</span>
<span class="c1">#         # assert isinstance(module, Tb)</span>
<span class="c1">#</span>
<span class="c1">#         # Get a blank footprint and then edit to define call on resources of this treatment event</span>
<span class="c1">#         the_appt_footprint = self.sim.modules[&quot;HealthSystem&quot;].get_blank_appt_footprint()</span>
<span class="c1">#         the_appt_footprint[&quot;Over5OPD&quot;] = 1  # This requires one out patient appt</span>
<span class="c1">#</span>
<span class="c1">#         # Define the necessary information for an HSI</span>
<span class="c1">#         self.TREATMENT_ID = &quot;Tb_IptHiv&quot;</span>
<span class="c1">#         self.EXPECTED_APPT_FOOTPRINT = the_appt_footprint</span>
<span class="c1">#         self.ACCEPTED_FACILITY_LEVEL = 1</span>
<span class="c1">#         self.ALERT_OTHER_DISEASES = []</span>
<span class="c1">#</span>
<span class="c1">#     def apply(self, person_id, squeeze_factor):</span>
<span class="c1">#</span>
<span class="c1">#         df = self.sim.population.props</span>
<span class="c1">#</span>
<span class="c1">#         consumables = self.sim.modules[&quot;HealthSystem&quot;].parameters[&quot;Consumables&quot;]</span>
<span class="c1">#         pkg_code1 = pd.unique(</span>
<span class="c1">#             consumables.loc[</span>
<span class="c1">#                 consumables[&quot;Intervention_Pkg&quot;]</span>
<span class="c1">#                 == &quot;Isoniazid preventative therapy for HIV+ no TB&quot;,</span>
<span class="c1">#                 &quot;Intervention_Pkg_Code&quot;,</span>
<span class="c1">#             ]</span>
<span class="c1">#         )[0]</span>
<span class="c1">#</span>
<span class="c1">#         the_cons_footprint = {</span>
<span class="c1">#             &quot;Intervention_Package_Code&quot;: [{pkg_code1: 1}],</span>
<span class="c1">#             &quot;Item_Code&quot;: [],</span>
<span class="c1">#         }</span>
<span class="c1">#</span>
<span class="c1">#         is_cons_available = self.sim.modules[&quot;HealthSystem&quot;].request_consumables(</span>
<span class="c1">#             hsi_event=self, cons_req_as_footprint=the_cons_footprint</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         if is_cons_available:</span>
<span class="c1">#</span>
<span class="c1">#             # only if not currently tb_active</span>
<span class="c1">#             if not df.at[person_id, &quot;tb_inf&quot;].startswith(&quot;active&quot;):</span>
<span class="c1">#</span>
<span class="c1">#                 logger.debug(</span>
<span class="c1">#                     &quot;HSI_Tb_IptHiv: starting IPT for HIV+ person %d&quot;, person_id</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#                 df.at[person_id, &quot;tb_on_ipt&quot;] = True</span>
<span class="c1">#                 df.at[person_id, &quot;tb_date_ipt&quot;] = self.sim.date</span>
<span class="c1">#</span>
<span class="c1">#                 # schedule end date of ipt after six months and repeat call</span>
<span class="c1">#                 self.sim.schedule_event(</span>
<span class="c1">#                     TbIptEndEvent(self.module, person_id),</span>
<span class="c1">#                     self.sim.date + DateOffset(months=6),</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#             else:</span>
<span class="c1">#                 logger.debug(</span>
<span class="c1">#                     &quot;HSI_Tb_IptHiv: person %d has active TB and can&#39;t start IPT&quot;,</span>
<span class="c1">#                     person_id,</span>
<span class="c1">#                 )</span>
<span class="c1">#</span>
<span class="c1">#     def did_not_run(self):</span>
<span class="c1">#         pass</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class TbIptEndEvent(Event, IndividualScopeEventMixin):</span>
<span class="c1">#     def __init__(self, module, person_id):</span>
<span class="c1">#         super().__init__(module, person_id=person_id)</span>
<span class="c1">#</span>
<span class="c1">#     def apply(self, person_id):</span>
<span class="c1">#         logger.debug(&quot;Stopping ipt for person %d&quot;, person_id)</span>
<span class="c1">#</span>
<span class="c1">#         df = self.sim.population.props</span>
<span class="c1">#</span>
<span class="c1">#         df.at[person_id, &quot;tb_on_ipt&quot;] = False</span>
<span class="c1">#</span>
<span class="c1">#         # if hiv+ reschedule HSI_Tb_IptHiv to continue IPT</span>
<span class="c1">#         if df.at[person_id, &quot;hv_inf&quot;]:</span>
<span class="c1">#             logger.debug(</span>
<span class="c1">#                 &quot;TbIptEndEvent: scheduling further IPT for person %d on date %s&quot;,</span>
<span class="c1">#                 person_id,</span>
<span class="c1">#                 self.sim.date,</span>
<span class="c1">#             )</span>
<span class="c1">#</span>
<span class="c1">#             ipt_start = HSI_Tb_IptHiv(self.module, person_id=person_id)</span>
<span class="c1">#</span>
<span class="c1">#             # Request the health system to have this follow-up appointment</span>
<span class="c1">#             self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="c1">#                 ipt_start, priority=1, topen=self.sim.date, tclose=None</span>
<span class="c1">#             )</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># # ---------------------------------------------------------------------------</span>
<span class="c1"># #   Deaths</span>
<span class="c1"># # ---------------------------------------------------------------------------</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class TbDeathEvent(RegularEvent, PopulationScopeEventMixin):</span>
<span class="c1">#     &quot;&quot;&quot;The regular event that kills people with active drug-susceptible tb</span>
<span class="c1">#     HIV-positive deaths due to TB counted as HIV deaths</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self, module):</span>
<span class="c1">#         super().__init__(module, frequency=DateOffset(months=1))</span>
<span class="c1">#</span>
<span class="c1">#     def apply(self, population):</span>
<span class="c1">#         params = self.module.parameters</span>
<span class="c1">#         df = population.props</span>
<span class="c1">#         now = self.sim.date</span>
<span class="c1">#         rng = self.module.rng</span>
<span class="c1">#</span>
<span class="c1">#         # ---------------------------------- TB DEATHS - HIV-NEGATIVE ------------------------------------</span>
<span class="c1">#         # only active infections result in death</span>
<span class="c1">#         mortality_rate = pd.Series(0, index=df.index)</span>
<span class="c1">#</span>
<span class="c1">#         # hiv-negative, tb untreated</span>
<span class="c1">#         mortality_rate.loc[</span>
<span class="c1">#             df[&quot;tb_inf&quot;].str.contains(&quot;active_susc&quot;)</span>
<span class="c1">#             &amp; ~df.hv_inf</span>
<span class="c1">#             &amp; (~df.tb_on_treatment | ~df.tb_treated_mdr)</span>
<span class="c1">#             &amp; ~df.hv_on_cotrim</span>
<span class="c1">#         ] = params[&quot;monthly_prob_tb_mortality&quot;]</span>
<span class="c1">#</span>
<span class="c1">#         # hiv-negative on cotrim - shouldn&#39;t be any, tb untreated</span>
<span class="c1">#         mortality_rate.loc[</span>
<span class="c1">#             df[&quot;tb_inf&quot;].str.contains(&quot;active_susc&quot;)</span>
<span class="c1">#             &amp; ~df.hv_inf</span>
<span class="c1">#             &amp; (~df.tb_on_treatment | ~df.tb_treated_mdr)</span>
<span class="c1">#             &amp; df.hv_on_cotrim</span>
<span class="c1">#         ] = (params[&quot;monthly_prob_tb_mortality&quot;] * params[&quot;mort_cotrim&quot;])</span>
<span class="c1">#</span>
<span class="c1">#         # hiv-negative, tb treated</span>
<span class="c1">#         mortality_rate.loc[</span>
<span class="c1">#             df[&quot;tb_inf&quot;].str.contains(&quot;active_susc&quot;)</span>
<span class="c1">#             &amp; ~df.hv_inf</span>
<span class="c1">#             &amp; (df.tb_on_treatment | df.tb_treated_mdr)</span>
<span class="c1">#             &amp; ~df.hv_on_cotrim</span>
<span class="c1">#         ] = params[&quot;monthly_prob_tb_mortality&quot;]</span>
<span class="c1">#</span>
<span class="c1">#         # Generate a series of random numbers, one per individual</span>
<span class="c1">#         probs = rng.rand(len(df))</span>
<span class="c1">#         deaths = df.is_alive &amp; (probs &lt; mortality_rate)</span>
<span class="c1">#         # print(&#39;deaths: &#39;, deaths)</span>
<span class="c1">#         will_die = (df[deaths]).index</span>
<span class="c1">#         # print(&#39;will_die: &#39;, will_die)</span>
<span class="c1">#</span>
<span class="c1">#         for person in will_die:</span>
<span class="c1">#             if df.at[person, &quot;is_alive&quot;]:</span>
<span class="c1">#                 df.at[person, &quot;tb_date_death_occurred&quot;] = self.sim.date</span>
<span class="c1">#</span>
<span class="c1">#                 self.sim.schedule_event(</span>
<span class="c1">#                     demography.InstantaneousDeath(</span>
<span class="c1">#                         self.module, individual_id=person, cause=&quot;tb&quot;</span>
<span class="c1">#                     ),</span>
<span class="c1">#                     now,</span>
<span class="c1">#                 )</span>
<span class="c1">#                 df.at[person, &quot;tb_date_death&quot;] = now</span>
<span class="c1">#</span>
<span class="c1">#         # ---------------------------------- HIV-TB DEATHS ------------------------------------</span>
<span class="c1">#         # only active infections result in death, no deaths on treatment</span>
<span class="c1">#         mort_hiv = pd.Series(0, index=df.index)</span>
<span class="c1">#</span>
<span class="c1">#         # hiv-positive, untreated</span>
<span class="c1">#         mort_hiv.loc[</span>
<span class="c1">#             df[&quot;tb_inf&quot;].str.contains(&quot;active_susc&quot;)</span>
<span class="c1">#             &amp; df.hv_inf</span>
<span class="c1">#             &amp; (~df.tb_on_treatment | ~df.tb_treated_mdr)</span>
<span class="c1">#             &amp; (df.hv_on_art != 2)</span>
<span class="c1">#             &amp; ~df.hv_on_cotrim</span>
<span class="c1">#         ] = params[&quot;monthly_prob_tb_mortality_hiv&quot;]</span>
<span class="c1">#</span>
<span class="c1">#         # hiv-positive, on ART</span>
<span class="c1">#         mort_hiv.loc[</span>
<span class="c1">#             df[&quot;tb_inf&quot;].str.contains(&quot;active_susc&quot;)</span>
<span class="c1">#             &amp; df.hv_inf</span>
<span class="c1">#             &amp; (~df.tb_on_treatment | ~df.tb_treated_mdr)</span>
<span class="c1">#             &amp; (df.hv_on_art == 2)</span>
<span class="c1">#             &amp; ~df.hv_on_cotrim</span>
<span class="c1">#         ] = params[&quot;monthly_prob_tb_mortality&quot;]</span>
<span class="c1">#</span>
<span class="c1">#         # hiv-positive on cotrim and not ART - shouldn&#39;t happen</span>
<span class="c1">#         mort_hiv.loc[</span>
<span class="c1">#             df[&quot;tb_inf&quot;].str.contains(&quot;active_susc&quot;)</span>
<span class="c1">#             &amp; df.hv_inf</span>
<span class="c1">#             &amp; (~df.tb_on_treatment | ~df.tb_treated_mdr)</span>
<span class="c1">#             &amp; (df.hv_on_art != 2)</span>
<span class="c1">#             &amp; df.hv_on_cotrim</span>
<span class="c1">#         ] = (params[&quot;monthly_prob_tb_mortality_hiv&quot;] * params[&quot;mort_cotrim&quot;])</span>
<span class="c1">#</span>
<span class="c1">#         # Generate a series of random numbers, one per individual</span>
<span class="c1">#         probs = rng.rand(len(df))</span>
<span class="c1">#         deaths = df.is_alive &amp; (probs &lt; mortality_rate)</span>
<span class="c1">#         # print(&#39;deaths: &#39;, deaths)</span>
<span class="c1">#         will_die = (df[deaths]).index</span>
<span class="c1">#</span>
<span class="c1">#         for person in will_die:</span>
<span class="c1">#             if df.at[person, &quot;is_alive&quot;]:</span>
<span class="c1">#                 df.at[person, &quot;tb_date_death_occurred&quot;] = self.sim.date</span>
<span class="c1">#</span>
<span class="c1">#                 self.sim.schedule_event(</span>
<span class="c1">#                     demography.InstantaneousDeath(</span>
<span class="c1">#                         self.module, individual_id=person, cause=&quot;hiv&quot;</span>
<span class="c1">#                     ),</span>
<span class="c1">#                     now,</span>
<span class="c1">#                 )</span>
<span class="c1">#                 df.at[person, &quot;tb_date_death&quot;] = now</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class TbMdrDeathEvent(RegularEvent, PopulationScopeEventMixin):</span>
<span class="c1">#     &quot;&quot;&quot;The regular event that kills people with active MDR tb</span>
<span class="c1">#     HIV-positive deaths due to TB counted as HIV deaths</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self, module):</span>
<span class="c1">#         super().__init__(module, frequency=DateOffset(months=1))</span>
<span class="c1">#</span>
<span class="c1">#     def apply(self, population):</span>
<span class="c1">#         params = self.module.parameters</span>
<span class="c1">#         df = population.props</span>
<span class="c1">#         now = self.sim.date</span>
<span class="c1">#         rng = self.module.rng</span>
<span class="c1">#</span>
<span class="c1">#         # ---------------------------------- TB DEATHS - HIV-NEGATIVE ------------------------------------</span>
<span class="c1">#         # only active infections result in death</span>
<span class="c1">#         mortality_rate = pd.Series(0, index=df.index)</span>
<span class="c1">#</span>
<span class="c1">#         # hiv-negative, tb untreated</span>
<span class="c1">#         mortality_rate.loc[</span>
<span class="c1">#             df[&quot;tb_inf&quot;].str.contains(&quot;active_mdr&quot;)</span>
<span class="c1">#             &amp; ~df.hv_inf</span>
<span class="c1">#             &amp; ~df.tb_treated_mdr</span>
<span class="c1">#             &amp; ~df.hv_on_cotrim</span>
<span class="c1">#         ] = params[&quot;monthly_prob_tb_mortality&quot;]</span>
<span class="c1">#</span>
<span class="c1">#         # hiv-negative on cotrim - shouldn&#39;t be any, tb untreated</span>
<span class="c1">#         mortality_rate.loc[</span>
<span class="c1">#             df[&quot;tb_inf&quot;].str.contains(&quot;active_mdr&quot;)</span>
<span class="c1">#             &amp; ~df.hv_inf</span>
<span class="c1">#             &amp; ~df.tb_treated_mdr</span>
<span class="c1">#             &amp; df.hv_on_cotrim</span>
<span class="c1">#         ] = (params[&quot;monthly_prob_tb_mortality&quot;] * params[&quot;mort_cotrim&quot;])</span>
<span class="c1">#</span>
<span class="c1">#         # hiv-negative, tb treated</span>
<span class="c1">#         mortality_rate.loc[</span>
<span class="c1">#             df[&quot;tb_inf&quot;].str.contains(&quot;active_mdr&quot;)</span>
<span class="c1">#             &amp; ~df.hv_inf</span>
<span class="c1">#             &amp; df.tb_treated_mdr</span>
<span class="c1">#             &amp; ~df.hv_on_cotrim</span>
<span class="c1">#         ] = (params[&quot;monthly_prob_tb_mortality&quot;] * params[&quot;mort_tx&quot;])</span>
<span class="c1">#</span>
<span class="c1">#         # Generate a series of random numbers, one per individual</span>
<span class="c1">#         probs = rng.rand(len(df))</span>
<span class="c1">#         deaths = df.is_alive &amp; (probs &lt; mortality_rate)</span>
<span class="c1">#         # print(&#39;deaths: &#39;, deaths)</span>
<span class="c1">#         will_die = (df[deaths]).index</span>
<span class="c1">#         # print(&#39;will_die: &#39;, will_die)</span>
<span class="c1">#</span>
<span class="c1">#         for person in will_die:</span>
<span class="c1">#             if df.at[person, &quot;is_alive&quot;]:</span>
<span class="c1">#                 df.at[person, &quot;tb_date_death_occurred&quot;] = self.sim.date</span>
<span class="c1">#</span>
<span class="c1">#                 self.sim.schedule_event(</span>
<span class="c1">#                     demography.InstantaneousDeath(</span>
<span class="c1">#                         self.module, individual_id=person, cause=&quot;tb&quot;</span>
<span class="c1">#                     ),</span>
<span class="c1">#                     now,</span>
<span class="c1">#                 )</span>
<span class="c1">#                 df.at[person, &quot;tb_date_death&quot;] = now</span>
<span class="c1">#</span>
<span class="c1">#         # ---------------------------------- HIV-TB DEATHS ------------------------------------</span>
<span class="c1">#         # only active infections result in death, no deaths on treatment</span>
<span class="c1">#         mort_hiv = pd.Series(0, index=df.index)</span>
<span class="c1">#</span>
<span class="c1">#         # hiv-positive no ART, tb untreated</span>
<span class="c1">#         mort_hiv.loc[</span>
<span class="c1">#             df[&quot;tb_inf&quot;].str.contains(&quot;active_mdr&quot;)</span>
<span class="c1">#             &amp; df.hv_inf</span>
<span class="c1">#             &amp; (~df.tb_on_treatment | ~df.tb_treated_mdr)</span>
<span class="c1">#             &amp; (df.hv_on_art != 2)</span>
<span class="c1">#             &amp; ~df.hv_on_cotrim</span>
<span class="c1">#         ] = params[&quot;monthly_prob_tb_mortality_hiv&quot;]</span>
<span class="c1">#</span>
<span class="c1">#         # hiv-positive on ART, tb untreated</span>
<span class="c1">#         mort_hiv.loc[</span>
<span class="c1">#             df[&quot;tb_inf&quot;].str.contains(&quot;active_mdr&quot;)</span>
<span class="c1">#             &amp; df.hv_inf</span>
<span class="c1">#             &amp; (~df.tb_on_treatment | ~df.tb_treated_mdr)</span>
<span class="c1">#             &amp; (df.hv_on_art == 2)</span>
<span class="c1">#             &amp; ~df.hv_on_cotrim</span>
<span class="c1">#         ] = params[&quot;monthly_prob_tb_mortality&quot;]</span>
<span class="c1">#</span>
<span class="c1">#         # hiv-positive on cotrim and ART, tb untreated</span>
<span class="c1">#         mort_hiv.loc[</span>
<span class="c1">#             df[&quot;tb_inf&quot;].str.contains(&quot;active_mdr&quot;)</span>
<span class="c1">#             &amp; df.hv_inf</span>
<span class="c1">#             &amp; (~df.tb_on_treatment | ~df.tb_treated_mdr)</span>
<span class="c1">#             &amp; (df.hv_on_art == 2)</span>
<span class="c1">#             &amp; df.hv_on_cotrim</span>
<span class="c1">#         ] = (params[&quot;monthly_prob_tb_mortality_hiv&quot;] * params[&quot;mort_cotrim&quot;])</span>
<span class="c1">#</span>
<span class="c1">#         # hiv-positive no ART, tb treated</span>
<span class="c1">#         mort_hiv.loc[</span>
<span class="c1">#             df[&quot;tb_inf&quot;].str.contains(&quot;active_mdr&quot;)</span>
<span class="c1">#             &amp; df.hv_inf</span>
<span class="c1">#             &amp; df.tb_treated_mdr</span>
<span class="c1">#             &amp; (df.hv_on_art == 2)</span>
<span class="c1">#             &amp; ~df.hv_on_cotrim</span>
<span class="c1">#         ] = (params[&quot;monthly_prob_tb_mortality&quot;] * params[&quot;mort_tx&quot;])</span>
<span class="c1">#</span>
<span class="c1">#         # Generate a series of random numbers, one per individual</span>
<span class="c1">#         probs = rng.rand(len(df))</span>
<span class="c1">#         deaths = df.is_alive &amp; (probs &lt; mortality_rate)</span>
<span class="c1">#         # print(&#39;deaths: &#39;, deaths)</span>
<span class="c1">#         will_die = (df[deaths]).index</span>
<span class="c1">#</span>
<span class="c1">#         for person in will_die:</span>
<span class="c1">#             if df.at[person, &quot;is_alive&quot;]:</span>
<span class="c1">#                 df.at[person, &quot;tb_date_death_occurred&quot;] = self.sim.date</span>
<span class="c1">#</span>
<span class="c1">#                 self.sim.schedule_event(</span>
<span class="c1">#                     demography.InstantaneousDeath(</span>
<span class="c1">#                         self.module, individual_id=person, cause=&quot;hiv&quot;</span>
<span class="c1">#                     ),</span>
<span class="c1">#                     now,</span>
<span class="c1">#                 )</span>
<span class="c1">#                 df.at[person, &quot;tb_date_death&quot;] = now</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># # ---------------------------------------------------------------------------</span>
<span class="c1"># #   Logging</span>
<span class="c1"># # ---------------------------------------------------------------------------</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class TbLoggingEvent(RegularEvent, PopulationScopeEventMixin):</span>
<span class="c1">#     def __init__(self, module):</span>
<span class="c1">#         &quot;&quot;&quot; produce some outputs to check</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         # run this event every 12 months</span>
<span class="c1">#         self.repeat = 12</span>
<span class="c1">#         super().__init__(module, frequency=DateOffset(months=self.repeat))</span>
<span class="c1">#</span>
<span class="c1">#     def apply(self, population):</span>
<span class="c1">#         # get some summary statistics</span>
<span class="c1">#         df = population.props</span>
<span class="c1">#         now = self.sim.date</span>
<span class="c1">#</span>
<span class="c1">#         # ------------------------------------ INCIDENCE ------------------------------------</span>
<span class="c1">#         # total number of new active cases in last year - susc + mdr</span>
<span class="c1">#         # may have died in the last year but still counted as active case for the year</span>
<span class="c1">#         new_tb_cases = len(</span>
<span class="c1">#             df[(df.tb_date_active &gt; (now - DateOffset(months=self.repeat)))]</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         # incidence per 100k</span>
<span class="c1">#         inc100k = (new_tb_cases / len(df[df.is_alive])) * 100000</span>
<span class="c1">#</span>
<span class="c1">#         # latent cases</span>
<span class="c1">#         new_latent_cases = len(</span>
<span class="c1">#             df[(df.tb_date_latent &gt; (now - DateOffset(months=self.repeat)))]</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         # percentage of active TB cases in the last year who are HIV-positive</span>
<span class="c1">#         inc_active_hiv = len(</span>
<span class="c1">#             df[(df.tb_date_active &gt; (now - DateOffset(months=self.repeat))) &amp; df.hv_inf]</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         prop_hiv = inc_active_hiv / new_tb_cases if new_tb_cases else 0</span>
<span class="c1">#</span>
<span class="c1">#         # incidence of TB-HIV per 100k</span>
<span class="c1">#         inc100k_hiv = (inc_active_hiv / len(df[df.is_alive])) * 100000</span>
<span class="c1">#</span>
<span class="c1">#         # proportion of new active cases that are mdr-tb</span>
<span class="c1">#         # technically this is EVER HAD MDR doesn&#39;t mean the last episode necessarily</span>
<span class="c1">#         inc_active_mdr = len(</span>
<span class="c1">#             df[</span>
<span class="c1">#                 df.tb_ever_tb_mdr</span>
<span class="c1">#                 &amp; (df.tb_date_active &gt; (now - DateOffset(months=self.repeat)))</span>
<span class="c1">#             ]</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         if new_tb_cases &gt; 0:</span>
<span class="c1">#             prop_inc_active_mdr = inc_active_mdr / new_tb_cases</span>
<span class="c1">#         else:</span>
<span class="c1">#             prop_inc_active_mdr = 0</span>
<span class="c1">#</span>
<span class="c1">#         assert prop_inc_active_mdr &lt;= 1</span>
<span class="c1">#</span>
<span class="c1">#         logger.info(</span>
<span class="c1">#             &quot;%s|tb_incidence|%s&quot;,</span>
<span class="c1">#             now,</span>
<span class="c1">#             {</span>
<span class="c1">#                 &quot;tbNewActiveCases&quot;: new_tb_cases,</span>
<span class="c1">#                 &quot;tbNewLatentCases&quot;: new_latent_cases,</span>
<span class="c1">#                 &quot;tbIncActive100k&quot;: inc100k,</span>
<span class="c1">#                 &quot;tbIncActive100k_hiv&quot;: inc100k_hiv,</span>
<span class="c1">#                 &quot;tbPropIncActiveMdr&quot;: prop_inc_active_mdr,</span>
<span class="c1">#                 &quot;tb_prop_hiv_pos&quot;: prop_hiv,</span>
<span class="c1">#             },</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         # ------------------------------------ PREVALENCE ------------------------------------</span>
<span class="c1">#         # prevalence should be the number of clinically active cases that occurred in the past year</span>
<span class="c1">#         # ACTIVE</span>
<span class="c1">#         new_tb_cases = len(</span>
<span class="c1">#             df[(df.tb_date_active &gt; (now - DateOffset(months=self.repeat)))]</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         # num_active = len(df[(df.tb_inf.str.contains(&#39;active&#39;)) &amp; df.is_alive])</span>
<span class="c1">#         prop_active = new_tb_cases / len(df[df.is_alive])</span>
<span class="c1">#</span>
<span class="c1">#         assert prop_active &lt;= 1</span>
<span class="c1">#</span>
<span class="c1">#         # todo: change to adjusted prevalence counting # episodes / pop</span>
<span class="c1">#         # proportion of adults with active tb</span>
<span class="c1">#         num_active_adult = len(</span>
<span class="c1">#             df[(df.tb_inf.str.contains(&quot;active&quot;)) &amp; (df.age_years &gt;= 15) &amp; df.is_alive]</span>
<span class="c1">#         )</span>
<span class="c1">#         prop_active_adult = num_active_adult / len(</span>
<span class="c1">#             df[(df.age_years &gt;= 15) &amp; df.is_alive]</span>
<span class="c1">#         )</span>
<span class="c1">#         assert prop_active_adult &lt;= 1</span>
<span class="c1">#</span>
<span class="c1">#         # proportion of children with active tb</span>
<span class="c1">#         num_active_child = len(</span>
<span class="c1">#             df[(df.tb_inf.str.contains(&quot;active&quot;)) &amp; (df.age_years &lt; 15) &amp; df.is_alive]</span>
<span class="c1">#         )</span>
<span class="c1">#         prop_active_child = num_active_child / len(</span>
<span class="c1">#             df[(df.age_years &lt; 15) &amp; df.is_alive]</span>
<span class="c1">#         )</span>
<span class="c1">#         assert prop_active_child &lt;= 1</span>
<span class="c1">#</span>
<span class="c1">#         # proportion of hiv cases with active tb</span>
<span class="c1">#         num_active_hiv = len(</span>
<span class="c1">#             df[(df.tb_inf.str.contains(&quot;active&quot;)) &amp; df.hv_inf &amp; df.is_alive]</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         if (num_active_hiv &gt; 0) &amp; (len(df[df.hv_inf &amp; df.is_alive]) &gt; 0):</span>
<span class="c1">#             prop_hiv_tb = num_active_hiv / len(df[df.hv_inf &amp; df.is_alive])</span>
<span class="c1">#         else:</span>
<span class="c1">#             prop_hiv_tb = 0</span>
<span class="c1">#</span>
<span class="c1">#         # proportion of population with active TB by age/sex - compare to WHO 2018</span>
<span class="c1">#         m_num_cases = (</span>
<span class="c1">#             df[df.is_alive &amp; (df.sex == &quot;M&quot;) &amp; (df.tb_inf.str.contains(&quot;active&quot;))]</span>
<span class="c1">#             .groupby(&quot;age_range&quot;)</span>
<span class="c1">#             .size()</span>
<span class="c1">#         )</span>
<span class="c1">#         f_num_cases = (</span>
<span class="c1">#             df[df.is_alive &amp; (df.sex == &quot;F&quot;) &amp; (df.tb_inf.str.contains(&quot;active&quot;))]</span>
<span class="c1">#             .groupby(&quot;age_range&quot;)</span>
<span class="c1">#             .size()</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         m_pop = df[df.is_alive &amp; (df.sex == &quot;M&quot;)].groupby(&quot;age_range&quot;).size()</span>
<span class="c1">#         f_pop = df[df.is_alive &amp; (df.sex == &quot;F&quot;)].groupby(&quot;age_range&quot;).size()</span>
<span class="c1">#</span>
<span class="c1">#         m_prop_active = m_num_cases / m_pop</span>
<span class="c1">#         m_prop_active = m_prop_active.fillna(0)</span>
<span class="c1">#         f_prop_active = f_num_cases / f_pop</span>
<span class="c1">#         f_prop_active = f_prop_active.fillna(0)</span>
<span class="c1">#</span>
<span class="c1">#         logger.info(&quot;%s|tb_propActiveTbMale|%s&quot;, self.sim.date, m_prop_active.to_dict())</span>
<span class="c1">#</span>
<span class="c1">#         logger.info(</span>
<span class="c1">#             &quot;%s|tb_propActiveTbFemale|%s&quot;, self.sim.date, f_prop_active.to_dict()</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         # LATENT</span>
<span class="c1">#</span>
<span class="c1">#         # proportion of population with latent TB - all pop</span>
<span class="c1">#         num_latent = len(df[(df.tb_inf.str.contains(&quot;latent&quot;)) &amp; df.is_alive])</span>
<span class="c1">#         prop_latent = num_latent / len(df[df.is_alive])</span>
<span class="c1">#         assert prop_latent &lt;= 1</span>
<span class="c1">#</span>
<span class="c1">#         # proportion of population with latent TB - adults</span>
<span class="c1">#         num_latent_adult = len(</span>
<span class="c1">#             df[(df.tb_inf.str.contains(&quot;latent&quot;)) &amp; (df.age_years &gt;= 15) &amp; df.is_alive]</span>
<span class="c1">#         )</span>
<span class="c1">#         prop_latent_adult = num_latent_adult / len(</span>
<span class="c1">#             df[(df.age_years &gt;= 15) &amp; df.is_alive]</span>
<span class="c1">#         )</span>
<span class="c1">#         assert prop_latent_adult &lt;= 1</span>
<span class="c1">#</span>
<span class="c1">#         # proportion of population with latent TB - children</span>
<span class="c1">#         num_latent_child = len(</span>
<span class="c1">#             df[(df.tb_inf.str.contains(&quot;latent&quot;)) &amp; (df.age_years &lt; 15) &amp; df.is_alive]</span>
<span class="c1">#         )</span>
<span class="c1">#         prop_latent_child = num_latent_child / len(</span>
<span class="c1">#             df[(df.age_years &lt; 15) &amp; df.is_alive]</span>
<span class="c1">#         )</span>
<span class="c1">#         assert prop_latent_child &lt;= 1</span>
<span class="c1">#</span>
<span class="c1">#         logger.info(</span>
<span class="c1">#             &quot;%s|tb_prevalence|%s&quot;,</span>
<span class="c1">#             now,</span>
<span class="c1">#             {</span>
<span class="c1">#                 &quot;tbPropActive&quot;: prop_active,</span>
<span class="c1">#                 &quot;tbPropActiveAdult&quot;: prop_active_adult,</span>
<span class="c1">#                 &quot;tbPropActiveChild&quot;: prop_active_child,</span>
<span class="c1">#                 &quot;tbPropActiveHiv&quot;: prop_hiv_tb,</span>
<span class="c1">#                 &quot;tbPropLatent&quot;: prop_latent,</span>
<span class="c1">#                 &quot;tbPropLatentAdult&quot;: prop_latent_adult,</span>
<span class="c1">#                 &quot;tbPropLatentChild&quot;: prop_latent_child,</span>
<span class="c1">#             },</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         # ------------------------------------ TREATMENT ------------------------------------</span>
<span class="c1">#         # number of new cases in the last time period / number new treatment starts in last time period</span>
<span class="c1">#</span>
<span class="c1">#         # percentage all cases which occurred in last time period and treated in last time period</span>
<span class="c1">#         new_tx = len(df[(df.tb_date_treated &gt; (now - DateOffset(months=self.repeat)))])</span>
<span class="c1">#</span>
<span class="c1">#         percent_treated = ((new_tx / new_tb_cases) * 100) if new_tb_cases else 0</span>
<span class="c1">#         # assert percent_treated &lt;= 100</span>
<span class="c1">#</span>
<span class="c1">#         # percentage all adult cases which occurred in last time period and treated in last time period</span>
<span class="c1">#         new_tb_cases_adult = len(</span>
<span class="c1">#             df[</span>
<span class="c1">#                 (df.age_years &gt;= 15)</span>
<span class="c1">#                 &amp; (df.tb_date_active &gt; (now - DateOffset(months=self.repeat)))</span>
<span class="c1">#             ]</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         new_tb_tx_adult = len(</span>
<span class="c1">#             df[</span>
<span class="c1">#                 (df.age_years &gt;= 15)</span>
<span class="c1">#                 &amp; (df.tb_date_treated &gt; (now - DateOffset(months=self.repeat)))</span>
<span class="c1">#             ]</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         percent_treated_adult = (</span>
<span class="c1">#             ((new_tb_tx_adult / new_tb_cases_adult) * 100) if new_tb_cases_adult else 0</span>
<span class="c1">#         )</span>
<span class="c1">#         # assert percent_treated_adult &lt;= 100</span>
<span class="c1">#</span>
<span class="c1">#         # percentage all child cases which occurred in last time period and treated in last time period</span>
<span class="c1">#         new_tb_cases_child = len(</span>
<span class="c1">#             df[</span>
<span class="c1">#                 (df.age_years &lt; 15)</span>
<span class="c1">#                 &amp; (df.tb_date_active &gt; (now - DateOffset(months=self.repeat)))</span>
<span class="c1">#             ]</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         new_tb_tx_child = len(</span>
<span class="c1">#             df[</span>
<span class="c1">#                 (df.age_years &lt; 15)</span>
<span class="c1">#                 &amp; (df.tb_date_treated &gt; (now - DateOffset(months=self.repeat)))</span>
<span class="c1">#             ]</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         percent_treated_child = (</span>
<span class="c1">#             ((new_tb_tx_child / new_tb_cases_child) * 100) if new_tb_cases_child else 0</span>
<span class="c1">#         )</span>
<span class="c1">#         # assert percent_treated_child &lt;= 100</span>
<span class="c1">#</span>
<span class="c1">#         logger.info(</span>
<span class="c1">#             &quot;%s|tb_treatment|%s&quot;,</span>
<span class="c1">#             now,</span>
<span class="c1">#             {</span>
<span class="c1">#                 &quot;tbTreat&quot;: percent_treated,</span>
<span class="c1">#                 &quot;tbTreatAdult&quot;: percent_treated_adult,</span>
<span class="c1">#                 &quot;tbTreatChild&quot;: percent_treated_child,</span>
<span class="c1">#             },</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         # ------------------------------------ BCG ------------------------------------</span>
<span class="c1">#         # bcg vaccination coverage in &lt;1 year old children</span>
<span class="c1">#         bcg = len(df[df.is_alive &amp; df.tb_bcg &amp; (df.age_years &lt;= 1)])</span>
<span class="c1">#         infants = len(df[df.is_alive &amp; (df.age_years &lt;= 1)])</span>
<span class="c1">#</span>
<span class="c1">#         coverage = ((bcg / infants) * 100) if infants else 0</span>
<span class="c1">#         assert coverage &lt;= 100</span>
<span class="c1">#</span>
<span class="c1">#         logger.info(</span>
<span class="c1">#             &quot;%s|tb_bcg|%s&quot;,</span>
<span class="c1">#             now,</span>
<span class="c1">#             {</span>
<span class="c1">#                 &quot;tbNumInfantsBcg&quot;: bcg,</span>
<span class="c1">#                 &quot;tbNumInfantsEligibleBcg&quot;: infants,</span>
<span class="c1">#                 &quot;tbBcgCoverage&quot;: coverage,</span>
<span class="c1">#             },</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         # ------------------------------------ MORTALITY ------------------------------------</span>
<span class="c1">#         # tb deaths (incl hiv) reported in the last 12 months / pop size</span>
<span class="c1">#         deaths = len(df[(df.tb_date_death &gt; (now - DateOffset(months=self.repeat)))])</span>
<span class="c1">#</span>
<span class="c1">#         mort_rate100k = (deaths / len(df[df.is_alive])) * 100000</span>
<span class="c1">#</span>
<span class="c1">#         # tb deaths (hiv+ only) reported in the last 12 months / pop size</span>
<span class="c1">#         deaths_tb_hiv = len(</span>
<span class="c1">#             df[df.hv_inf &amp; (df.tb_date_death &gt; (now - DateOffset(months=self.repeat)))]</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         mort_rate_tb_hiv100k = (deaths_tb_hiv / len(df[df.is_alive])) * 100000</span>
<span class="c1">#</span>
<span class="c1">#         logger.info(</span>
<span class="c1">#             &quot;%s|tb_mortality|%s&quot;,</span>
<span class="c1">#             now,</span>
<span class="c1">#             {</span>
<span class="c1">#                 &quot;tbMortRate100k&quot;: mort_rate100k,</span>
<span class="c1">#                 &quot;tbMortRateHiv100k&quot;: mort_rate_tb_hiv100k,</span>
<span class="c1">#             },</span>
<span class="c1">#         )</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
      <span class="lastupdated">
        Last updated on May 27, 2021.
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>