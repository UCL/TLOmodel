<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tlo.methods.schisto &mdash; TLOmodel 0.1.dev2435+gd9d3f62 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=d10597a4" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/theme_overrides.css?v=6ea10ece" />

  
    <link rel="shortcut icon" href="../../../_static/favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=f3d69a25"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            TLOmodel
          </a>
              <div class="version">
                0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Welcome</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../aims.html">Aims &amp; Objectives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../writeups.html">Model Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data_sources.html">Data Sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../azure_batch.html">Using Azure Batch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../resources/index.html">Resource files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../learning.html">Learning Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributors.html">Contributors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">TLOmodel</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../methods.html">tlo.methods</a></li>
      <li class="breadcrumb-item active">tlo.methods.schisto</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for tlo.methods.schisto</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">tlo</span> <span class="kn">import</span> <span class="n">Date</span><span class="p">,</span> <span class="n">DateOffset</span><span class="p">,</span> <span class="n">Module</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">,</span> <span class="n">Property</span><span class="p">,</span> <span class="n">Types</span><span class="p">,</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="nn">tlo.analysis.utils</span> <span class="kn">import</span> <span class="n">flatten_multi_index_series_into_dict_for_logging</span>
<span class="kn">from</span> <span class="nn">tlo.events</span> <span class="kn">import</span> <span class="n">Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">,</span> <span class="n">RegularEvent</span>
<span class="kn">from</span> <span class="nn">tlo.methods</span> <span class="kn">import</span> <span class="n">Metadata</span>
<span class="kn">from</span> <span class="nn">tlo.methods.causes</span> <span class="kn">import</span> <span class="n">Cause</span>
<span class="kn">from</span> <span class="nn">tlo.methods.hsi_event</span> <span class="kn">import</span> <span class="n">HSI_Event</span>
<span class="kn">from</span> <span class="nn">tlo.methods.hsi_generic_first_appts</span> <span class="kn">import</span> <span class="n">GenericFirstAppointmentsMixin</span>
<span class="kn">from</span> <span class="nn">tlo.methods.symptommanager</span> <span class="kn">import</span> <span class="n">Symptom</span>
<span class="kn">from</span> <span class="nn">tlo.util</span> <span class="kn">import</span> <span class="n">random_date</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">tlo.methods.hsi_generic_first_appts</span> <span class="kn">import</span> <span class="n">HSIEventScheduler</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="c1"># Definition of the age-groups used in the module, as a tuple of two integers (a,b) such that the given age group</span>
<span class="c1">#  is in range a &lt;= group &lt;= b. i.e.,</span>
<span class="c1">#     0 &lt;= PSAC &lt;= 4</span>
<span class="c1">#     5 &lt;= SAC &lt;= 14</span>
<span class="c1">#     15 &lt;= Adults</span>
<span class="c1">#     0 &lt;= All</span>
<span class="n">_AGE_GROUPS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;PSAC&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="s1">&#39;SAC&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span> <span class="s1">&#39;Adults&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span> <span class="s1">&#39;All&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">120</span><span class="p">)}</span>


<div class="viewcode-block" id="Schisto">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.Schisto">[docs]</a>
<span class="k">class</span> <span class="nc">Schisto</span><span class="p">(</span><span class="n">Module</span><span class="p">,</span> <span class="n">GenericFirstAppointmentsMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Schistosomiasis module.</span>
<span class="sd">    Two species of worm that cause Schistosomiasis are modelled independently. Worms are acquired by persons via the</span>
<span class="sd">     environment. There is a delay between the acquisition of worms and the maturation to &#39;adults&#39; worms; and a long</span>
<span class="sd">     period before the adult worms die. The number of worms in a person (whether a high-intensity infection or not)</span>
<span class="sd">     determines the symptoms they experience. These symptoms are associated with disability weights. There is no risk</span>
<span class="sd">     of death. Treatment can be provided to persons who present following the onset of symptoms. Mass Drug</span>
<span class="sd">     Administrations also give treatment to the general population, which clears any worm burden they have.</span>

<span class="sd">    N.B. Formal fitting has only been undertaken for: (&#39;Blantyre&#39;, &#39;Chiradzulu&#39;, &#39;Mulanje&#39;, &#39;Nsanje&#39;, &#39;Nkhotakota&#39;,</span>
<span class="sd">    &#39;Phalombe&#39;).&quot;&quot;&quot;</span>

    <span class="n">INIT_DEPENDENCIES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Demography&#39;</span><span class="p">,</span> <span class="s1">&#39;SymptomManager&#39;</span><span class="p">}</span>

    <span class="n">OPTIONAL_INIT_DEPENDENCIES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">,</span> <span class="s1">&#39;HealthBurden&#39;</span><span class="p">}</span>

    <span class="n">METADATA</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">Metadata</span><span class="o">.</span><span class="n">DISEASE_MODULE</span><span class="p">,</span>
        <span class="n">Metadata</span><span class="o">.</span><span class="n">USES_SYMPTOMMANAGER</span><span class="p">,</span>
        <span class="n">Metadata</span><span class="o">.</span><span class="n">USES_HEALTHSYSTEM</span><span class="p">,</span>
        <span class="n">Metadata</span><span class="o">.</span><span class="n">USES_HEALTHBURDEN</span>
    <span class="p">}</span>

    <span class="n">CAUSES_OF_DEATH</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">CAUSES_OF_DISABILITY</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Schistosomiasis&#39;</span><span class="p">:</span> <span class="n">Cause</span><span class="p">(</span><span class="n">gbd_causes</span><span class="o">=</span><span class="s1">&#39;Schistosomiasis&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Schistosomiasis&#39;</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="n">module_prefix</span> <span class="o">=</span> <span class="s1">&#39;ss&#39;</span>

    <span class="n">PROPERTIES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">module_prefix</span><span class="si">}</span><span class="s1">_last_PZQ_date&#39;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATE</span><span class="p">,</span> <span class="s1">&#39;Day of the most recent treatment with PZQ&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">PARAMETERS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;prob_sent_to_lab_test_children&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
                                                    <span class="s1">&#39;Probability that infected child gets sent to lab test&#39;</span><span class="p">),</span>
        <span class="s1">&#39;prob_sent_to_lab_test_adults&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
                                                  <span class="s1">&#39;Probability that an infected adults gets sent to lab test&#39;</span><span class="p">),</span>
        <span class="s1">&#39;delay_till_hsi_a_repeated&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
                                               <span class="s1">&#39;Time till seeking healthcare again after not being sent to schisto &#39;</span>
                                               <span class="s1">&#39;test: start&#39;</span><span class="p">),</span>
        <span class="s1">&#39;delay_till_hsi_b_repeated&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
                                               <span class="s1">&#39;Time till seeking healthcare again after not being sent to schisto &#39;</span>
                                               <span class="s1">&#39;test: end&#39;</span><span class="p">),</span>
        <span class="s1">&#39;PZQ_efficacy&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
                                  <span class="s1">&#39;The efficacy of Praziquantel in clearing burden of any Schistosomiasis worm &#39;</span>
                                  <span class="s1">&#39;species&#39;</span><span class="p">),</span>
        <span class="s1">&#39;MDA_coverage_historical&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span>
                                             <span class="s1">&#39;Probability of getting PZQ in the MDA for PSAC, SAC and Adults in &#39;</span>
                                             <span class="s1">&#39;historic rounds&#39;</span><span class="p">),</span>
        <span class="s1">&#39;MDA_coverage_prognosed&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span>
                                            <span class="s1">&#39;Probability of getting PZQ in the MDA for PSAC, SAC and Adults in future &#39;</span>
                                            <span class="s1">&#39;rounds, with the frequency given in months&#39;</span><span class="p">),</span>
    <span class="p">}</span>

<div class="viewcode-block" id="Schisto.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.Schisto.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resourcefilepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mda_execute</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resourcefilepath</span> <span class="o">=</span> <span class="n">resourcefilepath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mda_execute</span> <span class="o">=</span> <span class="n">mda_execute</span>

        <span class="c1"># Create pointer that will be to dict of disability weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disability_weights</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Create pointer that will be to the item_code for praziquantel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_code_for_praziquantel</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Create the instances of `SchistoSpecies` that will represent the two species being considered</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species</span> <span class="o">=</span> <span class="p">{</span><span class="n">_name</span><span class="p">:</span> <span class="n">SchistoSpecies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;mansoni&#39;</span><span class="p">,</span> <span class="s1">&#39;haematobium&#39;</span><span class="p">)}</span>

        <span class="c1"># Add properties and parameters declared by each species:</span>
        <span class="k">for</span> <span class="n">_spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PROPERTIES</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_spec</span><span class="o">.</span><span class="n">get_properties</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PARAMETERS</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_spec</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">())</span>

        <span class="c1"># Property names for infection_status of all species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cols_of_infection_status</span> <span class="o">=</span> <span class="p">[</span><span class="n">_spec</span><span class="o">.</span><span class="n">infection_status_property</span> <span class="k">for</span> <span class="n">_spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">districts</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Age-group mapper</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">120</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="s1">&#39;object&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">low_limit</span><span class="p">,</span> <span class="n">high_limit</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_AGE_GROUPS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;All&#39;</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">s</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">low_limit</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">high_limit</span><span class="p">)]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">age_group_mapper</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span></div>


<div class="viewcode-block" id="Schisto.read_parameters">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.Schisto.read_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">read_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_folder</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read parameters and register symptoms.&quot;&quot;&quot;</span>

        <span class="c1"># Load parameters</span>
        <span class="n">workbook</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resourcefilepath</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;ResourceFile_Schisto.xlsx&#39;</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_parameters_from_workbook</span><span class="p">(</span><span class="n">workbook</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_spec</span><span class="o">.</span><span class="n">load_parameters_from_workbook</span><span class="p">(</span><span class="n">workbook</span><span class="p">))</span>

        <span class="c1"># Register symptoms</span>
        <span class="n">symptoms_df</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s1">&#39;Symptoms&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_register_symptoms</span><span class="p">(</span><span class="n">symptoms_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Symptom&#39;</span><span class="p">)[</span><span class="s1">&#39;HSB_mapped_symptom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span></div>


<div class="viewcode-block" id="Schisto.pre_initialise_population">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.Schisto.pre_initialise_population">[docs]</a>
    <span class="k">def</span> <span class="nf">pre_initialise_population</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Do things before generating the population (but after read_parameters and any parameter updating).&quot;&quot;&quot;</span>

        <span class="c1"># Define districts that this module will operate in:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">districts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;Demography&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">districts</span>  <span class="c1"># &lt;- all districts</span>

        <span class="c1"># Call `pre_initialise_population` for each `SchistoSpecies` helper module.</span>
        <span class="k">for</span> <span class="n">_spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">_spec</span><span class="o">.</span><span class="n">update_parameters_from_schisto_module</span><span class="p">()</span></div>


<div class="viewcode-block" id="Schisto.initialise_population">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.Schisto.initialise_population">[docs]</a>
    <span class="k">def</span> <span class="nf">initialise_population</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the property values for the initial population.&quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">module_prefix</span><span class="si">}</span><span class="s1">_last_PZQ_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>

        <span class="k">for</span> <span class="n">_spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">_spec</span><span class="o">.</span><span class="n">initialise_population</span><span class="p">(</span><span class="n">population</span><span class="p">)</span></div>


<div class="viewcode-block" id="Schisto.initialise_simulation">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.Schisto.initialise_simulation">[docs]</a>
    <span class="k">def</span> <span class="nf">initialise_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get ready for simulation start.&quot;&quot;&quot;</span>

        <span class="c1"># Initialise the simulation for each species</span>
        <span class="k">for</span> <span class="n">_spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">_spec</span><span class="o">.</span><span class="n">initialise_simulation</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span>

        <span class="c1"># Look-up DALY weights</span>
        <span class="k">if</span> <span class="s1">&#39;HealthBurden&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disability_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_disability_weight</span><span class="p">()</span>

        <span class="c1"># Look-up item code for Praziquantel</span>
        <span class="k">if</span> <span class="s1">&#39;HealthSystem&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">item_code_for_praziquantel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_item_code_for_praziquantel</span><span class="p">()</span>

        <span class="c1"># Schedule the logging event</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">SchistoLoggingEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>

        <span class="c1"># Schedule MDA events</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mda_execute</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_mda_events</span><span class="p">()</span></div>


<div class="viewcode-block" id="Schisto.on_birth">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.Schisto.on_birth">[docs]</a>
    <span class="k">def</span> <span class="nf">on_birth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mother_id</span><span class="p">,</span> <span class="n">child_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialise our properties for a newborn individual.</span>
<span class="sd">        All children are born without an infection, even if the mother is infected.</span>

<span class="sd">        :param mother_id: the ID for the mother for this child</span>
<span class="sd">        :param child_id: the new child</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">module_prefix</span><span class="si">}</span><span class="s1">_last_PZQ_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>
        <span class="c1"># df.at[child_id, &#39;ss_scheduled_hsi_date&#39;] = pd.NaT</span>

        <span class="k">for</span> <span class="n">_spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">_spec</span><span class="o">.</span><span class="n">on_birth</span><span class="p">(</span><span class="n">mother_id</span><span class="p">,</span> <span class="n">child_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="Schisto.report_daly_values">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.Schisto.report_daly_values">[docs]</a>
    <span class="k">def</span> <span class="nf">report_daly_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Report the daly values, as the sum of the disability weight associated with each symptom caused by this</span>
<span class="sd">        module.&quot;&quot;&quot;</span>

        <span class="c1"># Get the total weights for all those that have symptoms caused by this module.</span>
        <span class="n">symptoms_being_caused</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;SymptomManager&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">caused_by</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_total_disability_weight</span><span class="p">(</span><span class="n">list_of_symptoms</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Returns the sum of the disability weights from a list of symptoms, capping at 1.0&quot;&quot;&quot;</span>
            <span class="n">dw</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">list_of_symptoms</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">dw</span>

            <span class="k">for</span> <span class="n">symptom</span> <span class="ow">in</span> <span class="n">list_of_symptoms</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">symptom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">disability_weights</span><span class="p">:</span>
                    <span class="n">dw</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disability_weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symptom</span><span class="p">)</span>

            <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dw</span><span class="p">)</span>

        <span class="n">disability_weights_for_each_person_with_symptoms</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">symptoms_being_caused</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="n">get_total_disability_weight</span><span class="p">)</span>

        <span class="c1"># Return pd.Series that include entries for all alive persons (filling 0.0 where they do not have any symptoms)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">disability_weights_for_each_person_with_symptoms</span><span class="p">,</span>
                                                                    <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span></div>


<div class="viewcode-block" id="Schisto.do_effect_of_treatment">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.Schisto.do_effect_of_treatment">[docs]</a>
    <span class="k">def</span> <span class="nf">do_effect_of_treatment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Do the effects of a treatment administered to a person or persons. This can be called for a person who is</span>
<span class="sd">        infected and receiving treatment following a diagnosis, or for a person who is receiving treatment as part of a</span>
<span class="sd">         Mass Drug Administration. The burden and effects of any species are alleviated by a successful treatment.&quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="c1"># Clear any symptoms caused by this module (i.e., Schisto of any species)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;SymptomManager&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">clear_symptoms</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">disease_module</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Record in the property the date of last treatment</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s1">&#39;ss_last_PZQ_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>

        <span class="c1"># Set properties to be not-infected (any species), and zero-out all worm burden information.</span>
        <span class="k">for</span> <span class="n">spec_prefix</span> <span class="ow">in</span> <span class="p">[</span><span class="n">_spec</span><span class="o">.</span><span class="n">prefix</span> <span class="k">for</span> <span class="n">_spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">values</span><span class="p">()]:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">module_prefix</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">spec_prefix</span><span class="si">}</span><span class="s1">_aggregate_worm_burden&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">module_prefix</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">spec_prefix</span><span class="si">}</span><span class="s1">_infection_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Non-infected&#39;</span></div>

            <span class="c1"># df.loc[person_id, f&#39;{self.module_prefix}_{spec_prefix}_start_of_prevalent_period&#39;] = pd.NaT</span>
            <span class="c1"># df.loc[person_id, f&#39;{self.module_prefix}_{spec_prefix}_start_of_high_infection&#39;] = pd.NaT</span>

<div class="viewcode-block" id="Schisto._load_parameters_from_workbook">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.Schisto._load_parameters_from_workbook">[docs]</a>
    <span class="k">def</span> <span class="nf">_load_parameters_from_workbook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workbook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load parameters from ResourceFile (loaded by pd.read_excel as `workbook`) that are general (i.e., not</span>
<span class="sd">        specific to a particular species).&quot;&quot;&quot;</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># HSI and treatment params:</span>
        <span class="n">param_list</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Parameter&quot;</span><span class="p">)[</span><span class="s1">&#39;Value&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">_param_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;delay_till_hsi_a_repeated&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;delay_till_hsi_b_repeated&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;prob_sent_to_lab_test_children&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;prob_sent_to_lab_test_adults&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;PZQ_efficacy&#39;</span><span class="p">,</span>
                            <span class="p">):</span>
            <span class="n">parameters</span><span class="p">[</span><span class="n">_param_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">param_list</span><span class="p">[</span><span class="n">_param_name</span><span class="p">])</span>

        <span class="c1"># MDA coverage - historic</span>
        <span class="n">historical_mda</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s1">&#39;MDA_historical_Coverage&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;District&#39;</span><span class="p">,</span> <span class="s1">&#39;Year&#39;</span><span class="p">])[</span>
            <span class="p">[</span><span class="s1">&#39;Coverage PSAC&#39;</span><span class="p">,</span> <span class="s1">&#39;Coverage SAC&#39;</span><span class="p">,</span> <span class="s1">&#39;Coverage Adults&#39;</span><span class="p">]]</span>
        <span class="n">historical_mda</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">historical_mda</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Coverage &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;MDA_coverage_historical&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">historical_mda</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

        <span class="c1"># MDA coverage - prognosed</span>
        <span class="n">prognosed_mda</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s1">&#39;MDA_prognosed_Coverage&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;District&#39;</span><span class="p">,</span> <span class="s1">&#39;Frequency&#39;</span><span class="p">])[</span>
            <span class="p">[</span><span class="s1">&#39;Coverage PSAC&#39;</span><span class="p">,</span> <span class="s1">&#39;Coverage SAC&#39;</span><span class="p">,</span> <span class="s1">&#39;Coverage Adults&#39;</span><span class="p">]]</span>
        <span class="n">prognosed_mda</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">prognosed_mda</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Coverage &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;MDA_coverage_prognosed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prognosed_mda</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">parameters</span></div>


<div class="viewcode-block" id="Schisto._register_symptoms">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.Schisto._register_symptoms">[docs]</a>
    <span class="k">def</span> <span class="nf">_register_symptoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symptoms</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register the symptoms with the `SymptomManager`.</span>
<span class="sd">        :params symptoms: The symptoms that are used by this module in a dictionary of the form, {&lt;symptom&gt;:</span>
<span class="sd">        &lt;generic_symptom_similar&gt;}. Each symptom is associated with the average healthcare seeking behaviour.&quot;&quot;&quot;</span>
        <span class="n">generic_symptoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;SymptomManager&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">generic_symptoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;SymptomManager&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">register_symptom</span><span class="p">(</span><span class="o">*</span><span class="p">[</span>
            <span class="n">Symptom</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">_symp</span><span class="p">)</span> <span class="k">for</span> <span class="n">_symp</span> <span class="ow">in</span> <span class="n">symptoms</span> <span class="k">if</span> <span class="n">_symp</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">generic_symptoms</span>
        <span class="p">])</span></div>


<div class="viewcode-block" id="Schisto._get_disability_weight">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.Schisto._get_disability_weight">[docs]</a>
    <span class="k">def</span> <span class="nf">_get_disability_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return dict containing the disability weight (value) of each symptom (key).&quot;&quot;&quot;</span>

        <span class="n">symptoms_to_disability_weight_mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># These mapping are justified in the &#39;DALYS&#39; worksheet of the ResourceFile.</span>
            <span class="s1">&#39;anemia&#39;</span><span class="p">:</span> <span class="mi">258</span><span class="p">,</span>
            <span class="s1">&#39;fever&#39;</span><span class="p">:</span> <span class="mi">262</span><span class="p">,</span>
            <span class="s1">&#39;hydronephrosis&#39;</span><span class="p">:</span> <span class="mi">260</span><span class="p">,</span>
            <span class="s1">&#39;dysuria&#39;</span><span class="p">:</span> <span class="mi">263</span><span class="p">,</span>
            <span class="s1">&#39;bladder_pathology&#39;</span><span class="p">:</span> <span class="mi">264</span><span class="p">,</span>
            <span class="s1">&#39;diarrhoea&#39;</span><span class="p">:</span> <span class="mi">259</span><span class="p">,</span>
            <span class="s1">&#39;vomiting&#39;</span><span class="p">:</span> <span class="mi">254</span><span class="p">,</span>
            <span class="s1">&#39;ascites&#39;</span><span class="p">:</span> <span class="mi">261</span><span class="p">,</span>
            <span class="s1">&#39;hepatomegaly&#39;</span><span class="p">:</span> <span class="mi">257</span><span class="p">,</span>
            <span class="s1">&#39;haematuria&#39;</span><span class="p">:</span> <span class="kc">None</span>  <span class="c1"># That&#39;s a very common symptom but no official DALY weight yet defined.</span>
        <span class="p">}</span>
        <span class="n">get_daly_weight</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">_code</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthBurden&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_daly_weight</span><span class="p">(</span>  <span class="c1"># noqa: E731</span>
            <span class="n">_code</span><span class="p">)</span> <span class="k">if</span> <span class="n">_code</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.0</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="n">symptom</span><span class="p">:</span> <span class="n">get_daly_weight</span><span class="p">(</span><span class="n">dw_code</span><span class="p">)</span> <span class="k">for</span> <span class="n">symptom</span><span class="p">,</span> <span class="n">dw_code</span> <span class="ow">in</span> <span class="n">symptoms_to_disability_weight_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="Schisto._get_item_code_for_praziquantel">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.Schisto._get_item_code_for_praziquantel">[docs]</a>
    <span class="k">def</span> <span class="nf">_get_item_code_for_praziquantel</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Look-up the item code for Praziquantel&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_item_code_from_item_name</span><span class="p">(</span><span class="s2">&quot;Praziquantel 600mg_1000_CMST&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Schisto._schedule_mda_events">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.Schisto._schedule_mda_events">[docs]</a>
    <span class="k">def</span> <span class="nf">_schedule_mda_events</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Schedule MDA events, historical and prognosed.&quot;&quot;&quot;</span>

        <span class="c1"># Schedule the  MDA that have occurred, in each district and in each year:</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">district</span><span class="p">,</span> <span class="n">year</span><span class="p">),</span> <span class="n">cov</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;MDA_coverage_historical&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">assert</span> <span class="n">district</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;Demography&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">districts</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;District </span><span class="si">{</span><span class="n">district</span><span class="si">}</span><span class="s1"> is not recognised.&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
                <span class="n">SchistoMDAEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                <span class="n">district</span><span class="o">=</span><span class="n">district</span><span class="p">,</span>
                                <span class="n">coverage</span><span class="o">=</span><span class="n">cov</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
                                <span class="n">months_between_repeats</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
                <span class="n">Date</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Schedule the first occurrence of a future MDA in each district. It will occur after the last historical MDA.</span>
        <span class="c1"># The event that will schedule further instances of itself.</span>
        <span class="n">year_last_historical_mda</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;MDA_coverage_historical&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">Year</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">year_first_simulated_mda</span> <span class="o">=</span> <span class="n">year_last_historical_mda</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">district</span><span class="p">,</span> <span class="n">frequency_in_months</span><span class="p">),</span> <span class="n">cov</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;MDA_coverage_prognosed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">assert</span> <span class="n">district</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;Demography&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">districts</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;District </span><span class="si">{</span><span class="n">district</span><span class="si">}</span><span class="s1"> is not recognised.&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
                <span class="n">SchistoMDAEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                <span class="n">district</span><span class="o">=</span><span class="n">district</span><span class="p">,</span>
                                <span class="n">coverage</span><span class="o">=</span><span class="n">cov</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
                                <span class="n">months_between_repeats</span><span class="o">=</span><span class="n">frequency_in_months</span> <span class="k">if</span> <span class="n">frequency_in_months</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),</span>
                <span class="n">Date</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">year_first_simulated_mda</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Schisto.do_at_generic_first_appt">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.Schisto.do_at_generic_first_appt">[docs]</a>
    <span class="k">def</span> <span class="nf">do_at_generic_first_appt</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">person_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">symptoms</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">schedule_hsi_event</span><span class="p">:</span> <span class="n">HSIEventScheduler</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Do when person presents to the GenericFirstAppt.</span>
        <span class="c1"># If the person has certain set of symptoms, refer ta HSI for testing.</span>
        <span class="n">set_of_symptoms_indicative_of_schisto</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;anemia&#39;</span><span class="p">,</span> <span class="s1">&#39;haematuria&#39;</span><span class="p">,</span> <span class="s1">&#39;bladder_pathology&#39;</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">set_of_symptoms_indicative_of_schisto</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">symptoms</span><span class="p">):</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">HSI_Schisto_TestingFollowingSymptoms</span><span class="p">(</span>
                <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span>
            <span class="p">)</span>
            <span class="n">schedule_hsi_event</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span></div>
</div>



<span class="k">class</span> <span class="nc">SchistoSpecies</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper Class to hold the information specific to a particular species (either S. mansoni or S. haematobium).&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schisto_module</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schisto_module</span> <span class="o">=</span> <span class="n">schisto_module</span>
        <span class="k">assert</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;mansoni&#39;</span><span class="p">,</span> <span class="s1">&#39;haematobium&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="c1"># Store prefix for this species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;s&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Store parameters specific to this species (for ease of access)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The species-specific parameters for this species.&quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># &#39;delay_a&#39;: Parameter(Types.REAL, &#39;End of the latent period in days, start&#39;),</span>
            <span class="c1"># &#39;delay_b&#39;: Parameter(Types.REAL, &#39;End of the latent period in days, end&#39;),</span>
            <span class="c1"># &#39;symptoms&#39;: Parameter(Types.LIST, &#39;Symptoms of the schistosomiasis infection, dependent on the module&#39;),</span>
            <span class="s1">&#39;beta_PSAC&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s1">&#39;Contact/exposure rate of PSAC&#39;</span><span class="p">),</span>
            <span class="s1">&#39;beta_SAC&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s1">&#39;Contact/exposure rate of SAC&#39;</span><span class="p">),</span>
            <span class="s1">&#39;beta_Adults&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s1">&#39;Contact/exposure rate of Adults&#39;</span><span class="p">),</span>
            <span class="s1">&#39;worms_fecundity&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s1">&#39;Fecundity parameter, driving density-dependent reproduction&#39;</span><span class="p">),</span>
            <span class="s1">&#39;worm_lifespan&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s1">&#39;Lifespan of the worm in human host given in years&#39;</span><span class="p">),</span>
            <span class="s1">&#39;high_intensity_threshold&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
                                                  <span class="s1">&#39;Threshold of worm burden indicating high intensity infection&#39;</span><span class="p">),</span>
            <span class="s1">&#39;low_intensity_threshold&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
                                                 <span class="s1">&#39;Threshold of worm burden indicating low intensity infection&#39;</span><span class="p">),</span>
            <span class="s1">&#39;high_intensity_threshold_PSAC&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
                                                       <span class="s1">&#39;Worm burden threshold for high intensity infection in PSAC&#39;</span><span class="p">),</span>
            <span class="s1">&#39;reservoir_2010&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span>
                                        <span class="s1">&#39;Initial reservoir of infectious material per district in 2010&#39;</span><span class="p">),</span>
            <span class="s1">&#39;gamma_alpha&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s1">&#39;Parameter alpha for Gamma distribution for harbouring rates&#39;</span><span class="p">),</span>
            <span class="s1">&#39;R0&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s1">&#39;Effective reproduction number, for the FOI&#39;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefix_species_parameter</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="k">def</span> <span class="nf">get_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The species-specific properties for this species.&quot;&quot;&quot;</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;infection_status&#39;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span>
                <span class="n">Types</span><span class="o">.</span><span class="n">CATEGORICAL</span><span class="p">,</span> <span class="s1">&#39;Current status of schistosomiasis infection for this species&#39;</span><span class="p">,</span>
                <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Non-infected&#39;</span><span class="p">,</span> <span class="s1">&#39;Low-infection&#39;</span><span class="p">,</span> <span class="s1">&#39;High-infection&#39;</span><span class="p">]),</span>
            <span class="s1">&#39;aggregate_worm_burden&#39;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span>
                <span class="n">Types</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span> <span class="s1">&#39;Number of mature worms of this species in the individual&#39;</span><span class="p">),</span>
            <span class="s1">&#39;harbouring_rate&#39;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span>
                <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s1">&#39;Rate of harbouring new worms of this species (Poisson), drawn from gamma distribution&#39;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix_species_property</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">properties</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="k">def</span> <span class="nf">prefix_species_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generic_property_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add the prefix to a `generic_property_name` to get the name of the species-specific property for this</span>
<span class="sd">        species.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">schisto_module</span><span class="o">.</span><span class="n">module_prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">generic_property_name</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="nf">_prefix_species_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generic_parameter_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add the prefix to a `generic_parameter_name` to get the name of the species-specific parameter for this</span>
<span class="sd">        species.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">generic_parameter_name</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">infection_status_property</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the property that identifies the infection_status of the person with respect to this species.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix_species_property</span><span class="p">(</span><span class="s1">&#39;infection_status&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_parameters_from_workbook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workbook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load parameters from ResourceFile (loaded by pd.read_excel as `workbook`) that are specific to this</span>
<span class="sd">        species.&quot;&quot;&quot;</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># Natural history params</span>
        <span class="n">param_list</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Parameter&quot;</span><span class="p">)[</span><span class="s1">&#39;Value&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">_param_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;beta_PSAC&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;beta_SAC&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;beta_Adults&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;worm_lifespan&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;worms_fecundity&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;high_intensity_threshold&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;low_intensity_threshold&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;high_intensity_threshold_PSAC&#39;</span>
                            <span class="p">):</span>
            <span class="n">parameters</span><span class="p">[</span><span class="n">_param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_list</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_param_name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>

        <span class="c1"># Baseline reservoir size and other district-related params (alpha and R0)</span>
        <span class="n">schisto_initial_reservoir</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;District_Params_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;District&quot;</span><span class="p">)</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;reservoir_2010&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">schisto_initial_reservoir</span><span class="p">[</span><span class="s1">&#39;Reservoir&#39;</span><span class="p">]</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;gamma_alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">schisto_initial_reservoir</span><span class="p">[</span><span class="s1">&#39;alpha_value&#39;</span><span class="p">]</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;R0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">schisto_initial_reservoir</span><span class="p">[</span><span class="s1">&#39;R0_value&#39;</span><span class="p">]</span>

        <span class="c1"># Symptoms (prevalence of each type of symptom)</span>
        <span class="n">symptoms_df</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s1">&#39;Symptoms&#39;</span><span class="p">]</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;symptoms&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">symptoms_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">symptoms_df</span><span class="p">[</span><span class="s1">&#39;Infection_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">])]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Symptom&#39;</span><span class="p">)[</span>
                <span class="s1">&#39;Prevalence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefix_species_parameter</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="k">def</span> <span class="nf">pre_initialise_population</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Do things before generating the population (but after read_parameters) and any parameter updating.&quot;&quot;&quot;</span>

        <span class="c1"># Save species-specific parameter in this class, copying from the `Schisto` module. (We have to do this step</span>
        <span class="c1"># because the module may have updated the parameters).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_parameters_from_schisto_module</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">initialise_population</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set species-specific property values for the initial population.&quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix_species_property</span>

        <span class="c1"># assign aggregate_worm_burden (zero for everyone initially)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="n">prop</span><span class="p">(</span><span class="s1">&#39;aggregate_worm_burden&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># assign a harbouring rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_initial_harbouring_rate</span><span class="p">(</span><span class="n">population</span><span class="p">)</span>

        <span class="c1"># assign initial worm burden</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_initial_worm_burden</span><span class="p">(</span><span class="n">population</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">initialise_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        * Schedule natural history events for those with worm burden initially.</span>
<span class="sd">        * Schedule the WormBurdenEvent for this species. (A recurring instance of this event will be scheduled for</span>
<span class="sd">        each species independently.)&quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="c1"># Assign infection statuses and symptoms and schedule natural history events for those with worm burden</span>
        <span class="c1"># initially.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_infectious_status_and_symptoms</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_death_of_worms_in_initial_population</span><span class="p">()</span>

        <span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
            <span class="n">SchistoInfectionWormBurdenEvent</span><span class="p">(</span>
                <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">schisto_module</span><span class="p">,</span>
                <span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="p">),</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_birth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mother_id</span><span class="p">,</span> <span class="n">child_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialise the species-specific properties for a newborn individual.</span>
<span class="sd">        :param mother_id: the ID for the mother for this child (redundant)</span>
<span class="sd">        :param child_id: the new child&quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schisto_module</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix_species_property</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schisto_module</span><span class="o">.</span><span class="n">rng</span>

        <span class="c1"># Assign the default for a newly born child</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="n">prop</span><span class="p">(</span><span class="s1">&#39;infection_status&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;Non-infected&#39;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="n">prop</span><span class="p">(</span><span class="s1">&#39;aggregate_worm_burden&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Generate the harbouring rate depending on a district of residence.</span>
        <span class="n">district</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s1">&#39;district_of_residence&#39;</span><span class="p">]</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="n">prop</span><span class="p">(</span><span class="s1">&#39;harbouring_rate&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;gamma_alpha&#39;</span><span class="p">][</span><span class="n">district</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_infectious_status_and_symptoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates the infection status and symptoms based on the current aggregate worm burden of this species.</span>
<span class="sd">         * Assigns the &#39;infection status&#39; (High-infection, Low-infection, Non-infected) to the persons with ids given</span>
<span class="sd">         in the `idx` argument, according their age (in years) and their aggregate worm burden (of worms of this</span>
<span class="sd">         species).</span>
<span class="sd">         * Causes the onset symptoms to the persons newly with high intensity infection.</span>
<span class="sd">         * Removes the symptoms if a person no longer has a high intensity infection (from any species)&quot;&quot;&quot;</span>

        <span class="n">schisto_module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schisto_module</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">schisto_module</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix_species_property</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">schisto_module</span><span class="o">.</span><span class="n">rng</span>
        <span class="n">possible_symptoms</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;symptoms&quot;</span><span class="p">]</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="n">schisto_module</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;SymptomManager&#39;</span><span class="p">]</span>
        <span class="n">cols_of_infection_status</span> <span class="o">=</span> <span class="n">schisto_module</span><span class="o">.</span><span class="n">cols_of_infection_status</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">def</span> <span class="nf">_get_infection_status</span><span class="p">(</span><span class="n">population</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
            <span class="n">age</span> <span class="o">=</span> <span class="n">population</span><span class="p">[</span><span class="s2">&quot;age_years&quot;</span><span class="p">]</span>
            <span class="n">agg_wb</span> <span class="o">=</span> <span class="n">population</span><span class="p">[</span><span class="n">prop</span><span class="p">(</span><span class="s2">&quot;aggregate_worm_burden&quot;</span><span class="p">)]</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                <span class="s2">&quot;Non-infected&quot;</span><span class="p">,</span>
                <span class="n">index</span><span class="o">=</span><span class="n">population</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">population</span><span class="p">[</span><span class="n">prop</span><span class="p">(</span><span class="s2">&quot;infection_status&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">dtype</span>
            <span class="p">)</span>
            <span class="n">high_group</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">age</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">agg_wb</span> <span class="o">&gt;=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;high_intensity_threshold_PSAC&quot;</span><span class="p">])</span>
            <span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">agg_wb</span> <span class="o">&gt;=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;high_intensity_threshold&quot;</span><span class="p">])</span>
            <span class="n">low_group</span> <span class="o">=</span> <span class="o">~</span><span class="n">high_group</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">agg_wb</span> <span class="o">&gt;=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;low_intensity_threshold&quot;</span><span class="p">])</span>
            <span class="n">status</span><span class="p">[</span><span class="n">high_group</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;High-infection&quot;</span>
            <span class="n">status</span><span class="p">[</span><span class="n">low_group</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Low-infection&quot;</span>
            <span class="k">return</span> <span class="n">status</span>

        <span class="k">def</span> <span class="nf">_impose_symptoms_of_high_intensity_infection</span><span class="p">(</span><span class="n">idx</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Assign symptoms to the person with high intensity infection.</span>
<span class="sd">            :param idx: indices of individuals&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="k">for</span> <span class="n">symptom</span><span class="p">,</span> <span class="n">prev</span> <span class="ow">in</span> <span class="n">possible_symptoms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">will_onset_this_symptom</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">prev</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">will_onset_this_symptom</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">sm</span><span class="o">.</span><span class="n">change_symptom</span><span class="p">(</span>
                        <span class="n">person_id</span><span class="o">=</span><span class="n">will_onset_this_symptom</span><span class="p">,</span>
                        <span class="n">symptom_string</span><span class="o">=</span><span class="n">symptom</span><span class="p">,</span>
                        <span class="n">add_or_remove</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
                        <span class="n">disease_module</span><span class="o">=</span><span class="n">schisto_module</span>
                    <span class="p">)</span>

        <span class="n">correct_status</span> <span class="o">=</span> <span class="n">_get_infection_status</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="n">original_status</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">prop</span><span class="p">(</span><span class="s1">&#39;infection_status&#39;</span><span class="p">)]</span>

        <span class="c1"># Impose symptoms for those newly having &#39;High-infection&#39; status</span>
        <span class="n">newly_have_high_infection</span> <span class="o">=</span> <span class="p">(</span><span class="n">original_status</span> <span class="o">!=</span> <span class="s1">&#39;High-infection&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">correct_status</span> <span class="o">==</span> <span class="s1">&#39;High-infection&#39;</span><span class="p">)</span>
        <span class="n">idx_newly_have_high_infection</span> <span class="o">=</span> <span class="n">newly_have_high_infection</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">newly_have_high_infection</span><span class="p">]</span>
        <span class="n">_impose_symptoms_of_high_intensity_infection</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="n">idx_newly_have_high_infection</span><span class="p">)</span>

        <span class="c1"># Update status for those whose status is changing</span>
        <span class="n">idx_changing</span> <span class="o">=</span> <span class="n">correct_status</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">original_status</span> <span class="o">!=</span> <span class="n">correct_status</span><span class="p">]</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx_changing</span><span class="p">,</span> <span class="n">prop</span><span class="p">(</span><span class="s1">&#39;infection_status&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">correct_status</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx_changing</span><span class="p">]</span>

        <span class="c1"># Remove symptoms if there is no cause High-infection status caused by either species</span>
        <span class="c1">#  NB. This is a limitation because there is no possibility of species-specific removal of symptoms. So, if a</span>
        <span class="c1">#  person has two infections causing &#39;High-infection&#39; and one is reduced below &#39;High-infection&#39;, symptoms will</span>
        <span class="c1">#  persist as if the person still had two causes of &#39;High-infection&#39;. The symptoms would not be removed until</span>
        <span class="c1">#  both the aggregate worm burden of both species is reduced.</span>
        <span class="n">cols_of_infection_status_for_other_species</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_of_infection_status</span> <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="n">prop</span><span class="p">(</span><span class="s1">&#39;infection_status&#39;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">high_infection_any_other_species</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">cols_of_infection_status_for_other_species</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;High-infection&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">no_longer_high_infection</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span>
            <span class="p">(</span><span class="n">original_status</span> <span class="o">==</span> <span class="s1">&#39;High-infection&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
                <span class="n">correct_status</span> <span class="o">!=</span> <span class="s1">&#39;High-infection&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">high_infection_any_other_species</span>
            <span class="p">]</span>
        <span class="n">sm</span><span class="o">.</span><span class="n">clear_symptoms</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">no_longer_high_infection</span><span class="p">,</span> <span class="n">disease_module</span><span class="o">=</span><span class="n">schisto_module</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_parameters_from_schisto_module</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the internally-held parameters from the `Schisto` module that are specific to this species.&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">remove_prefix</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">text</span><span class="p">[</span><span class="n">text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">):]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">remove_prefix</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_&quot;</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">schisto_module</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_assign_initial_harbouring_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assign a harbouring rate to every individual in the initial populattion (based on their district of</span>
<span class="sd">        residence).&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix_species_property</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">districts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schisto_module</span><span class="o">.</span><span class="n">districts</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schisto_module</span><span class="o">.</span><span class="n">rng</span>

        <span class="k">for</span> <span class="n">district</span> <span class="ow">in</span> <span class="n">districts</span><span class="p">:</span>
            <span class="n">in_the_district</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;district_of_residence&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">district</span><span class="p">]</span>
            <span class="n">hr</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;gamma_alpha&#39;</span><span class="p">][</span><span class="n">district</span><span class="p">]</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">in_the_district</span><span class="p">,</span> <span class="n">prop</span><span class="p">(</span><span class="s1">&#39;harbouring_rate&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">hr</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">in_the_district</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_assign_initial_worm_burden</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assign initial distribution of worms to each person (based on district and age-group).&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix_species_property</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">districts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schisto_module</span><span class="o">.</span><span class="n">districts</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schisto_module</span><span class="o">.</span><span class="n">rng</span>

        <span class="n">reservoir</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;reservoir_2010&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">district</span> <span class="ow">in</span> <span class="n">districts</span><span class="p">:</span>
            <span class="c1"># Determine a &#39;contact rate&#39; for each person</span>
            <span class="n">in_the_district</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;district_of_residence&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">district</span><span class="p">]</span>
            <span class="n">contact_rates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">in_the_district</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">age_group</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PSAC&#39;</span><span class="p">,</span> <span class="s1">&#39;SAC&#39;</span><span class="p">,</span> <span class="s1">&#39;Adults&#39;</span><span class="p">]:</span>
                <span class="n">age_range</span> <span class="o">=</span> <span class="n">_AGE_GROUPS</span><span class="p">[</span><span class="n">age_group</span><span class="p">]</span>
                <span class="n">in_the_district_and_age_group</span> <span class="o">=</span> \
                    <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;district_of_residence&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">district</span><span class="p">)</span> <span class="o">&amp;</span>
                             <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;age_years&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">age_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">age_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]))]</span>
                <span class="n">contact_rates</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">in_the_district_and_age_group</span><span class="p">]</span> <span class="o">*=</span> <span class="n">params</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;beta_</span><span class="si">{</span><span class="n">age_group</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_the_district</span><span class="p">):</span>
                <span class="n">harbouring_rates</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">in_the_district</span><span class="p">,</span> <span class="n">prop</span><span class="p">(</span><span class="s1">&#39;harbouring_rate&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
                <span class="n">rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">harbouring_rates</span><span class="p">,</span> <span class="n">contact_rates</span><span class="p">)</span>
                <span class="n">reservoir_distr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">reservoir</span><span class="p">[</span><span class="n">district</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_the_district</span><span class="p">))</span>

                <span class="c1"># Distribute a worm burden among persons, according to their &#39;contact rate&#39;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">reservoir_distr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">rates</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">chosen</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">in_the_district</span><span class="p">,</span> <span class="n">reservoir_distr</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">rates</span> <span class="o">/</span> <span class="n">rates</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
                    <span class="n">unique</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">chosen</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">worms_per_idx</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">unique</span><span class="p">,</span> <span class="n">counts</span><span class="p">))</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">prop</span><span class="p">(</span><span class="s1">&#39;aggregate_worm_burden&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">worms_per_idx</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_schedule_death_of_worms_in_initial_population</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Schedule death of worms assigned to the initial population&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schisto_module</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix_species_property</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schisto_module</span><span class="o">.</span><span class="n">rng</span>
        <span class="n">date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schisto_module</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>

        <span class="n">people_with_worms</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">prop</span><span class="p">(</span><span class="s1">&#39;aggregate_worm_burden&#39;</span><span class="p">)]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">person_id</span> <span class="ow">in</span> <span class="n">people_with_worms</span><span class="p">:</span>
            <span class="n">months_till_death</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;worm_lifespan&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">12</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">schisto_module</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
                <span class="n">SchistoWormsNatDeath</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">schisto_module</span><span class="p">,</span>
                                     <span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                                     <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span>
                                     <span class="n">number_of_worms_that_die</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="n">prop</span><span class="p">(</span><span class="s1">&#39;aggregate_worm_burden&#39;</span><span class="p">)]),</span>
                <span class="n">date</span> <span class="o">+</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="n">months_till_death</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">log_infection_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log the number of persons in each infection status for this species, by age-group and district.&quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schisto_module</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="n">age_grp</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">]</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schisto_module</span><span class="o">.</span><span class="n">age_group_mapper</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">infection_status_property</span><span class="p">],</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s1">&#39;district_of_residence&#39;</span><span class="p">],</span>
            <span class="n">age_grp</span>
        <span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;infection_status&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;infection_status_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">flatten_multi_index_series_into_dict_for_logging</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Counts of infection status with this species by age-group and district.&#39;</span>
        <span class="p">)</span>


<div class="viewcode-block" id="SchistoInfectionWormBurdenEvent">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.SchistoInfectionWormBurdenEvent">[docs]</a>
<span class="k">class</span> <span class="nc">SchistoInfectionWormBurdenEvent</span><span class="p">(</span><span class="n">RegularEvent</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A recurring event that causes infection of people with this species.</span>
<span class="sd">     * Determines who becomes infected (using worm burden and reservoir of infectious material.</span>
<span class="sd">     * Schedules `SchistoMatureWorms` for when the worms mature to adult worms.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SchistoInfectionWormBurdenEvent.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.SchistoInfectionWormBurdenEvent.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span> <span class="n">species</span><span class="p">:</span> <span class="n">SchistoSpecies</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species</span> <span class="o">=</span> <span class="n">species</span></div>


<div class="viewcode-block" id="SchistoInfectionWormBurdenEvent.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.SchistoInfectionWormBurdenEvent.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">params</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">prefix_species_property</span>

        <span class="n">betas</span> <span class="o">=</span> <span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_PSAC&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_SAC&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_Adults&#39;</span><span class="p">]]</span>
        <span class="n">R0</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;R0&#39;</span><span class="p">]</span>

        <span class="n">where</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
        <span class="n">age_group</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">where</span><span class="p">,</span> <span class="s1">&#39;age_years&#39;</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">120</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PSAC&#39;</span><span class="p">,</span> <span class="s1">&#39;SAC&#39;</span><span class="p">,</span> <span class="s1">&#39;Adults&#39;</span><span class="p">],</span>
                           <span class="n">include_lowest</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">age_group</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;age_group&#39;</span>
        <span class="n">beta_by_age_group</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">betas</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PSAC&#39;</span><span class="p">,</span> <span class="s1">&#39;SAC&#39;</span><span class="p">,</span> <span class="s1">&#39;Adults&#39;</span><span class="p">])</span>
        <span class="n">beta_by_age_group</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;age_group&#39;</span>

        <span class="c1"># get the size of reservoir per district</span>
        <span class="n">mean_count_burden_district_age_group</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">where</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;district_of_residence&#39;</span><span class="p">,</span> <span class="n">age_group</span><span class="p">])[</span>
            <span class="n">prop</span><span class="p">(</span><span class="s1">&#39;aggregate_worm_burden&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">])</span>
        <span class="n">district_count</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">where</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;district_of_residence&#39;</span><span class="p">)[</span><span class="s1">&#39;district_of_residence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">beta_contribution_to_reservoir</span> <span class="o">=</span> <span class="n">mean_count_burden_district_age_group</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">beta_by_age_group</span>
        <span class="n">to_get_weighted_mean</span> <span class="o">=</span> <span class="n">mean_count_burden_district_age_group</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">district_count</span>
        <span class="n">age_worm_burden</span> <span class="o">=</span> <span class="n">beta_contribution_to_reservoir</span> <span class="o">*</span> <span class="n">to_get_weighted_mean</span>
        <span class="n">reservoir</span> <span class="o">=</span> <span class="n">age_worm_burden</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;district_of_residence&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># harbouring new worms</span>
        <span class="n">contact_rates</span> <span class="o">=</span> <span class="n">age_group</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">beta_by_age_group</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">harbouring_rates</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">where</span><span class="p">,</span> <span class="n">prop</span><span class="p">(</span><span class="s1">&#39;harbouring_rate&#39;</span><span class="p">)]</span>
        <span class="n">rates</span> <span class="o">=</span> <span class="n">harbouring_rates</span> <span class="o">*</span> <span class="n">contact_rates</span>
        <span class="n">worms_total</span> <span class="o">=</span> <span class="n">reservoir</span> <span class="o">*</span> <span class="n">R0</span>
        <span class="n">draw_worms</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
            <span class="n">rng</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span>
                <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">where</span><span class="p">,</span> <span class="s1">&#39;district_of_residence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">worms_total</span><span class="p">)</span> <span class="o">*</span> <span class="n">rates</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">where</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># density dependent establishment</span>
        <span class="n">param_worm_fecundity</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;worms_fecundity&#39;</span><span class="p">]</span>
        <span class="n">established</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">where</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">where</span><span class="p">,</span> <span class="n">prop</span><span class="p">(</span><span class="s1">&#39;aggregate_worm_burden&#39;</span><span class="p">)]</span> <span class="o">*</span> <span class="o">-</span><span class="n">param_worm_fecundity</span>
        <span class="p">)</span>
        <span class="n">to_establish</span> <span class="o">=</span> <span class="n">draw_worms</span><span class="p">[(</span><span class="n">draw_worms</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">established</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="c1"># schedule maturation of the established worms</span>
        <span class="k">for</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">num_new_worms</span> <span class="ow">in</span> <span class="n">to_establish</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">date_of_maturation</span> <span class="o">=</span> <span class="n">random_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">),</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">55</span><span class="p">),</span> <span class="n">rng</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
                <span class="n">SchistoMatureWorms</span><span class="p">(</span>
                    <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span>
                    <span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">,</span>
                    <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span>
                    <span class="n">number_of_worms_that_mature</span><span class="o">=</span><span class="n">num_new_worms</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">date_of_maturation</span>
            <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="SchistoMatureWorms">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.SchistoMatureWorms">[docs]</a>
<span class="k">class</span> <span class="nc">SchistoMatureWorms</span><span class="p">(</span><span class="n">Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents the maturation of worms to adult worms.</span>
<span class="sd">    * Increases the aggregate worm burden of an individual upon maturation of the worms</span>
<span class="sd">    * Schedules the natural death of worms and symptoms development if High-infection</span>
<span class="sd">    * Updates the infection status and symptoms of the person accordingly.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SchistoMatureWorms.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.SchistoMatureWorms.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span> <span class="n">species</span><span class="p">:</span> <span class="n">SchistoSpecies</span><span class="p">,</span> <span class="n">person_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">number_of_worms_that_mature</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species</span> <span class="o">=</span> <span class="n">species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_of_worms_that_mature</span> <span class="o">=</span> <span class="n">number_of_worms_that_mature</span></div>


<div class="viewcode-block" id="SchistoMatureWorms.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.SchistoMatureWorms.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">prefix_species_property</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">params</span>

        <span class="n">person</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">person</span><span class="o">.</span><span class="n">is_alive</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># increase worm burden</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="n">prop</span><span class="p">(</span><span class="s1">&#39;aggregate_worm_burden&#39;</span><span class="p">)]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_worms_that_mature</span>

        <span class="c1"># schedule the natural death of the worms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
            <span class="n">SchistoWormsNatDeath</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span>
                                 <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span>
                                 <span class="n">number_of_worms_that_die</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_worms_that_mature</span><span class="p">,</span>
                                 <span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;worm_lifespan&#39;</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">update_infectious_status_and_symptoms</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">([</span><span class="n">person_id</span><span class="p">]))</span></div>
</div>



<div class="viewcode-block" id="SchistoWormsNatDeath">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.SchistoWormsNatDeath">[docs]</a>
<span class="k">class</span> <span class="nc">SchistoWormsNatDeath</span><span class="p">(</span><span class="n">Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents the death of adult worms.</span>
<span class="sd">     * Decreases the aggregate worm burden of an individual upon natural death of the adult worm.</span>
<span class="sd">     * Updates the infection status and the symtoms of the person accordingly.</span>
<span class="sd">    Nb. This event checks the last day of PZQ treatment and if has been less than the lifespan of the worm it doesn&#39;t</span>
<span class="sd">    do anything (because the worms for which this event was raised will since have been killed by the PZQ).&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SchistoWormsNatDeath.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.SchistoWormsNatDeath.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span> <span class="n">species</span><span class="p">:</span> <span class="n">SchistoSpecies</span><span class="p">,</span> <span class="n">person_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">number_of_worms_that_die</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species</span> <span class="o">=</span> <span class="n">species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_of_worms_that_die</span> <span class="o">=</span> <span class="n">number_of_worms_that_die</span></div>


<div class="viewcode-block" id="SchistoWormsNatDeath.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.SchistoWormsNatDeath.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">prefix_species_property</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">params</span>
        <span class="n">person</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">person</span><span class="o">.</span><span class="n">is_alive</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">worms_now</span> <span class="o">=</span> <span class="n">person</span><span class="p">[</span><span class="n">prop</span><span class="p">(</span><span class="s1">&#39;aggregate_worm_burden&#39;</span><span class="p">)]</span>
        <span class="n">date_last_pzq</span> <span class="o">=</span> <span class="n">person</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">module_prefix</span><span class="si">}</span><span class="s1">_last_PZQ_date&#39;</span><span class="p">]</span>
        <span class="n">date_worm_acquisition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;worm_lifespan&#39;</span><span class="p">])</span>
        <span class="n">has_had_treatment_since_worm_acquisition</span> <span class="o">=</span> <span class="n">date_last_pzq</span> <span class="o">&gt;=</span> <span class="n">date_worm_acquisition</span>

        <span class="k">if</span> <span class="n">worms_now</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># Do nothing if there are currently no worms</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_had_treatment_since_worm_acquisition</span><span class="p">:</span>
            <span class="c1"># This event is for worms that have matured since the last treatment.</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="n">prop</span><span class="p">(</span><span class="s1">&#39;aggregate_worm_burden&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">worms_now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_worms_that_die</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">update_infectious_status_and_symptoms</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">([</span><span class="n">person_id</span><span class="p">]))</span></div>
</div>



<div class="viewcode-block" id="SchistoMDAEvent">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.SchistoMDAEvent">[docs]</a>
<span class="k">class</span> <span class="nc">SchistoMDAEvent</span><span class="p">(</span><span class="n">Event</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mass-Drug administration scheduled for the population. This event schedules the occurrence of the</span>
<span class="sd">    individual-level HSIs for the administration of drugs to each individual.</span>
<span class="sd">    :param district: The district in which the MDA occurs.</span>
<span class="sd">    :param coverage: A dictionary of the form {&lt;age_group&gt;: &lt;coverage&gt;}, where &lt;age_group&gt; is one of (&#39;PSAC&#39;, &#39;SAC&#39;,</span>
<span class="sd">     &#39;Adults&#39;).</span>
<span class="sd">    :params months_between_repeat: The number of months between repeated occurrences of this event. (None for no</span>
<span class="sd">     repeats).&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SchistoMDAEvent.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.SchistoMDAEvent.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span> <span class="n">district</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">coverage</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">months_between_repeats</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">Schisto</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">district</span> <span class="o">=</span> <span class="n">district</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coverage</span> <span class="o">=</span> <span class="n">coverage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">months_between_repeats</span> <span class="o">=</span> <span class="n">months_between_repeats</span></div>


<div class="viewcode-block" id="SchistoMDAEvent.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.SchistoMDAEvent.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Represents the occurence of an MDA, in a particular year and district, which achieves a particular coverage</span>
<span class="sd">         (by age-group).</span>
<span class="sd">         * Schedules the MDA HSI for each person that is reached in the MDA.</span>
<span class="sd">         * Schedules the recurrence of this event, if the MDA is to be repeated in the future.&quot;&quot;&quot;</span>

        <span class="c1"># Determine who receives the MDA</span>
        <span class="n">idx_to_receive_mda</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">age_group</span><span class="p">,</span> <span class="n">cov</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coverage</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">idx_to_receive_mda</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_select_recipients</span><span class="p">(</span><span class="n">district</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">district</span><span class="p">,</span> <span class="n">age_group</span><span class="o">=</span><span class="n">age_group</span><span class="p">,</span> <span class="n">coverage</span><span class="o">=</span><span class="n">cov</span><span class="p">))</span>

        <span class="c1"># Schedule the MDA HSI. This HSI will do the work for all the `person_id`s in `idx_to_receive_mda`, but</span>
        <span class="c1"># the HSI&#39;s argument `person_id` is attached only to the one of these people. This is to avoid the inefficiency</span>
        <span class="c1"># of multiple individual HSI being created that do the same thing and occur on the same day and in the same</span>
        <span class="c1"># facility. The limitation is that if this person dies then no one gets the HSI.</span>
        <span class="c1"># This is discussed in https://github.com/UCL/TLOmodel/issues/531</span>
        <span class="k">if</span> <span class="n">idx_to_receive_mda</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">hsi_event</span><span class="o">=</span><span class="n">HSI_Schisto_MDA</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span>
                    <span class="n">person_id</span><span class="o">=</span><span class="n">idx_to_receive_mda</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">beneficiaries_ids</span><span class="o">=</span><span class="n">idx_to_receive_mda</span>
                <span class="p">),</span>
                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                <span class="n">tclose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">2</span>
                <span class="c1"># A long time-window of operation and a low priority is used for this MDA Appointment, to represent</span>
                <span class="c1"># that the MDA would not take a priority over other appointments.</span>
            <span class="p">)</span>

        <span class="c1"># Schedule the recurrence of this event, if the MDA is to be repeated in the future.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">months_between_repeats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">months_between_repeats</span><span class="p">))</span></div>


<div class="viewcode-block" id="SchistoMDAEvent._select_recipients">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.SchistoMDAEvent._select_recipients">[docs]</a>
    <span class="k">def</span> <span class="nf">_select_recipients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">district</span><span class="p">,</span> <span class="n">age_group</span><span class="p">,</span> <span class="n">coverage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine persons to receive MDA, based on a specified target age-group and coverage.&quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="n">coverage</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Value of coverage </span><span class="si">{</span><span class="n">coverage</span><span class="si">}</span><span class="s1"> is out of bounds.&#39;</span>
        <span class="k">assert</span> <span class="n">age_group</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;PSAC&#39;</span><span class="p">,</span> <span class="s1">&#39;SAC&#39;</span><span class="p">,</span> <span class="s1">&#39;Adults&#39;</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span>

        <span class="n">age_range</span> <span class="o">=</span> <span class="n">_AGE_GROUPS</span><span class="p">[</span><span class="n">age_group</span><span class="p">]</span>  <span class="c1"># returns a tuple (a,b) a &lt;= age_group &lt;= b</span>

        <span class="n">eligible</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;is_alive&#39;</span><span class="p">]</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;district_of_residence&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">district</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;age_years&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">age_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">age_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="p">]</span>

        <span class="k">return</span> <span class="n">eligible</span><span class="p">[</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eligible</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">coverage</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="HSI_Schisto_TestingFollowingSymptoms">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.HSI_Schisto_TestingFollowingSymptoms">[docs]</a>
<span class="k">class</span> <span class="nc">HSI_Schisto_TestingFollowingSymptoms</span><span class="p">(</span><span class="n">HSI_Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is a Health System Interaction Event for a person with symptoms who has been referred from the FirstAppt</span>
<span class="sd">    for testing at the clinic.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="HSI_Schisto_TestingFollowingSymptoms.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.HSI_Schisto_TestingFollowingSymptoms.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">Schisto</span><span class="p">)</span>

        <span class="n">under_5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s1">&#39;age_years&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TREATMENT_ID</span> <span class="o">=</span> <span class="s1">&#39;Schisto_Treatment&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s1">&#39;Under5OPD&#39;</span> <span class="k">if</span> <span class="n">under_5</span> <span class="k">else</span> <span class="s1">&#39;Over5OPD&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span> <span class="o">=</span> <span class="s1">&#39;1a&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_occurrences</span> <span class="o">=</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="HSI_Schisto_TestingFollowingSymptoms.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.HSI_Schisto_TestingFollowingSymptoms.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">squeeze_factor</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_occurrences</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">person</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">cols_of_infection_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">cols_of_infection_status</span>

        <span class="c1"># Determine if the person will be tested now</span>
        <span class="n">under_15</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&lt;=</span> <span class="mi">15</span>
        <span class="n">will_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">&lt;</span> <span class="p">(</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;prob_sent_to_lab_test_children&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">under_15</span> <span class="k">else</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;prob_sent_to_lab_test_adults&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">will_test</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_equipment</span><span class="p">({</span><span class="s1">&#39;Ordinary Microscope&#39;</span><span class="p">})</span>

            <span class="c1"># Determine if they truly are infected (with any of the species)</span>
            <span class="n">is_infected</span> <span class="o">=</span> <span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cols_of_infection_status</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;Non-infected&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">is_infected</span> <span class="o">&amp;</span> <span class="n">will_test</span><span class="p">:</span>
                <span class="c1"># If they are infected and will test, schedule a treatment HSI:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                    <span class="n">HSI_Schisto_TreatmentFollowingDiagnosis</span><span class="p">(</span>
                        <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span>
                        <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">),</span>
                    <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                    <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">priority</span><span class="o">=</span><span class="mi">0</span>
                <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># The person will not test now. If this is the &quot;first attempt&quot;, re-schedule this HSI to occur after a delay,</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_occurrences</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">next_occurence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;delay_till_hsi_a_repeated&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;delay_till_hsi_b_repeated&#39;</span><span class="p">])</span>
                <span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">topen</span><span class="o">=</span><span class="n">next_occurence</span><span class="p">,</span>
                    <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">priority</span><span class="o">=</span><span class="mi">0</span>
                <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="HSI_Schisto_TreatmentFollowingDiagnosis">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.HSI_Schisto_TreatmentFollowingDiagnosis">[docs]</a>
<span class="k">class</span> <span class="nc">HSI_Schisto_TreatmentFollowingDiagnosis</span><span class="p">(</span><span class="n">HSI_Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is a Health System Interaction Event for a person being provided with PZQ treatment after having been</span>
<span class="sd">    diagnosed.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="HSI_Schisto_TreatmentFollowingDiagnosis.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.HSI_Schisto_TreatmentFollowingDiagnosis.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">Schisto</span><span class="p">)</span>

        <span class="n">under_5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s1">&#39;age_years&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TREATMENT_ID</span> <span class="o">=</span> <span class="s1">&#39;Schisto_Treatment&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s1">&#39;Under5OPD&#39;</span> <span class="k">if</span> <span class="n">under_5</span> <span class="k">else</span> <span class="s1">&#39;Over5OPD&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span> <span class="o">=</span> <span class="s1">&#39;1a&#39;</span></div>


<div class="viewcode-block" id="HSI_Schisto_TreatmentFollowingDiagnosis.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.HSI_Schisto_TreatmentFollowingDiagnosis.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">squeeze_factor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Do the treatment for this person.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_consumables</span><span class="p">(</span><span class="n">item_codes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">item_code_for_praziquantel</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">do_effect_of_treatment</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="HSI_Schisto_MDA">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.HSI_Schisto_MDA">[docs]</a>
<span class="k">class</span> <span class="nc">HSI_Schisto_MDA</span><span class="p">(</span><span class="n">HSI_Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is a Health System Interaction Event for providing one or more persons with PZQ as part of a Mass Drug</span>
<span class="sd">    Administration (MDA). Note that the `person_id` declared as the `target` of this `HSI_Event` is only one of the</span>
<span class="sd">    beneficiaries. This is in, effect, a &quot;batch job&quot; of individual HSI being handled within one HSI, for the sake of</span>
<span class="sd">    computational efficiency.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="HSI_Schisto_MDA.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.HSI_Schisto_MDA.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">beneficiaries_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">Schisto</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beneficiaries_ids</span> <span class="o">=</span> <span class="n">beneficiaries_ids</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">TREATMENT_ID</span> <span class="o">=</span> <span class="s1">&#39;Schisto_MDA&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span>
            <span class="s1">&#39;EPI&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">beneficiaries_ids</span><span class="p">)</span> <span class="k">if</span> <span class="n">beneficiaries_ids</span> <span class="k">else</span> <span class="mi">1</span><span class="p">})</span>
        <span class="c1"># The `EPI` appointment is appropriate because it&#39;s a very small appointment, and we note that this is used in</span>
        <span class="c1"># the coding for &#39;de-worming&#39;-type activities in the DHIS2 data. We show that expect there will be one of these</span>
        <span class="c1"># appointments for each of the beneficiaries, whereas, in fact, it may be more realistic to consider that the</span>
        <span class="c1"># real requirement is fewer than that.</span>
        <span class="c1"># This class is created when running `tlo_hsi_event.py`, which doesn&#39;t provide the argument `beneficiaries_ids`</span>
        <span class="c1"># but does require that `self.EXPECTED_APPT_FOOTPRINT` is valid. So, in this case, we let</span>
        <span class="c1"># `self.EXPECTED_APPT_FOOTPRINT` show that this requires 1 * that appointment type.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span> <span class="o">=</span> <span class="s1">&#39;1a&#39;</span></div>


<div class="viewcode-block" id="HSI_Schisto_MDA.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.HSI_Schisto_MDA.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">squeeze_factor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provide the treatment to the beneficiaries of this HSI.&quot;&quot;&quot;</span>

        <span class="c1"># Find which of the beneficiaries are still alive</span>
        <span class="n">beneficiaries_still_alive</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beneficiaries_ids</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">is_alive</span><span class="p">]</span>
        <span class="p">))</span>

        <span class="c1"># Let the key consumable be &quot;optional&quot; in order that provision of the treatment is NOT conditional on the drugs</span>
        <span class="c1"># being available.This is because we expect that special planning would be undertaken in order to ensure the</span>
        <span class="c1"># availability of the drugs on the day(s) when the MDA is planned.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_consumables</span><span class="p">(</span>
            <span class="n">optional_item_codes</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">item_code_for_praziquantel</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">beneficiaries_still_alive</span><span class="p">)}</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">do_effect_of_treatment</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">beneficiaries_still_alive</span><span class="p">)</span>

        <span class="c1"># Return the update appointment that reflects the actual number of beneficiaries.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s1">&#39;EPI&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">beneficiaries_still_alive</span><span class="p">)})</span></div>
</div>



<div class="viewcode-block" id="SchistoLoggingEvent">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.SchistoLoggingEvent">[docs]</a>
<span class="k">class</span> <span class="nc">SchistoLoggingEvent</span><span class="p">(</span><span class="n">RegularEvent</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">):</span>
<div class="viewcode-block" id="SchistoLoggingEvent.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.SchistoLoggingEvent.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This is a regular event (every month) that causes the logging for each species.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">Schisto</span><span class="p">)</span></div>


<div class="viewcode-block" id="SchistoLoggingEvent.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.schisto.html#tlo.methods.schisto.SchistoLoggingEvent.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Call `log_infection_status` for each species.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">_spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">_spec</span><span class="o">.</span><span class="n">log_infection_status</span><span class="p">()</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
      <span class="lastupdated">Last updated on Aug 02, 2024.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>