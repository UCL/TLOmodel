<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tlo.methods.postnatal_supervisor &mdash; TLOmodel 0.1.dev2352+gc6f6fd1.d20240105 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=d10597a4" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/theme_overrides.css?v=6ea10ece" />

  
    <link rel="shortcut icon" href="../../../_static/favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=1f52c377"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            TLOmodel
          </a>
              <div class="version">
                0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Welcome</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../aims.html">Aims &amp; Objectives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../writeups.html">Model Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data_sources.html">Data Sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../azure_batch.html">Using Azure Batch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../resources/index.html">Resource files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../background.html">Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributors.html">Contributors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">TLOmodel</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../methods.html">tlo.methods</a></li>
      <li class="breadcrumb-item active">tlo.methods.postnatal_supervisor</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for tlo.methods.postnatal_supervisor</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">tlo</span> <span class="kn">import</span> <span class="n">DateOffset</span><span class="p">,</span> <span class="n">Module</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">,</span> <span class="n">Property</span><span class="p">,</span> <span class="n">Types</span><span class="p">,</span> <span class="n">logging</span><span class="p">,</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">tlo.events</span> <span class="kn">import</span> <span class="n">Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">,</span> <span class="n">RegularEvent</span>
<span class="kn">from</span> <span class="nn">tlo.lm</span> <span class="kn">import</span> <span class="n">LinearModel</span>
<span class="kn">from</span> <span class="nn">tlo.methods</span> <span class="kn">import</span> <span class="n">Metadata</span><span class="p">,</span> <span class="n">postnatal_supervisor_lm</span><span class="p">,</span> <span class="n">pregnancy_helper_functions</span>
<span class="kn">from</span> <span class="nn">tlo.methods.causes</span> <span class="kn">import</span> <span class="n">Cause</span>
<span class="kn">from</span> <span class="nn">tlo.methods.healthsystem</span> <span class="kn">import</span> <span class="n">HSI_Event</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>


<div class="viewcode-block" id="PostnatalSupervisor">
<a class="viewcode-back" href="../../../reference/tlo.methods.postnatal_supervisor.html#tlo.methods.postnatal_supervisor.PostnatalSupervisor">[docs]</a>
<span class="k">class</span> <span class="nc">PostnatalSupervisor</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; This module is responsible for the key conditions/complications experienced by a mother and by a neonate</span>
<span class="sd">    following labour and the immediate postpartum period (this period, from birth to day +1, is covered by the labour</span>
<span class="sd">    module).</span>

<span class="sd">    For mothers: This module applies risk of complications across the postnatal period, which is  defined as birth</span>
<span class="sd">    until day 42 post-delivery. PostnatalWeekOneMaternalEvent represents the first week post birth where risk of</span>
<span class="sd">    complications remains high. The primary mortality causing complications here are infection/sepsis, secondary</span>
<span class="sd">    postpartum haemorrhage and hypertension. Women with or without complications may/may not seek Postnatal Care within</span>
<span class="sd">    the Labour module for assessment and treatment of any complications assigned in this module. Additionally the</span>
<span class="sd">    PostnatalSupervisorEvent applies risk of complications in the following 3 weeks of the postnatal period.</span>

<span class="sd">    For neonates: This module applies risk of complications during the neonatal period, from birth until day 28. The</span>
<span class="sd">    PostnatalWeekOneNeonatalEvent Event applies risk of early onset neonatal sepsis (sepsis onsetting prior to day 7 of</span>
<span class="sd">    life). Care  may be sought (as described above) and neonates can be admitted for treatment. The PostnatalSupervisor</span>
<span class="sd">    Event applies risk of late onset neonatal sepsis from week 2-4 (ending on day 28). This event also determines</span>
<span class="sd">    additional care seeking for neonates who are unwell during this time period. All neonatal variables are reset on</span>
<span class="sd">    day 28.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="PostnatalSupervisor.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.postnatal_supervisor.html#tlo.methods.postnatal_supervisor.PostnatalSupervisor.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resourcefilepath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resourcefilepath</span> <span class="o">=</span> <span class="n">resourcefilepath</span>

        <span class="c1"># First we define dictionaries which will store the current parameters of interest (to allow parameters to</span>
        <span class="c1"># change between 2010 and 2020) and the linear models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_parameters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pn_linear_models</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span></div>


    <span class="n">INIT_DEPENDENCIES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Demography&#39;</span><span class="p">,</span> <span class="s1">&#39;HealthSystem&#39;</span><span class="p">}</span>

    <span class="n">ADDITIONAL_DEPENDENCIES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Labour&#39;</span><span class="p">,</span> <span class="s1">&#39;Lifestyle&#39;</span><span class="p">,</span> <span class="s1">&#39;NewbornOutcomes&#39;</span><span class="p">,</span> <span class="s1">&#39;PregnancySupervisor&#39;</span><span class="p">}</span>

    <span class="n">METADATA</span> <span class="o">=</span> <span class="p">{</span><span class="n">Metadata</span><span class="o">.</span><span class="n">DISEASE_MODULE</span><span class="p">,</span>
                <span class="n">Metadata</span><span class="o">.</span><span class="n">USES_HEALTHSYSTEM</span><span class="p">,</span>
                <span class="n">Metadata</span><span class="o">.</span><span class="n">USES_HEALTHBURDEN</span><span class="p">}</span>  <span class="c1"># declare that this is a disease module (leave as empty set otherwise)</span>

    <span class="c1"># Declare Causes of Death</span>
    <span class="n">CAUSES_OF_DEATH</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;secondary_postpartum_haemorrhage&#39;</span><span class="p">:</span> <span class="n">Cause</span><span class="p">(</span><span class="n">gbd_causes</span><span class="o">=</span><span class="s1">&#39;Maternal disorders&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Maternal Disorders&#39;</span><span class="p">),</span>
        <span class="s1">&#39;postpartum_sepsis&#39;</span><span class="p">:</span> <span class="n">Cause</span><span class="p">(</span><span class="n">gbd_causes</span><span class="o">=</span><span class="s1">&#39;Maternal disorders&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Maternal Disorders&#39;</span><span class="p">),</span>
        <span class="s1">&#39;severe_pre_eclampsia&#39;</span><span class="p">:</span> <span class="n">Cause</span><span class="p">(</span><span class="n">gbd_causes</span><span class="o">=</span><span class="s1">&#39;Maternal disorders&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Maternal Disorders&#39;</span><span class="p">),</span>
        <span class="s1">&#39;eclampsia&#39;</span><span class="p">:</span> <span class="n">Cause</span><span class="p">(</span><span class="n">gbd_causes</span><span class="o">=</span><span class="s1">&#39;Maternal disorders&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Maternal Disorders&#39;</span><span class="p">),</span>
        <span class="s1">&#39;severe_gestational_hypertension&#39;</span><span class="p">:</span> <span class="n">Cause</span><span class="p">(</span><span class="n">gbd_causes</span><span class="o">=</span><span class="s1">&#39;Maternal disorders&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Maternal Disorders&#39;</span><span class="p">),</span>
        <span class="s1">&#39;early_onset_sepsis&#39;</span><span class="p">:</span> <span class="n">Cause</span><span class="p">(</span><span class="n">gbd_causes</span><span class="o">=</span><span class="s1">&#39;Neonatal disorders&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Neonatal Disorders&#39;</span><span class="p">),</span>
        <span class="s1">&#39;late_onset_sepsis&#39;</span><span class="p">:</span> <span class="n">Cause</span><span class="p">(</span><span class="n">gbd_causes</span><span class="o">=</span><span class="s1">&#39;Neonatal disorders&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Neonatal Disorders&#39;</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="c1"># Declare Causes of Disability</span>
    <span class="n">CAUSES_OF_DISABILITY</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;maternal&#39;</span><span class="p">:</span> <span class="n">Cause</span><span class="p">(</span><span class="n">gbd_causes</span><span class="o">=</span><span class="s1">&#39;Maternal disorders&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Maternal Disorders&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">PARAMETERS</span> <span class="o">=</span> <span class="p">{</span>

        <span class="c1"># n.b. Parameters are stored as LIST variables due to containing values to match both 2010 and 2015 data.</span>

        <span class="c1"># OBSTETRIC FISTULA</span>
        <span class="s1">&#39;prob_obstetric_fistula&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;probability of a woman developing an obstetric fistula after birth&#39;</span><span class="p">),</span>
        <span class="s1">&#39;rr_obstetric_fistula_obstructed_labour&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;relative risk of obstetric fistula in women who experienced obstructed labour&#39;</span><span class="p">),</span>
        <span class="s1">&#39;prevalence_type_of_fistula&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;prevalence of 1.) vesicovaginal 2.)rectovaginal fistula &#39;</span><span class="p">),</span>

        <span class="c1"># SECONDARY POSTPARTUM HAEMORRHAGE</span>
        <span class="s1">&#39;prob_secondary_pph&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;baseline probability of secondary PPH&#39;</span><span class="p">),</span>
        <span class="s1">&#39;rr_secondary_pph_endometritis&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;relative risk of secondary postpartum haemorrhage in women with sepsis secondary to &#39;</span>
                        <span class="s1">&#39;endometritis&#39;</span><span class="p">),</span>
        <span class="s1">&#39;prob_secondary_pph_severity&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;probability of mild, moderate or severe secondary PPH&#39;</span><span class="p">),</span>
        <span class="s1">&#39;cfr_secondary_postpartum_haemorrhage&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;case fatality rate for secondary pph&#39;</span><span class="p">),</span>
        <span class="s1">&#39;rr_death_from_pph_with_anaemia&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;relative risk of death from PPH in women with anaemia&#39;</span><span class="p">),</span>

        <span class="c1"># HYPERTENSIVE DISORDERS</span>
        <span class="s1">&#39;prob_htn_resolves&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;Weekly probability of resolution of hypertension&#39;</span><span class="p">),</span>
        <span class="s1">&#39;weekly_prob_gest_htn_pn&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;weekly probability of a woman developing gestational hypertension during the postnatal &#39;</span>
                        <span class="s1">&#39;period&#39;</span><span class="p">),</span>
        <span class="s1">&#39;rr_gest_htn_obesity&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;Relative risk of gestational hypertension for women who are obese&#39;</span><span class="p">),</span>
        <span class="s1">&#39;prob_pre_eclampsia_per_month&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;underlying risk of pre-eclampsia per month without the impact of risk factors&#39;</span><span class="p">),</span>
        <span class="s1">&#39;weekly_prob_pre_eclampsia_pn&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;weekly probability of a woman developing mild pre-eclampsia during the postnatal period&#39;</span><span class="p">),</span>
        <span class="s1">&#39;rr_pre_eclampsia_obesity&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;Relative risk of pre-eclampsia for women who are obese&#39;</span><span class="p">),</span>
        <span class="s1">&#39;rr_pre_eclampsia_chronic_htn&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;Relative risk of pre-eclampsia in women who are chronically hypertensive&#39;</span><span class="p">),</span>
        <span class="s1">&#39;rr_pre_eclampsia_diabetes_mellitus&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;Relative risk of pre-eclampsia in women who have diabetes mellitus&#39;</span><span class="p">),</span>
        <span class="s1">&#39;probs_for_mgh_matrix_pn&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;probability of mild gestational hypertension moving between states: gestational &#39;</span>
                        <span class="s1">&#39;hypertension, severe gestational hypertension, mild pre-eclampsia, severe pre-eclampsia, &#39;</span>
                        <span class="s1">&#39;eclampsia&#39;</span><span class="p">),</span>
        <span class="s1">&#39;probs_for_sgh_matrix_pn&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;probability of severe gestational hypertension moving between states: gestational &#39;</span>
                        <span class="s1">&#39;hypertension, severe gestational hypertension, mild pre-eclampsia, severe pre-eclampsia, &#39;</span>
                        <span class="s1">&#39;eclampsia&#39;</span><span class="p">),</span>
        <span class="s1">&#39;probs_for_mpe_matrix_pn&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;probability of mild pre-eclampsia moving between states: gestational &#39;</span>
                        <span class="s1">&#39;hypertension, severe gestational hypertension, mild pre-eclampsia, severe pre-eclampsia, &#39;</span>
                        <span class="s1">&#39;eclampsia&#39;</span><span class="p">),</span>
        <span class="s1">&#39;probs_for_spe_matrix_pn&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;probability of severe pre-eclampsia moving between states: gestational &#39;</span>
                        <span class="s1">&#39;hypertension, severe gestational hypertension, mild pre-eclampsia, severe pre-eclampsia, &#39;</span>
                        <span class="s1">&#39;eclampsia&#39;</span><span class="p">),</span>
        <span class="s1">&#39;probs_for_ec_matrix_pn&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;probability of eclampsia moving between states: gestational hypertension, &#39;</span>
                        <span class="s1">&#39;severe gestational hypertension, mild pre-eclampsia, severe pre-eclampsia, &#39;</span>
                        <span class="s1">&#39;eclampsia&#39;</span><span class="p">),</span>
        <span class="s1">&#39;cfr_eclampsia&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;case fatality rate of eclampsia in the postnatal period&#39;</span><span class="p">),</span>
        <span class="s1">&#39;cfr_severe_pre_eclampsia&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;case fatality rate of severe pre-eclampsia in the postnatal period&#39;</span><span class="p">),</span>
        <span class="s1">&#39;weekly_prob_death_severe_gest_htn&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;weekly risk of death from  severe hypertension in the postnatal period&#39;</span><span class="p">),</span>

        <span class="c1"># ANAEMIA</span>
        <span class="s1">&#39;baseline_prob_anaemia_per_week&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;Weekly probability of anaemia in pregnancy&#39;</span><span class="p">),</span>
        <span class="s1">&#39;rr_anaemia_maternal_malaria&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;relative risk of anaemia secondary to malaria infection&#39;</span><span class="p">),</span>
        <span class="s1">&#39;rr_anaemia_recent_haemorrhage&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;relative risk of anaemia secondary to recent haemorrhage&#39;</span><span class="p">),</span>
        <span class="s1">&#39;rr_anaemia_hiv_no_art&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;relative risk of anaemia for a woman with HIV not on ART&#39;</span><span class="p">),</span>
        <span class="s1">&#39;prob_type_of_anaemia_pn&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;probability of a woman with anaemia having mild, moderate or severe anaemia&#39;</span><span class="p">),</span>

        <span class="c1"># MATERNAL SEPSIS</span>
        <span class="s1">&#39;prob_late_sepsis_endometritis&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;probability of developing sepsis following postpartum endometritis infection&#39;</span><span class="p">),</span>
        <span class="s1">&#39;rr_sepsis_endometritis_post_cs&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;relative risk of endometritis following caesarean delivery&#39;</span><span class="p">),</span>
        <span class="s1">&#39;prob_late_sepsis_urinary_tract&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;probability of developing sepsis following postpartum UTI&#39;</span><span class="p">),</span>
        <span class="s1">&#39;prob_late_sepsis_skin_soft_tissue&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;probability of developing sepsis following postpartum skin/soft tissue infection&#39;</span><span class="p">),</span>
        <span class="s1">&#39;rr_sepsis_sst_post_cs&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;relative risk of skin/soft tissue sepsis following caesarean delivery&#39;</span><span class="p">),</span>
        <span class="s1">&#39;cfr_postpartum_sepsis&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;case fatality rate for postnatal sepsis&#39;</span><span class="p">),</span>

        <span class="c1"># NEWBORN SEPSIS</span>
        <span class="s1">&#39;prob_early_onset_neonatal_sepsis_week_1&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;Baseline probability of a newborn developing sepsis in week one of life&#39;</span><span class="p">),</span>
        <span class="s1">&#39;rr_eons_maternal_chorio&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;relative risk of EONS in newborns whose mothers have chorioamnionitis&#39;</span><span class="p">),</span>
        <span class="s1">&#39;rr_eons_maternal_prom&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;relative risk of EONS in newborns whose mothers have PROM&#39;</span><span class="p">),</span>
        <span class="s1">&#39;rr_eons_preterm_neonate&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;relative risk of EONS in preterm newborns&#39;</span><span class="p">),</span>
        <span class="s1">&#39;cfr_early_onset_neonatal_sepsis&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;case fatality for early onset neonatal sepsis&#39;</span><span class="p">),</span>
        <span class="s1">&#39;prob_late_onset_neonatal_sepsis&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;probability of late onset neonatal sepsis (all cause)&#39;</span><span class="p">),</span>
        <span class="s1">&#39;cfr_late_neonatal_sepsis&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;Risk of death from late neonatal sepsis&#39;</span><span class="p">),</span>
        <span class="s1">&#39;prob_sepsis_disabilities&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;Probabilities of varying disability levels after neonatal sepsis&#39;</span><span class="p">),</span>

        <span class="c1"># CARE SEEKING</span>
        <span class="s1">&#39;prob_care_seeking_postnatal_emergency&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;baseline probability of emergency care seeking for women in the postnatal period&#39;</span><span class="p">),</span>
        <span class="s1">&#39;prob_care_seeking_postnatal_emergency_neonate&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;baseline probability care will be sought for a neonate with a complication&#39;</span><span class="p">),</span>
        <span class="s1">&#39;odds_care_seeking_fistula_repair&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;odds of a woman seeking care for treatment of obstetric fistula&#39;</span><span class="p">),</span>
        <span class="s1">&#39;aor_cs_fistula_age_15_19&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;odds ratio for care seeking for treatment of obstetric fistula in 15-19 year olds&#39;</span><span class="p">),</span>
        <span class="s1">&#39;aor_cs_fistula_age_lowest_education&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;odds ratio for care seeking for treatment of obstetric fistula in women in the lowest &#39;</span>
                        <span class="s1">&#39;education quantile&#39;</span><span class="p">),</span>

        <span class="c1"># TREATMENT EFFECTS</span>
        <span class="s1">&#39;treatment_effect_early_init_bf&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;effect of early initiation of breastfeeding on neonatal sepsis rates &#39;</span><span class="p">),</span>
        <span class="s1">&#39;treatment_effect_iron_folic_acid_anaemia&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;effect of iron and folic acid supplementation on anaemia risk&#39;</span><span class="p">),</span>
        <span class="s1">&#39;treatment_effect_abx_prom&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;effect of early antibiotics given to a mother with PROM on neonatal sepsis rates &#39;</span><span class="p">),</span>
        <span class="s1">&#39;treatment_effect_clean_birth&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;Treatment effect of clean birth practices on early onset neonatal sepsis risk&#39;</span><span class="p">),</span>
        <span class="s1">&#39;treatment_effect_cord_care&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;Treatment effect of chlorhexidine cord care on early onset neonatal sepsis risk&#39;</span><span class="p">),</span>
        <span class="s1">&#39;treatment_effect_anti_htns_progression_pn&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s1">&#39;Treatment effect of oral anti hypertensives on progression from mild/mod to severe gestational&#39;</span>
                        <span class="s1">&#39;hypertension&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">PROPERTIES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;pn_postnatal_period_in_weeks&#39;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s1">&#39;The number of weeks a woman is in the postnatal period &#39;</span>
                                                             <span class="s1">&#39;(1-6)&#39;</span><span class="p">),</span>
        <span class="s1">&#39;pn_htn_disorders&#39;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">CATEGORICAL</span><span class="p">,</span> <span class="s1">&#39;Hypertensive disorders of the postnatal period&#39;</span><span class="p">,</span>
                                     <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;resolved&#39;</span><span class="p">,</span> <span class="s1">&#39;gest_htn&#39;</span><span class="p">,</span> <span class="s1">&#39;severe_gest_htn&#39;</span><span class="p">,</span> <span class="s1">&#39;mild_pre_eclamp&#39;</span><span class="p">,</span>
                                                 <span class="s1">&#39;severe_pre_eclamp&#39;</span><span class="p">,</span> <span class="s1">&#39;eclampsia&#39;</span><span class="p">]),</span>
        <span class="s1">&#39;pn_postpartum_haem_secondary&#39;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span> <span class="s1">&#39;Whether this woman is experiencing a secondary &#39;</span>
                                                             <span class="s1">&#39;postpartum haemorrhage&#39;</span><span class="p">),</span>
        <span class="s1">&#39;pn_sepsis_late_postpartum&#39;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span> <span class="s1">&#39;Whether this woman is experiencing postnatal (day7+) &#39;</span>
                                                          <span class="s1">&#39;sepsis&#39;</span><span class="p">),</span>
        <span class="s1">&#39;pn_obstetric_fistula&#39;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">CATEGORICAL</span><span class="p">,</span> <span class="s1">&#39;Type of fistula developed after birth&#39;</span><span class="p">,</span>
                                         <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;vesicovaginal&#39;</span><span class="p">,</span> <span class="s1">&#39;rectovaginal&#39;</span><span class="p">]),</span>
        <span class="s1">&#39;pn_sepsis_early_neonatal&#39;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span> <span class="s1">&#39;Whether this neonate has developed early onset neonatal&#39;</span>
                                                         <span class="s1">&#39; sepsis during week one of life&#39;</span><span class="p">),</span>
        <span class="s1">&#39;pn_sepsis_late_neonatal&#39;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span> <span class="s1">&#39;Whether this neonate has developed late neonatal sepsis &#39;</span>
                                                        <span class="s1">&#39;following discharge&#39;</span><span class="p">),</span>
        <span class="s1">&#39;pn_neonatal_sepsis_disab&#39;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">CATEGORICAL</span><span class="p">,</span> <span class="s1">&#39;Level of disability experience from a neonate post &#39;</span>
                                                                <span class="s1">&#39;sepsis&#39;</span><span class="p">,</span> <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;mild_motor_and_cog&#39;</span><span class="p">,</span>
                                                                                      <span class="s1">&#39;mild_motor&#39;</span><span class="p">,</span> <span class="s1">&#39;moderate_motor&#39;</span><span class="p">,</span>
                                                                                      <span class="s1">&#39;severe_motor&#39;</span><span class="p">]),</span>
        <span class="s1">&#39;pn_deficiencies_following_pregnancy&#39;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span> <span class="s1">&#39;bitset column, stores types of anaemia causing &#39;</span>
                                                                   <span class="s1">&#39;deficiencies following pregnancy&#39;</span><span class="p">),</span>
        <span class="s1">&#39;pn_anaemia_following_pregnancy&#39;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">CATEGORICAL</span><span class="p">,</span> <span class="s1">&#39;severity of anaemia following pregnancy&#39;</span><span class="p">,</span>
                                                   <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;mild&#39;</span><span class="p">,</span> <span class="s1">&#39;moderate&#39;</span><span class="p">,</span> <span class="s1">&#39;severe&#39;</span><span class="p">]),</span>
        <span class="s1">&#39;pn_emergency_event_mother&#39;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span> <span class="s1">&#39;Whether a mother is experiencing an emergency complication&#39;</span>
                                                          <span class="s1">&#39; postnatally&#39;</span><span class="p">),</span>
    <span class="p">}</span>

<div class="viewcode-block" id="PostnatalSupervisor.read_parameters">
<a class="viewcode-back" href="../../../reference/tlo.methods.postnatal_supervisor.html#tlo.methods.postnatal_supervisor.PostnatalSupervisor.read_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">read_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_folder</span><span class="p">):</span>
        <span class="n">parameter_dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resourcefilepath</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;ResourceFile_PostnatalSupervisor.xlsx&#39;</span><span class="p">,</span>
                                            <span class="n">sheet_name</span><span class="o">=</span><span class="s1">&#39;parameter_values&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_parameters_from_dataframe</span><span class="p">(</span><span class="n">parameter_dataframe</span><span class="p">)</span></div>


<div class="viewcode-block" id="PostnatalSupervisor.initialise_population">
<a class="viewcode-back" href="../../../reference/tlo.methods.postnatal_supervisor.html#tlo.methods.postnatal_supervisor.PostnatalSupervisor.initialise_population">[docs]</a>
    <span class="k">def</span> <span class="nf">initialise_population</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s1">&#39;pn_postnatal_period_in_weeks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s1">&#39;pn_htn_disorders&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s1">&#39;pn_postpartum_haem_secondary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s1">&#39;pn_sepsis_late_postpartum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s1">&#39;pn_neonatal_sepsis_disab&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s1">&#39;pn_sepsis_early_neonatal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s1">&#39;pn_sepsis_late_neonatal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s1">&#39;pn_sepsis_late_neonatal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s1">&#39;pn_anaemia_following_pregnancy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s1">&#39;pn_obstetric_fistula&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s1">&#39;pn_emergency_event_mother&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="PostnatalSupervisor.initialise_simulation">
<a class="viewcode-back" href="../../../reference/tlo.methods.postnatal_supervisor.html#tlo.methods.postnatal_supervisor.PostnatalSupervisor.initialise_simulation">[docs]</a>
    <span class="k">def</span> <span class="nf">initialise_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span><span class="p">):</span>
        <span class="c1"># For the first period (2010-2015) we use the first value in each list as a parameter</span>
        <span class="n">pregnancy_helper_functions</span><span class="o">.</span><span class="n">update_current_parameter_dictionary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">list_position</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Schedule the first instance of the PostnatalSupervisorEvent</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">PostnatalSupervisorEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                           <span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="c1"># Register dx_tests used as assessment for postnatal conditions during PNC visits</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_parameters</span>

        <span class="c1"># ======================================= LINEAR MODEL EQUATIONS =============================================</span>
        <span class="c1"># All linear equations used in this module are stored within the pn_linear_equations</span>
        <span class="c1"># parameter below</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pn_linear_models</span> <span class="o">=</span> <span class="p">{</span>

            <span class="c1"># This equation is used to determine a mothers risk of developing obstetric fistula after birth</span>
            <span class="s1">&#39;obstetric_fistula&#39;</span><span class="p">:</span> <span class="n">LinearModel</span><span class="o">.</span><span class="n">custom</span><span class="p">(</span><span class="n">postnatal_supervisor_lm</span><span class="o">.</span><span class="n">predict_obstetric_fistula</span><span class="p">,</span>
                                                    <span class="n">parameters</span><span class="o">=</span><span class="n">params</span><span class="p">),</span>

            <span class="c1"># This equation is used to determine a mothers risk of secondary postpartum haemorrhage</span>
            <span class="s1">&#39;secondary_postpartum_haem&#39;</span><span class="p">:</span> <span class="n">LinearModel</span><span class="o">.</span><span class="n">custom</span><span class="p">(</span><span class="n">postnatal_supervisor_lm</span><span class="o">.</span><span class="n">predict_secondary_postpartum_haem</span><span class="p">,</span>
                                                            <span class="n">parameters</span><span class="o">=</span><span class="n">params</span><span class="p">),</span>

            <span class="c1"># This equation is used to determine a mothers risk of developing a sepsis secondary to endometritis</span>
            <span class="s1">&#39;sepsis_endometritis_late_postpartum&#39;</span><span class="p">:</span> <span class="n">LinearModel</span><span class="o">.</span><span class="n">custom</span><span class="p">(</span>
                <span class="n">postnatal_supervisor_lm</span><span class="o">.</span><span class="n">predict_sepsis_endometritis_late_postpartum</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">params</span><span class="p">),</span>

            <span class="c1"># This equation is used to determine a mothers risk of developing sepsis secondary to skin or soft tissue</span>
            <span class="c1"># infection</span>
            <span class="s1">&#39;sepsis_sst_late_postpartum&#39;</span><span class="p">:</span> <span class="n">LinearModel</span><span class="o">.</span><span class="n">custom</span><span class="p">(</span>
                <span class="n">postnatal_supervisor_lm</span><span class="o">.</span><span class="n">predict_sepsis_sst_late_postpartum</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">params</span><span class="p">),</span>

            <span class="c1"># This equation is used to determine a mothers risk of developing gestational hypertension in the postnatal</span>
            <span class="c1"># period</span>
            <span class="s1">&#39;gest_htn_pn&#39;</span><span class="p">:</span> <span class="n">LinearModel</span><span class="o">.</span><span class="n">custom</span><span class="p">(</span><span class="n">postnatal_supervisor_lm</span><span class="o">.</span><span class="n">predict_gest_htn_pn</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">params</span><span class="p">),</span>

            <span class="c1"># This equation is used to determine a mothers risk of developing pre-eclampsia in in the postnatal</span>
            <span class="c1"># period</span>
            <span class="s1">&#39;pre_eclampsia_pn&#39;</span><span class="p">:</span> <span class="n">LinearModel</span><span class="o">.</span><span class="n">custom</span><span class="p">(</span><span class="n">postnatal_supervisor_lm</span><span class="o">.</span><span class="n">predict_pre_eclampsia_pn</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="p">),</span>

            <span class="c1"># This equation is used to determine a mothers risk of developing anaemia postnatal</span>
            <span class="s1">&#39;anaemia_after_pregnancy&#39;</span><span class="p">:</span> <span class="n">LinearModel</span><span class="o">.</span><span class="n">custom</span><span class="p">(</span><span class="n">postnatal_supervisor_lm</span><span class="o">.</span><span class="n">predict_anaemia_after_pregnancy</span><span class="p">,</span>
                                                          <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="p">),</span>

            <span class="c1"># This equation is used to determine a neonates risk of developing early onset neonatal sepsis</span>
            <span class="c1"># (sepsis onsetting prior to day 7) in the first week of life</span>
            <span class="s1">&#39;early_onset_neonatal_sepsis_week_1&#39;</span><span class="p">:</span> <span class="n">LinearModel</span><span class="o">.</span><span class="n">custom</span><span class="p">(</span>
                <span class="n">postnatal_supervisor_lm</span><span class="o">.</span><span class="n">predict_early_onset_neonatal_sepsis_week_1</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">params</span><span class="p">),</span>

            <span class="c1"># This equation is used to determine a neonates risk of developing late onset neonatal sepsis</span>
            <span class="c1"># (sepsis onsetting between 7 and day 28) after  the first week of life</span>
            <span class="s1">&#39;late_onset_neonatal_sepsis&#39;</span><span class="p">:</span> <span class="n">LinearModel</span><span class="o">.</span><span class="n">custom</span><span class="p">(</span>
                <span class="n">postnatal_supervisor_lm</span><span class="o">.</span><span class="n">predict_late_onset_neonatal_sepsis</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">params</span><span class="p">),</span>

            <span class="c1"># This equation is used to determine if a mother will seek care for treatment for her obstetric fistula</span>
            <span class="s1">&#39;care_seeking_for_fistula_repair&#39;</span><span class="p">:</span> <span class="n">LinearModel</span><span class="o">.</span><span class="n">custom</span><span class="p">(</span>
                <span class="n">postnatal_supervisor_lm</span><span class="o">.</span><span class="n">predict_care_seeking_for_fistula_repair</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">params</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="s1">&#39;Hiv&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s1">&#39;HIV module is not registered in this simulation run and therefore HIV &#39;</span>
                                             <span class="s1">&#39;testing will not happen in postnatal care&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="PostnatalSupervisor.on_birth">
<a class="viewcode-back" href="../../../reference/tlo.methods.postnatal_supervisor.html#tlo.methods.postnatal_supervisor.PostnatalSupervisor.on_birth">[docs]</a>
    <span class="k">def</span> <span class="nf">on_birth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mother_id</span><span class="p">,</span> <span class="n">child_id</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s1">&#39;pn_postnatal_period_in_weeks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s1">&#39;pn_htn_disorders&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s1">&#39;pn_postpartum_haem_secondary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s1">&#39;pn_sepsis_late_postpartum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s1">&#39;pn_sepsis_early_neonatal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s1">&#39;pn_sepsis_late_neonatal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s1">&#39;pn_neonatal_sepsis_disab&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s1">&#39;pn_obstetric_fistula&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s1">&#39;pn_anaemia_following_pregnancy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s1">&#39;pn_emergency_event_mother&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="PostnatalSupervisor.further_on_birth_postnatal_supervisor">
<a class="viewcode-back" href="../../../reference/tlo.methods.postnatal_supervisor.html#tlo.methods.postnatal_supervisor.PostnatalSupervisor.further_on_birth_postnatal_supervisor">[docs]</a>
    <span class="k">def</span> <span class="nf">further_on_birth_postnatal_supervisor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mother_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function is called by the on_birth function of NewbornOutcomes module or following an intrapartum</span>
<span class="sd">        stillbirth in the Labour Module. This function contains additional code related to the postnatal supervisor</span>
<span class="sd">        module that should be ran on_birth. These additional on_birth functions ensure each modules</span>
<span class="sd">        (pregnancy,antenatal care, labour, newborn, postnatal) on_birth code is ran in the correct sequence</span>
<span class="sd">        (as this can vary depending on how modules are registered)</span>
<span class="sd">        :param mother_id: mothers individual id</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_parameters</span>
        <span class="n">store_dalys_in_mni</span> <span class="o">=</span> <span class="n">pregnancy_helper_functions</span><span class="o">.</span><span class="n">store_dalys_in_mni</span>
        <span class="n">mni</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;PregnancySupervisor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mother_and_newborn_info</span>

        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">mother_id</span><span class="p">,</span> <span class="s1">&#39;is_alive&#39;</span><span class="p">]:</span>

            <span class="c1"># Here we determine if, following childbirth, this woman will develop a fistula</span>
            <span class="n">risk_of_fistula</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pn_linear_models</span><span class="p">[</span>
                <span class="s1">&#39;obstetric_fistula&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">mother_id</span><span class="p">]])[</span><span class="n">mother_id</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">risk_of_fistula</span><span class="p">:</span>
                <span class="c1"># We determine the specific type of fistula this woman is experiencing, to match with DALY weights</span>
                <span class="n">fistula_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s1">&#39;vesicovaginal&#39;</span><span class="p">,</span> <span class="s1">&#39;rectovaginal&#39;</span><span class="p">],</span>
                                               <span class="n">p</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;prevalence_type_of_fistula&#39;</span><span class="p">])</span>
                <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">mother_id</span><span class="p">,</span> <span class="s1">&#39;pn_obstetric_fistula&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fistula_type</span>

                <span class="c1"># Store the onset weight for daly calculations</span>
                <span class="n">store_dalys_in_mni</span><span class="p">(</span><span class="n">mother_id</span><span class="p">,</span> <span class="n">mni</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fistula_type</span><span class="si">}</span><span class="s1">_fistula_onset&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;maternal_complication&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;person&#39;</span><span class="p">:</span> <span class="n">mother_id</span><span class="p">,</span>
                                                               <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fistula_type</span><span class="si">}</span><span class="s1">_fistula&#39;</span><span class="p">,</span>
                                                               <span class="s1">&#39;timing&#39;</span><span class="p">:</span> <span class="s1">&#39;postnatal&#39;</span><span class="p">})</span>

                <span class="c1"># Determine if she will seek care for repair</span>
                <span class="n">care_seeking_for_repair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pn_linear_models</span><span class="p">[</span>
                    <span class="s1">&#39;care_seeking_for_fistula_repair&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">mother_id</span><span class="p">]])[</span><span class="n">mother_id</span><span class="p">]</span>

                <span class="c1"># Schedule repair to occur for 1 week postnatal</span>
                <span class="k">if</span> <span class="n">care_seeking_for_repair</span><span class="p">:</span>
                    <span class="n">repair_hsi</span> <span class="o">=</span> <span class="n">HSI_PostnatalSupervisor_TreatmentForObstetricFistula</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">mother_id</span><span class="p">)</span>
                    <span class="n">repair_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">42</span><span class="p">)))</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span><span class="n">repair_hsi</span><span class="p">,</span>
                                                                        <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                                        <span class="n">topen</span><span class="o">=</span><span class="n">repair_date</span><span class="p">,</span>
                                                                        <span class="n">tclose</span><span class="o">=</span><span class="n">repair_date</span> <span class="o">+</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">))</span>

            <span class="c1"># ======================= CONTINUATION OF COMPLICATIONS INTO THE POSTNATAL PERIOD =========================</span>
            <span class="c1"># Certain conditions experienced in pregnancy are liable to continue into the postnatal period</span>

            <span class="c1"># HYPERTENSIVE DISORDERS...</span>
            <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">mother_id</span><span class="p">,</span> <span class="s1">&#39;ps_htn_disorders&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">mother_id</span><span class="p">,</span> <span class="s1">&#39;pn_htn_disorders&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">mother_id</span><span class="p">,</span> <span class="s1">&#39;ps_htn_disorders&#39;</span><span class="p">]</span>

            <span class="c1">#  ANAEMIA...</span>
            <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">mother_id</span><span class="p">,</span> <span class="s1">&#39;ps_anaemia_in_pregnancy&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">mother_id</span><span class="p">,</span> <span class="s1">&#39;pn_anaemia_following_pregnancy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">mother_id</span><span class="p">,</span> <span class="s1">&#39;ps_anaemia_in_pregnancy&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="PostnatalSupervisor.on_hsi_alert">
<a class="viewcode-back" href="../../../reference/tlo.methods.postnatal_supervisor.html#tlo.methods.postnatal_supervisor.PostnatalSupervisor.on_hsi_alert">[docs]</a>
    <span class="k">def</span> <span class="nf">on_hsi_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">treatment_id</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;This is PostnatalSupervisor, being alerted about a health system &#39;</span>
                                         <span class="sa">f</span><span class="s1">&#39;interaction person </span><span class="si">{</span><span class="n">person_id</span><span class="si">}</span><span class="s1"> for: </span><span class="si">{</span><span class="n">treatment_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="PostnatalSupervisor.report_daly_values">
<a class="viewcode-back" href="../../../reference/tlo.methods.postnatal_supervisor.html#tlo.methods.postnatal_supervisor.PostnatalSupervisor.report_daly_values">[docs]</a>
    <span class="k">def</span> <span class="nf">report_daly_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s1">&#39;This is PostnatalSupervisor reporting my health values&#39;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="n">daly_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">daly_series</span></div>


<div class="viewcode-block" id="PostnatalSupervisor.apply_linear_model">
<a class="viewcode-back" href="../../../reference/tlo.methods.postnatal_supervisor.html#tlo.methods.postnatal_supervisor.PostnatalSupervisor.apply_linear_model">[docs]</a>
    <span class="k">def</span> <span class="nf">apply_linear_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function will apply the linear model (lm) on the dataframe (df) to get a probability of some event</span>
<span class="sd">        happening to each individual. It then returns a series with same index with bools indicating the outcome based</span>
<span class="sd">        on the toss of the biased coin.</span>
<span class="sd">        :param lm: The linear model</span>
<span class="sd">        :param df: The dataframe</span>
<span class="sd">        :return: Series with same index containing outcomes (bool)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mni</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;PregnancySupervisor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mother_and_newborn_info</span>
        <span class="n">mni_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">mni</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>

        <span class="c1"># Here we define the external variables as series to pass to the linear model</span>
        <span class="n">mode_of_delivery</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">received_abx_for_prom</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">endometritis</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">chorio_in_preg</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;mode_of_delivery&#39;</span> <span class="ow">in</span> <span class="n">mni_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">mode_of_delivery</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">mni_df</span><span class="p">[</span><span class="s1">&#39;mode_of_delivery&#39;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;abx_for_prom_given&#39;</span> <span class="ow">in</span> <span class="n">mni_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">received_abx_for_prom</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">mni_df</span><span class="p">[</span><span class="s1">&#39;abx_for_prom_given&#39;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;chorio_in_preg&#39;</span> <span class="ow">in</span> <span class="n">mni_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">chorio_in_preg</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">mni_df</span><span class="p">[</span><span class="s1">&#39;chorio_in_preg&#39;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;endo_pp&#39;</span> <span class="ow">in</span> <span class="n">mni_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">endometritis</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">mni_df</span><span class="p">[</span><span class="s1">&#39;endo_pp&#39;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="n">maternal_prom</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ps_premature_rupture_of_membranes&#39;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">lm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="p">,</span>
                                                            <span class="n">mode_of_delivery</span><span class="o">=</span><span class="n">mode_of_delivery</span><span class="p">,</span>
                                                            <span class="n">received_abx_for_prom</span><span class="o">=</span><span class="n">received_abx_for_prom</span><span class="p">,</span>
                                                            <span class="n">maternal_prom</span><span class="o">=</span><span class="n">maternal_prom</span><span class="p">,</span>
                                                            <span class="n">endometritis</span><span class="o">=</span><span class="n">endometritis</span><span class="p">,</span>
                                                            <span class="n">maternal_chorioamnionitis</span><span class="o">=</span><span class="n">chorio_in_preg</span><span class="p">,</span>
                                                            <span class="p">)</span></div>


<div class="viewcode-block" id="PostnatalSupervisor.set_postnatal_complications_mothers">
<a class="viewcode-back" href="../../../reference/tlo.methods.postnatal_supervisor.html#tlo.methods.postnatal_supervisor.PostnatalSupervisor.set_postnatal_complications_mothers">[docs]</a>
    <span class="k">def</span> <span class="nf">set_postnatal_complications_mothers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">week</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function is called by the PostnatalSupervisor event. It applies risk of key complications to a subset of</span>
<span class="sd">        women during each week of the postnatal period starting from week 2. Currently this includes sepsis,</span>
<span class="sd">        anaemia and hypertension</span>
<span class="sd">        :param week: week in the postnatal period used to select women in the data frame.</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_parameters</span>
        <span class="n">store_dalys_in_mni</span> <span class="o">=</span> <span class="n">pregnancy_helper_functions</span><span class="o">.</span><span class="n">store_dalys_in_mni</span>
        <span class="n">mni</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;PregnancySupervisor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mother_and_newborn_info</span>

        <span class="k">def</span> <span class="nf">onset</span><span class="p">(</span><span class="n">eq</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Runs a specific equation within the linear model for the appropriate subset of women in the postnatal period</span>
<span class="sd">             and returns a BOOL series</span>
<span class="sd">            :param eq: linear model equation</span>
<span class="sd">            :return: BOOL series</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">onset_condition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_linear_model</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pn_linear_models</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">eq</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">],</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;is_alive&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;la_is_postpartum&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;pn_postnatal_period_in_weeks&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">week</span><span class="p">)</span> <span class="o">&amp;</span>
                       <span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;hs_is_inpatient&#39;</span><span class="p">]])</span>
            <span class="k">return</span> <span class="n">onset_condition</span>

        <span class="c1"># -------------------------------------- SEPSIS --------------------------------------------------------------</span>
        <span class="c1"># We apply risk of developing sepsis after either endometritits, urinary tract or skin/soft tissue infection.</span>
        <span class="c1"># If sepsis develops then the mother may choose to seek care</span>

        <span class="c1"># Apply linear model to determine risk of sepsis secondary to these two infections</span>
        <span class="n">onset_sepsis_endo</span> <span class="o">=</span> <span class="n">onset</span><span class="p">(</span><span class="s1">&#39;sepsis_endometritis_late_postpartum&#39;</span><span class="p">)</span>
        <span class="n">onset_sepsis_sst</span> <span class="o">=</span> <span class="n">onset</span><span class="p">(</span><span class="s1">&#39;sepsis_sst_late_postpartum&#39;</span><span class="p">)</span>

        <span class="c1"># Risk of urinary sepsis is currently a fixed parameter so we apply that risk here</span>
        <span class="n">at_sepsis_urinary</span> <span class="o">=</span> \
            <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">la_is_postpartum</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pn_postnatal_period_in_weeks</span> <span class="o">==</span> <span class="n">week</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">hs_is_inpatient</span>

        <span class="n">onset_sepsis_urinary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">at_sepsis_urinary</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">at_sepsis_urinary</span><span class="p">]))</span> <span class="o">&lt;</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;prob_late_sepsis_urinary_tract&#39;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">at_sepsis_urinary</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">at_sepsis_urinary</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="c1"># Iterate over each collection of women who will develop sepsis due to one of these reasons and update the</span>
        <span class="c1"># appropriate variables</span>
        <span class="k">for</span> <span class="n">index_slice</span> <span class="ow">in</span> <span class="p">[</span><span class="n">onset_sepsis_endo</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">onset_sepsis_endo</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                            <span class="n">onset_sepsis_sst</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">onset_sepsis_sst</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                            <span class="n">onset_sepsis_urinary</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">onset_sepsis_urinary</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">]:</span>

            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index_slice</span><span class="p">,</span> <span class="s1">&#39;pn_sepsis_late_postpartum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index_slice</span><span class="p">,</span> <span class="s1">&#39;pn_emergency_event_mother&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Women with sepsis secondary to endometritis have this mni variable updated as it will function as a predictor</span>
        <span class="c1"># in a linear model</span>
        <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">onset_sepsis_endo</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">onset_sepsis_endo</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">mni</span><span class="p">[</span><span class="n">person</span><span class="p">][</span><span class="s1">&#39;endo_pp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Log the complication for analysis</span>

        <span class="n">new_sepsis</span> <span class="o">=</span> \
            <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">la_is_postpartum</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pn_postnatal_period_in_weeks</span> <span class="o">==</span> <span class="n">week</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">hs_is_inpatient</span> <span class="o">&amp;</span> \
            <span class="n">df</span><span class="o">.</span><span class="n">pn_sepsis_late_postpartum</span>

        <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">new_sepsis</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">new_sepsis</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">store_dalys_in_mni</span><span class="p">(</span><span class="n">person</span><span class="p">,</span> <span class="n">mni</span><span class="p">,</span> <span class="s1">&#39;sepsis_onset&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;maternal_complication&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;person&#39;</span><span class="p">:</span> <span class="n">person</span><span class="p">,</span>
                                                           <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;sepsis&#39;</span><span class="p">,</span>
                                                           <span class="s1">&#39;timing&#39;</span><span class="p">:</span> <span class="s1">&#39;postnatal&#39;</span><span class="p">})</span>

        <span class="c1"># ------------------------------------ SECONDARY PPH ----------------------------------------------------------</span>
        <span class="c1"># Next we determine if any women will experience postnatal bleeding</span>
        <span class="n">onset_pph</span> <span class="o">=</span> <span class="n">onset</span><span class="p">(</span><span class="s1">&#39;secondary_postpartum_haem&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">onset_pph</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">onset_pph</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;pn_postpartum_haem_secondary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># And set the emergency property and log the complication onset in the mni</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">onset_pph</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">onset_pph</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;pn_emergency_event_mother&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">onset_pph</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">onset_pph</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">store_dalys_in_mni</span><span class="p">(</span><span class="n">person</span><span class="p">,</span> <span class="n">mni</span><span class="p">,</span> <span class="s1">&#39;secondary_pph_onset&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;maternal_complication&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;person&#39;</span><span class="p">:</span> <span class="n">person</span><span class="p">,</span>
                                                           <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;secondary_postpartum_haemorrhage&#39;</span><span class="p">,</span>
                                                           <span class="s1">&#39;timing&#39;</span><span class="p">:</span> <span class="s1">&#39;postnatal&#39;</span><span class="p">})</span>

        <span class="c1"># ---------------------------------------------  ANAEMIA --------------------------------------------------</span>
        <span class="c1"># We apply a risk of anaemia developing in this week, and determine its severity</span>
        <span class="n">onset_anaemia</span> <span class="o">=</span> <span class="n">onset</span><span class="p">(</span><span class="s1">&#39;anaemia_after_pregnancy&#39;</span><span class="p">)</span>
        <span class="n">random_choice_severity</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s1">&#39;mild&#39;</span><span class="p">,</span> <span class="s1">&#39;moderate&#39;</span><span class="p">,</span> <span class="s1">&#39;severe&#39;</span><span class="p">],</span>
                                                           <span class="n">p</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;prob_type_of_anaemia_pn&#39;</span><span class="p">],</span>
                                                           <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">onset_anaemia</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">onset_anaemia</span><span class="p">])),</span>
                                           <span class="n">index</span><span class="o">=</span><span class="n">onset_anaemia</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">onset_anaemia</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">onset_anaemia</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">onset_anaemia</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;pn_anaemia_following_pregnancy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_choice_severity</span>

        <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">onset_anaemia</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">onset_anaemia</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">store_dalys_in_mni</span><span class="p">(</span><span class="n">person</span><span class="p">,</span> <span class="n">mni</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;pn_anaemia_following_pregnancy&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">_anaemia_pp_onset&#39;</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;maternal_complication&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;person&#39;</span><span class="p">:</span> <span class="n">person</span><span class="p">,</span>
                                                           <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;pn_anaemia_following_pregnancy&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
                                                                   <span class="sa">f</span><span class="s1">&#39;_anaemia&#39;</span><span class="p">,</span>
                                                           <span class="s1">&#39;timing&#39;</span><span class="p">:</span> <span class="s1">&#39;postnatal&#39;</span><span class="p">})</span>

        <span class="c1"># --------------------------------------- HYPERTENSION ------------------------------------------</span>
        <span class="c1"># For women who are still experiencing a hypertensive disorder of pregnancy we determine if that will now</span>
        <span class="c1"># resolve</span>
        <span class="n">women_with_htn</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;is_alive&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;la_is_postpartum&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;pn_postnatal_period_in_weeks&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">week</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;hs_is_inpatient&#39;</span><span class="p">]</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;pn_htn_disorders&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;gest_htn|severe_gest_htn|mild_pre_eclamp|severe_pre_eclamp|&#39;</span>
                                                 <span class="s1">&#39;eclampsia&#39;</span><span class="p">))]</span>

        <span class="n">resolvers</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">women_with_htn</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;prob_htn_resolves&#39;</span><span class="p">],</span>
                              <span class="n">index</span><span class="o">=</span><span class="n">women_with_htn</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">resolvers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">resolvers</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">mni</span><span class="p">[</span><span class="n">person</span><span class="p">][</span><span class="s1">&#39;hypertension_onset&#39;</span><span class="p">]):</span>
                <span class="n">store_dalys_in_mni</span><span class="p">(</span><span class="n">person</span><span class="p">,</span> <span class="n">mni</span><span class="p">,</span> <span class="s1">&#39;hypertension_resolution&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>

        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">resolvers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">resolvers</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;pn_htn_disorders&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;resolved&#39;</span>

        <span class="c1"># And for the women who&#39;s hypertension doesnt resolve we now see if it will progress to a worsened state</span>

        <span class="k">def</span> <span class="nf">apply_risk</span><span class="p">(</span><span class="n">selected</span><span class="p">,</span> <span class="n">risk_of_gest_htn_progression</span><span class="p">):</span>
            <span class="c1"># This function uses the transition_states function to move women between states based on the</span>
            <span class="c1"># probability matrix</span>

            <span class="n">disease_states</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gest_htn&#39;</span><span class="p">,</span> <span class="s1">&#39;severe_gest_htn&#39;</span><span class="p">,</span> <span class="s1">&#39;mild_pre_eclamp&#39;</span><span class="p">,</span> <span class="s1">&#39;severe_pre_eclamp&#39;</span><span class="p">,</span> <span class="s1">&#39;eclampsia&#39;</span><span class="p">]</span>
            <span class="n">prob_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">disease_states</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">disease_states</span><span class="p">)</span>

            <span class="n">risk_ghtn_remains_mild</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">risk_of_gest_htn_progression</span> <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;probs_for_mgh_matrix_pn&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>

            <span class="c1"># update the probability matrix according to treatment</span>

            <span class="n">prob_matrix</span><span class="p">[</span><span class="s1">&#39;gest_htn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">risk_ghtn_remains_mild</span><span class="p">,</span> <span class="n">risk_of_gest_htn_progression</span><span class="p">,</span>
                                       <span class="n">params</span><span class="p">[</span><span class="s1">&#39;probs_for_mgh_matrix_pn&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
            <span class="n">prob_matrix</span><span class="p">[</span><span class="s1">&#39;severe_gest_htn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;probs_for_sgh_matrix_pn&#39;</span><span class="p">]</span>
            <span class="n">prob_matrix</span><span class="p">[</span><span class="s1">&#39;mild_pre_eclamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;probs_for_mpe_matrix_pn&#39;</span><span class="p">]</span>
            <span class="n">prob_matrix</span><span class="p">[</span><span class="s1">&#39;severe_pre_eclamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;probs_for_spe_matrix_pn&#39;</span><span class="p">]</span>
            <span class="n">prob_matrix</span><span class="p">[</span><span class="s1">&#39;eclampsia&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;probs_for_ec_matrix_pn&#39;</span><span class="p">]</span>

            <span class="n">current_status</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selected</span><span class="p">,</span> <span class="s2">&quot;pn_htn_disorders&quot;</span><span class="p">]</span>
            <span class="n">new_status</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">transition_states</span><span class="p">(</span><span class="n">current_status</span><span class="p">,</span> <span class="n">prob_matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selected</span><span class="p">,</span> <span class="s2">&quot;pn_htn_disorders&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_status</span>

            <span class="k">def</span> <span class="nf">log_new_progressed_cases</span><span class="p">(</span><span class="n">disease</span><span class="p">):</span>
                <span class="n">assess_status_change</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_status</span> <span class="o">!=</span> <span class="n">disease</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">new_status</span> <span class="o">==</span> <span class="n">disease</span><span class="p">)</span>
                <span class="n">new_onset_disease</span> <span class="o">=</span> <span class="n">assess_status_change</span><span class="p">[</span><span class="n">assess_status_change</span><span class="p">]</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">new_onset_disease</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">disease</span> <span class="o">==</span> <span class="s1">&#39;severe_pre_eclamp&#39;</span><span class="p">:</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">new_onset_disease</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;pn_emergency_event_mother&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="n">disease</span> <span class="o">==</span> <span class="s1">&#39;eclampsia&#39;</span><span class="p">:</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">new_onset_disease</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;pn_emergency_event_mother&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">new_onset_disease</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                            <span class="n">pregnancy_helper_functions</span><span class="o">.</span><span class="n">store_dalys_in_mni</span><span class="p">,</span>
                            <span class="n">mni</span><span class="o">=</span><span class="n">mni</span><span class="p">,</span> <span class="n">mni_variable</span><span class="o">=</span><span class="s1">&#39;eclampsia_onset&#39;</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">new_onset_disease</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;maternal_complication&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;person&#39;</span><span class="p">:</span> <span class="n">person</span><span class="p">,</span>
                                                                       <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">disease</span><span class="p">,</span>
                                                                       <span class="s1">&#39;timing&#39;</span><span class="p">:</span> <span class="s1">&#39;postnatal&#39;</span><span class="p">})</span>

                        <span class="k">if</span> <span class="n">disease</span> <span class="o">==</span> <span class="s1">&#39;severe_pre_eclamp&#39;</span><span class="p">:</span>
                            <span class="n">mni</span><span class="p">[</span><span class="n">person</span><span class="p">][</span><span class="s1">&#39;new_onset_spe&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">for</span> <span class="n">disease</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mild_pre_eclamp&#39;</span><span class="p">,</span> <span class="s1">&#39;severe_pre_eclamp&#39;</span><span class="p">,</span> <span class="s1">&#39;eclampsia&#39;</span><span class="p">,</span> <span class="s1">&#39;severe_gest_htn&#39;</span><span class="p">]:</span>
                <span class="n">log_new_progressed_cases</span><span class="p">(</span><span class="n">disease</span><span class="p">)</span>

        <span class="c1"># The function is then applied to women with hypertensive disorders who are on and not on treatment</span>
        <span class="n">women_with_htn_not_on_anti_htns</span> <span class="o">=</span>\
            <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> \
            <span class="n">df</span><span class="o">.</span><span class="n">la_is_postpartum</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pn_postnatal_period_in_weeks</span> <span class="o">==</span> <span class="n">week</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;pn_htn_disorders&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;gest_htn|severe_gest_htn|mild_pre_eclamp|severe_pre_eclamp|&#39;</span>
                                                 <span class="s1">&#39;eclampsia&#39;</span><span class="p">))</span> <span class="o">&amp;</span> \
            <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">la_gest_htn_on_treatment</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">hs_is_inpatient</span>

        <span class="n">women_with_htn_on_anti_htns</span> <span class="o">=</span> \
            <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> \
            <span class="n">df</span><span class="o">.</span><span class="n">la_is_postpartum</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pn_postnatal_period_in_weeks</span> <span class="o">==</span> <span class="n">week</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;pn_htn_disorders&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;gest_htn|severe_gest_htn|mild_pre_eclamp|severe_pre_eclamp|&#39;</span>
                                                 <span class="s1">&#39;eclampsia&#39;</span><span class="p">))</span> <span class="o">&amp;</span> \
            <span class="n">df</span><span class="o">.</span><span class="n">la_gest_htn_on_treatment</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">hs_is_inpatient</span>

        <span class="n">risk_progression_mild_to_severe_htn</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;probs_for_mgh_matrix_pn&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">apply_risk</span><span class="p">(</span><span class="n">women_with_htn_not_on_anti_htns</span><span class="p">,</span> <span class="n">risk_progression_mild_to_severe_htn</span><span class="p">)</span>
        <span class="n">apply_risk</span><span class="p">(</span><span class="n">women_with_htn_on_anti_htns</span><span class="p">,</span> <span class="p">(</span><span class="n">risk_progression_mild_to_severe_htn</span> <span class="o">*</span>
                                                 <span class="n">params</span><span class="p">[</span><span class="s1">&#39;treatment_effect_anti_htns_progression_pn&#39;</span><span class="p">]))</span>

        <span class="c1">#  -------------------------------- RISK OF PRE-ECLAMPSIA HYPERTENSION --------------------------------------</span>
        <span class="c1"># Here we apply a risk to women developing de-novo hypertension in the later postnatal period, this includes</span>
        <span class="c1"># pre-eclampsia and gestational hypertension</span>
        <span class="n">pre_eclampsia</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_linear_model</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pn_linear_models</span><span class="p">[</span><span class="s1">&#39;pre_eclampsia_pn&#39;</span><span class="p">],</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;is_alive&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;la_is_postpartum&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;pn_postnatal_period_in_weeks&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">week</span><span class="p">)</span> <span class="o">&amp;</span>
                   <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;pn_htn_disorders&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">)])</span>

        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pre_eclampsia</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pre_eclampsia</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;ps_prev_pre_eclamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pre_eclampsia</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pre_eclampsia</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;pn_htn_disorders&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mild_pre_eclamp&#39;</span>

        <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">pre_eclampsia</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pre_eclampsia</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;maternal_complication&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;person&#39;</span><span class="p">:</span> <span class="n">person</span><span class="p">,</span>
                                                           <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;mild_pre_eclamp&#39;</span><span class="p">,</span>
                                                           <span class="s1">&#39;timing&#39;</span><span class="p">:</span> <span class="s1">&#39;postnatal&#39;</span><span class="p">})</span>

        <span class="c1">#  -------------------------------- RISK OF GESTATIONAL HYPERTENSION --------------------------------------</span>
        <span class="n">gest_hypertension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_linear_model</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pn_linear_models</span><span class="p">[</span><span class="s1">&#39;gest_htn_pn&#39;</span><span class="p">],</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;is_alive&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;la_is_postpartum&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;pn_postnatal_period_in_weeks&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">week</span><span class="p">)</span> <span class="o">&amp;</span>
                   <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;pn_htn_disorders&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">)])</span>

        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gest_hypertension</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gest_hypertension</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;pn_htn_disorders&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;gest_htn&#39;</span>

        <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">gest_hypertension</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gest_hypertension</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;maternal_complication&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;person&#39;</span><span class="p">:</span> <span class="n">person</span><span class="p">,</span>
                                                           <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;mild_gest_htn&#39;</span><span class="p">,</span>
                                                           <span class="s1">&#39;timing&#39;</span><span class="p">:</span> <span class="s1">&#39;postnatal&#39;</span><span class="p">})</span>

        <span class="c1"># -------------------------------- RISK OF DEATH SEVERE HYPERTENSION ------------------------------------------</span>
        <span class="c1"># Risk of death is applied to women with severe hypertensive disease</span>
        <span class="n">at_risk_of_death_htn</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;is_alive&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;la_is_postpartum&#39;</span><span class="p">]</span> <span class="o">&amp;</span>
                                      <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;pn_postnatal_period_in_weeks&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">week</span><span class="p">)</span> <span class="o">&amp;</span>
                                      <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;pn_htn_disorders&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;severe_gest_htn&#39;</span><span class="p">)]</span>

        <span class="n">die_from_htn</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">at_risk_of_death_htn</span><span class="p">))</span> <span class="o">&lt;</span>
                                 <span class="n">params</span><span class="p">[</span><span class="s1">&#39;weekly_prob_death_severe_gest_htn&#39;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">at_risk_of_death_htn</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="c1"># Those women who die the on_death function in demography is applied</span>
        <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">die_from_htn</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">die_from_htn</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;Demography&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">do_death</span><span class="p">(</span><span class="n">individual_id</span><span class="o">=</span><span class="n">person</span><span class="p">,</span> <span class="n">cause</span><span class="o">=</span><span class="s1">&#39;severe_gestational_hypertension&#39;</span><span class="p">,</span>
                                                    <span class="n">originating_module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;PostnatalSupervisor&#39;</span><span class="p">])</span>

            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;PregnancySupervisor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mother_and_newborn_info</span><span class="p">[</span><span class="n">person</span><span class="p">]</span>

        <span class="c1"># ----------------------------------------- CARE SEEKING ------------------------------------------------------</span>
        <span class="c1"># We now use the the pn_emergency_event_mother property that has just been set for women who are experiencing</span>
        <span class="c1"># severe complications to select a subset of women who may choose to seek care</span>
        <span class="n">can_seek_care</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;is_alive&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;la_is_postpartum&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;pn_postnatal_period_in_weeks&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">week</span><span class="p">)</span> <span class="o">&amp;</span>
                               <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pn_emergency_event_mother&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;hs_is_inpatient&#39;</span><span class="p">]]</span>

        <span class="n">care_seekers</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">can_seek_care</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;prob_care_seeking_postnatal_emergency&#39;</span><span class="p">],</span>
            <span class="n">index</span><span class="o">=</span><span class="n">can_seek_care</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="c1"># Reset this property to stop repeat care seeking</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">can_seek_care</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;pn_emergency_event_mother&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Schedule the HSI event</span>
        <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">care_seekers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">care_seekers</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">tlo.methods.labour</span> <span class="kn">import</span> <span class="n">HSI_Labour_ReceivesPostnatalCheck</span>

            <span class="c1"># check if care seeking is delayed</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;Labour&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">current_parameters</span><span class="p">[</span><span class="s1">&#39;prob_delay_one_two_fd&#39;</span><span class="p">]:</span>
                <span class="n">mni</span><span class="p">[</span><span class="n">person</span><span class="p">][</span><span class="s1">&#39;delay_one_two&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">postnatal_check</span> <span class="o">=</span> <span class="n">HSI_Labour_ReceivesPostnatalCheck</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;Labour&#39;</span><span class="p">],</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span><span class="n">postnatal_check</span><span class="p">,</span>
                                                                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                                                                <span class="n">tclose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

        <span class="c1"># For women who do not seek care we immediately apply risk of death due to complications</span>
        <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">care_seekers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">care_seekers</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply_risk_of_maternal_or_neonatal_death_postnatal</span><span class="p">(</span><span class="n">mother_or_child</span><span class="o">=</span><span class="s1">&#39;mother&#39;</span><span class="p">,</span> <span class="n">individual_id</span><span class="o">=</span><span class="n">person</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">week</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
            <span class="c1"># Here we reset any remaining pregnancy variables (as some are used as predictors in models in the postnatal</span>
            <span class="c1"># period)</span>
            <span class="n">week_6_women</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">la_is_postpartum</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pn_postnatal_period_in_weeks</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;PregnancySupervisor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pregnancy_supervisor_property_reset</span><span class="p">(</span>
                <span class="n">id_or_index</span><span class="o">=</span><span class="n">week_6_women</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">week_6_women</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;CareOfWomenDuringPregnancy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">care_of_women_in_pregnancy_property_reset</span><span class="p">(</span>
                <span class="n">id_or_index</span><span class="o">=</span><span class="n">week_6_women</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">week_6_women</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span></div>


<div class="viewcode-block" id="PostnatalSupervisor.apply_risk_of_neonatal_complications_in_week_one">
<a class="viewcode-back" href="../../../reference/tlo.methods.postnatal_supervisor.html#tlo.methods.postnatal_supervisor.PostnatalSupervisor.apply_risk_of_neonatal_complications_in_week_one">[docs]</a>
    <span class="k">def</span> <span class="nf">apply_risk_of_neonatal_complications_in_week_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child_id</span><span class="p">,</span> <span class="n">mother_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function is called by PostnatalWeekOneEvent for newborns to determine risk of complications. Currently</span>
<span class="sd">        this is limited to early onset neonatal sepsis</span>
<span class="sd">        :param child_id: childs individual id</span>
<span class="sd">        :param mother_id: mothers individual id</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">mni</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;PregnancySupervisor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mother_and_newborn_info</span>
        <span class="n">nci</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;NewbornOutcomes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">newborn_care_info</span>
        <span class="n">mni_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">mni</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
        <span class="n">nci_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">nci</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>

        <span class="c1"># Set external variables used in the linear model equation</span>
        <span class="n">maternal_prom</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">mother_id</span><span class="p">,</span> <span class="s1">&#39;ps_premature_rupture_of_membranes&#39;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">child_id</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">received_abx_for_prom</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">nci_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s1">&#39;abx_for_prom_given&#39;</span><span class="p">],</span>  <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">child_id</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mother_id</span> <span class="ow">in</span> <span class="n">mni_df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">chorio_in_preg</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">mni_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">mother_id</span><span class="p">,</span> <span class="s1">&#39;chorio_in_preg&#39;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">child_id</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">chorio_in_preg</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">child_id</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="c1"># We then apply a risk that this womans newborn will develop sepsis during week one</span>
        <span class="n">risk_eons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pn_linear_models</span><span class="p">[</span><span class="s1">&#39;early_onset_neonatal_sepsis_week_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">child_id</span><span class="p">]],</span> <span class="n">received_abx_for_prom</span><span class="o">=</span><span class="n">received_abx_for_prom</span><span class="p">,</span>
            <span class="n">maternal_chorioamnionitis</span><span class="o">=</span><span class="n">chorio_in_preg</span><span class="p">,</span>
            <span class="n">maternal_prom</span><span class="o">=</span><span class="n">maternal_prom</span><span class="p">)[</span><span class="n">child_id</span><span class="p">]</span>

        <span class="c1"># Update the df, mni and log the case</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">risk_eons</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s1">&#39;pn_sepsis_early_neonatal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;NewbornOutcomes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">newborn_care_info</span><span class="p">[</span><span class="n">child_id</span><span class="p">][</span><span class="s1">&#39;sepsis_postnatal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;newborn_complication&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;newborn&#39;</span><span class="p">:</span> <span class="n">child_id</span><span class="p">,</span>
                                                          <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;early_onset_sepsis&#39;</span><span class="p">})</span></div>


<div class="viewcode-block" id="PostnatalSupervisor.set_postnatal_complications_neonates">
<a class="viewcode-back" href="../../../reference/tlo.methods.postnatal_supervisor.html#tlo.methods.postnatal_supervisor.PostnatalSupervisor.set_postnatal_complications_neonates">[docs]</a>
    <span class="k">def</span> <span class="nf">set_postnatal_complications_neonates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">upper_and_lower_day_limits</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function is called by the PostnatalSupervisor event. It applies risk of key complication to neonates</span>
<span class="sd">        during each week of the neonatal period after week one (weeks 2, 3 &amp; 4). This is currently limited to sepsis but</span>
<span class="sd">        may be expanded at a later date</span>
<span class="sd">        :param upper_and_lower_day_limits: 2 value list of the first and last day of each week of the neonatal period</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">nci</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;NewbornOutcomes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">newborn_care_info</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_parameters</span>

        <span class="c1"># Here we apply risk of late onset neonatal sepsis (sepsis onsetting after day 7) to newborns</span>
        <span class="n">onset_sepsis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_linear_model</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pn_linear_models</span><span class="p">[</span><span class="s1">&#39;late_onset_neonatal_sepsis&#39;</span><span class="p">],</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;is_alive&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;mother_id&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;nb_death_after_birth&#39;</span><span class="p">]</span> <span class="o">&amp;</span>
                   <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;age_days&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">upper_and_lower_day_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span>
                   <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;age_days&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">upper_and_lower_day_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;date_of_birth&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">start_date</span><span class="p">)</span> <span class="o">&amp;</span>
                   <span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;hs_is_inpatient&#39;</span><span class="p">]])</span>

        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">onset_sepsis</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">onset_sepsis</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;pn_sepsis_late_neonatal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">onset_sepsis</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">onset_sepsis</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">nci</span><span class="p">:</span>
                <span class="n">nci</span><span class="p">[</span><span class="n">person</span><span class="p">][</span><span class="s1">&#39;sepsis_postnatal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;newborn_complication&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;newborn&#39;</span><span class="p">:</span> <span class="n">person</span><span class="p">,</span>
                                                          <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;late_onset_sepsis&#39;</span><span class="p">})</span>

        <span class="c1"># Then we determine if care will be sought for newly septic newborns</span>
        <span class="n">care_seeking</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">onset_sepsis</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">onset_sepsis</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;prob_care_seeking_postnatal_emergency_neonate&#39;</span><span class="p">],</span>
            <span class="n">index</span><span class="o">=</span><span class="n">onset_sepsis</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">onset_sepsis</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="c1"># We schedule the HSI according</span>
        <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">care_seeking</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">care_seeking</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>

            <span class="kn">from</span> <span class="nn">tlo.methods.newborn_outcomes</span> <span class="kn">import</span> <span class="n">HSI_NewbornOutcomes_ReceivesPostnatalCheck</span>
            <span class="n">postnatal_check</span> <span class="o">=</span> <span class="n">HSI_NewbornOutcomes_ReceivesPostnatalCheck</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;NewbornOutcomes&#39;</span><span class="p">],</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span><span class="n">postnatal_check</span><span class="p">,</span>
                                                                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                                                                <span class="n">tclose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># And apply risk of death for newborns for which care is not sought</span>
        <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">care_seeking</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">care_seeking</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply_risk_of_maternal_or_neonatal_death_postnatal</span><span class="p">(</span><span class="n">mother_or_child</span><span class="o">=</span><span class="s1">&#39;child&#39;</span><span class="p">,</span> <span class="n">individual_id</span><span class="o">=</span><span class="n">person</span><span class="p">)</span></div>


<div class="viewcode-block" id="PostnatalSupervisor.apply_risk_of_maternal_or_neonatal_death_postnatal">
<a class="viewcode-back" href="../../../reference/tlo.methods.postnatal_supervisor.html#tlo.methods.postnatal_supervisor.PostnatalSupervisor.apply_risk_of_maternal_or_neonatal_death_postnatal">[docs]</a>
    <span class="k">def</span> <span class="nf">apply_risk_of_maternal_or_neonatal_death_postnatal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mother_or_child</span><span class="p">,</span> <span class="n">individual_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function is called to calculate an individuals risk of death following the onset of a complication. For</span>
<span class="sd">        individuals who dont seek care this is immediately after the onset of complications. For those who seek care it</span>
<span class="sd">        is called at the end of the HSI to allow for treatment effects. Either a mother or a child can be passed to the</span>
<span class="sd">        function.</span>
<span class="sd">        :param mother_or_child: Person of interest for the effect of this function - pass &#39;mother&#39; or &#39;child&#39; to</span>
<span class="sd">         apply risk of death correctly</span>
<span class="sd">        :param individual_id: individual_id</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_parameters</span>
        <span class="n">mni</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;PregnancySupervisor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mother_and_newborn_info</span>

        <span class="c1"># Select the individuals row in the data frame to prevent repeated at based indexing</span>
        <span class="k">if</span> <span class="n">mother_or_child</span> <span class="o">==</span> <span class="s1">&#39;mother&#39;</span><span class="p">:</span>
            <span class="n">mother</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">individual_id</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">mother_or_child</span> <span class="o">==</span> <span class="s1">&#39;child&#39;</span><span class="p">:</span>
            <span class="n">child</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">individual_id</span><span class="p">]</span>

        <span class="c1"># ================================== MATERNAL DEATH EQUATIONS ==============================================</span>
        <span class="c1"># Create a list of all the causes that may cause death in the individual (matched to GBD labels)</span>
        <span class="k">if</span> <span class="n">mother_or_child</span> <span class="o">==</span> <span class="s1">&#39;mother&#39;</span><span class="p">:</span>

            <span class="c1"># Function checks df for any potential cause of death, uses CFR parameters to determine risk of death</span>
            <span class="c1"># (either from one or multiple causes) and if death occurs returns the cause</span>
            <span class="n">potential_cause_of_death</span> <span class="o">=</span> <span class="n">pregnancy_helper_functions</span><span class="o">.</span><span class="n">check_for_risk_of_death_from_cause_maternal</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">individual_id</span><span class="o">=</span><span class="n">individual_id</span><span class="p">)</span>

            <span class="c1"># If a cause is returned death is scheduled</span>
            <span class="k">if</span> <span class="n">potential_cause_of_death</span><span class="p">:</span>
                <span class="n">mni</span><span class="p">[</span><span class="n">individual_id</span><span class="p">][</span><span class="s1">&#39;didnt_seek_care&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">pregnancy_helper_functions</span><span class="o">.</span><span class="n">log_mni_for_maternal_death</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">individual_id</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;Demography&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">do_death</span><span class="p">(</span><span class="n">individual_id</span><span class="o">=</span><span class="n">individual_id</span><span class="p">,</span> <span class="n">cause</span><span class="o">=</span><span class="n">potential_cause_of_death</span><span class="p">,</span>
                                                        <span class="n">originating_module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;PostnatalSupervisor&#39;</span><span class="p">])</span>
                <span class="k">del</span> <span class="n">mni</span><span class="p">[</span><span class="n">individual_id</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Reset variables for women who survive</span>
                <span class="k">if</span> <span class="n">mother</span><span class="o">.</span><span class="n">pn_postpartum_haem_secondary</span><span class="p">:</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">individual_id</span><span class="p">,</span> <span class="s1">&#39;pn_postpartum_haem_secondary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">mother</span><span class="o">.</span><span class="n">pn_sepsis_late_postpartum</span><span class="p">:</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">individual_id</span><span class="p">,</span> <span class="s1">&#39;pn_sepsis_late_postpartum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">mother</span><span class="o">.</span><span class="n">pn_htn_disorders</span> <span class="o">==</span> <span class="s1">&#39;eclampsia&#39;</span><span class="p">:</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">individual_id</span><span class="p">,</span> <span class="s1">&#39;pn_htn_disorders&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;severe_pre_eclamp&#39;</span>
                <span class="k">if</span> <span class="n">mother</span><span class="o">.</span><span class="n">pn_htn_disorders</span> <span class="o">==</span> <span class="s1">&#39;severe_pre_eclamp&#39;</span> <span class="ow">and</span> <span class="n">mni</span><span class="p">[</span><span class="n">individual_id</span><span class="p">][</span><span class="s1">&#39;new_onset_spe&#39;</span><span class="p">]:</span>
                    <span class="n">mni</span><span class="p">[</span><span class="n">individual_id</span><span class="p">][</span><span class="s1">&#39;new_onset_spe&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># ================================== NEONATAL DEATH EQUATIONS ==============================================</span>
        <span class="k">if</span> <span class="n">mother_or_child</span> <span class="o">==</span> <span class="s1">&#39;child&#39;</span><span class="p">:</span>
            <span class="c1"># Neonates can have either early or late onset sepsis, not both at once- so we use either equation</span>
            <span class="c1"># depending on this neonates current condition</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">pn_sepsis_early_neonatal</span><span class="p">:</span>
                <span class="n">risk_of_death</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;cfr_early_onset_neonatal_sepsis&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">child</span><span class="o">.</span><span class="n">pn_sepsis_late_neonatal</span><span class="p">:</span>
                <span class="n">risk_of_death</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;cfr_late_neonatal_sepsis&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">pn_sepsis_late_neonatal</span> <span class="ow">or</span> <span class="n">child</span><span class="o">.</span><span class="n">pn_sepsis_early_neonatal</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">pn_sepsis_late_neonatal</span><span class="p">:</span>
                    <span class="n">cause</span> <span class="o">=</span> <span class="s1">&#39;late_onset_sepsis&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cause</span> <span class="o">=</span> <span class="s1">&#39;early_onset_sepsis&#39;</span>

                <span class="c1"># If this neonate will die then we make the appropriate changes</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">risk_of_death</span><span class="p">:</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;Demography&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">do_death</span><span class="p">(</span><span class="n">individual_id</span><span class="o">=</span><span class="n">individual_id</span><span class="p">,</span> <span class="n">cause</span><span class="o">=</span><span class="n">cause</span><span class="p">,</span>
                                                            <span class="n">originating_module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;PostnatalSupervisor&#39;</span><span class="p">])</span>

                <span class="c1"># Otherwise we reset the variables in the data frame</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">individual_id</span><span class="p">,</span> <span class="s1">&#39;pn_sepsis_late_neonatal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">individual_id</span><span class="p">,</span> <span class="s1">&#39;pn_sepsis_early_neonatal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span></div>
</div>



<div class="viewcode-block" id="PostnatalSupervisorEvent">
<a class="viewcode-back" href="../../../reference/tlo.methods.postnatal_supervisor.html#tlo.methods.postnatal_supervisor.PostnatalSupervisorEvent">[docs]</a>
<span class="k">class</span> <span class="nc">PostnatalSupervisorEvent</span><span class="p">(</span><span class="n">RegularEvent</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the PostnatalSupervisorEvent. This event runs every week and is responsible for apply risk of complications</span>
<span class="sd">    to mothers and newborns in the postnatal and neonatal periods. Risk is applied after the first week of life as this</span>
<span class="sd">    is managed via PostnatalWeekOneMaternalEvent and PostnatalWeekOneNeonatalEvent. In addition this event ensures that</span>
<span class="sd">    the relevant postnatal/neonatal variables are reset for those who survive.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="PostnatalSupervisorEvent.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.postnatal_supervisor.html#tlo.methods.postnatal_supervisor.PostnatalSupervisorEvent.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">weeks</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span></div>


<div class="viewcode-block" id="PostnatalSupervisorEvent.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.postnatal_supervisor.html#tlo.methods.postnatal_supervisor.PostnatalSupervisorEvent.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">store_dalys_in_mni</span> <span class="o">=</span> <span class="n">pregnancy_helper_functions</span><span class="o">.</span><span class="n">store_dalys_in_mni</span>
        <span class="n">mni</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;PregnancySupervisor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mother_and_newborn_info</span>

        <span class="c1"># ================================ UPDATING LENGTH OF POSTPARTUM PERIOD  IN WEEKS  ============================</span>
        <span class="c1"># Here we update how far into the postpartum period each woman who has recently delivered is</span>
        <span class="n">alive_and_recently_delivered</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">la_is_postpartum</span>
        <span class="n">ppp_in_days</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">alive_and_recently_delivered</span><span class="p">,</span> <span class="s1">&#39;la_date_most_recent_delivery&#39;</span><span class="p">]</span>
        <span class="n">ppp_in_weeks</span> <span class="o">=</span> <span class="n">ppp_in_days</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">)</span>
        <span class="n">rounded_weeks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">ppp_in_weeks</span><span class="p">)</span>

        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">alive_and_recently_delivered</span><span class="p">,</span> <span class="s1">&#39;pn_postnatal_period_in_weeks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rounded_weeks</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;updating postnatal periods on date </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Check that all women are week 1 or above</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">alive_and_recently_delivered</span><span class="p">,</span> <span class="s1">&#39;pn_postnatal_period_in_weeks&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s1">&#39;Postnatal weeks incorrectly calculated&#39;</span><span class="p">)</span>

        <span class="c1"># ================================= COMPLICATIONS/CARE SEEKING FOR WOMEN ======================================</span>
        <span class="c1"># This function is called to apply risk of complications to women in weeks 2, 3, 4, 5 and 6 of the postnatal</span>
        <span class="c1"># period</span>
        <span class="k">for</span> <span class="n">week</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">set_postnatal_complications_mothers</span><span class="p">(</span><span class="n">week</span><span class="o">=</span><span class="n">week</span><span class="p">)</span>

        <span class="c1"># ================================= COMPLICATIONS/CARE SEEKING FOR NEONATES ===================================</span>
        <span class="c1"># Next this function is called to apply risk of complications to neonates in week 2, 3 and 4 of the neonatal</span>
        <span class="c1"># period. Upper and lower limit days in the week are used to define one week.</span>
        <span class="k">for</span> <span class="n">upper_and_lower_day_limits</span> <span class="ow">in</span> <span class="p">[[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span> <span class="p">[</span><span class="mi">14</span><span class="p">,</span> <span class="mi">22</span><span class="p">],</span> <span class="p">[</span><span class="mi">21</span><span class="p">,</span> <span class="mi">29</span><span class="p">]]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">set_postnatal_complications_neonates</span><span class="p">(</span><span class="n">upper_and_lower_day_limits</span><span class="o">=</span><span class="n">upper_and_lower_day_limits</span><span class="p">)</span>

        <span class="c1"># -------------------------------------- RESETTING VARIABLES --------------------------------------------------</span>
        <span class="c1"># Finally we reset any variables that have been modified during this module</span>
        <span class="c1"># We make these changes 2 weeks after the end of the postnatal and neonatal period in case of either mother or</span>
        <span class="c1"># newborn are receiving treatment following the last PNC visit (around day 42)</span>

        <span class="c1"># Maternal variables</span>
        <span class="n">week_8_postnatal_women_htn</span> <span class="o">=</span> \
            <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">la_is_postpartum</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pn_postnatal_period_in_weeks</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pn_htn_disorders</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;gest_htn|severe_gest_htn|mild_pre_eclamp|severe_pre_eclamp|eclampsia&#39;</span><span class="p">))</span>

        <span class="c1"># Schedule date of resolution for any women with hypertension</span>
        <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">week_8_postnatal_women_htn</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">week_8_postnatal_women_htn</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">mni</span><span class="p">[</span><span class="n">person</span><span class="p">][</span><span class="s1">&#39;hypertension_onset&#39;</span><span class="p">]):</span>
                <span class="n">store_dalys_in_mni</span><span class="p">(</span><span class="n">person</span><span class="p">,</span> <span class="n">mni</span><span class="p">,</span> <span class="s1">&#39;hypertension_resolution&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>

        <span class="n">week_8_postnatal_women_anaemia</span> <span class="o">=</span> \
            <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">la_is_postpartum</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pn_postnatal_period_in_weeks</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pn_anaemia_following_pregnancy</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>

        <span class="c1"># Schedule date of resolution for any women with anaemia</span>
        <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">week_8_postnatal_women_anaemia</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">week_8_postnatal_women_anaemia</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">store_dalys_in_mni</span><span class="p">(</span><span class="n">person</span><span class="p">,</span> <span class="n">mni</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;pn_anaemia_following_pregnancy&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">_anaemia&#39;</span>
                                            <span class="sa">f</span><span class="s1">&#39;_pp_resolution&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>

        <span class="n">week_8_postnatal_women</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">la_is_postpartum</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pn_postnatal_period_in_weeks</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>

        <span class="c1"># Set mni[person][&#39;delete_mni&#39;] to True meaning after the next DALY event each womans MNI dict is deleted</span>
        <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">week_8_postnatal_women</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">week_8_postnatal_women</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">mni</span><span class="p">[</span><span class="n">person</span><span class="p">][</span><span class="s1">&#39;delete_mni&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;total_mat_pnc_visits&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;mother&#39;</span><span class="p">:</span> <span class="n">person</span><span class="p">,</span>
                                                          <span class="s1">&#39;visits&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person</span><span class="p">,</span> <span class="s1">&#39;la_pn_checks_maternal&#39;</span><span class="p">],</span>
                                                          <span class="s1">&#39;anaemia&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person</span><span class="p">,</span> <span class="s1">&#39;pn_anaemia_following_pregnancy&#39;</span><span class="p">]})</span>

        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">week_8_postnatal_women</span><span class="p">,</span> <span class="s1">&#39;pn_postnatal_period_in_weeks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">week_8_postnatal_women</span><span class="p">,</span> <span class="s1">&#39;la_is_postpartum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">week_8_postnatal_women</span><span class="p">,</span> <span class="s1">&#39;la_pn_checks_maternal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">week_8_postnatal_women</span><span class="p">,</span> <span class="s1">&#39;pn_sepsis_late_postpartum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">week_8_postnatal_women</span><span class="p">,</span> <span class="s1">&#39;pn_postpartum_haem_secondary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">week_8_postnatal_women</span><span class="p">,</span> <span class="s1">&#39;pn_htn_disorders&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">week_8_postnatal_women</span><span class="p">,</span> <span class="s1">&#39;pn_anaemia_following_pregnancy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>

        <span class="c1"># For the neonates we now determine if they will develop any long term neurodevelopmental impairment following</span>
        <span class="c1"># survival of the neonatal period</span>
        <span class="n">week_5_postnatal_neonates</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_days</span> <span class="o">&gt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_days</span> <span class="o">&lt;</span> <span class="mi">36</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">date_of_birth</span> <span class="o">&gt;</span>
                                                                                             <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">start_date</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">week_5_postnatal_neonates</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">week_5_postnatal_neonates</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;NewbornOutcomes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_disability_status</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;total_neo_pnc_visits&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;child&#39;</span><span class="p">:</span> <span class="n">person</span><span class="p">,</span>
                                                          <span class="s1">&#39;visits&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person</span><span class="p">,</span> <span class="s1">&#39;nb_pnc_check&#39;</span><span class="p">]})</span>

        <span class="c1"># And then reset any key variables</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">week_5_postnatal_neonates</span><span class="p">,</span> <span class="s1">&#39;pn_sepsis_early_neonatal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">week_5_postnatal_neonates</span><span class="p">,</span> <span class="s1">&#39;pn_sepsis_late_neonatal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span></div>
</div>



<div class="viewcode-block" id="PostnatalWeekOneMaternalEvent">
<a class="viewcode-back" href="../../../reference/tlo.methods.postnatal_supervisor.html#tlo.methods.postnatal_supervisor.PostnatalWeekOneMaternalEvent">[docs]</a>
<span class="k">class</span> <span class="nc">PostnatalWeekOneMaternalEvent</span><span class="p">(</span><span class="n">Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is PostnatalWeekOneMaternalEvent. It is scheduled for all mothers who survive labour and the first 48 hours</span>
<span class="sd">    after birth. This event applies risk of key complications that can occur in the first week after birth. This event</span>
<span class="sd">    also schedules postnatal care for those women predicted to attend after 48 hours or in the situation where they have</span>
<span class="sd">    developed a complication. For women who dont seek care for themselves risk of death is applied.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="PostnatalWeekOneMaternalEvent.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.postnatal_supervisor.html#tlo.methods.postnatal_supervisor.PostnatalWeekOneMaternalEvent.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">individual_id</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">individual_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="PostnatalWeekOneMaternalEvent.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.postnatal_supervisor.html#tlo.methods.postnatal_supervisor.PostnatalWeekOneMaternalEvent.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">individual_id</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">current_parameters</span>
        <span class="n">mni</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;PregnancySupervisor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mother_and_newborn_info</span>
        <span class="n">store_dalys_in_mni</span> <span class="o">=</span> <span class="n">pregnancy_helper_functions</span><span class="o">.</span><span class="n">store_dalys_in_mni</span>
        <span class="n">mother</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">individual_id</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">mother</span><span class="o">.</span><span class="n">is_alive</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Run some checks on the mothers arriving to this event after delivery</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">mother</span><span class="o">.</span><span class="n">la_is_postpartum</span> <span class="ow">or</span>
            <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">-</span> <span class="n">mother</span><span class="o">.</span><span class="n">la_date_most_recent_delivery</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span> <span class="ow">or</span>
           <span class="n">mni</span><span class="p">[</span><span class="n">individual_id</span><span class="p">][</span><span class="s1">&#39;passed_through_week_one&#39;</span><span class="p">]):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s1">&#39;Mother incorrectly scheduled to arrive at PostnatalWeekOneMaternalEvent&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Signify this woman has reached week one of the postnatal period (this variable is used in the labour module)</span>
        <span class="n">mni</span><span class="p">[</span><span class="n">individual_id</span><span class="p">][</span><span class="s1">&#39;passed_through_week_one&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># And remove women from the labour list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;Labour&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">women_in_labour</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">individual_id</span><span class="p">)</span>

        <span class="c1"># Next we apply risk of key complications in the first week following delivery</span>

        <span class="c1">#  -----------------------------------MATERNAL  SEPSIS --------------------------------------------------------</span>
        <span class="c1"># Define external variable for linear model</span>
        <span class="n">mode_of_delivery</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">mni</span><span class="p">[</span><span class="n">individual_id</span><span class="p">][</span><span class="s1">&#39;mode_of_delivery&#39;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">individual_id</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="c1"># Determine individual risk of sepsis for each possible cause</span>
        <span class="n">risk_sepsis_endometritis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">pn_linear_models</span><span class="p">[</span><span class="s1">&#39;sepsis_endometritis_late_postpartum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">individual_id</span><span class="p">]],</span> <span class="n">mode_of_delivery</span><span class="o">=</span><span class="n">mode_of_delivery</span><span class="p">)[</span><span class="n">individual_id</span><span class="p">]</span>

        <span class="n">risk_sepsis_skin_soft_tissue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">pn_linear_models</span><span class="p">[</span><span class="s1">&#39;sepsis_sst_late_postpartum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">individual_id</span><span class="p">]],</span> <span class="n">mode_of_delivery</span><span class="o">=</span><span class="n">mode_of_delivery</span><span class="p">)[</span><span class="n">individual_id</span><span class="p">]</span>

        <span class="n">risk_sepsis_urinary_tract</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;prob_late_sepsis_urinary_tract&#39;</span><span class="p">]</span>

        <span class="c1"># Use random draw to determine if sepsis will occur</span>
        <span class="n">endo_result</span> <span class="o">=</span> <span class="n">risk_sepsis_endometritis</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span>
        <span class="n">ut_result</span> <span class="o">=</span> <span class="n">risk_sepsis_urinary_tract</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span>
        <span class="n">ssti_result</span> <span class="o">=</span> <span class="n">risk_sepsis_skin_soft_tissue</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span>

        <span class="c1"># If the individual develops sepsis, update key variables and log the case</span>
        <span class="k">if</span> <span class="n">endo_result</span> <span class="ow">or</span> <span class="n">ut_result</span> <span class="ow">or</span> <span class="n">ssti_result</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">individual_id</span><span class="p">,</span> <span class="s1">&#39;pn_sepsis_late_postpartum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">store_dalys_in_mni</span><span class="p">(</span><span class="n">individual_id</span><span class="p">,</span> <span class="n">mni</span><span class="p">,</span> <span class="s1">&#39;sepsis_onset&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;maternal_complication&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;person&#39;</span><span class="p">:</span> <span class="n">individual_id</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;sepsis&#39;</span><span class="p">,</span>
                                                           <span class="s1">&#39;timing&#39;</span><span class="p">:</span> <span class="s1">&#39;postnatal&#39;</span><span class="p">})</span>

            <span class="c1"># Sepsis secondary to endometritis is stored within the mni as it is used as a predictor in a linear model</span>
            <span class="k">if</span> <span class="n">endo_result</span><span class="p">:</span>
                <span class="n">mni</span><span class="p">[</span><span class="n">individual_id</span><span class="p">][</span><span class="s1">&#39;endo_pp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1">#  ---------------------------------------- SECONDARY PPH ------------------------------------------------</span>
        <span class="c1"># Next we apply risk of secondary postpartum bleeding, first define external variables</span>
        <span class="n">endometritis</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">mni</span><span class="p">[</span><span class="n">individual_id</span><span class="p">][</span><span class="s1">&#39;endo_pp&#39;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">individual_id</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="n">risk_secondary_pph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">pn_linear_models</span><span class="p">[</span><span class="s1">&#39;secondary_postpartum_haem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span>
            <span class="n">individual_id</span><span class="p">]],</span> <span class="n">endometritis</span><span class="o">=</span><span class="n">endometritis</span><span class="p">)[</span><span class="n">individual_id</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">risk_secondary_pph</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">():</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">individual_id</span><span class="p">,</span> <span class="s1">&#39;pn_postpartum_haem_secondary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">store_dalys_in_mni</span><span class="p">(</span><span class="n">individual_id</span><span class="p">,</span> <span class="n">mni</span><span class="p">,</span> <span class="s1">&#39;secondary_pph_onset&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;maternal_complication&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;person&#39;</span><span class="p">:</span> <span class="n">individual_id</span><span class="p">,</span>
                                                           <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;secondary_postpartum_haemorrhage&#39;</span><span class="p">,</span>
                                                           <span class="s1">&#39;timing&#39;</span><span class="p">:</span> <span class="s1">&#39;postnatal&#39;</span><span class="p">})</span>

        <span class="c1"># ------------------------------------------------ NEW ONSET ANAEMIA ------------------------------------------</span>
        <span class="c1"># And then risk of developing anaemia...</span>
        <span class="k">if</span> <span class="n">mother</span><span class="o">.</span><span class="n">pn_anaemia_following_pregnancy</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="n">risk_anaemia_after_pregnancy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">pn_linear_models</span><span class="p">[</span><span class="s1">&#39;anaemia_after_pregnancy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">individual_id</span><span class="p">]])[</span><span class="n">individual_id</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">risk_anaemia_after_pregnancy</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">():</span>
                <span class="n">random_choice_severity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s1">&#39;mild&#39;</span><span class="p">,</span> <span class="s1">&#39;moderate&#39;</span><span class="p">,</span> <span class="s1">&#39;severe&#39;</span><span class="p">],</span>
                                                                <span class="n">p</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;prob_type_of_anaemia_pn&#39;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">individual_id</span><span class="p">,</span> <span class="s1">&#39;pn_anaemia_following_pregnancy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_choice_severity</span>

                <span class="n">store_dalys_in_mni</span><span class="p">(</span><span class="n">individual_id</span><span class="p">,</span> <span class="n">mni</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">individual_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;pn_anaemia_following_pregnancy&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">_&#39;</span>
                                                       <span class="sa">f</span><span class="s1">&#39;anaemia_pp_onset&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;maternal_complication&#39;</span><span class="p">,</span>
                            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;person&#39;</span><span class="p">:</span> <span class="n">individual_id</span><span class="p">,</span>
                                  <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">individual_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;pn_anaemia_following_pregnancy&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">_anaemia&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;timing&#39;</span><span class="p">:</span> <span class="s1">&#39;postnatal&#39;</span><span class="p">})</span>

        <span class="c1"># -------------------------------------------- HYPERTENSION -----------------------------------------------</span>
        <span class="c1"># For women who remain hypertensive after delivery we apply a probability that this will resolve in the</span>
        <span class="c1"># first week after birth</span>

        <span class="k">if</span> <span class="s1">&#39;none&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mother</span><span class="o">.</span><span class="n">pn_htn_disorders</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;resolved&#39;</span> <span class="ow">in</span> <span class="n">mother</span><span class="o">.</span><span class="n">pn_htn_disorders</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;prob_htn_resolves&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">mni</span><span class="p">[</span><span class="n">individual_id</span><span class="p">][</span><span class="s1">&#39;hypertension_onset&#39;</span><span class="p">]):</span>
                    <span class="c1"># Store date of resolution for women who were aware of their hypertension (in keeping with daly</span>
                    <span class="c1"># weight definition)</span>
                    <span class="n">store_dalys_in_mni</span><span class="p">(</span><span class="n">individual_id</span><span class="p">,</span> <span class="n">mni</span><span class="p">,</span> <span class="s1">&#39;hypertension_resolution&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">individual_id</span><span class="p">,</span> <span class="s1">&#39;pn_htn_disorders&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;resolved&#39;</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If not, we apply a risk that the hypertension might worsen and progress into a more severe form</span>
                <span class="n">disease_states</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gest_htn&#39;</span><span class="p">,</span> <span class="s1">&#39;severe_gest_htn&#39;</span><span class="p">,</span> <span class="s1">&#39;mild_pre_eclamp&#39;</span><span class="p">,</span> <span class="s1">&#39;severe_pre_eclamp&#39;</span><span class="p">,</span> <span class="s1">&#39;eclampsia&#39;</span><span class="p">]</span>
                <span class="n">prob_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">disease_states</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">disease_states</span><span class="p">)</span>

                <span class="n">prob_matrix</span><span class="p">[</span><span class="s1">&#39;gest_htn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;probs_for_mgh_matrix_pn&#39;</span><span class="p">]</span>
                <span class="n">prob_matrix</span><span class="p">[</span><span class="s1">&#39;severe_gest_htn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;probs_for_sgh_matrix_pn&#39;</span><span class="p">]</span>
                <span class="n">prob_matrix</span><span class="p">[</span><span class="s1">&#39;mild_pre_eclamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;probs_for_mpe_matrix_pn&#39;</span><span class="p">]</span>
                <span class="n">prob_matrix</span><span class="p">[</span><span class="s1">&#39;severe_pre_eclamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;probs_for_spe_matrix_pn&#39;</span><span class="p">]</span>
                <span class="n">prob_matrix</span><span class="p">[</span><span class="s1">&#39;eclampsia&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;probs_for_ec_matrix_pn&#39;</span><span class="p">]</span>

                <span class="c1"># We modify the probability of progressing from mild to severe gestational hypertension for women</span>
                <span class="c1"># who are on anti hypertensives</span>
                <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">individual_id</span><span class="p">,</span> <span class="s1">&#39;la_gest_htn_on_treatment&#39;</span><span class="p">]:</span>
                    <span class="n">treatment_reduced_risk</span> <span class="o">=</span> <span class="n">prob_matrix</span><span class="p">[</span><span class="s1">&#39;gest_htn&#39;</span><span class="p">][</span><span class="s1">&#39;severe_gest_htn&#39;</span><span class="p">]</span> <span class="o">*</span> \
                                             <span class="n">params</span><span class="p">[</span><span class="s1">&#39;treatment_effect_anti_htns_progression_pn&#39;</span><span class="p">]</span>
                    <span class="n">prob_matrix</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s1">&#39;severe_gest_htn&#39;</span><span class="p">,</span> <span class="s1">&#39;gest_htn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">treatment_reduced_risk</span>
                    <span class="n">prob_matrix</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s1">&#39;gest_htn&#39;</span><span class="p">,</span> <span class="s1">&#39;gest_htn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">treatment_reduced_risk</span> <span class="o">+</span>
                                                                    <span class="n">prob_matrix</span><span class="p">[</span><span class="s1">&#39;gest_htn&#39;</span><span class="p">][</span><span class="s1">&#39;mild_pre_eclamp&#39;</span><span class="p">])</span>

                <span class="n">current_status</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">individual_id</span><span class="p">],</span> <span class="s1">&#39;pn_htn_disorders&#39;</span><span class="p">]</span>
                <span class="n">new_status</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">transition_states</span><span class="p">(</span><span class="n">current_status</span><span class="p">,</span> <span class="n">prob_matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="p">)</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">individual_id</span><span class="p">],</span> <span class="s2">&quot;pn_htn_disorders&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_status</span>

                <span class="k">def</span> <span class="nf">log_new_progressed_cases</span><span class="p">(</span><span class="n">disease</span><span class="p">):</span>
                    <span class="n">assess_status_change</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_status</span> <span class="o">!=</span> <span class="n">disease</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">new_status</span> <span class="o">==</span> <span class="n">disease</span><span class="p">)</span>
                    <span class="n">new_onset_disease</span> <span class="o">=</span> <span class="n">assess_status_change</span><span class="p">[</span><span class="n">assess_status_change</span><span class="p">]</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">new_onset_disease</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">new_onset_disease</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;maternal_complication&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;person&#39;</span><span class="p">:</span> <span class="n">person</span><span class="p">,</span>
                                                                           <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">disease</span><span class="p">,</span>
                                                                           <span class="s1">&#39;timing&#39;</span><span class="p">:</span> <span class="s1">&#39;postnatal&#39;</span><span class="p">})</span>
                            <span class="k">if</span> <span class="n">disease</span> <span class="o">==</span> <span class="s1">&#39;severe_pre_eclamp&#39;</span><span class="p">:</span>
                                <span class="n">mni</span><span class="p">[</span><span class="n">person</span><span class="p">][</span><span class="s1">&#39;new_onset_spe&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

                        <span class="k">if</span> <span class="n">disease</span> <span class="o">==</span> <span class="s1">&#39;eclampsia&#39;</span><span class="p">:</span>
                            <span class="n">new_onset_disease</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                                <span class="n">store_dalys_in_mni</span><span class="p">,</span> <span class="n">mni</span><span class="o">=</span><span class="n">mni</span><span class="p">,</span> <span class="n">mni_variable</span><span class="o">=</span><span class="s1">&#39;eclampsia_onset&#39;</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">disease</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mild_pre_eclamp&#39;</span><span class="p">,</span> <span class="s1">&#39;severe_pre_eclamp&#39;</span><span class="p">,</span> <span class="s1">&#39;eclampsia&#39;</span><span class="p">,</span> <span class="s1">&#39;severe_gest_htn&#39;</span><span class="p">]:</span>
                    <span class="n">log_new_progressed_cases</span><span class="p">(</span><span class="n">disease</span><span class="p">)</span>

        <span class="c1">#  ---------------------------- RISK OF POSTPARTUM PRE-ECLAMPSIA/HYPERTENSION ----------------------------</span>
        <span class="c1"># Women who are normatensive after delivery may develop new hypertension for the first time after birth</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">individual_id</span><span class="p">,</span> <span class="s1">&#39;pn_htn_disorders&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="n">risk_pe_after_pregnancy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">pn_linear_models</span><span class="p">[</span><span class="s1">&#39;pre_eclampsia_pn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span>
                    <span class="n">individual_id</span><span class="p">]])[</span><span class="n">individual_id</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">risk_pe_after_pregnancy</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">():</span>
                <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">individual_id</span><span class="p">,</span> <span class="s1">&#39;pn_htn_disorders&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mild_pre_eclamp&#39;</span>
                <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">individual_id</span><span class="p">,</span> <span class="s1">&#39;ps_prev_pre_eclamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;maternal_complication&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;person&#39;</span><span class="p">:</span> <span class="n">individual_id</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;mild_pre_eclamp&#39;</span><span class="p">,</span>
                                                               <span class="s1">&#39;timing&#39;</span><span class="p">:</span> <span class="s1">&#39;postnatal&#39;</span><span class="p">})</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">risk_gh_after_pregnancy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">pn_linear_models</span><span class="p">[</span><span class="s1">&#39;gest_htn_pn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span>
                        <span class="n">individual_id</span><span class="p">]])[</span><span class="n">individual_id</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">risk_gh_after_pregnancy</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">():</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">individual_id</span><span class="p">,</span> <span class="s1">&#39;pn_htn_disorders&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;gest_htn&#39;</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;maternal_complication&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;person&#39;</span><span class="p">:</span> <span class="n">individual_id</span><span class="p">,</span>
                                                                   <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;mild_gest_htn&#39;</span><span class="p">,</span>
                                                                   <span class="s1">&#39;timing&#39;</span><span class="p">:</span> <span class="s1">&#39;postnatal&#39;</span><span class="p">})</span>

        <span class="c1"># ======================================  POSTNATAL CHECK  ==================================================</span>
        <span class="c1"># Import the HSI which represents postnatal care</span>
        <span class="kn">from</span> <span class="nn">tlo.methods.labour</span> <span class="kn">import</span> <span class="n">HSI_Labour_ReceivesPostnatalCheck</span>

        <span class="n">pnc_one_maternal</span> <span class="o">=</span> <span class="n">HSI_Labour_ReceivesPostnatalCheck</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;Labour&#39;</span><span class="p">],</span> <span class="n">person_id</span><span class="o">=</span><span class="n">individual_id</span><span class="p">)</span>

        <span class="c1"># If a mother has developed complications in the first week after birth and has been predicted to attend PNC</span>
        <span class="c1"># anyway she will attend now. If she was not predicted to attend but now develops complications she may</span>
        <span class="c1"># choose to seek care</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">individual_id</span><span class="p">,</span> <span class="s1">&#39;pn_sepsis_late_postpartum&#39;</span><span class="p">]</span> <span class="ow">or</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">individual_id</span><span class="p">,</span> <span class="s1">&#39;pn_postpartum_haem_secondary&#39;</span><span class="p">]</span> <span class="ow">or</span>
            <span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">individual_id</span><span class="p">,</span> <span class="s1">&#39;pn_htn_disorders&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;severe_pre_eclamp&#39;</span><span class="p">)</span> <span class="ow">and</span>
             <span class="n">mni</span><span class="p">[</span><span class="n">individual_id</span><span class="p">][</span><span class="s1">&#39;new_onset_spe&#39;</span><span class="p">])</span> <span class="ow">or</span>
           <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">individual_id</span><span class="p">,</span> <span class="s1">&#39;pn_htn_disorders&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;eclampsia&#39;</span><span class="p">)):</span>

            <span class="c1"># We assume the probability of care seeking is higher in women with complications</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mni</span><span class="p">[</span><span class="n">individual_id</span><span class="p">][</span><span class="s1">&#39;will_receive_pnc&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;late&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">&lt;</span>
                                                                      <span class="n">params</span><span class="p">[</span><span class="s1">&#39;prob_care_seeking_postnatal_emergency&#39;</span><span class="p">]):</span>

                <span class="c1"># If care will be sought, check if they experience delay seeking care</span>
                <span class="n">pregnancy_helper_functions</span><span class="o">.</span><span class="n">check_if_delayed_careseeking</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">individual_id</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                    <span class="n">pnc_one_maternal</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">tclose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

            <span class="c1"># If she will not receive treatment for her complications we apply risk of death now</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">apply_risk_of_maternal_or_neonatal_death_postnatal</span><span class="p">(</span><span class="n">mother_or_child</span><span class="o">=</span><span class="s1">&#39;mother&#39;</span><span class="p">,</span>
                                                                               <span class="n">individual_id</span><span class="o">=</span><span class="n">individual_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Women without complications in week one are scheduled to attend PNC in the future</span>
            <span class="k">if</span> <span class="n">mni</span><span class="p">[</span><span class="n">individual_id</span><span class="p">][</span><span class="s1">&#39;will_receive_pnc&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;late&#39;</span><span class="p">:</span>
                <span class="n">appt_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">35</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                    <span class="n">pnc_one_maternal</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">topen</span><span class="o">=</span><span class="n">appt_date</span><span class="p">,</span> <span class="n">tclose</span><span class="o">=</span><span class="n">appt_date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span></div>
</div>



<div class="viewcode-block" id="PostnatalWeekOneNeonatalEvent">
<a class="viewcode-back" href="../../../reference/tlo.methods.postnatal_supervisor.html#tlo.methods.postnatal_supervisor.PostnatalWeekOneNeonatalEvent">[docs]</a>
<span class="k">class</span> <span class="nc">PostnatalWeekOneNeonatalEvent</span><span class="p">(</span><span class="n">Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is PostnatalWeekOneEvent. It is scheduled for all newborns who survive labour and the first 48 hours after</span>
<span class="sd">    birth. This event applies risk of key complications that can occur in the first week after birth. This event also</span>
<span class="sd">    schedules postnatal care for those newborns predicted to attend after 48 hours or in the situation where they have</span>
<span class="sd">    developed a complication. For newborns who dont seek care for themselves risk of death is applied.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PostnatalWeekOneNeonatalEvent.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.postnatal_supervisor.html#tlo.methods.postnatal_supervisor.PostnatalWeekOneNeonatalEvent.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">individual_id</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">individual_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="PostnatalWeekOneNeonatalEvent.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.postnatal_supervisor.html#tlo.methods.postnatal_supervisor.PostnatalWeekOneNeonatalEvent.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">individual_id</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">current_parameters</span>
        <span class="n">nci</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;NewbornOutcomes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">newborn_care_info</span>
        <span class="n">child</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">individual_id</span><span class="p">]</span>
        <span class="n">mother_id</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">individual_id</span><span class="p">,</span> <span class="s1">&#39;mother_id&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">child</span><span class="o">.</span><span class="n">is_alive</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Run checks to ensure only the right newborns have arrived here</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">child</span><span class="o">.</span><span class="n">age_days</span> <span class="o">&lt;</span> <span class="mi">7</span> <span class="ow">or</span> <span class="n">nci</span><span class="p">[</span><span class="n">individual_id</span><span class="p">][</span><span class="s1">&#39;passed_through_week_one&#39;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s1">&#39;Child incorrectly scheduled for PostnatalWeekOneNeonatalEvent&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">nci</span><span class="p">[</span><span class="n">individual_id</span><span class="p">][</span><span class="s1">&#39;passed_through_week_one&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Apply risk of complication (early onset sepsis)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">apply_risk_of_neonatal_complications_in_week_one</span><span class="p">(</span><span class="n">child_id</span><span class="o">=</span><span class="n">individual_id</span><span class="p">,</span> <span class="n">mother_id</span><span class="o">=</span><span class="n">mother_id</span><span class="p">)</span>

        <span class="c1"># ===============================  POSTNATAL CHECK  =========================================================</span>
        <span class="c1"># As with mothers we now determine if this child will receive postnatal care</span>
        <span class="kn">from</span> <span class="nn">tlo.methods.newborn_outcomes</span> <span class="kn">import</span> <span class="n">HSI_NewbornOutcomes_ReceivesPostnatalCheck</span>

        <span class="n">pnc_one_neonatal</span> <span class="o">=</span> <span class="n">HSI_NewbornOutcomes_ReceivesPostnatalCheck</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;NewbornOutcomes&#39;</span><span class="p">],</span> <span class="n">person_id</span><span class="o">=</span><span class="n">individual_id</span><span class="p">)</span>

        <span class="c1"># Neonates with sepsis are more likely to receive PNC that those without</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">individual_id</span><span class="p">,</span> <span class="s1">&#39;pn_sepsis_early_neonatal&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">nci</span><span class="p">[</span><span class="n">individual_id</span><span class="p">][</span><span class="s1">&#39;will_receive_pnc&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;late&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">&lt;</span>
                                                                       <span class="n">params</span><span class="p">[</span><span class="s1">&#39;prob_care_seeking_postnatal_&#39;</span>
                                                                              <span class="s1">&#39;emergency_neonate&#39;</span><span class="p">])):</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span><span class="n">pnc_one_neonatal</span><span class="p">,</span>
                                                                    <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                                    <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                                                                    <span class="n">tclose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Apply risk of death for those who wont seek care</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">apply_risk_of_maternal_or_neonatal_death_postnatal</span><span class="p">(</span><span class="n">mother_or_child</span><span class="o">=</span><span class="s1">&#39;child&#39;</span><span class="p">,</span>
                                                                               <span class="n">individual_id</span><span class="o">=</span><span class="n">individual_id</span><span class="p">)</span>

        <span class="c1"># Finally we determine if newborns without infection will receive PNC</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">individual_id</span><span class="p">,</span> <span class="s1">&#39;pn_sepsis_early_neonatal&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">nci</span><span class="p">[</span><span class="n">individual_id</span><span class="p">][</span><span class="s1">&#39;will_&#39;</span>
                                                                                          <span class="s1">&#39;receive_pnc&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;late&#39;</span><span class="p">):</span>
            <span class="n">days_till_day_7</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">individual_id</span><span class="p">,</span> <span class="s1">&#39;age_days&#39;</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">pnc_one_neonatal</span><span class="p">,</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">days_till_day_7</span><span class="p">)),</span>
                <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="HSI_PostnatalSupervisor_TreatmentForObstetricFistula">
<a class="viewcode-back" href="../../../reference/tlo.methods.postnatal_supervisor.html#tlo.methods.postnatal_supervisor.HSI_PostnatalSupervisor_TreatmentForObstetricFistula">[docs]</a>
<span class="k">class</span> <span class="nc">HSI_PostnatalSupervisor_TreatmentForObstetricFistula</span><span class="p">(</span><span class="n">HSI_Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is HSI_PostnatalSupervisor_TreatmentForObstetricFistula. It is scheduled by the on_birth function of this</span>
<span class="sd">     module for women have developed obstetric fistula and choose to seek care. Treatment delivered in this event</span>
<span class="sd">    includes surgical correction of obstetric fistula</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="HSI_PostnatalSupervisor_TreatmentForObstetricFistula.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.postnatal_supervisor.html#tlo.methods.postnatal_supervisor.HSI_PostnatalSupervisor_TreatmentForObstetricFistula.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">PostnatalSupervisor</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">TREATMENT_ID</span> <span class="o">=</span> <span class="s1">&#39;PostnatalCare_TreatmentForObstetricFistula&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s1">&#39;MajorSurg&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span> <span class="o">=</span> <span class="s1">&#39;1b&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ALERT_OTHER_DISEASES</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BEDDAYS_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_beddays_footprint</span><span class="p">({</span><span class="s1">&#39;general_bed&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">})</span></div>


<div class="viewcode-block" id="HSI_PostnatalSupervisor_TreatmentForObstetricFistula.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.postnatal_supervisor.html#tlo.methods.postnatal_supervisor.HSI_PostnatalSupervisor_TreatmentForObstetricFistula.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">squeeze_factor</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">mother</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">mother</span><span class="o">.</span><span class="n">is_alive</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">pregnancy_helper_functions</span><span class="o">.</span><span class="n">store_dalys_in_mni</span><span class="p">(</span>
            <span class="n">person_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;PregnancySupervisor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mother_and_newborn_info</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;pn_obstetric_fistula&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">_fistula_resolution&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>

        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s1">&#39;pn_obstetric_fistula&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
      <span class="lastupdated">Last updated on Jan 05, 2024.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>