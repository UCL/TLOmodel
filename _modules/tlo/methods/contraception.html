

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>tlo.methods.contraception &mdash; TLOmodel 0.1.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.png"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> TLOmodel
          

          
          </a>

          
            
            
              <div class="version">
                0.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Welcome</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../aims.html">Aims &amp; Objectives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../writeups.html">Model Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../azure_batch.html">Using Azure Batch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">TLOmodel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../methods.html">tlo.methods</a> &raquo;</li>
        
      <li>tlo.methods.contraception</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for tlo.methods.contraception</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Contraception module covering baseline fertility, contraception methods use, failure (pregnancy),</span>
<span class="sd">Switching contraceptive methods, and discontiuation rates by age</span>
<span class="sd">please see Dropbox/Thanzi la Onse/05 - Resources/Model design/Contraception-Pregnancy.pdf</span>
<span class="sd">for conceptual diagram</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">tlo</span> <span class="kn">import</span> <span class="n">Date</span><span class="p">,</span> <span class="n">DateOffset</span><span class="p">,</span> <span class="n">Module</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">,</span> <span class="n">Property</span><span class="p">,</span> <span class="n">Types</span><span class="p">,</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="nn">tlo.events</span> <span class="kn">import</span> <span class="n">PopulationScopeEventMixin</span><span class="p">,</span> <span class="n">RegularEvent</span>
<span class="kn">from</span> <span class="nn">tlo.util</span> <span class="kn">import</span> <span class="n">transition_states</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>


<div class="viewcode-block" id="Contraception"><a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.Contraception">[docs]</a><span class="k">class</span> <span class="nc">Contraception</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Contraception module covering baseline contraception methods use, failure (pregnancy),</span>
<span class="sd">    Switching contraceptive methods, and discontiuation rates by age</span>
<span class="sd">    please see Dropbox/Thanzi la Onse/05 - Resources/Programming Notes/Contraception-Pregnancy.pdf</span>
<span class="sd">    for conceptual diagram (lucid chart)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Contraception.__init__"><a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.Contraception.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resourcefilepath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resourcefilepath</span> <span class="o">=</span> <span class="n">resourcefilepath</span></div>

    <span class="c1"># Declare Metadata</span>
    <span class="n">METADATA</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Here we declare parameters for this module. Each parameter has a name, data type,</span>
    <span class="c1"># and longer description.</span>
    <span class="n">PARAMETERS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;fertility_schedule&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s1">&#39;Age_spec fertility&#39;</span><span class="p">),</span>
        <span class="s1">&#39;contraception_initiation1&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s1">&#39;irate1_&#39;</span><span class="p">),</span>  <span class="c1"># 2011-2016 rate</span>
        <span class="s1">&#39;contraception_initiation2&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s1">&#39;irate2_&#39;</span><span class="p">),</span>  <span class="c1"># 2011-2016 rate</span>
        <span class="s1">&#39;contraception_switching&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s1">&#39;Switching&#39;</span><span class="p">),</span>
        <span class="s1">&#39;contraception_switching_matrix&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s1">&#39;switching_matrix&#39;</span><span class="p">),</span>
        <span class="s1">&#39;contraception_discontinuation&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s1">&#39;Discontinuation&#39;</span><span class="p">),</span>
        <span class="s1">&#39;contraception_failure&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s1">&#39;Failure&#39;</span><span class="p">),</span>
        <span class="c1"># from Fracpoly regression:</span>
        <span class="s1">&#39;r_init1_age&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s1">&#39;proportioniate change in irate1 for each age in years&#39;</span><span class="p">),</span>
        <span class="c1"># from Fracpoly regression:</span>
        <span class="s1">&#39;r_discont_age&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s1">&#39;proportioniate change in drate for each age in years&#39;</span><span class="p">),</span>
        <span class="s1">&#39;rr_fail_under25&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s1">&#39;Increase in Failure rate for under-25s&#39;</span><span class="p">),</span>
        <span class="s1">&#39;r_init_year&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
                                 <span class="s1">&#39;proportional change in contraception initiation rates for each year, 2010 to 2100&#39;</span><span class="p">),</span>
        <span class="s1">&#39;r_discont_year&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
                                    <span class="s1">&#39;proportional change in contraception_discontinuation rate for each year,</span><span class="se">\</span>
<span class="s1">                                     2010 to 2100&#39;</span><span class="p">),</span>
        <span class="c1"># TODO: add relative fertility rates for HIV+ compared to HIV- by age group from Marston et al 2017</span>
    <span class="p">}</span>

    <span class="c1"># Next we declare the properties of individuals that this module provides.</span>
    <span class="c1"># Again each has a name, type and description. In addition, properties may be marked</span>
    <span class="c1"># as optional if they can be undefined for a given individual.</span>
    <span class="n">PROPERTIES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;co_contraception&#39;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">CATEGORICAL</span><span class="p">,</span> <span class="s1">&#39;Current contraceptive method&#39;</span><span class="p">,</span>
                                     <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;not_using&#39;</span><span class="p">,</span> <span class="s1">&#39;pill&#39;</span><span class="p">,</span> <span class="s1">&#39;IUD&#39;</span><span class="p">,</span> <span class="s1">&#39;injections&#39;</span><span class="p">,</span> <span class="s1">&#39;implant&#39;</span><span class="p">,</span> <span class="s1">&#39;male_condom&#39;</span><span class="p">,</span>
                                                 <span class="s1">&#39;female_sterilization&#39;</span><span class="p">,</span> <span class="s1">&#39;other_modern&#39;</span><span class="p">,</span> <span class="s1">&#39;periodic_abstinence&#39;</span><span class="p">,</span>
                                                 <span class="s1">&#39;withdrawal&#39;</span><span class="p">,</span> <span class="s1">&#39;other_traditional&#39;</span><span class="p">]),</span>
        <span class="c1"># These are the 11 categories of contraception (&#39;not using&#39; + 10 methods) from the DHS analysis of initiation,</span>
        <span class="c1"># discontinuation, failure and switching rates</span>
        <span class="c1"># &#39;other modern&#39; includes Male sterilization, Female Condom, Emergency contraception</span>
        <span class="c1"># &#39;other traditional&#39; includes</span>
        <span class="c1">#   lactational amenohroea (LAM),</span>
        <span class="c1">#   standard days method (SDM),</span>
        <span class="c1">#   &#39;other traditional method&#39;</span>
        <span class="c1"># Have replaced Age-spec fertility sheet in ResourceFile_DemographicData.xlsx (in this branch)</span>
        <span class="c1"># with the one in ResourceFile_Contraception.xlsx</span>
        <span class="c1"># (has 11 categories and one row for each age with baseline contraceptopn prevalences for</span>
        <span class="c1"># each of the 11 categories)</span>
        <span class="s1">&#39;co_date_of_childbirth&#39;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATE</span><span class="p">,</span> <span class="s1">&#39;Due date of child for those who become pregnant&#39;</span><span class="p">),</span>
        <span class="s1">&#39;is_pregnant&#39;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span> <span class="s1">&#39;Whether this individual is currently pregnant&#39;</span><span class="p">),</span>
        <span class="s1">&#39;date_of_last_pregnancy&#39;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATE</span><span class="p">,</span>
                                           <span class="s1">&#39;Date of the last pregnancy of this individual&#39;</span><span class="p">),</span>
        <span class="s1">&#39;co_unintended_preg&#39;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span> <span class="s1">&#39;Unintended pregnancies following contraception failure&#39;</span><span class="p">)</span>
    <span class="p">}</span>

<div class="viewcode-block" id="Contraception.read_parameters"><a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.Contraception.read_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">read_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_folder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Please see Contraception-Pregnancy.pdf for lucid chart explaining the relationships between</span>
<span class="sd">        baseline fertility rate, intitiation rates, discontinuation, failure and switching rates, and being on</span>
<span class="sd">        contraception or not, and being pregnant</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">workbook</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resourcefilepath</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;ResourceFile_Contraception.xlsx&#39;</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;fertility_schedule&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s1">&#39;Age_spec fertility&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;contraception_initiation2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s1">&#39;irate2_&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># this Excel sheet is irate2_all.csv outputs from &#39;initiation rates_age_stcox.do&#39;</span>
        <span class="c1"># Stata analysis of DHS contraception calendar data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;contraception_failure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s1">&#39;Failure&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># this Excel sheet is from contraception_failure_discontinuation_switching.csv outputs from</span>
        <span class="c1"># &#39;failure discontinuation switching rates.do&#39; Stata analysis of DHS contraception calendar data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;rr_fail_under25&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.2</span>
        <span class="c1"># From Guttmacher analysis - do not apply to female steriliztion or male sterilization</span>
        <span class="c1"># - note that as these are already 0 (see &#39;Failure&#39; Excel sheet) the rate will remain 0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;r_init1_age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s1">&#39;r_init1_age&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;r_discont_age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s1">&#39;r_discont_age&#39;</span><span class="p">]</span>
        <span class="c1"># from Stata analysis Step 3.5 of discontinuation &amp; switching rates_age.do: fracpoly: regress drate_allmeth age:</span>
        <span class="c1"># - see &#39;Discontinuation by age&#39; worksheet, results are in &#39;r_discont_age&#39; sheet</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;r_init_year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s1">&#39;r_init_year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;r_discont_year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s1">&#39;r_discont_year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)</span>

        <span class="c1"># =================== ARRANGE INPUTS FOR USE BY REGULAR EVENTS =============================</span>

        <span class="c1"># For ContraceptionSwitchingPoll.init1 -----------------------------------------------------</span>

        <span class="c1"># from Stata analysis line 250 of initiation rates_age_stcox_2005_2016_5yrPeriods.do:</span>
        <span class="c1"># fracpoly: regress _d age_</span>
        <span class="c1"># // fracpoly exact age (better fitting model, higher F statistic) - see &#39;Initiation1 by age&#39;</span>
        <span class="c1"># worksheet, results are in &#39;r_init1_age&#39; sheet</span>
        <span class="n">c_multiplier</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s1">&#39;r_init1_age&#39;</span><span class="p">]</span>

        <span class="c1"># &#39;irate_1_&#39; sheet created manually as a work around to address to do point on line 39</span>
        <span class="n">c_baseline</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s1">&#39;irate1_&#39;</span><span class="p">]</span>
        <span class="c1"># this Excel sheet is irate1_all.csv outputs from &#39;initiation rates_age_stcox.do&#39;</span>
        <span class="c1"># Stata analysis of DHS contraception calendar data</span>

        <span class="n">c_baseline</span> <span class="o">=</span> <span class="n">c_baseline</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;not_using&#39;</span><span class="p">])</span>
        <span class="n">c_baseline</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">c_baseline</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">c_multiplier</span><span class="p">),</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">c_adjusted</span> <span class="o">=</span> <span class="n">c_baseline</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">c_multiplier</span><span class="o">.</span><span class="n">r_init1_age</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
        <span class="n">c_adjusted</span> <span class="o">=</span> <span class="n">c_baseline</span> <span class="o">+</span> <span class="n">c_adjusted</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;contraception_initiation1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_adjusted</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">c_multiplier</span><span class="o">.</span><span class="n">age</span><span class="p">)</span>

        <span class="c1"># For ContraceptionSwitchingPoll.switch ----------------------------------------------------</span>
        <span class="n">switching_prob</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s1">&#39;Switching&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="c1"># this Excel sheet is from contraception_failure_discontinuation_switching.csv outputs from</span>
        <span class="c1"># &#39;failure discontinuation switching rates.do&#39; Stata analysis of DHS contraception calendar data</span>
        <span class="n">switching_prob</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;contraception_switching&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">switching_prob</span>

        <span class="n">switching_matrix</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s1">&#39;switching_matrix&#39;</span><span class="p">]</span>
        <span class="c1"># this Excel sheet is from contraception switching matrix outputs from line 144 of</span>
        <span class="c1"># &#39;failure discontinuation switching rates.do&#39; Stata analysis of DHS contraception calendar data</span>

        <span class="n">switching_matrix</span> <span class="o">=</span> <span class="n">switching_matrix</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;switchfrom&#39;</span><span class="p">)</span>
        <span class="n">switching_matrix</span> <span class="o">=</span> <span class="n">switching_matrix</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;contraception_switching_matrix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">switching_matrix</span>

        <span class="c1"># For ContraceptionSwitchingPoll.discontinue</span>
        <span class="n">c_baseline</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s1">&#39;Discontinuation&#39;</span><span class="p">]</span>
        <span class="c1"># this Excel sheet is from contraception_failure_discontinuation_switching.csv outputs from</span>
        <span class="c1"># &#39;failure discontinuation switching rates.do&#39; Stata analysis of DHS contraception calendar data</span>
        <span class="n">c_multiplier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;r_discont_age&#39;</span><span class="p">]</span>
        <span class="n">c_baseline</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">c_baseline</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">c_multiplier</span><span class="p">),</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">c_adjusted</span> <span class="o">=</span> <span class="n">c_baseline</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">c_multiplier</span><span class="o">.</span><span class="n">r_discont_age</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
        <span class="n">c_adjusted</span> <span class="o">=</span> <span class="n">c_baseline</span> <span class="o">+</span> <span class="n">c_adjusted</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;contraception_discontinuation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_adjusted</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">c_multiplier</span><span class="o">.</span><span class="n">age</span><span class="p">)</span></div>

<div class="viewcode-block" id="Contraception.initialise_population"><a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.Contraception.initialise_population">[docs]</a>    <span class="k">def</span> <span class="nf">initialise_population</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set our property values for the initial population.</span>

<span class="sd">        This method is called by the simulation when creating the initial population, and is</span>
<span class="sd">        responsible for assigning initial values, for every individual, of those properties</span>
<span class="sd">        &#39;owned&#39; by this module, i.e. those declared in the PROPERTIES dictionary above.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s1">&#39;co_contraception&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;not_using&#39;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s1">&#39;co_date_of_childbirth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s1">&#39;is_pregnant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s1">&#39;date_of_last_pregnancy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s1">&#39;co_unintended_preg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Assign contraception method</span>
        <span class="c1"># 1. select females aged 15-49 from population, for current year</span>
        <span class="n">females1549</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s1">&#39;F&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">49</span><span class="p">)</span>

        <span class="c1"># 2. Prepare probabilities lookup table</span>
        <span class="n">co_types_prob_lookup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;fertility_schedule&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">)</span>
        <span class="n">co_types_prob_lookup</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;basefert_dhs&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># drop unused columns</span>
        <span class="n">co_types</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">co_types_prob_lookup</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="c1"># normalise the values so they sum to 1 and collapse into single array</span>
        <span class="n">co_types_prob_lookup</span> <span class="o">=</span> <span class="n">co_types_prob_lookup</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># 3. apply probabilities of each contraception type to sim population</span>
        <span class="k">def</span> <span class="nf">pick_contraceptive</span><span class="p">(</span><span class="n">age</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;a function that randomly chooses a contraceptive based on age&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">co_types</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">co_types_prob_lookup</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">age</span><span class="p">])</span>

        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">females1549</span><span class="p">,</span> <span class="s1">&#39;co_contraception&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">females1549</span><span class="p">,</span> <span class="s1">&#39;age_years&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pick_contraceptive</span><span class="p">)</span></div>

<div class="viewcode-block" id="Contraception.initialise_simulation"><a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.Contraception.initialise_simulation">[docs]</a>    <span class="k">def</span> <span class="nf">initialise_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get ready for simulation start.</span>

<span class="sd">        This method is called just before the main simulation loop begins, and after all</span>
<span class="sd">        modules have read their parameters and the initial population has been created.</span>
<span class="sd">        It is a good place to add initial events to the event queue.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># starting contraception, switching contraception metho, and stopping contraception:</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">ContraceptionSwitchingPoll</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="c1"># check all females using contraception to determine if contraception fails i.e. woman becomes</span>
        <span class="c1"># pregnant whilst using contraception (starts at month 0)</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">Fail</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="c1"># check all population to determine if pregnancy should be triggered (repeats every month)</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">PregnancyPoll</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Launch the repeating event that will store statistics about the population structure</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">ContraceptionLoggingEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span></div>

<div class="viewcode-block" id="Contraception.on_birth"><a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.Contraception.on_birth">[docs]</a>    <span class="k">def</span> <span class="nf">on_birth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mother_id</span><span class="p">,</span> <span class="n">child_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialise our properties for a newborn individual.</span>

<span class="sd">        This is called by the simulation whenever a new person is born.</span>

<span class="sd">        :param mother_id: the mother for this child</span>
<span class="sd">        :param child_id: the new child</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s1">&#39;co_contraception&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;not_using&#39;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s1">&#39;co_date_of_childbirth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s1">&#39;is_pregnant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s1">&#39;date_of_last_pregnancy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s1">&#39;co_unintended_preg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Reset the mother&#39;s is_pregnant status showing that she is no longer pregnant</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">mother_id</span><span class="p">,</span> <span class="s1">&#39;is_pregnant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># TODO- commented out by joe, this way women always keep the date on which they most recently became pregnant,</span>
        <span class="c1">#  it is over written for new pregnancy</span>
        <span class="c1"># df.at[mother_id, &#39;date_of_last_pregnancy&#39;] = pd.NaT</span>

        <span class="c1"># Initiation of mother&#39;s contraception after birth (was previously Init2 event)</span>
        <span class="c1"># Notes: decide what contraceptive method they have (including not_using, according to</span>
        <span class="c1"># initiation_rate2 (irate_2)</span>
        <span class="c1"># Note the irate2s are low as they are just for the month after pregnancy and</span>
        <span class="c1"># then for the 99.48% who &#39;initiate&#39; to &#39;not_using&#39; (i.e. 1 - sum(irate2s))</span>
        <span class="c1"># they are then subject to the usual irate1s per month</span>
        <span class="c1"># - see Contraception-Pregnancy.pdf schematic</span>
        <span class="n">on_birth_co_probs</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;contraception_initiation2&#39;</span><span class="p">]</span>

        <span class="c1"># sample a single row of the init2 probabilities (weighted by those same probabilities)</span>
        <span class="n">chosen_co</span> <span class="o">=</span> <span class="n">on_birth_co_probs</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">on_birth_co_probs</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">)</span>

        <span class="c1"># the index of the row is the contraception type</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">mother_id</span><span class="p">,</span> <span class="s1">&#39;co_contraception&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chosen_co</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">|post_birth_contraception|</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s1">&#39;woman_index&#39;</span><span class="p">:</span> <span class="n">mother_id</span><span class="p">,</span>
                        <span class="s1">&#39;co_contraception&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">mother_id</span><span class="p">,</span> <span class="s1">&#39;co_contraception&#39;</span><span class="p">]</span>
                    <span class="p">})</span></div></div>


<div class="viewcode-block" id="ContraceptionSwitchingPoll"><a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.ContraceptionSwitchingPoll">[docs]</a><span class="k">class</span> <span class="nc">ContraceptionSwitchingPoll</span><span class="p">(</span><span class="n">RegularEvent</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Switching contraception status for population</span>

<span class="sd">    This event looks across:</span>
<span class="sd">    1) all women who are &#39;not_using&#39; contraception to determine if they start using each method=</span>
<span class="sd">    according to initiation_rate1 (irate_1)</span>
<span class="sd">    2) all women who are using a contraception method to determine if they switch to another</span>
<span class="sd">    method according to switching_rate, and then for those that switch directs towards a new method according to</span>
<span class="sd">    switching_matrix</span>
<span class="sd">    3) all women who are using a contraception method to determine if they stop using it</span>
<span class="sd">    according to discontinuation_rate</span>

<span class="sd">    (Was previously in Init1, Switch, Discontinue events)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ContraceptionSwitchingPoll.__init__"><a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.ContraceptionSwitchingPoll.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">age_low</span> <span class="o">=</span> <span class="mi">15</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">age_high</span> <span class="o">=</span> <span class="mi">49</span></div>

<div class="viewcode-block" id="ContraceptionSwitchingPoll.apply"><a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.ContraceptionSwitchingPoll.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="n">possible_co_users</span> <span class="o">=</span> <span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s1">&#39;F&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
                             <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span>
                             <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">age_low</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">age_high</span><span class="p">)</span> <span class="o">&amp;</span>
                             <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">is_pregnant</span><span class="p">)</span>

        <span class="n">currently_using_co</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">possible_co_users</span> <span class="o">&amp;</span>
                                      <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">co_contraception</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;not_using&#39;</span><span class="p">,</span> <span class="s1">&#39;female_steralization&#39;</span><span class="p">])]</span>
        <span class="n">currently_not_using_co</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">possible_co_users</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">co_contraception</span> <span class="o">==</span> <span class="s1">&#39;not_using&#39;</span><span class="p">)]</span>

        <span class="c1"># not using -&gt; using</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init1</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">currently_not_using_co</span><span class="p">)</span>

        <span class="c1"># using A -&gt; using B</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">currently_using_co</span><span class="p">)</span>

        <span class="c1"># using -&gt; not using</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discontinue</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">currently_using_co</span><span class="p">)</span></div>

<div class="viewcode-block" id="ContraceptionSwitchingPoll.init1"><a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.ContraceptionSwitchingPoll.init1">[docs]</a>    <span class="k">def</span> <span class="nf">init1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">individuals_not_using</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;check all females not using contraception to determine if contraception starts</span>
<span class="sd">        i.e. category should change from &#39;not_using&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span>

        <span class="n">c_multiplier</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;r_init_year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="s1">&#39;r_init_year&#39;</span><span class="p">]</span>
        <span class="n">co_start_prob_by_age</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;contraception_initiation1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">c_multiplier</span><span class="p">)</span>
        <span class="n">co_start_prob_by_age</span><span class="p">[</span><span class="s1">&#39;not_using&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">co_start_prob_by_age</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># all the contraceptive types we can randomly choose</span>
        <span class="n">co_types</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">co_start_prob_by_age</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">pick_random_contraceptive</span><span class="p">(</span><span class="n">age</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;random selects a contraceptive using probabilities for given age&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">co_types</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">co_start_prob_by_age</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">age</span><span class="p">])</span>

        <span class="c1"># select a random contraceptive for everyone not currently using</span>
        <span class="n">random_co</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">individuals_not_using</span><span class="p">,</span> <span class="s1">&#39;age_years&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pick_random_contraceptive</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">random_co</span><span class="p">):</span>
            <span class="c1"># get index of all those now using</span>
            <span class="n">now_using_co</span> <span class="o">=</span> <span class="n">random_co</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">random_co</span> <span class="o">!=</span> <span class="s1">&#39;not_using&#39;</span><span class="p">]</span>

            <span class="c1"># only update entries for all those now using a contraceptive</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">now_using_co</span><span class="p">,</span> <span class="s1">&#39;co_contraception&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_co</span><span class="p">[</span><span class="n">now_using_co</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">woman</span> <span class="ow">in</span> <span class="n">now_using_co</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">|start_contraception1|</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                            <span class="p">{</span>
                                <span class="s1">&#39;woman_index&#39;</span><span class="p">:</span> <span class="n">woman</span><span class="p">,</span>
                                <span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">woman</span><span class="p">,</span> <span class="s1">&#39;age_years&#39;</span><span class="p">],</span>
                                <span class="s1">&#39;co_contraception&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">woman</span><span class="p">,</span> <span class="s1">&#39;co_contraception&#39;</span><span class="p">]</span>
                            <span class="p">})</span></div>

<div class="viewcode-block" id="ContraceptionSwitchingPoll.switch"><a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.ContraceptionSwitchingPoll.switch">[docs]</a>    <span class="k">def</span> <span class="nf">switch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">individuals_using</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;check all females using contraception to determine if contraception Switches</span>
<span class="sd">        i.e. category should change from any method to a new method (not including &#39;not_using&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span>

        <span class="n">switching_prob</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;contraception_switching&#39;</span><span class="p">]</span>
        <span class="n">switching_matrix</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;contraception_switching_matrix&#39;</span><span class="p">]</span>

        <span class="c1"># get the probability of switching contraceptive for all those currently using</span>
        <span class="n">co_switch_prob</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">individuals_using</span><span class="p">,</span> <span class="s1">&#39;co_contraception&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">switching_prob</span><span class="o">.</span><span class="n">probability</span><span class="p">)</span>

        <span class="c1"># randomly select some individuals to switch contraceptive</span>
        <span class="n">random_draw</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">individuals_using</span><span class="p">))</span>
        <span class="n">switch_co</span> <span class="o">=</span> <span class="n">co_switch_prob</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">co_switch_prob</span> <span class="o">&gt;</span> <span class="n">random_draw</span><span class="p">]</span>

        <span class="c1"># if no one is switching, exit</span>
        <span class="k">if</span> <span class="n">switch_co</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># select new contraceptive using switching matrix</span>
        <span class="n">new_co</span> <span class="o">=</span> <span class="n">transition_states</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">switch_co</span><span class="p">,</span> <span class="s1">&#39;co_contraception&#39;</span><span class="p">],</span> <span class="n">switching_matrix</span><span class="p">,</span> <span class="n">rng</span><span class="p">)</span>

        <span class="c1"># log old -&gt; new contraception types</span>
        <span class="k">for</span> <span class="n">woman</span> <span class="ow">in</span> <span class="n">switch_co</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">|switchto_contraception|</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;woman_index&#39;</span><span class="p">:</span> <span class="n">woman</span><span class="p">,</span>
                            <span class="s1">&#39;co_from&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">woman</span><span class="p">,</span> <span class="s1">&#39;co_contraception&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;co_to&#39;</span><span class="p">:</span> <span class="n">new_co</span><span class="p">[</span><span class="n">woman</span><span class="p">]</span>
                        <span class="p">})</span>

        <span class="c1"># update contraception for all who switched</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">switch_co</span><span class="p">,</span> <span class="s1">&#39;co_contraception&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_co</span></div>

<div class="viewcode-block" id="ContraceptionSwitchingPoll.discontinue"><a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.ContraceptionSwitchingPoll.discontinue">[docs]</a>    <span class="k">def</span> <span class="nf">discontinue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">individuals_using</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;check all females using contraception to determine if contraception discontinues</span>
<span class="sd">        i.e. category should change to &#39;not_using&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span>

        <span class="n">c_multiplier</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;r_discont_year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="s1">&#39;r_discont_year&#39;</span><span class="p">]</span>
        <span class="n">c_adjustment</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;contraception_discontinuation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">c_multiplier</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_prob_discontinued</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;returns the probability of discontinuing contraceptive based on age and current</span>
<span class="sd">            contraceptive&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">c_adjustment</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">age_years</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">co_contraception</span><span class="p">]</span>

        <span class="c1"># get the probability of discontinuing for all currently using</span>
        <span class="n">discontinue_prob</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">individuals_using</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_prob_discontinued</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># random choose some to discontinue</span>
        <span class="n">random_draw</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">individuals_using</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">random_draw</span><span class="p">):</span>
            <span class="n">co_discontinue</span> <span class="o">=</span> <span class="n">discontinue_prob</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">discontinue_prob</span> <span class="o">&gt;</span> <span class="n">random_draw</span><span class="p">]</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">co_discontinue</span><span class="p">,</span> <span class="s1">&#39;co_contraception&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;not_using&#39;</span>

            <span class="k">for</span> <span class="n">woman</span> <span class="ow">in</span> <span class="n">co_discontinue</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">|stop_contraception|</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                            <span class="p">{</span>
                                <span class="s1">&#39;woman_index&#39;</span><span class="p">:</span> <span class="n">woman</span><span class="p">,</span>
                            <span class="p">})</span></div></div>


<div class="viewcode-block" id="Fail"><a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.Fail">[docs]</a><span class="k">class</span> <span class="nc">Fail</span><span class="p">(</span><span class="n">RegularEvent</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This event looks across all women who are using a contraception method to determine if they become pregnant</span>
<span class="sd">    i.e. the method fails according to failure_rate</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Fail.__init__"><a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.Fail.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>  <span class="c1"># runs every month</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">age_low</span> <span class="o">=</span> <span class="mi">15</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">age_high</span> <span class="o">=</span> <span class="mi">49</span></div>

<div class="viewcode-block" id="Fail.apply"><a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.Fail.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Checking to see if anyone becomes pregnant whilst on contraception&#39;</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span>

        <span class="n">prob_of_failure</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;contraception_failure&#39;</span><span class="p">]</span>

        <span class="c1"># TODO: N.B edited by joe- women who are in labour, have been pregnant in the last month or have previously had</span>
        <span class="c1">#  a hysterectomy cannot get pregnant(eventually should remove women with hysterectomy from being on</span>
        <span class="c1">#  contraception?)</span>

        <span class="n">possible_to_fail</span> <span class="o">=</span> <span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s1">&#39;F&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
                            <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span>
                            <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">is_pregnant</span> <span class="o">&amp;</span>
                            <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">la_currently_in_labour</span> <span class="o">&amp;</span>
                            <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">la_has_had_hysterectomy</span> <span class="o">&amp;</span>
                            <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">age_low</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">age_high</span><span class="p">)</span> <span class="o">&amp;</span>
                            <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">co_contraception</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;not_using&#39;</span><span class="p">,</span> <span class="s1">&#39;female_steralization&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
                            <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">la_is_postpartum</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">ps_ectopic_pregnancy</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
                            <span class="p">)</span>

        <span class="n">prob_of_failure</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">possible_to_fail</span><span class="p">,</span> <span class="s1">&#39;co_contraception&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">prob_of_failure</span><span class="p">)</span>

        <span class="c1"># apply increased risk of failure to under 25s</span>
        <span class="n">prob_of_failure</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">possible_to_fail</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">25</span><span class="p">))]]</span> <span class="o">*=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;rr_fail_under25&#39;</span><span class="p">]</span>

        <span class="c1"># randomly select some individual&#39;s for contraceptive failure</span>
        <span class="n">random_draw</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">prob_of_failure</span><span class="p">))</span>
        <span class="n">women_co_failure</span> <span class="o">=</span> <span class="n">prob_of_failure</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">prob_of_failure</span> <span class="o">&gt;</span> <span class="n">random_draw</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">woman</span> <span class="ow">in</span> <span class="n">women_co_failure</span><span class="p">:</span>
            <span class="c1"># this woman&#39;s contraception has failed - she is pregnant</span>
            <span class="c1"># Women currently in labour cannot become pregnant</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">woman</span><span class="p">,</span> <span class="s1">&#39;is_pregnant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">woman</span><span class="p">,</span> <span class="s1">&#39;date_of_last_pregnancy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">woman</span><span class="p">,</span> <span class="s1">&#39;co_unintended_preg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;Labour&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_date_of_labour</span><span class="p">(</span><span class="n">woman</span><span class="p">)</span>

            <span class="c1"># outputs some logging if any pregnancy (contraception failure)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">|fail_contraception|</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;woman_index&#39;</span><span class="p">:</span> <span class="n">woman</span><span class="p">,</span>
                            <span class="s1">&#39;birth_booked&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">woman</span><span class="p">,</span> <span class="s1">&#39;co_date_of_childbirth&#39;</span><span class="p">])</span>
                        <span class="p">})</span></div></div>


<div class="viewcode-block" id="PregnancyPoll"><a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.PregnancyPoll">[docs]</a><span class="k">class</span> <span class="nc">PregnancyPoll</span><span class="p">(</span><span class="n">RegularEvent</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This event looks across each woman in the population to determine who will become pregnant</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PregnancyPoll.__init__"><a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.PregnancyPoll.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">age_low</span> <span class="o">=</span> <span class="mi">15</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">age_high</span> <span class="o">=</span> <span class="mi">49</span></div>

<div class="viewcode-block" id="PregnancyPoll.apply"><a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.PregnancyPoll.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Checking to see if anyone should become pregnant....&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;</span> <span class="n">Date</span><span class="p">(</span><span class="mi">2035</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Now after 2035&#39;</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>  <span class="c1"># get the population dataframe</span>

        <span class="c1"># simplified with the addition of new postnatal property (women cant get pregnant 42 days post birth)</span>
        <span class="c1"># JC 10/02/2021</span>
        <span class="c1"># get the subset of women from the population dataframe and relevant characteristics</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s1">&#39;F&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">age_low</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">age_high</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">is_pregnant</span> <span class="o">&amp;</span> \
                 <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">co_contraception</span> <span class="o">==</span> <span class="s1">&#39;not_using&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">la_currently_in_labour</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">la_has_had_hysterectomy</span> <span class="o">&amp;</span> \
            <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">la_is_postpartum</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">ps_ectopic_pregnancy</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>

        <span class="n">females</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">subset</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;co_contraception&#39;</span><span class="p">,</span> <span class="s1">&#39;age_years&#39;</span><span class="p">]]</span>

        <span class="c1"># load the fertility schedule (imported datasheet from excel workbook)</span>
        <span class="n">fertility_schedule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;fertility_schedule&#39;</span><span class="p">]</span>

        <span class="c1"># --------</span>

        <span class="c1"># get the probability of pregnancy for each woman in the model, through merging with the fert_schedule data</span>
        <span class="n">len_before_merge</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">females</span><span class="p">)</span>
        <span class="n">females</span> <span class="o">=</span> <span class="n">females</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">fertility_schedule</span><span class="p">,</span>
                                              <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;age_years&#39;</span><span class="p">],</span>
                                              <span class="c1"># TimC: got rid of &#39;contraception&#39; here as just one</span>
                                              <span class="c1"># basefert_dhs per age (see new &#39;Age_spec fertility&#39; sheet)</span>
                                              <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">],</span>
                                              <span class="c1"># TimC: got rid of &#39;cmeth&#39; here as just one basefert_dhs per age</span>
                                              <span class="c1"># (see new &#39;Age_spec fertility&#39; sheet)</span>
                                              <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">females</span><span class="p">)</span> <span class="o">==</span> <span class="n">len_before_merge</span>

        <span class="c1"># flipping the coin to determine if this woman will become pregnant (basefert_dhs is in the Excel sheet)</span>
        <span class="n">newly_pregnant</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">females</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">females</span><span class="o">.</span><span class="n">basefert_dhs</span> <span class="o">/</span> <span class="mi">12</span><span class="p">)</span>

        <span class="c1"># the imported number is a yearly proportion. So adjust the rate accordingly</span>
        <span class="c1"># to the frequency with which the event is recurring</span>
        <span class="c1"># TODO: this should be linked to the self.frequency value</span>

        <span class="n">newly_pregnant_ids</span> <span class="o">=</span> <span class="n">females</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">newly_pregnant</span><span class="p">]</span>

        <span class="c1"># updating the pregancy status for that women</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">newly_pregnant_ids</span><span class="p">,</span> <span class="s1">&#39;is_pregnant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">newly_pregnant_ids</span><span class="p">,</span> <span class="s1">&#39;date_of_last_pregnancy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>

        <span class="c1"># loop through each newly pregnant women in order to schedule them to have labour sheduled</span>
        <span class="k">for</span> <span class="n">female_id</span> <span class="ow">in</span> <span class="n">newly_pregnant_ids</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;Labour&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_date_of_labour</span><span class="p">(</span><span class="n">female_id</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">|pregnant_at_age|</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;person_id&#39;</span><span class="p">:</span> <span class="n">female_id</span><span class="p">,</span>
                            <span class="s1">&#39;age_years&#39;</span><span class="p">:</span> <span class="n">females</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">female_id</span><span class="p">,</span> <span class="s1">&#39;age_years&#39;</span><span class="p">]</span>
                        <span class="p">})</span></div></div>


<div class="viewcode-block" id="ContraceptionLoggingEvent"><a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.ContraceptionLoggingEvent">[docs]</a><span class="k">class</span> <span class="nc">ContraceptionLoggingEvent</span><span class="p">(</span><span class="n">RegularEvent</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">):</span>
<div class="viewcode-block" id="ContraceptionLoggingEvent.__init__"><a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.ContraceptionLoggingEvent.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Logs outputs for analysis_contraception</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># run this event every 12 months (every year)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repeat</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">age_low</span> <span class="o">=</span> <span class="mi">15</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">age_high</span> <span class="o">=</span> <span class="mi">49</span></div>

<div class="viewcode-block" id="ContraceptionLoggingEvent.apply"><a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.ContraceptionLoggingEvent.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="n">contraception_count</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">age_low</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">age_high</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
            <span class="s1">&#39;co_contraception&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">|contraception|</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">contraception_count</span><span class="p">),</span>
                        <span class="s1">&#39;not_using&#39;</span><span class="p">:</span> <span class="n">contraception_count</span><span class="p">[</span><span class="s1">&#39;not_using&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;using&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">contraception_count</span><span class="p">)</span> <span class="o">-</span> <span class="n">contraception_count</span><span class="p">[</span><span class="s1">&#39;not_using&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;pill&#39;</span><span class="p">:</span> <span class="n">contraception_count</span><span class="p">[</span><span class="s1">&#39;pill&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;IUD&#39;</span><span class="p">:</span> <span class="n">contraception_count</span><span class="p">[</span><span class="s1">&#39;IUD&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;injections&#39;</span><span class="p">:</span> <span class="n">contraception_count</span><span class="p">[</span><span class="s1">&#39;injections&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;implant&#39;</span><span class="p">:</span> <span class="n">contraception_count</span><span class="p">[</span><span class="s1">&#39;implant&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;male_condom&#39;</span><span class="p">:</span> <span class="n">contraception_count</span><span class="p">[</span><span class="s1">&#39;male_condom&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;female_sterilization&#39;</span><span class="p">:</span> <span class="n">contraception_count</span><span class="p">[</span><span class="s1">&#39;female_sterilization&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;other_modern&#39;</span><span class="p">:</span> <span class="n">contraception_count</span><span class="p">[</span><span class="s1">&#39;other_modern&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;periodic_abstinence&#39;</span><span class="p">:</span> <span class="n">contraception_count</span><span class="p">[</span><span class="s1">&#39;periodic_abstinence&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;withdrawal&#39;</span><span class="p">:</span> <span class="n">contraception_count</span><span class="p">[</span><span class="s1">&#39;withdrawal&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;other_traditional&#39;</span><span class="p">:</span> <span class="n">contraception_count</span><span class="p">[</span><span class="s1">&#39;other_traditional&#39;</span><span class="p">]</span>
                    <span class="p">})</span>

        <span class="n">preg_counts</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">age_low</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">age_high</span><span class="p">)]</span><span class="o">.</span><span class="n">is_pregnant</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="n">is_preg_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">age_low</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">age_high</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_pregnant</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">is_notpreg_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">age_low</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">age_high</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">is_pregnant</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">|pregnancy|</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">preg_counts</span><span class="p">),</span>
                        <span class="s1">&#39;pregnant&#39;</span><span class="p">:</span> <span class="n">is_preg_count</span><span class="p">,</span>
                        <span class="s1">&#39;not_pregnant&#39;</span><span class="p">:</span> <span class="n">is_notpreg_count</span>
                    <span class="p">})</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
      <span class="lastupdated">
        Last updated on Jun 23, 2021.
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>