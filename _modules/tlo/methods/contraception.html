<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tlo.methods.contraception &mdash; TLOmodel 0.1.dev2407+gde94ffa documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=d10597a4" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/theme_overrides.css?v=6ea10ece" />

  
    <link rel="shortcut icon" href="../../../_static/favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=8142288c"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            TLOmodel
          </a>
              <div class="version">
                0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Welcome</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../aims.html">Aims &amp; Objectives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../writeups.html">Model Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data_sources.html">Data Sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../azure_batch.html">Using Azure Batch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../resources/index.html">Resource files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../learning.html">Learning Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributors.html">Contributors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">TLOmodel</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../methods.html">tlo.methods</a></li>
      <li class="breadcrumb-item active">tlo.methods.contraception</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for tlo.methods.contraception</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">tlo</span> <span class="kn">import</span> <span class="n">Date</span><span class="p">,</span> <span class="n">DateOffset</span><span class="p">,</span> <span class="n">Module</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">,</span> <span class="n">Property</span><span class="p">,</span> <span class="n">Types</span><span class="p">,</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="nn">tlo.analysis.utils</span> <span class="kn">import</span> <span class="n">flatten_multi_index_series_into_dict_for_logging</span>
<span class="kn">from</span> <span class="nn">tlo.events</span> <span class="kn">import</span> <span class="n">Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">,</span> <span class="n">RegularEvent</span>
<span class="kn">from</span> <span class="nn">tlo.methods.hsi_event</span> <span class="kn">import</span> <span class="n">HSI_Event</span>
<span class="kn">from</span> <span class="nn">tlo.util</span> <span class="kn">import</span> <span class="n">random_date</span><span class="p">,</span> <span class="n">sample_outcome</span><span class="p">,</span> <span class="n">transition_states</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>


<div class="viewcode-block" id="Contraception">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.Contraception">[docs]</a>
<span class="k">class</span> <span class="nc">Contraception</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Contraception module covering baseline contraception methods use, failure (i.e., pregnancy),</span>
<span class="sd">    Switching contraceptive methods, and discontinuation rates by age.</span>
<span class="sd">    Calibration is done in two stages:</span>
<span class="sd">    (i) A scaling factor on the risk of pregnancy (`scaling_factor_on_monthly_risk_of_pregnancy`) is used to induce the</span>
<span class="sd">     correct number of age-specific births initially, given the initial pattern of contraceptive use;</span>
<span class="sd">    (ii) Trends over time in the risk of starting (`time_age_trend_in_initiation`) and stopping</span>
<span class="sd">    (`time_age_trend_in_stopping`) of contraceptives are used to induce the correct trend in the number of births.&quot;&quot;&quot;</span>

    <span class="n">INIT_DEPENDENCIES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Demography&#39;</span><span class="p">}</span>

    <span class="n">OPTIONAL_INIT_DEPENDENCIES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">}</span>

    <span class="n">ADDITIONAL_DEPENDENCIES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Labour&#39;</span><span class="p">,</span> <span class="s1">&#39;Hiv&#39;</span><span class="p">}</span>

    <span class="n">METADATA</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">PARAMETERS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Method_Use_In_2010&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span>
                                        <span class="s1">&#39;Proportion of women using each method in 2010, by age.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;Pregnancy_NotUsing_In_2010&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span>
                                                <span class="s1">&#39;Probability per year of a women not on contraceptive becoming &#39;</span>
                                                <span class="s1">&#39;pregnant, by age.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;Pregnancy_NotUsing_HIVeffect&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span>
                                                  <span class="s1">&#39;Relative probability of becoming pregnant whilst not using a &#39;</span>
                                                  <span class="s1">&#39;a contraceptive for HIV-positive women compared to HIV-negative &#39;</span>
                                                  <span class="s1">&#39;women.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;Failure_ByMethod&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span>
                                      <span class="s1">&#39;Probability per month of a women on a contraceptive becoming pregnant, by &#39;</span>
                                      <span class="s1">&#39;method.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;rr_fail_under25&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
                                     <span class="s1">&#39;The relative risk of becoming pregnant whilst using a contraceptive for woman &#39;</span>
                                     <span class="s1">&#39;younger than 25 years compared to older women.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;Initiation_ByMethod&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span>
                                         <span class="s1">&#39;Probability per month of a women who is not using any contraceptive method of&#39;</span>
                                         <span class="s1">&#39; starting use of a method, by method.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;Interventions_Pop&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span>
                                       <span class="s1">&#39;Pop (population scale contraception intervention) intervention multiplier.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;Interventions_PPFP&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span>
                                        <span class="s1">&#39;PPFP (post-partum family planning) intervention multiplier.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;Initiation_ByAge&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span>
                                      <span class="s1">&#39;The effect of age on the probability of starting use of contraceptive (add one &#39;</span>
                                      <span class="s1">&#39;for multiplicative effect).&#39;</span><span class="p">),</span>
        <span class="s1">&#39;Initiation_AfterBirth&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span>
                                           <span class="s1">&#39;The probability of a woman starting a contraceptive immidiately after birth&#39;</span>
                                           <span class="s1">&#39;, by method.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;Discontinuation_ByMethod&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span>
                                              <span class="s1">&#39;The probability per month of discontinuing use of a method, by method.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;Discontinuation_ByAge&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span>
                                           <span class="s1">&#39;The effect of age on the probability of discontinuing use of contraceptive &#39;</span>
                                           <span class="s1">&#39;(add one for multiplicative effect).&#39;</span><span class="p">),</span>

        <span class="s1">&#39;Prob_Switch_From&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span>
                                      <span class="s1">&#39;The probability per month that a women switches from one form of contraceptive &#39;</span>
                                      <span class="s1">&#39;to another, conditional that she will not discontinue use of the method.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;Prob_Switch_From_And_To&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span>
                                             <span class="s1">&#39;The probability of switching to a new method, by method, conditional that&#39;</span>
                                             <span class="s1">&#39; the woman will switch to a new method.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;days_between_appts_for_maintenance&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span>
                                                        <span class="s1">&#39;The number of days between successive family planning &#39;</span>
                                                        <span class="s1">&#39;appointments for women that are maintaining the use of a &#39;</span>
                                                        <span class="s1">&#39;method (for each method in&#39;</span>
                                                        <span class="s1">&#39;sorted(self.states_that_may_require_HSI_to_maintain_on), i.e.&#39;</span>
                                                        <span class="s1">&#39;[IUD, implant, injections, other_modern, pill]).&#39;</span><span class="p">),</span>
        <span class="s1">&#39;age_specific_fertility_rates&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s1">&#39;Data table from official source (WPP) for age-specific fertility rates and calendar &#39;</span>
                              <span class="s1">&#39;period.&#39;</span><span class="p">),</span>

        <span class="s1">&#39;scaling_factor_on_monthly_risk_of_pregnancy&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span> <span class="s2">&quot;Scaling factor (by age-group: 15-19, 20-24, ..., 45-49) on the monthly risk of pregnancy and &quot;</span>
                        <span class="s2">&quot;contraceptive failure rate. This value is found through calibration so that, at the beginning &quot;</span>
                        <span class="s2">&quot;of the simulation, the age-specific monthly probability of a woman having a live birth matches&quot;</span>
                        <span class="s2">&quot; the WPP age-specific fertility rate value for the same year.&quot;</span><span class="p">),</span>

        <span class="s1">&#39;max_number_of_runs_of_hsi_if_consumable_not_available&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span> <span class="s2">&quot;The maximum number of time an HSI can run (repeats occur if the consumables are not &quot;</span>
                       <span class="s2">&quot;available).&quot;</span><span class="p">),</span>

        <span class="s1">&#39;max_days_delay_between_decision_to_change_method_and_hsi_scheduled&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span> <span class="s2">&quot;The maximum delay (in days) between the decision for a contraceptive to change and the `topen` &quot;</span>
                       <span class="s2">&quot;date of the HSI that is scheduled to effect the change (when using the healthsystem).&quot;</span><span class="p">),</span>

        <span class="s1">&#39;use_interventions&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span> <span class="s2">&quot;if True: FP interventions (pop &amp; ppfp) are simulated from the date &#39;interventions_start_date&#39;,&quot;</span>
                        <span class="s2">&quot; if False: FP interventions (pop &amp; ppfp) are not simulated.&quot;</span><span class="p">),</span>
        <span class="s1">&#39;interventions_start_date&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">DATE</span><span class="p">,</span> <span class="s2">&quot;The date since which the FP interventions (pop &amp; ppfp) are implemented, if at all (ie, if &quot;</span>
                        <span class="s2">&quot;use_interventions==True&quot;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">all_contraception_states</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;not_using&#39;</span><span class="p">,</span> <span class="s1">&#39;pill&#39;</span><span class="p">,</span> <span class="s1">&#39;IUD&#39;</span><span class="p">,</span> <span class="s1">&#39;injections&#39;</span><span class="p">,</span> <span class="s1">&#39;implant&#39;</span><span class="p">,</span> <span class="s1">&#39;male_condom&#39;</span><span class="p">,</span> <span class="s1">&#39;female_sterilization&#39;</span><span class="p">,</span> <span class="s1">&#39;other_modern&#39;</span><span class="p">,</span>
        <span class="s1">&#39;periodic_abstinence&#39;</span><span class="p">,</span> <span class="s1">&#39;withdrawal&#39;</span><span class="p">,</span> <span class="s1">&#39;other_traditional&#39;</span>
    <span class="p">}</span>
    <span class="c1"># These are the 11 categories of contraception (&#39;not_using&#39; + 10 methods) from the DHS analysis of initiation,</span>
    <span class="c1"># discontinuation, failure and switching rates.</span>
    <span class="c1"># &#39;other modern&#39; includes Male sterilization, Female Condom, Emergency contraception;</span>
    <span class="c1"># &#39;other traditional&#39; includes lactational amenohroea (LAM),  standard days method (SDM), &#39;other traditional</span>
    <span class="c1">#  method&#39;).</span>
    <span class="n">contraceptives_initiated_with_additional_items</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;pill&#39;</span><span class="p">,</span> <span class="s1">&#39;IUD&#39;</span><span class="p">,</span> <span class="s1">&#39;injections&#39;</span><span class="p">,</span> <span class="s1">&#39;implant&#39;</span><span class="p">,</span> <span class="s1">&#39;female_sterilization&#39;</span>
    <span class="p">}</span>
    <span class="c1"># These are methods for which additional items (&#39;co_initiation&#39;) are used to initiate the method after not using any</span>
    <span class="c1"># contraceptive or after using a method which is not in this category.</span>

    <span class="n">PROPERTIES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;co_contraception&#39;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">CATEGORICAL</span><span class="p">,</span> <span class="s1">&#39;Current contraceptive method&#39;</span><span class="p">,</span>
                                     <span class="n">categories</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_contraception_states</span><span class="p">)),</span>
        <span class="s1">&#39;is_pregnant&#39;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span> <span class="s1">&#39;Whether this individual is currently pregnant&#39;</span><span class="p">),</span>
        <span class="s1">&#39;date_of_last_pregnancy&#39;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATE</span><span class="p">,</span> <span class="s1">&#39;Date that the most recent or current pregnancy began.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;co_unintended_preg&#39;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span> <span class="s1">&#39;Whether the most recent or current pregnancy was unintended.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;co_date_of_last_fp_appt&#39;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATE</span><span class="p">,</span>
                                            <span class="s1">&#39;The date of the most recent Family Planning appointment. This is used to &#39;</span>
                                            <span class="s1">&#39;determine if a Family Planning appointment is needed to maintain the &#39;</span>
                                            <span class="s1">&#39;person on their current contraceptive. If the person is to maintain use of&#39;</span>
                                            <span class="s1">&#39; the current contraceptive, they will have an HSI only if the days elapsed&#39;</span>
                                            <span class="s1">&#39; since this value exceeds the method-specific parameter &#39;</span>
                                            <span class="s1">&#39;`days_between_appts_for_maintenance`.&#39;</span>
                                            <span class="p">)</span>
    <span class="p">}</span>

<div class="viewcode-block" id="Contraception.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.Contraception.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resourcefilepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_healthsystem</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">run_update_contraceptive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resourcefilepath</span> <span class="o">=</span> <span class="n">resourcefilepath</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">use_healthsystem</span> <span class="o">=</span> <span class="n">use_healthsystem</span>  <span class="c1"># if True: initiation and switches to contraception require an HSI;</span>
        <span class="c1"># if False: initiation and switching do not occur through an HSI</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">run_update_contraceptive</span> <span class="o">=</span> <span class="n">run_update_contraceptive</span>  <span class="c1"># If &#39;False&#39; prevents any logic occurring for</span>
        <span class="c1">#                                                           updating/changing/maintaining contraceptive methods.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">states_that_may_require_HSI_to_switch_to</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;male_condom&#39;</span><span class="p">,</span> <span class="s1">&#39;injections&#39;</span><span class="p">,</span> <span class="s1">&#39;other_modern&#39;</span><span class="p">,</span> <span class="s1">&#39;IUD&#39;</span><span class="p">,</span> <span class="s1">&#39;pill&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;female_sterilization&#39;</span><span class="p">,</span> <span class="s1">&#39;implant&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">states_that_may_require_HSI_to_maintain_on</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;male_condom&#39;</span><span class="p">,</span> <span class="s1">&#39;injections&#39;</span><span class="p">,</span> <span class="s1">&#39;other_modern&#39;</span><span class="p">,</span> <span class="s1">&#39;IUD&#39;</span><span class="p">,</span> <span class="s1">&#39;pill&#39;</span><span class="p">,</span>
                                                           <span class="s1">&#39;implant&#39;</span><span class="p">}</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">states_that_may_require_HSI_to_switch_to</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_contraception_states</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">states_that_may_require_HSI_to_maintain_on</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states_that_may_require_HSI_to_switch_to</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">processed_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># (Will store the processed data for rates/probabilities of outcomes).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cons_codes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># (Will store the consumables codes for use in the HSI)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng2</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (Will be a second random number generator, used for things to do with scheduling HSI)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_women_ids_sterilized_below30</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># The ids of women who had female sterilization initiated when they</span></div>

        <span class="c1">#                                             were less than 30 years old.</span>

<div class="viewcode-block" id="Contraception.read_parameters">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.Contraception.read_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">read_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_folder</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Import the relevant sheets from the ResourceFile (excel workbook) and declare values for other parameters</span>
<span class="sd">        (CSV ResourceFile).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">workbook</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resourcefilepath</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;contraception&#39;</span> <span class="o">/</span> <span class="s1">&#39;ResourceFile_Contraception.xlsx&#39;</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Import selected sheets from the workbook as the parameters</span>
        <span class="n">sheet_names</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;Method_Use_In_2010&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Pregnancy_NotUsing_In_2010&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Pregnancy_NotUsing_HIVeffect&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Failure_ByMethod&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Initiation_ByAge&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Initiation_ByMethod&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Interventions_Pop&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Interventions_PPFP&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Initiation_AfterBirth&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Discontinuation_ByMethod&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Discontinuation_ByAge&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Prob_Switch_From&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Prob_Switch_From_And_To&#39;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">sheet</span> <span class="ow">in</span> <span class="n">sheet_names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">sheet</span><span class="p">]</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="n">sheet</span><span class="p">]</span>

        <span class="c1"># Declare values for other parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_parameters_from_dataframe</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resourcefilepath</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;contraception&#39;</span> <span class="o">/</span> <span class="s1">&#39;ResourceFile_ContraceptionParams.csv&#39;</span>
        <span class="p">))</span>

        <span class="c1"># Import the Age-specific fertility rate data from WPP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;age_specific_fertility_rates&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resourcefilepath</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;demography&#39;</span> <span class="o">/</span> <span class="s1">&#39;ResourceFile_ASFR_WPP.csv&#39;</span><span class="p">)</span>

        <span class="c1"># Import 2010 pop and count numbs of women 15-49 &amp; 30-49</span>
        <span class="n">pop_2010</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;Demography&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;pop_2010&quot;</span><span class="p">]</span>
        <span class="n">n_females_aged_15_to_49_in_2010</span> <span class="o">=</span> <span class="n">pop_2010</span><span class="p">[</span>
            <span class="p">(</span><span class="n">pop_2010</span><span class="o">.</span><span class="n">Sex</span> <span class="o">==</span> <span class="s2">&quot;F&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pop_2010</span><span class="o">.</span><span class="n">Age</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pop_2010</span><span class="o">.</span><span class="n">Age</span> <span class="o">&lt;=</span> <span class="mi">49</span><span class="p">)</span>
        <span class="p">]</span><span class="o">.</span><span class="n">Count</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">n_females_aged_30_to_49_in_2010</span> <span class="o">=</span> <span class="n">pop_2010</span><span class="p">[</span>
            <span class="p">(</span><span class="n">pop_2010</span><span class="o">.</span><span class="n">Sex</span> <span class="o">==</span> <span class="s2">&quot;F&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pop_2010</span><span class="o">.</span><span class="n">Age</span> <span class="o">&gt;=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pop_2010</span><span class="o">.</span><span class="n">Age</span> <span class="o">&lt;=</span> <span class="mi">49</span><span class="p">)</span>
        <span class="p">]</span><span class="o">.</span><span class="n">Count</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ratio_n_females_30_49_to_15_49_in_2010</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">n_females_aged_30_to_49_in_2010</span> <span class="o">/</span> <span class="n">n_females_aged_15_to_49_in_2010</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Contraception.pre_initialise_population">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.Contraception.pre_initialise_population">[docs]</a>
    <span class="k">def</span> <span class="nf">pre_initialise_population</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process parameters before initialising population and simulation&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processed_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_params</span><span class="p">()</span></div>


<div class="viewcode-block" id="Contraception.initialise_population">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.Contraception.initialise_population">[docs]</a>
    <span class="k">def</span> <span class="nf">initialise_population</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set initial values for properties&quot;&quot;&quot;</span>

        <span class="c1"># 1) Set default values for properties</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s1">&#39;co_contraception&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;not_using&#39;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s1">&#39;is_pregnant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s1">&#39;date_of_last_pregnancy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s1">&#39;co_unintended_preg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s1">&#39;co_date_of_last_fp_appt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>

        <span class="c1"># 2) Assign contraception method</span>
        <span class="c1"># Select females aged 15-49 from population, for current year</span>
        <span class="n">females1549</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s1">&#39;F&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">49</span><span class="p">)</span>
        <span class="n">p_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed_params</span><span class="p">[</span><span class="s1">&#39;initial_method_use&#39;</span><span class="p">]</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">females1549</span><span class="p">,</span> <span class="s1">&#39;co_contraception&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">females1549</span><span class="p">,</span> <span class="s1">&#39;age_years&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">_age_years</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">p_method</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p_method</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">_age_years</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="c1"># 3) Give a notional date on which the last appointment occurred for those that need them</span>
        <span class="n">needs_appts</span> <span class="o">=</span> <span class="n">females1549</span> <span class="o">&amp;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;co_contraception&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states_that_may_require_HSI_to_maintain_on</span><span class="p">)</span>
        <span class="n">states_to_maintain_on</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states_that_may_require_HSI_to_maintain_on</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">needs_appts</span><span class="p">,</span> <span class="s1">&#39;co_date_of_last_fp_appt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">needs_appts</span><span class="p">,</span> <span class="s1">&#39;co_contraception&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">_co_contraception</span><span class="p">:</span> <span class="n">random_date</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span>
                    <span class="n">days</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;days_between_appts_for_maintenance&#39;</span><span class="p">]</span>
                    <span class="p">[</span><span class="n">states_to_maintain_on</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">_co_contraception</span><span class="p">)]),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rng</span>
            <span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Contraception.initialise_simulation">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.Contraception.initialise_simulation">[docs]</a>
    <span class="k">def</span> <span class="nf">initialise_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        * Schedule the ContraceptionPoll and ContraceptionLoggingEvent</span>
<span class="sd">        * Retrieve the consumables codes for the consumables used</span>
<span class="sd">        * Create second random number generator</span>
<span class="sd">        * Schedule births to occur during the first 9 months of the simulation</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Schedule the first occurrence of the Logging event to occur at the beginning of the simulation</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">ContraceptionLoggingEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>

        <span class="c1"># Schedule first occurrences of Contraception Poll to occur at the beginning of the simulation</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">ContraceptionPoll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_update_contraceptive</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_update_contraceptive</span><span class="p">),</span> <span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>

        <span class="c1"># Retrieve the consumables codes for the consumables used</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_healthsystem</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cons_codes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_code_for_each_contraceptive</span><span class="p">()</span>

        <span class="c1"># Create second random number generator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">31</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Schedule births to occur during the first 9 months of the simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule_births_for_first_9_months</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;use_interventions&#39;</span><span class="p">]:</span>
            <span class="c1"># Schedule StartInterventions event to update parameters when FP interventions are introduced</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">StartInterventions</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">Date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;interventions_start_date&#39;</span><span class="p">]))</span>

            <span class="c1"># Log initiation date of interventions and implementation costs</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;interventions_start_date&#39;</span><span class="p">,</span>
                        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                            <span class="s1">&#39;date_co_interv_implemented&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;interventions_start_date&#39;</span><span class="p">]</span>
                        <span class="p">},</span>
                        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;The date when parameters are updated to enable the FP interventions.&#39;</span>
                        <span class="p">)</span></div>


<div class="viewcode-block" id="Contraception.on_birth">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.Contraception.on_birth">[docs]</a>
    <span class="k">def</span> <span class="nf">on_birth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mother_id</span><span class="p">,</span> <span class="n">child_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        * 1) Formally end the pregnancy</span>
<span class="sd">        * 2) Initialise properties for the newborn</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="k">if</span> <span class="n">mother_id</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># check if direct birth look for positive mother ids</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_pregnancy</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">mother_id</span><span class="p">)</span>

        <span class="c1"># Initialise child&#39;s properties:</span>
        <span class="n">new_properties</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;co_contraception&#39;</span><span class="p">:</span> <span class="s1">&#39;not_using&#39;</span><span class="p">,</span>
            <span class="s1">&#39;is_pregnant&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;date_of_last_pregnancy&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span><span class="p">,</span>
            <span class="s1">&#39;co_unintended_preg&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;co_date_of_last_fp_appt&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="n">new_properties</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span> <span class="o">=</span> <span class="n">new_properties</span><span class="o">.</span><span class="n">values</span><span class="p">()</span></div>


<div class="viewcode-block" id="Contraception.end_pregnancy">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.Contraception.end_pregnancy">[docs]</a>
    <span class="k">def</span> <span class="nf">end_pregnancy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;End the pregnancy. Reset pregnancy status and may initiate a contraceptive method.</span>
<span class="sd">        This is called by `on_birth` in this module and by Labour/Pregnancy modules for births that do result in live</span>
<span class="sd">        birth.&quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s1">&#39;co_contraception&#39;</span><span class="p">]</span> \
               <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contraceptives_initiated_with_additional_items</span>
        <span class="c1"># TODO: Shouldn&#39;t it be even == &quot;not_using&quot;?</span>
        <span class="c1">#  It is not always the case when used along with Joe&#39;s rmnch modules, why?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s1">&#39;is_pregnant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">person_age</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s1">&#39;age_years&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select_contraceptive_following_birth</span><span class="p">(</span><span class="n">person_id</span><span class="p">,</span> <span class="n">person_age</span><span class="p">)</span></div>


<div class="viewcode-block" id="Contraception.process_params">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.Contraception.process_params">[docs]</a>
    <span class="k">def</span> <span class="nf">process_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process parameters that have been read-in.&quot;&quot;&quot;</span>

        <span class="n">processed_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">expand_to_age_years</span><span class="p">(</span><span class="n">values_by_age_groups</span><span class="p">,</span> <span class="n">ages_by_year</span><span class="p">):</span>
            <span class="n">_d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;15-19&#39;</span><span class="p">,</span> <span class="s1">&#39;20-24&#39;</span><span class="p">,</span> <span class="s1">&#39;25-29&#39;</span><span class="p">,</span> <span class="s1">&#39;30-34&#39;</span><span class="p">,</span> <span class="s1">&#39;35-39&#39;</span><span class="p">,</span> <span class="s1">&#39;40-44&#39;</span><span class="p">,</span> <span class="s1">&#39;45-49&#39;</span><span class="p">],</span> <span class="n">values_by_age_groups</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="n">_d</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;Demography&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">AGE_RANGE_LOOKUP</span><span class="p">[</span><span class="n">_age_year</span><span class="p">]]</span> <span class="k">for</span> <span class="n">_age_year</span> <span class="ow">in</span> <span class="n">ages_by_year</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">initial_method_use</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Generate the distribution of method use by age for the start of the simulation.&quot;&quot;&quot;</span>
            <span class="n">p_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Method_Use_In_2010&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="s1">&#39;age_years&#39;</span><span class="p">)</span>

            <span class="c1"># Normalise so that the sum within each age is 1.0</span>
            <span class="n">p_method</span> <span class="o">=</span> <span class="n">p_method</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">p_method</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">p_method</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

            <span class="c1"># Check correct format</span>
            <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">p_method</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_contraception_states</span><span class="p">)</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">p_method</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">p_method</span>

        <span class="k">def</span> <span class="nf">avoid_sterilization_below30</span><span class="p">(</span><span class="n">probs</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Prevent women below 30 years having female sterilization and adjust the probability for women 30 and over</span>
<span class="sd">            to preserve the overall probability of initiating sterilization.&quot;&quot;&quot;</span>
            <span class="c1"># Input &#39;probs&#39; must include probs for all methods including &#39;not_using&#39;</span>
            <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">probs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_contraception_states</span><span class="p">)</span>

            <span class="c1"># Prevent women below 30 years having &#39;female_sterilization&#39;</span>
            <span class="n">probs_below30</span> <span class="o">=</span> <span class="n">probs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">probs_below30</span><span class="p">[</span><span class="s1">&#39;female_sterilization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="c1"># Scale so that the probability of all outcomes sum to 1.0</span>
            <span class="n">probs_below30</span> <span class="o">=</span> <span class="n">probs_below30</span> <span class="o">/</span> <span class="n">probs_below30</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">probs_below30</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

            <span class="c1"># Increase prob of &#39;female_sterilization&#39; in older women accordingly</span>
            <span class="n">probs_30plus</span> <span class="o">=</span> <span class="n">probs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">probs_30plus</span><span class="p">[</span><span class="s1">&#39;female_sterilization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">probs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;female_sterilization&#39;</span><span class="p">]</span> <span class="o">/</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ratio_n_females_30_49_to_15_49_in_2010</span>
            <span class="p">)</span>
            <span class="c1"># Scale so that the probability of all outcomes sum to 1.0</span>
            <span class="n">probs_30plus</span> <span class="o">=</span> <span class="n">probs_30plus</span> <span class="o">/</span> <span class="n">probs_30plus</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">probs_30plus</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

            <span class="k">return</span> <span class="n">probs_below30</span><span class="p">,</span> <span class="n">probs_30plus</span>

        <span class="k">def</span> <span class="nf">contraception_initiation</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Generate the probability per month of a woman initiating onto each contraceptive, by the age (in whole</span>
<span class="sd">             years).&quot;&quot;&quot;</span>

            <span class="c1"># Probability of initiation by method per month (average over all ages)</span>
            <span class="n">p_init_by_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Initiation_ByMethod&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Prevent women below 30 years having &#39;female_sterilization&#39; while preserving the overall probability of</span>
            <span class="c1"># &#39;female_sterilization&#39; initiation</span>
            <span class="n">p_init_by_method_below30</span><span class="p">,</span> <span class="n">p_init_by_method_30plus</span> <span class="o">=</span> <span class="n">avoid_sterilization_below30</span><span class="p">(</span><span class="n">p_init_by_method</span><span class="p">)</span>

            <span class="c1"># Effect of age</span>
            <span class="n">age_effect</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Initiation_ByAge&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">)[</span><span class="s1">&#39;r_init1_age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span>
                <span class="s2">&quot;age_years&quot;</span><span class="p">)</span>

            <span class="c1"># Year effect</span>
            <span class="n">year_effect</span> <span class="o">=</span> <span class="n">time_age_trend_in_initiation</span><span class="p">()</span>

            <span class="k">def</span> <span class="nf">apply_age_year_effects</span><span class="p">(</span><span class="n">probs_below30</span><span class="p">,</span> <span class="n">probs_30plus</span><span class="p">):</span>
                <span class="c1"># Assemble into age-specific data-frame:</span>
                <span class="n">probs_by_method_below30</span> <span class="o">=</span> <span class="n">probs_below30</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;not_using&#39;</span><span class="p">)</span>
                <span class="n">probs_by_method_30plus</span> <span class="o">=</span> <span class="n">probs_30plus</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;not_using&#39;</span><span class="p">)</span>
                <span class="n">p_init</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">year_effect</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>

                    <span class="n">p_init_this_year</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">age_effect</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span>
                            <span class="n">p_init_this_year</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">probs_by_method_below30</span> <span class="o">*</span> <span class="n">age_effect</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">*</span> <span class="n">year_effect</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">year</span><span class="p">,</span> <span class="n">a</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">p_init_this_year</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">probs_by_method_30plus</span> <span class="o">*</span> <span class="n">age_effect</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">*</span> <span class="n">year_effect</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">year</span><span class="p">,</span> <span class="n">a</span><span class="p">]</span>
                    <span class="n">p_init_this_year_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">p_init_this_year</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>

                    <span class="c1"># Check correct format of age/method data-frame</span>
                    <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">p_init_this_year_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_contraception_states</span> <span class="o">-</span> <span class="p">{</span><span class="s1">&#39;not_using&#39;</span><span class="p">})</span>
                    <span class="k">assert</span> <span class="p">(</span><span class="n">p_init_this_year_df</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                    <span class="k">assert</span> <span class="p">(</span><span class="n">p_init_this_year_df</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

                    <span class="n">p_init</span><span class="p">[</span><span class="n">year</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_init_this_year_df</span>

                <span class="k">return</span> <span class="n">p_init</span>

            <span class="k">return</span> <span class="n">apply_age_year_effects</span><span class="p">(</span><span class="n">p_init_by_method_below30</span><span class="p">,</span> <span class="n">p_init_by_method_30plus</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">contraception_switch</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Get the probability per month of a woman switching to contraceptive method, given that she is currently</span>
<span class="sd">            using a different one.&quot;&quot;&quot;</span>

            <span class="c1"># Get the probability per month of the woman making a switch (to anything)</span>
            <span class="n">p_switch_from</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Prob_Switch_From&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Get the probability that the woman switches to a new contraceptive (given that she will switch to</span>
            <span class="c1"># something different).</span>
            <span class="c1"># Columns = &quot;current method&quot;; Row = &quot;new method&quot;</span>
            <span class="n">switching_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Prob_Switch_From_And_To&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;switchfrom&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

            <span class="c1"># Prevent women below 30 years having &#39;female_sterilization&#39;</span>
            <span class="n">switching_matrix_below30</span> <span class="o">=</span> <span class="n">switching_matrix</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">switching_matrix_below30</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;female_sterilization&#39;</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">switching_matrix_below30</span> <span class="o">=</span> <span class="n">switching_matrix_below30</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">col</span><span class="p">:</span> <span class="n">col</span> <span class="o">/</span> <span class="n">col</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

            <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">switching_matrix_below30</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">all_contraception_states</span> <span class="o">-</span> <span class="p">{</span><span class="s2">&quot;not_using&quot;</span><span class="p">,</span> <span class="s2">&quot;female_sterilization&quot;</span><span class="p">})</span>
            <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">switching_matrix_below30</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_contraception_states</span> <span class="o">-</span> <span class="p">{</span><span class="s2">&quot;not_using&quot;</span><span class="p">})</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">switching_matrix_below30</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

            <span class="c1"># Increase prob of &#39;female_sterilization&#39; in older women accordingly</span>
            <span class="n">new_fs_probs_30plus</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">switching_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;female_sterilization&#39;</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ratio_n_females_30_49_to_15_49_in_2010</span>
            <span class="p">)</span>
            <span class="n">switching_matrix_except_fs</span> <span class="o">=</span> <span class="n">switching_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">switching_matrix</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="s1">&#39;female_sterilization&#39;</span><span class="p">]</span>
            <span class="n">switching_matrix_30plus</span> <span class="o">=</span> <span class="n">switching_matrix_except_fs</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">col</span><span class="p">:</span> <span class="n">col</span> <span class="o">/</span> <span class="n">col</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
            <span class="n">switching_matrix_30plus</span> <span class="o">=</span> <span class="n">switching_matrix_30plus</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">new_fs_probs_30plus</span><span class="p">)</span>
            <span class="n">switching_matrix_30plus</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">new_fs_probs_30plus</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_fs_probs_30plus</span>

            <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">switching_matrix_30plus</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">all_contraception_states</span> <span class="o">-</span> <span class="p">{</span><span class="s2">&quot;not_using&quot;</span><span class="p">,</span> <span class="s2">&quot;female_sterilization&quot;</span><span class="p">})</span>
            <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">switching_matrix_30plus</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_contraception_states</span> <span class="o">-</span> <span class="p">{</span><span class="s2">&quot;not_using&quot;</span><span class="p">})</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">switching_matrix_30plus</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">p_switch_from</span><span class="p">,</span> <span class="n">switching_matrix_below30</span><span class="p">,</span> <span class="n">switching_matrix_30plus</span>

        <span class="k">def</span> <span class="nf">contraception_stop</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Get the probability per month of a woman stopping use of contraceptive method.&quot;&quot;&quot;</span>

            <span class="c1"># Get data from read-in Excel sheets</span>
            <span class="n">p_stop_by_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Discontinuation_ByMethod&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">age_effect</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Discontinuation_ByAge&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">)[</span><span class="s1">&#39;r_discont_age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span>
                <span class="s2">&quot;age_years&quot;</span><span class="p">)</span>
            <span class="n">year_effect</span> <span class="o">=</span> <span class="n">time_age_trend_in_stopping</span><span class="p">()</span>

            <span class="c1"># Probability of initiation by age for each method</span>
            <span class="n">p_stop</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">year_effect</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="n">p_stop_this_year</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">age_effect</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="n">p_stop_this_year</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_stop_by_method</span> <span class="o">*</span> <span class="n">age_effect</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">*</span> <span class="n">year_effect</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">year</span><span class="p">,</span> <span class="n">a</span><span class="p">]</span>
                <span class="n">p_stop_this_year_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">p_stop_this_year</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>

                <span class="c1"># Check correct format of age/method data-frame</span>
                <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">p_stop_this_year_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_contraception_states</span> <span class="o">-</span> <span class="p">{</span><span class="s1">&#39;not_using&#39;</span><span class="p">})</span>
                <span class="k">assert</span> <span class="p">(</span><span class="n">p_stop_this_year_df</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                <span class="k">assert</span> <span class="p">(</span><span class="n">p_stop_this_year_df</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

                <span class="n">p_stop</span><span class="p">[</span><span class="n">year</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_stop_this_year_df</span>

            <span class="k">return</span> <span class="n">p_stop</span>

        <span class="k">def</span> <span class="nf">time_age_trend_in_initiation</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;The age-specific effect of calendar year on the probability of starting use of contraceptive</span>
<span class="sd">            (multiplicative effect). Values are chosen to induce a trend in age-specific fertility consistent with</span>
<span class="sd">             the WPP estimates.&quot;&quot;&quot;</span>

            <span class="n">_years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2010</span><span class="p">,</span> <span class="mi">2101</span><span class="p">)</span>
            <span class="n">_ages</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

            <span class="n">_init_over_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">+</span><span class="mf">0.05</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="mi">2020</span> <span class="o">-</span> <span class="mi">2010</span><span class="p">,</span> <span class="p">(</span><span class="n">_years</span> <span class="o">-</span> <span class="mi">2010</span><span class="p">)))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                <span class="o">+</span><span class="mf">0.01</span> <span class="o">*</span> <span class="p">(</span><span class="n">_years</span> <span class="o">-</span> <span class="mi">2020</span><span class="p">)))</span>
            <span class="n">_init_over_time_modification_by_age</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">expand_to_age_years</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="n">_ages</span><span class="p">)</span>
            <span class="n">_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">_init_over_time</span><span class="p">,</span> <span class="n">_init_over_time_modification_by_age</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">_years</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">_ages</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">_init</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">time_age_trend_in_stopping</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;The age-specific effect of calendar year on the probability of discontinuing use of contraceptive</span>
<span class="sd">            (multiplicative effect). Values are chosen to induce a trend in age-specific fertility consistent with</span>
<span class="sd">            the WPP estimates.&quot;&quot;&quot;</span>

            <span class="n">_years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2010</span><span class="p">,</span> <span class="mi">2101</span><span class="p">)</span>
            <span class="n">_ages</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

            <span class="n">_discont_over_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.05</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="mi">2020</span> <span class="o">-</span> <span class="mi">2010</span><span class="p">,</span> <span class="p">(</span><span class="n">_years</span> <span class="o">-</span> <span class="mi">2010</span><span class="p">)))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                <span class="o">-</span><span class="mf">0.01</span> <span class="o">*</span> <span class="p">(</span><span class="n">_years</span> <span class="o">-</span> <span class="mi">2020</span><span class="p">)))</span>
            <span class="n">_discont_over_time_modification_by_age</span> <span class="o">=</span> <span class="n">expand_to_age_years</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="n">_ages</span><span class="p">)</span>
            <span class="n">_discont</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">_discont_over_time</span><span class="p">,</span> <span class="n">_discont_over_time_modification_by_age</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">_years</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">_ages</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">_discont</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">contraception_initiation_after_birth</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Get the probability of a woman starting a contraceptive following giving birth. Avoid sterilization in</span>
<span class="sd">            women below 30 years old.&quot;&quot;&quot;</span>

            <span class="c1"># Get data from read-in Excel sheets</span>
            <span class="n">p_start_after_birth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Initiation_AfterBirth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">avoid_sterilization_below30</span><span class="p">(</span><span class="n">p_start_after_birth</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">scaling_factor_on_monthly_risk_of_pregnancy</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;A scaling factor on the monthly risk of pregnancy, chosen to give the correct number of live-births</span>
<span class="sd">            initially, given the initial pattern of contraceptive use.&quot;&quot;&quot;</span>

            <span class="c1"># first scaling factor is that worked out from the calibration script</span>
            <span class="n">scaling_factor_as_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
                <span class="p">[</span><span class="s1">&#39;15-19&#39;</span><span class="p">,</span> <span class="s1">&#39;20-24&#39;</span><span class="p">,</span> <span class="s1">&#39;25-29&#39;</span><span class="p">,</span> <span class="s1">&#39;30-34&#39;</span><span class="p">,</span> <span class="s1">&#39;35-39&#39;</span><span class="p">,</span> <span class="s1">&#39;40-44&#39;</span><span class="p">,</span> <span class="s1">&#39;45-49&#39;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;scaling_factor_on_monthly_risk_of_pregnancy&#39;</span><span class="p">]</span>
            <span class="p">))</span>

            <span class="n">AGE_RANGE_LOOKUP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;Demography&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">AGE_RANGE_LOOKUP</span>
            <span class="n">_ages</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                <span class="n">index</span><span class="o">=</span><span class="n">_ages</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">scaling_factor_as_dict</span><span class="p">[</span><span class="n">AGE_RANGE_LOOKUP</span><span class="p">[</span><span class="n">_age_year</span><span class="p">]]</span> <span class="k">for</span> <span class="n">_age_year</span> <span class="ow">in</span> <span class="n">_ages</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">pregnancy_no_contraception</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Get the probability per month of a woman becoming pregnant if she is not using any contraceptive method.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="c1"># Get the probability of being pregnant if not HIV-positive</span>
            <span class="n">p_pregnancy_no_contraception_per_month_nohiv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Pregnancy_NotUsing_In_2010&#39;</span><span class="p">]</span> \
                <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">)[</span><span class="s1">&#39;AnnualProb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="s1">&#39;age_years&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">convert_annual_prob_to_monthly_prob</span><span class="p">)</span>

            <span class="c1"># Compute the probability of being pregnant if HIV-positive</span>
            <span class="n">p_pregnancy_no_contraception_per_month_hiv</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">p_pregnancy_no_contraception_per_month_nohiv</span> <span class="o">*</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Pregnancy_NotUsing_HIVeffect&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;age_&#39;</span><span class="p">)[</span><span class="s1">&#39;RR_pregnancy&#39;</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># Create combined dataframe</span>
            <span class="n">p_pregnancy_no_contraception_per_month</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">({</span>
                <span class="s1">&#39;hv_inf_False&#39;</span><span class="p">:</span> <span class="n">p_pregnancy_no_contraception_per_month_nohiv</span><span class="p">,</span>
                <span class="s1">&#39;hv_inf_True&#39;</span><span class="p">:</span> <span class="n">p_pregnancy_no_contraception_per_month_hiv</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">assert</span> <span class="p">(</span><span class="n">p_pregnancy_no_contraception_per_month</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">p_pregnancy_no_contraception_per_month</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="s1">&#39;hv_inf_True&#39;</span><span class="p">,</span> <span class="s1">&#39;hv_inf_False&#39;</span><span class="p">}</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Pregnancy_NotUsing_In_2010&#39;</span><span class="p">][</span><span class="s1">&#39;AnnualProb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                <span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">p_pregnancy_no_contraception_per_month</span><span class="p">[</span><span class="s1">&#39;hv_inf_False&#39;</span><span class="p">],</span> <span class="mi">12</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">p_pregnancy_no_contraception_per_month</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">scaling_factor_on_monthly_risk_of_pregnancy</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">pregnancy_with_contraception</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Get the probability per month of a woman becoming pregnant if she is using a contraceptive method.&quot;&quot;&quot;</span>
            <span class="n">p_pregnancy_by_method_per_month</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Failure_ByMethod&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Create rates that are age-specific (using self.parameters[&#39;rr_fail_under25&#39;])</span>
            <span class="n">p_pregnancy_with_contraception_per_month</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
                <span class="n">columns</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_contraception_states</span> <span class="o">-</span> <span class="p">{</span><span class="s2">&quot;not_using&quot;</span><span class="p">})</span>
            <span class="p">)</span>
            <span class="n">p_pregnancy_with_contraception_per_month</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">p_pregnancy_by_method_per_month</span>
            <span class="n">p_pregnancy_with_contraception_per_month</span><span class="o">.</span><span class="n">ffill</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">p_pregnancy_with_contraception_per_month</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">p_pregnancy_with_contraception_per_month</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">25</span>
                <span class="p">]</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;rr_fail_under25&#39;</span><span class="p">]</span>

            <span class="k">assert</span> <span class="p">(</span><span class="n">p_pregnancy_with_contraception_per_month</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">p_pregnancy_with_contraception_per_month</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">all_contraception_states</span> <span class="o">-</span> <span class="p">{</span><span class="s2">&quot;not_using&quot;</span><span class="p">})</span>
            <span class="k">assert</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">==</span> <span class="n">p_pregnancy_with_contraception_per_month</span><span class="p">[</span><span class="s1">&#39;female_sterilization&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">p_pregnancy_with_contraception_per_month</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">scaling_factor_on_monthly_risk_of_pregnancy</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">processed_params</span><span class="p">[</span><span class="s1">&#39;initial_method_use&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_method_use</span><span class="p">()</span>
        <span class="n">processed_params</span><span class="p">[</span><span class="s1">&#39;p_start_per_month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">contraception_initiation</span><span class="p">()</span>
        <span class="n">processed_params</span><span class="p">[</span><span class="s1">&#39;p_switch_from_per_month&#39;</span><span class="p">],</span> \
            <span class="n">processed_params</span><span class="p">[</span><span class="s1">&#39;p_switching_to_below30&#39;</span><span class="p">],</span> <span class="n">processed_params</span><span class="p">[</span><span class="s1">&#39;p_switching_to_30plus&#39;</span><span class="p">]</span> <span class="o">=</span>\
            <span class="n">contraception_switch</span><span class="p">()</span>
        <span class="n">processed_params</span><span class="p">[</span><span class="s1">&#39;p_stop_per_month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">contraception_stop</span><span class="p">()</span>
        <span class="n">processed_params</span><span class="p">[</span><span class="s1">&#39;p_start_after_birth_below30&#39;</span><span class="p">],</span> <span class="n">processed_params</span><span class="p">[</span><span class="s1">&#39;p_start_after_birth_30plus&#39;</span><span class="p">]</span> <span class="o">=</span>\
            <span class="n">contraception_initiation_after_birth</span><span class="p">()</span>

        <span class="n">processed_params</span><span class="p">[</span><span class="s1">&#39;p_pregnancy_no_contraception_per_month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pregnancy_no_contraception</span><span class="p">()</span>
        <span class="n">processed_params</span><span class="p">[</span><span class="s1">&#39;p_pregnancy_with_contraception_per_month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pregnancy_with_contraception</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">processed_params</span></div>


<div class="viewcode-block" id="Contraception.update_params_for_interventions">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.Contraception.update_params_for_interventions">[docs]</a>
    <span class="k">def</span> <span class="nf">update_params_for_interventions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates process parameters to enable FP interventions.&quot;&quot;&quot;</span>

        <span class="n">processed_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed_params</span>

        <span class="k">def</span> <span class="nf">contraception_initiation_with_interv</span><span class="p">(</span><span class="n">p_start_per_month_without_interv</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Increase the probabilities of a woman starting modern contraceptives due to Pop intervention being</span>
<span class="sd">            applied.&quot;&quot;&quot;</span>
            <span class="n">p_start_per_month_with_interv</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">year</span><span class="p">,</span> <span class="n">age_method_df</span> <span class="ow">in</span> <span class="n">p_start_per_month_without_interv</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">year</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">:</span>
                    <span class="n">p_start_per_month_with_interv</span><span class="p">[</span><span class="n">year</span><span class="p">]</span> <span class="o">=</span> <span class="n">age_method_df</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Interventions_Pop&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">p_start_per_month_with_interv</span>

        <span class="k">def</span> <span class="nf">contraception_initiation_after_birth_with_interv</span><span class="p">(</span><span class="n">p_start_after_birth_without_interv</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Increase the probabilities of a woman starting modern contraceptives following giving birth due to PPFP</span>
<span class="sd">            intervention being applied.&quot;&quot;&quot;</span>
            <span class="c1"># Exclude prob of &#39;not_using&#39;</span>
            <span class="n">p_start_after_birth_with_interv</span> <span class="o">=</span> <span class="n">p_start_after_birth_without_interv</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;not_using&#39;</span><span class="p">)</span>

            <span class="c1"># Apply PPFP intervention multipliers (ie increase probs of modern methods)</span>
            <span class="n">p_start_after_birth_with_interv</span> <span class="o">=</span> \
                <span class="n">p_start_after_birth_with_interv</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Interventions_PPFP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># Return reduced prob of &#39;not_using&#39;</span>
            <span class="n">p_start_after_birth_with_interv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">p_start_after_birth_with_interv</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span>
                                                        <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;not_using&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_start_after_birth_with_interv</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">p_start_after_birth_with_interv</span>

        <span class="n">processed_params</span><span class="p">[</span><span class="s1">&#39;p_start_per_month&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">contraception_initiation_with_interv</span><span class="p">(</span><span class="n">processed_params</span><span class="p">[</span><span class="s1">&#39;p_start_per_month&#39;</span><span class="p">])</span>
        <span class="n">processed_params</span><span class="p">[</span><span class="s1">&#39;p_start_after_birth_below30&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">contraception_initiation_after_birth_with_interv</span><span class="p">(</span><span class="n">processed_params</span><span class="p">[</span><span class="s1">&#39;p_start_after_birth_below30&#39;</span><span class="p">])</span>
        <span class="n">processed_params</span><span class="p">[</span><span class="s1">&#39;p_start_after_birth_30plus&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">contraception_initiation_after_birth_with_interv</span><span class="p">(</span><span class="n">processed_params</span><span class="p">[</span><span class="s1">&#39;p_start_after_birth_30plus&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">processed_params</span></div>


<div class="viewcode-block" id="Contraception.select_contraceptive_following_birth">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.Contraception.select_contraceptive_following_birth">[docs]</a>
    <span class="k">def</span> <span class="nf">select_contraceptive_following_birth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mother_id</span><span class="p">,</span> <span class="n">mother_age</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initiation of mother&#39;s contraception after birth.&quot;&quot;&quot;</span>

        <span class="c1"># Allocate the woman to a contraceptive status</span>
        <span class="k">if</span> <span class="n">mother_age</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span>
            <span class="n">probs_below30</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed_params</span><span class="p">[</span><span class="s1">&#39;p_start_after_birth_below30&#39;</span><span class="p">]</span>
            <span class="n">new_contraceptive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">probs_below30</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">probs_below30</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">probs_30plus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed_params</span><span class="p">[</span><span class="s1">&#39;p_start_after_birth_30plus&#39;</span><span class="p">]</span>
            <span class="n">new_contraceptive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">probs_30plus</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">probs_30plus</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="c1"># Do the change in contraceptive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule_batch_of_contraceptive_changes</span><span class="p">(</span><span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="n">mother_id</span><span class="p">],</span> <span class="n">old</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;not_using&#39;</span><span class="p">],</span> <span class="n">new</span><span class="o">=</span><span class="p">[</span><span class="n">new_contraceptive</span><span class="p">])</span></div>


<div class="viewcode-block" id="Contraception.get_item_code_for_each_contraceptive">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.Contraception.get_item_code_for_each_contraceptive">[docs]</a>
    <span class="k">def</span> <span class="nf">get_item_code_for_each_contraceptive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the item_code for each contraceptive and for contraceptive initiation.&quot;&quot;&quot;</span>
        <span class="c1"># TODO: update with optional items (currently all considered essential)</span>

        <span class="n">get_items_from_pkg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_item_codes_from_package_name</span>

        <span class="n">_cons_codes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="c1"># items for each method that requires an HSI to switch to</span>
        <span class="n">_cons_codes</span><span class="p">[</span><span class="s1">&#39;pill&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_items_from_pkg</span><span class="p">(</span><span class="s1">&#39;Pill&#39;</span><span class="p">)</span>
        <span class="n">_cons_codes</span><span class="p">[</span><span class="s1">&#39;male_condom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_items_from_pkg</span><span class="p">(</span><span class="s1">&#39;Male condom&#39;</span><span class="p">)</span>
        <span class="n">_cons_codes</span><span class="p">[</span><span class="s1">&#39;other_modern&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_items_from_pkg</span><span class="p">(</span><span class="s1">&#39;Female Condom&#39;</span><span class="p">)</span>
        <span class="c1"># NB. The consumable female condom is used for the contraceptive state of &quot;other_modern method&quot;</span>
        <span class="n">_cons_codes</span><span class="p">[</span><span class="s1">&#39;IUD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_items_from_pkg</span><span class="p">(</span><span class="s1">&#39;IUD&#39;</span><span class="p">)</span>
        <span class="n">_cons_codes</span><span class="p">[</span><span class="s1">&#39;injections&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_items_from_pkg</span><span class="p">(</span><span class="s1">&#39;Injectable&#39;</span><span class="p">)</span>
        <span class="n">_cons_codes</span><span class="p">[</span><span class="s1">&#39;implant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_items_from_pkg</span><span class="p">(</span><span class="s1">&#39;Implant&#39;</span><span class="p">)</span>
        <span class="n">_cons_codes</span><span class="p">[</span><span class="s1">&#39;female_sterilization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_items_from_pkg</span><span class="p">(</span><span class="s1">&#39;Female sterilization&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">_cons_codes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states_that_may_require_HSI_to_switch_to</span><span class="p">)</span>
        <span class="c1"># items used when initiating a modern reliable method after not using or switching from non-reliable method</span>
        <span class="n">_cons_codes</span><span class="p">[</span><span class="s1">&#39;co_initiation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_items_from_pkg</span><span class="p">(</span><span class="s1">&#39;Contraception initiation&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_cons_codes</span></div>


<div class="viewcode-block" id="Contraception.schedule_batch_of_contraceptive_changes">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.Contraception.schedule_batch_of_contraceptive_changes">[docs]</a>
    <span class="k">def</span> <span class="nf">schedule_batch_of_contraceptive_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enact the change in contraception, either through editing properties instantaneously or by scheduling HSI.</span>
<span class="sd">        ids: pd.Index of the woman for whom the contraceptive state is changing</span>
<span class="sd">        old: iterable giving the corresponding contraceptive state being switched from</span>
<span class="sd">        new: iterable giving the corresponding contraceptive state being switched to</span>

<span class="sd">        It is assumed that even with the option `self.use_healthsystem=True` that switches to certain methods do not</span>
<span class="sd">        require the use of HSI (these are not in `states_that_may_require_HSI_to_switch_to`).&quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">date_today</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>
        <span class="n">days_between_appts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;days_between_appts_for_maintenance&#39;</span><span class="p">]</span>

        <span class="n">date_of_last_appt</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ids</span><span class="p">,</span> <span class="s2">&quot;co_date_of_last_fp_appt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">states_to_maintain_on</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states_that_may_require_HSI_to_maintain_on</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">_woman_id</span><span class="p">,</span> <span class="n">_old</span><span class="p">,</span> <span class="n">_new</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_new</span> <span class="o">==</span> <span class="s1">&#39;female_sterilization&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">_woman_id</span><span class="p">,</span> <span class="s1">&#39;age_years&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_women_ids_sterilized_below30</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">_woman_id</span><span class="p">)</span>

            <span class="c1"># Does this change require an HSI?</span>
            <span class="n">is_a_switch</span> <span class="o">=</span> <span class="n">_old</span> <span class="o">!=</span> <span class="n">_new</span>
            <span class="n">reqs_appt</span> <span class="o">=</span> <span class="n">_new</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states_that_may_require_HSI_to_switch_to</span> <span class="k">if</span> <span class="n">is_a_switch</span> \
                <span class="k">else</span> <span class="n">_new</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states_that_may_require_HSI_to_maintain_on</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">is_a_switch</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">reqs_appt</span><span class="p">:</span>
                <span class="n">due_appt</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">date_of_last_appt</span><span class="p">[</span><span class="n">_woman_id</span><span class="p">])</span> <span class="ow">or</span>
                            <span class="p">(</span><span class="n">date_today</span> <span class="o">-</span> <span class="n">date_of_last_appt</span><span class="p">[</span><span class="n">_woman_id</span><span class="p">])</span><span class="o">.</span><span class="n">days</span> <span class="o">&gt;=</span>
                            <span class="n">days_between_appts</span><span class="p">[</span><span class="n">states_to_maintain_on</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">_old</span><span class="p">)]</span>
                            <span class="p">)</span>
            <span class="n">do_appt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_healthsystem</span> <span class="ow">and</span> <span class="n">reqs_appt</span> <span class="ow">and</span> <span class="p">(</span><span class="n">is_a_switch</span> <span class="ow">or</span> <span class="n">due_appt</span><span class="p">)</span>

            <span class="c1"># If the new method requires an HSI to be implemented, schedule the HSI:</span>
            <span class="k">if</span> <span class="n">do_appt</span><span class="p">:</span>
                <span class="c1"># If this is a change, or its maintenance and time for an appointment, schedule an appointment</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                    <span class="n">hsi_event</span><span class="o">=</span><span class="n">HSI_Contraception_FamilyPlanningAppt</span><span class="p">(</span>
                        <span class="n">person_id</span><span class="o">=</span><span class="n">_woman_id</span><span class="p">,</span>
                        <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">new_contraceptive</span><span class="o">=</span><span class="n">_new</span>
                    <span class="p">),</span>
                    <span class="c1"># select start_date for 0 max day delay; start_date or later for &gt;=1 max day delay:</span>
                    <span class="n">topen</span><span class="o">=</span><span class="n">random_date</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span>
                            <span class="n">days</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span>
                                     <span class="s1">&#39;max_days_delay_between_decision_to_change_method_and_hsi_scheduled&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">rng2</span><span class="p">),</span>
                    <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">priority</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Otherwise, implement the change immediately:</span>
                <span class="k">if</span> <span class="n">_old</span> <span class="o">!=</span> <span class="n">_new</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">do_and_log_individual_contraception_change</span><span class="p">(</span><span class="n">woman_id</span><span class="o">=</span><span class="n">_woman_id</span><span class="p">,</span> <span class="n">old</span><span class="o">=</span><span class="n">_old</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">_new</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>  <span class="c1"># No need to do anything if the old is the same as the new and no HSI needed.</span></div>


<div class="viewcode-block" id="Contraception.do_and_log_individual_contraception_change">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.Contraception.do_and_log_individual_contraception_change">[docs]</a>
    <span class="k">def</span> <span class="nf">do_and_log_individual_contraception_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">woman_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Implement and then log a start / stop / switch of contraception. &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">old</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_contraception_states</span>
        <span class="k">assert</span> <span class="n">new</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_contraception_states</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="c1"># Do the change</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">woman_id</span><span class="p">,</span> <span class="s2">&quot;co_contraception&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>

        <span class="c1"># Log the change</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;contraception_change&#39;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                        <span class="s1">&#39;woman_id&#39;</span><span class="p">:</span> <span class="n">woman_id</span><span class="p">,</span>
                        <span class="s1">&#39;age_years&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">woman_id</span><span class="p">,</span> <span class="s1">&#39;age_years&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;switch_from&#39;</span><span class="p">:</span> <span class="n">old</span><span class="p">,</span>
                        <span class="s1">&#39;switch_to&#39;</span><span class="p">:</span> <span class="n">new</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;All changes in contraception use&#39;</span>
                    <span class="p">)</span></div>


<div class="viewcode-block" id="Contraception.schedule_births_for_first_9_months">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.Contraception.schedule_births_for_first_9_months">[docs]</a>
    <span class="k">def</span> <span class="nf">schedule_births_for_first_9_months</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Schedule births to occur during the first 9 months of the simulation. This is necessary because at initiation</span>
<span class="sd">        no women are pregnant, so the first births generated endogenously (through pregnancy -&gt; gestation -&gt; labour)</span>
<span class="sd">        occur after 9 months of simulation time. This method examines age-specific fertility rate data and causes there</span>
<span class="sd">        to be the appropriate number of births, scattered uniformly over the first 9 months of the simulation. These are</span>
<span class="sd">        &quot;direct live births&quot; that are not subjected to any of the processes (e.g. risk of loss of pregnancy, or risk of</span>
<span class="sd">        death to mother) represented in the `PregnancySupervisor`, `CareOfWomenDuringPregnancy` or `Labour`.</span>
<span class="sd">        When initialising population ensured person_id=0 is a man, so can safely exclude person_id=0 from choice of</span>
<span class="sd">        direct birth mothers without loss of generality.&quot;&quot;&quot;</span>

        <span class="n">risk_of_birth</span> <span class="o">=</span> <span class="n">get_medium_variant_asfr_from_wpp_resourcefile</span><span class="p">(</span>
            <span class="n">dat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;age_specific_fertility_rates&#39;</span><span class="p">],</span> <span class="n">months_exposure</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="c1"># don&#39;t use person_id=0 for direct birth mother</span>
        <span class="n">prob_birth</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s1">&#39;F&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">is_pregnant</span><span class="p">][</span><span class="s1">&#39;age_range&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="n">risk_of_birth</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">])</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># determine which women will get pregnant</span>
        <span class="n">give_birth_women_ids</span> <span class="o">=</span> <span class="n">prob_birth</span><span class="o">.</span><span class="n">index</span><span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">prob_birth</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">prob_birth</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># schedule births, passing negative of mother&#39;s id:</span>
        <span class="k">for</span> <span class="n">_id</span> <span class="ow">in</span> <span class="n">give_birth_women_ids</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">DirectBirth</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">_id</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="p">),</span>
                                    <span class="n">random_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">9</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">)</span>
                                    <span class="p">)</span></div>


<div class="viewcode-block" id="Contraception.on_simulation_end">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.Contraception.on_simulation_end">[docs]</a>
    <span class="k">def</span> <span class="nf">on_simulation_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Do tasks at the end of the simulation: Raise warning and enter to log about women_ids who are sterilized</span>
<span class="sd">        when under 30 years old.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_women_ids_sterilized_below30</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="ne">UserWarning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;IDs of women for whom sterilization was initiated when they were under 30:/n&quot;</span>
                                      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_women_ids_sterilized_below30</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="n">key</span><span class="o">=</span><span class="s2">&quot;women_ids_sterilized_below30&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ids&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_women_ids_sterilized_below30</span><span class="p">}</span>
            <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="DirectBirth">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.DirectBirth">[docs]</a>
<span class="k">class</span> <span class="nc">DirectBirth</span><span class="p">(</span><span class="n">Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Do birth, with the mother_id set to person_id*(-1) to reflect that this was a `DirectBirth`.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="DirectBirth.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.DirectBirth.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="DirectBirth.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.DirectBirth.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">person_id</span> <span class="o">&lt;</span> <span class="mi">0</span>  <span class="c1"># check that mother is correctly logged as direct birth mother</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">do_birth</span><span class="p">(</span><span class="n">person_id</span><span class="p">)</span>  <span class="c1"># use actual id for mother</span></div>
</div>



<div class="viewcode-block" id="ContraceptionPoll">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.ContraceptionPoll">[docs]</a>
<span class="k">class</span> <span class="nc">ContraceptionPoll</span><span class="p">(</span><span class="n">RegularEvent</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The regular poll (monthly) for the Contraceptive Module:</span>
<span class="sd">    * Determines contraceptive start / stops / switches</span>
<span class="sd">    * Determines the onset of pregnancy</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ContraceptionPoll.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.ContraceptionPoll.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">run_do_pregnancy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">run_update_contraceptive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">age_low</span> <span class="o">=</span> <span class="mi">15</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">age_high</span> <span class="o">=</span> <span class="mi">49</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">run_do_pregnancy</span> <span class="o">=</span> <span class="n">run_do_pregnancy</span>  <span class="c1"># (Provided for testing only)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_update_contraceptive</span> <span class="o">=</span> <span class="n">run_update_contraceptive</span>  <span class="c1"># (Provided for testing only)</span></div>


<div class="viewcode-block" id="ContraceptionPoll.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.ContraceptionPoll.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine who will become pregnant and update contraceptive method.&quot;&quot;&quot;</span>

        <span class="c1"># Determine who will become pregnant, given current contraceptive method</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_do_pregnancy</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_pregnancy</span><span class="p">()</span>

        <span class="c1"># Update contraception method</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_update_contraceptive</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_contraceptive</span><span class="p">()</span></div>


<div class="viewcode-block" id="ContraceptionPoll.update_contraceptive">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.ContraceptionPoll.update_contraceptive">[docs]</a>
    <span class="k">def</span> <span class="nf">update_contraceptive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Determine women that will start, stop or switch contraceptive method.&quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="n">possible_co_users</span> <span class="o">=</span> <span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s1">&#39;F&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
                             <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span>
                             <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">age_low</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">age_high</span><span class="p">)</span> <span class="o">&amp;</span>
                             <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">is_pregnant</span><span class="p">)</span>

        <span class="n">currently_using_co</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">possible_co_users</span> <span class="o">&amp;</span>
                                      <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">co_contraception</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;not_using&#39;</span><span class="p">,</span> <span class="s1">&#39;female_sterilization&#39;</span><span class="p">])]</span>
        <span class="n">currently_not_using_co</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">possible_co_users</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">co_contraception</span> <span class="o">==</span> <span class="s1">&#39;not_using&#39;</span><span class="p">)]</span>

        <span class="c1"># initiating: not using -&gt; using</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initiate</span><span class="p">(</span><span class="n">currently_not_using_co</span><span class="p">)</span>

        <span class="c1"># continue/discontinue/switch: using --&gt; using/not using</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discontinue_switch_or_continue</span><span class="p">(</span><span class="n">currently_using_co</span><span class="p">)</span>

        <span class="c1"># put everyone older than `age_high` onto not_using:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s1">&#39;F&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">age_high</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">co_contraception</span> <span class="o">!=</span> <span class="s1">&#39;not_using&#39;</span><span class="p">),</span>
            <span class="s1">&#39;co_contraception&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;not_using&#39;</span></div>


<div class="viewcode-block" id="ContraceptionPoll.initiate">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.ContraceptionPoll.initiate">[docs]</a>
    <span class="k">def</span> <span class="nf">initiate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">individuals_not_using</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check all females not using contraception to determine if contraception starts</span>
<span class="sd">        (i.e. category change from &#39;not_using&#39; to something else).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Exit if there are no individuals currently not using a contraceptive:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">individuals_not_using</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">processed_params</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span>

        <span class="c1"># Get probability of each individual starting on each contraceptive</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">individuals_not_using</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;age_years&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">pp</span><span class="p">[</span><span class="s1">&#39;p_start_per_month&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">],</span>
            <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
            <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;age_years&#39;</span><span class="p">,</span>
            <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;age_years&#39;</span><span class="p">])</span>

        <span class="c1"># Determine if individual will start contraceptive</span>
        <span class="n">will_initiate</span> <span class="o">=</span> <span class="n">sample_outcome</span><span class="p">(</span><span class="n">probs</span><span class="o">=</span><span class="n">probs</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>

        <span class="c1"># Do the contraceptive change</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">will_initiate</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">schedule_batch_of_contraceptive_changes</span><span class="p">(</span>
                <span class="n">ids</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">will_initiate</span><span class="p">),</span>
                <span class="n">old</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;not_using&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">will_initiate</span><span class="p">),</span>
                <span class="n">new</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">will_initiate</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="ContraceptionPoll.discontinue_switch_or_continue">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.ContraceptionPoll.discontinue_switch_or_continue">[docs]</a>
    <span class="k">def</span> <span class="nf">discontinue_switch_or_continue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">individuals_using</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check all females currently using contraception to determine if they discontinue it, switch to a different</span>
<span class="sd">        one, or keep using the same one.&quot;&quot;&quot;</span>

        <span class="c1"># Exit if there are no individuals currently using a contraceptive:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">individuals_using</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">processed_params</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span>

        <span class="c1"># Get the probability of discontinuation for each individual (depends on age and current method)</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">individuals_using</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;age_years&#39;</span><span class="p">,</span> <span class="s1">&#39;co_contraception&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">pp</span><span class="p">[</span><span class="s1">&#39;p_stop_per_month&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">]</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">age_years</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">co_contraception</span><span class="p">],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>

        <span class="c1"># Determine if each individual will discontinue</span>
        <span class="n">will_stop_idx</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">prob</span> <span class="o">&gt;</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prob</span><span class="p">))]</span>

        <span class="c1"># Do the contraceptive change</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">will_stop_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">schedule_batch_of_contraceptive_changes</span><span class="p">(</span>
                <span class="n">ids</span><span class="o">=</span><span class="n">will_stop_idx</span><span class="p">,</span>
                <span class="n">old</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">will_stop_idx</span><span class="p">,</span> <span class="s1">&#39;co_contraception&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                <span class="n">new</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;not_using&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">will_stop_idx</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># 2) -- Switches and Continuations for those who do not Discontinue:</span>
        <span class="n">individuals_eligible_for_continue_or_switch</span> <span class="o">=</span> <span class="n">individuals_using</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">will_stop_idx</span><span class="p">)</span>

        <span class="c1"># Get the probability of switching contraceptive for all those currently using</span>
        <span class="n">switch_prob</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">individuals_eligible_for_continue_or_switch</span><span class="p">,</span> <span class="s1">&#39;co_contraception&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="n">pp</span><span class="p">[</span><span class="s1">&#39;p_switch_from_per_month&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Randomly select who will switch contraceptive and who will remain on their current contraceptive</span>
        <span class="n">will_switch</span> <span class="o">=</span> <span class="n">switch_prob</span> <span class="o">&gt;</span> <span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">individuals_eligible_for_continue_or_switch</span><span class="p">))</span>
        <span class="n">switch_idx</span> <span class="o">=</span> <span class="n">individuals_eligible_for_continue_or_switch</span><span class="p">[</span><span class="n">will_switch</span><span class="p">]</span>
        <span class="n">switch_idx_below30</span> <span class="o">=</span> <span class="n">switch_idx</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">switch_idx</span><span class="p">,</span> <span class="s1">&#39;age_years&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">]</span>
        <span class="n">switch_idx_30plus</span> <span class="o">=</span> <span class="n">switch_idx</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">switch_idx_below30</span><span class="p">)</span>
        <span class="n">continue_idx</span> <span class="o">=</span> <span class="n">individuals_eligible_for_continue_or_switch</span><span class="p">[</span><span class="o">~</span><span class="n">will_switch</span><span class="p">]</span>

        <span class="c1"># For that do switch, select the new contraceptive using switching matrix</span>
        <span class="n">new_co_below30</span> <span class="o">=</span> <span class="n">transition_states</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">switch_idx_below30</span><span class="p">,</span> <span class="s1">&#39;co_contraception&#39;</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="s1">&#39;p_switching_to_below30&#39;</span><span class="p">],</span> <span class="n">rng</span>
        <span class="p">)</span>
        <span class="n">new_co_30plus</span> <span class="o">=</span> <span class="n">transition_states</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">switch_idx_30plus</span><span class="p">,</span> <span class="s1">&#39;co_contraception&#39;</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="s1">&#39;p_switching_to_30plus&#39;</span><span class="p">],</span> <span class="n">rng</span>
        <span class="p">)</span>
        <span class="n">new_co</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">new_co_below30</span><span class="p">,</span> <span class="n">new_co_30plus</span><span class="p">])</span>

        <span class="c1"># Do the contraceptive change for those switching</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_co</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">schedule_batch_of_contraceptive_changes</span><span class="p">(</span>
                <span class="n">ids</span><span class="o">=</span><span class="n">new_co</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">old</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">new_co</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;co_contraception&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                <span class="n">new</span><span class="o">=</span><span class="n">new_co</span><span class="o">.</span><span class="n">values</span>
            <span class="p">)</span>

        <span class="c1"># Do the contraceptive &quot;change&quot; for those not switching (this is so that an HSI may be logged and if the HSI</span>
        <span class="c1">#  cannot occur the person discontinues use of the method).</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">continue_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">current_contraception</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">continue_idx</span><span class="p">,</span> <span class="s1">&#39;co_contraception&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">schedule_batch_of_contraceptive_changes</span><span class="p">(</span>
                <span class="n">ids</span><span class="o">=</span><span class="n">continue_idx</span><span class="p">,</span>
                <span class="n">old</span><span class="o">=</span><span class="n">current_contraception</span><span class="p">,</span>
                <span class="n">new</span><span class="o">=</span><span class="n">current_contraception</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="ContraceptionPoll.update_pregnancy">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.ContraceptionPoll.update_pregnancy">[docs]</a>
    <span class="k">def</span> <span class="nf">update_pregnancy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine who will become pregnant&quot;&quot;&quot;</span>

        <span class="c1"># Determine pregnancy for those on a contraceptive (&quot;unintentional pregnancy&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pregnancy_for_those_on_contraceptive</span><span class="p">()</span>

        <span class="c1"># Determine pregnancy for those not on contraceptive (&quot;intentional pregnancy&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pregnancy_for_those_not_on_contraceptive</span><span class="p">()</span></div>


<div class="viewcode-block" id="ContraceptionPoll.pregnancy_for_those_on_contraceptive">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.ContraceptionPoll.pregnancy_for_those_on_contraceptive">[docs]</a>
    <span class="k">def</span> <span class="nf">pregnancy_for_those_on_contraceptive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Look across all women who are using a contraception method to determine if they become pregnant (i.e., the</span>
<span class="sd">         method fails).&quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">processed_params</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span>

        <span class="n">prob_failure_per_month</span> <span class="o">=</span> <span class="n">pp</span><span class="p">[</span><span class="s1">&#39;p_pregnancy_with_contraception_per_month&#39;</span><span class="p">]</span>

        <span class="c1"># Get the women who are using a contraceptive that may fail and who may become pregnant (i.e., women who</span>
        <span class="c1"># are not in labour, have been pregnant in the last month, have previously had a hysterectomy, can get</span>
        <span class="c1"># pregnant.)</span>
        <span class="n">possible_to_fail</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s1">&#39;F&#39;</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">is_pregnant</span>
            <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">age_low</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">age_high</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">co_contraception</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;not_using&#39;</span><span class="p">,</span> <span class="s1">&#39;female_sterilization&#39;</span><span class="p">])</span>
            <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">la_currently_in_labour</span>
            <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">la_has_had_hysterectomy</span>
            <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">la_is_postpartum</span>
            <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">ps_ectopic_pregnancy</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;not_ruptured&#39;</span><span class="p">,</span> <span class="s1">&#39;ruptured&#39;</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">possible_to_fail</span><span class="o">.</span><span class="n">sum</span><span class="p">():</span>
            <span class="c1"># Get probability of method failure for each individual</span>
            <span class="n">prob_of_failure</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">possible_to_fail</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;age_years&#39;</span><span class="p">,</span> <span class="s1">&#39;co_contraception&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">prob_failure_per_month</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">age_years</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">co_contraception</span><span class="p">],</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>

            <span class="c1"># Determine if there will be a contraceptive failure for each individual</span>
            <span class="n">idx_failure</span> <span class="o">=</span> <span class="n">prob_of_failure</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">prob_of_failure</span> <span class="o">&gt;</span> <span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">prob_of_failure</span><span class="p">))]</span>

            <span class="c1"># Effect these women to be pregnant</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_new_pregnancy</span><span class="p">(</span><span class="n">women_id</span><span class="o">=</span><span class="n">idx_failure</span><span class="p">)</span></div>


<div class="viewcode-block" id="ContraceptionPoll.pregnancy_for_those_not_on_contraceptive">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.ContraceptionPoll.pregnancy_for_those_not_on_contraceptive">[docs]</a>
    <span class="k">def</span> <span class="nf">pregnancy_for_those_not_on_contraceptive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Look across all woman who are not using a contraceptive to determine who will become pregnant.&quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">processed_params</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span>

        <span class="c1"># Get the subset of women who are not using a contraceptive and who may become pregnant</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s1">&#39;F&#39;</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">is_pregnant</span>
            <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">age_low</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">age_high</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">co_contraception</span> <span class="o">==</span> <span class="s1">&#39;not_using&#39;</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">la_currently_in_labour</span>
            <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">la_has_had_hysterectomy</span>
            <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">la_is_postpartum</span>
            <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">ps_ectopic_pregnancy</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;not_ruptured&#39;</span><span class="p">,</span> <span class="s1">&#39;ruptured&#39;</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">subset</span><span class="o">.</span><span class="n">sum</span><span class="p">():</span>
            <span class="c1"># Get the probability of pregnancy for each individual</span>
            <span class="n">prob_pregnancy</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">subset</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;age_years&#39;</span><span class="p">,</span> <span class="s1">&#39;hv_inf&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">pp</span><span class="p">[</span><span class="s1">&#39;p_pregnancy_no_contraception_per_month&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">at</span><span class="p">[</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">age_years</span><span class="p">,</span> <span class="s1">&#39;hv_inf_True&#39;</span> <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">hv_inf</span> <span class="k">else</span> <span class="s1">&#39;hv_inf_False&#39;</span>
                <span class="p">],</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Determine if there will be a pregnancy for each individual</span>
            <span class="n">idx_pregnant</span> <span class="o">=</span> <span class="n">prob_pregnancy</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">prob_pregnancy</span> <span class="o">&gt;</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prob_pregnancy</span><span class="p">))]</span>

            <span class="c1"># Effect these women to be pregnant</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_new_pregnancy</span><span class="p">(</span><span class="n">women_id</span><span class="o">=</span><span class="n">idx_pregnant</span><span class="p">)</span></div>


<div class="viewcode-block" id="ContraceptionPoll.set_new_pregnancy">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.ContraceptionPoll.set_new_pregnancy">[docs]</a>
    <span class="k">def</span> <span class="nf">set_new_pregnancy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">women_id</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Effect that these women are now pregnancy and enter to the log&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">women_id</span><span class="p">:</span>
            <span class="n">woman</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;co_contraception&#39;</span><span class="p">,</span> <span class="s1">&#39;age_years&#39;</span><span class="p">]]</span>
            <span class="n">method_before_pregnancy</span> <span class="o">=</span> <span class="n">woman</span><span class="p">[</span><span class="s1">&#39;co_contraception&#39;</span><span class="p">]</span>

            <span class="c1"># Determine if this is unintended or not. (We say that it is &#39;unintended&#39; if the women is using a</span>
            <span class="c1"># contraceptive when she becomes pregnant.)</span>
            <span class="n">unintended</span> <span class="o">=</span> <span class="p">(</span><span class="n">method_before_pregnancy</span> <span class="o">!=</span> <span class="s1">&#39;not_using&#39;</span><span class="p">)</span>

            <span class="c1"># Update properties (including that she is no longer on any contraception; and store the method used prior</span>
            <span class="c1"># pregnancy).</span>
            <span class="n">new_properties</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;co_contraception&#39;</span><span class="p">:</span> <span class="s1">&#39;not_using&#39;</span><span class="p">,</span>
                <span class="s1">&#39;is_pregnant&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;date_of_last_pregnancy&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                <span class="s1">&#39;co_unintended_preg&#39;</span><span class="p">:</span> <span class="n">unintended</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">new_properties</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span> <span class="o">=</span> <span class="n">new_properties</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

            <span class="c1"># Set date of labour in the Labour module</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;Labour&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_date_of_labour</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

            <span class="c1"># Log that a pregnancy has occurred</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;pregnancy&#39;</span><span class="p">,</span>
                        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                            <span class="s1">&#39;woman_id&#39;</span><span class="p">:</span> <span class="n">w</span><span class="p">,</span>
                            <span class="s1">&#39;age_years&#39;</span><span class="p">:</span> <span class="n">woman</span><span class="p">[</span><span class="s1">&#39;age_years&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;contraception&#39;</span><span class="p">:</span> <span class="n">method_before_pregnancy</span><span class="p">,</span>
                            <span class="s1">&#39;unintended&#39;</span><span class="p">:</span> <span class="n">unintended</span>
                        <span class="p">},</span>
                        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;pregnancy following the failure of contraceptive method&#39;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="ContraceptionLoggingEvent">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.ContraceptionLoggingEvent">[docs]</a>
<span class="k">class</span> <span class="nc">ContraceptionLoggingEvent</span><span class="p">(</span><span class="n">RegularEvent</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">):</span>
<div class="viewcode-block" id="ContraceptionLoggingEvent.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.ContraceptionLoggingEvent.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Logs state of contraceptive usage in the population at a point in time.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span></div>


<div class="viewcode-block" id="ContraceptionLoggingEvent.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.ContraceptionLoggingEvent.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="c1"># Log summary of usage of contraceptives (without age-breakdown)</span>
        <span class="c1"># (NB. sort_index ensures the resulting dict has keys in the same order, which is requirement of the logging.)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;contraception_use_summary&#39;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s1">&#39;F&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">49</span><span class="p">),</span> <span class="s1">&#39;co_contraception&#39;</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
                    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Counts of women on each type of contraceptive at a point in time.&#39;</span><span class="p">)</span>

        <span class="c1"># Log summary of usage of contraceptives (with age-breakdown)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;contraception_use_summary_by_age&#39;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">flatten_multi_index_series_into_dict_for_logging</span><span class="p">(</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                            <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s1">&#39;F&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">49</span><span class="p">)</span>
                            <span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;co_contraception&#39;</span><span class="p">,</span> <span class="s1">&#39;age_range&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
                    <span class="p">),</span>
                    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Counts of women, by age-range, on each type of contraceptive at a point in time.&#39;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="HSI_Contraception_FamilyPlanningAppt">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.HSI_Contraception_FamilyPlanningAppt">[docs]</a>
<span class="k">class</span> <span class="nc">HSI_Contraception_FamilyPlanningAppt</span><span class="p">(</span><span class="n">HSI_Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;HSI event for the starting a contraceptive method, maintaining use of a method of a contraceptive, or switching</span>
<span class="sd">     between contraceptives.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="HSI_Contraception_FamilyPlanningAppt.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.HSI_Contraception_FamilyPlanningAppt.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">new_contraceptive</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>

        <span class="n">_facility_level</span> <span class="o">=</span> <span class="s1">&#39;2&#39;</span> <span class="k">if</span> <span class="n">new_contraceptive</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;implant&#39;</span><span class="p">,</span> <span class="s1">&#39;female_sterilization&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;1a&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">new_contraceptive</span> <span class="o">=</span> <span class="n">new_contraceptive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_number_of_times_run</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">TREATMENT_ID</span> <span class="o">=</span> <span class="s2">&quot;Contraception_Routine&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span> <span class="o">=</span> <span class="n">_facility_level</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">EXPECTED_APPT_FOOTPRINT</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the expected appt footprint based on contraception method and whether the HSI has been rescheduled.&quot;&quot;&quot;</span>
        <span class="n">person_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span>
        <span class="n">current_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span><span class="o">.</span><span class="n">co_contraception</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_number_of_times_run</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># if it is to re-schedule due to unavailable consumables</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({})</span>
        <span class="c1"># if to switch to a method</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_contraceptive</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;female_sterilization&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s1">&#39;MinorSurg&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_contraceptive</span> <span class="o">!=</span> <span class="n">current_method</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s1">&#39;FamPlan&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="c1"># if to maintain on a method</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_contraceptive</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;injections&#39;</span><span class="p">,</span> <span class="s1">&#39;IUD&#39;</span><span class="p">,</span> <span class="s1">&#39;implant&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s1">&#39;FamPlan&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_contraceptive</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;male_condom&#39;</span><span class="p">,</span> <span class="s1">&#39;other_modern&#39;</span><span class="p">,</span> <span class="s1">&#39;pill&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s1">&#39;PharmDispensing&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({})</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="ne">UserWarning</span><span class="p">(</span><span class="s2">&quot;Assumed empty footprint for Contraception Routine appt because couldn&#39;t find&quot;</span>
                                      <span class="s2">&quot;actual case.&quot;</span><span class="p">))</span>

<div class="viewcode-block" id="HSI_Contraception_FamilyPlanningAppt.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.HSI_Contraception_FamilyPlanningAppt.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">squeeze_factor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;If the relevant consumable is available, do change in contraception and log it&quot;&quot;&quot;</span>

        <span class="n">person</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span>
        <span class="n">current_method</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="n">co_contraception</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">is_alive</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">person</span><span class="o">.</span><span class="n">is_pregnant</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># Record the date that Family Planning Appointment happened for this person</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;co_date_of_last_fp_appt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>

        <span class="c1"># Determine essential and optional items</span>
        <span class="c1"># TODO: we don&#39;t distinguish essential X optional for contraception methods yet, will need to update once we do</span>
        <span class="n">items_essential</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">cons_codes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">new_contraceptive</span><span class="p">]</span>
        <span class="n">items_optional</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Record use of consumables and default the person to &quot;not_using&quot; if the consumable is not available.</span>
        <span class="c1"># If initiating use of a modern contraceptive method except condoms (after not using any or using non-modern</span>
        <span class="c1"># contraceptive or using condoms), &quot;co_initiation&quot; items are used along with the method consumables.</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">current_method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">contraceptives_initiated_with_additional_items</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_contraceptive</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">contraceptives_initiated_with_additional_items</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">items_optional</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">cons_codes</span><span class="p">[</span><span class="s2">&quot;co_initiation&quot;</span><span class="p">]</span>
            <span class="n">cons_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_consumables</span><span class="p">(</span>
                <span class="n">item_codes</span><span class="o">=</span><span class="n">items_essential</span><span class="p">,</span>
                <span class="n">optional_item_codes</span><span class="o">=</span><span class="n">items_optional</span><span class="p">,</span>
                <span class="n">return_individual_results</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cons_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_consumables</span><span class="p">(</span>
                <span class="n">item_codes</span><span class="o">=</span><span class="n">items_essential</span><span class="p">,</span>
                <span class="n">return_individual_results</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

        <span class="n">items_all</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">items_essential</span><span class="p">,</span> <span class="o">**</span><span class="n">items_optional</span><span class="p">}</span>

        <span class="c1"># Determine whether the contraception is administrated (ie all essential items are available),</span>
        <span class="c1"># if so do log the availability of all items, if not set the contraception to &quot;not_using&quot;:</span>
        <span class="n">co_administrated</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cons_available</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">items_essential</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">co_administrated</span><span class="p">:</span>
            <span class="c1"># if not running contraception module at debug level, it&#39;s pointless to save the (not) available items</span>
            <span class="k">if</span> <span class="n">logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
                <span class="c1"># Do logging of consumables for the `Consumables` module. Although this is duplicative of the detailed</span>
                <span class="c1"># logging of consumables in the `HealthSystem` module, it is done here too as the file generated by the</span>
                <span class="c1"># `HealthSystem` module is extremely large and not usable for the very long runs that are needed for the</span>
                <span class="c1"># analyses using the `Contraception` module.</span>
                <span class="n">items_available</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">items_all</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">cons_available</span><span class="p">[</span><span class="n">k</span><span class="p">]}</span>
                <span class="n">items_not_available</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">items_all</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">cons_available</span><span class="p">[</span><span class="n">k</span><span class="p">]}</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;Contraception_consumables&#39;</span><span class="p">,</span>
                             <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                                 <span class="s1">&#39;TREATMENT_ID&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TREATMENT_ID</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TREATMENT_ID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                                 <span class="s1">&#39;Item_Available&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">items_available</span><span class="p">),</span>
                                 <span class="s1">&#39;Item_NotAvailable&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">items_not_available</span><span class="p">),</span>
                             <span class="p">},</span>
                             <span class="c1"># NB. Casting the data to strings because logger complains with dict of varying sizes/keys</span>
                             <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Record of each contraception consumable item if the contraceptive is &quot;</span>
                                         <span class="s2">&quot;administrated.&quot;</span>
                             <span class="p">)</span>

            <span class="n">_new_contraceptive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_contraceptive</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_new_contraceptive</span> <span class="o">=</span> <span class="s2">&quot;not_using&quot;</span>

        <span class="k">if</span> <span class="n">current_method</span> <span class="o">!=</span> <span class="n">_new_contraceptive</span><span class="p">:</span>
            <span class="c1"># Do the change:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">do_and_log_individual_contraception_change</span><span class="p">(</span>
                <span class="n">woman_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
                <span class="n">old</span><span class="o">=</span><span class="n">current_method</span><span class="p">,</span>
                <span class="n">new</span><span class="o">=</span><span class="n">_new_contraceptive</span>
            <span class="p">)</span>
            <span class="c1"># (N.B. If the current method is the same as the new method, there is no logging.)</span>

        <span class="c1"># If the intended change was not possible due to non-available consumable, reschedule the appointment</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">co_administrated</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_number_of_times_run</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;max_number_of_runs_of_hsi_if_consumable_not_available&#39;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reschedule</span><span class="p">()</span></div>


<div class="viewcode-block" id="HSI_Contraception_FamilyPlanningAppt.post_apply_hook">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.HSI_Contraception_FamilyPlanningAppt.post_apply_hook">[docs]</a>
    <span class="k">def</span> <span class="nf">post_apply_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_number_of_times_run</span> <span class="o">+=</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="HSI_Contraception_FamilyPlanningAppt.reschedule">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.HSI_Contraception_FamilyPlanningAppt.reschedule">[docs]</a>
    <span class="k">def</span> <span class="nf">reschedule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Schedule for this same HSI_Event to occur tomorrow.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span><span class="n">hsi_event</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                                                                   <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                                                                   <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                                   <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="HSI_Contraception_FamilyPlanningAppt.never_ran">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.HSI_Contraception_FamilyPlanningAppt.never_ran">[docs]</a>
    <span class="k">def</span> <span class="nf">never_ran</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;If this HSI never ran, the person defaults to &quot;not_using&quot; a contraceptive.&quot;&quot;&quot;</span>
        <span class="n">person</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">person</span><span class="o">.</span><span class="n">is_alive</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">do_and_log_individual_contraception_change</span><span class="p">(</span>
            <span class="n">woman_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
            <span class="n">old</span><span class="o">=</span><span class="n">person</span><span class="o">.</span><span class="n">co_contraception</span><span class="p">,</span>  <span class="c1"># Current Method</span>
            <span class="n">new</span><span class="o">=</span><span class="s2">&quot;not_using&quot;</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="StartInterventions">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.StartInterventions">[docs]</a>
<span class="k">class</span> <span class="nc">StartInterventions</span><span class="p">(</span><span class="n">Event</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This event is run by Contraception module exactly once when interventions are introduced, or never if interventions</span>
<span class="sd">    are not used. If run, it updates parameters changed to reflect the FP interventions to be used from now on.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="StartInterventions.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.StartInterventions.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">Contraception</span><span class="p">)</span></div>


<div class="viewcode-block" id="StartInterventions.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.StartInterventions.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>

        <span class="c1"># Update module parameters to enable interventions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">processed_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">update_params_for_interventions</span><span class="p">()</span></div>
</div>



<span class="c1"># -----------------------------------------------------------------------------------------------------------</span>
<span class="c1"># -----------------------------------------------------------------------------------------------------------</span>
<span class="c1">#</span>
<span class="c1"># Accessory modules for testing / debugging</span>
<span class="c1">#</span>
<span class="c1"># -----------------------------------------------------------------------------------------------------------</span>
<span class="c1"># -----------------------------------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="SimplifiedPregnancyAndLabour">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.SimplifiedPregnancyAndLabour">[docs]</a>
<span class="k">class</span> <span class="nc">SimplifiedPregnancyAndLabour</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simplified module to replace `Labour`, &#39;PregnancySupervisor` and other associated module, for use in</span>
<span class="sd">    testing/calibrating the Contraception Module. The module calls itself Labour and provides the method</span>
<span class="sd">    `set_date_of_labour`, which is called by the Contraception Module at the onset of pregnancy. It schedules an event</span>
<span class="sd">    for the end of the pregnancy (approximately 9 months later) which may or may not result in a live birth.&quot;&quot;&quot;</span>

    <span class="n">INIT_DEPENDENCIES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Contraception&#39;</span><span class="p">}</span>

    <span class="n">ALTERNATIVE_TO</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Labour&#39;</span><span class="p">}</span>

    <span class="n">METADATA</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">PARAMETERS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;prob_live_birth&#39;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s1">&#39;Probability that a pregnancy results in a live birth.&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">PROPERTIES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;la_currently_in_labour&#39;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span> <span class="s1">&#39;whether this woman is currently in labour&#39;</span><span class="p">),</span>
        <span class="s1">&#39;la_has_had_hysterectomy&#39;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span> <span class="s1">&#39;whether this woman has had a hysterectomy as treatment for a &#39;</span>
                                                        <span class="s1">&#39;complication of labour, and therefore is unable to conceive&#39;</span><span class="p">),</span>
        <span class="s1">&#39;la_is_postpartum&#39;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span> <span class="s1">&#39;Whether a woman is in the postpartum period, from delivery until &#39;</span>
                                                 <span class="s1">&#39;day +42 (6 weeks)&#39;</span><span class="p">),</span>
        <span class="s1">&#39;ps_ectopic_pregnancy&#39;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">CATEGORICAL</span><span class="p">,</span> <span class="s1">&#39;Whether a woman is experiencing ectopic pregnancy and&#39;</span>
                                                            <span class="s1">&#39; its current state&#39;</span><span class="p">,</span>
                                         <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;not_ruptured&#39;</span><span class="p">,</span> <span class="s1">&#39;ruptured&#39;</span><span class="p">]</span>
                                         <span class="p">)</span>
    <span class="p">}</span>

<div class="viewcode-block" id="SimplifiedPregnancyAndLabour.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.SimplifiedPregnancyAndLabour.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Labour&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SimplifiedPregnancyAndLabour.read_parameters">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.SimplifiedPregnancyAndLabour.read_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">read_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">parameter_dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;Contraception&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">resourcefilepath</span> <span class="o">/</span>
                                            <span class="s1">&#39;contraception&#39;</span> <span class="o">/</span>
                                            <span class="s1">&#39;ResourceFile_Contraception.xlsx&#39;</span><span class="p">,</span>
                                            <span class="n">sheet_name</span><span class="o">=</span><span class="s1">&#39;simplified_labour_parameters&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_parameters_from_dataframe</span><span class="p">(</span><span class="n">parameter_dataframe</span><span class="p">)</span></div>


<div class="viewcode-block" id="SimplifiedPregnancyAndLabour.initialise_population">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.SimplifiedPregnancyAndLabour.initialise_population">[docs]</a>
    <span class="k">def</span> <span class="nf">initialise_population</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s1">&#39;la_currently_in_labour&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s1">&#39;la_has_had_hysterectomy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s1">&#39;la_is_postpartum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s1">&#39;ps_ectopic_pregnancy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span></div>


<div class="viewcode-block" id="SimplifiedPregnancyAndLabour.initialise_simulation">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.SimplifiedPregnancyAndLabour.initialise_simulation">[docs]</a>
    <span class="k">def</span> <span class="nf">initialise_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="SimplifiedPregnancyAndLabour.on_birth">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.SimplifiedPregnancyAndLabour.on_birth">[docs]</a>
    <span class="k">def</span> <span class="nf">on_birth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mother_id</span><span class="p">,</span> <span class="n">child_id</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s1">&#39;la_currently_in_labour&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s1">&#39;la_has_had_hysterectomy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s1">&#39;la_is_postpartum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s1">&#39;ps_ectopic_pregnancy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span></div>


<div class="viewcode-block" id="SimplifiedPregnancyAndLabour.set_date_of_labour">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.SimplifiedPregnancyAndLabour.set_date_of_labour">[docs]</a>
    <span class="k">def</span> <span class="nf">set_date_of_labour</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This is a drop-in replacement for the method in Labour that triggers the processes that determine the outcome</span>
<span class="sd">        of a pregnancy.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">EndOfPregnancyEvent</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                                                    <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span>
                                                    <span class="n">live_birth</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;prob_live_birth&#39;</span><span class="p">])</span>
                                                    <span class="p">),</span>
                                <span class="n">random_date</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">14</span><span class="p">),</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">14</span><span class="p">),</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">)</span>
                                <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="EndOfPregnancyEvent">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.EndOfPregnancyEvent">[docs]</a>
<span class="k">class</span> <span class="nc">EndOfPregnancyEvent</span><span class="p">(</span><span class="n">Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This event signals the end of the pregnancy, which may or may not result in a live-birth&quot;&quot;&quot;</span>

<div class="viewcode-block" id="EndOfPregnancyEvent.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.EndOfPregnancyEvent.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">live_birth</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">live_birth</span> <span class="o">=</span> <span class="n">live_birth</span></div>


<div class="viewcode-block" id="EndOfPregnancyEvent.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.contraception.html#tlo.methods.contraception.EndOfPregnancyEvent.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;End pregnancy and do live birth if needed&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">live_birth</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">do_birth</span><span class="p">(</span><span class="n">person_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;Contraception&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">end_pregnancy</span><span class="p">(</span><span class="n">person_id</span><span class="p">)</span></div>
</div>



<span class="c1"># -----------------------------------------------------------------------------------------------------------</span>
<span class="c1"># -----------------------------------------------------------------------------------------------------------</span>
<span class="c1">#</span>
<span class="c1"># Helper functions</span>
<span class="c1">#</span>
<span class="c1"># -----------------------------------------------------------------------------------------------------------</span>
<span class="c1"># -----------------------------------------------------------------------------------------------------------</span>

<span class="k">def</span> <span class="nf">get_medium_variant_asfr_from_wpp_resourcefile</span><span class="p">(</span><span class="n">dat</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">months_exposure</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process the data on age-specific fertility rates into a form that can be used to quickly map</span>
<span class="sd">    age-ranges to an age-specific fertility rate (for the &quot;Medium Variant&quot; in the WPP data source).</span>
<span class="sd">    :param dat: Raw form of the data in `ResourceFile_ASFR_WPP.csv`</span>
<span class="sd">    :param months_exposure: The time (in integer number of months) over which the risk of pregnancy should be</span>
<span class="sd">    computed.</span>
<span class="sd">    :returns: a dict, keyed by year, giving a dataframe of risk of pregnancy over a period, by age &quot;&quot;&quot;</span>

    <span class="n">dat</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="o">~</span><span class="n">dat</span><span class="o">.</span><span class="n">Variant</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;WPP_Estimates&#39;</span><span class="p">,</span> <span class="s1">&#39;WPP_Medium variant&#39;</span><span class="p">])]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;Period-Start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;Period&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;Period-End&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;Period&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">years</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;Period-Start&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;Period-End&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>

    <span class="c1"># Convert the rates for asfr (rate of live-birth per year) to a rate per the frequency of this event repeating</span>
    <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;asfr_per_period&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">convert_annual_prob_to_monthly_prob</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;asfr&#39;</span><span class="p">],</span> <span class="n">num_months</span><span class="o">=</span><span class="n">months_exposure</span><span class="p">)</span>

    <span class="n">asfr</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># format is {year: {age-range: asfr}}</span>
    <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">years</span><span class="p">:</span>
        <span class="n">asfr</span><span class="p">[</span><span class="n">year</span><span class="p">]</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;Period-Start&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">year</span> <span class="o">&lt;=</span> <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;Period-End&#39;</span><span class="p">])</span>
            <span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Age_Grp&#39;</span><span class="p">)[</span><span class="s1">&#39;asfr_per_period&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">asfr</span>


<span class="k">def</span> <span class="nf">convert_annual_prob_to_monthly_prob</span><span class="p">(</span><span class="n">p_annual</span><span class="p">,</span> <span class="n">num_months</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">p_annual</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">num_months</span> <span class="o">/</span> <span class="mf">12.0</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">convert_monthly_prob_to_annual_prob</span><span class="p">(</span><span class="n">p_monthly</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">p_monthly</span><span class="p">)</span> <span class="o">**</span> <span class="mf">12.0</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
      <span class="lastupdated">Last updated on May 27, 2024.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>