

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>tlo.methods.hiv &mdash; TLOmodel 0.1.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> TLOmodel
          

          
          </a>

          
            
            
              <div class="version">
                0.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../azure_batch.html">Using Azure Batch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../authors.html">Authors</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">TLOmodel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../methods.html">tlo.methods</a> &raquo;</li>
        
      <li>tlo.methods.hiv</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for tlo.methods.hiv</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The HIV Module</span>
<span class="sd">Overview:</span>
<span class="sd">HIV infection ---&gt; AIDS onset Event (defined by the presence of AIDS symptoms) --&gt; AIDS Death Event</span>
<span class="sd">Testing is spontaneously taken-up and can lead to accessing intervention services (ART, VMMC, PrEP).</span>
<span class="sd">AIDS symptoms can also lead to care-seeking and there is routine testing for HIV at all non-emergency Generic HSI</span>
<span class="sd"> events.</span>
<span class="sd">Persons can be on ART -</span>
<span class="sd">    - with viral suppression: when the person with not develop AIDS, or if they have already, it is relieved and they</span>
<span class="sd">        will not die of AIDS; and the person is not infectious</span>
<span class="sd">    - without viral suppression: when there is no benefit in avoiding AIDS and infectiousness is unchanged.</span>
<span class="sd">Maintenance on ART and PrEP is re-assessed at periodic &#39;Decision Events&#39;, at which is it is determined if the person</span>
<span class="sd">  will attend the &quot;next&quot; HSI for continuation of the service; and if not, they are removed from that service and &quot;stop</span>
<span class="sd">  treatment&quot;. If a stock-out or non-availability of health system resources prevent treatment continuation, the person</span>
<span class="sd">  &quot;stops treatment&quot;. Stopping treatment leads to a new AIDS Event being scheduled. Persons can restart treatment. If a</span>
<span class="sd">  person has developed AIDS, starts treatment and then defaults from treatment, their &#39;original&#39; AIDS Death Event will</span>
<span class="sd">  still occur.</span>
<span class="sd">If PrEP is not available due to limitations in the HealthSystem, the person defaults to not being on PrEP.</span>
<span class="sd"># Things to note:</span>
<span class="sd">    * Need to incorporate testing for HIV at first ANC appointment (as it does in generic HSI)</span>
<span class="sd">    * Need to incorporate testing for infants born to HIV-positive mothers (currently done in on_birth here).</span>
<span class="sd">    * Need to incorporate cotrim for infants born to HIV-positive mothers (not done here)</span>
<span class="sd">    * Cotrimoxazole is not included - either in effect of consumption of the drug (because the effect is not known).</span>
<span class="sd">    * Calibration has not been done: most things look OK - except HIV-AIDS deaths</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">tlo</span> <span class="kn">import</span> <span class="n">DAYS_IN_YEAR</span><span class="p">,</span> <span class="n">DateOffset</span><span class="p">,</span> <span class="n">Module</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">,</span> <span class="n">Property</span><span class="p">,</span> <span class="n">Types</span><span class="p">,</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="nn">tlo.events</span> <span class="kn">import</span> <span class="n">Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">,</span> <span class="n">RegularEvent</span>
<span class="kn">from</span> <span class="nn">tlo.lm</span> <span class="kn">import</span> <span class="n">LinearModel</span><span class="p">,</span> <span class="n">LinearModelType</span><span class="p">,</span> <span class="n">Predictor</span>
<span class="kn">from</span> <span class="nn">tlo.methods</span> <span class="kn">import</span> <span class="n">Metadata</span><span class="p">,</span> <span class="n">demography</span>
<span class="kn">from</span> <span class="nn">tlo.methods.dxmanager</span> <span class="kn">import</span> <span class="n">DxTest</span>
<span class="kn">from</span> <span class="nn">tlo.methods.healthsystem</span> <span class="kn">import</span> <span class="n">HSI_Event</span>
<span class="kn">from</span> <span class="nn">tlo.methods.symptommanager</span> <span class="kn">import</span> <span class="n">Symptom</span>
<span class="kn">from</span> <span class="nn">tlo.util</span> <span class="kn">import</span> <span class="n">create_age_range_lookup</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>


<div class="viewcode-block" id="Hiv"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv">[docs]</a><span class="k">class</span> <span class="nc">Hiv</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The HIV Disease Module</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Hiv.__init__"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resourcefilepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run_with_checks</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resourcefilepath</span> <span class="o">=</span> <span class="n">resourcefilepath</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">run_with_checks</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_with_checks</span> <span class="o">=</span> <span class="n">run_with_checks</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stored_test_numbers</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># create empty list for storing hiv test numbers</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">daly_wts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">footprints_for_consumables_required</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span></div>

    <span class="n">METADATA</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">Metadata</span><span class="o">.</span><span class="n">DISEASE_MODULE</span><span class="p">,</span>
        <span class="n">Metadata</span><span class="o">.</span><span class="n">USES_SYMPTOMMANAGER</span><span class="p">,</span>
        <span class="n">Metadata</span><span class="o">.</span><span class="n">USES_HEALTHSYSTEM</span><span class="p">,</span>
        <span class="n">Metadata</span><span class="o">.</span><span class="n">USES_HEALTHBURDEN</span>
    <span class="p">}</span>

    <span class="n">PROPERTIES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># --- Core Properties</span>
        <span class="s2">&quot;hv_inf&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span>
            <span class="s2">&quot;Is person currently infected with HIV (NB. AIDS status is determined by prescence of the AIDS Symptom.&quot;</span><span class="p">),</span>
        <span class="s2">&quot;hv_art&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">CATEGORICAL</span><span class="p">,</span>
            <span class="s2">&quot;ART status of person, whether on ART or not; and whether viral load is suppressed or not if on ART.&quot;</span><span class="p">,</span>
            <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;not&quot;</span><span class="p">,</span> <span class="s2">&quot;on_VL_suppressed&quot;</span><span class="p">,</span> <span class="s2">&quot;on_not_VL_suppressed&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;hv_is_on_prep&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span>
            <span class="s2">&quot;Whether the person is currently taking and receiving a protective effect from Pre-Exposure Prophylaxis.&quot;</span><span class="p">),</span>
        <span class="s2">&quot;hv_behaviour_change&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span>
            <span class="s2">&quot;Has this person been exposed to HIV prevention counselling following a negative HIV test result&quot;</span><span class="p">),</span>
        <span class="s2">&quot;hv_diagnosed&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span> <span class="s2">&quot;Knows that they are HIV+: i.e. is HIV+ and tested as HIV+&quot;</span><span class="p">),</span>
        <span class="s2">&quot;hv_number_tests&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span> <span class="s2">&quot;Number of HIV tests ever taken&quot;</span><span class="p">),</span>
        <span class="s2">&quot;hv_last_test_date&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATE</span><span class="p">,</span> <span class="s2">&quot;Date of last HIV test&quot;</span><span class="p">),</span>

        <span class="c1"># --- Dates on which things have happened:</span>
        <span class="s2">&quot;hv_date_inf&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATE</span><span class="p">,</span> <span class="s2">&quot;Date infected with HIV&quot;</span><span class="p">),</span>

    <span class="p">}</span>

    <span class="n">PARAMETERS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># Baseline characteristics</span>
        <span class="s2">&quot;time_inf&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s2">&quot;prob of time since infection for baseline adult pop&quot;</span><span class="p">),</span>
        <span class="s2">&quot;art_coverage&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s2">&quot;coverage of ART at baseline&quot;</span><span class="p">),</span>

        <span class="s2">&quot;fraction_of_those_infected_that_have_aids_at_initiation&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Fraction of persons living with HIV at baseline that have developed AIDS&quot;</span><span class="p">),</span>
        <span class="s2">&quot;testing_coverage_male&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;proportion of adult male population tested&quot;</span><span class="p">),</span>
        <span class="s2">&quot;testing_coverage_female&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;proportion of adult female population tested&quot;</span><span class="p">),</span>

        <span class="c1"># Natural history - transmission - overall rates</span>
        <span class="s2">&quot;beta&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Transmission rate&quot;</span><span class="p">),</span>
        <span class="s2">&quot;prob_mtct_untreated&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Probability of mother to child transmission&quot;</span><span class="p">),</span>
        <span class="s2">&quot;prob_mtct_treated&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Probability of mother to child transmission, mother on ART&quot;</span><span class="p">),</span>
        <span class="s2">&quot;prob_mtct_incident_preg&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Probability of mother to child transmission, mother infected during pregnancy&quot;</span><span class="p">),</span>
        <span class="s2">&quot;monthly_prob_mtct_bf_untreated&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Probability of mother to child transmission during breastfeeding&quot;</span><span class="p">),</span>
        <span class="s2">&quot;monthly_prob_mtct_bf_treated&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Probability of mother to child transmission, mother infected during breastfeeding&quot;</span><span class="p">),</span>

        <span class="c1"># Natural history - transmission - relative risk of HIV acquisition (non-intervention)</span>
        <span class="s2">&quot;rr_fsw&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative risk of HIV with female sex work&quot;</span><span class="p">),</span>
        <span class="s2">&quot;rr_circumcision&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative risk of HIV with circumcision&quot;</span><span class="p">),</span>
        <span class="s2">&quot;rr_rural&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative risk of HIV in rural location&quot;</span><span class="p">),</span>
        <span class="s2">&quot;rr_windex_poorer&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative risk of HIV with wealth level poorer&quot;</span><span class="p">),</span>
        <span class="s2">&quot;rr_windex_middle&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative risk of HIV with wealth level middle&quot;</span><span class="p">),</span>
        <span class="s2">&quot;rr_windex_richer&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative risk of HIV with wealth level richer&quot;</span><span class="p">),</span>
        <span class="s2">&quot;rr_windex_richest&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative risk of HIV with wealth level richest&quot;</span><span class="p">),</span>
        <span class="s2">&quot;rr_sex_f&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative risk of HIV if female&quot;</span><span class="p">),</span>
        <span class="s2">&quot;rr_age_gp20&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative risk of HIV if age 20-24 compared with 15-19&quot;</span><span class="p">),</span>
        <span class="s2">&quot;rr_age_gp25&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative risk of HIV if age 25-29&quot;</span><span class="p">),</span>
        <span class="s2">&quot;rr_age_gp30&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative risk of HIV if age 30-34&quot;</span><span class="p">),</span>
        <span class="s2">&quot;rr_age_gp35&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative risk of HIV if age 35-39&quot;</span><span class="p">),</span>
        <span class="s2">&quot;rr_age_gp40&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative risk of HIV if age 40-44&quot;</span><span class="p">),</span>
        <span class="s2">&quot;rr_age_gp45&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative risk of HIV if age 45-49&quot;</span><span class="p">),</span>
        <span class="s2">&quot;rr_age_gp50&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative risk of HIV if age 50+&quot;</span><span class="p">),</span>
        <span class="s2">&quot;rr_edlevel_primary&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative risk of HIV with primary education&quot;</span><span class="p">),</span>
        <span class="s2">&quot;rr_edlevel_secondary&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative risk of HIV with secondary education&quot;</span><span class="p">),</span>
        <span class="s2">&quot;rr_edlevel_higher&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative risk of HIV with higher education&quot;</span><span class="p">),</span>

        <span class="c1"># Natural history - transmission - relative risk of HIV acquisition (interventions)</span>
        <span class="s2">&quot;rr_behaviour_change&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative risk of HIV with behaviour modification&quot;</span><span class="p">),</span>
        <span class="s2">&quot;proportion_reduction_in_risk_of_hiv_aq_if_on_prep&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Proportion reduction in risk of HIV acquisition if on PrEP. 0 for no efficacy; 1.0 for perfect efficacy.&quot;</span><span class="p">),</span>

        <span class="c1"># Natural history - survival (adults)</span>
        <span class="s2">&quot;mean_months_between_aids_and_death&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Mean number of months (distributed exponentially) for the time between AIDS and AIDS Death&quot;</span><span class="p">),</span>
        <span class="s2">&quot;mean_months_between_aids_and_death_infant&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Mean number of months for the time between AIDS and AIDS Death for infants&quot;</span><span class="p">),</span>
        <span class="s2">&quot;infection_to_death_weibull_shape_1519&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Shape parameter for Weibull describing time between infection and death for 15-19 yo (units: years)&quot;</span><span class="p">),</span>
        <span class="s2">&quot;infection_to_death_weibull_shape_2024&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Shape parameter for Weibull describing time between infection and death for 20-24 yo (units: years)&quot;</span><span class="p">),</span>
        <span class="s2">&quot;infection_to_death_weibull_shape_2529&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Shape parameter for Weibull describing time between infection and death for 25-29 yo (units: years)&quot;</span><span class="p">),</span>
        <span class="s2">&quot;infection_to_death_weibull_shape_3034&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Shape parameter for Weibull describing time between infection and death for 30-34 yo (units: years)&quot;</span><span class="p">),</span>
        <span class="s2">&quot;infection_to_death_weibull_shape_3539&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Shape parameter for Weibull describing time between infection and death for 35-39 yo (units: years)&quot;</span><span class="p">),</span>
        <span class="s2">&quot;infection_to_death_weibull_shape_4044&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Shape parameter for Weibull describing time between infection and death for 40-44 yo (units: years)&quot;</span><span class="p">),</span>
        <span class="s2">&quot;infection_to_death_weibull_shape_4549&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Shape parameter for Weibull describing time between infection and death for 45-49 yo (units: years)&quot;</span><span class="p">),</span>
        <span class="s2">&quot;infection_to_death_weibull_scale_1519&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Scale parameter for Weibull describing time between infection and death for 15-19 yo (units: years)&quot;</span><span class="p">),</span>
        <span class="s2">&quot;infection_to_death_weibull_scale_2024&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Scale parameter for Weibull describing time between infection and death for 20-24 yo (units: years)&quot;</span><span class="p">),</span>
        <span class="s2">&quot;infection_to_death_weibull_scale_2529&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Scale parameter for Weibull describing time between infection and death for 25-29 yo (units: years)&quot;</span><span class="p">),</span>
        <span class="s2">&quot;infection_to_death_weibull_scale_3034&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Scale parameter for Weibull describing time between infection and death for 30-34 yo (units: years)&quot;</span><span class="p">),</span>
        <span class="s2">&quot;infection_to_death_weibull_scale_3539&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Scale parameter for Weibull describing time between infection and death for 35-39 yo (units: years)&quot;</span><span class="p">),</span>
        <span class="s2">&quot;infection_to_death_weibull_scale_4044&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Scale parameter for Weibull describing time between infection and death for 40-44 yo (units: years)&quot;</span><span class="p">),</span>
        <span class="s2">&quot;infection_to_death_weibull_scale_4549&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Scale parameter for Weibull describing time between infection and death for 45-49 yo (units: years)&quot;</span><span class="p">),</span>
        <span class="s2">&quot;art_default_to_aids_mean_years&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Mean years between when a person (any change) stops being on treatment to when AIDS is onset (if the &quot;</span>
            <span class="s2">&quot;absence of resuming treatment).&quot;</span><span class="p">),</span>

        <span class="c1"># Natural history - survival (children)</span>
        <span class="s2">&quot;mean_survival_for_infants_infected_prior_to_birth&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Exponential rate parameter for mortality in infants who are infected before birth&quot;</span><span class="p">),</span>
        <span class="s2">&quot;infection_to_death_infant_infection_after_birth_weibull_scale&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Weibull scale parameter for mortality in infants who are infected after birth&quot;</span><span class="p">),</span>
        <span class="s2">&quot;infection_to_death_infant_infection_after_birth_weibull_shape&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Weibull shape parameter for mortality in infants who are infected after birth&quot;</span><span class="p">),</span>

        <span class="c1"># Uptake of Interventions</span>
        <span class="s2">&quot;prob_spontaneous_test_12m&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Probability that a person will seek HIV testing per 12 month period.&quot;</span><span class="p">),</span>
        <span class="s2">&quot;prob_start_art_after_hiv_test&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Probability that a person will start treatment, if HIV-positive, following testing&quot;</span><span class="p">),</span>
        <span class="s2">&quot;rr_start_art_if_aids_symptoms&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative probability of a person starting treatment if they have aids_symptoms compared to if&quot;</span>
                        <span class="s2">&quot;they do not.&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;prob_behav_chg_after_hiv_test&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Probability that a person will change risk behaviours, if HIV-negative, following testing&quot;</span><span class="p">),</span>
        <span class="s2">&quot;prob_prep_for_fsw_after_hiv_test&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Probability that a FSW will start PrEP, if HIV-negative, following testing&quot;</span><span class="p">),</span>
        <span class="s2">&quot;prob_circ_after_hiv_test&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Probability that a male will be circumcised, if HIV-negative, following testing&quot;</span><span class="p">),</span>
        <span class="s2">&quot;probability_of_being_retained_on_prep_every_3_months&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Probability that someone who has initiated on prep will attend an appointment and be on prep &quot;</span>
                        <span class="s2">&quot;for the next 3 months, until the next appointment.&quot;</span><span class="p">),</span>
        <span class="s2">&quot;probability_of_being_retained_on_art_every_6_months&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Probability that someone who has initiated on treatment will attend an appointment and be on &quot;</span>
                        <span class="s2">&quot;treatment for next 6 months, until the next appointment.&quot;</span><span class="p">),</span>
        <span class="s2">&quot;probability_of_seeking_further_art_appointment_if_drug_not_available&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Probability that a person who &#39;should&#39; be on art will seek another appointment (the following &quot;</span>
                        <span class="s2">&quot;day and try for each of the next 7 days) if drugs were not available.&quot;</span><span class="p">),</span>
        <span class="s2">&quot;probability_of_seeking_further_art_appointment_if_appointment_not_available&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Probability that a person who &#39;should&#39; be on art will seek another appointment if the health-&quot;</span>
                        <span class="s2">&quot;system has not been able to provide them with an appointment&quot;</span><span class="p">),</span>
        <span class="s2">&quot;vls_m&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Rates of viral load suppression males&quot;</span><span class="p">),</span>
        <span class="s2">&quot;vls_f&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Rates of viral load suppression males&quot;</span><span class="p">),</span>
        <span class="s2">&quot;vls_child&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Rates of viral load suppression in children 0-14 years&quot;</span><span class="p">),</span>
        <span class="s2">&quot;prep_start_year&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Year from which PrEP is available&quot;</span><span class="p">)</span>
    <span class="p">}</span>

<div class="viewcode-block" id="Hiv.read_parameters"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.read_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">read_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_folder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        * 1) Reads the ResourceFiles</span>
<span class="sd">        * 2) Declare the Symptoms</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># 1) Read the ResourceFiles</span>

        <span class="c1"># Short cut to parameters dict</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>

        <span class="n">workbook</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resourcefilepath</span><span class="p">,</span> <span class="s2">&quot;ResourceFile_HIV.xlsx&quot;</span><span class="p">),</span>
            <span class="n">sheet_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_parameters_from_dataframe</span><span class="p">(</span><span class="n">workbook</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">])</span>

        <span class="c1"># Load data on HIV prevalence</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;hiv_prev&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s2">&quot;hiv_prevalence&quot;</span><span class="p">]</span>

        <span class="c1"># Load assumed time since infected at baseline (year 2010)</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;time_inf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s2">&quot;time_since_infection_at_baselin&quot;</span><span class="p">]</span>

        <span class="c1"># Load assumed ART coverage at baseline (year 2010)</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;art_coverage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s2">&quot;art_coverage&quot;</span><span class="p">]</span>

        <span class="c1"># DALY weights</span>
        <span class="c1"># get the DALY weight that this module will use from the weight database (these codes are just random!)</span>
        <span class="k">if</span> <span class="s2">&quot;HealthBurden&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># Chronic infection but not AIDS (including if on ART)</span>
            <span class="c1"># (taken to be equal to &quot;Symptomatic HIV without anaemia&quot;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">daly_wts</span><span class="p">[</span><span class="s1">&#39;hiv_infection_but_not_aids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthBurden&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_daly_weight</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span>

            <span class="c1">#  AIDS without anti-retroviral treatment without anemia</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">daly_wts</span><span class="p">[</span><span class="s1">&#39;aids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthBurden&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_daly_weight</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span>

        <span class="c1"># 2)  Declare the Symptoms.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;SymptomManager&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">register_symptom</span><span class="p">(</span>
            <span class="n">Symptom</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;aids_symptoms&quot;</span><span class="p">,</span>
                    <span class="n">odds_ratio_health_seeking_in_adults</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>  <span class="c1"># High chance of seeking care when aids_symptoms onset</span>
                    <span class="n">odds_ratio_health_seeking_in_children</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>  <span class="c1"># High chance of seeking care when aids_symptoms onset</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Hiv.pre_initialise_population"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.pre_initialise_population">[docs]</a>    <span class="k">def</span> <span class="nf">pre_initialise_population</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        * Establish the Linear Models</span>
<span class="sd">        *</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>

        <span class="c1"># ---- LINEAR MODELS -----</span>
        <span class="c1"># LinearModel for the relative risk of becoming infected during the simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s1">&#39;rr_of_infection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinearModel</span><span class="o">.</span><span class="n">multiplicative</span><span class="p">(</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s1">&#39;age_years&#39;</span><span class="p">)</span>  <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;&lt;15&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                                    <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;&lt;20&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
                                    <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;&lt;25&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_age_gp20&quot;</span><span class="p">])</span>
                                    <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;&lt;30&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_age_gp25&quot;</span><span class="p">])</span>
                                    <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;&lt;35&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_age_gp30&quot;</span><span class="p">])</span>
                                    <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;&lt;40&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_age_gp35&quot;</span><span class="p">])</span>
                                    <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;&lt;45&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_age_gp40&quot;</span><span class="p">])</span>
                                    <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;&lt;50&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_age_gp45&quot;</span><span class="p">])</span>
                                    <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;&lt;80&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_age_gp50&quot;</span><span class="p">])</span>
                                    <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s1">&#39;sex&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_sex_f&quot;</span><span class="p">]),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s1">&#39;li_is_sexworker&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_fsw&quot;</span><span class="p">]),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s1">&#39;li_is_circ&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_circumcision&quot;</span><span class="p">]),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s1">&#39;hv_is_on_prep&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;proportion_reduction_in_risk_of_hiv_aq_if_on_prep&#39;</span><span class="p">]),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s1">&#39;li_urban&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_rural&quot;</span><span class="p">]),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s1">&#39;li_wealth&#39;</span><span class="p">)</span>  <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_windex_poorer&quot;</span><span class="p">])</span>
                                    <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_windex_middle&quot;</span><span class="p">])</span>
                                    <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_windex_richer&quot;</span><span class="p">])</span>
                                    <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_windex_richest&quot;</span><span class="p">]),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s1">&#39;li_ed_lev&#39;</span><span class="p">)</span>  <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_edlevel_primary&quot;</span><span class="p">])</span>
                                    <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_edlevel_secondary&quot;</span><span class="p">]),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s1">&#39;hv_behaviour_change&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_behaviour_change&quot;</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="c1"># LinearModels to give the shape and scale for the Weibull distribution describing time from infection to death</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s1">&#39;scale_parameter_for_infection_to_death&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinearModel</span><span class="o">.</span><span class="n">multiplicative</span><span class="p">(</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s1">&#39;age_years&#39;</span><span class="p">)</span>  <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;&lt;20&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_weibull_scale_1519&quot;</span><span class="p">])</span>
                                    <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;&lt;25&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_weibull_scale_2024&quot;</span><span class="p">])</span>
                                    <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;&lt;30&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_weibull_scale_2529&quot;</span><span class="p">])</span>
                                    <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;&lt;35&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_weibull_scale_3034&quot;</span><span class="p">])</span>
                                    <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;&lt;40&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_weibull_scale_3539&quot;</span><span class="p">])</span>
                                    <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;&lt;45&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_weibull_scale_4044&quot;</span><span class="p">])</span>
                                    <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;&lt;50&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_weibull_scale_4549&quot;</span><span class="p">])</span>
                                    <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_weibull_scale_4549&quot;</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s1">&#39;shape_parameter_for_infection_to_death&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinearModel</span><span class="o">.</span><span class="n">multiplicative</span><span class="p">(</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s1">&#39;age_years&#39;</span><span class="p">)</span>  <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;&lt;20&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_weibull_shape_1519&quot;</span><span class="p">])</span>
                                    <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;&lt;25&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_weibull_shape_2024&quot;</span><span class="p">])</span>
                                    <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;&lt;30&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_weibull_shape_2529&quot;</span><span class="p">])</span>
                                    <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;&lt;35&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_weibull_shape_3034&quot;</span><span class="p">])</span>
                                    <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;&lt;40&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_weibull_shape_3539&quot;</span><span class="p">])</span>
                                    <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;&lt;45&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_weibull_shape_4044&quot;</span><span class="p">])</span>
                                    <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;&lt;50&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_weibull_shape_4549&quot;</span><span class="p">])</span>
                                    <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_weibull_shape_4549&quot;</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="c1"># -- Linear Models for the Uptake of Services</span>
        <span class="c1"># Linear model that give the probability of seeking a &#39;Spontaneous&#39; Test for HIV</span>
        <span class="c1"># (= sum of probabilities for accessing any HIV service when not ill)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s1">&#39;lm_spontaneous_test_12m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinearModel</span><span class="p">(</span>
            <span class="n">LinearModelType</span><span class="o">.</span><span class="n">MULTIPLICATIVE</span><span class="p">,</span>
            <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prob_spontaneous_test_12m&quot;</span><span class="p">],</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s1">&#39;hv_diagnosed&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Linear model if the person will start ART, following when the person has been diagnosed:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s1">&#39;lm_art&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinearModel</span><span class="p">(</span>
            <span class="n">LinearModelType</span><span class="o">.</span><span class="n">MULTIPLICATIVE</span><span class="p">,</span>
            <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prob_start_art_after_hiv_test&quot;</span><span class="p">],</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s1">&#39;hv_inf&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s1">&#39;has_aids_symptoms&#39;</span><span class="p">,</span> <span class="n">external</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_start_art_if_aids_symptoms&quot;</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="c1"># Linear model for changing behaviour following an HIV-negative test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s1">&#39;lm_behavchg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinearModel</span><span class="p">(</span>
            <span class="n">LinearModelType</span><span class="o">.</span><span class="n">MULTIPLICATIVE</span><span class="p">,</span>
            <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prob_behav_chg_after_hiv_test&quot;</span><span class="p">],</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s1">&#39;hv_inf&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Linear model for starting PrEP (if F/sex-workers), following when the person has tested HIV -ve:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s1">&#39;lm_prep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinearModel</span><span class="p">(</span>
            <span class="n">LinearModelType</span><span class="o">.</span><span class="n">MULTIPLICATIVE</span><span class="p">,</span>
            <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prob_prep_for_fsw_after_hiv_test&quot;</span><span class="p">],</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s1">&#39;hv_inf&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s1">&#39;sex&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s1">&#39;li_is_sexworker&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Linear model for circumcision (if M) following when the person has been diagnosed:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s1">&#39;lm_circ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinearModel</span><span class="p">(</span>
            <span class="n">LinearModelType</span><span class="o">.</span><span class="n">MULTIPLICATIVE</span><span class="p">,</span>
            <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prob_circ_after_hiv_test&quot;</span><span class="p">],</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s1">&#39;hv_inf&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s1">&#39;sex&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Hiv.initialise_population"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.initialise_population">[docs]</a>    <span class="k">def</span> <span class="nf">initialise_population</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set our property values for the initial population.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="c1"># --- Current status</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s2">&quot;hv_inf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s2">&quot;hv_art&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;not&quot;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s2">&quot;hv_is_on_prep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s2">&quot;hv_behaviour_change&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s2">&quot;hv_diagnosed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s2">&quot;hv_number_tests&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># --- Dates on which things have happened</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s2">&quot;hv_date_inf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s2">&quot;hv_last_test_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>

        <span class="c1"># Launch sub-routines for allocating the right number of people into each category</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialise_baseline_prevalence</span><span class="p">(</span><span class="n">population</span><span class="p">)</span>  <span class="c1"># allocate baseline prevalence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialise_baseline_art</span><span class="p">(</span><span class="n">population</span><span class="p">)</span>  <span class="c1"># allocate baseline art coverage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialise_baseline_tested</span><span class="p">(</span><span class="n">population</span><span class="p">)</span>  <span class="c1"># allocate baseline art coverage</span></div>

<div class="viewcode-block" id="Hiv.initialise_baseline_prevalence"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.initialise_baseline_prevalence">[docs]</a>    <span class="k">def</span> <span class="nf">initialise_baseline_prevalence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign baseline HIV prevalence, according to age, sex and key other variables (established in analysis of DHS</span>
<span class="sd">        data).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="c1"># prob of infection based on age and sex in baseline year (2010:</span>
        <span class="n">prevalence_db</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;hiv_prev&quot;</span><span class="p">]</span>
        <span class="n">prev_2010</span> <span class="o">=</span> <span class="n">prevalence_db</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">prevalence_db</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="mi">2010</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;age_from&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="s1">&#39;prev_prop&#39;</span><span class="p">]]</span>
        <span class="n">prev_2010</span> <span class="o">=</span> <span class="n">prev_2010</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;age_from&#39;</span><span class="p">:</span> <span class="s1">&#39;age_years&#39;</span><span class="p">})</span>
        <span class="n">prob_of_infec</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;age_years&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">prev_2010</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;age_years&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)[</span>
            <span class="s1">&#39;prev_prop&#39;</span><span class="p">]</span>

        <span class="c1"># probability based on risk factors</span>
        <span class="n">rel_prob_by_risk_factor</span> <span class="o">=</span> <span class="n">LinearModel</span><span class="o">.</span><span class="n">multiplicative</span><span class="p">(</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;li_is_sexworker&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rr_fsw&quot;</span><span class="p">]),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;li_is_circ&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rr_circumcision&quot;</span><span class="p">]),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;li_urban&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rr_rural&quot;</span><span class="p">]),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;li_wealth&quot;</span><span class="p">)</span>  <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rr_windex_poorer&quot;</span><span class="p">])</span>
                                    <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rr_windex_middle&quot;</span><span class="p">])</span>
                                    <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rr_windex_richer&quot;</span><span class="p">])</span>
                                    <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rr_windex_richest&quot;</span><span class="p">]),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;li_ed_lev&quot;</span><span class="p">)</span>  <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rr_edlevel_primary&quot;</span><span class="p">])</span>
                                    <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rr_edlevel_secondary&quot;</span><span class="p">])</span>
        <span class="p">)</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">])</span>

        <span class="c1"># Rescale relative probability of infection so that its average is 1.0 within each age/sex group</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;age_years&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;age_years&#39;</span><span class="p">],</span>
            <span class="s1">&#39;sex&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sex&#39;</span><span class="p">],</span>
            <span class="s1">&#39;prob_of_infec&#39;</span><span class="p">:</span> <span class="n">prob_of_infec</span><span class="p">,</span>
            <span class="s1">&#39;rel_prob_by_risk_factor&#39;</span><span class="p">:</span> <span class="n">rel_prob_by_risk_factor</span>
        <span class="p">})</span>

        <span class="n">p</span><span class="p">[</span><span class="s1">&#39;mean_of_rel_prob_within_age_sex_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;age_years&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">])[</span>
            <span class="s1">&#39;rel_prob_by_risk_factor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="n">p</span><span class="p">[</span><span class="s1">&#39;scaled_rel_prob_by_risk_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;rel_prob_by_risk_factor&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;mean_of_rel_prob_within_age_sex_group&#39;</span><span class="p">]</span>
        <span class="n">p</span><span class="p">[</span><span class="s1">&#39;overall_prob_of_infec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;scaled_rel_prob_by_risk_factor&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;prob_of_infec&#39;</span><span class="p">]</span>
        <span class="n">infec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;overall_prob_of_infec&#39;</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;overall_prob_of_infec&#39;</span><span class="p">]</span>

        <span class="c1"># Assign the designated person as infected in the population.props dataframe:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">infec</span><span class="p">,</span> <span class="s1">&#39;hv_inf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Assign date that persons were infected by drawing from assumed distribution (for adults)</span>
        <span class="c1"># Clipped to prevent dates of infection before before the person was born.</span>
        <span class="n">years_ago_inf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_inf</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">],</span>
            <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">infec</span><span class="p">),</span>
            <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_inf</span><span class="p">[</span><span class="s2">&quot;scaled_prob&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="n">hv_date_inf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">years_ago_inf</span> <span class="o">*</span> <span class="n">DAYS_IN_YEAR</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">))</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">infec</span><span class="p">,</span> <span class="s2">&quot;hv_date_inf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hv_date_inf</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">date_of_birth</span><span class="p">)</span></div>

<div class="viewcode-block" id="Hiv.initialise_baseline_art"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.initialise_baseline_art">[docs]</a>    <span class="k">def</span> <span class="nf">initialise_baseline_art</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; assign initial art coverage levels</span>
<span class="sd">        also assign hiv test properties if allocated ART</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="c1"># 1) Determine who is currently on ART</span>
        <span class="n">worksheet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;art_coverage&quot;</span><span class="p">]</span>
        <span class="n">art_data</span> <span class="o">=</span> <span class="n">worksheet</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="mi">2010</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;single_age&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">,</span> <span class="s2">&quot;prop_coverage&quot;</span><span class="p">]</span>
        <span class="p">]</span>

        <span class="c1"># merge all susceptible individuals with their coverage probability based on sex and age</span>
        <span class="n">prob_art</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;age_years&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">art_data</span><span class="p">,</span>
            <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;age_years&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">],</span>
            <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;single_age&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">],</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
        <span class="p">)[</span><span class="s1">&#39;prop_coverage&#39;</span><span class="p">]</span>

        <span class="n">prob_art</span> <span class="o">=</span> <span class="n">prob_art</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">art_idx</span> <span class="o">=</span> <span class="n">prob_art</span><span class="o">.</span><span class="n">index</span><span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prob_art</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">prob_art</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
            <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span>
            <span class="p">]</span>

        <span class="c1"># 2) Determine adherence levels for those currently on ART, for each of adult men, adult women and children</span>
        <span class="n">adult_f_art_idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">art_idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s1">&#39;F&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">))]</span><span class="o">.</span><span class="n">index</span>
        <span class="n">adult_m_art_idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">art_idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s1">&#39;M&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">))]</span><span class="o">.</span><span class="n">index</span>
        <span class="n">child_art_idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">art_idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">))]</span><span class="o">.</span><span class="n">index</span>

        <span class="n">suppr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>  <span class="c1"># list of all indices for persons on ART and suppressed</span>
        <span class="n">notsuppr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>  <span class="c1"># list of all indices for persons on ART and not suppressed</span>

        <span class="k">def</span> <span class="nf">split_into_vl_and_notvl</span><span class="p">(</span><span class="n">all_idx</span><span class="p">,</span> <span class="n">prob</span><span class="p">):</span>
            <span class="n">vl_suppr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_idx</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">prob</span>
            <span class="n">suppr</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">all_idx</span><span class="p">[</span><span class="n">vl_suppr</span><span class="p">])</span>
            <span class="n">notsuppr</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">all_idx</span><span class="p">[</span><span class="o">~</span><span class="n">vl_suppr</span><span class="p">])</span>

        <span class="n">split_into_vl_and_notvl</span><span class="p">(</span><span class="n">adult_f_art_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;vls_f&#39;</span><span class="p">])</span>
        <span class="n">split_into_vl_and_notvl</span><span class="p">(</span><span class="n">adult_m_art_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;vls_m&#39;</span><span class="p">])</span>
        <span class="n">split_into_vl_and_notvl</span><span class="p">(</span><span class="n">child_art_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;vls_child&#39;</span><span class="p">])</span>

        <span class="c1"># Set ART status:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">suppr</span><span class="p">,</span> <span class="s2">&quot;hv_art&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;on_VL_suppressed&quot;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">notsuppr</span><span class="p">,</span> <span class="s2">&quot;hv_art&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;on_not_VL_suppressed&quot;</span>

        <span class="c1"># check that everyone on ART is labelled as such</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">art_idx</span><span class="p">,</span> <span class="s2">&quot;hv_art&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;not&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>

        <span class="c1"># for logical consistency, ensure that all persons on ART have been tested and diagnosed</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">art_idx</span><span class="p">,</span> <span class="s2">&quot;hv_number_tests&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">art_idx</span><span class="p">,</span> <span class="s2">&quot;hv_last_test_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">art_idx</span><span class="p">,</span> <span class="s2">&quot;hv_diagnosed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># all those on ART need to have event scheduled for continuation/cessation of treatment</span>
        <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">art_idx</span><span class="p">:</span>
            <span class="n">days</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
                <span class="n">Hiv_DecisionToContinueTreatment</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">days</span><span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="Hiv.initialise_baseline_tested"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.initialise_baseline_tested">[docs]</a>    <span class="k">def</span> <span class="nf">initialise_baseline_tested</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; assign initial hiv testing levels, only for adults</span>
<span class="sd">        all who have been allocated ART will already have property hv_number_tests=1</span>
<span class="sd">        use the hiv testing coverage levels to assign any remaining hiv tests</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>

        <span class="n">random_draw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
        <span class="n">testing_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;testing_coverage_female&#39;</span><span class="p">],</span> <span class="s1">&#39;M&#39;</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;testing_coverage_male&#39;</span><span class="p">]}</span>

        <span class="c1"># test_index = {}</span>
        <span class="k">for</span> <span class="n">sex</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">]:</span>
            <span class="n">hiv_test</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_number_tests</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="n">sex</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)])</span>
            <span class="n">pop</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="n">sex</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)])</span>
            <span class="n">hiv_test_coverage</span> <span class="o">=</span> <span class="n">hiv_test</span> <span class="o">/</span> <span class="n">pop</span>
            <span class="n">hiv_test_deficit</span> <span class="o">=</span> <span class="n">testing_dict</span><span class="p">[</span><span class="n">sex</span><span class="p">]</span> <span class="o">-</span> <span class="n">hiv_test_coverage</span>

            <span class="k">if</span> <span class="n">hiv_test_deficit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># assign more tests to fill testing coverage deficit</span>
                <span class="n">test_index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">random_draw</span> <span class="o">&lt;</span> <span class="n">hiv_test_deficit</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="n">sex</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span>
                    <span class="p">]</span>

                <span class="c1"># assign hiv tests to males and females</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test_index</span><span class="p">,</span> <span class="s1">&#39;hv_number_tests&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="c1"># dummy date for date last hiv test (before sim start), otherwise see big spike in testing 01-01-2010</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test_index</span><span class="p">,</span> <span class="s1">&#39;hv_last_test_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># person assumed to be diagnosed if they have had a test and are currently HIV positive:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[((</span><span class="n">df</span><span class="o">.</span><span class="n">hv_number_tests</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span><span class="p">),</span> <span class="s1">&#39;hv_diagnosed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Hiv.initialise_simulation"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.initialise_simulation">[docs]</a>    <span class="k">def</span> <span class="nf">initialise_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        * 1) Schedule the Main HIV Regular Polling Event</span>
<span class="sd">        * 2) Schedule the Logging Event</span>
<span class="sd">        * 3) Determine who has AIDS and impose the Symptoms &#39;aids_symptoms&#39;</span>
<span class="sd">        * 4) Schedule the AIDS onset events and AIDS death event for those infected already</span>
<span class="sd">        * 5) (Optionally) Schedule the event to check the configuration of all properties</span>
<span class="sd">        * 6) Define the DxTests</span>
<span class="sd">        * 7) Look-up and save the codes for consumables</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="c1"># 1) Schedule the Main HIV Regular Polling Event</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">HivRegularPollingEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>

        <span class="c1"># 2) Schedule the Logging Event</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">HivLoggingEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>

        <span class="c1"># 3) Determine who has AIDS and impose the Symptoms &#39;aids_symptoms&#39;</span>

        <span class="c1"># Those on ART currently (will not get any further events scheduled):</span>
        <span class="n">on_art_idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span>
            <span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_art</span> <span class="o">!=</span> <span class="s2">&quot;not&quot;</span><span class="p">)</span>
            <span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># Those that lived more than ten years and not currently on ART are assumed to currently have AIDS</span>
        <span class="c1">#  (will have AIDS Death event scheduled)</span>
        <span class="n">has_aids_idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span>
            <span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span> <span class="o">&amp;</span>
            <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_date_inf</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">365</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_art</span> <span class="o">==</span> <span class="s2">&quot;not&quot;</span><span class="p">)</span>
            <span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># Those that are in neither category are &quot;before AIDS&quot; (will have AIDS Onset Event scheduled)</span>
        <span class="n">before_aids_idx</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">has_aids_idx</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">on_art_idx</span><span class="p">)</span>

        <span class="c1"># Impose the symptom to those that have AIDS (the symptom is the definition of having AIDS)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;SymptomManager&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">change_symptom</span><span class="p">(</span>
            <span class="n">person_id</span><span class="o">=</span><span class="n">has_aids_idx</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
            <span class="n">symptom_string</span><span class="o">=</span><span class="s1">&#39;aids_symptoms&#39;</span><span class="p">,</span>
            <span class="n">add_or_remove</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
            <span class="n">disease_module</span><span class="o">=</span><span class="bp">self</span>
        <span class="p">)</span>

        <span class="c1"># 4) Schedule the AIDS onset events and AIDS death event for those infected already</span>
        <span class="c1"># AIDS Onset Event for those who are infected but not yet AIDS and have not ever started ART</span>
        <span class="c1"># NB. This means that those on ART at the start of the simulation may not have an AIDS event --</span>
        <span class="c1"># like it happened at some point in the past</span>

        <span class="k">for</span> <span class="n">person_id</span> <span class="ow">in</span> <span class="n">before_aids_idx</span><span class="p">:</span>
            <span class="c1"># get days until develops aids, repeating sampling until a positive number is obtained.</span>
            <span class="n">days_until_aids</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">days_until_aids</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">days_since_infection</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s1">&#39;hv_date_inf&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">days</span>
                <span class="n">days_infection_to_aids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">get_time_from_infection_to_aids</span><span class="p">(</span><span class="n">person_id</span><span class="p">))</span><span class="o">.</span><span class="n">months</span> <span class="o">*</span> <span class="mf">30.5</span><span class="p">)</span>
                <span class="n">days_until_aids</span> <span class="o">=</span> <span class="n">days_infection_to_aids</span> <span class="o">-</span> <span class="n">days_since_infection</span>

            <span class="n">date_onset_aids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days_until_aids</span><span class="p">)</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
                <span class="n">HivAidsOnsetEvent</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="p">),</span>
                <span class="n">date</span><span class="o">=</span><span class="n">date_onset_aids</span>
            <span class="p">)</span>

        <span class="c1"># Schedule the AIDS death events for those who have got AIDS already</span>
        <span class="k">for</span> <span class="n">person_id</span> <span class="ow">in</span> <span class="n">has_aids_idx</span><span class="p">:</span>
            <span class="n">date_aids_death</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time_from_aids_to_death</span><span class="p">()</span>  <span class="c1"># (assumes AIDS onset on this day)</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
                <span class="n">HivAidsDeathEvent</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="p">),</span>
                <span class="n">date</span><span class="o">=</span><span class="n">date_aids_death</span>
            <span class="p">)</span>

        <span class="c1"># 5) (Optionally) Schedule the event to check the configuration of all properties</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_with_checks</span><span class="p">:</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">HivCheckPropertiesEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># 6) Define the DxTests</span>
        <span class="c1"># HIV Rapid Diagnostic Test:</span>

        <span class="n">consumables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;Consumables&quot;</span><span class="p">]</span>
        <span class="n">pkg_code_hiv_rapid_test</span> <span class="o">=</span> <span class="n">consumables</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">consumables</span><span class="p">[</span><span class="s2">&quot;Intervention_Pkg&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;HIV Testing Services&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Intervention_Pkg_Code&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># NB. The rapid test is assumed to be 100% specific and sensitive. This is used to guarantee that all persons</span>
        <span class="c1">#  that start ART are truly HIV-pos.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">register_dx_test</span><span class="p">(</span>
            <span class="n">hiv_rapid_test</span><span class="o">=</span><span class="n">DxTest</span><span class="p">(</span>
                <span class="nb">property</span><span class="o">=</span><span class="s1">&#39;hv_inf&#39;</span><span class="p">,</span>
                <span class="n">cons_req_as_footprint</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Intervention_Package_Code&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">pkg_code_hiv_rapid_test</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="s1">&#39;Item_Code&#39;</span><span class="p">:</span> <span class="p">{}}</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Test for Early Infect Diagnosis</span>
        <span class="c1">#  - Consumables required:</span>
        <span class="n">item1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
            <span class="n">consumables</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">consumables</span><span class="p">[</span><span class="s2">&quot;Items&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Blood collecting tube, 5 ml&quot;</span><span class="p">,</span> <span class="s2">&quot;Item_Code&quot;</span>
            <span class="p">]</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">item2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
            <span class="n">consumables</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">consumables</span><span class="p">[</span><span class="s2">&quot;Items&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Gloves, exam, latex, disposable, pair&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Item_Code&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">item3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
            <span class="n">consumables</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">consumables</span><span class="p">[</span><span class="s2">&quot;Items&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;HIV EIA Elisa test&quot;</span><span class="p">,</span> <span class="s2">&quot;Item_Code&quot;</span><span class="p">]</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">register_dx_test</span><span class="p">(</span>
            <span class="n">hiv_early_infant_test</span><span class="o">=</span><span class="n">DxTest</span><span class="p">(</span>
                <span class="nb">property</span><span class="o">=</span><span class="s1">&#39;hv_inf&#39;</span><span class="p">,</span>
                <span class="n">sensitivity</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="n">specificity</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="n">cons_req_as_footprint</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Intervention_Package_Code&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;Item_Code&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">item1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">item2</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">item3</span><span class="p">:</span> <span class="mi">1</span><span class="p">}}</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># 7) Look-up and store the codes for the consumables used in the interventions.</span>
        <span class="n">consumables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;Consumables&quot;</span><span class="p">]</span>

        <span class="c1"># Circumcison:</span>
        <span class="n">pkg_codes_for_circ</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
            <span class="n">consumables</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">consumables</span><span class="p">[</span><span class="s2">&quot;Intervention_Pkg&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Male circumcision &quot;</span><span class="p">,</span>
                <span class="s2">&quot;Intervention_Pkg_Code&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">footprints_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;circ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Intervention_Package_Code&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">pkg_codes_for_circ</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
            <span class="s2">&quot;Item_Code&quot;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span>

        <span class="c1"># PrEP:</span>
        <span class="n">item_code_for_prep</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
            <span class="n">consumables</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">consumables</span><span class="p">[</span><span class="s2">&quot;Items&quot;</span><span class="p">]</span>
                <span class="o">==</span> <span class="s2">&quot;Tenofovir (TDF)/Emtricitabine (FTC), tablet, 300/200 mg&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Item_Code&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">footprints_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;prep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Intervention_Package_Code&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;Item_Code&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">item_code_for_prep</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="p">}</span>

        <span class="c1"># ART for adults</span>
        <span class="n">item_code_for_art</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
            <span class="n">consumables</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">consumables</span><span class="p">[</span><span class="s2">&quot;Items&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Adult First line 1A d4T-based&quot;</span><span class="p">,</span> <span class="s2">&quot;Item_Code&quot;</span>
            <span class="p">]</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">item_code_for_art2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
            <span class="n">consumables</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">consumables</span><span class="p">[</span><span class="s2">&quot;Items&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Cotrimoxizole, 960mg pppy&quot;</span><span class="p">,</span> <span class="s2">&quot;Item_Code&quot;</span>
            <span class="p">]</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># NB spelling error in consumables file &quot;Cotrimoxizole&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">footprints_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;art_adult&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Intervention_Package_Code&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;Item_Code&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">item_code_for_art</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">item_code_for_art2</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="p">}</span>

        <span class="c1"># ART for children:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">footprints_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;art_child&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Intervention_Package_Code&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">consumables</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                              <span class="n">consumables</span><span class="p">[</span><span class="s2">&quot;Intervention_Pkg&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Cotrimoxazole for children&quot;</span><span class="p">,</span>
                              <span class="s2">&quot;Intervention_Pkg_Code&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]:</span> <span class="mi">1</span><span class="p">},</span>
            <span class="s2">&quot;Item_Code&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">consumables</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                              <span class="n">consumables</span><span class="p">[</span>
                                  <span class="s2">&quot;Items&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Lamiduvine/Zidovudine/Nevirapine (3TC + AZT + NVP), tablet, 150 + 300&quot;</span>
                                              <span class="s2">&quot; + 200 mg&quot;</span><span class="p">,</span> <span class="s2">&quot;Item_Code&quot;</span><span class="p">])[</span>
                    <span class="mi">0</span><span class="p">]:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="p">}</span>

        <span class="c1"># Viral Load monitoring</span>
        <span class="n">item_code_for_viral_load</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
            <span class="n">consumables</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">consumables</span><span class="p">[</span><span class="s2">&quot;Intervention_Pkg&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Viral Load&quot;</span><span class="p">,</span> <span class="s2">&quot;Intervention_Pkg_Code&quot;</span>
            <span class="p">]</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">footprints_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;vl_measurement&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Intervention_Package_Code&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;Item_Code&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">item_code_for_viral_load</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="Hiv.on_birth"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.on_birth">[docs]</a>    <span class="k">def</span> <span class="nf">on_birth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mother_id</span><span class="p">,</span> <span class="n">child_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        * Initialise our properties for a newborn individual;</span>
<span class="sd">        * schedule testing;</span>
<span class="sd">        * schedule infection during breastfeeding</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="c1"># Default Settings:</span>
        <span class="c1"># --- Current status</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;hv_inf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;hv_art&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;not&quot;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;hv_is_on_prep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;hv_behaviour_change&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;hv_diagnosed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;hv_number_tests&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># --- Dates on which things have happened</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;hv_date_inf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;hv_last_test_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>

        <span class="c1"># ----------------------------------- MTCT - AT OR PRIOR TO BIRTH --------------------------</span>
        <span class="c1">#  DETERMINE IF THE CHILD IS INFECTED WITH HIV FROM THEIR MOTHER DURING PREGNANCY / DELIVERY</span>
        <span class="n">mother</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mother_id</span><span class="p">]</span>

        <span class="n">mother_infected_prior_to_pregnancy</span> <span class="o">=</span> <span class="n">mother</span><span class="o">.</span><span class="n">hv_inf</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mother</span><span class="o">.</span><span class="n">hv_date_inf</span> <span class="o">&lt;=</span> <span class="n">mother</span><span class="o">.</span><span class="n">date_of_last_pregnancy</span><span class="p">)</span>
        <span class="n">mother_infected_during_pregnancy</span> <span class="o">=</span> <span class="n">mother</span><span class="o">.</span><span class="n">hv_inf</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mother</span><span class="o">.</span><span class="n">hv_date_inf</span> <span class="o">&gt;</span> <span class="n">mother</span><span class="o">.</span><span class="n">date_of_last_pregnancy</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mother_infected_prior_to_pregnancy</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mother</span><span class="o">.</span><span class="n">hv_art</span> <span class="o">==</span> <span class="s2">&quot;on_VL_suppressed&quot;</span><span class="p">:</span>
                <span class="c1">#  mother has existing infection, mother ON ART and VL suppressed at time of delivery</span>
                <span class="n">child_infected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;prob_mtct_treated&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># mother was infected prior to prgenancy but is not on VL suppressed at time of delivery</span>
                <span class="n">child_infected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;prob_mtct_untreated&quot;</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">mother_infected_during_pregnancy</span><span class="p">:</span>
            <span class="c1">#  mother has incident infection during pregnancy, NO ART</span>
            <span class="n">child_infected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;prob_mtct_incident_preg&quot;</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># mother is not infected</span>
            <span class="n">child_infected</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">child_infected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_new_infection</span><span class="p">(</span><span class="n">child_id</span><span class="p">)</span>

        <span class="c1"># ----------------------------------- MTCT - DURING BREASTFEEDING --------------------------</span>
        <span class="c1"># If child is not infected and is being breastfed, then expose them to risk of MTCT through breastfeeding</span>
        <span class="c1"># TODO: note for AT/TH - neonatal breastfeeding property replaced HIV temp property as discussed 19/02/21.</span>
        <span class="c1">#  We need to make sure newborn outcomes on_birth is always called before HIV so breastfeeding status is set</span>
        <span class="c1">#  prior to this function being called</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">child_infected</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;nb_breastfeeding_status&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mother</span><span class="o">.</span><span class="n">hv_inf</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mtct_during_breastfeeding</span><span class="p">(</span><span class="n">mother_id</span><span class="p">,</span> <span class="n">child_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="Hiv.on_hsi_alert"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.on_hsi_alert">[docs]</a>    <span class="k">def</span> <span class="nf">on_hsi_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">treatment_id</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="Hiv.report_daly_values"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.report_daly_values">[docs]</a>    <span class="k">def</span> <span class="nf">report_daly_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Report DALYS for HIV, based on current symptomatic state of persons.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="n">dalys</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="c1"># All those infected get the &#39;infected but not AIDS&#39; daly_wt:</span>
        <span class="n">dalys</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">daly_wts</span><span class="p">[</span><span class="s1">&#39;hiv_infection_but_not_aids&#39;</span><span class="p">]</span>

        <span class="c1"># Overwrite the value for those that currently have symptoms of AIDS with the &#39;AIDS&#39; daly_wt:</span>
        <span class="n">dalys</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;SymptomManager&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">who_has</span><span class="p">(</span><span class="s1">&#39;aids_symptoms&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">daly_wts</span><span class="p">[</span><span class="s1">&#39;aids&#39;</span><span class="p">]</span>

        <span class="n">dalys</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;hiv&#39;</span>
        <span class="k">return</span> <span class="n">dalys</span></div>

<div class="viewcode-block" id="Hiv.mtct_during_breastfeeding"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.mtct_during_breastfeeding">[docs]</a>    <span class="k">def</span> <span class="nf">mtct_during_breastfeeding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mother_id</span><span class="p">,</span> <span class="n">child_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute risk of mother-to-child transmission and schedule HivInfectionDuringBreastFeedingEvent.</span>
<span class="sd">        If the child is breastfeeding currently, consider the time-until-infection assuming a constantly monthly risk of</span>
<span class="sd">         transmission. If the breastfeeding has ceased by the time of the scheduled infection, then it will not run.</span>
<span class="sd">        (This means that this event can be run at birth or at the time of the mother&#39;s infection without the need for</span>
<span class="sd">        further polling etc.)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>

        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">mother_id</span><span class="p">,</span> <span class="s2">&quot;hv_art&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;on_VL_suppressed&quot;</span><span class="p">:</span>
            <span class="n">monthly_prob_mtct_bf</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;monthly_prob_mtct_bf_treated&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">monthly_prob_mtct_bf</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;monthly_prob_mtct_bf_untreated&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">monthly_prob_mtct_bf</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">months_to_infection</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">monthly_prob_mtct_bf</span><span class="p">))</span>
            <span class="n">date_of_infection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="n">months_to_infection</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
                <span class="n">HivInfectionDuringBreastFeedingEvent</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">child_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="p">),</span>
                <span class="n">date_of_infection</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="Hiv.do_new_infection"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.do_new_infection">[docs]</a>    <span class="k">def</span> <span class="nf">do_new_infection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enact that this person is infected with HIV</span>
<span class="sd">        * Update their hv_inf status and hv_date_inf</span>
<span class="sd">        * Schedule the AIDS onset event for this person</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="c1"># Update HIV infection status for this person</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_inf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_date_inf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>

        <span class="c1"># Schedule AIDS onset events for this person</span>
        <span class="n">date_onset_aids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time_from_infection_to_aids</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">HivAidsOnsetEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">),</span> <span class="n">date</span><span class="o">=</span><span class="n">date_onset_aids</span><span class="p">)</span></div>

<div class="viewcode-block" id="Hiv.get_time_from_infection_to_aids"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.get_time_from_infection_to_aids">[docs]</a>    <span class="k">def</span> <span class="nf">get_time_from_infection_to_aids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gives time between onset of infection and AIDS, returning a pd.DateOffset.</span>
<span class="sd">        For those infected prior to, or at, birth: (this is a draw from an exponential distribution)</span>
<span class="sd">        For those infected after birth but before reaching age 5.0 (this is drawn from a weibull distribution)</span>
<span class="sd">        For adults: (this is a drawn from a weibull distribution (with scale depending on age);</span>
<span class="sd">        * NB. It is further assumed that the time from aids to death is 18 months.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">age</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s1">&#39;age_exact_years&#39;</span><span class="p">]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>

        <span class="k">if</span> <span class="n">age</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="c1"># The person is infected prior to, or at, birth:</span>
            <span class="n">months_to_death</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;mean_survival_for_infants_infected_prior_to_birth&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">12</span><span class="p">))</span>
            <span class="n">months_to_aids</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">months_to_death</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;mean_months_between_aids_and_death_infant&#39;</span><span class="p">])))</span>
        <span class="k">elif</span> <span class="n">age</span> <span class="o">&lt;</span> <span class="mf">5.0</span><span class="p">:</span>
            <span class="c1"># The person is infected after birth but before age 5.0:</span>
            <span class="n">months_to_death</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">weibull</span><span class="p">(</span>
                    <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_infant_infection_after_birth_weibull_shape&quot;</span><span class="p">])</span> <span class="o">*</span>
                    <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_infant_infection_after_birth_weibull_scale&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">12</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">months_to_aids</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">months_to_death</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;mean_months_between_aids_and_death_infant&#39;</span><span class="p">])))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># The person is infected after age 5.0</span>
            <span class="c1"># - get the shape parameters (unit: years)</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s1">&#39;scale_parameter_for_infection_to_death&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">person_id</span><span class="p">]])</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># - get the scale parameter (unit: years)</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s1">&#39;shape_parameter_for_infection_to_death&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">person_id</span><span class="p">]])</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># - draw from Weibull and convert to months</span>
            <span class="n">months_to_death</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">weibull</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span> <span class="o">*</span> <span class="mi">12</span>
            <span class="c1"># - compute months to aids, which is somewhat shorter than the months to death</span>
            <span class="n">months_to_aids</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">months_to_death</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;mean_months_between_aids_and_death&#39;</span><span class="p">])))</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="n">months_to_aids</span><span class="p">)</span></div>

<div class="viewcode-block" id="Hiv.get_time_from_aids_to_death"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.get_time_from_aids_to_death">[docs]</a>    <span class="k">def</span> <span class="nf">get_time_from_aids_to_death</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gives time between onset of AIDS and death, returning a pd.DateOffset.</span>
<span class="sd">        Assumes that the time between onset of AIDS symptoms and deaths is exponentially distributed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;mean_months_between_aids_and_death&#39;</span><span class="p">]</span>
        <span class="n">draw_number_of_months</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="n">mean</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="n">draw_number_of_months</span><span class="p">)</span></div>

<div class="viewcode-block" id="Hiv.do_when_hiv_diagnosed"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.do_when_hiv_diagnosed">[docs]</a>    <span class="k">def</span> <span class="nf">do_when_hiv_diagnosed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Things to do when a person has been tested and found (newly) be be HIV-positive:.</span>
<span class="sd">        * Consier if ART should be initiated, and schedule HSI if so.</span>
<span class="sd">        The person should not yet be on ART.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s1">&#39;hv_art&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;not&#39;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;This event should not be running. do_when_diagnosed is for persons being newly dianogsed.&quot;</span><span class="p">)</span>

        <span class="c1"># Consider if the person will be referred to start ART</span>
        <span class="n">has_aids_symptoms</span> <span class="o">=</span> <span class="s1">&#39;aids_symptoms&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;SymptomManager&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">has_what</span><span class="p">(</span><span class="n">person_id</span><span class="p">)</span>

        <span class="n">starts_art</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s1">&#39;lm_art&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">person_id</span><span class="p">]],</span>
            <span class="n">rng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">,</span>
            <span class="n">has_aids_symptoms</span><span class="o">=</span><span class="n">has_aids_symptoms</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">starts_art</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">HSI_Hiv_StartOrContinueTreatment</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="p">),</span>
                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="Hiv.stops_treatment"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.stops_treatment">[docs]</a>    <span class="k">def</span> <span class="nf">stops_treatment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper function that is called when someone stops being on ART.</span>
<span class="sd">        Sets the flag for ART status. If the person was already on ART, it schedules a new AIDSEvent&quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="c1"># Schedule a new AIDS onset event if the person was on ART up until now</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_art&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;not&quot;</span><span class="p">:</span>
            <span class="n">months_to_aids</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;art_default_to_aids_mean_years&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="mf">12.0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">HivAidsOnsetEvent</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="p">),</span>
                                    <span class="n">date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="n">months_to_aids</span><span class="p">)</span>
                                    <span class="p">)</span>

        <span class="c1"># Set that the person is no longer on ART</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_art&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;not&quot;</span></div>

<div class="viewcode-block" id="Hiv.per_capita_testing_rate"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.per_capita_testing_rate">[docs]</a>    <span class="k">def</span> <span class="nf">per_capita_testing_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; this calculates the numbers of hiv tests performed in each time period</span>
<span class="sd">        it looks at the cumulative number of tests ever performed and subtracts the</span>
<span class="sd">        number calculated at the last time point</span>
<span class="sd">        values are converted to per capita testing rates</span>
<span class="sd">        this function is called by the logger and can be called at any frequency</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="c1"># get number of tests performed in last time period</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="mi">2010</span><span class="p">:</span>
            <span class="n">number_tests_new</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_number_tests</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">previous_test_numbers</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">previous_test_numbers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stored_test_numbers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># calculate number of tests now performed - cumulative, include those who have died</span>
            <span class="n">number_tests_new</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_number_tests</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stored_test_numbers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">number_tests_new</span><span class="p">)</span>

        <span class="c1"># number of tests performed in last time period</span>
        <span class="n">number_tests_in_last_period</span> <span class="o">=</span> <span class="n">number_tests_new</span> <span class="o">-</span> <span class="n">previous_test_numbers</span>

        <span class="c1"># per-capita testing rate</span>
        <span class="n">per_capita_testing</span> <span class="o">=</span> <span class="n">number_tests_in_last_period</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">])</span>

        <span class="c1"># return updated value for time-period</span>
        <span class="k">return</span> <span class="n">per_capita_testing</span></div>

<div class="viewcode-block" id="Hiv.check_config_of_properties"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.check_config_of_properties">[docs]</a>    <span class="k">def</span> <span class="nf">check_config_of_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;check that the properties are currently configured correctly&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">df_alive</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">]</span>

        <span class="c1"># basic check types of columns and dtypes</span>
        <span class="n">orig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">new_row</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dtypes</span> <span class="o">==</span> <span class="n">orig</span><span class="o">.</span><span class="n">dtypes</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">is_subset</span><span class="p">(</span><span class="n">col_for_set</span><span class="p">,</span> <span class="n">col_for_subset</span><span class="p">):</span>
            <span class="c1"># Confirms that the series of col_for_subset is true only for a subset of the series for col_for_set</span>
            <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">col_for_subset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">col_for_subset</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">col_for_set</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">col_for_set</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="c1"># Check that core properties of current status are never None/NaN/NaT</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">df_alive</span><span class="o">.</span><span class="n">hv_inf</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">df_alive</span><span class="o">.</span><span class="n">hv_art</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">df_alive</span><span class="o">.</span><span class="n">hv_behaviour_change</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">df_alive</span><span class="o">.</span><span class="n">hv_diagnosed</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">df_alive</span><span class="o">.</span><span class="n">hv_number_tests</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>

        <span class="c1"># Check that the core HIV properties are &#39;nested&#39; in the way expected.</span>
        <span class="k">assert</span> <span class="n">is_subset</span><span class="p">(</span><span class="n">col_for_set</span><span class="o">=</span><span class="n">df_alive</span><span class="o">.</span><span class="n">hv_inf</span><span class="p">,</span> <span class="n">col_for_subset</span><span class="o">=</span><span class="n">df_alive</span><span class="o">.</span><span class="n">hv_diagnosed</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">is_subset</span><span class="p">(</span><span class="n">col_for_set</span><span class="o">=</span><span class="n">df_alive</span><span class="o">.</span><span class="n">hv_diagnosed</span><span class="p">,</span> <span class="n">col_for_subset</span><span class="o">=</span><span class="p">(</span><span class="n">df_alive</span><span class="o">.</span><span class="n">hv_art</span> <span class="o">!=</span> <span class="s2">&quot;not&quot;</span><span class="p">))</span>

        <span class="c1"># Check that if person is not infected, the dates of HIV events are None/NaN/NaT</span>
        <span class="k">assert</span> <span class="n">df_alive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">df_alive</span><span class="o">.</span><span class="n">hv_inf</span><span class="p">,</span> <span class="s2">&quot;hv_date_inf&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="c1"># Check that dates consistent for those infected with HIV</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">df_alive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_alive</span><span class="o">.</span><span class="n">hv_inf</span><span class="p">]</span><span class="o">.</span><span class="n">hv_date_inf</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">df_alive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_alive</span><span class="o">.</span><span class="n">hv_inf</span><span class="p">]</span><span class="o">.</span><span class="n">hv_date_inf</span> <span class="o">&gt;=</span> <span class="n">df_alive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_alive</span><span class="o">.</span><span class="n">hv_inf</span><span class="p">]</span><span class="o">.</span><span class="n">date_of_birth</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="c1"># Check alignment between AIDS Symptoms and status and infection and ART status</span>
        <span class="n">has_aids_symptoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;SymptomManager&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">who_has</span><span class="p">(</span><span class="s1">&#39;aids_symptoms&#39;</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">has_aids_symptoms</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">df_alive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_alive</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df_alive</span><span class="o">.</span><span class="n">hv_inf</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">has_aids_symptoms</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">df_alive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_alive</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">df_alive</span><span class="o">.</span><span class="n">hv_art</span> <span class="o">==</span> <span class="s2">&quot;on_VL_suppressed&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">))</span></div></div>

<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1">#   Main Polling Event</span>
<span class="c1"># ---------------------------------------------------------------------------</span>


<div class="viewcode-block" id="HivRegularPollingEvent"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivRegularPollingEvent">[docs]</a><span class="k">class</span> <span class="nc">HivRegularPollingEvent</span><span class="p">(</span><span class="n">RegularEvent</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; The HIV Regular Polling Events</span>
<span class="sd">    * Schedules persons becoming newly infected through horizontal transmission</span>
<span class="sd">    * Schedules who will present for voluntary (&quot;spontaneous&quot;) testing</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="HivRegularPollingEvent.__init__"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivRegularPollingEvent.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">12</span><span class="p">))</span>  <span class="c1"># repeats every 12 months, but this can be changed</span></div>

<div class="viewcode-block" id="HivRegularPollingEvent.apply"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivRegularPollingEvent.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span>

        <span class="n">fraction_of_year_between_polls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="o">.</span><span class="n">months</span> <span class="o">/</span> <span class="mi">12</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">fraction_of_year_between_polls</span>

        <span class="c1"># ----------------------------------- HORIZONTAL TRANSMISSION -----------------------------------</span>
        <span class="k">def</span> <span class="nf">horizontal_transmission</span><span class="p">(</span><span class="n">to_sex</span><span class="p">,</span> <span class="n">from_sex</span><span class="p">):</span>
            <span class="c1"># Count current number of alive 15-80 year-olds at risk of transmission</span>
            <span class="c1"># (= those infected and not VL suppressed):</span>
            <span class="n">n_infectious</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                                   <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span>
                                   <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span> <span class="o">&amp;</span>
                                   <span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span> <span class="o">&amp;</span>
                                   <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_art</span> <span class="o">!=</span> <span class="s2">&quot;on_VL_suppressed&quot;</span><span class="p">)</span> <span class="o">&amp;</span>
                                   <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="n">from_sex</span><span class="p">)</span>
                                   <span class="p">])</span>

            <span class="c1"># Get Susceptible (non-infected alive 15-80 year-old) persons:</span>
            <span class="n">susc_idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="n">to_sex</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span>
            <span class="n">n_susceptible</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">susc_idx</span><span class="p">)</span>

            <span class="c1"># Compute chance that each susceptible person becomes infected:</span>
            <span class="c1">#  - relative chance of infection (acts like a scaling-factor on &#39;beta&#39;)</span>
            <span class="n">rr_of_infection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s1">&#39;rr_of_infection&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">susc_idx</span><span class="p">])</span>

            <span class="c1">#  - probability of infection = beta * I/N</span>
            <span class="n">p_infection</span> <span class="o">=</span> <span class="n">rr_of_infection</span> <span class="o">*</span> <span class="n">beta</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_infectious</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_infectious</span> <span class="o">+</span> <span class="n">n_susceptible</span><span class="p">))</span>

            <span class="c1"># New infections:</span>
            <span class="n">will_be_infected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p_infection</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">p_infection</span>
            <span class="n">idx_new_infection</span> <span class="o">=</span> <span class="n">will_be_infected</span><span class="p">[</span><span class="n">will_be_infected</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>

            <span class="c1"># Schedule the date of infection for each new infection:</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idx_new_infection</span><span class="p">:</span>
                <span class="n">date_of_infection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> \
                                    <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">365</span> <span class="o">*</span> <span class="n">fraction_of_year_between_polls</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">HivInfectionEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span> <span class="n">date_of_infection</span><span class="p">)</span>

        <span class="c1"># Horizontal transmission: Male --&gt; Female</span>
        <span class="n">horizontal_transmission</span><span class="p">(</span><span class="n">from_sex</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">to_sex</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>

        <span class="c1"># Horizontal transmission: Female --&gt; Male</span>
        <span class="n">horizontal_transmission</span><span class="p">(</span><span class="n">from_sex</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="n">to_sex</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">)</span>

        <span class="c1"># ----------------------------------- SPONTANEOUS TESTING -----------------------------------</span>
        <span class="n">prob_spontaneous_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s1">&#39;lm_spontaneous_test_12m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">])</span> <span class="o">*</span> <span class="n">fraction_of_year_between_polls</span>
        <span class="n">will_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prob_spontaneous_test</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">prob_spontaneous_test</span>
        <span class="n">idx_will_test</span> <span class="o">=</span> <span class="n">will_test</span><span class="p">[</span><span class="n">will_test</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="k">for</span> <span class="n">person_id</span> <span class="ow">in</span> <span class="n">idx_will_test</span><span class="p">:</span>
            <span class="n">date_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> \
                        <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">365</span> <span class="o">*</span> <span class="n">fraction_of_year_between_polls</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">hsi_event</span><span class="o">=</span><span class="n">HSI_Hiv_TestAndRefer</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">),</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">topen</span><span class="o">=</span><span class="n">date_test</span><span class="p">,</span>
                <span class="n">tclose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="o">.</span><span class="n">months</span><span class="p">)</span>  <span class="c1"># (to occur before next polling)</span>
            <span class="p">)</span></div></div>


<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1">#   Natural History Events</span>
<span class="c1"># ---------------------------------------------------------------------------</span>

<div class="viewcode-block" id="HivInfectionEvent"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivInfectionEvent">[docs]</a><span class="k">class</span> <span class="nc">HivInfectionEvent</span><span class="p">(</span><span class="n">Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This person will become infected.</span>
<span class="sd">    * Do the infection process</span>
<span class="sd">    * Check for onward transmission through MTCT if the infection is to a mother who is currently breastfeeding.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="HivInfectionEvent.__init__"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivInfectionEvent.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="HivInfectionEvent.apply"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivInfectionEvent.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="c1"># Check person is_alive</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s1">&#39;is_alive&#39;</span><span class="p">]:</span>
            <span class="k">return</span>

        <span class="c1"># Onset the infection for this person (which will schedule progression etc)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">do_new_infection</span><span class="p">(</span><span class="n">person_id</span><span class="p">)</span>

        <span class="c1"># Consider mother-to-child-transmission (MTCT) from this person to their children:</span>
        <span class="n">children_of_this_person_being_breastfed</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">mother_id</span> <span class="o">==</span> <span class="n">person_id</span><span class="p">)</span> <span class="o">&amp;</span>
                                                         <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">nb_breastfeeding_status</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span>
        <span class="c1"># - Do the MTCT routine for each child:</span>
        <span class="k">for</span> <span class="n">child_id</span> <span class="ow">in</span> <span class="n">children_of_this_person_being_breastfed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">mtct_during_breastfeeding</span><span class="p">(</span><span class="n">person_id</span><span class="p">,</span> <span class="n">child_id</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="HivInfectionDuringBreastFeedingEvent"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivInfectionDuringBreastFeedingEvent">[docs]</a><span class="k">class</span> <span class="nc">HivInfectionDuringBreastFeedingEvent</span><span class="p">(</span><span class="n">Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This person will become infected during breastfeeding</span>
<span class="sd">    * Do the infection process</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="HivInfectionDuringBreastFeedingEvent.__init__"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivInfectionDuringBreastFeedingEvent.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="HivInfectionDuringBreastFeedingEvent.apply"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivInfectionDuringBreastFeedingEvent.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="c1"># Check person is_alive</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s1">&#39;is_alive&#39;</span><span class="p">]:</span>
            <span class="k">return</span>

        <span class="c1"># Check person is breastfed currently</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;nb_breastfeeding_status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Onset the infection for this person (which will schedule progression etc)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">do_new_infection</span><span class="p">(</span><span class="n">person_id</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="HivAidsOnsetEvent"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivAidsOnsetEvent">[docs]</a><span class="k">class</span> <span class="nc">HivAidsOnsetEvent</span><span class="p">(</span><span class="n">Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This person has developed AIDS.</span>
<span class="sd">    * Update their symptomatic status</span>
<span class="sd">    * Record the date at which AIDS onset</span>
<span class="sd">    * Schedule the AIDS death</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="HivAidsOnsetEvent.__init__"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivAidsOnsetEvent.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="HivAidsOnsetEvent.apply"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivAidsOnsetEvent.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="c1"># Check person is_alive</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s1">&#39;is_alive&#39;</span><span class="p">]:</span>
            <span class="k">return</span>

        <span class="c1"># Do nothing if person is now on ART and VL suppressed (non-VL suppressed has no effect)</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_art&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;on_VL_suppressed&quot;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Update Symptoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;SymptomManager&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">change_symptom</span><span class="p">(</span>
            <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span>
            <span class="n">symptom_string</span><span class="o">=</span><span class="s2">&quot;aids_symptoms&quot;</span><span class="p">,</span>
            <span class="n">add_or_remove</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
            <span class="n">disease_module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Schedule AidsDeath</span>
        <span class="n">date_of_aids_death</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">get_time_from_aids_to_death</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">HivAidsDeathEvent</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">),</span>
                                <span class="n">date</span><span class="o">=</span><span class="n">date_of_aids_death</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="HivAidsDeathEvent"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivAidsDeathEvent">[docs]</a><span class="k">class</span> <span class="nc">HivAidsDeathEvent</span><span class="p">(</span><span class="n">Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Causes someone to die of AIDS, if they are not VL suppressed on ART.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="HivAidsDeathEvent.__init__"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivAidsDeathEvent.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="HivAidsDeathEvent.apply"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivAidsDeathEvent.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="c1"># Check person is_alive</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s1">&#39;is_alive&#39;</span><span class="p">]:</span>
            <span class="k">return</span>

        <span class="c1"># Do nothing if person is now on ART and VL suppressed (non VL suppressed has no effect)</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_art&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;on_VL_suppressed&quot;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Cause the death to happen immediately</span>
        <span class="n">demography</span><span class="o">.</span><span class="n">InstantaneousDeath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">individual_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">cause</span><span class="o">=</span><span class="s2">&quot;AIDS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">person_id</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Hiv_DecisionToContinueOnPrEP"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv_DecisionToContinueOnPrEP">[docs]</a><span class="k">class</span> <span class="nc">Hiv_DecisionToContinueOnPrEP</span><span class="p">(</span><span class="n">Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper event that is used to &#39;decide&#39; if someone on PrEP should continue on PrEP.</span>
<span class="sd">    This event is scheduled by &#39;HSI_Hiv_StartOrContinueOnPrep&#39; 3 months after it is run.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Hiv_DecisionToContinueOnPrEP.__init__"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv_DecisionToContinueOnPrEP.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="Hiv_DecisionToContinueOnPrEP.apply"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv_DecisionToContinueOnPrEP.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">person</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span>

        <span class="c1"># If the person is no longer alive, and sex worker and not diagnosed, they will not continue on PrEP</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;is_alive&quot;</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;li_is_sexworker&quot;</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="n">person</span><span class="p">[</span><span class="s2">&quot;hv_diagnosed&quot;</span><span class="p">]):</span>
            <span class="k">return</span>

        <span class="c1"># Check that there are on PrEP currently:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;hv_is_on_prep&quot;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;This event should not be running&#39;</span><span class="p">)</span>

        <span class="c1"># Determine if this appointment is actually attended by the person who has already started on PrEP</span>
        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">m</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;probability_of_being_retained_on_prep_every_3_months&#39;</span><span class="p">]:</span>
            <span class="c1"># Continue on PrEP - and schedule an HSI for a refill appointment today</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">HSI_Hiv_StartOrContinueOnPrep</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="n">m</span><span class="p">),</span>
                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                <span class="n">tclose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">),</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Defaults to being off PrEP - reset flag and take no further action</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_is_on_prep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="Hiv_DecisionToContinueTreatment"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv_DecisionToContinueTreatment">[docs]</a><span class="k">class</span> <span class="nc">Hiv_DecisionToContinueTreatment</span><span class="p">(</span><span class="n">Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper event that is used to &#39;decide&#39; if someone on Treatment should continue on Treatment.</span>
<span class="sd">    This event is scheduled by &#39;HSI_Hiv_StartOrContinueTreatment&#39; 6 months after it is run.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Hiv_DecisionToContinueTreatment.__init__"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv_DecisionToContinueTreatment.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="Hiv_DecisionToContinueTreatment.apply"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv_DecisionToContinueTreatment.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">person</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;is_alive&quot;</span><span class="p">]:</span>
            <span class="k">return</span>

        <span class="c1"># Check that there are on Treatment currently:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">person</span><span class="p">[</span><span class="s2">&quot;hv_art&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;on_VL_suppressed&quot;</span><span class="p">,</span> <span class="s2">&quot;on_not_VL_suppressed&quot;</span><span class="p">]):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;This event should not be running&#39;</span><span class="p">)</span>

        <span class="c1"># Determine if this appointment is actually attended by the person who has already started on PrEP</span>
        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">m</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;probability_of_being_retained_on_art_every_6_months&#39;</span><span class="p">]:</span>
            <span class="c1"># Continue on Treatment - and schedule an HSI for a continuation appointment today</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">HSI_Hiv_StartOrContinueTreatment</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="n">m</span><span class="p">),</span>
                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                <span class="n">tclose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">14</span><span class="p">),</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Defaults to being off Treatment</span>
            <span class="n">m</span><span class="o">.</span><span class="n">stops_treatment</span><span class="p">(</span><span class="n">person_id</span><span class="p">)</span></div></div>


<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1">#   Health System Interactions (HSI)</span>
<span class="c1"># ---------------------------------------------------------------------------</span>

<div class="viewcode-block" id="HSI_Hiv_TestAndRefer"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_TestAndRefer">[docs]</a><span class="k">class</span> <span class="nc">HSI_Hiv_TestAndRefer</span><span class="p">(</span><span class="n">HSI_Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The is the Test-and-Refer HSI. Individuals may seek an HIV test at any time. From this, they can be referred on to</span>
<span class="sd">    other services.</span>
<span class="sd">    This event is scheduled by:</span>
<span class="sd">        * the main event poll,</span>
<span class="sd">        * when someone presents for any care through a Generic HSI.</span>
<span class="sd">        * when an infant is born to an HIV-positive mother</span>
<span class="sd">    Following the test, they may or may not go on to present for uptake an HIV service: ART (if HIV-positive), VMMC (if</span>
<span class="sd">    HIV-negative and male) or PrEP (if HIV-negative and a female sex worker).</span>
<span class="sd">    If this event is called within another HSI, it may be desirable to limit the functionality of the HSI: do this</span>
<span class="sd">    using the arguments:</span>
<span class="sd">        * do_not_refer_if_neg=False : if the person is HIV-neg they will not be referred to VMMC or PrEP</span>
<span class="sd">        * suppress_footprint=True : the HSI will not have any footprint</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="HSI_Hiv_TestAndRefer.__init__"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_TestAndRefer.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">do_not_refer_if_neg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">suppress_footprint</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">module</span><span class="p">,</span> <span class="n">Hiv</span>
        <span class="p">)</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">do_not_refer_if_neg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_not_refer_if_neg</span> <span class="o">=</span> <span class="n">do_not_refer_if_neg</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">suppress_footprint</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suppress_footprint</span> <span class="o">=</span> <span class="n">suppress_footprint</span>

        <span class="c1"># Define the necessary information for an HSI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TREATMENT_ID</span> <span class="o">=</span> <span class="s2">&quot;Hiv_TestAndRefer&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s1">&#39;VCTNegative&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ALERT_OTHER_DISEASES</span> <span class="o">=</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="HSI_Hiv_TestAndRefer.apply"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_TestAndRefer.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">squeeze_factor</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Do the testing and referring to other services&quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">person</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">person</span><span class="p">[</span><span class="s1">&#39;is_alive&#39;</span><span class="p">]:</span>
            <span class="k">return</span>

        <span class="c1"># If the person has previously been diagnosed do nothing do not occupy any resources</span>
        <span class="k">if</span> <span class="n">person</span><span class="p">[</span><span class="s1">&#39;hv_diagnosed&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_blank_appt_footprint</span><span class="p">()</span>

        <span class="c1"># Run test</span>
        <span class="k">if</span> <span class="n">person</span><span class="p">[</span><span class="s1">&#39;age_years&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">test_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">run_dx_test</span><span class="p">(</span>
                <span class="n">dx_tests_to_run</span><span class="o">=</span><span class="s1">&#39;hiv_early_infant_test&#39;</span><span class="p">,</span>
                <span class="n">hsi_event</span><span class="o">=</span><span class="bp">self</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">test_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">run_dx_test</span><span class="p">(</span>
                <span class="n">dx_tests_to_run</span><span class="o">=</span><span class="s1">&#39;hiv_rapid_test&#39;</span><span class="p">,</span>
                <span class="n">hsi_event</span><span class="o">=</span><span class="bp">self</span>
            <span class="p">)</span>

        <span class="c1"># Update number of tests:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s1">&#39;hv_number_tests&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s1">&#39;hv_last_test_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>

        <span class="k">if</span> <span class="n">test_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Offer services as needed:</span>
            <span class="k">if</span> <span class="n">test_result</span><span class="p">:</span>
                <span class="c1"># The test_result is HIV positive</span>
                <span class="n">ACTUAL_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s1">&#39;VCTPositive&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>

                <span class="c1"># Update diagnosis if the person is indeed HIV positive;</span>
                <span class="k">if</span> <span class="n">person</span><span class="p">[</span><span class="s1">&#39;hv_inf&#39;</span><span class="p">]:</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s1">&#39;hv_diagnosed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">do_when_hiv_diagnosed</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># The test_result is HIV negative</span>
                <span class="n">ACTUAL_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s1">&#39;VCTNegative&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_not_refer_if_neg</span><span class="p">:</span>
                    <span class="c1"># The test was negative: make referrals to other services:</span>

                    <span class="c1"># Consider if the person&#39;s risk will be reduced by behaviour change counselling</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s1">&#39;lm_behavchg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">person_id</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="p">):</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s1">&#39;hv_behaviour_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="c1"># If person is a man, and not circumcised, then consider referring to VMMC</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">person</span><span class="p">[</span><span class="s1">&#39;sex&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;M&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">person</span><span class="p">[</span><span class="s1">&#39;li_is_circ&#39;</span><span class="p">]):</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s1">&#39;lm_circ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">person_id</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">x</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                                <span class="n">HSI_Hiv_Circ</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">),</span>
                                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                                <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span>
                            <span class="p">)</span>

                    <span class="c1"># If person is a woman and FSW, and not currently on PrEP then consider referring to PrEP</span>
                    <span class="c1"># available 2018 onwards</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">person</span><span class="p">[</span><span class="s1">&#39;sex&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;F&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
                        <span class="n">person</span><span class="p">[</span><span class="s1">&#39;li_is_sexworker&#39;</span><span class="p">]</span> <span class="o">&amp;</span>
                        <span class="o">~</span><span class="n">person</span><span class="p">[</span><span class="s1">&#39;hv_is_on_prep&#39;</span><span class="p">]</span> <span class="o">&amp;</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;prep_start_year&#39;</span><span class="p">])</span>
                    <span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s1">&#39;lm_prep&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">person_id</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                                <span class="n">HSI_Hiv_StartOrContinueOnPrep</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">),</span>
                                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                                <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span>
                            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Test was not possible, so do nothing:</span>
            <span class="n">ACTUAL_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s1">&#39;VCTNegative&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>

        <span class="c1"># Return the footprint. If it should be suppressed, return a blank footprint.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suppress_footprint</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ACTUAL_APPT_FOOTPRINT</span></div></div>


<div class="viewcode-block" id="HSI_Hiv_Circ"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_Circ">[docs]</a><span class="k">class</span> <span class="nc">HSI_Hiv_Circ</span><span class="p">(</span><span class="n">HSI_Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<div class="viewcode-block" id="HSI_Hiv_Circ.__init__"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_Circ.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">TREATMENT_ID</span> <span class="o">=</span> <span class="s2">&quot;Hiv_Circumcision&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s2">&quot;MinorSurg&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ALERT_OTHER_DISEASES</span> <span class="o">=</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="HSI_Hiv_Circ.apply"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_Circ.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">squeeze_factor</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Do the circumcision for this man&quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>  <span class="c1"># shortcut to the dataframe</span>

        <span class="n">person</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span>

        <span class="c1"># Do not run if the person is not alive or is already circumcised</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">person</span><span class="p">[</span><span class="s2">&quot;is_alive&quot;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">person</span><span class="p">[</span><span class="s2">&quot;li_is_circ&quot;</span><span class="p">]):</span>
            <span class="k">return</span>

        <span class="c1"># Check/log use of consumables, and do circumcision if materials available</span>
        <span class="c1"># NB. If materials not available, it is assumed that the procedure is not carried out for this person following</span>
        <span class="c1"># this particular referral.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_consumables</span><span class="p">(</span><span class="n">footprint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">footprints_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;circ&#39;</span><span class="p">]):</span>
            <span class="c1"># Update circumcision state</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;li_is_circ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div></div>


<div class="viewcode-block" id="HSI_Hiv_StartOrContinueOnPrep"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_StartOrContinueOnPrep">[docs]</a><span class="k">class</span> <span class="nc">HSI_Hiv_StartOrContinueOnPrep</span><span class="p">(</span><span class="n">HSI_Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<div class="viewcode-block" id="HSI_Hiv_StartOrContinueOnPrep.__init__"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_StartOrContinueOnPrep.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">Hiv</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">TREATMENT_ID</span> <span class="o">=</span> <span class="s2">&quot;Hiv_StartOrContinueOnPrep&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s2">&quot;Over5OPD&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ALERT_OTHER_DISEASES</span> <span class="o">=</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="HSI_Hiv_StartOrContinueOnPrep.apply"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_StartOrContinueOnPrep.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">squeeze_factor</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start PrEP for this person; or continue them on PrEP for 3 more months&quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">person</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span>

        <span class="c1"># Do not run if the person is not alive, or is not currently a sex worker, or is diagnosed</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;is_alive&quot;</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;li_is_sexworker&quot;</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="n">person</span><span class="p">[</span><span class="s2">&quot;hv_diagnosed&quot;</span><span class="p">]):</span>
            <span class="k">return</span>

        <span class="c1"># Run an HIV test</span>
        <span class="n">test_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">run_dx_test</span><span class="p">(</span>
            <span class="n">dx_tests_to_run</span><span class="o">=</span><span class="s1">&#39;hiv_rapid_test&#39;</span><span class="p">,</span>
            <span class="n">hsi_event</span><span class="o">=</span><span class="bp">self</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s1">&#39;hv_number_tests&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s1">&#39;hv_last_test_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>

        <span class="c1"># If test is positive, flag as diagnosed and refer to ART</span>
        <span class="k">if</span> <span class="n">test_result</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># label as diagnosed</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s1">&#39;hv_diagnosed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Do actions for when a person has been diagnosed with HIV</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">do_when_hiv_diagnosed</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s2">&quot;Over5OPD&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;VCTPositive&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>

        <span class="c1"># Check that PrEP is available and if it is, initiate or continue  PrEP:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_consumables</span><span class="p">(</span><span class="n">footprint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">footprints_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;prep&#39;</span><span class="p">]):</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_is_on_prep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Schedule &#39;decision about whether to continue on PrEP&#39; for 3 months time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
                <span class="n">Hiv_DecisionToContinueOnPrEP</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If PrEP is not available, the person will default and not be on PrEP</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_is_on_prep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="HSI_Hiv_StartOrContinueOnPrep.never_ran"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_StartOrContinueOnPrep.never_ran">[docs]</a>    <span class="k">def</span> <span class="nf">never_ran</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This is called if this HSI was never run.</span>
<span class="sd">        Default the person to being off PrEP&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="s2">&quot;hv_is_on_prep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="HSI_Hiv_StartOrContinueTreatment"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_StartOrContinueTreatment">[docs]</a><span class="k">class</span> <span class="nc">HSI_Hiv_StartOrContinueTreatment</span><span class="p">(</span><span class="n">HSI_Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<div class="viewcode-block" id="HSI_Hiv_StartOrContinueTreatment.__init__"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_StartOrContinueTreatment.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">Hiv</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">TREATMENT_ID</span> <span class="o">=</span> <span class="s2">&quot;Hiv_Treatment_InitiationOrContinuation&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s2">&quot;Over5OPD&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;NewAdult&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ALERT_OTHER_DISEASES</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">counter_for_did_not_run</span> <span class="o">=</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="HSI_Hiv_StartOrContinueTreatment.apply"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_StartOrContinueTreatment.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">squeeze_factor</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This is a Health System Interaction Event - start or continue HIV treatment for 6 more months&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">person</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span>
        <span class="n">art_status_at_beginning_of_hsi</span> <span class="o">=</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;hv_art&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;is_alive&quot;</span><span class="p">]:</span>
            <span class="k">return</span>

        <span class="c1"># Confirm that the person is diagnosed (this should not run if they are not)</span>
        <span class="k">assert</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;hv_diagnosed&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">art_status_at_beginning_of_hsi</span> <span class="o">==</span> <span class="s2">&quot;not&quot;</span><span class="p">:</span>
            <span class="c1"># Do a confirmatory test and do not run the rest of the event if negative.</span>
            <span class="c1"># NB. It is assumed that the sensitivity and specificiy of the raoid test is perfect.</span>
            <span class="n">test_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">run_dx_test</span><span class="p">(</span>
                <span class="n">dx_tests_to_run</span><span class="o">=</span><span class="s1">&#39;hiv_rapid_test&#39;</span><span class="p">,</span>
                <span class="n">hsi_event</span><span class="o">=</span><span class="bp">self</span>
            <span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s1">&#39;hv_number_tests&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s1">&#39;hv_last_test_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">test_result</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s2">&quot;Over5OPD&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>

            <span class="k">assert</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;hv_inf&quot;</span><span class="p">]</span>  <span class="c1"># after the test results, it can be guaranteed that the person is HIV-pos.</span>

            <span class="c1"># Try to initiate the person onto ART:</span>
            <span class="n">drugs_were_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_at_initiation</span><span class="p">(</span><span class="n">person_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Try to continue the person on ART:</span>
            <span class="n">drugs_were_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_at_continuation</span><span class="p">(</span><span class="n">person_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">drugs_were_available</span><span class="p">:</span>
            <span class="c1"># If person has been placed/continued on ART, schedule &#39;decision about whether to continue on Treatment for</span>
            <span class="c1"># 6 months later</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
                <span class="n">Hiv_DecisionToContinueTreatment</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># As drugs were not available, the person will default to being off ART (...if they were on ART at the</span>
            <span class="c1"># beginning of the HSI.)</span>
            <span class="c1"># NB. If the person was not on ART at the beginning of the HSI, then there is no need to stop them (which</span>
            <span class="c1">#  causes a new AIDSOnsetEvent to be scheduled.)</span>
            <span class="k">if</span> <span class="n">art_status_at_beginning_of_hsi</span> <span class="o">!=</span> <span class="s2">&quot;not&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">stops_treatment</span><span class="p">(</span><span class="n">person_id</span><span class="p">)</span>

            <span class="c1"># If person &#39;decides to&#39; seek another appointment, schedule a new HSI appointment for tomorrow.</span>
            <span class="c1"># NB. With a probability of 1.0, this will keep occurring, and the person will never give-up coming back to</span>
            <span class="c1"># pick-up medication.</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">&lt;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;probability_of_seeking_further_art_appointment_if_drug_not_available&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                    <span class="n">hsi_event</span><span class="o">=</span><span class="n">HSI_Hiv_StartOrContinueTreatment</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">),</span>
                    <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                    <span class="n">tclose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">15</span><span class="p">),</span>
                    <span class="n">priority</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)</span></div>

<div class="viewcode-block" id="HSI_Hiv_StartOrContinueTreatment.do_at_initiation"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_StartOrContinueTreatment.do_at_initiation">[docs]</a>    <span class="k">def</span> <span class="nf">do_at_initiation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Things to do when this the first appointment ART&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">person</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span>

        <span class="c1"># Check if drugs are available, and provide drugs:</span>
        <span class="n">drugs_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_drugs</span><span class="p">(</span><span class="n">age_of_person</span><span class="o">=</span><span class="n">person</span><span class="p">[</span><span class="s1">&#39;age_years&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">drugs_available</span><span class="p">:</span>
            <span class="c1"># Assign person to be have suppressed or un-suppressed viral load</span>
            <span class="c1"># (If person is VL suppressed This will prevent the Onset of AIDS, or an AIDS death if AIDS has already</span>
            <span class="c1"># onset,)</span>
            <span class="n">vl_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_vl_status</span><span class="p">(</span><span class="n">sex_of_person</span><span class="o">=</span><span class="n">person</span><span class="p">[</span><span class="s2">&quot;sex&quot;</span><span class="p">],</span> <span class="n">age_of_person</span><span class="o">=</span><span class="n">person</span><span class="p">[</span><span class="s2">&quot;age_years&quot;</span><span class="p">])</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_art&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vl_status</span>

            <span class="c1"># If VL suppressed, remove any symptoms caused by this module</span>
            <span class="k">if</span> <span class="n">vl_status</span> <span class="o">==</span> <span class="s2">&quot;on_VL_suppressed&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;SymptomManager&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">clear_symptoms</span><span class="p">(</span>
                    <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span>
                    <span class="n">disease_module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span>
                <span class="p">)</span>

        <span class="c1"># Consider if TB treatment should start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consider_tb</span><span class="p">(</span><span class="n">person_id</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">drugs_available</span></div>

<div class="viewcode-block" id="HSI_Hiv_StartOrContinueTreatment.do_at_continuation"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_StartOrContinueTreatment.do_at_continuation">[docs]</a>    <span class="k">def</span> <span class="nf">do_at_continuation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Things to do when the person is already on ART&quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">person</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span>

        <span class="c1"># Viral Load Monitoring</span>
        <span class="c1"># NB. This does not have a direct effect on outcomes for the person.</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_consumables</span><span class="p">(</span><span class="n">footprint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">footprints_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;vl_measurement&#39;</span><span class="p">])</span>

        <span class="c1"># Check if drugs are available, and provide drugs:</span>
        <span class="n">drugs_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_drugs</span><span class="p">(</span><span class="n">age_of_person</span><span class="o">=</span><span class="n">person</span><span class="p">[</span><span class="s1">&#39;age_years&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">drugs_available</span></div>

<div class="viewcode-block" id="HSI_Hiv_StartOrContinueTreatment.determine_vl_status"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_StartOrContinueTreatment.determine_vl_status">[docs]</a>    <span class="k">def</span> <span class="nf">determine_vl_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sex_of_person</span><span class="p">,</span> <span class="n">age_of_person</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper function to determine the VL status that the person will have.</span>
<span class="sd">        Return what will be the status of &quot;hv_art&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span>

        <span class="k">if</span> <span class="n">age_of_person</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">:</span>
            <span class="n">prob_vs</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;vls_child&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sex_of_person</span> <span class="o">==</span> <span class="s2">&quot;M&quot;</span><span class="p">:</span>
                <span class="n">prob_vs</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;vls_m&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prob_vs</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;vls_f&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="s2">&quot;on_VL_suppressed&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">prob_vs</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;on_not_VL_suppressed&quot;</span></div>

<div class="viewcode-block" id="HSI_Hiv_StartOrContinueTreatment.get_drugs"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_StartOrContinueTreatment.get_drugs">[docs]</a>    <span class="k">def</span> <span class="nf">get_drugs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">age_of_person</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper function to get the ART according to the age of the person being treated. Returns bool to indicate</span>
<span class="sd">        whether drugs were available&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">age_of_person</span> <span class="o">&lt;</span> <span class="mf">5.0</span><span class="p">:</span>
            <span class="c1"># Formulation for children</span>
            <span class="n">drugs_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_consumables</span><span class="p">(</span>
                <span class="n">footprint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">footprints_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;art_child&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Formulation for adults</span>
            <span class="n">drugs_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_consumables</span><span class="p">(</span>
                <span class="n">footprint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">footprints_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;art_adult&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">drugs_available</span></div>

<div class="viewcode-block" id="HSI_Hiv_StartOrContinueTreatment.consider_tb"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_StartOrContinueTreatment.consider_tb">[docs]</a>    <span class="k">def</span> <span class="nf">consider_tb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="c1"># todo - TB treatment when person starts ART - complete when TB module is completed.</span>
        <span class="k">pass</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Consider whether IPT is needed at this time. This is run only when treatment is initiated.</span>
<span class="sd">        # if &#39;Tb&#39; in self.sim.modules:</span>
<span class="sd">            district = df.at[person_id, &quot;district_of_residence&quot;]</span>
<span class="sd">            eligible = df.at[person_id, &quot;tb_inf&quot;].startswith(&quot;active&quot;)</span>
<span class="sd">            if (</span>
<span class="sd">                (district in params[&quot;tb_high_risk_distr&quot;].values)</span>
<span class="sd">                &amp; (self.sim.date.year &gt; 2012)</span>
<span class="sd">                &amp; eligible</span>
<span class="sd">                &amp; (self.module.rng.rand() &lt; params[&quot;???&quot;])</span>
<span class="sd">            ):</span>
<span class="sd">                # Schedule the TB treatment event:</span>
<span class="sd">                self.sim.modules[&quot;HealthSystem&quot;].schedule_hsi_event(</span>
<span class="sd">                    tb.HSI_Tb_IptHiv(self.module[&#39;Tb&#39;], person_id=person_id),</span>
<span class="sd">                    priority=1,</span>
<span class="sd">                    topen=self.sim.date,</span>
<span class="sd">                    tclose=None</span>
<span class="sd">                )</span>
<span class="sd">            &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="HSI_Hiv_StartOrContinueTreatment.never_ran"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_StartOrContinueTreatment.never_ran">[docs]</a>    <span class="k">def</span> <span class="nf">never_ran</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This is called if this HSI was never run.</span>
<span class="sd">        * Default the person to being off ART.</span>
<span class="sd">        * Determine if they will re-seek care themselves in the future:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># stop treatment for this person</span>
        <span class="n">person_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">stops_treatment</span><span class="p">(</span><span class="n">person_id</span><span class="p">)</span>

        <span class="c1"># determine if will seek another HSI:</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">&lt;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;probability_of_seeking_further_art_appointment_if_appointment_not_available&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">HSI_Hiv_StartOrContinueTreatment</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">),</span>
                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">14</span><span class="p">),</span>
                <span class="n">tclose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">21</span><span class="p">),</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span></div></div>

<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1">#   Logging</span>
<span class="c1"># ---------------------------------------------------------------------------</span>


<div class="viewcode-block" id="HivLoggingEvent"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivLoggingEvent">[docs]</a><span class="k">class</span> <span class="nc">HivLoggingEvent</span><span class="p">(</span><span class="n">RegularEvent</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">):</span>
<div class="viewcode-block" id="HivLoggingEvent.__init__"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivLoggingEvent.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Log Current status of the population, every year</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">repeat</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">))</span></div>

<div class="viewcode-block" id="HivLoggingEvent.apply"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivLoggingEvent.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
        <span class="c1"># get some summary statistics</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>

        <span class="c1"># ------------------------------------ SUMMARIES ------------------------------------</span>
        <span class="c1"># adult prevalence</span>
        <span class="n">adult_prev_15plus</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)])</span>
            <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)])</span>
        <span class="p">)</span>

        <span class="n">adult_prev_1549</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">49</span><span class="p">)])</span>
            <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)])</span>
        <span class="p">)</span>

        <span class="c1"># child prevalence</span>
        <span class="n">child_prev</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)])</span>
            <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)])</span>
        <span class="p">)</span>

        <span class="c1"># incidence in the period since the last log for 15+ and 15-49 year-olds (denominator is approximate)</span>
        <span class="n">n_new_infections_adult_15plus</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_date_inf</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))</span>
                <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">denom_adults_15plus</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)])</span>
        <span class="n">adult_inc_15plus</span> <span class="o">=</span> <span class="n">n_new_infections_adult_15plus</span> <span class="o">/</span> <span class="n">denom_adults_15plus</span>

        <span class="n">n_new_infections_adult_1549</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">49</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_date_inf</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))</span>
                <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">denom_adults_1549</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">49</span><span class="p">)])</span>
        <span class="n">adult_inc_1549</span> <span class="o">=</span> <span class="n">n_new_infections_adult_1549</span> <span class="o">/</span> <span class="n">denom_adults_1549</span>

        <span class="c1"># incidence in the period since the last log for 0-14 year-olds (denominator is approximate)</span>
        <span class="n">n_new_infections_children</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_date_inf</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))</span>
                <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">denom_children</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)])</span>
        <span class="n">child_inc</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_new_infections_children</span> <span class="o">/</span> <span class="n">denom_children</span><span class="p">)</span>

        <span class="c1"># hiv prev among female sex workers (aged 15-49)</span>
        <span class="n">n_fsw</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">li_is_sexworker</span> <span class="o">&amp;</span>
                        <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;F&quot;</span><span class="p">)</span> <span class="o">&amp;</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">49</span><span class="p">)</span>
                        <span class="p">])</span>
        <span class="n">prev_hiv_fsw</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">n_fsw</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> \
            <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span> <span class="o">&amp;</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">li_is_sexworker</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;F&quot;</span><span class="p">)</span> <span class="o">&amp;</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">49</span><span class="p">)</span>
                    <span class="p">])</span> <span class="o">/</span> <span class="n">n_fsw</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;summary_inc_and_prev_for_adults_and_children_and_fsw&#39;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Summary of HIV among adult (15+ and 15-49) and children (0-14s) and female sex workers&#39;</span>
                                <span class="s1">&#39; (15-49)&#39;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;hiv_prev_adult_15plus&quot;</span><span class="p">:</span> <span class="n">adult_prev_15plus</span><span class="p">,</span>
                        <span class="s2">&quot;hiv_prev_adult_1549&quot;</span><span class="p">:</span> <span class="n">adult_prev_1549</span><span class="p">,</span>
                        <span class="s2">&quot;hiv_prev_child&quot;</span><span class="p">:</span> <span class="n">child_prev</span><span class="p">,</span>
                        <span class="s2">&quot;hiv_adult_inc_15plus&quot;</span><span class="p">:</span> <span class="n">adult_inc_15plus</span><span class="p">,</span>
                        <span class="s2">&quot;hiv_adult_inc_1549&quot;</span><span class="p">:</span> <span class="n">adult_inc_1549</span><span class="p">,</span>
                        <span class="s2">&quot;hiv_child_inc&quot;</span><span class="p">:</span> <span class="n">child_inc</span><span class="p">,</span>
                        <span class="s2">&quot;hiv_prev_fsw&quot;</span><span class="p">:</span> <span class="n">prev_hiv_fsw</span>
                    <span class="p">}</span>
                    <span class="p">)</span>

        <span class="c1"># ------------------------------------ PREVALENCE BY AGE and SEX  ------------------------------------</span>

        <span class="c1"># Prevalence by Age/Sex (to make every category be output, do separately by &#39;sex&#39;)</span>
        <span class="n">prev_by_age_and_sex</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">sex</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">]:</span>
            <span class="n">n_hiv</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="n">sex</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;age_range&#39;</span><span class="p">])[</span><span class="s1">&#39;hv_inf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">n_pop</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="n">sex</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;age_range&#39;</span><span class="p">])[</span><span class="s1">&#39;hv_inf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
            <span class="n">prev_by_age_and_sex</span><span class="p">[</span><span class="n">sex</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_hiv</span> <span class="o">/</span> <span class="n">n_pop</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;prev_by_age_and_sex&#39;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">prev_by_age_and_sex</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Prevalence of HIV split by age and sex&#39;</span><span class="p">)</span>

        <span class="c1"># ------------------------------------ TESTING ------------------------------------</span>

        <span class="c1"># proportion of adult population tested in past year</span>
        <span class="n">n_tested</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_number_tests</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span>
                              <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_last_test_date</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))])</span>
        <span class="n">n_pop</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)])</span>
        <span class="n">tested</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_tested</span> <span class="o">/</span> <span class="n">n_pop</span><span class="p">)</span>

        <span class="c1"># proportion of adult population tested in past year by sex</span>
        <span class="n">testing_by_sex</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">sex</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">]:</span>
            <span class="n">n_tested</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="n">sex</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_number_tests</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span>
                                  <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_last_test_date</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))])</span>
            <span class="n">n_pop</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="n">sex</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)])</span>
            <span class="n">testing_by_sex</span><span class="p">[</span><span class="n">sex</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_tested</span> <span class="o">/</span> <span class="n">n_pop</span><span class="p">)</span>

        <span class="c1"># per_capita_testing_rate: number of tests administered divided by population</span>
        <span class="n">current_testing_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">per_capita_testing_rate</span><span class="p">()</span>

        <span class="c1"># ------------------------------------ TREATMENT ------------------------------------</span>
        <span class="k">def</span> <span class="nf">treatment_counts</span><span class="p">(</span><span class="n">subset</span><span class="p">):</span>
            <span class="c1"># total number of subset (subset is a true/false series)</span>
            <span class="n">count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>
            <span class="c1"># proportion of subset living with HIV that are diagnosed:</span>
            <span class="n">proportion_diagnosed</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">subset</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_diagnosed</span><span class="p">)</span> <span class="o">/</span> <span class="n">count</span> <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="c1"># proportions of subset living with HIV on treatment:</span>
            <span class="n">art</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">subset</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_art</span> <span class="o">!=</span> <span class="s2">&quot;not&quot;</span><span class="p">))</span>
            <span class="n">art_cov</span> <span class="o">=</span> <span class="n">art</span> <span class="o">/</span> <span class="n">count</span> <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="c1"># proportion of subset on treatment that have good VL suppression</span>
            <span class="n">art_vs</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">subset</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_art</span> <span class="o">==</span> <span class="s2">&quot;on_VL_suppressed&quot;</span><span class="p">))</span>
            <span class="n">art_cov_vs</span> <span class="o">=</span> <span class="n">art_vs</span> <span class="o">/</span> <span class="n">art</span> <span class="k">if</span> <span class="n">art</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="n">proportion_diagnosed</span><span class="p">,</span> <span class="n">art_cov</span><span class="p">,</span> <span class="n">art_cov_vs</span>

        <span class="n">alive_infected</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span>
        <span class="n">dx_adult</span><span class="p">,</span> <span class="n">art_cov_adult</span><span class="p">,</span> <span class="n">art_cov_vs_adult</span> <span class="o">=</span> <span class="n">treatment_counts</span><span class="p">(</span><span class="n">alive_infected</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">))</span>
        <span class="n">dx_children</span><span class="p">,</span> <span class="n">art_cov_children</span><span class="p">,</span> <span class="n">art_cov_vs_children</span> <span class="o">=</span> <span class="n">treatment_counts</span><span class="p">(</span><span class="n">alive_infected</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">))</span>

        <span class="c1"># ------------------------------------ BEHAVIOUR CHANGE ------------------------------------</span>

        <span class="c1"># proportion of adults (15+) exposed to behaviour change intervention</span>
        <span class="n">prop_adults_exposed_to_behav_intv</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_behaviour_change</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)]</span>
        <span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)])</span>

        <span class="c1"># ------------------------------------ PREP AMONG FSW ------------------------------------</span>
        <span class="n">prop_fsw_on_prep</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">n_fsw</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">li_is_sexworker</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_is_on_prep</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">li_is_sexworker</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)])</span>

        <span class="c1"># ------------------------------------ MALE CIRCUMCISION ------------------------------------</span>
        <span class="c1"># NB. Among adult men</span>
        <span class="n">prop_men_circ</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s1">&#39;M&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">li_is_circ</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s1">&#39;M&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)])</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;hiv_program_coverage&#39;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Coverage of interventions for HIV among adult (15+) and children (0-14s)&#39;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;prop_tested_adult&quot;</span><span class="p">:</span> <span class="n">tested</span><span class="p">,</span>
                        <span class="s2">&quot;prop_tested_adult_male&quot;</span><span class="p">:</span> <span class="n">testing_by_sex</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">],</span>
                        <span class="s2">&quot;prop_tested_adult_female&quot;</span><span class="p">:</span> <span class="n">testing_by_sex</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">],</span>
                        <span class="s2">&quot;per_capita_testing_rate&quot;</span><span class="p">:</span> <span class="n">current_testing_rate</span><span class="p">,</span>
                        <span class="s2">&quot;dx_adult&quot;</span><span class="p">:</span> <span class="n">dx_adult</span><span class="p">,</span>
                        <span class="s2">&quot;dx_childen&quot;</span><span class="p">:</span> <span class="n">dx_children</span><span class="p">,</span>
                        <span class="s2">&quot;art_coverage_adult&quot;</span><span class="p">:</span> <span class="n">art_cov_adult</span><span class="p">,</span>
                        <span class="s2">&quot;art_coverage_adult_VL_suppression&quot;</span><span class="p">:</span> <span class="n">art_cov_vs_adult</span><span class="p">,</span>
                        <span class="s2">&quot;art_coverage_child&quot;</span><span class="p">:</span> <span class="n">art_cov_children</span><span class="p">,</span>
                        <span class="s2">&quot;art_coverage_child_VL_suppression&quot;</span><span class="p">:</span> <span class="n">art_cov_vs_children</span><span class="p">,</span>
                        <span class="s2">&quot;prop_adults_exposed_to_behav_intv&quot;</span><span class="p">:</span> <span class="n">prop_adults_exposed_to_behav_intv</span><span class="p">,</span>
                        <span class="s2">&quot;prop_fsw_on_prep&quot;</span><span class="p">:</span> <span class="n">prop_fsw_on_prep</span><span class="p">,</span>
                        <span class="s2">&quot;prop_men_circ&quot;</span><span class="p">:</span> <span class="n">prop_men_circ</span>
                    <span class="p">}</span>
                    <span class="p">)</span></div></div>

<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1">#   Debugging / Checking Events</span>
<span class="c1"># ---------------------------------------------------------------------------</span>


<div class="viewcode-block" id="HivCheckPropertiesEvent"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivCheckPropertiesEvent">[docs]</a><span class="k">class</span> <span class="nc">HivCheckPropertiesEvent</span><span class="p">(</span><span class="n">RegularEvent</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">):</span>
<div class="viewcode-block" id="HivCheckPropertiesEvent.__init__"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivCheckPropertiesEvent.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>  <span class="c1"># runs every month</span></div>

<div class="viewcode-block" id="HivCheckPropertiesEvent.apply"><a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivCheckPropertiesEvent.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">check_config_of_properties</span><span class="p">()</span></div></div>

<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1">#   Helper functions for analysing outputs</span>
<span class="c1"># ---------------------------------------------------------------------------</span>


<span class="k">def</span> <span class="nf">set_age_group</span><span class="p">(</span><span class="n">ser</span><span class="p">):</span>
    <span class="n">AGE_RANGE_CATEGORIES</span><span class="p">,</span> <span class="n">AGE_RANGE_LOOKUP</span> <span class="o">=</span> <span class="n">create_age_range_lookup</span><span class="p">(</span>
        <span class="n">min_age</span><span class="o">=</span><span class="n">demography</span><span class="o">.</span><span class="n">MIN_AGE_FOR_RANGE</span><span class="p">,</span>
        <span class="n">max_age</span><span class="o">=</span><span class="n">demography</span><span class="o">.</span><span class="n">MAX_AGE_FOR_RANGE</span><span class="p">,</span>
        <span class="n">range_size</span><span class="o">=</span><span class="n">demography</span><span class="o">.</span><span class="n">AGE_RANGE_SIZE</span>
    <span class="p">)</span>
    <span class="n">ser</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>
    <span class="n">AGE_RANGE_CATEGORIES_filtered</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">AGE_RANGE_CATEGORIES</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ser</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">ser</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">reorder_categories</span><span class="p">(</span><span class="n">AGE_RANGE_CATEGORIES_filtered</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">map_to_age_group</span><span class="p">(</span><span class="n">ser</span><span class="p">):</span>
    <span class="n">AGE_RANGE_CATEGORIES</span><span class="p">,</span> <span class="n">AGE_RANGE_LOOKUP</span> <span class="o">=</span> <span class="n">create_age_range_lookup</span><span class="p">(</span>
        <span class="n">min_age</span><span class="o">=</span><span class="n">demography</span><span class="o">.</span><span class="n">MIN_AGE_FOR_RANGE</span><span class="p">,</span>
        <span class="n">max_age</span><span class="o">=</span><span class="n">demography</span><span class="o">.</span><span class="n">MAX_AGE_FOR_RANGE</span><span class="p">,</span>
        <span class="n">range_size</span><span class="o">=</span><span class="n">demography</span><span class="o">.</span><span class="n">AGE_RANGE_SIZE</span>
    <span class="p">)</span>
    <span class="n">ser</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">AGE_RANGE_LOOKUP</span><span class="p">)</span>
    <span class="n">ser</span> <span class="o">=</span> <span class="n">set_age_group</span><span class="p">(</span><span class="n">ser</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ser</span>


<span class="k">def</span> <span class="nf">unpack_raw_output_dict</span><span class="p">(</span><span class="n">raw_dict</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">raw_dict</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">x</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="s1">&#39;age_group&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">x</span><span class="p">[</span><span class="s1">&#39;age_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">set_age_group</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;age_group&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, The TLOmodel Team.
      <span class="lastupdated">
        Last updated on May 25, 2021.
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>