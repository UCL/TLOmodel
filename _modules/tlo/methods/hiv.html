

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tlo.methods.hiv &mdash; TLOmodel 0.1.dev2457+g44ac319.d20241008 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=d10597a4" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=7ab3649f" />
      <link rel="stylesheet" type="text/css" href="../../../_static/theme_overrides.css?v=6ea10ece" />

  
    <link rel="shortcut icon" href="../../../_static/favicon.png"/>
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=0e657b16"></script>
      <script src="../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            TLOmodel
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Welcome</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../aims.html">Aims &amp; Objectives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../writeups.html">Model Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data_sources.html">Data Sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../azure_batch.html">Using Azure Batch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../resources/index.html">Resource files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../parameters.html">Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../learning.html">Learning Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributors.html">Contributors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">TLOmodel</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../methods.html">tlo.methods</a></li>
      <li class="breadcrumb-item active">tlo.methods.hiv</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for tlo.methods.hiv</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The HIV Module</span>
<span class="sd">Overview:</span>
<span class="sd">HIV infection ---&gt; AIDS onset Event (defined by the presence of AIDS symptoms) --&gt; AIDS Death Event</span>
<span class="sd">Testing is spontaneously taken-up and can lead to accessing intervention services (ART, VMMC, PrEP).</span>
<span class="sd">AIDS symptoms can also lead to care-seeking and there is routine testing for HIV at all non-emergency Generic HSI</span>
<span class="sd"> events.</span>
<span class="sd">Persons can be on ART -</span>
<span class="sd">    - with viral suppression: when the person with not develop AIDS, or if they have already, it is relieved and they</span>
<span class="sd">        will not die of AIDS; and the person is not infectious</span>
<span class="sd">    - without viral suppression: when there is no benefit in avoiding AIDS and infectiousness is unchanged.</span>
<span class="sd">Maintenance on ART and PrEP is re-assessed at periodic &#39;Decision Events&#39;, at which it is determined if the person</span>
<span class="sd">  will attend the &quot;next&quot; HSI for continuation of the service; and if not, they are removed from that service and &quot;stop</span>
<span class="sd">  treatment&quot;. If a stock-out or non-availability of health system resources prevent treatment continuation, the person</span>
<span class="sd">  &quot;stops treatment&quot;. Stopping treatment leads to a new AIDS Event being scheduled. Persons can restart treatment. If a</span>
<span class="sd">  person has developed AIDS, starts treatment and then defaults from treatment, their &#39;original&#39; AIDS Death Event will</span>
<span class="sd">  still occur.</span>
<span class="sd">If PrEP is not available due to limitations in the HealthSystem, the person defaults to not being on PrEP.</span>
<span class="sd"># Things to note:</span>
<span class="sd">    * Need to incorporate testing for HIV at first ANC appointment (as it does in generic HSI)</span>
<span class="sd">    * Need to incorporate testing for infants born to HIV-positive mothers (currently done in on_birth here).</span>
<span class="sd">    * Need to incorporate cotrim for infants born to HIV-positive mothers (not done here)</span>
<span class="sd">    * Cotrimoxazole is not included - either in effect of consumption of the drug (because the effect is not known).</span>
<span class="sd">    * Calibration has not been done: most things look OK - except HIV-AIDS deaths</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">List</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">tlo</span> <span class="kn">import</span> <span class="n">DAYS_IN_YEAR</span><span class="p">,</span> <span class="n">Date</span><span class="p">,</span> <span class="n">DateOffset</span><span class="p">,</span> <span class="n">Module</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">,</span> <span class="n">Property</span><span class="p">,</span> <span class="n">Types</span><span class="p">,</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="nn">tlo.events</span> <span class="kn">import</span> <span class="n">Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">,</span> <span class="n">RegularEvent</span>
<span class="kn">from</span> <span class="nn">tlo.lm</span> <span class="kn">import</span> <span class="n">LinearModel</span><span class="p">,</span> <span class="n">LinearModelType</span><span class="p">,</span> <span class="n">Predictor</span>
<span class="kn">from</span> <span class="nn">tlo.methods</span> <span class="kn">import</span> <span class="n">Metadata</span><span class="p">,</span> <span class="n">demography</span><span class="p">,</span> <span class="n">tb</span>
<span class="kn">from</span> <span class="nn">tlo.methods.causes</span> <span class="kn">import</span> <span class="n">Cause</span>
<span class="kn">from</span> <span class="nn">tlo.methods.dxmanager</span> <span class="kn">import</span> <span class="n">DxTest</span>
<span class="kn">from</span> <span class="nn">tlo.methods.hsi_event</span> <span class="kn">import</span> <span class="n">HSI_Event</span>
<span class="kn">from</span> <span class="nn">tlo.methods.hsi_generic_first_appts</span> <span class="kn">import</span> <span class="n">GenericFirstAppointmentsMixin</span>
<span class="kn">from</span> <span class="nn">tlo.methods.symptommanager</span> <span class="kn">import</span> <span class="n">Symptom</span>
<span class="kn">from</span> <span class="nn">tlo.util</span> <span class="kn">import</span> <span class="n">create_age_range_lookup</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">tlo.methods.hsi_generic_first_appts</span> <span class="kn">import</span> <span class="n">HSIEventScheduler</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>


<div class="viewcode-block" id="Hiv">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv">[docs]</a>
<span class="k">class</span> <span class="nc">Hiv</span><span class="p">(</span><span class="n">Module</span><span class="p">,</span> <span class="n">GenericFirstAppointmentsMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The HIV Disease Module</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Hiv.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resourcefilepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run_with_checks</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resourcefilepath</span> <span class="o">=</span> <span class="n">resourcefilepath</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">run_with_checks</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_with_checks</span> <span class="o">=</span> <span class="n">run_with_checks</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stored_test_numbers</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># create empty list for storing hiv test numbers</span>

        <span class="c1"># hiv outputs needed for calibration</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">,</span>
                <span class="s2">&quot;hiv_prev_adult_1549&quot;</span><span class="p">,</span>
                <span class="s2">&quot;hiv_adult_inc_1549&quot;</span><span class="p">,</span>
                <span class="s2">&quot;hiv_prev_child&quot;</span><span class="p">,</span>
                <span class="s2">&quot;population&quot;</span>
                <span class="p">]</span>
        <span class="c1"># initialise empty dict with set keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hiv_outputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">daly_wts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span></div>


    <span class="n">INIT_DEPENDENCIES</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Demography&quot;</span><span class="p">,</span> <span class="s2">&quot;HealthSystem&quot;</span><span class="p">,</span> <span class="s2">&quot;Lifestyle&quot;</span><span class="p">,</span> <span class="s2">&quot;SymptomManager&quot;</span><span class="p">}</span>

    <span class="n">OPTIONAL_INIT_DEPENDENCIES</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;HealthBurden&quot;</span><span class="p">}</span>

    <span class="n">ADDITIONAL_DEPENDENCIES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Tb&#39;</span><span class="p">,</span> <span class="s1">&#39;NewbornOutcomes&#39;</span><span class="p">}</span>

    <span class="n">METADATA</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">Metadata</span><span class="o">.</span><span class="n">DISEASE_MODULE</span><span class="p">,</span>
        <span class="n">Metadata</span><span class="o">.</span><span class="n">USES_SYMPTOMMANAGER</span><span class="p">,</span>
        <span class="n">Metadata</span><span class="o">.</span><span class="n">USES_HEALTHSYSTEM</span><span class="p">,</span>
        <span class="n">Metadata</span><span class="o">.</span><span class="n">USES_HEALTHBURDEN</span>
    <span class="p">}</span>

    <span class="c1"># Declare Causes of Death</span>
    <span class="n">CAUSES_OF_DEATH</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;AIDS_non_TB&quot;</span><span class="p">:</span> <span class="n">Cause</span><span class="p">(</span><span class="n">gbd_causes</span><span class="o">=</span><span class="s2">&quot;HIV/AIDS&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;AIDS&quot;</span><span class="p">),</span>
        <span class="s2">&quot;AIDS_TB&quot;</span><span class="p">:</span> <span class="n">Cause</span><span class="p">(</span><span class="n">gbd_causes</span><span class="o">=</span><span class="s2">&quot;HIV/AIDS&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;AIDS&quot;</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="c1"># Declare Causes of Disability</span>
    <span class="n">CAUSES_OF_DISABILITY</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;HIV&quot;</span><span class="p">:</span> <span class="n">Cause</span><span class="p">(</span><span class="n">gbd_causes</span><span class="o">=</span><span class="s2">&quot;HIV/AIDS&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;AIDS&quot;</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="n">PROPERTIES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># --- Core Properties</span>
        <span class="s2">&quot;hv_inf&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span>
            <span class="s2">&quot;Is person currently infected with HIV (NB. AIDS status is determined by prescence of the AIDS Symptom.&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;hv_art&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">CATEGORICAL</span><span class="p">,</span>
            <span class="s2">&quot;ART status of person, whether on ART or not; and whether viral load is suppressed or not if on ART.&quot;</span><span class="p">,</span>
            <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;not&quot;</span><span class="p">,</span> <span class="s2">&quot;on_VL_suppressed&quot;</span><span class="p">,</span> <span class="s2">&quot;on_not_VL_suppressed&quot;</span><span class="p">],</span>
        <span class="p">),</span>
        <span class="s2">&quot;hv_on_cotrimoxazole&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span>
            <span class="s2">&quot;Whether the person is currently taking and receiving a malaria-protective effect from cotrimoxazole&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;hv_is_on_prep&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span>
            <span class="s2">&quot;Whether the person is currently taking and receiving a protective effect from Pre-Exposure Prophylaxis&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;hv_behaviour_change&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span>
            <span class="s2">&quot;Has this person been exposed to HIV prevention counselling following a negative HIV test result&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;hv_diagnosed&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span> <span class="s2">&quot;Knows that they are HIV+: i.e. is HIV+ and tested as HIV+&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;hv_number_tests&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span> <span class="s2">&quot;Number of HIV tests ever taken&quot;</span><span class="p">),</span>
        <span class="c1"># --- Dates on which things have happened:</span>
        <span class="s2">&quot;hv_last_test_date&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATE</span><span class="p">,</span> <span class="s2">&quot;Date of last HIV test&quot;</span><span class="p">),</span>
        <span class="s2">&quot;hv_date_inf&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATE</span><span class="p">,</span> <span class="s2">&quot;Date infected with HIV&quot;</span><span class="p">),</span>
        <span class="s2">&quot;hv_date_treated&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATE</span><span class="p">,</span> <span class="s2">&quot;date hiv treatment started&quot;</span><span class="p">),</span>
        <span class="s2">&quot;hv_date_last_ART&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATE</span><span class="p">,</span> <span class="s2">&quot;date of last ART dispensation&quot;</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="n">PARAMETERS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># Baseline characteristics</span>
        <span class="s2">&quot;time_inf&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s2">&quot;prob of time since infection for baseline adult pop&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;art_coverage&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s2">&quot;coverage of ART at baseline&quot;</span><span class="p">),</span>
        <span class="s2">&quot;treatment_cascade&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s2">&quot;spectrum estimates of treatment cascade&quot;</span><span class="p">),</span>
        <span class="c1"># Natural history - transmission - overall rates</span>
        <span class="s2">&quot;beta&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Transmission rate&quot;</span><span class="p">),</span>
        <span class="s2">&quot;unaids_prevalence_adjustment_factor&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;adjustment for baseline age-specific prevalence values to give correct population prevalence&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;prob_mtct_untreated&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Probability of mother to child transmission&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;prob_mtct_treated&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Probability of mother to child transmission, mother on ART&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;prob_mtct_incident_preg&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Probability of mother to child transmission, mother infected during pregnancy&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;monthly_prob_mtct_bf_untreated&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Probability of mother to child transmission during breastfeeding&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;monthly_prob_mtct_bf_treated&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Probability of mother to child transmission, mother infected during breastfeeding&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="c1"># Natural history - transmission - relative risk of HIV acquisition (non-intervention)</span>
        <span class="s2">&quot;rr_fsw&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative risk of HIV with female sex work&quot;</span><span class="p">),</span>
        <span class="s2">&quot;rr_circumcision&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative risk of HIV with circumcision&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;rr_rural&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative risk of HIV in rural location&quot;</span><span class="p">),</span>
        <span class="s2">&quot;rr_windex_poorer&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative risk of HIV with wealth level poorer&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;rr_windex_middle&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative risk of HIV with wealth level middle&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;rr_windex_richer&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative risk of HIV with wealth level richer&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;rr_windex_richest&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative risk of HIV with wealth level richest&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;rr_sex_f&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative risk of HIV if female&quot;</span><span class="p">),</span>
        <span class="s2">&quot;rr_edlevel_primary&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative risk of HIV with primary education&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;rr_edlevel_secondary&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative risk of HIV with secondary education&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;rr_edlevel_higher&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative risk of HIV with higher education&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;rr_schisto&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative risk of HIV with high intensity S. haematobium infection&quot;</span>
        <span class="p">),</span>
        <span class="c1"># Natural history - transmission - relative risk of HIV acquisition (interventions)</span>
        <span class="s2">&quot;rr_behaviour_change&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Relative risk of HIV with behaviour modification&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;proportion_reduction_in_risk_of_hiv_aq_if_on_prep&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Proportion reduction in risk of HIV acquisition if on PrEP. 0 for no efficacy; 1.0 for perfect efficacy.&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="c1"># Natural history - survival (adults)</span>
        <span class="s2">&quot;mean_months_between_aids_and_death&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Mean number of months (distributed exponentially) for the time between AIDS and AIDS Death&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;mean_months_between_aids_and_death_infant&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Mean number of months for the time between AIDS and AIDS Death for infants&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;infection_to_death_weibull_shape_1519&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Shape parameter for Weibull describing time between infection and death for 15-19 yo (units: years)&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;infection_to_death_weibull_shape_2024&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Shape parameter for Weibull describing time between infection and death for 20-24 yo (units: years)&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;infection_to_death_weibull_shape_2529&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Shape parameter for Weibull describing time between infection and death for 25-29 yo (units: years)&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;infection_to_death_weibull_shape_3034&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Shape parameter for Weibull describing time between infection and death for 30-34 yo (units: years)&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;infection_to_death_weibull_shape_3539&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Shape parameter for Weibull describing time between infection and death for 35-39 yo (units: years)&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;infection_to_death_weibull_shape_4044&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Shape parameter for Weibull describing time between infection and death for 40-44 yo (units: years)&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;infection_to_death_weibull_shape_4549&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Shape parameter for Weibull describing time between infection and death for 45-49 yo (units: years)&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;infection_to_death_weibull_scale_1519&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Scale parameter for Weibull describing time between infection and death for 15-19 yo (units: years)&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;infection_to_death_weibull_scale_2024&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Scale parameter for Weibull describing time between infection and death for 20-24 yo (units: years)&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;infection_to_death_weibull_scale_2529&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Scale parameter for Weibull describing time between infection and death for 25-29 yo (units: years)&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;infection_to_death_weibull_scale_3034&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Scale parameter for Weibull describing time between infection and death for 30-34 yo (units: years)&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;infection_to_death_weibull_scale_3539&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Scale parameter for Weibull describing time between infection and death for 35-39 yo (units: years)&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;infection_to_death_weibull_scale_4044&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Scale parameter for Weibull describing time between infection and death for 40-44 yo (units: years)&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;infection_to_death_weibull_scale_4549&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Scale parameter for Weibull describing time between infection and death for 45-49 yo (units: years)&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;art_default_to_aids_mean_years&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Mean years between when a person (any change) stops being on treatment to when AIDS is onset (if the &quot;</span>
            <span class="s2">&quot;absence of resuming treatment).&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;prop_delayed_aids_onset&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Proportion of PLHIV that will have delayed AIDS onset to compensate for AIDS-TB&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="c1"># Natural history - survival (children)</span>
        <span class="s2">&quot;mean_survival_for_infants_infected_prior_to_birth&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Exponential rate parameter for mortality in infants who are infected before birth&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;infection_to_death_infant_infection_after_birth_weibull_scale&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Weibull scale parameter for mortality in infants who are infected after birth&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;infection_to_death_infant_infection_after_birth_weibull_shape&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Weibull shape parameter for mortality in infants who are infected after birth&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="c1"># Uptake of Interventions</span>
        <span class="s2">&quot;hiv_testing_rates&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span> <span class="s2">&quot;annual rates of testing for children and adults&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;rr_test_hiv_positive&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;relative likelihood of having HIV test for people with HIV&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;hiv_testing_rate_adjustment&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;adjustment to current testing rates to account for multiple routes into HIV testing&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;treatment_initiation_adjustment&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;adjustment to current ART coverage levels to account for defaulters&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;vs_adjustment&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;adjustment to current viral suppression levels to account for defaulters&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;prob_hiv_test_at_anc_or_delivery&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;probability of a women having hiv test at anc or following delivery&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;prob_hiv_test_for_newborn_infant&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;probability of a newborn infant having HIV test pre-discharge&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;prob_start_art_or_vs&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Probability that a person will start treatment and be virally suppressed following testing&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;prob_behav_chg_after_hiv_test&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Probability that a person will change risk behaviours, if HIV-negative, following testing&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;prob_prep_for_fsw_after_hiv_test&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Probability that a FSW will start PrEP, if HIV-negative, following testing&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;prob_prep_for_agyw&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Probability that adolescent girls / young women will start PrEP&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;prob_circ_after_hiv_test&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Probability that a male will be circumcised, if HIV-negative, following testing&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;prob_circ_for_child_before_2020&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Probability that a male aging &lt;15 yrs will be circumcised before year 2020&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;prob_circ_for_child_from_2020&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Probability that a male aging &lt;15 yrs will be circumcised from year 2020, &quot;</span>
            <span class="s2">&quot;which is different from before 2020 as children vmmc policy/fund/cases has changed, &quot;</span>
            <span class="s2">&quot;according to PEPFAR 2020 Country Operational Plan and DHIS2 data&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;probability_of_being_retained_on_prep_every_3_months&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Probability that someone who has initiated on prep will attend an appointment and be on prep &quot;</span>
            <span class="s2">&quot;for the next 3 months, until the next appointment.&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;probability_of_being_retained_on_art_every_3_months&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Probability that someone who has initiated on treatment will attend an appointment and be on &quot;</span>
            <span class="s2">&quot;treatment for next 3 months, until the next appointment.&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;probability_of_seeking_further_art_appointment_if_drug_not_available&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Probability that a person who &#39;should&#39; be on art will seek another appointment (the following &quot;</span>
            <span class="s2">&quot;day and try for each of the next 7 days) if drugs were not available.&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;probability_of_seeking_further_art_appointment_if_appointment_not_available&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;Probability that a person who &#39;should&#39; be on art will seek another appointment if the health-&quot;</span>
            <span class="s2">&quot;system has not been able to provide them with an appointment&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;prep_start_year&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s2">&quot;Year from which PrEP is available&quot;</span><span class="p">),</span>
        <span class="s2">&quot;ART_age_cutoff_young_child&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span> <span class="s2">&quot;Age cutoff for ART regimen for young children&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;ART_age_cutoff_older_child&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span> <span class="s2">&quot;Age cutoff for ART regimen for older children&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;rel_probability_art_baseline_aids&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;relative probability of person with HIV infection over 10 years being on ART at baseline&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;aids_tb_treatment_adjustment&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;probability of death if aids and tb, person on treatment for tb&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;hiv_healthseekingbehaviour_cap&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span>
            <span class="s2">&quot;number of repeat visits assumed for healthcare services&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;dispensation_period_months&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s2">&quot;length of prescription for ARVs in months, same for all PLHIV&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;length_of_inpatient_stay_if_terminal&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">LIST</span><span class="p">,</span>
            <span class="s2">&quot;length in days of inpatient stay for end-of-life HIV patients: list has two elements [low-bound-inclusive,&quot;</span>
            <span class="s2">&quot; high-bound-exclusive]&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="c1"># ------------------ scale-up parameters for scenario analysis ------------------ #</span>
        <span class="s2">&quot;type_of_scaleup&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">STRING</span><span class="p">,</span> <span class="s2">&quot;argument to determine type scale-up of program which will be implemented, &quot;</span>
                          <span class="s2">&quot;can be &#39;none&#39;, &#39;target&#39; or &#39;max&#39;&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;scaleup_start_year&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span>
            <span class="s2">&quot;the year when the scale-up starts (it will occur on 1st January of that year)&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;scaleup_parameters&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">.</span><span class="n">DATA_FRAME</span><span class="p">,</span>
            <span class="s2">&quot;the parameters and values changed in scenario analysis&quot;</span>
        <span class="p">),</span>
    <span class="p">}</span>

<div class="viewcode-block" id="Hiv.read_parameters">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.read_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">read_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_folder</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        * 1) Reads the ResourceFiles</span>
<span class="sd">        * 2) Declare the Symptoms</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># 1) Read the ResourceFiles</span>

        <span class="c1"># Shortcut to parameters dict</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>

        <span class="n">workbook</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resourcefilepath</span><span class="p">,</span> <span class="s2">&quot;ResourceFile_HIV.xlsx&quot;</span><span class="p">),</span>
            <span class="n">sheet_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_parameters_from_dataframe</span><span class="p">(</span><span class="n">workbook</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">])</span>

        <span class="c1"># Load data on HIV prevalence</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;hiv_prev&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s2">&quot;hiv_prevalence&quot;</span><span class="p">]</span>

        <span class="c1"># Load assumed time since infected at baseline (year 2010)</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;time_inf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s2">&quot;time_since_infection_at_baselin&quot;</span><span class="p">]</span>

        <span class="c1"># Load reported hiv testing rates</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;hiv_testing_rates&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s2">&quot;MoH_numbers_tests&quot;</span><span class="p">]</span>

        <span class="c1"># Load assumed ART coverage at baseline (year 2010)</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;art_coverage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s2">&quot;art_coverage&quot;</span><span class="p">]</span>

        <span class="c1"># Load probability of art / viral suppression start after positive HIV test</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prob_start_art_or_vs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s2">&quot;spectrum_treatment_cascade&quot;</span><span class="p">]</span>

        <span class="c1"># Load spectrum estimates of treatment cascade</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;treatment_cascade&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s2">&quot;spectrum_treatment_cascade&quot;</span><span class="p">]</span>

        <span class="c1"># load parameters for scale-up projections</span>
        <span class="n">p</span><span class="p">[</span><span class="s1">&#39;scaleup_parameters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">[</span><span class="s2">&quot;scaleup_parameters&quot;</span><span class="p">]</span>

        <span class="c1"># DALY weights</span>
        <span class="c1"># get the DALY weight that this module will use from the weight database (these codes are just random!)</span>
        <span class="k">if</span> <span class="s2">&quot;HealthBurden&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># Chronic infection but not AIDS (including if on ART)</span>
            <span class="c1"># (taken to be equal to &quot;Symptomatic HIV without anaemia&quot;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">daly_wts</span><span class="p">[</span><span class="s2">&quot;hiv_infection_but_not_aids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span>
                <span class="s2">&quot;HealthBurden&quot;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">get_daly_weight</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span>

            <span class="c1">#  AIDS without anti-retroviral treatment without anemia</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">daly_wts</span><span class="p">[</span><span class="s2">&quot;aids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthBurden&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_daly_weight</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span>

        <span class="c1"># 2)  Declare the Symptoms.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;SymptomManager&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">register_symptom</span><span class="p">(</span>
            <span class="n">Symptom</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;aids_symptoms&quot;</span><span class="p">,</span>
                <span class="n">odds_ratio_health_seeking_in_adults</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>  <span class="c1"># High chance of seeking care when aids_symptoms onset</span>
                <span class="n">odds_ratio_health_seeking_in_children</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Hiv.pre_initialise_population">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.pre_initialise_population">[docs]</a>
    <span class="k">def</span> <span class="nf">pre_initialise_population</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Do things required before the population is created</span>
<span class="sd">        * Build the LinearModels&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_linear_models</span><span class="p">()</span></div>


<div class="viewcode-block" id="Hiv._build_linear_models">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv._build_linear_models">[docs]</a>
    <span class="k">def</span> <span class="nf">_build_linear_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Establish the Linear Models&quot;&quot;&quot;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>

        <span class="c1"># ---- LINEAR MODELS -----</span>
        <span class="c1"># LinearModel for the relative risk of becoming infected during the simulation</span>
        <span class="c1"># N.B. age assumed not to have an effect on incidence</span>
        <span class="n">predictors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;age_years&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;&lt;15&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;&lt;49&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;sex&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;F&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_sex_f&quot;</span><span class="p">]),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;li_is_circ&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_circumcision&quot;</span><span class="p">]),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;hv_is_on_prep&quot;</span><span class="p">)</span><span class="o">.</span>
            <span class="n">when</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;proportion_reduction_in_risk_of_hiv_aq_if_on_prep&quot;</span><span class="p">]),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;li_urban&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_rural&quot;</span><span class="p">]),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;li_wealth&quot;</span><span class="p">,</span> <span class="n">conditions_are_mutually_exclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_windex_poorer&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_windex_middle&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_windex_richer&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_windex_richest&quot;</span><span class="p">]),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;li_ed_lev&quot;</span><span class="p">,</span> <span class="n">conditions_are_mutually_exclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_edlevel_primary&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_edlevel_secondary&quot;</span><span class="p">]),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;hv_behaviour_change&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_behaviour_change&quot;</span><span class="p">])</span>
        <span class="p">]</span>

        <span class="n">conditional_predictors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Predictor</span><span class="p">()</span><span class="o">.</span><span class="n">when</span><span class="p">(</span>
                <span class="s1">&#39;(ss_sh_infection_status == &quot;High-infection&quot;) &amp;&#39;</span>
                <span class="s1">&#39;(sex == &quot;F&quot;)&#39;</span><span class="p">,</span>
                <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_schisto&quot;</span><span class="p">]</span>
            <span class="p">),</span>
        <span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;Schisto&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span> <span class="k">else</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s2">&quot;rr_of_infection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinearModel</span><span class="o">.</span><span class="n">multiplicative</span><span class="p">(</span>
            <span class="o">*</span><span class="p">(</span><span class="n">predictors</span> <span class="o">+</span> <span class="n">conditional_predictors</span><span class="p">))</span>

        <span class="c1"># LinearModels to give the shape and scale for the Weibull distribution describing time from infection to death</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s2">&quot;scale_parameter_for_infection_to_death&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinearModel</span><span class="o">.</span><span class="n">multiplicative</span><span class="p">(</span>
            <span class="n">Predictor</span><span class="p">(</span>
                <span class="s2">&quot;age_years&quot;</span><span class="p">,</span>
                <span class="n">conditions_are_mutually_exclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">conditions_are_exhaustive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;==0&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;mean_survival_for_infants_infected_prior_to_birth&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span>
                <span class="s2">&quot;.between(1,4)&quot;</span><span class="p">,</span>
                <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_infant_infection_after_birth_weibull_scale&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;.between(5, 19)&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_weibull_scale_1519&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;.between(20, 24)&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_weibull_scale_2024&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;.between(25, 29)&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_weibull_scale_2529&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;.between(30, 34)&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_weibull_scale_3034&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;.between(35, 39)&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_weibull_scale_3539&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;.between(40, 44)&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_weibull_scale_4044&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;.between(45, 49)&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_weibull_scale_4549&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;&gt;= 50&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_weibull_scale_4549&quot;</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s2">&quot;shape_parameter_for_infection_to_death&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinearModel</span><span class="o">.</span><span class="n">multiplicative</span><span class="p">(</span>
            <span class="n">Predictor</span><span class="p">(</span>
                <span class="s2">&quot;age_years&quot;</span><span class="p">,</span>
                <span class="n">conditions_are_mutually_exclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">conditions_are_exhaustive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;==0&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Weibull with shape=1 equivalent to exponential distribution</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;.between(1,4)&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_infant_infection_after_birth_weibull_shape&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;.between(5, 19)&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_weibull_shape_1519&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;.between(20, 24)&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_weibull_shape_2024&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;.between(25, 29)&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_weibull_shape_2529&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;.between(30, 34)&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_weibull_shape_3034&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;.between(35, 39)&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_weibull_shape_3539&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;.between(40, 44)&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_weibull_shape_4044&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;.between(45, 49)&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_weibull_shape_4549&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;&gt;= 50&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;infection_to_death_weibull_shape_4549&quot;</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="c1"># -- Linear Model to give the mean months between aids and death depending on age</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s2">&quot;offset_parameter_for_months_from_aids_to_death&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">LinearModel</span><span class="o">.</span><span class="n">multiplicative</span><span class="p">(</span>
                <span class="n">Predictor</span><span class="p">(</span>
                    <span class="s2">&quot;age_years&quot;</span><span class="p">,</span>
                    <span class="n">conditions_are_mutually_exclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">conditions_are_exhaustive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;&lt;5&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;mean_months_between_aids_and_death_infant&quot;</span><span class="p">])</span>
                <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;&gt;=5&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;mean_months_between_aids_and_death&quot;</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># -- Linear Models for the Uptake of Services</span>
        <span class="c1"># Linear model that give the increase in likelihood of seeking a &#39;Spontaneous&#39; Test for HIV</span>
        <span class="c1"># condition must be not on ART for test</span>
        <span class="c1"># allow children to be tested without symptoms</span>
        <span class="c1"># previously diagnosed can be re-tested</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s2">&quot;lm_spontaneous_test_12m&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinearModel</span><span class="o">.</span><span class="n">multiplicative</span><span class="p">(</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;hv_inf&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rr_test_hiv_positive&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;hv_art&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;not&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Linear model for changing behaviour following an HIV-negative test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s2">&quot;lm_behavchg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinearModel</span><span class="p">(</span>
            <span class="n">LinearModelType</span><span class="o">.</span><span class="n">MULTIPLICATIVE</span><span class="p">,</span>
            <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prob_behav_chg_after_hiv_test&quot;</span><span class="p">],</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;hv_inf&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Linear model for starting PrEP (if F/sex-workers), following when the person has tested HIV -ve:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s2">&quot;lm_prep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinearModel</span><span class="p">(</span>
            <span class="n">LinearModelType</span><span class="o">.</span><span class="n">MULTIPLICATIVE</span><span class="p">,</span>
            <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prob_prep_for_fsw_after_hiv_test&quot;</span><span class="p">],</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;hv_inf&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;sex&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;F&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;li_is_sexworker&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Linear model for circumcision (if M) following when the person has been tested:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s2">&quot;lm_circ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinearModel</span><span class="p">(</span>
            <span class="n">LinearModelType</span><span class="o">.</span><span class="n">MULTIPLICATIVE</span><span class="p">,</span>
            <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prob_circ_after_hiv_test&quot;</span><span class="p">],</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;hv_inf&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;sex&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Linear model for circumcision for male and aging &lt;15 yrs who spontaneously presents for VMMC</span>
        <span class="c1"># This is to increase the VMMC cases/visits for &lt;15 yrs males, which should account for about</span>
        <span class="c1"># 40% of total VMMC cases according to UNAIDS &amp; WHO/DHIS2 2015-2019 data.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s2">&quot;lm_circ_child&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinearModel</span><span class="o">.</span><span class="n">multiplicative</span><span class="p">(</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;sex&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;age_years&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;&lt;15&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">,</span>
                      <span class="n">external</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">conditions_are_mutually_exclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">conditions_are_exhaustive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s2">&quot;&lt;2020&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prob_circ_for_child_before_2020&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;prob_circ_for_child_from_2020&quot;</span><span class="p">])</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Hiv.initialise_population">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.initialise_population">[docs]</a>
    <span class="k">def</span> <span class="nf">initialise_population</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set our property values for the initial population.&quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="c1"># --- Current status</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s2">&quot;hv_inf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s2">&quot;hv_art&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;not&quot;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s2">&quot;hv_is_on_prep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s2">&quot;hv_behaviour_change&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s2">&quot;hv_diagnosed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s2">&quot;hv_number_tests&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># --- Dates on which things have happened</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s2">&quot;hv_date_inf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s2">&quot;hv_last_test_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s2">&quot;hv_date_treated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s2">&quot;hv_date_last_ART&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>

        <span class="c1"># Launch sub-routines for allocating the right number of people into each category</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialise_baseline_prevalence</span><span class="p">(</span><span class="n">population</span><span class="p">)</span>  <span class="c1"># allocate baseline prevalence</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initialise_baseline_art</span><span class="p">(</span><span class="n">population</span><span class="p">)</span>  <span class="c1"># allocate baseline art coverage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialise_baseline_tested</span><span class="p">(</span><span class="n">population</span><span class="p">)</span>  <span class="c1"># allocate baseline testing coverage</span></div>


<div class="viewcode-block" id="Hiv.initialise_baseline_prevalence">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.initialise_baseline_prevalence">[docs]</a>
    <span class="k">def</span> <span class="nf">initialise_baseline_prevalence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign baseline HIV prevalence, according to age, sex and key other variables (established in analysis of DHS</span>
<span class="sd">        data).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="c1"># prob of infection based on age and sex in baseline year (2010:</span>
        <span class="n">prevalence_db</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;hiv_prev&quot;</span><span class="p">]</span>
        <span class="n">prev_2010</span> <span class="o">=</span> <span class="n">prevalence_db</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">prevalence_db</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="mi">2010</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;age_from&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">,</span> <span class="s2">&quot;prop_hiv_mw2021_v14&quot;</span><span class="p">]</span>
        <span class="p">]</span>

        <span class="n">prev_2010</span> <span class="o">=</span> <span class="n">prev_2010</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;age_from&quot;</span><span class="p">:</span> <span class="s2">&quot;age_years&quot;</span><span class="p">})</span>
        <span class="n">prob_of_infec</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;age_years&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">prev_2010</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;age_years&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
        <span class="p">)[</span><span class="s2">&quot;prop_hiv_mw2021_v14&quot;</span><span class="p">]</span>

        <span class="c1"># probability of being hiv-positive based on risk factors</span>
        <span class="n">rel_prob_by_risk_factor</span> <span class="o">=</span> <span class="n">LinearModel</span><span class="o">.</span><span class="n">multiplicative</span><span class="p">(</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;li_is_sexworker&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rr_fsw&quot;</span><span class="p">]),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;li_is_circ&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rr_circumcision&quot;</span><span class="p">]),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;li_urban&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rr_rural&quot;</span><span class="p">]),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;li_wealth&quot;</span><span class="p">,</span> <span class="n">conditions_are_mutually_exclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rr_windex_poorer&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rr_windex_middle&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rr_windex_richer&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rr_windex_richest&quot;</span><span class="p">]),</span>
            <span class="n">Predictor</span><span class="p">(</span><span class="s2">&quot;li_ed_lev&quot;</span><span class="p">,</span> <span class="n">conditions_are_mutually_exclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rr_edlevel_primary&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rr_edlevel_secondary&quot;</span><span class="p">]),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">])</span>

        <span class="c1"># Rescale relative probability of infection so that its average is 1.0 within each age/sex group</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;age_years&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;age_years&quot;</span><span class="p">],</span>
                <span class="s2">&quot;sex&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;sex&quot;</span><span class="p">],</span>
                <span class="s2">&quot;prob_of_infec&quot;</span><span class="p">:</span> <span class="n">prob_of_infec</span><span class="p">,</span>
                <span class="s2">&quot;rel_prob_by_risk_factor&quot;</span><span class="p">:</span> <span class="n">rel_prob_by_risk_factor</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;mean_of_rel_prob_within_age_sex_group&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;age_years&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">])[</span>
            <span class="s2">&quot;rel_prob_by_risk_factor&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;scaled_rel_prob_by_risk_factor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rel_prob_by_risk_factor&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;mean_of_rel_prob_within_age_sex_group&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># add scaling factor 1.1 to match overall unaids prevalence</span>
        <span class="c1"># different assumptions on pop size result in slightly different overall prevalence so use adjustment factor</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;overall_prob_of_infec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">p</span><span class="p">[</span><span class="s2">&quot;scaled_rel_prob_by_risk_factor&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prob_of_infec&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;unaids_prevalence_adjustment_factor&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># this needs to be series of True/False</span>
        <span class="n">infec</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;overall_prob_of_infec&quot;</span><span class="p">]))</span>
                    <span class="o">&lt;</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;overall_prob_of_infec&quot;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>

        <span class="c1"># Assign the designated person as infected in the population.props dataframe:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">infec</span><span class="p">,</span> <span class="s2">&quot;hv_inf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Assign date that persons were infected by drawing from assumed distribution (for adults)</span>
        <span class="c1"># Clipped to prevent dates of infection before the person was born.</span>
        <span class="n">time_inf</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;time_inf&quot;</span><span class="p">]</span>
        <span class="n">years_ago_inf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
            <span class="n">time_inf</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">],</span>
            <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">infec</span><span class="p">),</span>
            <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">p</span><span class="o">=</span><span class="n">time_inf</span><span class="p">[</span><span class="s2">&quot;scaled_prob&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="n">hv_date_inf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">years_ago_inf</span> <span class="o">*</span> <span class="n">DAYS_IN_YEAR</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">infec</span><span class="p">,</span> <span class="s2">&quot;hv_date_inf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hv_date_inf</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">date_of_birth</span><span class="p">)</span></div>


<div class="viewcode-block" id="Hiv.initialise_baseline_art">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.initialise_baseline_art">[docs]</a>
    <span class="k">def</span> <span class="nf">initialise_baseline_art</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;assign initial art coverage levels</span>
<span class="sd">        also assign hiv test properties if allocated ART</span>
<span class="sd">        probability of being on ART scaled by length of time infected (&gt;10 years)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>

        <span class="c1"># 1) Determine who is currently on ART</span>
        <span class="n">worksheet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;art_coverage&quot;</span><span class="p">]</span>
        <span class="n">art_data</span> <span class="o">=</span> <span class="n">worksheet</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="mi">2010</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;single_age&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">,</span> <span class="s2">&quot;prop_coverage&quot;</span><span class="p">]</span>
        <span class="p">]</span>

        <span class="c1"># merge all susceptible individuals with their coverage probability based on sex and age</span>
        <span class="n">prob_art</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;age_years&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">art_data</span><span class="p">,</span>
            <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;age_years&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">],</span>
            <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;single_age&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">],</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
        <span class="p">)[</span><span class="s2">&quot;prop_coverage&quot;</span><span class="p">]</span>

        <span class="c1"># make a series with relative risks of art which depends on &gt;10 years infected (5x higher)</span>
        <span class="n">rr_art</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">rr_art</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_date_inf</span> <span class="o">&lt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">10</span><span class="p">)))</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rel_probability_art_baseline_aids&quot;</span><span class="p">]</span>

        <span class="c1"># Rescale relative probability of infection so that its average is 1.0 within each age/sex group</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;age_years&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;age_years&quot;</span><span class="p">],</span>
                <span class="s2">&quot;sex&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;sex&quot;</span><span class="p">],</span>
                <span class="s2">&quot;prob_art&quot;</span><span class="p">:</span> <span class="n">prob_art</span><span class="p">,</span>
                <span class="s2">&quot;rel_prob_art_by_time_infected&quot;</span><span class="p">:</span> <span class="n">rr_art</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;mean_of_rel_prob_within_age_sex_group&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;age_years&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">])[</span>
            <span class="s2">&quot;rel_prob_art_by_time_infected&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;scaled_rel_prob_by_time_infected&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rel_prob_art_by_time_infected&quot;</span><span class="p">]</span>
            <span class="o">/</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;mean_of_rel_prob_within_age_sex_group&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;overall_prob_of_art&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;scaled_rel_prob_by_time_infected&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prob_art&quot;</span><span class="p">]</span>
        <span class="n">random_draw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>

        <span class="n">art_idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span>
            <span class="p">(</span><span class="n">random_draw</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;overall_prob_of_art&quot;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span>
            <span class="p">]</span>

        <span class="c1"># 2) Determine adherence levels for those currently on ART, for each of adult men, adult women and children</span>
        <span class="n">adult_f_art_idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">art_idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;F&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">))</span>
        <span class="p">]</span><span class="o">.</span><span class="n">index</span>
        <span class="n">adult_m_art_idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">art_idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;M&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">))</span>
        <span class="p">]</span><span class="o">.</span><span class="n">index</span>
        <span class="n">child_art_idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">art_idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">))]</span><span class="o">.</span><span class="n">index</span>

        <span class="n">suppr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>  <span class="c1"># list of all indices for persons on ART and suppressed</span>
        <span class="n">notsuppr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>  <span class="c1"># list of all indices for persons on ART and not suppressed</span>

        <span class="k">def</span> <span class="nf">split_into_vl_and_notvl</span><span class="p">(</span><span class="n">all_idx</span><span class="p">,</span> <span class="n">prob</span><span class="p">):</span>
            <span class="n">vl_suppr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_idx</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">prob</span>
            <span class="n">suppr</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">all_idx</span><span class="p">[</span><span class="n">vl_suppr</span><span class="p">])</span>
            <span class="n">notsuppr</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">all_idx</span><span class="p">[</span><span class="o">~</span><span class="n">vl_suppr</span><span class="p">])</span>

        <span class="c1"># get expected viral suppression rates by age and year</span>
        <span class="n">prob_vs_adult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prob_viral_suppression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">age_of_person</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">prob_vs_child</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prob_viral_suppression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">age_of_person</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="n">split_into_vl_and_notvl</span><span class="p">(</span><span class="n">adult_f_art_idx</span><span class="p">,</span> <span class="n">prob_vs_adult</span><span class="p">)</span>
        <span class="n">split_into_vl_and_notvl</span><span class="p">(</span><span class="n">adult_m_art_idx</span><span class="p">,</span> <span class="n">prob_vs_adult</span><span class="p">)</span>
        <span class="n">split_into_vl_and_notvl</span><span class="p">(</span><span class="n">child_art_idx</span><span class="p">,</span> <span class="n">prob_vs_child</span><span class="p">)</span>

        <span class="c1"># Set ART status:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">suppr</span><span class="p">,</span> <span class="s2">&quot;hv_art&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;on_VL_suppressed&quot;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">notsuppr</span><span class="p">,</span> <span class="s2">&quot;hv_art&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;on_not_VL_suppressed&quot;</span>

        <span class="c1"># check that everyone on ART is labelled as such</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">art_idx</span><span class="p">,</span> <span class="s2">&quot;hv_art&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;not&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>

        <span class="c1"># for logical consistency, ensure that all persons on ART have been tested and diagnosed</span>
        <span class="c1"># set last test date prior to 2010 so not counted as a current new test</span>
        <span class="c1"># don&#39;t record individual property hv_number_tests for logging (occurred prior to 2010)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">art_idx</span><span class="p">,</span> <span class="s2">&quot;hv_last_test_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">art_idx</span><span class="p">,</span> <span class="s2">&quot;hv_diagnosed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># all those on ART need to have event scheduled for continuation/cessation of treatment</span>
        <span class="c1"># this window is 1-90 days (3-monthly prescribing)</span>
        <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">art_idx</span><span class="p">:</span>
            <span class="n">days</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;dispensation_period_months&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">30.5</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

            <span class="n">date_treated</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;dispensation_period_months&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">30.5</span><span class="p">)</span> <span class="o">-</span> <span class="n">days</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person</span><span class="p">,</span> <span class="s2">&quot;hv_date_treated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">date_treated</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;days&quot;</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person</span><span class="p">,</span> <span class="s2">&quot;hv_date_last_ART&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">date_treated</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;days&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
                <span class="n">Hiv_DecisionToContinueTreatment</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">days</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;days&quot;</span><span class="p">),</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Hiv.initialise_baseline_tested">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.initialise_baseline_tested">[docs]</a>
    <span class="k">def</span> <span class="nf">initialise_baseline_tested</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;assign initial hiv testing levels, only for adults</span>
<span class="sd">        all who have been allocated ART will already have property hv_diagnosed=True</span>
<span class="sd">        use the spectrum proportion PLHIV who know status to assign remaining tests</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>

        <span class="c1"># get proportion plhiv who know staus from spectum estimates</span>
        <span class="n">worksheet</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;treatment_cascade&quot;</span><span class="p">]</span>
        <span class="n">testing_data</span> <span class="o">=</span> <span class="n">worksheet</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="mi">2010</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;know_status&quot;</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">adult_know_status</span> <span class="o">=</span> <span class="n">testing_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">testing_data</span><span class="o">.</span><span class="n">age</span> <span class="o">==</span> <span class="s2">&quot;adults&quot;</span><span class="p">),</span> <span class="s2">&quot;know_status&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="n">children_know_status</span> <span class="o">=</span> <span class="n">testing_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">testing_data</span><span class="o">.</span><span class="n">age</span> <span class="o">==</span> <span class="s2">&quot;children&quot;</span><span class="p">),</span> <span class="s2">&quot;know_status&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>

        <span class="c1"># ADULTS</span>
        <span class="c1"># find proportion of adult PLHIV diagnosed (currently on ART)</span>
        <span class="n">adults_diagnosed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                                  <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_diagnosed</span>
                                  <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)])</span>

        <span class="n">adults_infected</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                                 <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span>
                                 <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)])</span>

        <span class="n">prop_currently_diagnosed</span> <span class="o">=</span> <span class="n">adults_diagnosed</span> <span class="o">/</span> <span class="n">adults_infected</span> <span class="k">if</span> <span class="n">adults_infected</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">hiv_test_deficit</span> <span class="o">=</span> <span class="n">adult_know_status</span> <span class="o">-</span> <span class="n">prop_currently_diagnosed</span>
        <span class="n">number_deficit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hiv_test_deficit</span> <span class="o">*</span> <span class="n">adults_infected</span><span class="p">)</span>

        <span class="n">adult_test_index</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">hiv_test_deficit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># sample number_deficit from remaining undiagnosed pop</span>
            <span class="n">adult_undiagnosed</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                                       <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span>
                                       <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">hv_diagnosed</span>
                                       <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span>

            <span class="n">adult_test_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">adult_undiagnosed</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">number_deficit</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># CHILDREN</span>
        <span class="c1"># find proportion of adult PLHIV diagnosed (currently on ART)</span>
        <span class="n">children_diagnosed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                                    <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_diagnosed</span>
                                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)])</span>

        <span class="n">children_infected</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                                   <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span>
                                   <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)])</span>

        <span class="n">prop_currently_diagnosed</span> <span class="o">=</span> <span class="n">children_diagnosed</span> <span class="o">/</span> <span class="n">children_infected</span> <span class="k">if</span> <span class="n">children_infected</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">hiv_test_deficit</span> <span class="o">=</span> <span class="n">children_know_status</span> <span class="o">-</span> <span class="n">prop_currently_diagnosed</span>
        <span class="n">number_deficit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hiv_test_deficit</span> <span class="o">*</span> <span class="n">children_infected</span><span class="p">)</span>

        <span class="n">child_test_index</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">hiv_test_deficit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">child_undiagnosed</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                                       <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span>
                                       <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">hv_diagnosed</span>
                                       <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span>

            <span class="n">child_test_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">child_undiagnosed</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">number_deficit</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># join indices</span>
        <span class="n">test_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">adult_test_index</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">child_test_index</span><span class="p">)</span>

        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">test_index</span><span class="p">),</span> <span class="s2">&quot;hv_diagnosed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># dummy date for date last hiv test (before sim start), otherwise see big spike in testing 01-01-2010</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test_index</span><span class="p">,</span> <span class="s2">&quot;hv_last_test_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span>
            <span class="n">years</span><span class="o">=</span><span class="mi">3</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Hiv.initialise_simulation">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.initialise_simulation">[docs]</a>
    <span class="k">def</span> <span class="nf">initialise_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        * 1) Schedule the Main HIV Regular Polling Event</span>
<span class="sd">        * 2) Schedule the Logging Event</span>
<span class="sd">        * 3) Determine who has AIDS and impose the Symptoms &#39;aids_symptoms&#39;</span>
<span class="sd">        * 4) Schedule the AIDS onset events and AIDS death event for those infected already</span>
<span class="sd">        * 5) (Optionally) Schedule the event to check the configuration of all properties</span>
<span class="sd">        * 6) Define the DxTests</span>
<span class="sd">        * 7) Look-up and save the codes for consumables</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>

        <span class="c1"># 1) Schedule the Main HIV Regular Polling Event</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
            <span class="n">HivRegularPollingEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># 2) Schedule the Logging Event</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">HivLoggingEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Optional: Schedule the scale-up of programs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;type_of_scaleup&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="n">scaleup_start_date</span> <span class="o">=</span> <span class="n">Date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;scaleup_start_year&quot;</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">scaleup_start_date</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">start_date</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Date </span><span class="si">{</span><span class="n">scaleup_start_date</span><span class="si">}</span><span class="s2"> is before simulation starts.&quot;</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span><span class="n">HivScaleUpEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">scaleup_start_date</span><span class="p">)</span>

        <span class="c1"># 3) Determine who has AIDS and impose the Symptoms &#39;aids_symptoms&#39;</span>

        <span class="c1"># Those on ART currently (will not get any further events scheduled):</span>
        <span class="n">on_art_idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_art</span> <span class="o">==</span> <span class="s2">&quot;on_VL_suppressed&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># Those that lived more than ten years and not currently on ART are assumed to currently have AIDS</span>
        <span class="c1">#  (will have AIDS Death event scheduled)</span>
        <span class="n">has_aids_idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
            <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span>
            <span class="o">&amp;</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_date_inf</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">365</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_art</span> <span class="o">!=</span> <span class="s2">&quot;on_VL_suppressed&quot;</span><span class="p">)</span>
            <span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># Those that are in neither category are &quot;before AIDS&quot; (will have AIDS Onset Event scheduled)</span>
        <span class="n">before_aids_idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">has_aids_idx</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">on_art_idx</span><span class="p">)</span>

        <span class="c1"># Impose the symptom to those that have AIDS (the symptom is the definition of having AIDS)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;SymptomManager&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">change_symptom</span><span class="p">(</span>
            <span class="n">person_id</span><span class="o">=</span><span class="n">has_aids_idx</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
            <span class="n">symptom_string</span><span class="o">=</span><span class="s2">&quot;aids_symptoms&quot;</span><span class="p">,</span>
            <span class="n">add_or_remove</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
            <span class="n">disease_module</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># 4) Schedule the AIDS onset events and AIDS death event for those infected already</span>
        <span class="c1"># AIDS Onset Event for those who are infected but not yet AIDS and have not ever started ART</span>
        <span class="c1"># NB. This means that those on ART at the start of the simulation may not have an AIDS event --</span>
        <span class="c1"># like it happened at some point in the past</span>
        <span class="n">scale</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time_from_infection_to_aids_distribution_parameters</span><span class="p">(</span><span class="n">before_aids_idx</span><span class="p">)</span>
        <span class="n">days_infection_to_aids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_from_infection_to_aids_given_parameters</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
        <span class="n">days_since_infection</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">before_aids_idx</span><span class="p">,</span> <span class="s2">&quot;hv_date_inf&quot;</span><span class="p">])</span>
        <span class="c1"># If any days_since_infection &gt;= days_infection_to_aids are negative resample</span>
        <span class="c1"># these values until all are positive</span>
        <span class="n">days_until_aids_is_negative</span> <span class="o">=</span> <span class="n">days_since_infection</span> <span class="o">&gt;=</span> <span class="n">days_infection_to_aids</span>
        <span class="k">while</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">days_until_aids_is_negative</span><span class="p">):</span>
            <span class="n">days_infection_to_aids</span><span class="p">[</span><span class="n">days_until_aids_is_negative</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_from_infection_to_aids_given_parameters</span><span class="p">(</span>
                    <span class="n">scale</span><span class="p">[</span><span class="n">days_until_aids_is_negative</span><span class="p">],</span>
                    <span class="n">shape</span><span class="p">[</span><span class="n">days_until_aids_is_negative</span><span class="p">],</span>
                    <span class="n">offset</span><span class="p">[</span><span class="n">days_until_aids_is_negative</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">days_until_aids_is_negative</span> <span class="o">=</span> <span class="n">days_since_infection</span> <span class="o">&gt;=</span> <span class="n">days_infection_to_aids</span>
        <span class="n">days_until_aids</span> <span class="o">=</span> <span class="n">days_infection_to_aids</span> <span class="o">-</span> <span class="n">days_since_infection</span>
        <span class="n">date_onset_aids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">days_until_aids</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">date</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">before_aids_idx</span><span class="p">,</span> <span class="n">date_onset_aids</span><span class="p">):</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
                <span class="n">HivAidsOnsetEvent</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">cause</span><span class="o">=</span><span class="s1">&#39;AIDS_non_TB&#39;</span><span class="p">),</span>
                <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Schedule the AIDS death events for those who have got AIDS already</span>
        <span class="k">for</span> <span class="n">person_id</span> <span class="ow">in</span> <span class="n">has_aids_idx</span><span class="p">:</span>
            <span class="c1"># schedule a HSI_Test_and_Refer otherwise initial AIDS rates and deaths are far too high</span>
            <span class="n">date_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">60</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">hsi_event</span><span class="o">=</span><span class="n">HSI_Hiv_TestAndRefer</span><span class="p">(</span>
                    <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">referred_from</span><span class="o">=</span><span class="s2">&quot;initialise_simulation&quot;</span><span class="p">),</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">topen</span><span class="o">=</span><span class="n">date_test</span><span class="p">,</span>
                <span class="n">tclose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">365</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="n">date_aids_death</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span>
                <span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;mean_months_between_aids_and_death&#39;</span><span class="p">]))</span>
            <span class="p">)</span>

            <span class="c1"># 30% AIDS deaths have TB co-infection</span>
            <span class="n">cause_of_death</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;AIDS_non_TB&quot;</span><span class="p">,</span> <span class="s2">&quot;AIDS_TB&quot;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">])</span>

            <span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
                <span class="n">HivAidsDeathEvent</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">cause</span><span class="o">=</span><span class="n">cause_of_death</span><span class="p">),</span>
                <span class="n">date</span><span class="o">=</span><span class="n">date_aids_death</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># schedule hospital stay for end of life care if untreated</span>
            <span class="n">beddays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span>
                <span class="n">low</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;length_of_inpatient_stay_if_terminal&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">high</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;length_of_inpatient_stay_if_terminal&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">date_admission</span> <span class="o">=</span> <span class="n">date_aids_death</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">beddays</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">hsi_event</span><span class="o">=</span><span class="n">HSI_Hiv_EndOfLifeCare</span><span class="p">(</span>
                    <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">beddays</span><span class="o">=</span><span class="n">beddays</span>
                <span class="p">),</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">topen</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">date_admission</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">date_admission</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
                    <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># 5) (Optionally) Schedule the event to check the configuration of all properties</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_with_checks</span><span class="p">:</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
                <span class="n">HivCheckPropertiesEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># 6) Store codes for the consumables needed</span>
        <span class="n">hs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span>

        <span class="c1"># updated consumables listing</span>
        <span class="c1"># blood tube and gloves are optional items</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;hiv_rapid_test&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">hs</span><span class="o">.</span><span class="n">get_item_code_from_item_name</span><span class="p">(</span><span class="s2">&quot;Test, HIV EIA Elisa&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;hiv_early_infant_test&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">hs</span><span class="o">.</span><span class="n">get_item_code_from_item_name</span><span class="p">(</span><span class="s2">&quot;Test, HIV EIA Elisa&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;blood_tube&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">hs</span><span class="o">.</span><span class="n">get_item_code_from_item_name</span><span class="p">(</span><span class="s2">&quot;Blood collecting tube, 5 ml&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;gloves&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">hs</span><span class="o">.</span><span class="n">get_item_code_from_item_name</span><span class="p">(</span><span class="s2">&quot;Disposables gloves, powder free, 100 pieces per box&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;vl_measurement&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">hs</span><span class="o">.</span><span class="n">get_item_codes_from_package_name</span><span class="p">(</span><span class="s2">&quot;Viral Load&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;circ&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">hs</span><span class="o">.</span><span class="n">get_item_codes_from_package_name</span><span class="p">(</span><span class="s2">&quot;Male circumcision &quot;</span><span class="p">)</span>

        <span class="c1"># adult prep: 1 tablet daily</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;prep&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">hs</span><span class="o">.</span><span class="n">get_item_code_from_item_name</span><span class="p">(</span><span class="s2">&quot;Tenofovir (TDF)/Emtricitabine (FTC), tablet, 300/200 mg&quot;</span><span class="p">)</span>

        <span class="c1"># infant NVP 1.5mg daily for birth weight 2500g or above, for 6 weeks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;infant_prep&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">hs</span><span class="o">.</span><span class="n">get_item_code_from_item_name</span><span class="p">(</span><span class="s2">&quot;Nevirapine, oral solution, 10 mg/ml&quot;</span><span class="p">)</span>

        <span class="c1"># First - line ART for adults(age &gt; &quot;ART_age_cutoff_older_child&quot;)</span>
        <span class="c1"># TDF/3TC/DTG 120/60/50mg, 1 tablet per day</span>
        <span class="c1"># cotrim adult tablet, 1 tablet per day, units specified in mg * dispensation days</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;First-line ART regimen: adult&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">hs</span><span class="o">.</span><span class="n">get_item_code_from_item_name</span><span class="p">(</span><span class="s2">&quot;First-line ART regimen: adult&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;First-line ART regimen: adult: cotrimoxazole&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">hs</span><span class="o">.</span><span class="n">get_item_code_from_item_name</span><span class="p">(</span><span class="s2">&quot;Cotrimoxizole, 960mg pppy&quot;</span><span class="p">)</span>

        <span class="c1"># ART for older children aged (&quot;ART_age_cutoff_younger_child&quot; &lt; age &lt;= &quot;ART_age_cutoff_older_child&quot;):</span>
        <span class="c1"># ABC/3TC/DTG 120/60/50mg, 3 tablets per day</span>
        <span class="c1"># cotrim paediatric tablet, 4 tablets per day, units specified in mg * dispensation days</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;First line ART regimen: older child&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">hs</span><span class="o">.</span><span class="n">get_item_code_from_item_name</span><span class="p">(</span><span class="s2">&quot;First line ART regimen: older child&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;First line ART regimen: older child: cotrimoxazole&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">hs</span><span class="o">.</span><span class="n">get_item_code_from_item_name</span><span class="p">(</span><span class="s2">&quot;Cotrimoxazole 120mg_1000_CMST&quot;</span><span class="p">)</span>

        <span class="c1"># ART for younger children aged (age &lt; &quot;ART_age_cutoff_younger_child&quot;):</span>
        <span class="c1"># ABC/3TC/DTG 120/60/10mg, 2 tablets per day</span>
        <span class="c1"># cotrim paediatric tablet, 2 tablets per day, units specified in mg * dispensation days</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;First line ART regimen: young child&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">hs</span><span class="o">.</span><span class="n">get_item_code_from_item_name</span><span class="p">(</span><span class="s2">&quot;First line ART regimen: young child&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;First line ART regimen: young child: cotrimoxazole&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">hs</span><span class="o">.</span><span class="n">get_item_code_from_item_name</span><span class="p">(</span><span class="s2">&quot;Cotrimoxazole 120mg_1000_CMST&quot;</span><span class="p">)</span>

        <span class="c1"># 7) Define the DxTests</span>
        <span class="c1"># HIV Rapid Diagnostic Test:</span>
        <span class="c1"># NB. The rapid test is assumed to be 100% specific and sensitive. This is used to guarantee that all persons</span>
        <span class="c1">#  that start ART are truly HIV-pos.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">register_dx_test</span><span class="p">(</span>
            <span class="n">hiv_rapid_test</span><span class="o">=</span><span class="n">DxTest</span><span class="p">(</span>
                <span class="nb">property</span><span class="o">=</span><span class="s1">&#39;hv_inf&#39;</span><span class="p">,</span>
                <span class="n">item_codes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;hiv_rapid_test&#39;</span><span class="p">],</span>
                <span class="n">optional_item_codes</span><span class="o">=</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;blood_tube&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;gloves&#39;</span><span class="p">]]</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Test for Early Infect Diagnosis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">register_dx_test</span><span class="p">(</span>
            <span class="n">hiv_early_infant_test</span><span class="o">=</span><span class="n">DxTest</span><span class="p">(</span>
                <span class="nb">property</span><span class="o">=</span><span class="s1">&#39;hv_inf&#39;</span><span class="p">,</span>
                <span class="n">sensitivity</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="n">specificity</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="n">item_codes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;hiv_early_infant_test&#39;</span><span class="p">],</span>
                <span class="n">optional_item_codes</span><span class="o">=</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;blood_tube&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;gloves&#39;</span><span class="p">]]</span>
            <span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Hiv.update_parameters_for_program_scaleup">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.update_parameters_for_program_scaleup">[docs]</a>
    <span class="k">def</span> <span class="nf">update_parameters_for_program_scaleup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; options for program scale-up are &#39;target&#39; or &#39;max&#39; &quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">scaled_params_workbook</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;scaleup_parameters&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;type_of_scaleup&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;target&#39;</span><span class="p">:</span>
            <span class="n">scaled_params</span> <span class="o">=</span> <span class="n">scaled_params_workbook</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;parameter&#39;</span><span class="p">)[</span><span class="s1">&#39;target_value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scaled_params</span> <span class="o">=</span> <span class="n">scaled_params_workbook</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;parameter&#39;</span><span class="p">)[</span><span class="s1">&#39;max_value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="c1"># scale-up HIV program</span>
        <span class="c1"># reduce risk of HIV - applies to whole adult population</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">scaled_params</span><span class="p">[</span><span class="s2">&quot;reduction_in_hiv_beta&quot;</span><span class="p">]</span>

        <span class="c1"># increase PrEP coverage for FSW after HIV test</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prob_prep_for_fsw_after_hiv_test&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaled_params</span><span class="p">[</span><span class="s2">&quot;prob_prep_for_fsw_after_hiv_test&quot;</span><span class="p">]</span>

        <span class="c1"># prep poll for AGYW - target to the highest risk</span>
        <span class="c1"># increase retention to 75% for FSW and AGYW</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prob_prep_for_agyw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaled_params</span><span class="p">[</span><span class="s2">&quot;prob_prep_for_agyw&quot;</span><span class="p">]</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;probability_of_being_retained_on_prep_every_3_months&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaled_params</span><span class="p">[</span><span class="s2">&quot;probability_of_being_retained_on_prep_every_3_months&quot;</span><span class="p">]</span>

        <span class="c1"># perfect retention on ART</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;probability_of_being_retained_on_art_every_3_months&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaled_params</span><span class="p">[</span><span class="s2">&quot;probability_of_being_retained_on_art_every_3_months&quot;</span><span class="p">]</span>

        <span class="c1"># increase probability of VMMC after hiv test</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prob_circ_after_hiv_test&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaled_params</span><span class="p">[</span><span class="s2">&quot;prob_circ_after_hiv_test&quot;</span><span class="p">]</span>

        <span class="c1"># increase testing/diagnosis rates, default 2020 0.03/0.25 -&gt; 93% dx</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;hiv_testing_rates&quot;</span><span class="p">][</span><span class="s2">&quot;annual_testing_rate_adults&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaled_params</span><span class="p">[</span><span class="s2">&quot;annual_testing_rate_adults&quot;</span><span class="p">]</span>

        <span class="c1"># ANC testing - value for mothers and infants testing</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prob_hiv_test_at_anc_or_delivery&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaled_params</span><span class="p">[</span><span class="s2">&quot;prob_hiv_test_at_anc_or_delivery&quot;</span><span class="p">]</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prob_hiv_test_for_newborn_infant&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaled_params</span><span class="p">[</span><span class="s2">&quot;prob_hiv_test_for_newborn_infant&quot;</span><span class="p">]</span>

        <span class="c1"># viral suppression rates</span>
        <span class="c1"># adults already at 95% by 2020</span>
        <span class="c1"># change all column values</span>
        <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prob_start_art_or_vs&quot;</span><span class="p">][</span><span class="s2">&quot;virally_suppressed_on_art&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaled_params</span><span class="p">[</span><span class="s2">&quot;virally_suppressed_on_art&quot;</span><span class="p">]</span>

        <span class="c1"># update exising linear models to use new scaled-up paramters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_linear_models</span><span class="p">()</span></div>


<div class="viewcode-block" id="Hiv.on_birth">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.on_birth">[docs]</a>
    <span class="k">def</span> <span class="nf">on_birth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mother_id</span><span class="p">,</span> <span class="n">child_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        * Initialise our properties for a newborn individual;</span>
<span class="sd">        * schedule testing;</span>
<span class="sd">        * schedule infection during breastfeeding</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="c1"># Default Settings:</span>
        <span class="c1"># --- Current status</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;hv_inf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;hv_art&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;not&quot;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;hv_on_cotrimoxazole&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;hv_is_on_prep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;hv_behaviour_change&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;hv_diagnosed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;hv_number_tests&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># --- Dates on which things have happened</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;hv_date_inf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;hv_last_test_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;hv_date_treated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;hv_date_last_ART&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>

        <span class="c1"># ----------------------------------- MTCT - AT OR PRIOR TO BIRTH --------------------------</span>
        <span class="c1">#  DETERMINE IF THE CHILD IS INFECTED WITH HIV FROM THEIR MOTHER DURING PREGNANCY / DELIVERY</span>
        <span class="n">mother</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">mother_id</span><span class="p">)]</span>  <span class="c1"># Not interested whether true or direct birth</span>

        <span class="n">mother_infected_prior_to_pregnancy</span> <span class="o">=</span> <span class="n">mother</span><span class="o">.</span><span class="n">hv_inf</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">mother</span><span class="o">.</span><span class="n">hv_date_inf</span> <span class="o">&lt;=</span> <span class="n">mother</span><span class="o">.</span><span class="n">date_of_last_pregnancy</span>
        <span class="p">)</span>
        <span class="n">mother_infected_during_pregnancy</span> <span class="o">=</span> <span class="n">mother</span><span class="o">.</span><span class="n">hv_inf</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">mother</span><span class="o">.</span><span class="n">hv_date_inf</span> <span class="o">&gt;</span> <span class="n">mother</span><span class="o">.</span><span class="n">date_of_last_pregnancy</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">mother_infected_prior_to_pregnancy</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mother</span><span class="o">.</span><span class="n">hv_art</span> <span class="o">==</span> <span class="s2">&quot;on_VL_suppressed&quot;</span><span class="p">:</span>
                <span class="c1">#  mother has existing infection, mother ON ART and VL suppressed at time of delivery</span>
                <span class="n">child_infected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prob_mtct_treated&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># mother was infected prior to pregnancy but is not on VL suppressed at time of delivery</span>
                <span class="n">child_infected</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prob_mtct_untreated&quot;</span><span class="p">]</span>
                <span class="p">)</span>

        <span class="k">elif</span> <span class="n">mother_infected_during_pregnancy</span><span class="p">:</span>
            <span class="c1">#  mother has incident infection during pregnancy, NO ART</span>
            <span class="n">child_infected</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prob_mtct_incident_preg&quot;</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># mother is not infected</span>
            <span class="n">child_infected</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">child_infected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_new_infection</span><span class="p">(</span><span class="n">child_id</span><span class="p">)</span>

        <span class="c1"># ----------------------------------- MTCT - DURING BREASTFEEDING --------------------------</span>
        <span class="c1"># If child is not infected and is being breastfed, then expose them to risk of MTCT through breastfeeding</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="p">(</span><span class="ow">not</span> <span class="n">child_infected</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;nb_breastfeeding_status&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;none&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">mother</span><span class="o">.</span><span class="n">hv_inf</span>
        <span class="p">):</span>
            <span class="c1"># Pass mother&#39;s id, whether from true or direct birth</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mtct_during_breastfeeding</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">mother_id</span><span class="p">),</span> <span class="n">child_id</span><span class="p">)</span>

        <span class="c1"># ----------------------------------- HIV testing --------------------------</span>
        <span class="k">if</span> <span class="s2">&quot;CareOfWomenDuringPregnancy&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
            <span class="c1"># if mother&#39;s HIV status not known, schedule test at delivery</span>
            <span class="c1"># usually performed by care_of_women_during_pregnancy module</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mother</span><span class="o">.</span><span class="n">hv_diagnosed</span> <span class="ow">and</span> \
                <span class="n">mother</span><span class="o">.</span><span class="n">is_alive</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prob_hiv_test_at_anc_or_delivery&quot;</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                    <span class="n">hsi_event</span><span class="o">=</span><span class="n">HSI_Hiv_TestAndRefer</span><span class="p">(</span>
                        <span class="n">person_id</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">mother_id</span><span class="p">),</span>  <span class="c1"># Pass mother&#39;s id, whether from true or direct birth</span>
                        <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">referred_from</span><span class="o">=</span><span class="s1">&#39;ANC_routine&#39;</span><span class="p">),</span>
                    <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                    <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># if mother known HIV+, schedule virological test for infant and give prep</span>
        <span class="k">if</span> <span class="n">mother</span><span class="o">.</span><span class="n">hv_diagnosed</span> <span class="ow">and</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;is_alive&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">hsi_event</span><span class="o">=</span><span class="n">HSI_Hiv_StartInfantProphylaxis</span><span class="p">(</span>
                    <span class="n">person_id</span><span class="o">=</span><span class="n">child_id</span><span class="p">,</span>
                    <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">referred_from</span><span class="o">=</span><span class="s2">&quot;on_birth&quot;</span><span class="p">,</span>
                    <span class="n">repeat_visits</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;newborn_outcomes&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;prob_hiv_test_for_newborn_infant&#39;</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                    <span class="n">hsi_event</span><span class="o">=</span><span class="n">HSI_Hiv_TestAndRefer</span><span class="p">(</span>
                        <span class="n">person_id</span><span class="o">=</span><span class="n">child_id</span><span class="p">,</span>
                        <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">referred_from</span><span class="o">=</span><span class="s1">&#39;Infant_testing&#39;</span><span class="p">),</span>
                    <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">weeks</span><span class="o">=</span><span class="mi">6</span><span class="p">),</span>
                    <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># these later infant tests are not in newborn_outcomes</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;prob_hiv_test_for_newborn_infant&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                    <span class="n">hsi_event</span><span class="o">=</span><span class="n">HSI_Hiv_TestAndRefer</span><span class="p">(</span>
                        <span class="n">person_id</span><span class="o">=</span><span class="n">child_id</span><span class="p">,</span>
                        <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">referred_from</span><span class="o">=</span><span class="s1">&#39;Infant_testing&#39;</span><span class="p">),</span>
                    <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">9</span><span class="p">),</span>
                    <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                    <span class="n">hsi_event</span><span class="o">=</span><span class="n">HSI_Hiv_TestAndRefer</span><span class="p">(</span>
                        <span class="n">person_id</span><span class="o">=</span><span class="n">child_id</span><span class="p">,</span>
                        <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">referred_from</span><span class="o">=</span><span class="s1">&#39;Infant_testing&#39;</span><span class="p">),</span>
                    <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">18</span><span class="p">),</span>
                    <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span></div>


<div class="viewcode-block" id="Hiv.report_daly_values">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.report_daly_values">[docs]</a>
    <span class="k">def</span> <span class="nf">report_daly_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Report DALYS for HIV, based on current symptomatic state of persons.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="n">dalys</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="c1"># All those infected get the &#39;infected but not AIDS&#39; daly_wt:</span>
        <span class="n">dalys</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">daly_wts</span><span class="p">[</span><span class="s2">&quot;hiv_infection_but_not_aids&quot;</span><span class="p">]</span>

        <span class="c1"># Overwrite the value for those that currently have symptoms of AIDS with the &#39;AIDS&#39; daly_wt:</span>
        <span class="n">dalys</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;SymptomManager&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">who_has</span><span class="p">(</span><span class="s2">&quot;aids_symptoms&quot;</span><span class="p">)</span>
        <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">daly_wts</span><span class="p">[</span><span class="s2">&quot;aids&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">dalys</span></div>


<div class="viewcode-block" id="Hiv.mtct_during_breastfeeding">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.mtct_during_breastfeeding">[docs]</a>
    <span class="k">def</span> <span class="nf">mtct_during_breastfeeding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mother_id</span><span class="p">,</span> <span class="n">child_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute risk of mother-to-child transmission and schedule HivInfectionDuringBreastFeedingEvent.</span>
<span class="sd">        If the child is breastfeeding currently, consider the time-until-infection assuming a constantly monthly risk of</span>
<span class="sd">         transmission. If the breastfeeding has ceased by the time of the scheduled infection, then it will not run.</span>
<span class="sd">        (This means that this event can be run at birth or at the time of the mother&#39;s infection without the need for</span>
<span class="sd">        further polling etc.)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>

        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">mother_id</span><span class="p">,</span> <span class="s2">&quot;hv_art&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;on_VL_suppressed&quot;</span><span class="p">:</span>
            <span class="n">monthly_prob_mtct_bf</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;monthly_prob_mtct_bf_treated&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">monthly_prob_mtct_bf</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;monthly_prob_mtct_bf_untreated&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">monthly_prob_mtct_bf</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">months_to_infection</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">monthly_prob_mtct_bf</span><span class="p">))</span>
            <span class="n">date_of_infection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span>
                <span class="n">months</span><span class="o">=</span><span class="n">months_to_infection</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
                <span class="n">HivInfectionDuringBreastFeedingEvent</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">child_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="p">),</span>
                <span class="n">date_of_infection</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Hiv.do_new_infection">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.do_new_infection">[docs]</a>
    <span class="k">def</span> <span class="nf">do_new_infection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enact that this person is infected with HIV</span>
<span class="sd">        * Update their hv_inf status and hv_date_inf</span>
<span class="sd">        * Schedule the AIDS onset event for this person</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="c1"># Update HIV infection status for this person</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_inf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_date_inf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>

        <span class="c1"># Schedule AIDS onset events for this person</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time_from_infection_to_aids_distribution_parameters</span><span class="p">(</span>
            <span class="p">[</span><span class="n">person_id</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">date_onset_aids</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_from_infection_to_aids_given_parameters</span><span class="p">(</span><span class="o">*</span><span class="n">parameters</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
            <span class="n">event</span><span class="o">=</span><span class="n">HivAidsOnsetEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">cause</span><span class="o">=</span><span class="s1">&#39;AIDS_non_TB&#39;</span><span class="p">),</span>
            <span class="n">date</span><span class="o">=</span><span class="n">date_onset_aids</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Hiv.sample_time_from_infection_to_aids_given_parameters">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.sample_time_from_infection_to_aids_given_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">sample_time_from_infection_to_aids_given_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate time(s) between onset of infection and AIDS as Pandas time deltas.</span>

<span class="sd">        The times are generated from translated Weibull distributions discretised to</span>
<span class="sd">        an integer number of months.</span>

<span class="sd">        :param scale: Scale parameters of Weibull distributions (unit: years).</span>
<span class="sd">        :param shape: Shape parameters of Weibull distributions.</span>
<span class="sd">        :param offset: Offset to (negatively) shift Weibull variable by (unit: months).</span>

<span class="sd">        :return: Generated time deltas.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">months_to_death</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">weibull</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span> <span class="o">*</span> <span class="mi">12</span>
        <span class="n">months_to_aids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">months_to_death</span> <span class="o">-</span> <span class="n">offset</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">months_to_aids</span> <span class="o">*</span> <span class="mf">30.5</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Hiv.get_time_from_infection_to_aids_distribution_parameters">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.get_time_from_infection_to_aids_distribution_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">get_time_from_infection_to_aids_distribution_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_ids</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute per-person parameters of distribution of time from infection to aids.</span>

<span class="sd">        Evaluates three linear models which output age specific scale, shape and offset</span>
<span class="sd">        parameters for the (translated) Weibull distribution used to generate the time</span>
<span class="sd">        from infection to aids for an individual.</span>

<span class="sd">        For those infected prior to, or at, birth, a Weibull distribution with shape</span>
<span class="sd">        parameter 1 (equivalent to an exponential distribution) is used.</span>

<span class="sd">        For those infected after birth a Weibull distribution with both shape and</span>
<span class="sd">        scale depending on age is used.</span>

<span class="sd">        :param person_ids: Iterable of ID indices of individuals to get parameters for.</span>

<span class="sd">        :return: Per-person parameters as a 3-tuple ``(scale, shape, offset)`` of</span>
<span class="sd">            ``pandas.Series`` objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subpopulation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_ids</span><span class="p">]</span>
        <span class="c1"># get the scale parameters (unit: years)</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s2">&quot;scale_parameter_for_infection_to_death&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">subpopulation</span><span class="p">)</span>
        <span class="c1"># get the shape parameter</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s2">&quot;shape_parameter_for_infection_to_death&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">subpopulation</span><span class="p">)</span>
        <span class="c1"># get the mean months between aids and death (unit: months)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s2">&quot;offset_parameter_for_months_from_aids_to_death&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
            <span class="n">subpopulation</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">scale</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">offset</span></div>


<div class="viewcode-block" id="Hiv.get_time_from_aids_to_death">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.get_time_from_aids_to_death">[docs]</a>
    <span class="k">def</span> <span class="nf">get_time_from_aids_to_death</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gives time between onset of AIDS and death, returning a pd.DateOffset.</span>
<span class="sd">        Assumes that the time between onset of AIDS symptoms and deaths is exponentially distributed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;mean_months_between_aids_and_death&quot;</span><span class="p">]</span>
        <span class="n">draw_number_of_months</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="n">mean</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="p">(</span><span class="n">draw_number_of_months</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span></div>


<div class="viewcode-block" id="Hiv.do_when_hiv_diagnosed">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.do_when_hiv_diagnosed">[docs]</a>
    <span class="k">def</span> <span class="nf">do_when_hiv_diagnosed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Things to do when a person has been tested and found (newly) to be HIV-positive:.</span>
<span class="sd">        * Consider if ART should be initiated, and schedule HSI if so.</span>
<span class="sd">        The person should not yet be on ART.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_art&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;not&quot;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="n">key</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="s2">&quot;This event should not be running. do_when_diagnosed is for newly diagnosed persons.&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Consider if the person will be referred to start ART</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;age_years&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">:</span>
            <span class="n">starts_art</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">starts_art</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">prob_art_start_after_test</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">starts_art</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">HSI_Hiv_StartOrContinueTreatment</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                                                 <span class="n">facility_level_of_this_hsi</span><span class="o">=</span><span class="s2">&quot;1a&quot;</span><span class="p">),</span>
                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Hiv.prob_art_start_after_test">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.prob_art_start_after_test">[docs]</a>
    <span class="k">def</span> <span class="nf">prob_art_start_after_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; returns the probability of starting ART after a positive HIV test</span>
<span class="sd">        this value for initiation can be higher than the current reported coverage levels</span>
<span class="sd">        to account for defaulters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prob_art</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;prob_start_art_or_vs&quot;</span><span class="p">]</span>
        <span class="n">current_year</span> <span class="o">=</span> <span class="n">year</span> <span class="k">if</span> <span class="n">year</span> <span class="o">&lt;=</span> <span class="mi">2025</span> <span class="k">else</span> <span class="mi">2025</span>

        <span class="c1"># use iloc to index by position as index will change by year</span>
        <span class="n">return_prob</span> <span class="o">=</span> <span class="n">prob_art</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                          <span class="p">(</span><span class="n">prob_art</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">current_year</span><span class="p">)</span> <span class="o">&amp;</span>
                          <span class="p">(</span><span class="n">prob_art</span><span class="o">.</span><span class="n">age</span> <span class="o">==</span> <span class="s2">&quot;adults&quot;</span><span class="p">),</span>
                          <span class="s2">&quot;prob_art_if_dx&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;treatment_initiation_adjustment&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">return_prob</span></div>


<div class="viewcode-block" id="Hiv.prob_viral_suppression">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.prob_viral_suppression">[docs]</a>
    <span class="k">def</span> <span class="nf">prob_viral_suppression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">age_of_person</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; returns the probability of viral suppression once on ART</span>
<span class="sd">        data from 2012 - 2020 from spectrum</span>
<span class="sd">        assume constant values 2010-2012 and 2020 on</span>
<span class="sd">        time-series ends at 2025</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prob_vs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;prob_start_art_or_vs&quot;</span><span class="p">]</span>
        <span class="n">current_year</span> <span class="o">=</span> <span class="n">year</span> <span class="k">if</span> <span class="n">year</span> <span class="o">&lt;=</span> <span class="mi">2025</span> <span class="k">else</span> <span class="mi">2025</span>
        <span class="n">age_of_person</span> <span class="o">=</span> <span class="n">age_of_person</span>
        <span class="n">age_group</span> <span class="o">=</span> <span class="s2">&quot;adults&quot;</span> <span class="k">if</span> <span class="n">age_of_person</span> <span class="o">&gt;=</span> <span class="mi">15</span> <span class="k">else</span> <span class="s2">&quot;children&quot;</span>

        <span class="n">return_prob</span> <span class="o">=</span> <span class="n">prob_vs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">prob_vs</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">current_year</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">prob_vs</span><span class="o">.</span><span class="n">age</span> <span class="o">==</span> <span class="n">age_group</span><span class="p">),</span>
            <span class="s2">&quot;virally_suppressed_on_art&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># convert to probability and adjust for defaulters</span>
        <span class="n">return_prob</span> <span class="o">=</span> <span class="p">(</span><span class="n">return_prob</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;vs_adjustment&quot;</span><span class="p">]</span>

        <span class="k">assert</span> <span class="n">return_prob</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">return_prob</span></div>


<div class="viewcode-block" id="Hiv.stops_treatment">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.stops_treatment">[docs]</a>
    <span class="k">def</span> <span class="nf">stops_treatment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper function that is called when someone stops being on ART.</span>
<span class="sd">        Sets the flag for ART status. If the person was already on ART, it schedules a new AIDSEvent</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="c1"># Schedule a new AIDS onset event if the person was on ART up until now</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_art&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;on_VL_suppressed&quot;</span><span class="p">:</span>
            <span class="n">months_to_aids</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span>
                        <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;art_default_to_aids_mean_years&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="o">*</span> <span class="mf">12.0</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
                <span class="n">event</span><span class="o">=</span><span class="n">HivAidsOnsetEvent</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">cause</span><span class="o">=</span><span class="s1">&#39;AIDS_non_TB&#39;</span><span class="p">),</span>
                <span class="n">date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="n">months_to_aids</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># Set that the person is no longer on ART or cotrimoxazole</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_art&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;not&quot;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_on_cotrimoxazole&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Hiv.per_capita_testing_rate">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.per_capita_testing_rate">[docs]</a>
    <span class="k">def</span> <span class="nf">per_capita_testing_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This calculates the numbers of hiv tests performed in each time period.</span>
<span class="sd">        It looks at the cumulative number of tests ever performed and subtracts the</span>
<span class="sd">        number calculated at the last time point.</span>
<span class="sd">        Values are converted to per capita testing rates.</span>
<span class="sd">        This function is called by the logger and can be called at any frequency</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="c1"># get number of tests performed in last time period</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="mi">2011</span><span class="p">:</span>
            <span class="n">number_tests_new</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_number_tests</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">previous_test_numbers</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">previous_test_numbers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stored_test_numbers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># calculate number of tests now performed - cumulative, include those who have died</span>
            <span class="n">number_tests_new</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_number_tests</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stored_test_numbers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">number_tests_new</span><span class="p">)</span>

        <span class="c1"># number of tests performed in last time period</span>
        <span class="n">number_tests_in_last_period</span> <span class="o">=</span> <span class="n">number_tests_new</span> <span class="o">-</span> <span class="n">previous_test_numbers</span>

        <span class="c1"># per-capita testing rate</span>
        <span class="n">per_capita_testing</span> <span class="o">=</span> <span class="n">number_tests_in_last_period</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">])</span>

        <span class="c1"># return updated value for time-period</span>
        <span class="k">return</span> <span class="n">per_capita_testing</span></div>


<div class="viewcode-block" id="Hiv.decide_whether_hiv_test_for_mother">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.decide_whether_hiv_test_for_mother">[docs]</a>
    <span class="k">def</span> <span class="nf">decide_whether_hiv_test_for_mother</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">referred_from</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This will return a True/False for whether an HIV test should be scheduled for a mother; and schedule the HIV</span>
<span class="sd">        Test if a test should be scheduled.</span>
<span class="sd">        This is called from `labour.py` under `interventions_delivered_pre_discharge` and</span>
<span class="sd">        `care_of_women_during_pregnancy.py`.</span>
<span class="sd">        Mothers who are not already diagnosed will have an HIV test with a certain probability defined by a parameter;</span>
<span class="sd">         mothers who are diagnosed already will not have another HIV test.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s1">&#39;hv_diagnosed&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;prob_hiv_test_at_anc_or_delivery&#39;</span><span class="p">]):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;HealthSystem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">HSI_Hiv_TestAndRefer</span><span class="p">(</span>
                    <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span>
                    <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">referred_from</span><span class="o">=</span><span class="n">referred_from</span><span class="p">),</span>
                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Hiv.decide_whether_hiv_test_for_infant">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.decide_whether_hiv_test_for_infant">[docs]</a>
    <span class="k">def</span> <span class="nf">decide_whether_hiv_test_for_infant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mother_id</span><span class="p">,</span> <span class="n">child_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; This will schedule an HIV testing HSI for a child under certain conditions.</span>
<span class="sd">        It is called from newborn_outcomes.py under hiv_screening_for_at_risk_newborns.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">mother_id</span> <span class="o">=</span> <span class="n">mother_id</span>
        <span class="n">child_id</span> <span class="o">=</span> <span class="n">child_id</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;hv_diagnosed&quot;</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">mother_id</span><span class="p">,</span> <span class="s2">&quot;hv_diagnosed&quot;</span><span class="p">]</span>
            <span class="ow">and</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child_id</span><span class="p">,</span> <span class="s2">&quot;nb_pnc_check&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;prob_hiv_test_for_newborn_infant&quot;</span><span class="p">])</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">HSI_Hiv_TestAndRefer</span><span class="p">(</span>
                    <span class="n">person_id</span><span class="o">=</span><span class="n">child_id</span><span class="p">,</span>
                    <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">referred_from</span><span class="o">=</span><span class="s2">&quot;newborn_outcomes&quot;</span><span class="p">),</span>
                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">weeks</span><span class="o">=</span><span class="mi">6</span><span class="p">),</span>
                <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Hiv.check_config_of_properties">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.check_config_of_properties">[docs]</a>
    <span class="k">def</span> <span class="nf">check_config_of_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;check that the properties are currently configured correctly&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">df_alive</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">]</span>

        <span class="c1"># basic check types of columns and dtypes</span>
        <span class="n">orig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">new_row</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dtypes</span> <span class="o">==</span> <span class="n">orig</span><span class="o">.</span><span class="n">dtypes</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">is_subset</span><span class="p">(</span><span class="n">col_for_set</span><span class="p">,</span> <span class="n">col_for_subset</span><span class="p">):</span>
            <span class="c1"># Confirms that the series of col_for_subset is true only for a subset of the series for col_for_set</span>
            <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">col_for_subset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">col_for_subset</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span>
                <span class="n">col_for_set</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">col_for_set</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
            <span class="p">)</span>

        <span class="c1"># Check that core properties of current status are never None/NaN/NaT</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">df_alive</span><span class="o">.</span><span class="n">hv_inf</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">df_alive</span><span class="o">.</span><span class="n">hv_art</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">df_alive</span><span class="o">.</span><span class="n">hv_behaviour_change</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">df_alive</span><span class="o">.</span><span class="n">hv_diagnosed</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">df_alive</span><span class="o">.</span><span class="n">hv_number_tests</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>

        <span class="c1"># Check that the core HIV properties are &#39;nested&#39; in the way expected.</span>
        <span class="k">assert</span> <span class="n">is_subset</span><span class="p">(</span>
            <span class="n">col_for_set</span><span class="o">=</span><span class="n">df_alive</span><span class="o">.</span><span class="n">hv_inf</span><span class="p">,</span> <span class="n">col_for_subset</span><span class="o">=</span><span class="n">df_alive</span><span class="o">.</span><span class="n">hv_diagnosed</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">is_subset</span><span class="p">(</span>
            <span class="n">col_for_set</span><span class="o">=</span><span class="n">df_alive</span><span class="o">.</span><span class="n">hv_diagnosed</span><span class="p">,</span> <span class="n">col_for_subset</span><span class="o">=</span><span class="p">(</span><span class="n">df_alive</span><span class="o">.</span><span class="n">hv_art</span> <span class="o">!=</span> <span class="s2">&quot;not&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Check that if person is not infected, the dates of HIV events are None/NaN/NaT</span>
        <span class="k">assert</span> <span class="n">df_alive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">df_alive</span><span class="o">.</span><span class="n">hv_inf</span><span class="p">,</span> <span class="s2">&quot;hv_date_inf&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="c1"># Check that dates consistent for those infected with HIV</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">df_alive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_alive</span><span class="o">.</span><span class="n">hv_inf</span><span class="p">]</span><span class="o">.</span><span class="n">hv_date_inf</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">df_alive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_alive</span><span class="o">.</span><span class="n">hv_inf</span><span class="p">]</span><span class="o">.</span><span class="n">hv_date_inf</span>
            <span class="o">&gt;=</span> <span class="n">df_alive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_alive</span><span class="o">.</span><span class="n">hv_inf</span><span class="p">]</span><span class="o">.</span><span class="n">date_of_birth</span>
        <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="c1"># Check alignment between AIDS Symptoms and status and infection and ART status</span>
        <span class="n">has_aids_symptoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;SymptomManager&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">who_has</span><span class="p">(</span><span class="s2">&quot;aids_symptoms&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">has_aids_symptoms</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span>
            <span class="n">df_alive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_alive</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df_alive</span><span class="o">.</span><span class="n">hv_inf</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
        <span class="p">)</span>

        <span class="c1"># a person can have AIDS onset if they&#39;re virally suppressed if had active TB</span>
        <span class="c1"># if cured of TB and still virally suppressed, AIDS symptoms are removed</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">has_aids_symptoms</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span>
                <span class="n">df_alive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">df_alive</span><span class="o">.</span><span class="n">is_alive</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_alive</span><span class="o">.</span><span class="n">hv_art</span> <span class="o">==</span> <span class="s2">&quot;on_VL_suppressed&quot;</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_alive</span><span class="o">.</span><span class="n">tb_inf</span> <span class="o">==</span> <span class="s2">&quot;uninfected&quot;</span><span class="p">)</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">index</span>
            <span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Hiv.do_at_generic_first_appt">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv.do_at_generic_first_appt">[docs]</a>
    <span class="k">def</span> <span class="nf">do_at_generic_first_appt</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">person_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">symptoms</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">schedule_hsi_event</span><span class="p">:</span> <span class="n">HSIEventScheduler</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># &#39;Automatic&#39; testing for HIV for everyone attending care with AIDS symptoms:</span>
        <span class="c1">#  - suppress the footprint (as it done as part of another appointment)</span>
        <span class="c1">#  - do not do referrals if the person is HIV negative (assumed not time for counselling etc).</span>
        <span class="k">if</span> <span class="s2">&quot;aids_symptoms&quot;</span> <span class="ow">in</span> <span class="n">symptoms</span><span class="p">:</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">HSI_Hiv_TestAndRefer</span><span class="p">(</span>
                <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span>
                <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">referred_from</span><span class="o">=</span><span class="s2">&quot;hsi_generic_first_appt&quot;</span><span class="p">,</span>
                <span class="n">suppress_footprint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">do_not_refer_if_neg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">schedule_hsi_event</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span></div>
</div>


<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1">#   Main Polling Event</span>
<span class="c1"># ---------------------------------------------------------------------------</span>


<div class="viewcode-block" id="HivRegularPollingEvent">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivRegularPollingEvent">[docs]</a>
<span class="k">class</span> <span class="nc">HivRegularPollingEvent</span><span class="p">(</span><span class="n">RegularEvent</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; The HIV Regular Polling Events</span>
<span class="sd">    * Schedules persons becoming newly infected through horizontal transmission</span>
<span class="sd">    * Schedules who will present for voluntary (&quot;spontaneous&quot;) testing</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="HivRegularPollingEvent.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivRegularPollingEvent.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">module</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># repeats every 12 months, but this can be changed</span></div>


<div class="viewcode-block" id="HivRegularPollingEvent.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivRegularPollingEvent.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span>

        <span class="n">fraction_of_year_between_polls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="o">.</span><span class="n">months</span> <span class="o">/</span> <span class="mi">12</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">fraction_of_year_between_polls</span>

        <span class="c1"># ----------------------------------- HORIZONTAL TRANSMISSION -----------------------------------</span>
        <span class="k">def</span> <span class="nf">horizontal_transmission</span><span class="p">(</span><span class="n">to_sex</span><span class="p">,</span> <span class="n">from_sex</span><span class="p">):</span>
            <span class="c1"># Count current number of alive 15-80 year-olds at risk of transmission</span>
            <span class="c1"># (= those infected and not VL suppressed):</span>
            <span class="n">n_infectious</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                    <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_art</span> <span class="o">!=</span> <span class="s2">&quot;on_VL_suppressed&quot;</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="n">from_sex</span><span class="p">)</span>
                    <span class="p">]</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">n_infectious</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

                <span class="c1"># Get Susceptible (non-infected alive 15-80 year-old) persons:</span>
                <span class="n">susc_idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                    <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span>
                    <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="n">to_sex</span><span class="p">)</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">index</span>
                <span class="n">n_susceptible</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">susc_idx</span><span class="p">)</span>

                <span class="c1"># Compute chance that each susceptible person becomes infected:</span>
                <span class="c1">#  - relative chance of infection (acts like a scaling-factor on &#39;beta&#39;)</span>
                <span class="n">rr_of_infection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s2">&quot;rr_of_infection&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">susc_idx</span><span class="p">]</span>
                <span class="p">)</span>

                <span class="c1">#  - probability of infection = beta * I/N</span>
                <span class="n">p_infection</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">rr_of_infection</span> <span class="o">*</span> <span class="n">beta</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_infectious</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_infectious</span> <span class="o">+</span> <span class="n">n_susceptible</span><span class="p">))</span>
                <span class="p">)</span>

                <span class="c1"># New infections:</span>
                <span class="n">will_be_infected</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p_infection</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">p_infection</span>
                <span class="p">)</span>
                <span class="n">idx_new_infection</span> <span class="o">=</span> <span class="n">will_be_infected</span><span class="p">[</span><span class="n">will_be_infected</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>

                <span class="n">idx_new_infection_fsw</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1"># additional risk for fsw</span>
                <span class="k">if</span> <span class="n">to_sex</span> <span class="o">==</span> <span class="s2">&quot;F&quot;</span><span class="p">:</span>
                    <span class="n">fsw_at_risk</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                        <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span>
                        <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">li_is_sexworker</span>
                        <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">hv_is_on_prep</span>
                        <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">index</span>

                    <span class="c1">#  - probability of infection - relative risk applies only to fsw</span>
                    <span class="n">p_infection_fsw</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;rr_fsw&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">beta</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_infectious</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_infectious</span> <span class="o">+</span> <span class="n">n_susceptible</span><span class="p">))</span>
                    <span class="p">)</span>

                    <span class="n">fsw_infected</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fsw_at_risk</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">p_infection_fsw</span>
                    <span class="p">)</span>
                    <span class="n">idx_new_infection_fsw</span> <span class="o">=</span> <span class="n">fsw_at_risk</span><span class="p">[</span><span class="n">fsw_infected</span><span class="p">]</span>

                <span class="n">idx_new_infection</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">idx_new_infection</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">idx_new_infection_fsw</span><span class="p">)</span>

                <span class="c1"># Schedule the date of infection for each new infection:</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idx_new_infection</span><span class="p">:</span>
                    <span class="n">date_of_infection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span>
                        <span class="n">days</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">365</span> <span class="o">*</span> <span class="n">fraction_of_year_between_polls</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
                        <span class="n">HivInfectionEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span> <span class="n">date_of_infection</span>
                    <span class="p">)</span>

        <span class="c1"># ----------------------------------- SPONTANEOUS TESTING -----------------------------------</span>
        <span class="k">def</span> <span class="nf">spontaneous_testing</span><span class="p">(</span><span class="n">current_year</span><span class="p">):</span>

            <span class="c1"># extract annual testing rates from MoH Reports</span>
            <span class="n">test_rates</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;hiv_testing_rates&quot;</span><span class="p">]</span>

            <span class="n">testing_rate_adults</span> <span class="o">=</span> <span class="n">test_rates</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                                      <span class="n">test_rates</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">current_year</span><span class="p">,</span> <span class="s2">&quot;annual_testing_rate_adults&quot;</span>
                                  <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;hiv_testing_rate_adjustment&quot;</span><span class="p">]</span>

            <span class="c1"># adult testing trends also informed by demographic characteristics</span>
            <span class="c1"># relative probability of testing - this may skew testing rates higher or lower than moh reports</span>
            <span class="n">rr_of_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s2">&quot;lm_spontaneous_test_12m&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)])</span>
            <span class="n">mean_prob_test</span> <span class="o">=</span> <span class="p">(</span><span class="n">rr_of_test</span> <span class="o">*</span> <span class="n">testing_rate_adults</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">scaled_prob_test</span> <span class="o">=</span> <span class="p">(</span><span class="n">rr_of_test</span> <span class="o">*</span> <span class="n">testing_rate_adults</span><span class="p">)</span> <span class="o">/</span> <span class="n">mean_prob_test</span>
            <span class="n">overall_prob_test</span> <span class="o">=</span> <span class="n">scaled_prob_test</span> <span class="o">*</span> <span class="n">testing_rate_adults</span>

            <span class="n">random_draw</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)]))</span>
            <span class="n">adult_tests_idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">random_draw</span> <span class="o">&lt;</span> <span class="n">overall_prob_test</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span>

            <span class="n">idx_will_test</span> <span class="o">=</span> <span class="n">adult_tests_idx</span>

            <span class="k">for</span> <span class="n">person_id</span> <span class="ow">in</span> <span class="n">idx_will_test</span><span class="p">:</span>
                <span class="n">date_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span>
                    <span class="n">days</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">365</span> <span class="o">*</span> <span class="n">fraction_of_year_between_polls</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                    <span class="n">hsi_event</span><span class="o">=</span><span class="n">HSI_Hiv_TestAndRefer</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">referred_from</span><span class="o">=</span><span class="s1">&#39;HIV_poll&#39;</span><span class="p">),</span>
                    <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">topen</span><span class="o">=</span><span class="n">date_test</span><span class="p">,</span>
                    <span class="n">tclose</span><span class="o">=</span><span class="n">date_test</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span>
                        <span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="o">.</span><span class="n">months</span>
                    <span class="p">),</span>  <span class="c1"># (to occur before next polling)</span>
                <span class="p">)</span>

        <span class="c1"># ----------------------------------- PrEP poll for AGYW -----------------------------------</span>
        <span class="k">def</span> <span class="nf">prep_for_agyw</span><span class="p">():</span>

            <span class="c1"># select highest risk agyw</span>
            <span class="n">agyw_idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">hv_diagnosed</span>
                <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;F&quot;</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">hv_is_on_prep</span>
                <span class="p">]</span><span class="o">.</span><span class="n">index</span>

            <span class="n">rr_of_infection_in_agyw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s2">&quot;rr_of_infection&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">agyw_idx</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="c1"># divide by the mean risk then multiply by prob of prep</span>
            <span class="c1"># highest risk AGYW will have highest probability of getting prep</span>
            <span class="n">mean_risk</span> <span class="o">=</span> <span class="n">rr_of_infection_in_agyw</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">scaled_risk</span> <span class="o">=</span> <span class="n">rr_of_infection_in_agyw</span> <span class="o">/</span> <span class="n">mean_risk</span>
            <span class="n">overall_risk_and_prob_of_prep</span> <span class="o">=</span> <span class="n">scaled_risk</span> <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;prob_prep_for_agyw&quot;</span><span class="p">]</span>

            <span class="c1"># give prep</span>
            <span class="n">give_prep</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">overall_risk_and_prob_of_prep</span><span class="p">))</span>
                                   <span class="o">&lt;</span> <span class="n">overall_risk_and_prob_of_prep</span><span class="p">)</span>
                               <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                               <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">hv_diagnosed</span>
                               <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
                               <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;F&quot;</span><span class="p">)</span>
                               <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">hv_is_on_prep</span>
                               <span class="p">]</span><span class="o">.</span><span class="n">index</span>

            <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">give_prep</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                    <span class="n">hsi_event</span><span class="o">=</span><span class="n">HSI_Hiv_StartOrContinueOnPrep</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person</span><span class="p">,</span>
                                                            <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">),</span>
                    <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                    <span class="n">tclose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span>
                        <span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="o">.</span><span class="n">months</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="c1"># ----------------------------------- SPONTANEOUS VMMC FOR &lt;15 YRS -----------------------------------</span>
        <span class="k">def</span> <span class="nf">vmmc_for_child</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;schedule the HSI_Hiv_Circ for &lt;15 yrs males according to his age, circumcision status</span>
<span class="sd">            and the probability of being circumcised&quot;&quot;&quot;</span>
            <span class="c1"># work out who will be circumcised.</span>
            <span class="n">will_go_to_circ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s2">&quot;lm_circ_child&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;M&quot;</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">li_is_circ</span><span class="p">)</span>
                    <span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="p">,</span>
                <span class="n">year</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># schedule the HSI based on the probability</span>
            <span class="k">for</span> <span class="n">person_id</span> <span class="ow">in</span> <span class="n">will_go_to_circ</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">will_go_to_circ</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                    <span class="n">HSI_Hiv_Circ</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">),</span>
                    <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                    <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># Horizontal transmission: Male --&gt; Female</span>
        <span class="n">horizontal_transmission</span><span class="p">(</span><span class="n">from_sex</span><span class="o">=</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="n">to_sex</span><span class="o">=</span><span class="s2">&quot;F&quot;</span><span class="p">)</span>

        <span class="c1"># Horizontal transmission: Female --&gt; Male</span>
        <span class="n">horizontal_transmission</span><span class="p">(</span><span class="n">from_sex</span><span class="o">=</span><span class="s2">&quot;F&quot;</span><span class="p">,</span> <span class="n">to_sex</span><span class="o">=</span><span class="s2">&quot;M&quot;</span><span class="p">)</span>

        <span class="c1"># testing</span>
        <span class="c1"># if year later than 2020, set testing rates to those reported in 2020</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;</span> <span class="mi">2021</span><span class="p">:</span>
            <span class="n">current_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">year</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_year</span> <span class="o">=</span> <span class="mi">2020</span>
        <span class="n">spontaneous_testing</span><span class="p">(</span><span class="n">current_year</span><span class="o">=</span><span class="n">current_year</span><span class="p">)</span>

        <span class="c1"># PrEP for AGYW</span>
        <span class="n">prep_for_agyw</span><span class="p">()</span>

        <span class="c1"># VMMC for &lt;15 yrs in the population</span>
        <span class="n">vmmc_for_child</span><span class="p">()</span></div>
</div>



<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1">#   Natural History Events</span>
<span class="c1"># ---------------------------------------------------------------------------</span>

<div class="viewcode-block" id="HivInfectionEvent">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivInfectionEvent">[docs]</a>
<span class="k">class</span> <span class="nc">HivInfectionEvent</span><span class="p">(</span><span class="n">Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; This person will become infected.</span>
<span class="sd">    * Do the infection process</span>
<span class="sd">    * Check for onward transmission through MTCT if the infection is to a mother who is currently breastfeeding.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="HivInfectionEvent.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivInfectionEvent.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="HivInfectionEvent.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivInfectionEvent.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="c1"># Check person is_alive</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;is_alive&quot;</span><span class="p">]:</span>
            <span class="k">return</span>

        <span class="c1"># Onset the infection for this person (which will schedule progression etc)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">do_new_infection</span><span class="p">(</span><span class="n">person_id</span><span class="p">)</span>

        <span class="c1"># Consider mother-to-child-transmission (MTCT) from this person to their children:</span>
        <span class="n">children_of_this_person_being_breastfed</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">mother_id</span> <span class="o">==</span> <span class="n">person_id</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">nb_breastfeeding_status</span> <span class="o">!=</span> <span class="s2">&quot;none&quot;</span><span class="p">)</span>
            <span class="p">]</span><span class="o">.</span><span class="n">index</span>
        <span class="c1"># - Do the MTCT routine for each child:</span>
        <span class="k">for</span> <span class="n">child_id</span> <span class="ow">in</span> <span class="n">children_of_this_person_being_breastfed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">mtct_during_breastfeeding</span><span class="p">(</span><span class="n">person_id</span><span class="p">,</span> <span class="n">child_id</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="HivInfectionDuringBreastFeedingEvent">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivInfectionDuringBreastFeedingEvent">[docs]</a>
<span class="k">class</span> <span class="nc">HivInfectionDuringBreastFeedingEvent</span><span class="p">(</span><span class="n">Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; This person will become infected during breastfeeding</span>
<span class="sd">    * Do the infection process</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="HivInfectionDuringBreastFeedingEvent.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivInfectionDuringBreastFeedingEvent.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="HivInfectionDuringBreastFeedingEvent.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivInfectionDuringBreastFeedingEvent.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="c1"># Check person is_alive</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;is_alive&quot;</span><span class="p">]:</span>
            <span class="k">return</span>

        <span class="c1"># Check person is breastfed currently</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;nb_breastfeeding_status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># If child is on NVP for HIV prophylaxis, then do not let the infection occur</span>
        <span class="c1"># (the prophylaxis is assumed to be perfectly effective in blocking transmission)</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_is_on_prep&quot;</span><span class="p">]:</span>
            <span class="k">return</span>

        <span class="c1"># Onset the infection for this person (which will schedule progression etc)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">do_new_infection</span><span class="p">(</span><span class="n">person_id</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="HivAidsOnsetEvent">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivAidsOnsetEvent">[docs]</a>
<span class="k">class</span> <span class="nc">HivAidsOnsetEvent</span><span class="p">(</span><span class="n">Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; This person has developed AIDS.</span>
<span class="sd">    * Update their symptomatic status</span>
<span class="sd">    * Record the date at which AIDS onset</span>
<span class="sd">    * Schedule the AIDS death</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="HivAidsOnsetEvent.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivAidsOnsetEvent.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">cause</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cause</span> <span class="o">=</span> <span class="n">cause</span></div>


<div class="viewcode-block" id="HivAidsOnsetEvent.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivAidsOnsetEvent.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="c1"># Return if person is dead or no HIV+</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;is_alive&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_inf&quot;</span><span class="p">]:</span>
            <span class="k">return</span>

        <span class="c1"># eligible for AIDS onset:</span>
        <span class="c1"># not VL suppressed no active tb</span>
        <span class="c1"># not VL suppressed active tb</span>
        <span class="c1"># VL suppressed active tb</span>

        <span class="c1"># Do nothing if person is now on ART and VL suppressed (non-VL suppressed has no effect)</span>
        <span class="c1"># if cause is TB, allow AIDS onset</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_art&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;on_VL_suppressed&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cause</span> <span class="o">!=</span> <span class="s1">&#39;AIDS_TB&#39;</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># need to delay onset of AIDS (non-tb) to compensate for AIDS-TB</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cause</span> <span class="o">==</span> <span class="s2">&quot;AIDS_non_TB&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;Hiv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;Hiv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;prop_delayed_aids_onset&quot;</span><span class="p">]):</span>

            <span class="c1"># redraw time to aids and reschedule</span>
            <span class="n">months_to_aids</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;Hiv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span>
                        <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;Hiv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;art_default_to_aids_mean_years&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="o">*</span> <span class="mf">12.0</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
                <span class="n">event</span><span class="o">=</span><span class="n">HivAidsOnsetEvent</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;Hiv&quot;</span><span class="p">],</span> <span class="n">cause</span><span class="o">=</span><span class="s1">&#39;AIDS_non_TB&#39;</span><span class="p">),</span>
                <span class="n">date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="n">months_to_aids</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># else assign aids onset and schedule aids death</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># if eligible for aids onset (not treated with ART or currently has active TB):</span>
            <span class="c1"># Update Symptoms</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;SymptomManager&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">change_symptom</span><span class="p">(</span>
                <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span>
                <span class="n">symptom_string</span><span class="o">=</span><span class="s2">&quot;aids_symptoms&quot;</span><span class="p">,</span>
                <span class="n">add_or_remove</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
                <span class="n">disease_module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;Hiv&quot;</span><span class="p">],</span>
            <span class="p">)</span>

            <span class="c1"># Schedule AidsDeath</span>
            <span class="n">date_of_aids_death</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;Hiv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_time_from_aids_to_death</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cause</span> <span class="o">==</span> <span class="s2">&quot;AIDS_non_TB&quot;</span><span class="p">:</span>

                <span class="c1"># cause is HIV</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
                    <span class="n">event</span><span class="o">=</span><span class="n">HivAidsDeathEvent</span><span class="p">(</span>
                        <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;Hiv&quot;</span><span class="p">],</span> <span class="n">cause</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cause</span>
                    <span class="p">),</span>
                    <span class="n">date</span><span class="o">=</span><span class="n">date_of_aids_death</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># schedule hospital stay</span>
                <span class="n">beddays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;Hiv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">date_admission</span> <span class="o">=</span> <span class="n">date_of_aids_death</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">beddays</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                    <span class="n">hsi_event</span><span class="o">=</span><span class="n">HSI_Hiv_EndOfLifeCare</span><span class="p">(</span>
                        <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span>
                        <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;Hiv&quot;</span><span class="p">],</span>
                        <span class="n">beddays</span><span class="o">=</span><span class="n">beddays</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">topen</span><span class="o">=</span><span class="p">(</span>
                        <span class="n">date_admission</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">date_admission</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
                        <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>
                    <span class="p">),</span>
                    <span class="n">tclose</span><span class="o">=</span><span class="n">date_of_aids_death</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># cause is active TB</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
                    <span class="n">event</span><span class="o">=</span><span class="n">HivAidsTbDeathEvent</span><span class="p">(</span>
                        <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;Hiv&quot;</span><span class="p">],</span> <span class="n">cause</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cause</span>
                    <span class="p">),</span>
                    <span class="n">date</span><span class="o">=</span><span class="n">date_of_aids_death</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># schedule hospital stay</span>
                <span class="n">beddays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;Hiv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">date_admission</span> <span class="o">=</span> <span class="n">date_of_aids_death</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">beddays</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                    <span class="n">hsi_event</span><span class="o">=</span><span class="n">HSI_Hiv_EndOfLifeCare</span><span class="p">(</span>
                        <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span>
                        <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;Hiv&quot;</span><span class="p">],</span>
                        <span class="n">beddays</span><span class="o">=</span><span class="n">beddays</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">topen</span><span class="o">=</span><span class="p">(</span>
                        <span class="n">date_admission</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">date_admission</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
                        <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>
                    <span class="p">),</span>
                    <span class="n">tclose</span><span class="o">=</span><span class="n">date_of_aids_death</span><span class="p">,</span>
                <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="HivAidsDeathEvent">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivAidsDeathEvent">[docs]</a>
<span class="k">class</span> <span class="nc">HivAidsDeathEvent</span><span class="p">(</span><span class="n">Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Causes someone to die of AIDS, if they are not VL suppressed on ART.</span>
<span class="sd">    if death scheduled by tb-aids, death event is HivAidsTbDeathEvent</span>
<span class="sd">    if death scheduled by hiv but person also has active TB, cause of</span>
<span class="sd">    death is AIDS_TB</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="HivAidsDeathEvent.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivAidsDeathEvent.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">cause</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cause</span> <span class="o">=</span> <span class="n">cause</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cause</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;AIDS_non_TB&quot;</span><span class="p">,</span> <span class="s2">&quot;AIDS_TB&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="HivAidsDeathEvent.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivAidsDeathEvent.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>

        <span class="c1"># Check person is_alive</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;is_alive&quot;</span><span class="p">]:</span>
            <span class="k">return</span>

        <span class="c1"># Do nothing if person is now on ART and VL suppressed (non VL suppressed has no effect)</span>
        <span class="c1"># only if no current TB infection</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_art&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;on_VL_suppressed&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_inf&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;active&quot;</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># off ART, no TB infection</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_art&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;on_VL_suppressed&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_inf&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;active&quot;</span><span class="p">):</span>
            <span class="c1"># cause is HIV (no TB)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;Demography&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">do_death</span><span class="p">(</span>
                <span class="n">individual_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span>
                <span class="n">cause</span><span class="o">=</span><span class="s2">&quot;AIDS_non_TB&quot;</span><span class="p">,</span>
                <span class="n">originating_module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># on or off ART, active TB infection, schedule AidsTbDeathEvent</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;tb_inf&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;active&quot;</span><span class="p">:</span>
            <span class="c1"># cause is active TB</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
                <span class="n">event</span><span class="o">=</span><span class="n">HivAidsTbDeathEvent</span><span class="p">(</span>
                    <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">cause</span><span class="o">=</span><span class="s2">&quot;AIDS_TB&quot;</span>
                <span class="p">),</span>
                <span class="n">date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
            <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="HivAidsTbDeathEvent">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivAidsTbDeathEvent">[docs]</a>
<span class="k">class</span> <span class="nc">HivAidsTbDeathEvent</span><span class="p">(</span><span class="n">Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This event is caused by someone co-infected with HIV and active TB</span>
<span class="sd">    it causes someone to die of AIDS-TB, death dependent on tb treatment status</span>
<span class="sd">    and not affected by ART status</span>
<span class="sd">    can be called by Tb or Hiv module</span>
<span class="sd">    if the random draw doesn&#39;t result in AIDS-TB death, an AIDS death (HivAidsDeathEvent) will be scheduled</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="HivAidsTbDeathEvent.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivAidsTbDeathEvent.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">cause</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cause</span> <span class="o">=</span> <span class="n">cause</span></div>


<div class="viewcode-block" id="HivAidsTbDeathEvent.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivAidsTbDeathEvent.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;Hiv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span>

        <span class="c1"># Check person is_alive</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;is_alive&quot;</span><span class="p">]:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s1">&#39;tb_on_treatment&#39;</span><span class="p">]:</span>

            <span class="n">risk_of_death</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;aids_tb_treatment_adjustment&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s2">&quot;CardioMetabolicDisorders&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;nc_diabetes&quot;</span><span class="p">]:</span>
                    <span class="n">risk_of_death</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;Tb&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;rr_death_diabetes&quot;</span><span class="p">]</span>

            <span class="c1"># treatment adjustment reduces probability of death</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">risk_of_death</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;Demography&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">do_death</span><span class="p">(</span>
                    <span class="n">individual_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span>
                    <span class="n">cause</span><span class="o">=</span><span class="s2">&quot;AIDS_TB&quot;</span><span class="p">,</span>
                    <span class="n">originating_module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># if they survive, reschedule the aids death event</span>
                <span class="c1"># module calling rescheduled AIDS death should be Hiv (not TB)</span>
                <span class="n">date_of_aids_death</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;Hiv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_time_from_aids_to_death</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
                    <span class="n">event</span><span class="o">=</span><span class="n">HivAidsDeathEvent</span><span class="p">(</span>
                        <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span>
                        <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;Hiv&quot;</span><span class="p">],</span>
                        <span class="n">cause</span><span class="o">=</span><span class="s2">&quot;AIDS_non_TB&quot;</span>
                    <span class="p">),</span>
                    <span class="n">date</span><span class="o">=</span><span class="n">date_of_aids_death</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># schedule hospital stay</span>
                <span class="n">beddays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">date_admission</span> <span class="o">=</span> <span class="n">date_of_aids_death</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">beddays</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                    <span class="n">hsi_event</span><span class="o">=</span><span class="n">HSI_Hiv_EndOfLifeCare</span><span class="p">(</span>
                        <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span>
                        <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;Hiv&quot;</span><span class="p">],</span>
                        <span class="n">beddays</span><span class="o">=</span><span class="n">beddays</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">topen</span><span class="o">=</span><span class="p">(</span>
                        <span class="n">date_admission</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">date_admission</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
                        <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>
                    <span class="p">),</span>
                    <span class="n">tclose</span><span class="o">=</span><span class="n">date_of_aids_death</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># aids-tb and not on tb treatment</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s1">&#39;tb_on_treatment&#39;</span><span class="p">]:</span>
            <span class="c1"># Cause the death to happen immediately, cause defined by TB status</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;Demography&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">do_death</span><span class="p">(</span>
                <span class="n">individual_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">cause</span><span class="o">=</span><span class="s2">&quot;AIDS_TB&quot;</span><span class="p">,</span> <span class="n">originating_module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span>
            <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="Hiv_DecisionToContinueOnPrEP">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv_DecisionToContinueOnPrEP">[docs]</a>
<span class="k">class</span> <span class="nc">Hiv_DecisionToContinueOnPrEP</span><span class="p">(</span><span class="n">Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper event that is used to &#39;decide&#39; if someone on PrEP should continue on PrEP.</span>
<span class="sd">    This event is scheduled by &#39;HSI_Hiv_StartOrContinueOnPrep&#39; 3 months after it is run.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Hiv_DecisionToContinueOnPrEP.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv_DecisionToContinueOnPrEP.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="Hiv_DecisionToContinueOnPrEP.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv_DecisionToContinueOnPrEP.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">person</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span>

        <span class="c1"># If the person is no longer alive or has been diagnosed with hiv, they will not continue on PrEP</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="p">(</span><span class="ow">not</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;is_alive&quot;</span><span class="p">])</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">person</span><span class="p">[</span><span class="s2">&quot;hv_diagnosed&quot;</span><span class="p">])</span>
        <span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># Check that there are on PrEP currently:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;hv_is_on_prep&quot;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="n">key</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="s2">&quot;This event should not be running: Hiv_DecisionToContinueOnPrEP is for those currently on prep&quot;</span><span class="p">)</span>

        <span class="c1"># check still eligible, person must be &lt;30 years old or a fsw</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">person</span><span class="p">[</span><span class="s2">&quot;age_years&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;li_is_sexworker&quot;</span><span class="p">]:</span>
            <span class="k">return</span>

        <span class="c1"># Determine if this appointment is actually attended by the person who has already started on PrEP</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">m</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span>
            <span class="o">&lt;</span> <span class="n">m</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;probability_of_being_retained_on_prep_every_3_months&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="c1"># Continue on PrEP - and schedule an HSI for a refill appointment today</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">HSI_Hiv_StartOrContinueOnPrep</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="n">m</span><span class="p">),</span>
                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                <span class="n">tclose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">),</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Defaults to being off PrEP - reset flag and take no further action</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_is_on_prep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span></div>
</div>



<div class="viewcode-block" id="Hiv_DecisionToContinueTreatment">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv_DecisionToContinueTreatment">[docs]</a>
<span class="k">class</span> <span class="nc">Hiv_DecisionToContinueTreatment</span><span class="p">(</span><span class="n">Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper event that is used to &#39;decide&#39; if someone on Treatment should continue on Treatment.</span>
<span class="sd">    This event is scheduled by &#39;HSI_Hiv_StartOrContinueTreatment&#39; 3 months after it is run.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Hiv_DecisionToContinueTreatment.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv_DecisionToContinueTreatment.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="Hiv_DecisionToContinueTreatment.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.Hiv_DecisionToContinueTreatment.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">person</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;is_alive&quot;</span><span class="p">]:</span>
            <span class="k">return</span>

        <span class="c1"># Check that they are on Treatment currently:</span>
        <span class="k">if</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;hv_art&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;on_VL_suppressed&quot;</span><span class="p">,</span> <span class="s2">&quot;on_not_VL_suppressed&quot;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="n">key</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="s2">&quot;This event should not be running, Hiv_DecisionToContinueTreatment is for those already on tx&quot;</span><span class="p">)</span>

        <span class="c1"># Determine if this appointment is actually attended by the person who has already started on ART</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">m</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span>
            <span class="o">&lt;</span> <span class="n">m</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;probability_of_being_retained_on_art_every_3_months&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="c1"># Continue on Treatment - and schedule an HSI for a continuation appointment today</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">HSI_Hiv_StartOrContinueTreatment</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="n">m</span><span class="p">,</span>
                                                 <span class="n">facility_level_of_this_hsi</span><span class="o">=</span><span class="s2">&quot;1a&quot;</span><span class="p">),</span>
                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                <span class="n">tclose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">14</span><span class="p">),</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Defaults to being off Treatment</span>
            <span class="n">m</span><span class="o">.</span><span class="n">stops_treatment</span><span class="p">(</span><span class="n">person_id</span><span class="p">)</span>

            <span class="c1"># refer for another treatment again in 1 month</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">HSI_Hiv_StartOrContinueTreatment</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="n">m</span><span class="p">,</span>
                                                 <span class="n">facility_level_of_this_hsi</span><span class="o">=</span><span class="s2">&quot;1a&quot;</span><span class="p">),</span>
                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="HivScaleUpEvent">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivScaleUpEvent">[docs]</a>
<span class="k">class</span> <span class="nc">HivScaleUpEvent</span><span class="p">(</span><span class="n">Event</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; This event exists to change parameters or functions</span>
<span class="sd">    depending on the scenario for projections which has been set</span>
<span class="sd">    It only occurs once on date: scaleup_start_date,</span>
<span class="sd">    called by initialise_simulation</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="HivScaleUpEvent.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivScaleUpEvent.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">)</span></div>


<div class="viewcode-block" id="HivScaleUpEvent.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivScaleUpEvent.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">update_parameters_for_program_scaleup</span><span class="p">()</span></div>
</div>



<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1">#   Health System Interactions (HSI)</span>
<span class="c1"># ---------------------------------------------------------------------------</span>


<div class="viewcode-block" id="HSI_Hiv_TestAndRefer">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_TestAndRefer">[docs]</a>
<span class="k">class</span> <span class="nc">HSI_Hiv_TestAndRefer</span><span class="p">(</span><span class="n">HSI_Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the Test-and-Refer HSI. Individuals may seek an HIV test at any time. From this, they can be referred on to</span>
<span class="sd">    other services.</span>
<span class="sd">    This event is scheduled by:</span>
<span class="sd">        * the main event poll,</span>
<span class="sd">        * when someone presents for any care through a Generic HSI.</span>
<span class="sd">        * when an infant is born to an HIV-positive mother</span>
<span class="sd">    Following the test, they may or may not go on to present for uptake an HIV service: ART (if HIV-positive), VMMC (if</span>
<span class="sd">    HIV-negative and male) or PrEP (if HIV-negative and a female sex worker).</span>
<span class="sd">    If this event is called within another HSI, it may be desirable to limit the functionality of the HSI: do this</span>
<span class="sd">    using the arguments:</span>
<span class="sd">        * do_not_refer_if_neg=False : if the person is HIV-neg they will not be referred to VMMC or PrEP</span>
<span class="sd">        * suppress_footprint=True : the HSI will not have any footprint</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="HSI_Hiv_TestAndRefer.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_TestAndRefer.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">do_not_refer_if_neg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">suppress_footprint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">referred_from</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">Hiv</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">do_not_refer_if_neg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_not_refer_if_neg</span> <span class="o">=</span> <span class="n">do_not_refer_if_neg</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">suppress_footprint</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suppress_footprint</span> <span class="o">=</span> <span class="n">suppress_footprint</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">referred_from</span> <span class="o">=</span> <span class="n">referred_from</span>

        <span class="c1"># Define the necessary information for an HSI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TREATMENT_ID</span> <span class="o">=</span> <span class="s2">&quot;Hiv_Test&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s2">&quot;VCTNegative&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span> <span class="o">=</span> <span class="s2">&quot;1a&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter_for_test_not_available</span> <span class="o">=</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="HSI_Hiv_TestAndRefer.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_TestAndRefer.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">squeeze_factor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Do the testing and referring to other services&quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">person</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;is_alive&quot;</span><span class="p">]:</span>
            <span class="k">return</span>

        <span class="c1"># If person is diagnosed and on treatment do nothing do not occupy any resources</span>
        <span class="k">if</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;hv_diagnosed&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">person</span><span class="p">[</span><span class="s2">&quot;hv_art&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;not&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_blank_appt_footprint</span><span class="p">()</span>

        <span class="c1"># if person has had test in last week, do not repeat test</span>
        <span class="k">if</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;hv_last_test_date&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_blank_appt_footprint</span><span class="p">()</span>

        <span class="c1"># Run test</span>
        <span class="k">if</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;age_years&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">test_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">run_dx_test</span><span class="p">(</span>
                <span class="n">dx_tests_to_run</span><span class="o">=</span><span class="s2">&quot;hiv_early_infant_test&quot;</span><span class="p">,</span> <span class="n">hsi_event</span><span class="o">=</span><span class="bp">self</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">test_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">run_dx_test</span><span class="p">(</span>
                <span class="n">dx_tests_to_run</span><span class="o">=</span><span class="s2">&quot;hiv_rapid_test&quot;</span><span class="p">,</span> <span class="n">hsi_event</span><span class="o">=</span><span class="bp">self</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">test_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1"># Update number of tests:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_number_tests&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_last_test_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>

            <span class="c1"># Log the test: line-list of summary information about each test</span>
            <span class="n">person_details_for_test</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="n">person</span><span class="p">[</span><span class="s1">&#39;age_years&#39;</span><span class="p">],</span>
                <span class="s1">&#39;hiv_status&#39;</span><span class="p">:</span> <span class="n">person</span><span class="p">[</span><span class="s1">&#39;hv_inf&#39;</span><span class="p">],</span>
                <span class="s1">&#39;hiv_diagnosed&#39;</span><span class="p">:</span> <span class="n">person</span><span class="p">[</span><span class="s1">&#39;hv_diagnosed&#39;</span><span class="p">],</span>
                <span class="s1">&#39;referred_from&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">referred_from</span><span class="p">,</span>
                <span class="s1">&#39;person_id&#39;</span><span class="p">:</span> <span class="n">person_id</span>
            <span class="p">}</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;hiv_test&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">person_details_for_test</span><span class="p">)</span>

            <span class="c1"># Offer services as needed:</span>
            <span class="k">if</span> <span class="n">test_result</span><span class="p">:</span>
                <span class="c1"># The test_result is HIV positive</span>
                <span class="n">ACTUAL_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s2">&quot;VCTPositive&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>

                <span class="c1"># Update diagnosis if the person is indeed HIV positive;</span>
                <span class="k">if</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;hv_inf&quot;</span><span class="p">]:</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_diagnosed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">do_when_hiv_diagnosed</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>

                    <span class="c1"># Screen for tb if they have not been referred from a Tb HSI</span>
                    <span class="c1"># and do not currently have TB diagnosis</span>
                    <span class="k">if</span> <span class="s2">&quot;Tb&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">referred_from</span> <span class="o">!=</span> <span class="s1">&#39;Tb&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;tb_diagnosed&quot;</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                            <span class="n">tb</span><span class="o">.</span><span class="n">HSI_Tb_ScreeningAndRefer</span><span class="p">(</span>
                                <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;Tb&quot;</span><span class="p">]</span>
                            <span class="p">),</span>
                            <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                            <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># The test_result is HIV negative</span>
                <span class="n">ACTUAL_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s2">&quot;VCTNegative&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_not_refer_if_neg</span><span class="p">:</span>
                    <span class="c1"># The test was negative: make referrals to other services:</span>

                    <span class="c1"># Consider if the person&#39;s risk will be reduced by behaviour change counselling</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s2">&quot;lm_behavchg&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">person_id</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span>
                    <span class="p">):</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_behaviour_change&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="c1"># If person is a man, and not circumcised, then consider referring to VMMC</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">person</span><span class="p">[</span><span class="s2">&quot;sex&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;M&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">person</span><span class="p">[</span><span class="s2">&quot;li_is_circ&quot;</span><span class="p">]):</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s2">&quot;lm_circ&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
                            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">person_id</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">x</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                                <span class="n">HSI_Hiv_Circ</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">),</span>
                                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                                <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                            <span class="p">)</span>

                    <span class="c1"># If person is a woman and FSW, and not currently on PrEP then consider referring to PrEP</span>
                    <span class="c1"># available 2018 onwards</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">person</span><span class="p">[</span><span class="s2">&quot;sex&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;F&quot;</span><span class="p">)</span>
                        <span class="o">&amp;</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;li_is_sexworker&quot;</span><span class="p">]</span>
                        <span class="o">&amp;</span> <span class="o">~</span><span class="n">person</span><span class="p">[</span><span class="s2">&quot;hv_is_on_prep&quot;</span><span class="p">]</span>
                        <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;prep_start_year&quot;</span><span class="p">])</span>
                    <span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">lm</span><span class="p">[</span><span class="s2">&quot;lm_prep&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">person_id</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span>
                                                             <span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                                <span class="n">HSI_Hiv_StartOrContinueOnPrep</span><span class="p">(</span>
                                    <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span>
                                <span class="p">),</span>
                                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                                <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Test was not possible, set blank footprint and schedule another test</span>
            <span class="n">ACTUAL_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s2">&quot;VCTNegative&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>

            <span class="c1"># set cap for number of repeat tests</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">counter_for_test_not_available</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># The current appointment is included in the count.</span>


            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">counter_for_test_not_available</span>
                <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;hiv_healthseekingbehaviour_cap&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="c1"># repeat appt for HIV test</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">),</span>
                    <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># Return the footprint. If it should be suppressed, return a blank footprint.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suppress_footprint</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ACTUAL_APPT_FOOTPRINT</span></div>
</div>



<div class="viewcode-block" id="HSI_Hiv_Circ">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_Circ">[docs]</a>
<span class="k">class</span> <span class="nc">HSI_Hiv_Circ</span><span class="p">(</span><span class="n">HSI_Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<div class="viewcode-block" id="HSI_Hiv_Circ.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_Circ.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">TREATMENT_ID</span> <span class="o">=</span> <span class="s2">&quot;Hiv_Prevention_Circumcision&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s2">&quot;MaleCirc&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span> <span class="o">=</span> <span class="s1">&#39;1b&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_of_occurrences</span> <span class="o">=</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="HSI_Hiv_Circ.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_Circ.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">squeeze_factor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Do the circumcision for this man. If he is already circumcised, this is a follow-up appointment.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_of_occurrences</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># The current appointment is included in the count.</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>  <span class="c1"># shortcut to the dataframe</span>

        <span class="n">person</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span>

        <span class="c1"># Do not run if the person is not alive</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;is_alive&quot;</span><span class="p">]:</span>
            <span class="k">return</span>

        <span class="c1"># if person not circumcised, perform the procedure</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;li_is_circ&quot;</span><span class="p">]:</span>
            <span class="c1"># Check/log use of consumables, if materials available, do circumcision and schedule follow-up appts</span>
            <span class="c1"># If materials not available, repeat the HSI, i.e., first appt.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_consumables</span><span class="p">(</span><span class="n">item_codes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;circ&#39;</span><span class="p">]):</span>
                <span class="c1"># Update circumcision state</span>
                <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;li_is_circ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># Add used equipment</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_equipment</span><span class="p">({</span><span class="s1">&#39;Drip stand&#39;</span><span class="p">,</span> <span class="s1">&#39;Stool, adjustable height&#39;</span><span class="p">,</span> <span class="s1">&#39;Autoclave&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;Bipolar Diathermy Machine&#39;</span><span class="p">,</span> <span class="s1">&#39;Bed, adult&#39;</span><span class="p">,</span> <span class="s1">&#39;Trolley, patient&#39;</span><span class="p">})</span>

                <span class="c1"># Schedule follow-up appts</span>
                <span class="c1"># schedule first follow-up appt, 3 days from procedure;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
                    <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># schedule second follow-up appt, 7 days from procedure;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">),</span>
                    <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># schedule repeating appt when consumables not available</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">number_of_occurrences</span>
                    <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;hiv_healthseekingbehaviour_cap&quot;</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span>
                        <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">weeks</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                        <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="HSI_Hiv_StartInfantProphylaxis">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_StartInfantProphylaxis">[docs]</a>
<span class="k">class</span> <span class="nc">HSI_Hiv_StartInfantProphylaxis</span><span class="p">(</span><span class="n">HSI_Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<div class="viewcode-block" id="HSI_Hiv_StartInfantProphylaxis.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_StartInfantProphylaxis.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">referred_from</span><span class="p">,</span> <span class="n">repeat_visits</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">Hiv</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">TREATMENT_ID</span> <span class="o">=</span> <span class="s2">&quot;Hiv_Prevention_Infant&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s2">&quot;Peds&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;VCTNegative&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span> <span class="o">=</span> <span class="s1">&#39;1a&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">referred_from</span> <span class="o">=</span> <span class="n">referred_from</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repeat_visits</span> <span class="o">=</span> <span class="n">repeat_visits</span></div>


<div class="viewcode-block" id="HSI_Hiv_StartInfantProphylaxis.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_StartInfantProphylaxis.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">squeeze_factor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start infant prophylaxis for this infant lasting for duration of breastfeeding</span>
<span class="sd">        or up to 18 months</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">person</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span>

        <span class="c1"># Do not run if the child is not alive or is diagnosed with hiv</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;is_alive&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;hv_diagnosed&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_blank_appt_footprint</span><span class="p">()</span>

        <span class="c1"># if breastfeeding has ceased or child &gt;18 months, no further prophylaxis required</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;nb_breastfeeding_status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">)</span> \
            <span class="ow">or</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;age_years&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">1.5</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_blank_appt_footprint</span><span class="p">()</span>

        <span class="c1"># Check that infant prophylaxis is available and if it is, initiate:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_consumables</span><span class="p">(</span>
            <span class="n">item_codes</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;infant_prep&#39;</span><span class="p">]:</span> <span class="mi">63</span><span class="p">}</span>
        <span class="p">):</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_is_on_prep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Schedule follow-up visit for 3 months time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">hsi_event</span><span class="o">=</span><span class="n">HSI_Hiv_StartInfantProphylaxis</span><span class="p">(</span>
                    <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span>
                    <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span>
                    <span class="n">referred_from</span><span class="o">=</span><span class="s2">&quot;repeat3months&quot;</span><span class="p">,</span>
                    <span class="n">repeat_visits</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
                <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># infant does not get NVP now but has repeat visit scheduled up to 5 times</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_is_on_prep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">repeat_visits</span>
                <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;hiv_healthseekingbehaviour_cap&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">repeat_visits</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Schedule repeat visit for one week&#39;s time</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                    <span class="n">hsi_event</span><span class="o">=</span><span class="n">HSI_Hiv_StartInfantProphylaxis</span><span class="p">(</span>
                        <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span>
                        <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span>
                        <span class="n">referred_from</span><span class="o">=</span><span class="s2">&quot;repeatNoCons&quot;</span><span class="p">,</span>
                        <span class="n">repeat_visits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat_visits</span><span class="p">),</span>
                    <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">),</span>
                    <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span></div>


<div class="viewcode-block" id="HSI_Hiv_StartInfantProphylaxis.never_ran">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_StartInfantProphylaxis.never_ran">[docs]</a>
    <span class="k">def</span> <span class="nf">never_ran</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This is called if this HSI was never run.</span>
<span class="sd">        Default the person to being off PrEP&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="s2">&quot;hv_is_on_prep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span></div>
</div>



<div class="viewcode-block" id="HSI_Hiv_StartOrContinueOnPrep">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_StartOrContinueOnPrep">[docs]</a>
<span class="k">class</span> <span class="nc">HSI_Hiv_StartOrContinueOnPrep</span><span class="p">(</span><span class="n">HSI_Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<div class="viewcode-block" id="HSI_Hiv_StartOrContinueOnPrep.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_StartOrContinueOnPrep.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">Hiv</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">TREATMENT_ID</span> <span class="o">=</span> <span class="s2">&quot;Hiv_Prevention_Prep&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s2">&quot;PharmDispensing&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;VCTNegative&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span> <span class="o">=</span> <span class="s1">&#39;1a&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter_for_drugs_not_available</span> <span class="o">=</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="HSI_Hiv_StartOrContinueOnPrep.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_StartOrContinueOnPrep.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">squeeze_factor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start PrEP for this person; or continue them on PrEP for 3 more months&quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">person</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span>

        <span class="c1"># Do not run if the person is not alive or is diagnosed with hiv</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="p">(</span><span class="ow">not</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;is_alive&quot;</span><span class="p">])</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">person</span><span class="p">[</span><span class="s2">&quot;hv_diagnosed&quot;</span><span class="p">])</span>
        <span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># Run an HIV test</span>
        <span class="n">test_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dx_manager</span><span class="o">.</span><span class="n">run_dx_test</span><span class="p">(</span>
            <span class="n">dx_tests_to_run</span><span class="o">=</span><span class="s2">&quot;hiv_rapid_test&quot;</span><span class="p">,</span> <span class="n">hsi_event</span><span class="o">=</span><span class="bp">self</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_number_tests&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_last_test_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>

        <span class="c1"># If test is positive, flag as diagnosed and refer to ART</span>
        <span class="k">if</span> <span class="n">test_result</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># label as diagnosed</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_diagnosed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Do actions for when a person has been diagnosed with HIV</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">do_when_hiv_diagnosed</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s2">&quot;Over5OPD&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;VCTPositive&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>

        <span class="c1"># Check that PrEP is available and if it is, initiate or continue  PrEP:</span>
        <span class="n">quantity_required</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;dispensation_period_months&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">30</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_consumables</span><span class="p">(</span>
            <span class="n">item_codes</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;prep&#39;</span><span class="p">]:</span> <span class="n">quantity_required</span><span class="p">}</span>
        <span class="p">):</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_is_on_prep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Schedule &#39;decision about whether to continue on PrEP&#39; for 3 months time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
                <span class="n">Hiv_DecisionToContinueOnPrEP</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If PrEP is not available, the person will default and not be on PrEP</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_is_on_prep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">counter_for_drugs_not_available</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="mi">1</span>  <span class="c1"># The current appointment is included in the count.</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">counter_for_drugs_not_available</span>
                <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;hiv_healthseekingbehaviour_cap&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="c1"># Schedule repeat visit for one week&#39;s time</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">),</span>
                    <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span></div>


<div class="viewcode-block" id="HSI_Hiv_StartOrContinueOnPrep.never_ran">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_StartOrContinueOnPrep.never_ran">[docs]</a>
    <span class="k">def</span> <span class="nf">never_ran</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This is called if this HSI was never run.</span>
<span class="sd">        Default the person to being off PrEP&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="s2">&quot;hv_is_on_prep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span></div>
</div>



<div class="viewcode-block" id="HSI_Hiv_StartOrContinueTreatment">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_StartOrContinueTreatment">[docs]</a>
<span class="k">class</span> <span class="nc">HSI_Hiv_StartOrContinueTreatment</span><span class="p">(</span><span class="n">HSI_Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>

<div class="viewcode-block" id="HSI_Hiv_StartOrContinueTreatment.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_StartOrContinueTreatment.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">facility_level_of_this_hsi</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">Hiv</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">TREATMENT_ID</span> <span class="o">=</span> <span class="s2">&quot;Hiv_Treatment&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span> <span class="o">=</span> <span class="n">facility_level_of_this_hsi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter_for_drugs_not_available</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter_for_did_not_run</span> <span class="o">=</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="HSI_Hiv_StartOrContinueTreatment.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_StartOrContinueTreatment.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">squeeze_factor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This is a Health System Interaction Event - start or continue HIV treatment for 6 more months&quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">person</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span>
        <span class="n">art_status_at_beginning_of_hsi</span> <span class="o">=</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;hv_art&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;is_alive&quot;</span><span class="p">]:</span>
            <span class="k">return</span>

        <span class="c1"># Confirm that the person is diagnosed (this should not run if they are not)</span>
        <span class="k">assert</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;hv_diagnosed&quot;</span><span class="p">]</span>

        <span class="c1"># check whether person had Rx at least 3 months ago and is now due repeat prescription</span>
        <span class="c1"># alternate routes into testing/tx may mean person already has recent ARV dispensation</span>
        <span class="k">if</span> <span class="n">person</span><span class="p">[</span><span class="s1">&#39;hv_date_last_ART&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;dispensation_period_months&#39;</span><span class="p">])):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_blank_appt_footprint</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">art_status_at_beginning_of_hsi</span> <span class="o">==</span> <span class="s2">&quot;not&quot;</span><span class="p">:</span>

            <span class="k">assert</span> <span class="n">person</span><span class="p">[</span>
                <span class="s2">&quot;hv_inf&quot;</span>
            <span class="p">]</span>  <span class="c1"># after the test results, it can be guaranteed that the person is HIV-pos.</span>

            <span class="c1"># Try to initiate the person onto ART:</span>
            <span class="n">drugs_were_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_at_initiation</span><span class="p">(</span><span class="n">person_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Try to continue the person on ART:</span>
            <span class="n">drugs_were_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_at_continuation</span><span class="p">(</span><span class="n">person_id</span><span class="p">)</span>

        <span class="c1"># if ART is available (1st item in drugs_were_available dict)</span>
        <span class="k">if</span> <span class="n">drugs_were_available</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;art&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s1">&#39;hv_date_last_ART&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>

            <span class="c1"># If person has been placed/continued on ART, schedule &#39;decision about whether to continue on Treatment</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">schedule_event</span><span class="p">(</span>
                <span class="n">Hiv_DecisionToContinueTreatment</span><span class="p">(</span>
                    <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span>
                <span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;dispensation_period_months&#39;</span><span class="p">]),</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># logger for drugs not available</span>
            <span class="n">person_details_for_tx</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="n">person</span><span class="p">[</span><span class="s1">&#39;age_years&#39;</span><span class="p">],</span>
                <span class="s1">&#39;facility_level&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span><span class="p">,</span>
                <span class="s1">&#39;number_appts&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter_for_drugs_not_available</span><span class="p">,</span>
                <span class="s1">&#39;district&#39;</span><span class="p">:</span> <span class="n">person</span><span class="p">[</span><span class="s1">&#39;district_of_residence&#39;</span><span class="p">],</span>
                <span class="s1">&#39;person_id&#39;</span><span class="p">:</span> <span class="n">person_id</span><span class="p">,</span>
                <span class="s1">&#39;drugs_available&#39;</span><span class="p">:</span> <span class="n">drugs_were_available</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;hiv_arv_NA&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">person_details_for_tx</span><span class="p">)</span>

            <span class="c1"># As drugs were not available, the person will default to being off ART (...if they were on ART at the</span>
            <span class="c1"># beginning of the HSI.)</span>
            <span class="c1"># NB. If the person was not on ART at the beginning of the HSI, then there is no need to stop them (which</span>
            <span class="c1">#  causes a new AIDSOnsetEvent to be scheduled.)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">counter_for_drugs_not_available</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># The current appointment is included in the count.</span>

            <span class="k">if</span> <span class="n">art_status_at_beginning_of_hsi</span> <span class="o">!=</span> <span class="s2">&quot;not&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">stops_treatment</span><span class="p">(</span><span class="n">person_id</span><span class="p">)</span>

            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span>
                <span class="s2">&quot;probability_of_seeking_further_art_appointment_if_drug_not_available&quot;</span>
            <span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">p</span><span class="p">:</span>

                <span class="c1"># add in referral straight back to tx</span>
                <span class="c1"># if defaulting, seek another treatment appointment in 6 months</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                    <span class="n">hsi_event</span><span class="o">=</span><span class="n">HSI_Hiv_StartOrContinueTreatment</span><span class="p">(</span>
                        <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span>
                        <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span>
                        <span class="n">facility_level_of_this_hsi</span><span class="o">=</span><span class="s2">&quot;1a&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">6</span><span class="p">),</span>
                    <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If person &#39;decides to&#39; seek another treatment appointment,</span>
                <span class="c1"># schedule a new HSI appointment for next month</span>
                <span class="c1"># NB. With a probability of 1.0, this will keep occurring,</span>
                <span class="c1"># if person has already tried unsuccessfully to get ART at level 1a 2 times</span>
                <span class="c1">#  then refer to level 1b</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter_for_drugs_not_available</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="c1"># repeat attempt for ARVs at level 1a</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span>
                        <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                        <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># refer to higher facility level</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                        <span class="n">hsi_event</span><span class="o">=</span><span class="n">HSI_Hiv_StartOrContinueTreatment</span><span class="p">(</span>
                            <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span>
                            <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span>
                            <span class="n">facility_level_of_this_hsi</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                        <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="c1"># also screen for tb</span>
        <span class="k">if</span> <span class="s2">&quot;Tb&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">tb</span><span class="o">.</span><span class="n">HSI_Tb_ScreeningAndRefer</span><span class="p">(</span>
                    <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;Tb&quot;</span><span class="p">]</span>
                <span class="p">),</span>
                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                <span class="n">tclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="HSI_Hiv_StartOrContinueTreatment.do_at_initiation">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_StartOrContinueTreatment.do_at_initiation">[docs]</a>
    <span class="k">def</span> <span class="nf">do_at_initiation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Things to do when this the first appointment ART&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">person</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span>

        <span class="c1"># Check if drugs are available, and provide drugs</span>
        <span class="c1"># this will return a dict where the first item is ART and the second is cotrimoxazole</span>
        <span class="n">drugs_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_drugs</span><span class="p">(</span><span class="n">age_of_person</span><span class="o">=</span><span class="n">person</span><span class="p">[</span><span class="s2">&quot;age_years&quot;</span><span class="p">])</span>

        <span class="c1"># ART is first item in drugs_available dict</span>
        <span class="k">if</span> <span class="n">drugs_available</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;art&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="c1"># Assign person to be suppressed or un-suppressed viral load</span>
            <span class="c1"># (If person is VL suppressed This will prevent the Onset of AIDS, or an AIDS death if AIDS has already</span>
            <span class="c1"># onset)</span>
            <span class="n">vl_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_vl_status</span><span class="p">(</span>
                <span class="n">age_of_person</span><span class="o">=</span><span class="n">person</span><span class="p">[</span><span class="s2">&quot;age_years&quot;</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_art&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vl_status</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_date_treated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>

            <span class="c1"># If VL suppressed, remove any symptoms caused by this module</span>
            <span class="k">if</span> <span class="n">vl_status</span> <span class="o">==</span> <span class="s2">&quot;on_VL_suppressed&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;SymptomManager&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">clear_symptoms</span><span class="p">(</span>
                    <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">disease_module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span>
                <span class="p">)</span>

        <span class="c1"># if cotrimoxazole is available</span>
        <span class="k">if</span> <span class="n">drugs_available</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cotrim&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_on_cotrimoxazole&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Consider if TB treatment should start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consider_tb</span><span class="p">(</span><span class="n">person_id</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">drugs_available</span></div>


<div class="viewcode-block" id="HSI_Hiv_StartOrContinueTreatment.do_at_continuation">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_StartOrContinueTreatment.do_at_continuation">[docs]</a>
    <span class="k">def</span> <span class="nf">do_at_continuation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Things to do when the person is already on ART&quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">person</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span>

        <span class="c1"># default to person stopping cotrimoxazole</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_on_cotrimoxazole&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Viral Load Monitoring</span>
        <span class="c1"># NB. This does not have a direct effect on outcomes for the person.</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_consumables</span><span class="p">(</span><span class="n">item_codes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span><span class="s1">&#39;vl_measurement&#39;</span><span class="p">])</span>

        <span class="c1"># Check if drugs are available, and provide drugs:</span>
        <span class="n">drugs_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_drugs</span><span class="p">(</span><span class="n">age_of_person</span><span class="o">=</span><span class="n">person</span><span class="p">[</span><span class="s2">&quot;age_years&quot;</span><span class="p">])</span>

        <span class="c1"># if cotrimoxazole is available, update person&#39;s property</span>
        <span class="k">if</span> <span class="n">drugs_available</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cotrim&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_on_cotrimoxazole&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">drugs_available</span></div>


<div class="viewcode-block" id="HSI_Hiv_StartOrContinueTreatment.determine_vl_status">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_StartOrContinueTreatment.determine_vl_status">[docs]</a>
    <span class="k">def</span> <span class="nf">determine_vl_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">age_of_person</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper function to determine the VL status that the person will have.</span>
<span class="sd">        Return what will be the status of &quot;hv_art&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prob_vs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">prob_viral_suppression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">age_of_person</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="s2">&quot;on_VL_suppressed&quot;</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">prob_vs</span><span class="p">)</span>
            <span class="k">else</span> <span class="s2">&quot;on_not_VL_suppressed&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="HSI_Hiv_StartOrContinueTreatment.get_drugs">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_StartOrContinueTreatment.get_drugs">[docs]</a>
    <span class="k">def</span> <span class="nf">get_drugs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">age_of_person</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper function to get the ART according to the age of the person being treated. Returns dict to indicate</span>
<span class="sd">        whether individual drugs were available&quot;&quot;&quot;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">dispensation_days</span> <span class="o">=</span> <span class="mi">30</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;dispensation_period_months&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">age_of_person</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;ART_age_cutoff_young_child&quot;</span><span class="p">]:</span>
            <span class="c1"># Formulation for young children</span>
            <span class="n">drugs_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_consumables</span><span class="p">(</span>
                <span class="n">item_codes</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span>
                                <span class="s1">&#39;First line ART regimen: young child&#39;</span><span class="p">]:</span> <span class="n">dispensation_days</span> <span class="o">*</span> <span class="mi">2</span><span class="p">},</span>
                <span class="n">optional_item_codes</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span>
                                         <span class="s1">&#39;First line ART regimen: young child: cotrimoxazole&#39;</span><span class="p">]:</span> <span class="n">dispensation_days</span> <span class="o">*</span> <span class="mi">240</span><span class="p">},</span>
                <span class="n">return_individual_results</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">age_of_person</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;ART_age_cutoff_older_child&quot;</span><span class="p">]:</span>
            <span class="c1"># Formulation for older children</span>
            <span class="n">drugs_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_consumables</span><span class="p">(</span>
                <span class="n">item_codes</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span>
                                <span class="s1">&#39;First line ART regimen: older child&#39;</span><span class="p">]:</span> <span class="n">dispensation_days</span> <span class="o">*</span> <span class="mi">3</span><span class="p">},</span>
                <span class="n">optional_item_codes</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span>
                    <span class="s1">&#39;First line ART regimen: older child: cotrimoxazole&#39;</span><span class="p">]:</span> <span class="n">dispensation_days</span> <span class="o">*</span> <span class="mi">480</span><span class="p">},</span>
                <span class="n">return_individual_results</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Formulation for adults</span>
            <span class="n">drugs_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_consumables</span><span class="p">(</span>
                <span class="n">item_codes</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span>
                                <span class="s1">&#39;First-line ART regimen: adult&#39;</span><span class="p">]:</span> <span class="n">dispensation_days</span><span class="p">},</span>
                <span class="n">optional_item_codes</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">item_codes_for_consumables_required</span><span class="p">[</span>
                    <span class="s1">&#39;First-line ART regimen: adult: cotrimoxazole&#39;</span><span class="p">]:</span> <span class="n">dispensation_days</span> <span class="o">*</span> <span class="mi">960</span><span class="p">},</span>
                <span class="n">return_individual_results</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># add drug names to dict</span>
        <span class="n">drugs_available</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;art&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">drugs_available</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;cotrim&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">drugs_available</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">drugs_available</span></div>


<div class="viewcode-block" id="HSI_Hiv_StartOrContinueTreatment.consider_tb">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_StartOrContinueTreatment.consider_tb">[docs]</a>
    <span class="k">def</span> <span class="nf">consider_tb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        screen for tb</span>
<span class="sd">        Consider whether IPT is needed at this time. This is run only when treatment is initiated.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;Tb&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;Tb&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">consider_ipt_for_those_initiating_art</span><span class="p">(</span>
                <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="HSI_Hiv_StartOrContinueTreatment.never_ran">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_StartOrContinueTreatment.never_ran">[docs]</a>
    <span class="k">def</span> <span class="nf">never_ran</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This is called if this HSI was never run.</span>
<span class="sd">        * Default the person to being off ART.</span>
<span class="sd">        * Determine if they will re-seek care themselves in the future:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># stop treatment for this person</span>
        <span class="n">person_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">stops_treatment</span><span class="p">(</span><span class="n">person_id</span><span class="p">)</span>

        <span class="c1"># sample whether person will seek further appt</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span>
            <span class="s2">&quot;probability_of_seeking_further_art_appointment_if_appointment_not_available&quot;</span>
        <span class="p">]:</span>
            <span class="c1"># schedule HSI</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_hsi_event</span><span class="p">(</span>
                <span class="n">HSI_Hiv_StartOrContinueTreatment</span><span class="p">(</span>
                    <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">facility_level_of_this_hsi</span><span class="o">=</span><span class="s2">&quot;1a&quot;</span>
                <span class="p">),</span>
                <span class="n">topen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">14</span><span class="p">),</span>
                <span class="n">tclose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">21</span><span class="p">),</span>
                <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">EXPECTED_APPT_FOOTPRINT</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the appointment footprint for this person according to their current status:</span>
<span class="sd">         * `NewAdult` for an adult, newly starting treatment</span>
<span class="sd">         * `EstNonCom` for an adult, re-starting treatment or already on treatment</span>
<span class="sd">         (NB. This is an appointment type that assumes that the patient does not have complications.)</span>
<span class="sd">         * `Peds` for a child - whether newly starting or already on treatment</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">person_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s1">&#39;age_years&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s2">&quot;Peds&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>  <span class="c1"># Child</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s1">&#39;hv_art&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;not&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s1">&#39;hv_date_treated&#39;</span><span class="p">])</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s2">&quot;NewAdult&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>  <span class="c1"># Adult newly starting treatment</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({</span><span class="s2">&quot;EstNonCom&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>  <span class="c1"># Adult already on treatment</span></div>



<div class="viewcode-block" id="HSI_Hiv_EndOfLifeCare">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_EndOfLifeCare">[docs]</a>
<span class="k">class</span> <span class="nc">HSI_Hiv_EndOfLifeCare</span><span class="p">(</span><span class="n">HSI_Event</span><span class="p">,</span> <span class="n">IndividualScopeEventMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    this is a hospital stay for terminally-ill patients with AHD</span>
<span class="sd">    it does not affect disability weight or probability of death</span>
<span class="sd">    no consumables are logged but health system capacity (HR) is allocated</span>
<span class="sd">    there are no consequences if hospital bed is not available as person has scheduled death</span>
<span class="sd">    already within 2 weeks</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="HSI_Hiv_EndOfLifeCare.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_EndOfLifeCare.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">beddays</span><span class="o">=</span><span class="mi">17</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">Hiv</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">TREATMENT_ID</span> <span class="o">=</span> <span class="s2">&quot;Hiv_PalliativeCare&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_APPT_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_appt_footprint</span><span class="p">({})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ACCEPTED_FACILITY_LEVEL</span> <span class="o">=</span> <span class="s2">&quot;2&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">beddays</span> <span class="o">=</span> <span class="n">beddays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BEDDAYS_FOOTPRINT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_beddays_footprint</span><span class="p">({</span><span class="s2">&quot;general_bed&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">beddays</span><span class="p">})</span></div>


<div class="viewcode-block" id="HSI_Hiv_EndOfLifeCare.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HSI_Hiv_EndOfLifeCare.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">squeeze_factor</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">hs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;HealthSystem&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;is_alive&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">hs</span><span class="o">.</span><span class="n">get_blank_appt_footprint</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">person_id</span><span class="p">,</span> <span class="s2">&quot;hv_art&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;virally_suppressed&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hs</span><span class="o">.</span><span class="n">get_blank_appt_footprint</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;HSI_Hiv_EndOfLifeCare: inpatient admission for </span><span class="si">{</span><span class="n">person_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>



<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1">#   Logging</span>
<span class="c1"># ---------------------------------------------------------------------------</span>


<div class="viewcode-block" id="HivLoggingEvent">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivLoggingEvent">[docs]</a>
<span class="k">class</span> <span class="nc">HivLoggingEvent</span><span class="p">(</span><span class="n">RegularEvent</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">):</span>
<div class="viewcode-block" id="HivLoggingEvent.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivLoggingEvent.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Log Current status of the population, every year</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">repeat</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">))</span></div>


<div class="viewcode-block" id="HivLoggingEvent.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivLoggingEvent.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
        <span class="c1"># get some summary statistics</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span>

        <span class="c1"># ------------------------------------ SUMMARIES ------------------------------------</span>
        <span class="c1"># population</span>
        <span class="n">pop_male_15plus</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;M&quot;</span><span class="p">)]</span>
        <span class="p">)</span>
        <span class="n">pop_female_15plus</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;F&quot;</span><span class="p">)]</span>
        <span class="p">)</span>

        <span class="c1"># plhiv</span>
        <span class="n">male_plhiv</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;M&quot;</span><span class="p">)]</span>
        <span class="p">)</span>
        <span class="n">female_plhiv</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;F&quot;</span><span class="p">)]</span>
        <span class="p">)</span>
        <span class="n">child_plhiv</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)])</span>
        <span class="n">total_plhiv</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">])</span>

        <span class="c1"># adult prevalence</span>
        <span class="n">adult_prev_15plus</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)]</span>
        <span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)])</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="n">adult_prev_1549</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">49</span><span class="p">)]</span>
        <span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">49</span><span class="p">)])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">49</span><span class="p">)])</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="c1"># child prevalence</span>
        <span class="n">child_prev</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)]</span>
        <span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)]</span>
                <span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)])</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="c1"># incidence in the period since the last log for 15+ and 15-49 year-olds (denominator is approximate)</span>
        <span class="n">n_new_infections_adult_15plus</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_date_inf</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))</span>
                <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">denom_adults_15plus</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)])</span>
        <span class="n">adult_inc_15plus</span> <span class="o">=</span> <span class="n">n_new_infections_adult_15plus</span> <span class="o">/</span> <span class="n">denom_adults_15plus</span> <span class="k">if</span> <span class="n">denom_adults_15plus</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="n">n_new_infections_adult_1549</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">49</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_date_inf</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))</span>
                <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">denom_adults_1549</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">49</span><span class="p">)])</span>
        <span class="n">adult_inc_1549</span> <span class="o">=</span> <span class="n">n_new_infections_adult_1549</span> <span class="o">/</span> <span class="n">denom_adults_1549</span> <span class="k">if</span> <span class="n">denom_adults_1549</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="c1"># incidence in the period since the last log for 0-14 year-olds (denominator is approximate)</span>
        <span class="n">n_new_infections_children</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_date_inf</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))</span>
                <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">denom_children</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)])</span>
        <span class="n">child_inc</span> <span class="o">=</span> <span class="n">n_new_infections_children</span> <span class="o">/</span> <span class="n">denom_children</span> <span class="k">if</span> <span class="n">denom_children</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="c1"># hiv prev among female sex workers (aged 15-49)</span>
        <span class="n">n_fsw</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">li_is_sexworker</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;F&quot;</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">49</span><span class="p">)</span>
                <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">prev_hiv_fsw</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">0</span>
            <span class="k">if</span> <span class="n">n_fsw</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="k">else</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                    <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span>
                    <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">li_is_sexworker</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;F&quot;</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">49</span><span class="p">)</span>
                    <span class="p">]</span>
            <span class="p">)</span> <span class="o">/</span> <span class="n">n_fsw</span>
        <span class="p">)</span>

        <span class="n">total_population</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">])</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;summary_inc_and_prev_for_adults_and_children_and_fsw&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Summary of HIV among adult (15+ and 15-49) and children (0-14s) and female sex workers&quot;</span>
                        <span class="s2">&quot; (15-49)&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;pop_male_15plus&quot;</span><span class="p">:</span> <span class="n">pop_male_15plus</span><span class="p">,</span>
                <span class="s2">&quot;pop_female_15plus&quot;</span><span class="p">:</span> <span class="n">pop_female_15plus</span><span class="p">,</span>
                <span class="s2">&quot;pop_child&quot;</span><span class="p">:</span> <span class="n">denom_children</span><span class="p">,</span>
                <span class="s2">&quot;pop_total&quot;</span><span class="p">:</span> <span class="n">total_population</span><span class="p">,</span>
                <span class="s2">&quot;male_plhiv_15plus&quot;</span><span class="p">:</span> <span class="n">male_plhiv</span><span class="p">,</span>
                <span class="s2">&quot;female_plhiv_15plus&quot;</span><span class="p">:</span> <span class="n">female_plhiv</span><span class="p">,</span>
                <span class="s2">&quot;child_plhiv&quot;</span><span class="p">:</span> <span class="n">child_plhiv</span><span class="p">,</span>
                <span class="s2">&quot;total_plhiv&quot;</span><span class="p">:</span> <span class="n">total_plhiv</span><span class="p">,</span>
                <span class="s2">&quot;hiv_prev_adult_15plus&quot;</span><span class="p">:</span> <span class="n">adult_prev_15plus</span><span class="p">,</span>
                <span class="s2">&quot;hiv_prev_adult_1549&quot;</span><span class="p">:</span> <span class="n">adult_prev_1549</span><span class="p">,</span>
                <span class="s2">&quot;hiv_prev_child&quot;</span><span class="p">:</span> <span class="n">child_prev</span><span class="p">,</span>
                <span class="s2">&quot;hiv_adult_inc_15plus&quot;</span><span class="p">:</span> <span class="n">adult_inc_15plus</span><span class="p">,</span>
                <span class="s2">&quot;n_new_infections_adult_1549&quot;</span><span class="p">:</span> <span class="n">n_new_infections_adult_1549</span><span class="p">,</span>
                <span class="s2">&quot;hiv_adult_inc_1549&quot;</span><span class="p">:</span> <span class="n">adult_inc_1549</span><span class="p">,</span>
                <span class="s2">&quot;hiv_child_inc&quot;</span><span class="p">:</span> <span class="n">child_inc</span><span class="p">,</span>
                <span class="s2">&quot;hiv_prev_fsw&quot;</span><span class="p">:</span> <span class="n">prev_hiv_fsw</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># store some outputs in dict for calibration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">hiv_outputs</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">hiv_outputs</span><span class="p">[</span><span class="s2">&quot;hiv_prev_adult_1549&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">adult_prev_1549</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">hiv_outputs</span><span class="p">[</span><span class="s2">&quot;hiv_adult_inc_1549&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">adult_inc_1549</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">hiv_outputs</span><span class="p">[</span><span class="s2">&quot;hiv_prev_child&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">child_prev</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">hiv_outputs</span><span class="p">[</span><span class="s2">&quot;population&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">total_population</span><span class="p">]</span>

        <span class="c1"># ------------------------------------ PREVALENCE BY AGE and SEX  ------------------------------------</span>

        <span class="c1"># Prevalence by Age/Sex (to make every category be output, do separately by &#39;sex&#39;)</span>
        <span class="n">prev_by_age_and_sex</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">sex</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;F&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">]:</span>
            <span class="n">n_hiv</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="n">sex</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;age_range&quot;</span><span class="p">])[</span><span class="s2">&quot;hv_inf&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">n_pop</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="n">sex</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;age_range&quot;</span><span class="p">])[</span><span class="s2">&quot;hv_inf&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
            <span class="n">prev_by_age_and_sex</span><span class="p">[</span><span class="n">sex</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_hiv</span> <span class="o">/</span> <span class="n">n_pop</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;prev_by_age_and_sex&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">prev_by_age_and_sex</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Prevalence of HIV split by age and sex&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">male_prev_1524</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;M&quot;</span><span class="p">)]</span>
        <span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;M&quot;</span><span class="p">)])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;M&quot;</span><span class="p">)])</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="n">male_prev_2549</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">49</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;M&quot;</span><span class="p">)]</span>
        <span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">49</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;M&quot;</span><span class="p">)])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">49</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;M&quot;</span><span class="p">)])</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="n">female_prev_1524</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;F&quot;</span><span class="p">)]</span>
        <span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;F&quot;</span><span class="p">)])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;F&quot;</span><span class="p">)])</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="n">female_prev_2549</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">49</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;F&quot;</span><span class="p">)]</span>
        <span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">49</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;F&quot;</span><span class="p">)])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">49</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;F&quot;</span><span class="p">)])</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="n">total_prev</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">])</span>

        <span class="c1"># incidence by age-group and sex</span>
        <span class="n">n_new_infections_male_1524</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;M&quot;</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_date_inf</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))</span>
                <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">denom_male_1524</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span>
                                  <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                                  <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;M&quot;</span><span class="p">)</span>
                                  <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">24</span><span class="p">)])</span>
        <span class="n">male_inc_1524</span> <span class="o">=</span> <span class="n">n_new_infections_male_1524</span> <span class="o">/</span> <span class="n">denom_male_1524</span> <span class="k">if</span> <span class="n">denom_male_1524</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="n">n_new_infections_male_2549</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">49</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;M&quot;</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_date_inf</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))</span>
                <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">denom_male_2549</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span>
                                  <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                                  <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;M&quot;</span><span class="p">)</span>
                                  <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">49</span><span class="p">)])</span>
        <span class="n">male_inc_2549</span> <span class="o">=</span> <span class="n">n_new_infections_male_2549</span> <span class="o">/</span> <span class="n">denom_male_2549</span> <span class="k">if</span> <span class="n">denom_male_2549</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="n">n_new_infections_male_1549</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">49</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;M&quot;</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_date_inf</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))</span>
                <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">n_new_infections_female_1524</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;F&quot;</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_date_inf</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))</span>
                <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">denom_female_1524</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span>
                                    <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;F&quot;</span><span class="p">)</span>
                                    <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">24</span><span class="p">)])</span>
        <span class="n">female_inc_1524</span> <span class="o">=</span> <span class="n">n_new_infections_female_1524</span> <span class="o">/</span> <span class="n">denom_female_1524</span> <span class="k">if</span> <span class="n">denom_female_1524</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="n">n_new_infections_female_2549</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">49</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;F&quot;</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_date_inf</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))</span>
                <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">denom_female_2549</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span>
                                    <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;F&quot;</span><span class="p">)</span>
                                    <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">age_years</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">49</span><span class="p">)])</span>
        <span class="n">female_inc_2549</span> <span class="o">=</span> <span class="n">n_new_infections_female_2549</span> <span class="o">/</span> <span class="n">denom_female_2549</span> <span class="k">if</span> <span class="n">denom_female_2549</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;infections_by_2age_groups_and_sex&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;male_prev_1524&quot;</span><span class="p">:</span> <span class="n">male_prev_1524</span><span class="p">,</span>
                <span class="s2">&quot;male_prev_2549&quot;</span><span class="p">:</span> <span class="n">male_prev_2549</span><span class="p">,</span>
                <span class="s2">&quot;female_prev_1524&quot;</span><span class="p">:</span> <span class="n">female_prev_1524</span><span class="p">,</span>
                <span class="s2">&quot;female_prev_2549&quot;</span><span class="p">:</span> <span class="n">female_prev_2549</span><span class="p">,</span>
                <span class="s2">&quot;total_prev&quot;</span><span class="p">:</span> <span class="n">total_prev</span><span class="p">,</span>
                <span class="s2">&quot;n_new_infections_male_1524&quot;</span><span class="p">:</span> <span class="n">n_new_infections_male_1524</span><span class="p">,</span>
                <span class="s2">&quot;n_new_infections_male_2549&quot;</span><span class="p">:</span> <span class="n">n_new_infections_male_2549</span><span class="p">,</span>
                <span class="s2">&quot;n_new_infections_male_1549&quot;</span><span class="p">:</span> <span class="n">n_new_infections_male_1549</span><span class="p">,</span>
                <span class="s2">&quot;n_new_infections_female_1524&quot;</span><span class="p">:</span> <span class="n">n_new_infections_female_1524</span><span class="p">,</span>
                <span class="s2">&quot;n_new_infections_female_2549&quot;</span><span class="p">:</span> <span class="n">n_new_infections_female_2549</span><span class="p">,</span>
                <span class="s2">&quot;male_inc_1524&quot;</span><span class="p">:</span> <span class="n">male_inc_1524</span><span class="p">,</span>
                <span class="s2">&quot;male_inc_2549&quot;</span><span class="p">:</span> <span class="n">male_inc_2549</span><span class="p">,</span>
                <span class="s2">&quot;female_inc_1524&quot;</span><span class="p">:</span> <span class="n">female_inc_1524</span><span class="p">,</span>
                <span class="s2">&quot;female_inc_2549&quot;</span><span class="p">:</span> <span class="n">female_inc_2549</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;HIV infections split by 2 age-groups age and sex&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;prev_by_age_and_sex&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">prev_by_age_and_sex</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Prevalence of HIV split by age and sex&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># ------------------------------------ TESTING ------------------------------------</span>
        <span class="c1"># testing can happen through lm[spontaneous_testing] or symptom-driven or ANC or TB</span>

        <span class="c1"># proportion of adult population tested in past year</span>
        <span class="n">n_tested</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_number_tests</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_last_test_date</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))</span>
                <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">n_pop</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)])</span>
        <span class="n">tested</span> <span class="o">=</span> <span class="n">n_tested</span> <span class="o">/</span> <span class="n">n_pop</span> <span class="k">if</span> <span class="n">n_pop</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="c1"># proportion of adult population tested in past year by sex</span>
        <span class="n">testing_by_sex</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">sex</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;F&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">]:</span>
            <span class="n">n_tested</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="n">sex</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_number_tests</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_last_test_date</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))</span>
                    <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">n_pop</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="n">sex</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)])</span>
            <span class="n">testing_by_sex</span><span class="p">[</span><span class="n">sex</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_tested</span> <span class="o">/</span> <span class="n">n_pop</span> <span class="k">if</span> <span class="n">n_pop</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="c1"># per_capita_testing_rate: number of tests administered divided by population</span>
        <span class="n">current_testing_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">per_capita_testing_rate</span><span class="p">()</span>

        <span class="c1"># testing yield: number positive results divided by number tests performed</span>
        <span class="c1"># if person has multiple tests in one year, will only count 1</span>
        <span class="n">total_tested</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_number_tests</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                   <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_last_test_date</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))</span>
                   <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">total_tested_hiv_positive</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span>
                   <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_number_tests</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                   <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_last_test_date</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))</span>
                   <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">testing_yield</span> <span class="o">=</span> <span class="n">total_tested_hiv_positive</span> <span class="o">/</span> <span class="n">total_tested</span> <span class="k">if</span> <span class="n">total_tested</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="c1"># ------------------------------------ TREATMENT ------------------------------------</span>
        <span class="k">def</span> <span class="nf">treatment_counts</span><span class="p">(</span><span class="n">subset</span><span class="p">):</span>
            <span class="c1"># total number of subset (subset is a true/false series)</span>
            <span class="n">count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>
            <span class="c1"># proportion of subset living with HIV that are diagnosed:</span>
            <span class="n">proportion_diagnosed</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">sum</span><span class="p">(</span><span class="n">subset</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_diagnosed</span><span class="p">)</span> <span class="o">/</span> <span class="n">count</span> <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
            <span class="p">)</span>
            <span class="c1"># proportions of subset living with HIV on treatment:</span>
            <span class="n">art</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">subset</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_art</span> <span class="o">!=</span> <span class="s2">&quot;not&quot;</span><span class="p">))</span>
            <span class="n">art_cov</span> <span class="o">=</span> <span class="n">art</span> <span class="o">/</span> <span class="n">count</span> <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>

            <span class="c1"># proportion of subset on treatment that have good VL suppression</span>
            <span class="n">art_vs</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">subset</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_art</span> <span class="o">==</span> <span class="s2">&quot;on_VL_suppressed&quot;</span><span class="p">))</span>
            <span class="n">art_cov_vs</span> <span class="o">=</span> <span class="n">art_vs</span> <span class="o">/</span> <span class="n">art</span> <span class="k">if</span> <span class="n">art</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
            <span class="k">return</span> <span class="n">proportion_diagnosed</span><span class="p">,</span> <span class="n">art_cov</span><span class="p">,</span> <span class="n">art_cov_vs</span>

        <span class="n">alive_infected</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span>
        <span class="n">dx_adult</span><span class="p">,</span> <span class="n">art_cov_adult</span><span class="p">,</span> <span class="n">art_cov_vs_adult</span> <span class="o">=</span> <span class="n">treatment_counts</span><span class="p">(</span>
            <span class="n">alive_infected</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">dx_children</span><span class="p">,</span> <span class="n">art_cov_children</span><span class="p">,</span> <span class="n">art_cov_vs_children</span> <span class="o">=</span> <span class="n">treatment_counts</span><span class="p">(</span>
            <span class="n">alive_infected</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">n_on_art_male_15plus</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;M&quot;</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_art</span> <span class="o">!=</span> <span class="s2">&quot;not&quot;</span><span class="p">)</span>
                <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">n_on_art_female_15plus</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;F&quot;</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_art</span> <span class="o">!=</span> <span class="s2">&quot;not&quot;</span><span class="p">)</span>
                <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">n_on_art_children</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_art</span> <span class="o">!=</span> <span class="s2">&quot;not&quot;</span><span class="p">)</span>
                <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">n_on_art_total</span> <span class="o">=</span> <span class="n">n_on_art_male_15plus</span> <span class="o">+</span> <span class="n">n_on_art_female_15plus</span> <span class="o">+</span> <span class="n">n_on_art_children</span>

        <span class="c1"># ------------------------------------ BEHAVIOUR CHANGE ------------------------------------</span>

        <span class="c1"># proportion of adults (15+) exposed to behaviour change intervention</span>
        <span class="n">prop_adults_exposed_to_behav_intv</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_behaviour_change</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)]</span>
        <span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)])</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="c1"># ------------------------------------ PREP AMONG FSW ------------------------------------</span>
        <span class="n">prop_fsw_on_prep</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">0</span>
            <span class="k">if</span> <span class="n">n_fsw</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="k">else</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">df</span><span class="p">[</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">is_alive</span>
                    <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">li_is_sexworker</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_is_on_prep</span>
                    <span class="p">]</span>
            <span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">li_is_sexworker</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)])</span>
        <span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">li_is_sexworker</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)])</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="c1"># ------------------------------------ MALE CIRCUMCISION ------------------------------------</span>
        <span class="c1"># NB. Among adult men</span>
        <span class="n">prop_men_circ</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;M&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">li_is_circ</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;M&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;M&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)])</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;hiv_program_coverage&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Coverage of interventions for HIV among adult (15+) and children (0-14s)&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;number_adults_tested&quot;</span><span class="p">:</span> <span class="n">n_tested</span><span class="p">,</span>
                <span class="s2">&quot;prop_tested_adult&quot;</span><span class="p">:</span> <span class="n">tested</span><span class="p">,</span>
                <span class="s2">&quot;prop_tested_adult_male&quot;</span><span class="p">:</span> <span class="n">testing_by_sex</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">],</span>
                <span class="s2">&quot;prop_tested_adult_female&quot;</span><span class="p">:</span> <span class="n">testing_by_sex</span><span class="p">[</span><span class="s2">&quot;F&quot;</span><span class="p">],</span>
                <span class="s2">&quot;per_capita_testing_rate&quot;</span><span class="p">:</span> <span class="n">current_testing_rate</span><span class="p">,</span>
                <span class="s2">&quot;testing_yield&quot;</span><span class="p">:</span> <span class="n">testing_yield</span><span class="p">,</span>
                <span class="s2">&quot;dx_adult&quot;</span><span class="p">:</span> <span class="n">dx_adult</span><span class="p">,</span>
                <span class="s2">&quot;dx_childen&quot;</span><span class="p">:</span> <span class="n">dx_children</span><span class="p">,</span>
                <span class="s2">&quot;art_coverage_adult&quot;</span><span class="p">:</span> <span class="n">art_cov_adult</span><span class="p">,</span>
                <span class="s2">&quot;art_coverage_adult_VL_suppression&quot;</span><span class="p">:</span> <span class="n">art_cov_vs_adult</span><span class="p">,</span>
                <span class="s2">&quot;art_coverage_child&quot;</span><span class="p">:</span> <span class="n">art_cov_children</span><span class="p">,</span>
                <span class="s2">&quot;art_coverage_child_VL_suppression&quot;</span><span class="p">:</span> <span class="n">art_cov_vs_children</span><span class="p">,</span>
                <span class="s2">&quot;n_on_art_total&quot;</span><span class="p">:</span> <span class="n">n_on_art_total</span><span class="p">,</span>
                <span class="s2">&quot;n_on_art_male_15plus&quot;</span><span class="p">:</span> <span class="n">n_on_art_male_15plus</span><span class="p">,</span>
                <span class="s2">&quot;n_on_art_female_15plus&quot;</span><span class="p">:</span> <span class="n">n_on_art_female_15plus</span><span class="p">,</span>
                <span class="s2">&quot;n_on_art_children&quot;</span><span class="p">:</span> <span class="n">n_on_art_children</span><span class="p">,</span>
                <span class="s2">&quot;prop_adults_exposed_to_behav_intv&quot;</span><span class="p">:</span> <span class="n">prop_adults_exposed_to_behav_intv</span><span class="p">,</span>
                <span class="s2">&quot;prop_fsw_on_prep&quot;</span><span class="p">:</span> <span class="n">prop_fsw_on_prep</span><span class="p">,</span>
                <span class="s2">&quot;prop_men_circ&quot;</span><span class="p">:</span> <span class="n">prop_men_circ</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># ------------------------------------ TREATMENT DELAYS ------------------------------------</span>
        <span class="c1"># for every person initiated on treatment, record time from onset to treatment</span>
        <span class="c1"># each year a series of intervals in days (treatment date - onset date) are recorded</span>
        <span class="c1"># convert to list</span>

        <span class="c1"># adults</span>
        <span class="c1"># get index of adults starting tx in last time-period</span>
        <span class="n">adult_tx_idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span>
                              <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_date_treated</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))]</span><span class="o">.</span><span class="n">index</span>
        <span class="c1"># calculate treatment_date - onset_date for each person in index</span>
        <span class="n">adult_tx_delays</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">adult_tx_idx</span><span class="p">,</span> <span class="s2">&quot;hv_date_treated&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">adult_tx_idx</span><span class="p">,</span> <span class="s2">&quot;hv_date_inf&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span>
        <span class="n">adult_tx_delays</span> <span class="o">=</span> <span class="n">adult_tx_delays</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># children</span>
        <span class="n">child_tx_idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">age_years</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span>
                              <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">hv_date_treated</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)))]</span><span class="o">.</span><span class="n">index</span>
        <span class="n">child_tx_delays</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">child_tx_idx</span><span class="p">,</span> <span class="s2">&quot;hv_date_treated&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">child_tx_idx</span><span class="p">,</span> <span class="s2">&quot;hv_date_inf&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span>
        <span class="n">child_tx_delays</span> <span class="o">=</span> <span class="n">child_tx_delays</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;hiv_treatment_delays&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;HIV time from onset to treatment&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;HivTreatmentDelayAdults&quot;</span><span class="p">:</span> <span class="n">adult_tx_delays</span><span class="p">,</span>
                <span class="s2">&quot;HivTreatmentDelayChildren&quot;</span><span class="p">:</span> <span class="n">child_tx_delays</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span></div>
</div>



<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1">#   Debugging / Checking Events</span>
<span class="c1"># ---------------------------------------------------------------------------</span>


<div class="viewcode-block" id="HivCheckPropertiesEvent">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivCheckPropertiesEvent">[docs]</a>
<span class="k">class</span> <span class="nc">HivCheckPropertiesEvent</span><span class="p">(</span><span class="n">RegularEvent</span><span class="p">,</span> <span class="n">PopulationScopeEventMixin</span><span class="p">):</span>
<div class="viewcode-block" id="HivCheckPropertiesEvent.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivCheckPropertiesEvent.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>  <span class="c1"># runs every month</span></div>


<div class="viewcode-block" id="HivCheckPropertiesEvent.apply">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.HivCheckPropertiesEvent.apply">[docs]</a>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">check_config_of_properties</span><span class="p">()</span></div>
</div>



<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1">#   Helper functions for analysing outputs</span>
<span class="c1"># ---------------------------------------------------------------------------</span>


<span class="k">def</span> <span class="nf">set_age_group</span><span class="p">(</span><span class="n">ser</span><span class="p">):</span>
    <span class="n">AGE_RANGE_CATEGORIES</span><span class="p">,</span> <span class="n">AGE_RANGE_LOOKUP</span> <span class="o">=</span> <span class="n">create_age_range_lookup</span><span class="p">(</span>
        <span class="n">min_age</span><span class="o">=</span><span class="n">demography</span><span class="o">.</span><span class="n">MIN_AGE_FOR_RANGE</span><span class="p">,</span>
        <span class="n">max_age</span><span class="o">=</span><span class="n">demography</span><span class="o">.</span><span class="n">MAX_AGE_FOR_RANGE</span><span class="p">,</span>
        <span class="n">range_size</span><span class="o">=</span><span class="n">demography</span><span class="o">.</span><span class="n">AGE_RANGE_SIZE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ser</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>
    <span class="n">AGE_RANGE_CATEGORIES_filtered</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">AGE_RANGE_CATEGORIES</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ser</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">ser</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">reorder_categories</span><span class="p">(</span><span class="n">AGE_RANGE_CATEGORIES_filtered</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">map_to_age_group</span><span class="p">(</span><span class="n">ser</span><span class="p">):</span>
    <span class="n">AGE_RANGE_CATEGORIES</span><span class="p">,</span> <span class="n">AGE_RANGE_LOOKUP</span> <span class="o">=</span> <span class="n">create_age_range_lookup</span><span class="p">(</span>
        <span class="n">min_age</span><span class="o">=</span><span class="n">demography</span><span class="o">.</span><span class="n">MIN_AGE_FOR_RANGE</span><span class="p">,</span>
        <span class="n">max_age</span><span class="o">=</span><span class="n">demography</span><span class="o">.</span><span class="n">MAX_AGE_FOR_RANGE</span><span class="p">,</span>
        <span class="n">range_size</span><span class="o">=</span><span class="n">demography</span><span class="o">.</span><span class="n">AGE_RANGE_SIZE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ser</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">AGE_RANGE_LOOKUP</span><span class="p">)</span>
    <span class="n">ser</span> <span class="o">=</span> <span class="n">set_age_group</span><span class="p">(</span><span class="n">ser</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ser</span>


<span class="k">def</span> <span class="nf">unpack_raw_output_dict</span><span class="p">(</span><span class="n">raw_dict</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">raw_dict</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
    <span class="n">x</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">x</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;age_group&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;value&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">x</span><span class="p">[</span><span class="s2">&quot;age_group&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">set_age_group</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;age_group&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">x</span>


<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1">#   Dummy Version of the Module</span>
<span class="c1"># ---------------------------------------------------------------------------</span>


<div class="viewcode-block" id="DummyHivModule">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.DummyHivModule">[docs]</a>
<span class="k">class</span> <span class="nc">DummyHivModule</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dummy HIV Module - it&#39;s only job is to create and maintain the &#39;hv_inf&#39; and &#39;hv_art&#39; properties.</span>
<span class="sd">    This can be used in test files.&quot;&quot;&quot;</span>

    <span class="n">INIT_DEPENDENCIES</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Demography&quot;</span><span class="p">}</span>
    <span class="n">ALTERNATIVE_TO</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Hiv&quot;</span><span class="p">}</span>

    <span class="n">PROPERTIES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;hv_inf&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span> <span class="s2">&quot;DUMMY version of the property for hv_inf&quot;</span><span class="p">),</span>
        <span class="s2">&quot;hv_art&quot;</span><span class="p">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">Types</span><span class="o">.</span><span class="n">CATEGORICAL</span><span class="p">,</span> <span class="s2">&quot;DUMMY version of the property for hv_art.&quot;</span><span class="p">,</span>
                           <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;not&quot;</span><span class="p">,</span> <span class="s2">&quot;on_VL_suppressed&quot;</span><span class="p">,</span> <span class="s2">&quot;on_not_VL_suppressed&quot;</span><span class="p">]),</span>
    <span class="p">}</span>

<div class="viewcode-block" id="DummyHivModule.__init__">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.DummyHivModule.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hiv_prev</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">art_cov</span><span class="o">=</span><span class="mf">0.75</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hiv_prev</span> <span class="o">=</span> <span class="n">hiv_prev</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">art_cov</span> <span class="o">=</span> <span class="n">art_cov</span></div>


<div class="viewcode-block" id="DummyHivModule.read_parameters">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.DummyHivModule.read_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">read_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_folder</span><span class="p">):</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="DummyHivModule.initialise_population">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.DummyHivModule.initialise_population">[docs]</a>
    <span class="k">def</span> <span class="nf">initialise_population</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">,</span> <span class="s2">&quot;hv_inf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span><span class="p">))</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">hiv_prev</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span><span class="p">),</span> <span class="s2">&quot;hv_art&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">hv_inf</span><span class="p">))</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">art_cov</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="p">{</span><span class="kc">True</span><span class="p">:</span> <span class="s2">&quot;on_VL_suppressed&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span> <span class="s2">&quot;not&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">values</span></div>


<div class="viewcode-block" id="DummyHivModule.initialise_simulation">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.DummyHivModule.initialise_simulation">[docs]</a>
    <span class="k">def</span> <span class="nf">initialise_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span><span class="p">):</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="DummyHivModule.on_birth">
<a class="viewcode-back" href="../../../reference/tlo.methods.hiv.html#tlo.methods.hiv.DummyHivModule.on_birth">[docs]</a>
    <span class="k">def</span> <span class="nf">on_birth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mother</span><span class="p">,</span> <span class="n">child</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">props</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child</span><span class="p">,</span> <span class="s2">&quot;hv_inf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">hiv_prev</span>

        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child</span><span class="p">,</span> <span class="s2">&quot;hv_inf&quot;</span><span class="p">]:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">child</span><span class="p">,</span> <span class="s2">&quot;hv_art&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;on_VL_suppressed&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">art_cov</span> <span class="k">else</span> <span class="s2">&quot;not&quot;</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
      <span class="lastupdated">Last updated on Oct 08, 2024.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>