# Runs a pyinstrument profiling session on the scale_run profiling model,
# capturing the profiling result and sending it to the TLOmodel-profiling
# repository for processing and display.
#
# Profiling script executed is src/scripts/profiling/run-profiling.py.
# Output is the .pyisession file from the profiler, placed into results/
# results/ folder is then pushed to the TLOmodel-profiling repo, results branch.
name: Run profiling

on:
  workflow_call:
    inputs:
      runs-on:
        description: The type of machine to run job on
        required: false
        type: string
        default: self-hosted
      event-name:
        description: |
          The event name to attribute to the workflow run.
          Should be passed the value of ${GITHUB_EVENT_NAME} from the triggering workflow.
        type: string
        required: false
        default: workflow_dispatch
      run-number:
        description: |
          The run number (${GITHUB_RUN_NUMBER}) of the triggering workflow.
          Defaults to 0 if not provided.
        type: string
        required: false
        default: 0
      sha:
        description: The SHA to checkout and run profiling on.
        required: true
        type: string
    secrets:
      profiling-access-token:
        description: |
          Access token providing write access to the TLOmodel-profiling repository, 
          which will be used to commit profiling results on a successful profiling session.
        required: true

jobs:
  run-profiling:
    name: Setup developer environment
    runs-on: ${{ inputs.runs-on }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.sha }}

      ## The profile environment produces outputs in the /results directory
      - name: Run profiling in dev environment
        run: tox -vv -e profile -- --output_name ${{ inputs.event-name }}_${{ inputs.run-number }}_${{ inputs.sha }}

      ## Upload the output as an artifact so we can push it to the profiling repository
      - name: Save results as artifact
        uses: actions/upload-artifact@v3
        with:
          name: profiling_${{ inputs.run-number }}
          path: profiling_results/
          retention-days: 1

  upload-results:
    name: Upload profiling outputs
    runs-on: ubuntu-latest
    needs: run-profiling
    steps:
      - name: Download the profiling results
        uses: actions/download-artifact@v3
        with:
          name: profiling_${{ inputs.run-number }}
          path: profiling_results

      ## The token provided needs contents and pages access to the target repo
      ## Token can be (re)generated by a member of the UCL organisation, 
      ## the current member is the rc-softdev-admin.
      ## [10-07-2023] The current token will expire 10-07-2024
      - name: Push results to profiling repository
        uses: dmnemec/copy_file_to_another_repo_action@v1.1.1
        env:
          API_TOKEN_GITHUB: ${{ secrets.profiling-access-token }}
        with:
          source_file: profiling_results/
          destination_repo: UCL/TLOmodel-profiling
          destination_folder: .
          destination_branch: results
          user_email: rsd-notifications@ucl.ac.uk
          user_name:  rc-softdev-admin

      - name: Trigger website rebuild
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.profiling-access-token }}
          repository: UCL/TLOmodel-profiling
          event-type: new-profiling-results
